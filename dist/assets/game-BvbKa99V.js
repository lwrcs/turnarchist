var fh=Object.defineProperty;var uh=(o,e,t)=>e in o?fh(o,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[e]=t;var r=(o,e,t)=>uh(o,typeof e!="symbol"?e+"":e,t);import{c as xs}from"./index-Bd3S4n76.js";const ae=class ae{};r(ae,"state"),r(ae,"setState",e=>{ae.state=e}),r(ae,"rand",()=>(ae.state^=ae.state<<21,ae.state^=ae.state>>>35,ae.state^=ae.state<<4,(ae.state>>>0)/4294967296));let O=ae;var Ea={};/*!
 *  howler.js v2.2.4
 *  howlerjs.com
 *
 *  (c) 2013-2020, James Simpson of GoldFire Studios
 *  goldfirestudios.com
 *
 *  MIT License
 */var vo;function mh(){return vo||(vo=1,(function(o){(function(){var e=function(){this.init()};e.prototype={init:function(){var h=this||t;return h._counter=1e3,h._html5AudioPool=[],h.html5PoolSize=10,h._codecs={},h._howls=[],h._muted=!1,h._volume=1,h._canPlayEvent="canplaythrough",h._navigator=typeof window<"u"&&window.navigator?window.navigator:null,h.masterGain=null,h.noAudio=!1,h.usingWebAudio=!0,h.autoSuspend=!0,h.ctx=null,h.autoUnlock=!0,h._setup(),h},volume:function(h){var f=this||t;if(h=parseFloat(h),f.ctx||u(),typeof h<"u"&&h>=0&&h<=1){if(f._volume=h,f._muted)return f;f.usingWebAudio&&f.masterGain.gain.setValueAtTime(h,t.ctx.currentTime);for(var p=0;p<f._howls.length;p++)if(!f._howls[p]._webAudio)for(var y=f._howls[p]._getSoundIds(),g=0;g<y.length;g++){var w=f._howls[p]._soundById(y[g]);w&&w._node&&(w._node.volume=w._volume*h)}return f}return f._volume},mute:function(h){var f=this||t;f.ctx||u(),f._muted=h,f.usingWebAudio&&f.masterGain.gain.setValueAtTime(h?0:f._volume,t.ctx.currentTime);for(var p=0;p<f._howls.length;p++)if(!f._howls[p]._webAudio)for(var y=f._howls[p]._getSoundIds(),g=0;g<y.length;g++){var w=f._howls[p]._soundById(y[g]);w&&w._node&&(w._node.muted=h?!0:w._muted)}return f},stop:function(){for(var h=this||t,f=0;f<h._howls.length;f++)h._howls[f].stop();return h},unload:function(){for(var h=this||t,f=h._howls.length-1;f>=0;f--)h._howls[f].unload();return h.usingWebAudio&&h.ctx&&typeof h.ctx.close<"u"&&(h.ctx.close(),h.ctx=null,u()),h},codecs:function(h){return(this||t)._codecs[h.replace(/^x-/,"")]},_setup:function(){var h=this||t;if(h.state=h.ctx&&h.ctx.state||"suspended",h._autoSuspend(),!h.usingWebAudio)if(typeof Audio<"u")try{var f=new Audio;typeof f.oncanplaythrough>"u"&&(h._canPlayEvent="canplay")}catch{h.noAudio=!0}else h.noAudio=!0;try{var f=new Audio;f.muted&&(h.noAudio=!0)}catch{}return h.noAudio||h._setupCodecs(),h},_setupCodecs:function(){var h=this||t,f=null;try{f=typeof Audio<"u"?new Audio:null}catch{return h}if(!f||typeof f.canPlayType!="function")return h;var p=f.canPlayType("audio/mpeg;").replace(/^no$/,""),y=h._navigator?h._navigator.userAgent:"",g=y.match(/OPR\/(\d+)/g),w=g&&parseInt(g[0].split("/")[1],10)<33,b=y.indexOf("Safari")!==-1&&y.indexOf("Chrome")===-1,T=y.match(/Version\/(.*?) /),v=b&&T&&parseInt(T[1],10)<15;return h._codecs={mp3:!!(!w&&(p||f.canPlayType("audio/mp3;").replace(/^no$/,""))),mpeg:!!p,opus:!!f.canPlayType('audio/ogg; codecs="opus"').replace(/^no$/,""),ogg:!!f.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,""),oga:!!f.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,""),wav:!!(f.canPlayType('audio/wav; codecs="1"')||f.canPlayType("audio/wav")).replace(/^no$/,""),aac:!!f.canPlayType("audio/aac;").replace(/^no$/,""),caf:!!f.canPlayType("audio/x-caf;").replace(/^no$/,""),m4a:!!(f.canPlayType("audio/x-m4a;")||f.canPlayType("audio/m4a;")||f.canPlayType("audio/aac;")).replace(/^no$/,""),m4b:!!(f.canPlayType("audio/x-m4b;")||f.canPlayType("audio/m4b;")||f.canPlayType("audio/aac;")).replace(/^no$/,""),mp4:!!(f.canPlayType("audio/x-mp4;")||f.canPlayType("audio/mp4;")||f.canPlayType("audio/aac;")).replace(/^no$/,""),weba:!!(!v&&f.canPlayType('audio/webm; codecs="vorbis"').replace(/^no$/,"")),webm:!!(!v&&f.canPlayType('audio/webm; codecs="vorbis"').replace(/^no$/,"")),dolby:!!f.canPlayType('audio/mp4; codecs="ec-3"').replace(/^no$/,""),flac:!!(f.canPlayType("audio/x-flac;")||f.canPlayType("audio/flac;")).replace(/^no$/,"")},h},_unlockAudio:function(){var h=this||t;if(!(h._audioUnlocked||!h.ctx)){h._audioUnlocked=!1,h.autoUnlock=!1,!h._mobileUnloaded&&h.ctx.sampleRate!==44100&&(h._mobileUnloaded=!0,h.unload()),h._scratchBuffer=h.ctx.createBuffer(1,1,22050);var f=function(p){for(;h._html5AudioPool.length<h.html5PoolSize;)try{var y=new Audio;y._unlocked=!0,h._releaseHtml5Audio(y)}catch{h.noAudio=!0;break}for(var g=0;g<h._howls.length;g++)if(!h._howls[g]._webAudio)for(var w=h._howls[g]._getSoundIds(),b=0;b<w.length;b++){var T=h._howls[g]._soundById(w[b]);T&&T._node&&!T._node._unlocked&&(T._node._unlocked=!0,T._node.load())}h._autoResume();var v=h.ctx.createBufferSource();v.buffer=h._scratchBuffer,v.connect(h.ctx.destination),typeof v.start>"u"?v.noteOn(0):v.start(0),typeof h.ctx.resume=="function"&&h.ctx.resume(),v.onended=function(){v.disconnect(0),h._audioUnlocked=!0,document.removeEventListener("touchstart",f,!0),document.removeEventListener("touchend",f,!0),document.removeEventListener("click",f,!0),document.removeEventListener("keydown",f,!0);for(var k=0;k<h._howls.length;k++)h._howls[k]._emit("unlock")}};return document.addEventListener("touchstart",f,!0),document.addEventListener("touchend",f,!0),document.addEventListener("click",f,!0),document.addEventListener("keydown",f,!0),h}},_obtainHtml5Audio:function(){var h=this||t;if(h._html5AudioPool.length)return h._html5AudioPool.pop();var f=new Audio().play();return f&&typeof Promise<"u"&&(f instanceof Promise||typeof f.then=="function")&&f.catch(function(){console.warn("HTML5 Audio pool exhausted, returning potentially locked audio object.")}),new Audio},_releaseHtml5Audio:function(h){var f=this||t;return h._unlocked&&f._html5AudioPool.push(h),f},_autoSuspend:function(){var h=this;if(!(!h.autoSuspend||!h.ctx||typeof h.ctx.suspend>"u"||!t.usingWebAudio)){for(var f=0;f<h._howls.length;f++)if(h._howls[f]._webAudio){for(var p=0;p<h._howls[f]._sounds.length;p++)if(!h._howls[f]._sounds[p]._paused)return h}return h._suspendTimer&&clearTimeout(h._suspendTimer),h._suspendTimer=setTimeout(function(){if(h.autoSuspend){h._suspendTimer=null,h.state="suspending";var y=function(){h.state="suspended",h._resumeAfterSuspend&&(delete h._resumeAfterSuspend,h._autoResume())};h.ctx.suspend().then(y,y)}},3e4),h}},_autoResume:function(){var h=this;if(!(!h.ctx||typeof h.ctx.resume>"u"||!t.usingWebAudio))return h.state==="running"&&h.ctx.state!=="interrupted"&&h._suspendTimer?(clearTimeout(h._suspendTimer),h._suspendTimer=null):h.state==="suspended"||h.state==="running"&&h.ctx.state==="interrupted"?(h.ctx.resume().then(function(){h.state="running";for(var f=0;f<h._howls.length;f++)h._howls[f]._emit("resume")}),h._suspendTimer&&(clearTimeout(h._suspendTimer),h._suspendTimer=null)):h.state==="suspending"&&(h._resumeAfterSuspend=!0),h}};var t=new e,i=function(h){var f=this;if(!h.src||h.src.length===0){console.error("An array of source files must be passed with any new Howl.");return}f.init(h)};i.prototype={init:function(h){var f=this;return t.ctx||u(),f._autoplay=h.autoplay||!1,f._format=typeof h.format!="string"?h.format:[h.format],f._html5=h.html5||!1,f._muted=h.mute||!1,f._loop=h.loop||!1,f._pool=h.pool||5,f._preload=typeof h.preload=="boolean"||h.preload==="metadata"?h.preload:!0,f._rate=h.rate||1,f._sprite=h.sprite||{},f._src=typeof h.src!="string"?h.src:[h.src],f._volume=h.volume!==void 0?h.volume:1,f._xhr={method:h.xhr&&h.xhr.method?h.xhr.method:"GET",headers:h.xhr&&h.xhr.headers?h.xhr.headers:null,withCredentials:h.xhr&&h.xhr.withCredentials?h.xhr.withCredentials:!1},f._duration=0,f._state="unloaded",f._sounds=[],f._endTimers={},f._queue=[],f._playLock=!1,f._onend=h.onend?[{fn:h.onend}]:[],f._onfade=h.onfade?[{fn:h.onfade}]:[],f._onload=h.onload?[{fn:h.onload}]:[],f._onloaderror=h.onloaderror?[{fn:h.onloaderror}]:[],f._onplayerror=h.onplayerror?[{fn:h.onplayerror}]:[],f._onpause=h.onpause?[{fn:h.onpause}]:[],f._onplay=h.onplay?[{fn:h.onplay}]:[],f._onstop=h.onstop?[{fn:h.onstop}]:[],f._onmute=h.onmute?[{fn:h.onmute}]:[],f._onvolume=h.onvolume?[{fn:h.onvolume}]:[],f._onrate=h.onrate?[{fn:h.onrate}]:[],f._onseek=h.onseek?[{fn:h.onseek}]:[],f._onunlock=h.onunlock?[{fn:h.onunlock}]:[],f._onresume=[],f._webAudio=t.usingWebAudio&&!f._html5,typeof t.ctx<"u"&&t.ctx&&t.autoUnlock&&t._unlockAudio(),t._howls.push(f),f._autoplay&&f._queue.push({event:"play",action:function(){f.play()}}),f._preload&&f._preload!=="none"&&f.load(),f},load:function(){var h=this,f=null;if(t.noAudio){h._emit("loaderror",null,"No audio support.");return}typeof h._src=="string"&&(h._src=[h._src]);for(var p=0;p<h._src.length;p++){var y,g;if(h._format&&h._format[p])y=h._format[p];else{if(g=h._src[p],typeof g!="string"){h._emit("loaderror",null,"Non-string found in selected audio sources - ignoring.");continue}y=/^data:audio\/([^;,]+);/i.exec(g),y||(y=/\.([^.]+)$/.exec(g.split("?",1)[0])),y&&(y=y[1].toLowerCase())}if(y||console.warn('No file extension was found. Consider using the "format" property or specify an extension.'),y&&t.codecs(y)){f=h._src[p];break}}if(!f){h._emit("loaderror",null,"No codec support for selected audio sources.");return}return h._src=f,h._state="loading",window.location.protocol==="https:"&&f.slice(0,5)==="http:"&&(h._html5=!0,h._webAudio=!1),new s(h),h._webAudio&&n(h),h},play:function(h,f){var p=this,y=null;if(typeof h=="number")y=h,h=null;else{if(typeof h=="string"&&p._state==="loaded"&&!p._sprite[h])return null;if(typeof h>"u"&&(h="__default",!p._playLock)){for(var g=0,w=0;w<p._sounds.length;w++)p._sounds[w]._paused&&!p._sounds[w]._ended&&(g++,y=p._sounds[w]._id);g===1?h=null:y=null}}var b=y?p._soundById(y):p._inactiveSound();if(!b)return null;if(y&&!h&&(h=b._sprite||"__default"),p._state!=="loaded"){b._sprite=h,b._ended=!1;var T=b._id;return p._queue.push({event:"play",action:function(){p.play(T)}}),T}if(y&&!b._paused)return f||p._loadQueue("play"),b._id;p._webAudio&&t._autoResume();var v=Math.max(0,b._seek>0?b._seek:p._sprite[h][0]/1e3),k=Math.max(0,(p._sprite[h][0]+p._sprite[h][1])/1e3-v),D=k*1e3/Math.abs(b._rate),N=p._sprite[h][0]/1e3,U=(p._sprite[h][0]+p._sprite[h][1])/1e3;b._sprite=h,b._ended=!1;var Z=function(){b._paused=!1,b._seek=v,b._start=N,b._stop=U,b._loop=!!(b._loop||p._sprite[h][2])};if(v>=U){p._ended(b);return}var j=b._node;if(p._webAudio){var V=function(){p._playLock=!1,Z(),p._refreshBuffer(b);var ft=b._muted||p._muted?0:b._volume;j.gain.setValueAtTime(ft,t.ctx.currentTime),b._playStart=t.ctx.currentTime,typeof j.bufferSource.start>"u"?b._loop?j.bufferSource.noteGrainOn(0,v,86400):j.bufferSource.noteGrainOn(0,v,k):b._loop?j.bufferSource.start(0,v,86400):j.bufferSource.start(0,v,k),D!==1/0&&(p._endTimers[b._id]=setTimeout(p._ended.bind(p,b),D)),f||setTimeout(function(){p._emit("play",b._id),p._loadQueue()},0)};t.state==="running"&&t.ctx.state!=="interrupted"?V():(p._playLock=!0,p.once("resume",V),p._clearTimer(b._id))}else{var J=function(){j.currentTime=v,j.muted=b._muted||p._muted||t._muted||j.muted,j.volume=b._volume*t.volume(),j.playbackRate=b._rate;try{var ft=j.play();if(ft&&typeof Promise<"u"&&(ft instanceof Promise||typeof ft.then=="function")?(p._playLock=!0,Z(),ft.then(function(){p._playLock=!1,j._unlocked=!0,f?p._loadQueue():p._emit("play",b._id)}).catch(function(){p._playLock=!1,p._emit("playerror",b._id,"Playback was unable to start. This is most commonly an issue on mobile devices and Chrome where playback was not within a user interaction."),b._ended=!0,b._paused=!0})):f||(p._playLock=!1,Z(),p._emit("play",b._id)),j.playbackRate=b._rate,j.paused){p._emit("playerror",b._id,"Playback was unable to start. This is most commonly an issue on mobile devices and Chrome where playback was not within a user interaction.");return}h!=="__default"||b._loop?p._endTimers[b._id]=setTimeout(p._ended.bind(p,b),D):(p._endTimers[b._id]=function(){p._ended(b),j.removeEventListener("ended",p._endTimers[b._id],!1)},j.addEventListener("ended",p._endTimers[b._id],!1))}catch(at){p._emit("playerror",b._id,at)}};j.src==="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA"&&(j.src=p._src,j.load());var z=window&&window.ejecta||!j.readyState&&t._navigator.isCocoonJS;if(j.readyState>=3||z)J();else{p._playLock=!0,p._state="loading";var tt=function(){p._state="loaded",J(),j.removeEventListener(t._canPlayEvent,tt,!1)};j.addEventListener(t._canPlayEvent,tt,!1),p._clearTimer(b._id)}}return b._id},pause:function(h){var f=this;if(f._state!=="loaded"||f._playLock)return f._queue.push({event:"pause",action:function(){f.pause(h)}}),f;for(var p=f._getSoundIds(h),y=0;y<p.length;y++){f._clearTimer(p[y]);var g=f._soundById(p[y]);if(g&&!g._paused&&(g._seek=f.seek(p[y]),g._rateSeek=0,g._paused=!0,f._stopFade(p[y]),g._node))if(f._webAudio){if(!g._node.bufferSource)continue;typeof g._node.bufferSource.stop>"u"?g._node.bufferSource.noteOff(0):g._node.bufferSource.stop(0),f._cleanBuffer(g._node)}else(!isNaN(g._node.duration)||g._node.duration===1/0)&&g._node.pause();arguments[1]||f._emit("pause",g?g._id:null)}return f},stop:function(h,f){var p=this;if(p._state!=="loaded"||p._playLock)return p._queue.push({event:"stop",action:function(){p.stop(h)}}),p;for(var y=p._getSoundIds(h),g=0;g<y.length;g++){p._clearTimer(y[g]);var w=p._soundById(y[g]);w&&(w._seek=w._start||0,w._rateSeek=0,w._paused=!0,w._ended=!0,p._stopFade(y[g]),w._node&&(p._webAudio?w._node.bufferSource&&(typeof w._node.bufferSource.stop>"u"?w._node.bufferSource.noteOff(0):w._node.bufferSource.stop(0),p._cleanBuffer(w._node)):(!isNaN(w._node.duration)||w._node.duration===1/0)&&(w._node.currentTime=w._start||0,w._node.pause(),w._node.duration===1/0&&p._clearSound(w._node))),f||p._emit("stop",w._id))}return p},mute:function(h,f){var p=this;if(p._state!=="loaded"||p._playLock)return p._queue.push({event:"mute",action:function(){p.mute(h,f)}}),p;if(typeof f>"u")if(typeof h=="boolean")p._muted=h;else return p._muted;for(var y=p._getSoundIds(f),g=0;g<y.length;g++){var w=p._soundById(y[g]);w&&(w._muted=h,w._interval&&p._stopFade(w._id),p._webAudio&&w._node?w._node.gain.setValueAtTime(h?0:w._volume,t.ctx.currentTime):w._node&&(w._node.muted=t._muted?!0:h),p._emit("mute",w._id))}return p},volume:function(){var h=this,f=arguments,p,y;if(f.length===0)return h._volume;if(f.length===1||f.length===2&&typeof f[1]>"u"){var g=h._getSoundIds(),w=g.indexOf(f[0]);w>=0?y=parseInt(f[0],10):p=parseFloat(f[0])}else f.length>=2&&(p=parseFloat(f[0]),y=parseInt(f[1],10));var b;if(typeof p<"u"&&p>=0&&p<=1){if(h._state!=="loaded"||h._playLock)return h._queue.push({event:"volume",action:function(){h.volume.apply(h,f)}}),h;typeof y>"u"&&(h._volume=p),y=h._getSoundIds(y);for(var T=0;T<y.length;T++)b=h._soundById(y[T]),b&&(b._volume=p,f[2]||h._stopFade(y[T]),h._webAudio&&b._node&&!b._muted?b._node.gain.setValueAtTime(p,t.ctx.currentTime):b._node&&!b._muted&&(b._node.volume=p*t.volume()),h._emit("volume",b._id))}else return b=y?h._soundById(y):h._sounds[0],b?b._volume:0;return h},fade:function(h,f,p,y){var g=this;if(g._state!=="loaded"||g._playLock)return g._queue.push({event:"fade",action:function(){g.fade(h,f,p,y)}}),g;h=Math.min(Math.max(0,parseFloat(h)),1),f=Math.min(Math.max(0,parseFloat(f)),1),p=parseFloat(p),g.volume(h,y);for(var w=g._getSoundIds(y),b=0;b<w.length;b++){var T=g._soundById(w[b]);if(T){if(y||g._stopFade(w[b]),g._webAudio&&!T._muted){var v=t.ctx.currentTime,k=v+p/1e3;T._volume=h,T._node.gain.setValueAtTime(h,v),T._node.gain.linearRampToValueAtTime(f,k)}g._startFadeInterval(T,h,f,p,w[b],typeof y>"u")}}return g},_startFadeInterval:function(h,f,p,y,g,w){var b=this,T=f,v=p-f,k=Math.abs(v/.01),D=Math.max(4,k>0?y/k:y),N=Date.now();h._fadeTo=p,h._interval=setInterval(function(){var U=(Date.now()-N)/y;N=Date.now(),T+=v*U,T=Math.round(T*100)/100,v<0?T=Math.max(p,T):T=Math.min(p,T),b._webAudio?h._volume=T:b.volume(T,h._id,!0),w&&(b._volume=T),(p<f&&T<=p||p>f&&T>=p)&&(clearInterval(h._interval),h._interval=null,h._fadeTo=null,b.volume(p,h._id),b._emit("fade",h._id))},D)},_stopFade:function(h){var f=this,p=f._soundById(h);return p&&p._interval&&(f._webAudio&&p._node.gain.cancelScheduledValues(t.ctx.currentTime),clearInterval(p._interval),p._interval=null,f.volume(p._fadeTo,h),p._fadeTo=null,f._emit("fade",h)),f},loop:function(){var h=this,f=arguments,p,y,g;if(f.length===0)return h._loop;if(f.length===1)if(typeof f[0]=="boolean")p=f[0],h._loop=p;else return g=h._soundById(parseInt(f[0],10)),g?g._loop:!1;else f.length===2&&(p=f[0],y=parseInt(f[1],10));for(var w=h._getSoundIds(y),b=0;b<w.length;b++)g=h._soundById(w[b]),g&&(g._loop=p,h._webAudio&&g._node&&g._node.bufferSource&&(g._node.bufferSource.loop=p,p&&(g._node.bufferSource.loopStart=g._start||0,g._node.bufferSource.loopEnd=g._stop,h.playing(w[b])&&(h.pause(w[b],!0),h.play(w[b],!0)))));return h},rate:function(){var h=this,f=arguments,p,y;if(f.length===0)y=h._sounds[0]._id;else if(f.length===1){var g=h._getSoundIds(),w=g.indexOf(f[0]);w>=0?y=parseInt(f[0],10):p=parseFloat(f[0])}else f.length===2&&(p=parseFloat(f[0]),y=parseInt(f[1],10));var b;if(typeof p=="number"){if(h._state!=="loaded"||h._playLock)return h._queue.push({event:"rate",action:function(){h.rate.apply(h,f)}}),h;typeof y>"u"&&(h._rate=p),y=h._getSoundIds(y);for(var T=0;T<y.length;T++)if(b=h._soundById(y[T]),b){h.playing(y[T])&&(b._rateSeek=h.seek(y[T]),b._playStart=h._webAudio?t.ctx.currentTime:b._playStart),b._rate=p,h._webAudio&&b._node&&b._node.bufferSource?b._node.bufferSource.playbackRate.setValueAtTime(p,t.ctx.currentTime):b._node&&(b._node.playbackRate=p);var v=h.seek(y[T]),k=(h._sprite[b._sprite][0]+h._sprite[b._sprite][1])/1e3-v,D=k*1e3/Math.abs(b._rate);(h._endTimers[y[T]]||!b._paused)&&(h._clearTimer(y[T]),h._endTimers[y[T]]=setTimeout(h._ended.bind(h,b),D)),h._emit("rate",b._id)}}else return b=h._soundById(y),b?b._rate:h._rate;return h},seek:function(){var h=this,f=arguments,p,y;if(f.length===0)h._sounds.length&&(y=h._sounds[0]._id);else if(f.length===1){var g=h._getSoundIds(),w=g.indexOf(f[0]);w>=0?y=parseInt(f[0],10):h._sounds.length&&(y=h._sounds[0]._id,p=parseFloat(f[0]))}else f.length===2&&(p=parseFloat(f[0]),y=parseInt(f[1],10));if(typeof y>"u")return 0;if(typeof p=="number"&&(h._state!=="loaded"||h._playLock))return h._queue.push({event:"seek",action:function(){h.seek.apply(h,f)}}),h;var b=h._soundById(y);if(b)if(typeof p=="number"&&p>=0){var T=h.playing(y);T&&h.pause(y,!0),b._seek=p,b._ended=!1,h._clearTimer(y),!h._webAudio&&b._node&&!isNaN(b._node.duration)&&(b._node.currentTime=p);var v=function(){T&&h.play(y,!0),h._emit("seek",y)};if(T&&!h._webAudio){var k=function(){h._playLock?setTimeout(k,0):v()};setTimeout(k,0)}else v()}else if(h._webAudio){var D=h.playing(y)?t.ctx.currentTime-b._playStart:0,N=b._rateSeek?b._rateSeek-b._seek:0;return b._seek+(N+D*Math.abs(b._rate))}else return b._node.currentTime;return h},playing:function(h){var f=this;if(typeof h=="number"){var p=f._soundById(h);return p?!p._paused:!1}for(var y=0;y<f._sounds.length;y++)if(!f._sounds[y]._paused)return!0;return!1},duration:function(h){var f=this,p=f._duration,y=f._soundById(h);return y&&(p=f._sprite[y._sprite][1]/1e3),p},state:function(){return this._state},unload:function(){for(var h=this,f=h._sounds,p=0;p<f.length;p++)f[p]._paused||h.stop(f[p]._id),h._webAudio||(h._clearSound(f[p]._node),f[p]._node.removeEventListener("error",f[p]._errorFn,!1),f[p]._node.removeEventListener(t._canPlayEvent,f[p]._loadFn,!1),f[p]._node.removeEventListener("ended",f[p]._endFn,!1),t._releaseHtml5Audio(f[p]._node)),delete f[p]._node,h._clearTimer(f[p]._id);var y=t._howls.indexOf(h);y>=0&&t._howls.splice(y,1);var g=!0;for(p=0;p<t._howls.length;p++)if(t._howls[p]._src===h._src||h._src.indexOf(t._howls[p]._src)>=0){g=!1;break}return a&&g&&delete a[h._src],t.noAudio=!1,h._state="unloaded",h._sounds=[],h=null,null},on:function(h,f,p,y){var g=this,w=g["_on"+h];return typeof f=="function"&&w.push(y?{id:p,fn:f,once:y}:{id:p,fn:f}),g},off:function(h,f,p){var y=this,g=y["_on"+h],w=0;if(typeof f=="number"&&(p=f,f=null),f||p)for(w=0;w<g.length;w++){var b=p===g[w].id;if(f===g[w].fn&&b||!f&&b){g.splice(w,1);break}}else if(h)y["_on"+h]=[];else{var T=Object.keys(y);for(w=0;w<T.length;w++)T[w].indexOf("_on")===0&&Array.isArray(y[T[w]])&&(y[T[w]]=[])}return y},once:function(h,f,p){var y=this;return y.on(h,f,p,1),y},_emit:function(h,f,p){for(var y=this,g=y["_on"+h],w=g.length-1;w>=0;w--)(!g[w].id||g[w].id===f||h==="load")&&(setTimeout((function(b){b.call(this,f,p)}).bind(y,g[w].fn),0),g[w].once&&y.off(h,g[w].fn,g[w].id));return y._loadQueue(h),y},_loadQueue:function(h){var f=this;if(f._queue.length>0){var p=f._queue[0];p.event===h&&(f._queue.shift(),f._loadQueue()),h||p.action()}return f},_ended:function(h){var f=this,p=h._sprite;if(!f._webAudio&&h._node&&!h._node.paused&&!h._node.ended&&h._node.currentTime<h._stop)return setTimeout(f._ended.bind(f,h),100),f;var y=!!(h._loop||f._sprite[p][2]);if(f._emit("end",h._id),!f._webAudio&&y&&f.stop(h._id,!0).play(h._id),f._webAudio&&y){f._emit("play",h._id),h._seek=h._start||0,h._rateSeek=0,h._playStart=t.ctx.currentTime;var g=(h._stop-h._start)*1e3/Math.abs(h._rate);f._endTimers[h._id]=setTimeout(f._ended.bind(f,h),g)}return f._webAudio&&!y&&(h._paused=!0,h._ended=!0,h._seek=h._start||0,h._rateSeek=0,f._clearTimer(h._id),f._cleanBuffer(h._node),t._autoSuspend()),!f._webAudio&&!y&&f.stop(h._id,!0),f},_clearTimer:function(h){var f=this;if(f._endTimers[h]){if(typeof f._endTimers[h]!="function")clearTimeout(f._endTimers[h]);else{var p=f._soundById(h);p&&p._node&&p._node.removeEventListener("ended",f._endTimers[h],!1)}delete f._endTimers[h]}return f},_soundById:function(h){for(var f=this,p=0;p<f._sounds.length;p++)if(h===f._sounds[p]._id)return f._sounds[p];return null},_inactiveSound:function(){var h=this;h._drain();for(var f=0;f<h._sounds.length;f++)if(h._sounds[f]._ended)return h._sounds[f].reset();return new s(h)},_drain:function(){var h=this,f=h._pool,p=0,y=0;if(!(h._sounds.length<f)){for(y=0;y<h._sounds.length;y++)h._sounds[y]._ended&&p++;for(y=h._sounds.length-1;y>=0;y--){if(p<=f)return;h._sounds[y]._ended&&(h._webAudio&&h._sounds[y]._node&&h._sounds[y]._node.disconnect(0),h._sounds.splice(y,1),p--)}}},_getSoundIds:function(h){var f=this;if(typeof h>"u"){for(var p=[],y=0;y<f._sounds.length;y++)p.push(f._sounds[y]._id);return p}else return[h]},_refreshBuffer:function(h){var f=this;return h._node.bufferSource=t.ctx.createBufferSource(),h._node.bufferSource.buffer=a[f._src],h._panner?h._node.bufferSource.connect(h._panner):h._node.bufferSource.connect(h._node),h._node.bufferSource.loop=h._loop,h._loop&&(h._node.bufferSource.loopStart=h._start||0,h._node.bufferSource.loopEnd=h._stop||0),h._node.bufferSource.playbackRate.setValueAtTime(h._rate,t.ctx.currentTime),f},_cleanBuffer:function(h){var f=this,p=t._navigator&&t._navigator.vendor.indexOf("Apple")>=0;if(!h.bufferSource)return f;if(t._scratchBuffer&&h.bufferSource&&(h.bufferSource.onended=null,h.bufferSource.disconnect(0),p))try{h.bufferSource.buffer=t._scratchBuffer}catch{}return h.bufferSource=null,f},_clearSound:function(h){var f=/MSIE |Trident\//.test(t._navigator&&t._navigator.userAgent);f||(h.src="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA")}};var s=function(h){this._parent=h,this.init()};s.prototype={init:function(){var h=this,f=h._parent;return h._muted=f._muted,h._loop=f._loop,h._volume=f._volume,h._rate=f._rate,h._seek=0,h._paused=!0,h._ended=!0,h._sprite="__default",h._id=++t._counter,f._sounds.push(h),h.create(),h},create:function(){var h=this,f=h._parent,p=t._muted||h._muted||h._parent._muted?0:h._volume;return f._webAudio?(h._node=typeof t.ctx.createGain>"u"?t.ctx.createGainNode():t.ctx.createGain(),h._node.gain.setValueAtTime(p,t.ctx.currentTime),h._node.paused=!0,h._node.connect(t.masterGain)):t.noAudio||(h._node=t._obtainHtml5Audio(),h._errorFn=h._errorListener.bind(h),h._node.addEventListener("error",h._errorFn,!1),h._loadFn=h._loadListener.bind(h),h._node.addEventListener(t._canPlayEvent,h._loadFn,!1),h._endFn=h._endListener.bind(h),h._node.addEventListener("ended",h._endFn,!1),h._node.src=f._src,h._node.preload=f._preload===!0?"auto":f._preload,h._node.volume=p*t.volume(),h._node.load()),h},reset:function(){var h=this,f=h._parent;return h._muted=f._muted,h._loop=f._loop,h._volume=f._volume,h._rate=f._rate,h._seek=0,h._rateSeek=0,h._paused=!0,h._ended=!0,h._sprite="__default",h._id=++t._counter,h},_errorListener:function(){var h=this;h._parent._emit("loaderror",h._id,h._node.error?h._node.error.code:0),h._node.removeEventListener("error",h._errorFn,!1)},_loadListener:function(){var h=this,f=h._parent;f._duration=Math.ceil(h._node.duration*10)/10,Object.keys(f._sprite).length===0&&(f._sprite={__default:[0,f._duration*1e3]}),f._state!=="loaded"&&(f._state="loaded",f._emit("load"),f._loadQueue()),h._node.removeEventListener(t._canPlayEvent,h._loadFn,!1)},_endListener:function(){var h=this,f=h._parent;f._duration===1/0&&(f._duration=Math.ceil(h._node.duration*10)/10,f._sprite.__default[1]===1/0&&(f._sprite.__default[1]=f._duration*1e3),f._ended(h)),h._node.removeEventListener("ended",h._endFn,!1)}};var a={},n=function(h){var f=h._src;if(a[f]){h._duration=a[f].duration,d(h);return}if(/^data:[^;]+;base64,/.test(f)){for(var p=atob(f.split(",")[1]),y=new Uint8Array(p.length),g=0;g<p.length;++g)y[g]=p.charCodeAt(g);l(y.buffer,h)}else{var w=new XMLHttpRequest;w.open(h._xhr.method,f,!0),w.withCredentials=h._xhr.withCredentials,w.responseType="arraybuffer",h._xhr.headers&&Object.keys(h._xhr.headers).forEach(function(b){w.setRequestHeader(b,h._xhr.headers[b])}),w.onload=function(){var b=(w.status+"")[0];if(b!=="0"&&b!=="2"&&b!=="3"){h._emit("loaderror",null,"Failed loading audio file with status: "+w.status+".");return}l(w.response,h)},w.onerror=function(){h._webAudio&&(h._html5=!0,h._webAudio=!1,h._sounds=[],delete a[f],h.load())},c(w)}},c=function(h){try{h.send()}catch{h.onerror()}},l=function(h,f){var p=function(){f._emit("loaderror",null,"Decoding audio data failed.")},y=function(g){g&&f._sounds.length>0?(a[f._src]=g,d(f,g)):p()};typeof Promise<"u"&&t.ctx.decodeAudioData.length===1?t.ctx.decodeAudioData(h).then(y).catch(p):t.ctx.decodeAudioData(h,y,p)},d=function(h,f){f&&!h._duration&&(h._duration=f.duration),Object.keys(h._sprite).length===0&&(h._sprite={__default:[0,h._duration*1e3]}),h._state!=="loaded"&&(h._state="loaded",h._emit("load"),h._loadQueue())},u=function(){if(t.usingWebAudio){try{typeof AudioContext<"u"?t.ctx=new AudioContext:typeof webkitAudioContext<"u"?t.ctx=new webkitAudioContext:t.usingWebAudio=!1}catch{t.usingWebAudio=!1}t.ctx||(t.usingWebAudio=!1);var h=/iP(hone|od|ad)/.test(t._navigator&&t._navigator.platform),f=t._navigator&&t._navigator.appVersion.match(/OS (\d+)_(\d+)_?(\d+)?/),p=f?parseInt(f[1],10):null;if(h&&p&&p<9){var y=/safari/.test(t._navigator&&t._navigator.userAgent.toLowerCase());t._navigator&&!y&&(t.usingWebAudio=!1)}t.usingWebAudio&&(t.masterGain=typeof t.ctx.createGain>"u"?t.ctx.createGainNode():t.ctx.createGain(),t.masterGain.gain.setValueAtTime(t._muted?0:t._volume,t.ctx.currentTime),t.masterGain.connect(t.ctx.destination)),t._setup()}};o.Howler=t,o.Howl=i,typeof xs<"u"?(xs.HowlerGlobal=e,xs.Howler=t,xs.Howl=i,xs.Sound=s):typeof window<"u"&&(window.HowlerGlobal=e,window.Howler=t,window.Howl=i,window.Sound=s)})();/*!
 *  Spatial Plugin - Adds support for stereo and 3D audio where Web Audio is supported.
 *  
 *  howler.js v2.2.4
 *  howlerjs.com
 *
 *  (c) 2013-2020, James Simpson of GoldFire Studios
 *  goldfirestudios.com
 *
 *  MIT License
 */(function(){HowlerGlobal.prototype._pos=[0,0,0],HowlerGlobal.prototype._orientation=[0,0,-1,0,1,0],HowlerGlobal.prototype.stereo=function(t){var i=this;if(!i.ctx||!i.ctx.listener)return i;for(var s=i._howls.length-1;s>=0;s--)i._howls[s].stereo(t);return i},HowlerGlobal.prototype.pos=function(t,i,s){var a=this;if(!a.ctx||!a.ctx.listener)return a;if(i=typeof i!="number"?a._pos[1]:i,s=typeof s!="number"?a._pos[2]:s,typeof t=="number")a._pos=[t,i,s],typeof a.ctx.listener.positionX<"u"?(a.ctx.listener.positionX.setTargetAtTime(a._pos[0],Howler.ctx.currentTime,.1),a.ctx.listener.positionY.setTargetAtTime(a._pos[1],Howler.ctx.currentTime,.1),a.ctx.listener.positionZ.setTargetAtTime(a._pos[2],Howler.ctx.currentTime,.1)):a.ctx.listener.setPosition(a._pos[0],a._pos[1],a._pos[2]);else return a._pos;return a},HowlerGlobal.prototype.orientation=function(t,i,s,a,n,c){var l=this;if(!l.ctx||!l.ctx.listener)return l;var d=l._orientation;if(i=typeof i!="number"?d[1]:i,s=typeof s!="number"?d[2]:s,a=typeof a!="number"?d[3]:a,n=typeof n!="number"?d[4]:n,c=typeof c!="number"?d[5]:c,typeof t=="number")l._orientation=[t,i,s,a,n,c],typeof l.ctx.listener.forwardX<"u"?(l.ctx.listener.forwardX.setTargetAtTime(t,Howler.ctx.currentTime,.1),l.ctx.listener.forwardY.setTargetAtTime(i,Howler.ctx.currentTime,.1),l.ctx.listener.forwardZ.setTargetAtTime(s,Howler.ctx.currentTime,.1),l.ctx.listener.upX.setTargetAtTime(a,Howler.ctx.currentTime,.1),l.ctx.listener.upY.setTargetAtTime(n,Howler.ctx.currentTime,.1),l.ctx.listener.upZ.setTargetAtTime(c,Howler.ctx.currentTime,.1)):l.ctx.listener.setOrientation(t,i,s,a,n,c);else return d;return l},Howl.prototype.init=(function(t){return function(i){var s=this;return s._orientation=i.orientation||[1,0,0],s._stereo=i.stereo||null,s._pos=i.pos||null,s._pannerAttr={coneInnerAngle:typeof i.coneInnerAngle<"u"?i.coneInnerAngle:360,coneOuterAngle:typeof i.coneOuterAngle<"u"?i.coneOuterAngle:360,coneOuterGain:typeof i.coneOuterGain<"u"?i.coneOuterGain:0,distanceModel:typeof i.distanceModel<"u"?i.distanceModel:"inverse",maxDistance:typeof i.maxDistance<"u"?i.maxDistance:1e4,panningModel:typeof i.panningModel<"u"?i.panningModel:"HRTF",refDistance:typeof i.refDistance<"u"?i.refDistance:1,rolloffFactor:typeof i.rolloffFactor<"u"?i.rolloffFactor:1},s._onstereo=i.onstereo?[{fn:i.onstereo}]:[],s._onpos=i.onpos?[{fn:i.onpos}]:[],s._onorientation=i.onorientation?[{fn:i.onorientation}]:[],t.call(this,i)}})(Howl.prototype.init),Howl.prototype.stereo=function(t,i){var s=this;if(!s._webAudio)return s;if(s._state!=="loaded")return s._queue.push({event:"stereo",action:function(){s.stereo(t,i)}}),s;var a=typeof Howler.ctx.createStereoPanner>"u"?"spatial":"stereo";if(typeof i>"u")if(typeof t=="number")s._stereo=t,s._pos=[t,0,0];else return s._stereo;for(var n=s._getSoundIds(i),c=0;c<n.length;c++){var l=s._soundById(n[c]);if(l)if(typeof t=="number")l._stereo=t,l._pos=[t,0,0],l._node&&(l._pannerAttr.panningModel="equalpower",(!l._panner||!l._panner.pan)&&e(l,a),a==="spatial"?typeof l._panner.positionX<"u"?(l._panner.positionX.setValueAtTime(t,Howler.ctx.currentTime),l._panner.positionY.setValueAtTime(0,Howler.ctx.currentTime),l._panner.positionZ.setValueAtTime(0,Howler.ctx.currentTime)):l._panner.setPosition(t,0,0):l._panner.pan.setValueAtTime(t,Howler.ctx.currentTime)),s._emit("stereo",l._id);else return l._stereo}return s},Howl.prototype.pos=function(t,i,s,a){var n=this;if(!n._webAudio)return n;if(n._state!=="loaded")return n._queue.push({event:"pos",action:function(){n.pos(t,i,s,a)}}),n;if(i=typeof i!="number"?0:i,s=typeof s!="number"?-.5:s,typeof a>"u")if(typeof t=="number")n._pos=[t,i,s];else return n._pos;for(var c=n._getSoundIds(a),l=0;l<c.length;l++){var d=n._soundById(c[l]);if(d)if(typeof t=="number")d._pos=[t,i,s],d._node&&((!d._panner||d._panner.pan)&&e(d,"spatial"),typeof d._panner.positionX<"u"?(d._panner.positionX.setValueAtTime(t,Howler.ctx.currentTime),d._panner.positionY.setValueAtTime(i,Howler.ctx.currentTime),d._panner.positionZ.setValueAtTime(s,Howler.ctx.currentTime)):d._panner.setPosition(t,i,s)),n._emit("pos",d._id);else return d._pos}return n},Howl.prototype.orientation=function(t,i,s,a){var n=this;if(!n._webAudio)return n;if(n._state!=="loaded")return n._queue.push({event:"orientation",action:function(){n.orientation(t,i,s,a)}}),n;if(i=typeof i!="number"?n._orientation[1]:i,s=typeof s!="number"?n._orientation[2]:s,typeof a>"u")if(typeof t=="number")n._orientation=[t,i,s];else return n._orientation;for(var c=n._getSoundIds(a),l=0;l<c.length;l++){var d=n._soundById(c[l]);if(d)if(typeof t=="number")d._orientation=[t,i,s],d._node&&(d._panner||(d._pos||(d._pos=n._pos||[0,0,-.5]),e(d,"spatial")),typeof d._panner.orientationX<"u"?(d._panner.orientationX.setValueAtTime(t,Howler.ctx.currentTime),d._panner.orientationY.setValueAtTime(i,Howler.ctx.currentTime),d._panner.orientationZ.setValueAtTime(s,Howler.ctx.currentTime)):d._panner.setOrientation(t,i,s)),n._emit("orientation",d._id);else return d._orientation}return n},Howl.prototype.pannerAttr=function(){var t=this,i=arguments,s,a,n;if(!t._webAudio)return t;if(i.length===0)return t._pannerAttr;if(i.length===1)if(typeof i[0]=="object")s=i[0],typeof a>"u"&&(s.pannerAttr||(s.pannerAttr={coneInnerAngle:s.coneInnerAngle,coneOuterAngle:s.coneOuterAngle,coneOuterGain:s.coneOuterGain,distanceModel:s.distanceModel,maxDistance:s.maxDistance,refDistance:s.refDistance,rolloffFactor:s.rolloffFactor,panningModel:s.panningModel}),t._pannerAttr={coneInnerAngle:typeof s.pannerAttr.coneInnerAngle<"u"?s.pannerAttr.coneInnerAngle:t._coneInnerAngle,coneOuterAngle:typeof s.pannerAttr.coneOuterAngle<"u"?s.pannerAttr.coneOuterAngle:t._coneOuterAngle,coneOuterGain:typeof s.pannerAttr.coneOuterGain<"u"?s.pannerAttr.coneOuterGain:t._coneOuterGain,distanceModel:typeof s.pannerAttr.distanceModel<"u"?s.pannerAttr.distanceModel:t._distanceModel,maxDistance:typeof s.pannerAttr.maxDistance<"u"?s.pannerAttr.maxDistance:t._maxDistance,refDistance:typeof s.pannerAttr.refDistance<"u"?s.pannerAttr.refDistance:t._refDistance,rolloffFactor:typeof s.pannerAttr.rolloffFactor<"u"?s.pannerAttr.rolloffFactor:t._rolloffFactor,panningModel:typeof s.pannerAttr.panningModel<"u"?s.pannerAttr.panningModel:t._panningModel});else return n=t._soundById(parseInt(i[0],10)),n?n._pannerAttr:t._pannerAttr;else i.length===2&&(s=i[0],a=parseInt(i[1],10));for(var c=t._getSoundIds(a),l=0;l<c.length;l++)if(n=t._soundById(c[l]),n){var d=n._pannerAttr;d={coneInnerAngle:typeof s.coneInnerAngle<"u"?s.coneInnerAngle:d.coneInnerAngle,coneOuterAngle:typeof s.coneOuterAngle<"u"?s.coneOuterAngle:d.coneOuterAngle,coneOuterGain:typeof s.coneOuterGain<"u"?s.coneOuterGain:d.coneOuterGain,distanceModel:typeof s.distanceModel<"u"?s.distanceModel:d.distanceModel,maxDistance:typeof s.maxDistance<"u"?s.maxDistance:d.maxDistance,refDistance:typeof s.refDistance<"u"?s.refDistance:d.refDistance,rolloffFactor:typeof s.rolloffFactor<"u"?s.rolloffFactor:d.rolloffFactor,panningModel:typeof s.panningModel<"u"?s.panningModel:d.panningModel};var u=n._panner;u||(n._pos||(n._pos=t._pos||[0,0,-.5]),e(n,"spatial"),u=n._panner),u.coneInnerAngle=d.coneInnerAngle,u.coneOuterAngle=d.coneOuterAngle,u.coneOuterGain=d.coneOuterGain,u.distanceModel=d.distanceModel,u.maxDistance=d.maxDistance,u.refDistance=d.refDistance,u.rolloffFactor=d.rolloffFactor,u.panningModel=d.panningModel}return t},Sound.prototype.init=(function(t){return function(){var i=this,s=i._parent;i._orientation=s._orientation,i._stereo=s._stereo,i._pos=s._pos,i._pannerAttr=s._pannerAttr,t.call(this),i._stereo?s.stereo(i._stereo):i._pos&&s.pos(i._pos[0],i._pos[1],i._pos[2],i._id)}})(Sound.prototype.init),Sound.prototype.reset=(function(t){return function(){var i=this,s=i._parent;return i._orientation=s._orientation,i._stereo=s._stereo,i._pos=s._pos,i._pannerAttr=s._pannerAttr,i._stereo?s.stereo(i._stereo):i._pos?s.pos(i._pos[0],i._pos[1],i._pos[2],i._id):i._panner&&(i._panner.disconnect(0),i._panner=void 0,s._refreshBuffer(i)),t.call(this)}})(Sound.prototype.reset);var e=function(t,i){i=i||"spatial",i==="spatial"?(t._panner=Howler.ctx.createPanner(),t._panner.coneInnerAngle=t._pannerAttr.coneInnerAngle,t._panner.coneOuterAngle=t._pannerAttr.coneOuterAngle,t._panner.coneOuterGain=t._pannerAttr.coneOuterGain,t._panner.distanceModel=t._pannerAttr.distanceModel,t._panner.maxDistance=t._pannerAttr.maxDistance,t._panner.refDistance=t._pannerAttr.refDistance,t._panner.rolloffFactor=t._pannerAttr.rolloffFactor,t._panner.panningModel=t._pannerAttr.panningModel,typeof t._panner.positionX<"u"?(t._panner.positionX.setValueAtTime(t._pos[0],Howler.ctx.currentTime),t._panner.positionY.setValueAtTime(t._pos[1],Howler.ctx.currentTime),t._panner.positionZ.setValueAtTime(t._pos[2],Howler.ctx.currentTime)):t._panner.setPosition(t._pos[0],t._pos[1],t._pos[2]),typeof t._panner.orientationX<"u"?(t._panner.orientationX.setValueAtTime(t._orientation[0],Howler.ctx.currentTime),t._panner.orientationY.setValueAtTime(t._orientation[1],Howler.ctx.currentTime),t._panner.orientationZ.setValueAtTime(t._orientation[2],Howler.ctx.currentTime)):t._panner.setOrientation(t._orientation[0],t._orientation[1],t._orientation[2])):(t._panner=Howler.ctx.createStereoPanner(),t._panner.pan.setValueAtTime(t._stereo,Howler.ctx.currentTime)),t._panner.connect(t._node),t._paused||t._parent.pause(t._id,!0).play(t._id,!0)}})()})(Ea)),Ea}var qt=mh();const B=class B{static isMobile(){return H.isMobile}static async unlockMobileAudio(){if(!(B.mobileUnlockAttempted||!B.isMobile())){B.mobileUnlockAttempted=!0;try{const e=B.audioContext.createBuffer(1,1,22050),t=B.audioContext.createBufferSource();t.buffer=e,t.connect(B.audioContext.destination),typeof t.start>"u"?t.noteOn(0):t.start(0),B.audioContext.state==="suspended"&&await B.audioContext.resume()}catch(e){console.warn("[REVERB-MOBILE] Failed to unlock audio context:",e)}}}static getSoundName(e){const t=e._src;return Array.isArray(t)&&t.length>0?t[0].split("/").pop()||"unknown":typeof t=="string"&&t.split("/").pop()||"unknown"}static logStep(e,t,i,s){}static async initialize(){if(B.initialized)return;let e=m.inputReceived;if(!e)try{await new Promise(t=>{const i=()=>{m.inputReceived?(t(),e=!0):requestAnimationFrame(i)};i()})}catch(t){console.error("Failed to wait for input:",t);return}if(!B.audioContext&&!B.initialized&&e)try{qt.Howler.ctx||await new Promise(i=>setTimeout(i,100)),B.audioContext=qt.Howler.ctx||new(window.AudioContext||window.webkitAudioContext),B.isMobile()&&await B.unlockMobileAudio(),B.audioContext.state==="suspended"&&await B.audioContext.resume(),B.convolver=B.audioContext.createConvolver(),B.convolver.connect(B.audioContext.destination),await B.loadReverbBuffer("res/SFX/impulses/small.mp3"),B.setDefaultReverb(),B.originalRefreshBuffer||(B.originalRefreshBuffer=qt.Howl.prototype._refreshBuffer,qt.Howl.prototype._refreshBuffer=function(i){const s=B.getSoundName(this);if(B.logStep("A",s,"Intercepted _refreshBuffer",i._id),B.isMobile()&&B.audioContext.state==="suspended"&&B.audioContext.resume().then(()=>{B.logStep("A-MOBILE",s,"Resumed suspended context",i._id)}),B.originalRefreshBuffer.call(this,i),i._node&&i._node.bufferSource){B.logStep("B",s,"Setting up reverb routing",i._id),i._node.bufferSource.disconnect();let a=B.gainNodes.get(i._id);if(!a){a=B.audioContext.createGain();const n=this._volume||1;a.gain.setValueAtTime(n,B.audioContext.currentTime),a.connect(B.convolver),B.gainNodes.set(i._id,a),B.logStep("C",s,`Created gain node with volume ${n}`,i._id)}i._node.bufferSource.connect(a),B.logStep("D",s,"Connected to reverb gain node",i._id)}}),B.initialized=!0,H.initialized&&(H.audioMuted=!1);const t=B.isMobile()?"MOBILE":"DESKTOP"}catch(t){console.error("Failed to initialize ReverbEngine:",t),B.initialized=!0,H.initialized&&(H.audioMuted=!1)}}static async loadReverbBuffer(e){try{const t=await fetch(e);if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);const i=await t.arrayBuffer();B.reverbBuffer=await B.audioContext.decodeAudioData(i)}catch(t){console.error("Error loading reverb buffer:",t)}}static setDefaultReverb(){B.reverbBuffer&&(B.convolver.buffer=B.reverbBuffer)}static async setReverbImpulse(e){if(B.initialized)try{await B.loadReverbBuffer(e),B.reverbBuffer&&(B.convolver.buffer=B.reverbBuffer)}catch(t){console.error("Error setting reverb impulse:",t)}}static applyReverb(e){return B.getSoundName(e),B.initialized&&B.isMobile()&&B.audioContext.state!=="running"&&B.audioContext.resume().catch(t=>{console.warn("[REVERB-MOBILE] Could not resume audio context:",t)}),e.play()}static removeReverb(e){B.getSoundName(e);for(const[t,i]of B.gainNodes.entries())i&&(i.disconnect(),B.gainNodes.delete(t))}static cleanup(){B.originalRefreshBuffer&&(qt.Howl.prototype._refreshBuffer=B.originalRefreshBuffer);for(const[e,t]of B.gainNodes.entries())t&&t.disconnect();B.gainNodes.clear(),B.convolver&&B.convolver.disconnect(),B.audioContext&&B.audioContext.state!=="closed"&&B.audioContext.close(),B.initialized=!1}};r(B,"audioContext"),r(B,"convolver"),r(B,"reverbBuffer",null),r(B,"gainNodes",new Map),r(B,"originalRefreshBuffer"),r(B,"mobileUnlockAttempted",!1),r(B,"initialized",!1);let Fe=B;var S;let H=(S=class{static detectMobile(){const e=navigator.userAgent||navigator.vendor||window.opera;return S.isMobile=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(e),S.isMobile}static async enableAudioForMobile(){if(!S.audioContextResumed)try{qt.Howler.ctx&&qt.Howler.ctx.state==="suspended"&&(await qt.Howler.ctx.resume(),S.audioContextResumed=!0,console.log("AudioContext resumed"))}catch(e){console.warn("Could not resume AudioContext:",e)}}static addMobileAudioHandlers(){const e=async()=>{await S.enableAudioForMobile(),S.audioMuted&&Fe.initialized&&(S.audioMuted=!1,qt.Howler.mute(!1))},t=["touchstart","click","keydown"],i=()=>{e(),t.forEach(s=>{document.removeEventListener(s,i)})};t.forEach(s=>{document.addEventListener(s,i,{once:!0})})}static toggleMute(){S.audioMuted=!S.audioMuted,S.audioMuted?qt.Howler.mute(!0):(qt.Howler.mute(!1),S.isMobile&&S.enableAudioForMobile())}static playWithReverb(e,t=S.PRIORITY.INTERACTIONS){if(S.audioMuted)return null;try{if(S.currentlyPlaying.size>10&&t<S.PRIORITY.COMBAT)return null;let i=null;return Fe.initialized&&!S.isMobile?i=Fe.applyReverb(e):i=e.play(),i&&(S.currentlyPlaying.add(i),e.once("end",()=>{S.currentlyPlaying.delete(i)}),setTimeout(()=>{S.currentlyPlaying.delete(i)},5e3)),i}catch(i){return console.error("Error playing sound:",i),null}}static stopSound(e){e.stop()}static stopSoundWithReverb(e){Fe.removeReverb(e),this.stopSound(e)}static cleanup(){S.currentlyPlaying.clear(),qt.Howler.unload()}},r(S,"playerStoneFootsteps"),r(S,"playerGrassFootsteps"),r(S,"playerDirtFootsteps"),r(S,"enemyFootsteps"),r(S,"hitSounds"),r(S,"enemySpawnSound"),r(S,"chestSounds"),r(S,"coinPickupSounds"),r(S,"miningSounds"),r(S,"breakRockSound"),r(S,"hurtSounds"),r(S,"genericPickupSound"),r(S,"pushSounds"),r(S,"healSound"),r(S,"forestMusic"),r(S,"caveMusic"),r(S,"graveSound"),r(S,"ambientSound"),r(S,"goreSound"),r(S,"swingSounds"),r(S,"unlockSounds"),r(S,"doorOpenSounds"),r(S,"potSmashSounds"),r(S,"keyPickupSound"),r(S,"magicSound"),r(S,"wooshSounds"),r(S,"initialized",!1),r(S,"audioMuted",!0),r(S,"bombSounds"),r(S,"fuseBurnSound"),r(S,"fuseLoopSound"),r(S,"fuseStartSound"),r(S,"warHammerSound"),r(S,"sliceSound"),r(S,"shortSliceSound"),r(S,"backpackSound"),r(S,"smithSound"),r(S,"bushSounds"),r(S,"parrySounds"),r(S,"eatSounds"),r(S,"gruntSounds"),r(S,"lockedSound"),r(S,"woodSound"),r(S,"squishSound"),r(S,"fishingCastSounds"),r(S,"fishingReelSound"),r(S,"fishingCatchSounds"),r(S,"crushSounds"),r(S,"currentlyPlaying",new Set),r(S,"PRIORITY",{AMBIENT:1,FOOTSTEPS:2,INTERACTIONS:3,COMBAT:4,CRITICAL:5}),r(S,"isMobile",!1),r(S,"audioContextResumed",!1),r(S,"forestMusicId",null),r(S,"caveMusicId",null),r(S,"ambientSoundId",null),r(S,"loadSounds",async()=>{if(S.initialized)return;S.initialized=!0,S.detectMobile(),S.isMobile&&S.addMobileAudioHandlers(),Fe.initialized&&(S.audioMuted=!1);const e=(i,s,a=1,n=3)=>s.map(c=>new qt.Howl({src:[`${i}${c}.mp3`],volume:a,preload:!0,html5:!1,pool:n})),t=(i,s=1,a=!1,n=2)=>new qt.Howl({src:[i],volume:s,preload:!0,loop:a,html5:!1,pool:n});try{S.magicSound=t("res/SFX/attacks/magic2.mp3",.25,!1,3),S.warHammerSound=t("res/SFX/attacks/warhammer.mp3",1,!1,3),S.healSound=t("res/SFX/items/powerup1.mp3",.5,!1,1),S.eatSounds=e("res/SFX/items/eat",[1,2],1,5),S.playerStoneFootsteps=e("res/SFX/footsteps/stone/footstep",[1,2,3],1,4),S.playerGrassFootsteps=e("res/SFX/footsteps/grass/footstep",[1,2,3,6],1,4),S.playerDirtFootsteps=e("res/SFX/footsteps/dirt/footstep",[1,2,3,4,5],1,4),S.enemyFootsteps=e("res/SFX/footsteps/enemy/enemyfootstep",[1,2,3,4,5],1,4),S.swingSounds=e("res/SFX/attacks/swing",[1,2,3,4],.5,6),S.hitSounds=e("res/SFX/attacks/hurt",[1,2,3,4],.5,4),S.hurtSounds=[t("res/SFX/attacks/hit.mp3",.3,!1,0)],S.sliceSound=e("res/SFX/attacks/slice",[1,2,3],.5,4),S.shortSliceSound=e("res/SFX/attacks/sliceShort",[1,2,3],.5,4),S.parrySounds=e("res/SFX/attacks/parry",[1,2],.5,3),S.gruntSounds=e("res/SFX/attacks/grunt",[1],.35,1),S.enemySpawnSound=t("res/SFX/attacks/enemyspawn.mp3",.7,!1,3),S.wooshSounds=e("res/SFX/attacks/woosh",[1,2],.2,3),S.chestSounds=e("res/SFX/chest/chest",[1,2,3],.5,3),S.coinPickupSounds=e("res/SFX/items/coins",[1,2,3,4],1,5),S.genericPickupSound=t("res/SFX/items/pickup.mp3",.8,!1,3),S.keyPickupSound=t("res/SFX/items/keyPickup.mp3",1,!1,2),S.backpackSound=t("res/SFX/items/backpack.mp3",.75,!1,2),S.smithSound=t("res/SFX/items/smith.mp3",.5,!1,2),S.lockedSound=t("res/SFX/door/locked1.mp3",.75,!1,2),S.woodSound=t("res/SFX/objects/woodHit1.mp3",1.25,!1,2),S.squishSound=t("res/SFX/attacks/squish1.mp3",.75,!1,2),S.crushSounds=e("res/SFX/attacks/crush",[1,2],.4,2),S.miningSounds=e("res/SFX/resources/Pickaxe",[1,2,3,4],.3,3),S.breakRockSound=t("res/SFX/resources/rockbreak.mp3",1,!1,2),S.unlockSounds=e("res/SFX/door/unlock",[1],.5,2),S.doorOpenSounds=e("res/SFX/door/open",[1,2],.5,3),S.potSmashSounds=e("res/SFX/objects/potSmash",[1,2,3],.5,3),S.bushSounds=e("res/SFX/objects/plantHit",[1,2],.75,3),S.pushSounds=e("res/SFX/pushing/push",[1,2],1,3),S.fishingCastSounds=e("res/SFX/fishing/cast",[1,2],.5,3),S.fishingReelSound=t("res/SFX/fishing/catch.mp3",.5,!1,2),S.fishingCatchSounds=e("res/SFX/fishing/splash",[1,2],.85,3),S.bombSounds=e("res/SFX/attacks/explode",[1,2],.7,3),S.fuseBurnSound=t("res/SFX/attacks/fuse.mp3",.2,!1,2),S.fuseLoopSound=t("res/SFX/attacks/fuseLoop.mp3",.2,!0,1),S.fuseStartSound=t("res/SFX/attacks/fuseStart.mp3",.2,!1,2),S.forestMusic=t("res/music/forest1.mp3",.25,!0,1),S.caveMusic=t("res/music/cave1.mp3",.25,!0,1),S.graveSound=t("res/SFX/attacks/skelespawn.mp3",1,!1,2),S.ambientSound=t("res/SFX/ambient/ambientDark2.mp3",.3,!0,1),S.goreSound=t("res/SFX/misc Unused/gore2.mp3",.5,!1,2),console.log("All sounds loaded successfully")}catch(i){console.error("Error loading sounds:",i)}}),r(S,"playerStoneFootstep",e=>{if(S.audioMuted)return;let t=S.playerStoneFootsteps;e===2&&(t=S.playerGrassFootsteps),e===1&&(t=S.playerDirtFootsteps);let i=m.randTable(t,O.rand);S.playWithReverb(i,S.PRIORITY.FOOTSTEPS)}),r(S,"enemyFootstep",()=>{if(S.audioMuted)return;let e=m.randTable(S.enemyFootsteps,O.rand);S.playWithReverb(e,S.PRIORITY.FOOTSTEPS)}),r(S,"swing",()=>{if(S.audioMuted)return;let e=m.randTable(S.swingSounds,O.rand);S.playWithReverb(e,S.PRIORITY.COMBAT)}),r(S,"hit",(e=!1)=>{if(S.audioMuted)return;let t=S.hitSounds.slice(e?2:0,e?3:2);setTimeout(()=>{let i=m.randTable(t,O.rand);S.playWithReverb(i,S.PRIORITY.COMBAT)},100)}),r(S,"hurt",()=>{if(S.audioMuted)return;let e=m.randTable(S.hurtSounds,O.rand);S.playWithReverb(e,S.PRIORITY.CRITICAL)}),r(S,"enemySpawn",()=>{S.audioMuted||S.playWithReverb(S.enemySpawnSound,S.PRIORITY.CRITICAL)}),r(S,"chest",()=>{if(S.audioMuted)return;let e=m.randTable(S.chestSounds,O.rand);S.playWithReverb(e,S.PRIORITY.INTERACTIONS)}),r(S,"potSmash",()=>{if(S.audioMuted)return;let e=m.randTable(S.potSmashSounds,O.rand);S.delayPlay(()=>S.playWithReverb(e,S.PRIORITY.INTERACTIONS),100)}),r(S,"pickupCoin",()=>{if(S.audioMuted)return;let e=m.randTable(S.coinPickupSounds,O.rand);S.playWithReverb(e,S.PRIORITY.INTERACTIONS)}),r(S,"mine",()=>{if(S.audioMuted)return;let e=m.randTable(S.miningSounds,O.rand);S.playWithReverb(e,S.PRIORITY.INTERACTIONS)}),r(S,"breakRock",()=>{S.audioMuted||setTimeout(()=>{S.playWithReverb(S.breakRockSound,S.PRIORITY.INTERACTIONS)},100)}),r(S,"heal",()=>{S.audioMuted||S.playWithReverb(S.healSound,S.PRIORITY.CRITICAL)}),r(S,"genericPickup",()=>{S.audioMuted||S.playWithReverb(S.genericPickupSound,S.PRIORITY.INTERACTIONS)}),r(S,"keyPickup",()=>{S.audioMuted||S.playWithReverb(S.keyPickupSound,S.PRIORITY.INTERACTIONS)}),r(S,"push",()=>{if(S.audioMuted)return;let e=m.randTable(S.pushSounds,O.rand);S.playWithReverb(e,S.PRIORITY.INTERACTIONS)}),r(S,"skeleSpawn",()=>{S.audioMuted||(S.graveSound.volume(.3),S.playWithReverb(S.graveSound,S.PRIORITY.CRITICAL))}),r(S,"unlock",()=>{if(S.audioMuted)return;let e=m.randTable(S.unlockSounds,O.rand);S.playWithReverb(e,S.PRIORITY.INTERACTIONS)}),r(S,"playCaveMusic",(e=0)=>{if(!S.audioMuted)try{S.caveMusicId&&S.caveMusic.stop(S.caveMusicId),S.caveMusicId=S.caveMusic.play(),S.isMobile&&!S.audioContextResumed&&S.enableAudioForMobile()}catch(t){console.error("Error playing cave music:",t)}}),r(S,"playForestMusic",(e=0)=>{if(!S.audioMuted)try{S.forestMusicId&&S.forestMusic.stop(S.forestMusicId),S.forestMusicId=S.forestMusic.play(),S.isMobile&&!S.audioContextResumed&&S.enableAudioForMobile()}catch(t){console.error("Error playing forest music:",t)}}),r(S,"doorOpen",()=>{if(S.audioMuted)return;let e=m.randTable(S.doorOpenSounds,O.rand);S.playWithReverb(e,S.PRIORITY.INTERACTIONS)}),r(S,"playAmbient",()=>{if(!S.audioMuted)try{(!S.ambientSoundId||!S.ambientSound.playing(S.ambientSoundId))&&(S.ambientSoundId=S.ambientSound.play())}catch(e){console.error("Error playing ambient sound:",e)}}),r(S,"stopAmbient",()=>{S.ambientSoundId&&(S.ambientSound.stop(S.ambientSoundId),S.ambientSoundId=null)}),r(S,"playFuse",()=>{S.audioMuted||(S.fuseStartSound.play(),S.fuseStartSound.once("end",()=>{S.fuseLoopSound.play()}))}),r(S,"stopFuse",()=>{S.fuseLoopSound.stop(),S.fuseStartSound.stop()}),r(S,"playGore",()=>{S.audioMuted||S.playWithReverb(S.goreSound,S.PRIORITY.COMBAT)}),r(S,"playBomb",()=>{if(S.audioMuted)return;let e=m.randTable(S.bombSounds,O.rand);S.playWithReverb(e,S.PRIORITY.CRITICAL)}),r(S,"playWarHammer",()=>{S.audioMuted||S.delayPlay(()=>{S.playWithReverb(S.hitSounds[2],S.PRIORITY.COMBAT)},200)}),r(S,"playMagic",()=>{if(S.audioMuted)return;S.playWithReverb(S.magicSound,S.PRIORITY.COMBAT);let e=S.wooshSounds[0];S.playWithReverb(e,S.PRIORITY.COMBAT)}),r(S,"playSlice",()=>{if(S.audioMuted)return;let e=m.randTable(S.sliceSound,O.rand);S.playWithReverb(e,S.PRIORITY.COMBAT)}),r(S,"playShortSlice",()=>{if(S.audioMuted)return;let e=m.randTable(S.shortSliceSound,O.rand);S.playWithReverb(e,S.PRIORITY.COMBAT)}),r(S,"playBackpack",()=>{S.audioMuted||S.playWithReverb(S.backpackSound,S.PRIORITY.INTERACTIONS)}),r(S,"playSmith",()=>{S.audioMuted||S.playWithReverb(S.smithSound,S.PRIORITY.INTERACTIONS)}),r(S,"playBush",()=>{if(S.audioMuted)return;let e=m.randTable(S.bushSounds,O.rand);S.delayPlay(()=>S.playWithReverb(e,S.PRIORITY.INTERACTIONS),100)}),r(S,"playParry",()=>{if(S.audioMuted)return;let e=m.randTable(S.parrySounds,O.rand);S.delayPlay(()=>S.playWithReverb(e,S.PRIORITY.CRITICAL),100)}),r(S,"playEat",()=>{if(S.audioMuted)return;let e=m.randTable(S.eatSounds,O.rand);S.playWithReverb(e,S.PRIORITY.INTERACTIONS)}),r(S,"playGrunt",()=>{if(S.audioMuted)return;let e=m.randTable(S.gruntSounds,O.rand);S.playWithReverb(e,S.PRIORITY.COMBAT)}),r(S,"playLocked",()=>{S.audioMuted||S.playWithReverb(S.lockedSound,S.PRIORITY.INTERACTIONS)}),r(S,"playWood",()=>{S.audioMuted||S.delayPlay(()=>{S.playWithReverb(S.woodSound,S.PRIORITY.INTERACTIONS)},150)}),r(S,"playSquish",()=>{S.audioMuted||S.playWithReverb(S.squishSound,S.PRIORITY.INTERACTIONS)}),r(S,"playFishingCast",()=>{if(S.audioMuted)return;let e=m.randTable(S.fishingCastSounds,O.rand);S.playWithReverb(e,S.PRIORITY.INTERACTIONS)}),r(S,"playFishingReel",()=>{S.audioMuted||S.playWithReverb(S.fishingReelSound,S.PRIORITY.INTERACTIONS)}),r(S,"playFishingCatch",()=>{if(S.audioMuted)return;let e=m.randTable(S.fishingCatchSounds,O.rand);S.delayPlay(()=>S.playWithReverb(e,S.PRIORITY.INTERACTIONS),100)}),r(S,"playCrush",()=>{if(S.audioMuted)return;let e=S.wooshSounds[1],t=S.crushSounds[1];S.playWithReverb(e,S.PRIORITY.COMBAT),S.delayPlay(()=>{S.playWithReverb(t,S.PRIORITY.COMBAT)},200),S.playWithReverb(e,S.PRIORITY.COMBAT)}),r(S,"delayPlay",(e,t)=>{setTimeout(e,t)}),S);class xi{constructor(){r(this,"drawableY",0);r(this,"shouldDrawAbovePlayer",!1);r(this,"draw",e=>{});r(this,"hasBloom",!1);r(this,"bloomColor","#FFFFFF");r(this,"bloomAlpha",1);r(this,"softBloomAlpha",0);r(this,"updateBloom",e=>{if(this.hasBloom){let t=this.softBloomAlpha-this.bloomAlpha;Math.abs(t)>.001?this.softBloomAlpha=this.softBloomAlpha-t*.1*e:this.softBloomAlpha=this.bloomAlpha}else this.softBloomAlpha=0})}}const ke=class ke{};r(ke,"distance",(e,t,i,s)=>Math.sqrt((i-e)**2+(s-t)**2)),r(ke,"calculateExponentialFalloff",(e,t)=>Math.exp(-t*e)),r(ke,"hsvToHex",(e,t,i)=>{let s=i*t,a=s*(1-Math.abs(e/60%2-1)),n=i-s,c=0,l=0,d=0;e>=0&&e<60?(c=s,l=a,d=0):e>=60&&e<120?(c=a,l=s,d=0):e>=120&&e<180?(c=0,l=s,d=a):e>=180&&e<240?(c=0,l=a,d=s):e>=240&&e<300?(c=a,l=0,d=s):(c=s,l=0,d=a);const u=Math.round((c+n)*255),h=Math.round((l+n)*255),f=Math.round((d+n)*255);return ke.rgbToHex(u,h,f)}),r(ke,"rgbToHex",(e,t,i)=>{const s=a=>{const n=a.toString(16);return n.length===1?"0"+n:n};return`#${s(e)}${s(t)}${s(i)}`}),r(ke,"randomSineInt",(e,t,i={})=>{const s=Math.ceil(t),a=Math.floor(e),n=s-a+1,{median:c=a+(n-1)/2}=i,l=Math.min(Math.max(c,a),s),d=O.rand()*2*Math.PI,u=O.rand()*2*Math.PI,h=(Math.cos(d)+Math.cos(u)+2)/4,f=(l-a)/(n-1),p=.7,y=h*(1-p)+(h<.5?h*(f/.5):f+(h-.5)*2*(1-f))*p,g=.001,w=Math.min(Math.max(y,g),1-g),b=Math.floor(w*n)+a;return Math.min(Math.max(b,a),s)}),r(ke,"randTableWeighted",e=>{if(!e||e.length===0)return null;if(!e.some(a=>a&&typeof a.weight=="number"))return e[m.rand(0,e.length-1,O.rand)];const i=e.reduce((a,n)=>a+(n&&typeof n.weight=="number"?n.weight:0),0);if(i<=0)return e[m.rand(0,e.length-1,O.rand)];let s=O.rand()*i;for(const a of e)if(a&&typeof a.weight=="number"&&(s-=a.weight,s<=0))return a;return e[e.length-1]}),r(ke,"randomNormalInt",(e,t,i={})=>{const{median:s=e+(t-e)/2}=i,a=(t-e)/5;let n=O.rand(),c=O.rand();for(;n===0;)n=O.rand();const d=Math.sqrt(-2*Math.log(n))*Math.cos(2*Math.PI*c)*a+s,u=Math.max(0,d);return Math.round(u)});let Q=ke;class se{static generate(e=""){let t;do{const i=(this._next++).toString(36);t=e?`${e}-${i}`:i}while(this._registry.has(t));return this._registry.add(t),t}static reserve(e){if(this._registry.has(e))throw new Error(`Duplicate ID detected while reserving: ${e}`);this._registry.add(e)}static isReserved(e){return this._registry.has(e)}static resetForTest(){this._next=BigInt(1),this._registry.clear()}}r(se,"_next",BigInt(1)),r(se,"_registry",new Set);class Di{static draw(e,t,i=1,s=1){m.ctx.save(),m.ctx.globalAlpha=.3,i>1||s>1?m.drawFX(30,3,2,2,e,t+.5,2,2,"black"):m.drawFX(30,1,2,2,e-.5,t-.5,2,2,"black"),m.ctx.restore()}}r(Di,"_canvas"),r(Di,"_ctx"),r(Di,"_blurRenderer");var F=(o=>(o[o.DUNGEON=0]="DUNGEON",o[o.CAVE=1]="CAVE",o[o.FOREST=2]="FOREST",o[o.CASTLE=3]="CASTLE",o[o.GLACIER=4]="GLACIER",o[o.DARK_CASTLE=5]="DARK_CASTLE",o[o.PLACEHOLDER=6]="PLACEHOLDER",o[o.DESERT=7]="DESERT",o[o.MAGMA_CAVE=8]="MAGMA_CAVE",o))(F||{});const ph=o=>{switch(o){case 0:return"DUNGEON";case 1:return"CAVE";case 2:return"FOREST";case 3:return"CASTLE";case 4:return"GLACIER";case 5:return"DARK_CASTLE";case 6:return"PLACEHOLDER";case 7:return"DESERT";case 8:return"MAGMA_CAVE"}};class gh{constructor(){r(this,"events",{})}on(e,t){this.events[e]||(this.events[e]=[]),this.events[e].push(t)}off(e,t){this.events[e]&&(this.events[e]=this.events[e].filter(i=>i!==t))}emit(e,t){this.events[e]&&this.events[e].forEach(i=>i(t))}removeAllListeners(e){delete this.events[e]}}const Ai=class Ai{constructor(){r(this,"eventEmitter");this.eventEmitter=new gh}static getInstance(){return Ai.instance||(Ai.instance=new Ai),Ai.instance}emit(e,t){this.eventEmitter.emit(e,t)}on(e,t){this.eventEmitter.on(e,t)}off(e,t){this.eventEmitter.off(e,t)}};r(Ai,"instance");let Ua=Ai;const ht=Ua.getInstance(),xt={KEY_DOWN:"KEY_DOWN",KEY_UP:"KEY_UP",MOUSE_LEFT_CLICK:"MOUSE_LEFT_CLICK",MOUSE_RIGHT_CLICK:"MOUSE_RIGHT_CLICK",MOUSE_MOVE:"MOUSE_MOVE",TOUCH_START:"TOUCH_START",TOUCH_MOVE:"TOUCH_MOVE",TOUCH_END:"TOUCH_END",TAP:"TAP",TAP_HOLD:"TAP_HOLD",MOUSE_DOWN:"MOUSE_DOWN",MOUSE_UP:"MOUSE_UP",CHAT_MESSAGE:"ChatMessage",ENEMY_SEEN_PLAYER:"EnemySeenPlayer",ENEMY_KILLED:"ENEMY_KILLED",DAMAGE_DONE:"DAMAGE_DONE",DAMAGE_TAKEN:"DAMAGE_TAKEN",TURN_PASSED:"TURN_PASSED",COIN_COLLECTED:"COIN_COLLECTED",ITEM_COLLECTED:"ITEM_COLLECTED",LEVEL_GENERATION_STARTED:"LEVEL_GENERATION_STARTED",LEVEL_GENERATION_COMPLETED:"LEVEL_GENERATION_COMPLETED"};class br{constructor(){r(this,"stats",br.initialStats());r(this,"handleEnemyKilled",e=>{this.stats.enemiesKilled+=1,this.stats.enemies.push(e.enemyId),this.stats.xp+=e.xp,this.stats.level=Math.floor(this.stats.xp/100)+1});r(this,"handleDamageDone",e=>{this.stats.damageDone+=e.amount});r(this,"handleDamageTaken",e=>{this.stats.damageTaken+=e.amount});r(this,"handleTurnPassed",()=>{this.stats.turnsPassed+=1});r(this,"handleCoinCollected",e=>{this.stats.coinsCollected+=e.amount});r(this,"handleItemCollected",e=>{this.stats.itemsCollected+=1});this.initializeListeners()}static initialStats(){return{enemiesKilled:0,damageDone:0,damageTaken:0,turnsPassed:0,coinsCollected:0,itemsCollected:0,enemies:[],weaponChoice:null,sidePathsEntered:[],xp:0,level:1}}initializeListeners(){ht.on(xt.ENEMY_KILLED,this.handleEnemyKilled),ht.on(xt.DAMAGE_DONE,this.handleDamageDone),ht.on(xt.DAMAGE_TAKEN,this.handleDamageTaken),ht.on(xt.TURN_PASSED,this.handleTurnPassed),ht.on(xt.COIN_COLLECTED,this.handleCoinCollected),ht.on(xt.ITEM_COLLECTED,this.handleItemCollected)}getStats(){return this.stats}getXp(){return this.stats.xp}increaseXp(e){this.stats.xp+=e}recordWeaponChoice(e){this.stats.weaponChoice=e}recordSidePathEntered({depth:e,sidePath:t}){this.stats.sidePathsEntered.push({depth:e,sidePath:ph(t)})}resetStats(){this.stats=br.initialStats()}setStats(e){this.stats=e}}const $e=new br;class me extends xi{constructor(t,i,s){super();r(this,"globalId");r(this,"x");r(this,"y");r(this,"w");r(this,"h");r(this,"offsetY");r(this,"tileX");r(this,"tileY");r(this,"frame");r(this,"level");r(this,"stackable");r(this,"stackCount");r(this,"pickedUp");r(this,"alpha");r(this,"scaleFactor");r(this,"name");r(this,"startY");r(this,"randomOffset");r(this,"durability");r(this,"durabilityMax");r(this,"broken");r(this,"description");r(this,"drawOffset");r(this,"pickupOffsetY");r(this,"inChest");r(this,"chestOffsetY");r(this,"sineAnimateFactor");r(this,"iconOffset");r(this,"grouped");r(this,"group",null);r(this,"degradeable",!0);r(this,"cooldown",0);r(this,"maximumStackCount",8);r(this,"animateToInventory",!1);r(this,"animStartX",0);r(this,"animStartY",0);r(this,"animTargetX",0);r(this,"animTargetY",0);r(this,"animT",0);r(this,"animStartDistance",null);r(this,"player");r(this,"hoverText",()=>this.name);r(this,"tick",()=>{});r(this,"tickInInventory",()=>{});r(this,"getDescription",()=>{const t=this.stackable?`
Amount: ${this.stackCount}`:"";return`${this.name} 
${this.description} 
${t}`});r(this,"animateFromChest",()=>{this.chestOffsetY=.5,this.alpha=0,this.inChest=!0,this.sineAnimateFactor=0,this.setDrawOffset()});r(this,"pickupSound",()=>{this.level===this.level.game.room&&H.genericPickup()});r(this,"onDrop",()=>{});r(this,"onPickup",t=>{t.inventory.canPickup(this)&&(this.player=t,this.pickedUp||(this.startY=t.y,this.drawableY=this.y,this.alpha=1,this.pickedUp=t.inventory.addItem(this),this.pickedUp&&(this.animateToInventory===!0&&(this.animStartX=this.x,this.animStartY=this.y,this.animTargetX=this.player.x,this.animTargetY=this.player.y,this.animT=0),this.isNewItem(t)&&(this.pickupMessage(),t.inventory.foundItems.push(this)),this.pickupSound(),ht.emit(xt.ITEM_COLLECTED,{itemId:this.name}),this.grouped&&($e.recordWeaponChoice(this.name),this.group.destroyOtherItems(this),this.grouped=!1,this.group=null))))});r(this,"autoPickup",()=>{});r(this,"pickupMessage",()=>{const t=this.constructor.itemName;let i=this.stackable?`You find ${this.stackCount} ${t}.`:`You find a ${t}.`;this.stackCount>1&&this.name==="coin"&&(i=`You find ${this.stackCount} ${t}s.`),this.level.game.pushMessage(i)});r(this,"isNewItem",t=>{for(let i of t.inventory.foundItems)if(i.constructor===this.constructor)return!1;return!0});r(this,"dropFromInventory",()=>{this.setDrawOffset()});r(this,"shadeAmount",()=>{var t;return x.SMOOTH_LIGHTING&&!x.SHADE_INLINE_IN_ENTITY_LAYER?0:this.level.softVis[this.x]?(t=this.level.softVis[this.x])==null?void 0:t[this.y]:(console.warn("tried to get shade for tile that does not exist",this.x,this.y),0)});r(this,"drawStatus",(t,i)=>{});r(this,"drawBrokenSymbol",(t,i)=>{this.broken&&m.drawFX(5,0,1,1,t-.5/x.TILESIZE,i-.5/x.TILESIZE,1,1)});r(this,"draw",t=>{if(m.ctx.save(),!this.pickedUp){m.ctx.globalAlpha=this.alpha,this.alpha<1&&(this.alpha+=.01*t),this.drawableY=this.y,this.inChest&&(this.chestOffsetY-=Math.abs(this.chestOffsetY+.5)*.035*t,this.chestOffsetY<-.47&&(this.chestOffsetY=-.5)),this.sineAnimateFactor<1&&this.chestOffsetY<-.45&&(this.sineAnimateFactor+=.2*t),this.scaleFactor>0&&(this.scaleFactor*=.5**t,this.scaleFactor<.01&&(this.scaleFactor=0));const i=1/(this.scaleFactor+1);m.ctx.imageSmoothingEnabled=!1,Di.draw(this.x,this.y,1,1),this.frame+=t*(Math.PI*2)/60,m.drawItem(this.tileX,this.tileY,1,2,this.x+this.w*(i*-.5+.5)+this.drawOffset,this.y+this.sineAnimateFactor*Math.sin(this.frame)*.07-1+this.offsetY+this.h*(i*-.5+.5)+this.chestOffsetY,this.w*i,this.h*i,this.level.shadeColor,this.shadeAmount())}m.ctx.restore()});r(this,"setDrawOffset",()=>{const t=this.level.items.filter(i=>i.x===this.x&&i.y===this.y);t.length>1&&t.forEach(i=>{i.drawOffset=(-t.length/2+t.indexOf(i)+1)/t.length})});r(this,"degrade",()=>{this.degradeable&&(this.durability-=1)});r(this,"drawAboveShading",t=>{if(this.pickedUp)if(this.animateToInventory===!0&&this.player){const i=.025*t;this.animT=Math.min(1,this.animT+i);const s=Math.pow(this.animT,2),a=this.animStartX*(1-s)+this.animTargetX*s+(this.player.x-this.animTargetX-this.player.drawX)*s+this.drawOffset,n=this.animStartY*(1-s)+this.animTargetY*s+(this.player.y-this.animTargetY-this.player.drawY)*s+this.chestOffsetY;this.animStartDistance===null&&(this.animStartDistance=Q.distance(this.player.x-this.player.drawX,this.player.y-this.player.drawY,a,n));const c=Math.abs(Q.distance(this.player.x-this.player.drawX,this.player.y-this.player.drawY,a,n)),l=.5;if(s>l){const d=(s-l)/(1-l);this.alpha=Math.max(1-d,Math.abs(c/this.animStartDistance))}m.ctx.globalAlpha=Math.max(0,this.alpha),this.x=Math.floor(a),this.y=Math.floor(n),m.drawItem(this.tileX,this.tileY,1,2,a,n-1.5,this.w,this.h,this.level.shadeColor,this.shadeAmount()),m.ctx.globalAlpha=1,this.animT>=1&&(this.animateToInventory=!1,this.level.items=this.level.items.filter(d=>d!==this));return}else return});r(this,"drawTopLayer",t=>{if(this.pickedUp){if(this.animateToInventory===!1)this.pickupOffsetY+=(4.5-this.pickupOffsetY)*.1*t;else return;this.alpha*=.9**t,Math.abs(this.alpha)<.01&&(this.drawOffset=0,this.pickupOffsetY=1,this.level.items=this.level.items.filter(i=>i!==this)),m.ctx.globalAlpha=Math.max(0,this.alpha),m.drawItem(this.tileX,this.tileY,1,2,this.x,this.y-this.pickupOffsetY,this.w,this.h),m.ctx.globalAlpha=1}});r(this,"drawIcon",(t,i,s,a=1,n)=>{m.ctx.globalAlpha=a,this.drawDurability(i,s);let c=0;this.durability<=1&&!this.broken&&(c=Math.round(Math.sin(Date.now()/25)+1/2)/2/x.TILESIZE),this.cooldown>0&&(m.ctx.globalAlpha=.35),m.drawItem(this.tileX,this.tileY,1,2,i+c,s-1+this.iconOffset,this.w,this.h),m.ctx.globalAlpha=1;let l=n||this.stackCount,d=l<=1?"":""+l,h=16-m.measureText(d).width;m.fillTextOutline(d,i*x.TILESIZE+h,s*x.TILESIZE+10,x.OUTLINE,"white"),this.drawCooldown(i,s),this.drawStatus(i,s),this.drawBrokenSymbol(i,s)});r(this,"drawCooldown",(t,i)=>{this.cooldown>0&&m.fillTextOutline(this.cooldown.toString(),t*x.TILESIZE+10,i*x.TILESIZE+10,x.OUTLINE,"white")});r(this,"drawDurability",(t,i)=>{if(this.durability<this.durabilityMax){const s=this.durability/this.durabilityMax;let a=Q.hsvToHex(120*s,1,1);const n=x.TILESIZE,c=Math.ceil(s*n),l=2,d=Math.ceil(t*x.TILESIZE),u=Math.ceil(i*x.TILESIZE+x.TILESIZE-2);m.ctx.fillStyle=a,m.ctx.imageSmoothingEnabled=!1,m.ctx.fillRect(d,u,c,l),m.ctx.fillStyle="white"}});this.globalId=se.generate("IT"),this.level=t,this.x=i,this.y=s,this.drawableY=s,this.w=1,this.h=2,this.tileX=0,this.tileY=0,this.frame=0,this.stackable=!1,this.stackCount=1,this.pickedUp=!1,this.alpha=1,this.scaleFactor=5,this.offsetY=-.5,this.name="item",this.startY=s,this.randomOffset=O.rand(),this.durability=50,this.durabilityMax=50,this.broken=!1,this.description="",this.drawOffset=0,this.pickupOffsetY=1,this.chestOffsetY=0,this.sineAnimateFactor=1,this.iconOffset=0,this.grouped=!1,this.group=null,this.maximumStackCount=12,this.animateToInventory=!1,this.player=null}static add(t,i,s,...a){return new this(t,i,s,...a)}destroy(){this.pickedUp=!0}}r(me,"itemName");class G{}r(G,"LIMIT_ENEMY_TYPES",!0),r(G,"MEDIAN_ROOM_DENSITY",.25),r(G,"UNLIMITED_SPAWNERS",!0),r(G,"THROTTLE_SPAWNERS",!0),r(G,"NO_ENEMIES",!1),r(G,"EQUIP_USES_TURN",!1),r(G,"UNBREAKABLE_ITEMGROUP_LOOT",!1),r(G,"PRESET_BOSSES",!1),r(G,"PNG_LEVEL_PROBABILITY",.1),r(G,"MAIN_PATH_BRANCHING",.1),r(G,"MAIN_PATH_LOOPINESS",.05),r(G,"BASE_ENEMY_ALERT_RANGE",4),r(G,"BASE_ENEMY_ALERT_NEARBY_RANGE",2),r(G,"NEW_ENEMIES_PER_LEVEL",2),r(G,"ENEMY_TYPES_BASE_COUNT",4),r(G,"DEPTH_ZERO_ENEMY_TYPES",3),r(G,"SPAWNER_MIN_DEPTH",0),r(G,"OCCULTIST_MIN_DEPTH",1),r(G,"SPAWNER_SPAWN_CHANCE",.1),r(G,"OCCULTIST_SPAWN_CHANCE",.1),r(G,"SPAWNER_AREA_THRESHOLD",50),r(G,"OCCULTIST_AREA_THRESHOLD",200),r(G,"ENEMY_DENSITY_DEPTH_MULTIPLIER",.04),r(G,"ENEMY_DENSITY_DEPTH_OFFSET",2),r(G,"MAX_ENEMY_DENSITY",.25),r(G,"FOREST_ENEMY_REDUCTION",.25),r(G,"MAX_OCCULTIST_SHIELDS",7),r(G,"MAX_EXALTER_BUFFS",7);class vt extends me{constructor(t,i,s){super(t,i,s);r(this,"wielder",null);r(this,"equipped");r(this,"equipTick",!1);r(this,"useCost",1);r(this,"cooldown",0);r(this,"cooldownMax",0);r(this,"previousWeapon",null);r(this,"setWielder",t=>{this.wielder=t});r(this,"coEquippable",t=>!0);r(this,"toggleEquip",()=>{var t,i,s;if(!this.broken&&this.cooldown<=0||this instanceof Wt)!this.equipped&&((i=(t=this.wielder)==null?void 0:t.inventory)!=null&&i.weapon)&&(this.previousWeapon=this.wielder.inventory.weapon),this.equipped=!this.equipped,G.EQUIP_USES_TURN&&this.equipped===!0&&((s=this.wielder)==null||s.stall());else if(this.broken){this.equipped=!1;let a=this.name.endsWith("s")?"them":"it";this.level.game.pushMessage("You'll have to fix your "+this.name+" before you can use "+a+".")}else this.cooldown>0&&this.level.game.pushMessage("Cooldown: "+this.cooldown)});r(this,"drawEquipped",(t,i,s)=>{m.drawItem(this.tileX,this.tileY,1,2,i,s-1,this.w,this.h)});r(this,"degrade",(t=1)=>{this.degradeable&&(this.durability-=t*this.useCost,this.durability<=0&&this.break())});r(this,"break",()=>{this.durability=0,this.broken=!0,this.toggleEquip()});r(this,"onDrop",()=>{});r(this,"dropFromInventory",()=>{this.wielder=null,this.equipped=!1});this.equipped=!1}}class dt extends me{constructor(t,i,s){super(t,i,s);r(this,"user");r(this,"canUseOnOther");r(this,"onUse",t=>{});r(this,"useOnOther",(t,i)=>{});this.canUseOnOther=!1}}class ei extends dt{constructor(t,i,s,a){super(t,i,s);r(this,"onUse",t=>{t.health=Math.min(t.maxHealth,t.health+1),(t!=null&&t.getRoom?t.getRoom():this.level.game.rooms[t.levelID])===this.level.game.room&&H.heal(),t.inventory.removeItem(this)});r(this,"useOnOther",(t,i)=>{if(i instanceof vt&&i.durabilityMax-i.durability>=1&&i.name!=="spellbook"){let s=Math.min(i.durabilityMax-i.durability,this.stackCount);i.durability+=s,this.stackCount-=s,i.broken=!1,this.level.game.pushMessage(`You repair your ${i.name} with ${s} fragments.`),this.stackCount<=0&&t.inventory.removeItem(this)}else i.name==="spellbook"&&this.level.game.pushMessage("You'll need some book pages to replenish that.")});this.tileX=3,this.tileY=0,this.offsetY=-.3,this.name="weapon fragments",this.canUseOnOther=!0,this.stackable=!0,this.stackCount=a||Math.ceil(O.rand()*10)+7,this.description="Can be used to repair broken weapons",this.maximumStackCount=64}}r(ei,"itemName","weapon fragments");class yi extends xi{constructor(){super(...arguments);r(this,"x");r(this,"y");r(this,"dead");r(this,"room");r(this,"drawTopLayer",t=>{});r(this,"shadeAmount",()=>{if(x.SMOOTH_LIGHTING&&!x.SHADE_INLINE_IN_ENTITY_LAYER)return 0;const t=Math.floor(this.x),i=Math.floor(this.y);return this.room.softVis[t]?this.room.softVis[t][i]??.9:.9});r(this,"shadeColor",()=>this.room.shadeColor)}}class Ga extends yi{constructor(t,i,s,a){super();r(this,"tileX");r(this,"tileY");r(this,"tileYOffset");r(this,"x");r(this,"y");r(this,"frame");r(this,"type");r(this,"direction");r(this,"frames");r(this,"yOffset");r(this,"xOffset");r(this,"animationSpeed");r(this,"drawTopLayer",t=>{this.drawAnimation(t)});r(this,"drawAnimation",t=>{this.dead||(this.frame>=0&&m.drawFX(this.tileX+2*Math.round(Math.max(0,this.frame)/2),this.tileY+this.tileYOffset,2,2,this.x-.5+this.xOffset,this.y-.5+this.yOffset,2,2),this.frame+=this.animationSpeed*t,this.frame>this.frames&&(this.dead=!0))});switch(this.x=t,this.y=i-.25,this.dead=!1,this.frame=0,this.type=s,this.xOffset=0,this.yOffset=0,this.tileX=12,this.animationSpeed=1,s){case"dagger":switch(this.frames=8,this.tileY=24,this.yOffset=0,this.xOffset=0,a){case E.DOWN:this.yOffset-=.75;break;case E.UP:this.yOffset+=.5;break;case E.LEFT:this.xOffset+=.8,this.yOffset+=.25;break;case E.RIGHT:this.xOffset-=.8,this.yOffset-=.25;break}break;case"warhammer":switch(this.frames=8,this.tileX=12,this.tileY=32,this.yOffset=-.75,this.xOffset=-0,this.frame=-5,this.animationSpeed=2,a){case E.DOWN:this.yOffset-=.25,this.xOffset+=.125;break;case E.UP:this.yOffset+=1,this.xOffset+=.25;break;case E.LEFT:this.xOffset+=.75,this.yOffset+=.5;break;case E.RIGHT:this.xOffset-=.75,this.yOffset+=.5;break}break;case"dualdagger":switch(this.frames=8,this.tileY=40,this.yOffset=0,this.xOffset=0,a){case E.DOWN:this.yOffset-=1;break;case E.UP:this.yOffset+=.5;break;case E.LEFT:this.xOffset+=.8,this.yOffset-=.25;break;case E.RIGHT:this.xOffset-=.8,this.yOffset-=.25;break}break;case"dualdagger2":switch(this.frames=8,this.tileY=48,this.yOffset=0,this.xOffset=0,a){case E.DOWN:this.yOffset-=1;break;case E.UP:this.yOffset+=.5;break;case E.LEFT:this.xOffset+=.8,this.yOffset-=.25;break;case E.RIGHT:this.xOffset-=.8,this.yOffset-=.25;break}break;case"spear":switch(this.frames=5,this.tileY=32,this.tileX=22,this.animationSpeed=.5,a){case E.DOWN:this.yOffset-=.75,this.xOffset+=.125;break;case E.UP:this.yOffset+=1,this.xOffset-=.125;break;case E.LEFT:this.xOffset+=1,this.yOffset+=.25;break;case E.RIGHT:this.xOffset-=1,this.yOffset+=.25;break}break;case"scythe":switch(this.frames=6,this.tileY=40,this.tileX=0,this.animationSpeed=.75,a){case E.DOWN:this.yOffset-=.75,this.xOffset+=0;break;case E.UP:this.yOffset+=.75,this.xOffset-=0;break;case E.LEFT:this.xOffset+=.75,this.yOffset+=0;break;case E.RIGHT:this.xOffset-=.75,this.yOffset-=0;break}break;case"sword":switch(this.frames=6,this.tileY=48,this.tileX=0,this.animationSpeed=.75,a){case E.DOWN:this.yOffset-=.95,this.xOffset+=0;break;case E.UP:this.yOffset+=.95,this.xOffset-=0;break;case E.LEFT:this.xOffset+=.95,this.yOffset+=0;break;case E.RIGHT:this.xOffset-=.95,this.yOffset-=0;break}break}switch(a){case E.DOWN:this.tileYOffset=0;break;case E.UP:this.tileYOffset=2;break;case E.LEFT:this.tileYOffset=4;break;case E.RIGHT:this.tileYOffset=6;break}}}const Mr=class Mr extends vt{constructor(t,i,s,a){super(t,i,s);r(this,"game");r(this,"range");r(this,"canMine");r(this,"damage");r(this,"status");r(this,"name");r(this,"statusApplicationCount");r(this,"hitDelay");r(this,"cooldown");r(this,"cooldownMax");r(this,"twoHanded");r(this,"hoverText",()=>this.name);r(this,"break",()=>{this.durability=0,this.wielder.inventory.weapon=null,this.toggleEquip(),this.game.pushMessage("Your weapon breaks"),(this.status.poison||this.status.blood)&&this.clearStatus(),this.broken=!0});r(this,"coEquippable",t=>!(t instanceof Mr||t instanceof Wt&&this.twoHanded));r(this,"applyStatus",t=>{this.status=t,this.status.blood});r(this,"clearStatus",()=>{const t=this.status.poison?"poison":"bleed";this.game.pushMessage(`Your ${this.name}'s ${t} effect dries up`),this.status={poison:!1,blood:!1},this.statusApplicationCount=0});r(this,"statusEffect",t=>{if(!t.isEnemy)return;const i=t;!i.status.poison.active&&!i.status.bleed.active&&this.wielder.applyStatus(i,this.status)&&i.health>0&&(this.statusApplicationCount++,this.status.poison?`${i.name}`:`${i.name}`)});r(this,"disassemble",()=>{if(!this.degradeable){this.game.pushMessage("You can't disassemble this item because it's not degradeable.");return}if(this.equipped){this.game.pushMessage("I should probably unequip this before I try to disassemble it...");return}this.game.pushMessage(`You dissassemble your ${this.name} into fragments.`);let t=this.wielder.inventory,i=this.x,s=this.y,a=Math.floor(this.durability/1.5);this.toggleEquip(),t.removeItem(this),t.addItem(new ei(this.level,i,s),a)});r(this,"dropFromInventory",()=>{this.wielder.inventory.weapon===this&&(this.wielder.inventory.weapon=null),this.wielder=null,this.equipped=!1});r(this,"checkForCollidables",(t,i)=>{for(const s of this.getEntitiesAt(t,i))if(s.collidable===!0)return!0;return!1});r(this,"weaponMove",(t,i)=>this.checkForPushables(t,i)?!0:!this.executeAttack(t,i));r(this,"attack",(t,i)=>{t.hurt(this.wielder,i||this.damage),this.statusEffect(t)});r(this,"attackAnimation",(t,i)=>{var a,n,c;this.wielder.setHitXY(t,i);const s=(a=this.wielder)!=null&&a.getRoom?this.wielder.getRoom():(c=(n=this.game)==null?void 0:n.rooms)==null?void 0:c[this.wielder.levelID];if(!s){console.error(" WEAPON: Cannot add particle - invalid room state");return}s.particles.push(new Ga(t,i,this.name,this.wielder.direction))});r(this,"shakeScreen",(t,i)=>{var a;((a=this.wielder)!=null&&a.getRoom?this.wielder.getRoom():this.wielder.game.rooms[this.wielder.levelID])===this.wielder.game.room&&this.wielder.shakeScreen(this.wielder.x,this.wielder.y,t,i)});r(this,"hitSound",()=>{H.swing(),H.hit()});r(this,"drawStatus",(t,i)=>{if(this.status.poison||this.status.blood){let s=3;this.status.poison&&(s=4),this.status.blood&&(s=3),m.drawFX(s,0,1,1,t-1/x.TILESIZE,i-1/x.TILESIZE,1,1)}});r(this,"getDescription",()=>{let t=this.broken?" (broken)":"",i=[],s="";return this.status.poison&&i.push("Poison"),this.status.blood&&i.push(" Bleed"),this.durability<this.durabilityMax&&(s=` Durability: ${this.durability}/${this.durabilityMax}`),`${this.name}${t}
${i.join(", ")}
${s}
${this.description}
damage: ${this.damage}`});r(this,"tick",()=>{this.updateCooldown()});r(this,"updateCooldown",()=>{this.cooldown>0&&(this.cooldown--,this.cooldown>0&&this.equipped&&(this.equipped=!1,this.wielder.inventory.items.some(i=>i===this.previousWeapon)&&this.previousWeapon!==null&&this.previousWeapon.broken===!1&&this.previousWeapon.cooldown===0?(this.wielder.inventory.weapon=this.previousWeapon,this.previousWeapon.equipped=!0):this.wielder.inventory.weapon=null))});r(this,"applyHitDelay",t=>{t&&(this.wielder.busyAnimating=!0,setTimeout(()=>{this.wielder.busyAnimating=!1},this.hitDelay||0))});t&&(this.game=t.game),this.canMine=!1,this.range=1,this.damage=1,this.status=a||{poison:!1,blood:!1},this.durability=50,this.durabilityMax=50,this.statusApplicationCount=0,this.equipTick=!0,this.name=this.constructor.prototype.itemName,this.cooldown=0,this.cooldownMax=0,this.twoHanded=!1}getEntitiesAt(t,i){var a,n,c;if(!this.game)return console.error(" WEAPON: this.game is undefined"),[];if(!this.wielder)return console.error(" WEAPON: this.wielder is undefined"),[];const s=(a=this.wielder)!=null&&a.getRoom?this.wielder.getRoom():(c=(n=this.game)==null?void 0:n.rooms)==null?void 0:c[this.wielder.levelID];return s?s.entities.filter(l=>l.destroyable&&l.pointIn(t,i)):(console.error(" WEAPON: current room is undefined"),[])}hitEntitiesAt(t,i,s){const a=this.getEntitiesAt(t,i).filter(c=>!c.pushable);let n=!1;for(const c of a)this.attack(c,s),n=!0;return n}checkForPushables(t,i){var y,g,w,b;const s=this.wielder.direction;let a=t,n=i;switch(s){case E.DOWN:n+=1;break;case E.UP:n-=1;break;case E.LEFT:a-=1;break;case E.RIGHT:a+=1;break}const c=(y=this.wielder)!=null&&y.getRoom?this.wielder.getRoom():(w=(g=this.game)==null?void 0:g.rooms)==null?void 0:w[this.wielder.levelID];if(!c)return!1;const d=this.getEntitiesAt(a,n).filter(T=>!T.pushable).length>0,u=(b=c.roomArray[a])==null?void 0:b[n],h=!u||u.isSolid(),f=this.getEntitiesAt(t,i).filter(T=>T.pushable),p=!h&&!d;return f.length>0&&p}executeAttack(t,i,s=!0,a=this.damage,n=!0,c=!0,l=!0,d=!0){var h,f,p;const u=this.hitEntitiesAt(t,i,a);if(this.applyHitDelay(u),u){if(c&&this.hitSound(),this.wielder.setHitXY(t,i),s&&this.attackAnimation(t,i),d){const y=(h=this.wielder)!=null&&h.getRoom?this.wielder.getRoom():(p=(f=this.game)==null?void 0:f.rooms)==null?void 0:p[this.wielder.levelID];y&&y.tick(this.wielder)}n&&this.shakeScreen(t,i),l&&this.degrade()}return u}};r(Mr,"itemName","weapon");let Et=Mr;const Pr=class Pr extends vt{constructor(t,i,s){super(t,i,s);r(this,"health");r(this,"rechargeTurnCounter");r(this,"RECHARGE_TURNS",25);r(this,"coEquippable",t=>!(t instanceof Pr||t instanceof Et&&t.twoHanded));r(this,"getDescription",()=>`ENCHANTED SHIELD
An occult shield. Absorbs one hit and regenerates after `+this.RECHARGE_TURNS+" turns.");r(this,"tickInInventory",()=>{this.rechargeTurnCounter>0&&(this.rechargeTurnCounter--,this.cooldown=this.rechargeTurnCounter,this.rechargeTurnCounter===0&&(this.rechargeTurnCounter=-1,this.cooldown=this.rechargeTurnCounter,this.health=1))});r(this,"hurt",t=>{this.health<=0||(this.health-=Math.max(t,1),this.rechargeTurnCounter=this.RECHARGE_TURNS+1,this.cooldown=this.rechargeTurnCounter)});r(this,"drawGUI",(t,i,s)=>{const a=(s-7)/x.TILESIZE,n=Math.max(a,-.2)+i/1.5+.5;let c=x.WIDTH>175?0:-1.25;this.rechargeTurnCounter===-1?m.drawFX(5,2,.75,.75,n,x.HEIGHT/x.TILESIZE-1+c,.75,.75):1-this.rechargeTurnCounter/this.RECHARGE_TURNS<.5?m.drawFX(7,2,.75,.75,n,x.HEIGHT/x.TILESIZE-1+c,.75,.75):m.drawFX(8,2,.75,.75,n,x.HEIGHT/x.TILESIZE-1+c,.75,.75)});this.health=1,this.rechargeTurnCounter=-1,this.tileX=5,this.tileY=0,this.name="occult shield"}};r(Pr,"itemName","occult shield");let Wt=Pr;const Rr=class Rr extends dt{constructor(t,i,s){super(t,i,s);r(this,"onUse",t=>{this.level.game.rooms[t.levelID]===this.level.game.room&&H.playBackpack(),t.inventory.removeItem(this),t.inventory.expansion+=1,this.level.game.pushMessage("You equip the backpack, increasing the amount you can carry.")});r(this,"getDescription",()=>`BACKPACK
A normal looking backpack. Increases the amount you can carry. `);this.tileX=4,this.tileY=0,this.offsetY=0,this.name=Rr.itemName}};r(Rr,"itemName","backpack");let hs=Rr;const It=class It{static get LIGHTING_ANGLE_BRIGHTNESS_COMPENSATION(){return It.LIGHTING_ANGLE_STEP/2}};r(It,"SCREEN_W",1),r(It,"SCREEN_H",1),r(It,"COMPUTER_TURN_DELAY",250),r(It,"TURN_TIME",3e3),r(It,"LEVEL_TRANSITION_TIME",300),r(It,"LEVEL_TRANSITION_TIME_LADDER",1e3),r(It,"ROOM_COUNT",50),r(It,"HEALTH_BAR_FADEIN",100),r(It,"HEALTH_BAR_FADEOUT",350),r(It,"HEALTH_BAR_TOTALTIME",2e3),r(It,"SHADED_TILE_CUTOFF",1),r(It,"MIN_VISIBILITY",0),r(It,"LIGHTING_ANGLE_STEP",2),r(It,"LIGHTING_MAX_DISTANCE",7),r(It,"LEVEL_TEXT_COLOR","yellow"),r(It,"AMBIENT_LIGHT_COLOR",[12,15,12]),r(It,"TORCH_LIGHT_COLOR",[120,35,10]);let q=It;class Wi extends vt{constructor(t,i,s){super(t,i,s);r(this,"fuel");r(this,"fuelCap");r(this,"radius");r(this,"maxBrightness");r(this,"minBrightness");r(this,"canRefuel",!1);r(this,"color");r(this,"updateLighting",()=>{var i;const t=(i=this.wielder)!=null&&i.getRoom?this.wielder.getRoom():this.wielder.game.rooms[this.wielder.levelID];t==null||t.updateLighting()});r(this,"isIgnited",()=>!!(this.fuel>0&&this.equipped));r(this,"dropFromInventory",()=>{console.log("onDrop"),this.equipped&&this.toggleEquip()});r(this,"setRadius",()=>{this.wielder.sightRadius=this.radius+this.fuelPercentage*this.radius});r(this,"setBrightness",()=>{this.wielder.lightBrightness=this.minBrightness+this.fuelPercentage*this.maxBrightness});r(this,"toggleEquip",()=>{this.fuel>0?(this.equipped=!this.equipped,this.isIgnited()?(this.setBrightness(),this.wielder.lightEquipped=!0,this.wielder.lightColor=this.color):(this.resetBrightness(),this.wielder.lightEquipped=!1,this.wielder.lightColor=q.AMBIENT_LIGHT_COLOR)):this.wielder.game.pushMessage("I'll need some fuel before I can use this"),this.updateLighting()});r(this,"coEquippable",t=>!(t instanceof Wi));r(this,"resetRadius",()=>{this.wielder.sightRadius=this.wielder.defaultSightRadius});r(this,"resetBrightness",()=>{this.wielder.lightBrightness=.5});r(this,"burn",()=>{var t;this.isIgnited()&&(((t=this.wielder)!=null&&t.getRoom?this.wielder.getRoom():this.wielder.game.rooms[this.wielder.levelID]).roomCleared()?this.fuel-=.2:this.fuel--,this.setRadius(),this.setBrightness()),this.fuel<=0&&(this.stackable&&(this.stackCount--,this.fuel=this.fuelCap),this.equipped&&(this.stackable&&this.stackCount<=0||!this.stackable&&!this.canRefuel?(this.resetRadius(),this.wielder.lightEquipped=!1,this.wielder.inventory.removeItem(this),this.wielder.game.pushMessage(`${this.name} depletes.`)):this.canRefuel&&(this.wielder.game.pushMessage(`${this.name} depletes.`),this.equipped=!1,this.resetRadius(),this.wielder.lightEquipped=!1,this.broken=!0),this.updateLighting()))});r(this,"drawDurability",(t,i)=>{if(this.fuel<this.fuelCap){const s=this.fuel/this.fuelCap;let a=Q.hsvToHex(120*s,1,1);const n=x.TILESIZE,c=s*n,l=2,d=t*x.TILESIZE,u=i*x.TILESIZE+x.TILESIZE-2;m.ctx.fillStyle=a,m.ctx.imageSmoothingEnabled=!1,m.ctx.fillRect(d,u,c,l),m.ctx.fillStyle="white"}});r(this,"tickInInventory",()=>{this.burn()});r(this,"getDescription",()=>`${this.name}: ${Math.ceil(this.fuelPercentage*100)}%`);this.tileX=28,this.tileY=0,this.fuel=0,this.fuelCap=250,this.maxBrightness=5,this.minBrightness=2,this.radius=6,this.equipped=!1,this.color=q.TORCH_LIGHT_COLOR}get fuelPercentage(){return this.fuel/this.fuelCap}}class ii extends Wi{constructor(e,t,i){super(e,t,i),this.fuel=100,this.tileX=27,this.tileY=0,this.name="candle",this.fuelCap=100,this.radius=4,this.stackable=!0,this.maxBrightness=2,this.maxBrightness=.25}}r(ii,"itemName","candle");class Ze extends me{constructor(t,i,s){super(t,i,s);r(this,"doorID");r(this,"depth");r(this,"getDescription",()=>`KEY
A key. ${this.depth!==null?"Depth: "+this.depth.toString():""}`);r(this,"onPickup",t=>{this.pickedUp||(this.pickedUp=t.inventory.addItem(this),this.pickedUp&&(this.level.game.pushMessage("You found a key!"),H.keyPickup(),this.depth===null&&(this.depth=t.depth),console.log(this.depth)))});this.tileX=1,this.tileY=0,this.name="key",this.doorID=0,this.depth=null}}r(Ze,"itemName","key");class Vt{constructor(e,t,i,s=[180,60,5],a=1){r(this,"x");r(this,"y");r(this,"r");r(this,"c");r(this,"b",1);r(this,"oldX");r(this,"oldY");r(this,"oldR");r(this,"oldC");r(this,"oldB");r(this,"dead",!1);r(this,"hasChanged");r(this,"updatePosition",(e,t)=>{this.x=e,this.y=t});r(this,"shouldUpdate",()=>!0);this.x=e,this.y=t,this.r=i,this.c=s,this.b=a,this.oldX=e,this.oldY=t,this.oldR=i,this.oldC=s,this.oldB=a,this.hasChanged=!0}}var hi=(o=>(o[o.DUNGEON=0]="DUNGEON",o[o.CAVE=1]="CAVE",o[o.FOREST=2]="FOREST",o[o.CASTLE=3]="CASTLE",o[o.GLACIER=4]="GLACIER",o[o.DARK_CASTLE=5]="DARK_CASTLE",o[o.PLACEHOLDER=6]="PLACEHOLDER",o[o.DESERT=7]="DESERT",o[o.MAGMA_CAVE=8]="MAGMA_CAVE",o))(hi||{});class oe extends xi{constructor(t,i,s){super();r(this,"globalId");r(this,"x");r(this,"y");r(this,"room");r(this,"skin");r(this,"isDoor");r(this,"opacity");r(this,"name","");r(this,"getName",()=>this.name);r(this,"hasPlayer",t=>t.x===this.x&&t.y===this.y);r(this,"shadeAmount",(t=0,i=0,s=!0)=>x.SMOOTH_LIGHTING&&s?0:this.room.softVis[this.x+t][this.y+i]);r(this,"isSolid",()=>!1);r(this,"canCrushEnemy",()=>!1);r(this,"isOpaque",()=>!1);r(this,"onCollide",t=>{});r(this,"onCollideEnemy",t=>{});r(this,"tick",()=>{});r(this,"tickEnd",()=>{});r(this,"draw",t=>{});r(this,"drawUnderPlayer",t=>{});r(this,"drawAbovePlayer",t=>{});r(this,"drawAboveShading",t=>{});this.globalId=se.generate("T"),this.skin=t.skin,this.room=t,this.x=i,this.y=s,this.drawableY=s,this.isDoor=!1,this.opacity=1}}class ao extends oe{constructor(t,i,s,a){super(t,s,a);r(this,"game");r(this,"frame");r(this,"keyID");r(this,"lightSource");r(this,"environment");r(this,"lockable");r(this,"addLightSource",()=>{this.environment===F.FOREST&&!this.lockable.isLocked()&&(this.lightSource=new Vt(this.x+.5,this.y+.5,6,[0,100,100]),this.room.lightSources.push(this.lightSource))});this.game=i,this.frame=0,this.keyID=0}updateFrame(t){this.frame>100&&(this.frame=0),this.frame+=1*t}getFloatingOffset(){return .125*Math.sin(this.frame*Math.PI/50)}}var Ti=(o=>(o[o.DOOR=0]="DOOR",o[o.LOCKEDDOOR=1]="LOCKEDDOOR",o[o.GUARDEDDOOR=2]="GUARDEDDOOR",o[o.TUNNELDOOR=3]="TUNNELDOOR",o))(Ti||{});class ot extends ao{constructor(t,i,s,a,n,c){super(t,i,s,a);r(this,"globalId");r(this,"linkedDoor");r(this,"opened");r(this,"doorDir");r(this,"guarded");r(this,"type");r(this,"locked");r(this,"iconTileX");r(this,"iconXOffset");r(this,"iconYOffset");r(this,"unlocking");r(this,"iconAlpha");r(this,"tileXOffset");r(this,"tileX");r(this,"drawTopOf");r(this,"alpha");r(this,"startRoom");r(this,"enteredFrom");r(this,"shadeAmount",(t=0,i=0,s=!0)=>{if(x.SMOOTH_LIGHTING&&s)return 0;const a=this.room.softVis[this.x+t][this.y+i];return this.opened?a/2:a});r(this,"openTunnelXOffset",()=>this.type===3&&this.opened?-3:0);r(this,"guard",()=>{this.type=2,this.locked=!0,this.iconTileX=9,this.iconXOffset=1/32});r(this,"lock",()=>{this.type=1,this.locked=!0,this.iconTileX=10,this.iconXOffset=1/32});r(this,"removeLock",()=>{this.type!==3&&(this.type=0),this.locked=!1});r(this,"removeLockIcon",()=>{this.iconYOffset=0,this.unlocking=!1,this.iconTileX=2,this.iconXOffset=0,this.iconAlpha=1});r(this,"canUnlock",t=>{if(this.type===1){let i=t.inventory.hasItem(Ze);return i!==null?i.doorID===this.lockable.keyID?(this.game.pushMessage("You use the key to unlock the door."),!0):(this.game.pushMessage("The key doesn't fit the lock."),!1):(this.game.pushMessage("The door is locked tightly and won't budge."),!1)}return this.type===2?(this.room.checkForNoEnemies(),this.game.pushMessage("There are still remaining foes guarding this door..."),!1):this.type===3&&(!this.opened||!this.linkedDoor.opened)?this.linkedDoor===this.room.level.exitRoom.tunnelDoor||this.startRoom?(this.game.pushMessage("The door refuses to budge from this side."),!1):(this.game.pushMessage("You clear the debris, revealing a narrow tunnel."),!0):!0});r(this,"unlock",t=>{if(this.type===1){let i=t.inventory.hasItem(Ze);i!==null&&(t.inventory.removeItem(i),H.unlock(),this.removeLock(),this.unlocking=!0)}else this.type===3&&(this.locked=!1,this.unlocking=!0)});r(this,"unGuard",()=>{this.type===2&&(this.removeLock(),H.unlock(),this.game.tutorialActive=!1),setTimeout(()=>{this.removeLockIcon()},1e3)});r(this,"link",t=>{this.linkedDoor=t});r(this,"isDrawnFirst",()=>{if(!this.linkedDoor||!this.linkedDoor.room)return!1;try{const t=this.game.currentPathId,s=this.game.rooms.filter(c=>c.pathId===t).slice().sort((c,l)=>c.roomY+c.height-(l.roomY+l.height)),a=s.indexOf(this.room),n=s.indexOf(this.linkedDoor.room);return a===-1||n===-1?!1:a<n}catch{return!1}});r(this,"isSolid",()=>{if(this.locked)return!0});r(this,"canCrushEnemy",()=>!0);r(this,"onCollide",t=>{this.opened||(H.doorOpen(),this.doorDir===E.LEFT&&(this.enteredFrom=E.LEFT,this.linkedDoor.enteredFrom=E.LEFT),this.doorDir===E.RIGHT&&(this.enteredFrom=E.RIGHT,this.linkedDoor.enteredFrom=E.RIGHT)),this.opened=!0,this.linkedDoor.opened=!0,this.doorDir===E.UP||this.doorDir===E.DOWN?this.game.changeLevelThroughDoor(t,this.linkedDoor):this.game.changeLevelThroughDoor(t,this.linkedDoor,this.linkedDoor.room.roomX-this.room.roomX>0?1:-1),this.type===3&&!this.startRoom&&this.game.pushMessage("The tunnel leads you back to the start."),this.linkedDoor.removeLock(),this.linkedDoor.removeLockIcon(),this.removeLockIcon()});r(this,"draw",t=>{if(m.ctx.save(),this.doorDir===E.DOWN&&m.drawTile(1,this.skin,1,1,this.x,this.y,1,1,this.room.shadeColor,this.shadeAmount()),this.doorDir===E.UP&&(this.opened?m.drawTile(6+this.tileXOffset+this.openTunnelXOffset(),this.skin,1,1,this.x,this.y,1,1,this.room.shadeColor,this.shadeAmount(0,1)):m.drawTile(3+this.tileXOffset+this.openTunnelXOffset(),this.skin,1,1,this.x,this.y,1,1,this.room.shadeColor,this.shadeAmount())),this.doorDir!==E.UP&&(this.isDrawnFirst()||!this.opened)&&m.drawTile(1,this.skin,1,1,this.x,this.y,1,1,this.room.shadeColor,this.shadeAmount()),this.doorDir===E.UP){if(!this.drawTopOf)return;this.opened?m.drawTile(14,0,1,1,this.x,this.y-1,1,1,this.room.shadeColor,this.shadeAmount(0,1,!1)):m.drawTile(13,0,1,1,this.x,this.y-1,1,1,this.room.shadeColor,this.shadeAmount(0,1,!1))}m.ctx.restore()});r(this,"drawAbovePlayer",t=>{});r(this,"drawAboveShading",t=>{this.updateFrame(t),m.ctx.globalAlpha=this.iconAlpha;let i=.125;this.unlocking===!0&&(this.iconAlpha*=.92**t,this.iconYOffset-=.035*t,i=0,this.iconAlpha<=.01&&this.removeLockIcon()),this.doorDir===E.UP?m.drawFX(this.iconTileX,2,1,1,this.x+this.iconXOffset,this.y-1.25+i*Math.sin(this.frame*Math.PI/50)+this.iconYOffset,1,1):((this.doorDir===E.LEFT||this.doorDir===E.RIGHT)&&(this.iconYOffset=-.5),m.drawFX(this.iconTileX,2,1,1,this.x+this.iconXOffset,this.y-1.25+i*Math.sin(this.frame*Math.PI/50)+this.iconYOffset,1,1)),m.ctx.globalAlpha=1});switch(this.globalId=se.generate("D"),this.opened=!1,this.doorDir=n,this.locked=!1,this.isDoor=!0,this.type=c,this.iconTileX=2,this.iconXOffset=0,this.iconYOffset=0,this.unlocking=!1,this.iconAlpha=1,this.tileXOffset=0,this.tileX=2,this.drawTopOf=!0,this.alpha=1,this.enteredFrom=null,this.doorDir){case E.UP:case E.DOWN:case E.LEFT:case E.RIGHT:}switch(this.lightSource=new Vt(s+.5,a+.5,0,[0,0,0],9),this.room.lightSources.push(this.lightSource),this.type){case 2:if(G.NO_ENEMIES)break;this.guard();break;case 1:this.lock();break;case 0:this.removeLock();break;case 3:this.locked=!0,this.iconTileX=10,this.iconXOffset=1/32,this.tileXOffset=12,this.drawTopOf=!1;break}}}class et extends oe{constructor(t,i,s,a){super(t,i,s);r(this,"tileXOffset");r(this,"wallDirections");r(this,"room");r(this,"isSolid",()=>!0);r(this,"canCrushEnemy",()=>!0);r(this,"isOpaque",()=>{const t=this.wallInfo();return t?!t.isTopWall&&!t.isInnerWall||t.isLeftWall||t.isRightWall:!1});r(this,"isInnerWall",()=>{const t=this.wallInfo();return(t==null?void 0:t.isInnerWall)||!1});r(this,"wallInfo",()=>this.room.wallInfo.get(`${this.x},${this.y}`));r(this,"getDoor",()=>{var s;const t=this.wallInfo();if(!t||!t.isBelowDoorWall)return;const i=(s=this.room.roomArray[this.x])==null?void 0:s[this.y+1];return i instanceof ot?i:void 0});r(this,"draw",t=>{this.drawWall(t)});r(this,"drawWall",t=>{var a;const i=this.room.wallInfo.get(`${this.x},${this.y}`);if(!i)return;this.tileXOffset=i.innerWallType==="bottomInner"||i.innerWallType==="surroundedInner"?0:26;const s=(a=this.getDoor())==null?void 0:a.isDrawnFirst();if(i.isDoorWall||i.isBelowDoorWall||i.isTopWall&&!i.isLeftWall&&!i.isRightWall||i.isInnerWall){if(i.isBelowDoorWall&&!s&&x.SMOOTH_LIGHTING)return;const n=x.SMOOTH_LIGHTING?this.shadeAmount():this.room.softVis[this.x][this.y+1];m.drawTile(0,this.skin,1,1,this.x,this.y,1,1,this.room.shadeColor,n)}m.drawTile(2+this.tileXOffset,this.skin,1,1,this.x,this.y-1,1,1,this.room.shadeColor,this.shadeAmount())});r(this,"drawTopLayer",t=>{const i=this.room.wallInfo.get(`${this.x},${this.y}`),s=this.room;!i||!s||i.isBottomWall&&s.active&&m.drawTile(2+this.tileXOffset,this.skin,1,1,this.x,this.y-1,1,1,this.room.shadeColor,this.shadeAmount())});this.isDoor=!1,this.tileXOffset=6,this.wallDirections=a||[],this.opacity=1,this.room=t}get direction(){let t=[];return this.room.roomArray[this.x-1][this.y]===null&&t.push(E.LEFT),this.room.roomArray[this.x+1][this.y]===null&&t.push(E.RIGHT),this.room.roomArray[this.x][this.y-1]===null&&t.push(E.DOWN),this.room.roomArray[this.x][this.y+1]===null&&t.push(E.UP),t.length==1?t[0]:t.includes(E.UP)&&t.includes(E.LEFT)?(this.opacity=.5,E.UP_LEFT):t.includes(E.UP)&&t.includes(E.RIGHT)?(this.opacity=.5,E.UP_RIGHT):t.includes(E.DOWN)&&t.includes(E.LEFT)?(this.opacity=.5,E.DOWN_LEFT):E.DOWN_RIGHT}}class bt extends oe{constructor(t,i,s){super(t,i,s);r(this,"variation");r(this,"draw",t=>{m.drawTile(this.variation,this.skin,1,1,this.x,this.y,1,1,this.room.shadeColor,this.shadeAmount())});this.variation=1,this.skin==hi.DUNGEON&&(this.variation=m.randTable([1,1,1,1,1,1,8,8,8,9,10,10,10,10,10,12],O.rand)),this.skin==hi.CAVE&&(this.variation=m.randTable([1,1,1,1,1,1,8,8,8,9,10,10,10,10,10,12],O.rand)),this.skin==hi.FOREST&&(this.variation=m.randTable([1,1,1,1,1,1,8,8,8,9,10,10,10,10,10,12],O.rand)),this.skin==hi.DESERT&&(this.variation=m.randTable([1,1,1,1,1,1,8,8,8,9,10,10,10,10,10,12],O.rand)),this.skin==hi.MAGMA_CAVE&&(this.variation=m.randTable([1,1,1,1,1,1,8,8,8,9,10,10,10,10,10,12],O.rand),(this.variation===8||this.variation===9||this.variation===10)&&(this.hasBloom=!0,this.bloomAlpha=1,this.bloomColor="#641900"))}}var De=(o=>(o[o.NONE=0]="NONE",o[o.LOCKED=1]="LOCKED",o[o.GUARDED=2]="GUARDED",o[o.TUNNEL=3]="TUNNEL",o))(De||{});class ia{constructor(e,t){r(this,"locked",!1);r(this,"unlocking",!1);r(this,"iconAlpha",1);r(this,"iconYOffset",0);r(this,"frame",0);r(this,"lockType");r(this,"keyID",0);r(this,"iconTileX");r(this,"iconXOffset");r(this,"isTopDoor");r(this,"game");this.game=e,this.lockType=t.lockType,this.keyID=t.keyID||0,this.iconTileX=t.iconTileX||2,this.iconXOffset=t.iconXOffset||0,this.isTopDoor=t.isTopDoor||!1,this.initializeLockState()}initializeLockState(){switch(this.lockType){case 1:this.lock();break;case 2:this.guard();break;case 3:this.lock(),this.iconTileX=10,this.iconXOffset=1/32;break;case 0:this.removeLock();break}}isLocked(){return this.locked}isUnlocking(){return this.unlocking}lock(){this.locked=!0,this.iconTileX=10,this.iconXOffset=1/32}guard(){this.lockType=2,this.locked=!0,this.iconTileX=9,this.iconXOffset=1/32}removeLock(){this.lockType=0,this.locked=!1}removeLockIcon(){this.iconYOffset=0,this.unlocking=!1,this.iconTileX=2,this.iconXOffset=0,this.iconAlpha=1}canUnlock(e){if(x.DEVELOPER_MODE)return!0;if(this.lockType===1){const t=this.hasKeyWithID(this.keyID,e);return console.log(this.keyID),t!==null?(this.game.pushMessage("You use the key to unlock."),console.log("key.doorID",t.doorID,"lock.keyID",this.keyID),!0):(e.inventory.hasItem(Ze)?this.game.pushMessage("The key doesn't fit the lock."):this.game.pushMessage("It's locked tightly and won't budge."),!1)}return this.lockType===2&&this.game.room.entities.some(i=>i.constructor.name.includes("Enemy")&&!i.dead)?(this.game.pushMessage("There are still remaining foes guarding this..."),!1):!0}unlock(e){if(this.lockType===1){const t=this.hasKeyWithID(this.keyID,e);(t!==null||x.DEVELOPER_MODE)&&(e.inventory.removeItem(t),H.unlock(),this.removeLock(),this.unlocking=!0)}else this.lockType===3&&(this.locked=!1,this.unlocking=!0)}hasKeyWithID(e,t){const i=t.inventory;for(const s of i.items)if(s instanceof Ze&&s.doorID===e)return s;return null}unGuard(){this.lockType===2&&(this.removeLock(),H.unlock(),this.game.tutorialActive=!1),setTimeout(()=>{this.removeLockIcon()},1e3)}update(e){this.frame>100&&(this.frame=0),this.frame+=1*e}drawIcon(e,t,i){m.ctx.globalAlpha=this.iconAlpha;let s=.125;this.unlocking&&(this.iconAlpha*=.92**i,this.iconYOffset-=.035*i,s=0,this.iconAlpha<=.01&&this.removeLockIcon());const a=(this.isTopDoor,t-1.25);if(this.lockType===0&&!this.unlocking){m.drawFX(2,2,1,1,e,t-1.25+s*Math.sin(this.frame*Math.PI/50),1,1);return}m.drawFX(this.iconTileX,2,1,1,e+this.iconXOffset,a+s*Math.sin(this.frame*Math.PI/50)+this.iconYOffset,1,1),m.ctx.globalAlpha=1}setKey(e){this.keyID=ia.generateID(),e.doorID=this.keyID}static generateID(){return Math.floor(O.rand()*1e6)}}class le extends ao{constructor(t,i,s,a,n=De.NONE){super(t,i,s,a);r(this,"linkedRoom");r(this,"isRope",!1);r(this,"depth");r(this,"lockable");r(this,"isSidePath",!1);r(this,"onCollide",t=>{var i;if(!this.game){console.error("Game instance is undefined in UpLadder:",this);return}if(this.lockable.isLocked()){this.lockable.canUnlock(t)&&this.lockable.unlock(t);return}try{this.linkedRoom||this.linkRoom();const s=this.exitDownLadderPos;if(this.isRope&&this.linkedRoom&&(this.game.currentPathId=this.linkedRoom.pathId||"main"),this.game.changeLevelThroughLadder(t,this),s&&this.linkedRoom){this.linkedRoom.__entryPositionFromLadder=s;try{console.log(`UpLadder.onCollide: wrote __entryPositionFromLadder (${s.x}, ${s.y}) onto parent room gid=${(i=this.linkedRoom)==null?void 0:i.globalId}`)}catch{}}H.forestMusic.pause(),H.caveMusic.pause()}catch(s){console.error("Error during changeLevelThroughLadder:",s)}});r(this,"getName",()=>this.isRope?"rope up":"staircase up");r(this,"linkRoom",()=>{var t;if(this.isRope&&!this.linkedRoom){const i=this.game.levels[this.depth];if(i){for(const a of i.rooms)if(a.mapGroup<this.room.mapGroup)for(let n=a.roomX;n<a.roomX+a.width;n++)for(let c=a.roomY;c<a.roomY+a.height;c++){const l=(t=a.roomArray[n])==null?void 0:t[c];if(l instanceof wt&&l.isSidePath){this.linkedRoom=a,l.linkedRoom=this.room;return}}const s=i.roomsById?i.roomsById.values().next().value:i.rooms[0];this.linkedRoom=i.startRoom||s;return}}this.depth-1>=0&&this.game.levels[this.depth-1]&&(this.linkedRoom=this.game.levels[this.depth-1].exitRoom)});r(this,"draw",t=>{let i=29,s=0;this.isRope&&(i=16,s=1),m.drawTile(1,this.skin,1,1,this.x,this.y,1,1,this.room.shadeColor,this.shadeAmount()),this.isRope?m.drawTile(i,s+0,1,2,this.x,this.y-1,1,2,this.room.shadeColor,this.shadeAmount(0,-1,!1)):m.drawTile(i,s,1,1,this.x,this.y-1,1,1,this.room.shadeColor,this.shadeAmount(0,-1,!1)),m.drawTile(i,s+1,1,1,this.x,this.y,1,1,this.room.shadeColor,this.shadeAmount()),Di.draw(this.x,this.y+.25)});r(this,"drawAboveShading",t=>{this.lockable.update(t),this.lockable.drawIcon(this.x,this.y,t),this.frame>100&&(this.frame=0),this.frame+=1*t,m.drawFX(2,2,1,1,this.x,this.y-1.25+.125*Math.sin(this.frame*Math.PI/50),1,1)});r(this,"drawAbovePlayer",t=>{this.isRope&&m.drawTile(16,1,1,1,this.x,this.y-1,1,1,this.room.shadeColor,this.shadeAmount())});this.depth=t.depth,this.lockable=new ia(i,{lockType:n,isTopDoor:!0})}isLocked(){return this.lockable.isLocked()}}class yh{constructor(e){r(this,"game");this.game=e}async generateFor(e){if(e.linkedRoom)return;const t=e.room.depth+(e.isSidePath?0:1),i=this.getDeterministicPathId(e);await this.game.levelgen.generate(this.game,t,e.isSidePath,s=>this.handleLinkedRoom(e,s),e.environment,!1,i,e.opts),$e.recordSidePathEntered({depth:this.game.currentDepth,sidePath:e.linkedRoom.envType})}switchToPathBeforeTransition(e){e.isSidePath&&e.linkedRoom&&(this.game.currentPathId=e.linkedRoom.pathId||this.game.currentPathId||"main")}getDeterministicPathId(e){if(!e.isSidePath)return"main";const t=this.game.currentPathId||"main",i=`${e.room.depth}:${e.room.roomX},${e.room.roomY}`,s=`${e.x},${e.y}`,a=`sp:${t}:${i}:${s}`,n=e.globalId||`${e.room.globalId}:${e.x},${e.y}`;return a||n||"main"}handleLinkedRoom(e,t){e.isSidePath&&this.handleSidePathRooms(t),e.linkedRoom=t,this.linkUpLadders(e)}handleSidePathRooms(e){const t=e.level,i=this.game.rooms.filter(a=>a.mapGroup===e.mapGroup),s=t.rooms.length;i.forEach((a,n)=>{a.id=s+n,t.rooms.push(a)})}linkUpLadders(e){var t,i;if(e.linkedRoom)if(e.isSidePath){const s=e.linkedRoom.level,a=e.linkedRoom.mapGroup,n=s.rooms.filter(c=>c.mapGroup===a);for(const c of n)for(let l=c.roomX;l<c.roomX+c.width;l++)for(let d=c.roomY;d<c.roomY+c.height;d++){const u=(t=c.roomArray[l])==null?void 0:t[d];u instanceof le&&(this.setUpLadderLink(e,u),!e.entryUpLadderPos&&c===e.linkedRoom&&(e.entryUpLadderPos={x:u.x,y:u.y}))}}else for(let s=e.linkedRoom.roomX;s<e.linkedRoom.roomX+e.linkedRoom.width;s++)for(let a=e.linkedRoom.roomY;a<e.linkedRoom.roomY+e.linkedRoom.height;a++){const n=(i=e.linkedRoom.roomArray[s])==null?void 0:i[a];if(n instanceof le){this.setUpLadderLink(e,n);return}}}setUpLadderLink(e,t){e.isSidePath?(t.linkedRoom=e.room,t.isRope=!0,t.exitDownLadderPos={x:e.x,y:e.y}):t.linkedRoom=this.game.levels[e.room.depth].exitRoom}}class wt extends ao{constructor(t,i,s,a,n=!1,c=F.DUNGEON,l=De.NONE,d,u){super(t,i,s,a);r(this,"linkedRoom");r(this,"isSidePath",!1);r(this,"depth");r(this,"environment");r(this,"lockable");r(this,"opts");r(this,"entryUpLadderPos");r(this,"sidePathManager");r(this,"getName",()=>this.isSidePath?"rope down":"staircase down");r(this,"generate",async()=>{this.linkedRoom?console.log("LinkedRoom already exists:",this.linkedRoom):await this.sidePathManager.generateFor(this)});r(this,"onCollide",t=>{let i=!0;for(const s in this.game.players){const a=this.game.players[s];((a.getRoom?a.getRoom():this.game.levels[a.depth].rooms[a.levelID])!==this.room||a.x!==this.x||a.y!==this.y)&&(i=!1)}i?(ht.emit(xt.LEVEL_GENERATION_STARTED,{}),this.generate().then(()=>{ht.emit(xt.LEVEL_GENERATION_COMPLETED,{}),this.sidePathManager.switchToPathBeforeTransition(this);for(const s in this.game.players)this.game.changeLevelThroughLadder(this.game.players[s],this)})):t===this.game.players[this.game.localPlayerID]&&this.game.pushMessage("all players must be present")});r(this,"draw",t=>{let i=4;this.isSidePath&&(i=16,this.lockable.isLocked()&&(i=17)),m.drawTile(1,this.skin,1,1,this.x,this.y,1,1,this.room.shadeColor,this.shadeAmount()),m.drawTile(i,0,1,1,this.x,this.y,1,1,this.room.shadeColor,this.shadeAmount())});r(this,"drawAboveShading",t=>{this.lockable.update(t),this.lockable.drawIcon(this.x,this.y,t),this.updateFrame(t)});r(this,"drawAbovePlayer",t=>{});this.linkedRoom=null,this.depth=t.depth,this.isSidePath=n,this.environment=c,this.opts=d,this.sidePathManager=new yh(i);const h=u?u.lockType:n&&!x.DEVELOPER_MODE?De.LOCKED:l;this.lockable=new ia(i,{lockType:h,keyID:u==null?void 0:u.keyID,isTopDoor:!1}),this.addLightSource()}isLocked(){return this.lockable.isLocked()}}var yt;(o=>{(c=>{c[c.WALL=0]="WALL",c[c.OPEN=1]="OPEN"})(o.GraphNodeType||(o.GraphNodeType={}));let e=c=>c?c.isSolid()||c.isDoor||c instanceof wt?99999999:300:99999999;class t{constructor(l){r(this,"nodes");r(this,"elements");this.elements=l;for(var d=[],u,h,f=l.length,p=0;p<f;++p){u=l[p],h=u.length,d[p]=new Array(h);for(var y=0;y<h;++y)d[p][y]=new i(p,y,u[y])}this.nodes=d}toString(){for(var l=`
`,d=this.nodes,u,h,f,p,y=0,g=d.length;y<g;){for(u="",h=d[y++],f=0,p=h.length;f<p;)u+=h[f++].type+" ";l=l+u+`
`}return l}}o.Graph=t;class i{constructor(l,d,u){r(this,"x");r(this,"y");r(this,"type");r(this,"data");r(this,"pos");this.data={},this.x=l,this.y=d,this.pos={x:l,y:d},this.type=u}toString(){return"["+this.x+" "+this.y+"]"}isWall(){return this.type==0}}o.GraphNode=i;class s{constructor(l){r(this,"content");r(this,"scoreFunction");this.content=[],this.scoreFunction=l}push(l){this.content.push(l),this.sinkDown(this.content.length-1)}pop(){var l=this.content[0],d=this.content.pop();return this.content.length>0&&(this.content[0]=d,this.bubbleUp(0)),l}remove(l){var d=this.content.indexOf(l),u=this.content.pop();d!==this.content.length-1&&(this.content[d]=u,this.scoreFunction(u)<this.scoreFunction(l)?this.sinkDown(d):this.bubbleUp(d))}size(){return this.content.length}rescoreElement(l){this.sinkDown(this.content.indexOf(l))}sinkDown(l){for(var d=this.content[l];l>0;){var u=(l+1>>1)-1,h=this.content[u];if(this.scoreFunction(d)<this.scoreFunction(h))this.content[u]=d,this.content[l]=h,l=u;else break}}bubbleUp(l){for(var d=this.content.length,u=this.content[l],h=this.scoreFunction(u);;){var f=l+1<<1,p=f-1,y=null;if(p<d){var g=this.content[p],w=this.scoreFunction(g);w<h&&(y=p)}if(f<d){var b=this.content[f],T=this.scoreFunction(b);T<(y===null?h:w)&&(y=f)}if(y!==null)this.content[l]=this.content[y],this.content[y]=u,l=y;else break}}}o.BinaryHeap=s;const n=class n{constructor(l,d,u,h){r(this,"grid");this.grid=[];for(var f=0,p=l.length;f<p;f++){this.grid[f]=[];for(var y=0,g=l[f].length;y<g;y++){var w=e(l[f][y]);this.grid[f][y]={org:l[f][y],f:0,g:0,h:0,cost:w,visited:!1,closed:!1,pos:{x:f,y},parent:null}}}if(d!==void 0)for(var b=0;b<d.length;b++)d[b].x>=0&&d[b].x<this.grid.length&&d[b].y>=0&&d[b].y<this.grid[0].length&&(this.grid[d[b].x][d[b].y].cost=99999999);u&&u.x>=0&&u.x<this.grid.length&&u.y>=0&&u.y<this.grid[0].length&&(this.grid[u.x][u.y].cost=.5)}heap(){return new s(function(l){return l.f})}_find(l){for(var d=0;d<this.grid.length;d++)for(var u=0;u<this.grid[d].length;u++)if(this.grid[d][u].org==l)return this.grid[d][u]}_search(l,d,u,h,f,p,y,g,w){y=y||this.manhattan,u=!!u,h=!!h,f=!!f,g=!!g;var b=this.heap(),T,v;if(l.x!==void 0&&l.y!==void 0?T=this.grid[l.x][l.y]:T=this._find(l),d.x!==void 0&&d.y!==void 0?v=this.grid[d.x][d.y]:v=this._find(d),n.NO_CHECK_START_POINT==!1&&T.cost<=0)return[];for(b.push(T);b.size()>0;){var k=b.pop();if(k===v){for(var D=k,N=[];D.parent;)N.push(D),D=D.parent;return N.reverse()}k.closed=!0;for(var U=this.neighbors(k,u,h,g),Z=0,j=U.length;Z<j;Z++){var V=U[Z];if(!(V.closed||V.cost<=0)){var J=k.g+V.cost;if(f){var z=!1;k.parent?z=!(k.parent.pos.x===k.pos.x&&k.pos.x===V.pos.x||k.parent.pos.y===k.pos.y&&k.pos.y===V.pos.y):(z=!0,V.pos.x-k.pos.x===0&&V.pos.y-k.pos.y===-1&&p===E.UP&&(z=!1),V.pos.x-k.pos.x===0&&V.pos.y-k.pos.y===1&&p===E.DOWN&&(z=!1),V.pos.x-k.pos.x===1&&V.pos.y-k.pos.y===0&&p===E.RIGHT&&(z=!1),V.pos.x-k.pos.x===-1&&V.pos.y-k.pos.y===0&&p===E.LEFT&&(z=!1)),z&&J++}var tt=V.visited;(!tt||J<V.g)&&(V.visited=!0,V.parent=k,V.h=V.h||y(V.pos,v.pos,w),V.g=J,V.f=V.g+V.h,tt?b.rescoreElement(V):b.push(V))}}}return[]}static search(l,d,u,h,f,p,y,g,w,b,T){var v=new n(l,h,T);return v._search(d,u,f,p,y,g,w,b)}manhattan(l,d){var u=Math.abs(d.x-l.x),h=Math.abs(d.y-l.y),f=u+h;return f}neighbors(l,d,u,h){var f=this.grid,p=[],y=l.pos.x,g=l.pos.y;u||(f[y-1]&&f[y-1][g]&&p.push(f[y-1][g]),f[y+1]&&f[y+1][g]&&p.push(f[y+1][g]),f[y]&&f[y][g-1]&&p.push(f[y][g-1]),f[y]&&f[y][g+1]&&p.push(f[y][g+1])),d&&(f[y-1]&&f[y-1][g-1]&&p.push(f[y-1][g-1]),f[y+1]&&f[y+1][g-1]&&p.push(f[y+1][g-1]),f[y-1]&&f[y-1][g+1]&&p.push(f[y-1][g+1]),f[y+1]&&f[y+1][g+1]&&p.push(f[y+1][g+1]));function w(){return O.rand()<.5}if(h){const b=w();if(f[y-1]&&f[y-1][g])if(b==!0){p.push(f[y-1][g-1]);return}else{p.push(f[y-1][g+1]);return}if(f[y+1]&&f[y+1][g])if(b==!0){p.push(f[y+1][g-1]);return}else{p.push(f[y+1][g+1]);return}if(f[y]&&f[y][g-1])if(b==!0){p.push(f[y-1][g-1]);return}else{p.push(f[y+1][g-1]);return}if(f[y]&&f[y][g+1])if(b==!0){p.push(f[y-1][g+1]);return}else{p.push(f[y+1][g+1]);return}else return}return p}};r(n,"NO_CHECK_START_POINT",!1);let a=n;o.AStar=a})(yt||(yt={}));class gn{constructor(){r(this,"hurtTimer");r(this,"shouldDraw");r(this,"hurt",()=>{this.hurtTimer=Date.now()});r(this,"draw",(e,t,i,s,a,n)=>{let c=Math.min(q.HEALTH_BAR_TOTALTIME,Math.max(Date.now()-this.hurtTimer,0));if(c<=q.HEALTH_BAR_TOTALTIME){let l=Math.floor(t),d=Math.ceil(t-l),u=Math.round(Math.min(9,Math.min(.05*(q.HEALTH_BAR_TOTALTIME-c),.05*c))),h=Math.round(Math.min(.5,Math.min(.003*(q.HEALTH_BAR_TOTALTIME-c),.003*c))*16)/16,p=.5+-((u*(i-1)+8)/16)/2;for(let y=0;y<Math.ceil(.5*i);y++){let g=0;n?y<l?g=0:y<l+d?g=.5:g=1:g=1.5;let w=u*y/16+p;m.drawFX(g,8,.5,.5,s+w,a-1-h/2,.5,h),w+=9/16;let b=i-y-1;if(b!==y){let T=0;n?b<l?T=0:b<l+d?T=.5:T=1:T=1.5;let v=u*b/16+p;m.drawFX(T,8,.5,.5,s+v,a-1-h/2,.5,h),v+=9/16}}}});this.hurtTimer=0}}var re=(o=>(o[o.North=0]="North",o[o.NorthEast=1]="NorthEast",o[o.East=2]="East",o[o.SouthEast=3]="SouthEast",o[o.South=4]="South",o[o.SouthWest=5]="SouthWest",o[o.West=6]="West",o[o.NorthWest=7]="NorthWest",o[o.Center=8]="Center",o))(re||{});const Oe=class Oe extends xi{constructor(t,i,s,a,n,c,l=!1,d=null){super();r(this,"x");r(this,"y");r(this,"dead");r(this,"game");r(this,"parent",null);r(this,"_pointerDir",null);r(this,"_pointerOffset",null);r(this,"tileX");r(this,"tileY");r(this,"eX");r(this,"eY");r(this,"offsetY");r(this,"pointerOffset");r(this,"isEnemy");r(this,"dirOnly");r(this,"alpha",0);r(this,"ticks");r(this,"tickedForDeath",!1);r(this,"tick",()=>{this.tickedForDeath&&(this.dead=!0),this.tickedForDeath=!0});r(this,"removeOverlapping",()=>{for(const t of this.game.room.entities)if(t.x===this.x&&t.y===this.y&&t.pushable===!1){this.dead=!0;break}for(const t of this.game.room.doors)if(t.x===this.x&&t.y===this.y){this.dead=!0;break}});r(this,"fadeHitwarnings",t=>{this.tickedForDeath?(this.alpha>0&&(this.alpha-=.03*t),this.alpha<0&&(this.alpha=0)):(this.alpha<1&&(this.alpha+=.03*t),this.alpha>1&&(this.alpha=1))});r(this,"draw",t=>{this.fadeHitwarnings(t),Math.abs(this.x-this.game.players[this.game.localPlayerID].x)<=1&&Math.abs(this.y-this.game.players[this.game.localPlayerID].y)<=1&&(m.ctx.globalAlpha=this.alpha,this.isEnemy&&Q.distance(this.x,this.y,this.game.players[this.game.localPlayerID].x,this.game.players[this.game.localPlayerID].y)<=1&&m.drawFX(this.tileX+Math.floor(Oe.frame),this.tileY,1,1,this.x+this.pointerOffset.x,this.y+this.pointerOffset.y-this.offsetY,1,1),m.ctx.globalAlpha=1)});r(this,"drawTopLayer",t=>{this.fadeHitwarnings(t),m.ctx.globalAlpha=this.alpha,this.isEnemy&&this.getPointerDir()!==0&&m.drawFX(this.tileX+Math.floor(Oe.frame),this.tileY+1,1,1,this.x+this.pointerOffset.x,this.y+this.pointerOffset.y-this.offsetY,1,1),Q.distance(this.x,this.y,this.game.players[this.game.localPlayerID].x,this.game.players[this.game.localPlayerID].y)<=1&&(this.dirOnly||m.drawFX(18+Math.floor(Oe.frame),6,1,1,this.x,this.y-this.offsetY+0,1,1)),m.ctx.globalAlpha=1});this.x=i,this.y=s,this.dead=!1,this.game=t,this.parent=d,this.tileX=0,this.tileY=22,this.eX=a,this.eY=n,this.offsetY=.2,this.dirOnly=l,this.isEnemy=c!==void 0?c:!0,this.pointerOffset=this.getPointerOffset(),this.removeOverlapping()}getPointerDir(){if(this._pointerDir===null){const t=this.eX-this.x,i=this.eY-this.y;t===0&&i===0?this._pointerDir=8:t===0?this._pointerDir=i<0?4:0:i===0?this._pointerDir=t<0?2:6:t<0?this._pointerDir=i<0?3:1:this._pointerDir=i<0?5:7,this.tileX=0+2*this._pointerDir}return this._pointerDir}getPointerOffset(){if(this._pointerOffset===null){const t={0:{x:0,y:.5},4:{x:0,y:-.6},6:{x:.6,y:0},2:{x:-.6,y:0},1:{x:-.5,y:.5},7:{x:.5,y:.5},3:{x:-.5,y:-.5},5:{x:.5,y:-.5},8:{x:0,y:-.25}};this._pointerOffset=t[this.getPointerDir()]}return this._pointerOffset}};r(Oe,"frame",0),r(Oe,"updateFrame",t=>{Oe.frame+=.125*t,Oe.frame>=2&&(Oe.frame=0)});let Ht=Oe;class oo extends yi{constructor(t,i,s,a,n,c){super();r(this,"room");r(this,"damage");r(this,"x");r(this,"y");r(this,"alpha",1);r(this,"color");r(this,"outlineColor");r(this,"frame",0);r(this,"xoffset",0);r(this,"getXoffset",()=>{if(this.room.particles.length>0){let t=this.room.particles.filter(i=>i instanceof oo);if(t.length%3===0)return .5;if(t.length%3===1)return 0;if(t.length%3===2)return .25}});r(this,"drawTopLayer",t=>{if(m.ctx.save(),this.dead){m.ctx.restore();return}this.frame>15&&(this.alpha-=.025*t),this.y-=.03*t,this.frame+=t,m.measureText(this.damage.toString()).width,this.alpha<=.002&&(this.alpha=0,this.dead=!0),m.ctx.globalAlpha=this.alpha;const i=m.measureText(this.damage.toString()).width/2;m.fillTextOutline("-"+this.damage.toString(),(this.x+.4+this.xoffset)*x.TILESIZE-i,(this.y-.6)*x.TILESIZE,this.outlineColor,this.color),m.ctx.globalAlpha=1,m.ctx.restore()});this.room=t,this.damage=a,this.x=i,this.y=s,n?this.color=n:this.color="red",c?this.outlineColor=c:this.outlineColor=x.OUTLINE,this.xoffset=O.rand()*.2}}const Dr=class Dr extends dt{constructor(t,i,s){super(t,i,s);r(this,"useOnOther",(t,i)=>{i.name==="gold ring"&&i.embed(t,this)});r(this,"getDescription",()=>"A gem of zircon. Embed it into a gold ring to imbue it with magic.");this.tileX=13,this.tileY=0,this.name=Dr.itemName,this.canUseOnOther=!0,this.stackable=!0}};r(Dr,"itemName","zircon");let ze=Dr;const Ls=class Ls extends me{constructor(t,i,s){super(t,i,s);r(this,"onDrop",()=>{const t=[];for(const i of this.level.items)i instanceof Ls&&t.push(i);for(const i of t)this!==i&&this.x===i.x&&this.y===i.y&&(this.stackCount+=i.stackCount,this.level.items=this.level.items.filter(s=>s!==i)),this.stackCount>=3&&(this.tileX=20),this.stackCount>=7&&(this.tileX=21)});r(this,"autoPickup",()=>{this.onPickup(this.level.game.players[this.level.game.localPlayerID])});r(this,"pickupSound",()=>{let t=0;t=Math.ceil(O.rand()*200+400),this.level===this.level.game.room&&H.delayPlay(H.pickupCoin,t)});this.tileX=19,this.tileY=0,this.stackCount=1,this.stackable=!0,this.name=Ls.itemName,this.animateToInventory=!0}get distanceToBottomRight(){return Math.sqrt((this.x+this.w-window.innerWidth)**2+(this.y+this.h-window.innerHeight)**2)}};r(Ls,"itemName","coin");let ct=Ls;const Cr=class Cr extends dt{constructor(t,i,s){super(t,i,s);r(this,"useOnOther",(t,i)=>{i.name==="gold ring"&&i.embed(t,this)});r(this,"getDescription",()=>"An emerald gem. Embed it into a gold ring to imbue it with magic.");this.tileX=11,this.tileY=0,this.name=Cr.itemName,this.canUseOnOther=!0,this.stackable=!0}};r(Cr,"itemName","emerald");let _e=Cr;const Lr=class Lr extends dt{constructor(t,i,s){super(t,i,s);r(this,"onUse",t=>{t.health<t.maxHealth&&(t.health=Math.min(t.maxHealth,t.health+1),this.level.game.rooms[t.levelID]===this.level.game.room&&H.heal(),this.stackCount>1?this.stackCount--:t.inventory.removeItem(this),t.game.pushMessage("You drink the health potion."))});this.tileX=8,this.tileY=0,this.offsetY=-.3,this.name=Lr.itemName,this.stackable=!0,this.description="restores 1 health"}};r(Lr,"itemName","health potion");let ue=Lr;const Yr=class Yr extends dt{constructor(t,i,s){super(t,i,s);r(this,"useOnOther",(t,i)=>{i.name==="gold ring"&&i.embed(t,this)});r(this,"getDescription",()=>"A garnet gem. Embed it into a gold ring to imbue it with magic.");this.tileX=12,this.tileY=0,this.name=Yr.itemName,this.canUseOnOther=!0,this.stackable=!0}};r(Yr,"itemName","garnet");let ce=Yr;class we extends Et{constructor(t,i,s){super(t,i,s);r(this,"weaponMove",(t,i)=>{let s=2*t-this.wielder.x,a=2*i-this.wielder.y,n=!1;if(this.getEntitiesAt(t,i).filter(f=>f.pushable).length>0)return!0;const l=this.getEntitiesAt(t,i),d=this.getEntitiesAt(s,a),u=l.filter(f=>!f.pushable&&!f.isEnemy);if(u.length>0){for(const f of u)this.attack(f);return this.hitSound(),this.attackAnimation(t,i),this.game.rooms[this.wielder.levelID].tick(this.wielder),this.shakeScreen(t,i),this.degrade(),!1}const h=l.filter(f=>!f.pushable&&f.isEnemy);if(h.length>0){for(const f of h)this.attack(f);n=!0}if(this.game.rooms[this.wielder.levelID].roomArray[s]&&this.game.rooms[this.wielder.levelID].roomArray[s][a]&&!this.game.rooms[this.wielder.levelID].roomArray[s][a].isSolid()){const f=d.filter(p=>!p.pushable&&p.isEnemy);if(f.length>0){for(const p of f)this.attack(p);n=!0}}return n&&(this.hitSound(),this.attackAnimation(s,a),this.game.rooms[this.wielder.levelID].tick(this.wielder),this.shakeScreen(s,a),this.degrade()),!n});this.tileX=24,this.tileY=0,this.name="spear",this.description="Hits enemies in front of you within a range of 2 tiles.",this.iconOffset=.1,this.offsetY=-.25,this.useCost=1,this.degradeable=!1}}r(we,"itemName","spear");class ms extends Et{constructor(t,i,s){super(t,i,s);r(this,"hitDelay");r(this,"hitSound",()=>{H.swing(),H.playWarHammer()});r(this,"weaponMove",(t,i)=>{if(this.checkForPushables(t,i))return!0;const s=this.executeAttack(t,i);return s&&(this.cooldown=this.cooldownMax),!s});r(this,"shakeScreen",()=>{this.wielder.beginSlowMotion(),setTimeout(()=>{switch(this.wielder.endSlowMotion(),this.wielder.direction){case E.DOWN:this.game.shakeScreen(0,-30,!1);break;case E.UP:this.game.shakeScreen(0,-30,!1);break;case E.LEFT:this.game.shakeScreen(-5,-30,!1);break;case E.RIGHT:this.game.shakeScreen(5,-30,!1);break}},this.hitDelay)});this.tileX=22,this.tileY=2,this.damage=2,this.name="warhammer",this.hitDelay=225,this.useCost=2,this.degradeable=!1}}r(ms,"itemName","warhammer");class Zs extends Et{constructor(t,i,s){super(t,i,s);r(this,"firstAttack");r(this,"hitSound",()=>{H.swing(),H.playShortSlice()});r(this,"tickInInventory",()=>{this.firstAttack=!0});r(this,"weaponMove",(t,i)=>{const s=this.getEntitiesAt(t,i).filter(n=>!n.pushable);let a=!1;for(let n of s)this.attack(n,this.damage),this.statusEffect(n),a=!0;return a&&(this.hitSound(),this.wielder.setHitXY(t,i),this.shakeScreen(t,i),this.firstAttack?this.game.rooms[this.wielder.levelID].particles.push(new Ga(t,i,"dualdagger",this.wielder.direction)):this.game.rooms[this.wielder.levelID].particles.push(new Ga(t,i,"dualdagger2",this.wielder.direction)),this.game.rooms[this.wielder.levelID].entities=this.game.rooms[this.wielder.levelID].entities.filter(n=>!n.dead),this.firstAttack||this.game.rooms[this.wielder.levelID].tick(this.wielder),this.wielder===this.game.players[this.game.localPlayerID]&&this.game.shakeScreen(10*this.wielder.hitX,10*this.wielder.hitY),this.firstAttack&&(this.game.rooms[this.wielder.levelID].tickHitWarnings(),this.game.rooms[this.wielder.levelID].clearDeadStuff(),this.firstAttack=!1,this.wielder.beginSlowMotion()),this.degrade()),!a});this.tileX=23,this.tileY=0,this.firstAttack=!0,this.name="Dual Daggers",this.useCost=2,this.description="After the first attack, enemies will not take their turn until you attack or move again."}}r(Zs,"itemName","dual daggers");class sa extends dt{constructor(t,i,s){super(t,i,s);r(this,"onUse",t=>{t.health=Math.min(t.maxHealth,t.health+1),this.level.game.rooms[t.levelID]===this.level.game.room&&H.heal()});r(this,"useOnOther",(t,i)=>{i instanceof Et&&(i.applyStatus({poison:!0,blood:!1}),t.inventory.removeItem(this),this.level.game.pushMessage(`You apply the poison to your ${i.name}.`),console.log(`weapon poison used on ${i.name}`))});r(this,"getDescription",()=>`WEAPON POISON
Can be applied to weapons to deal poison damage`);this.tileX=11,this.tileY=4,this.offsetY=-.3,this.canUseOnOther=!0}}r(sa,"itemName","weapon poison");class ra extends dt{constructor(t,i,s){super(t,i,s);r(this,"onUse",t=>{t.health=Math.min(t.maxHealth,t.health+1),this.level.game.rooms[t.levelID]===this.level.game.room&&H.heal()});r(this,"useOnOther",(t,i)=>{i instanceof Et&&(i.applyStatus({blood:!0,poison:!1}),t.inventory.removeItem(this),this.level.game.pushMessage(`You coat your ${i.name} in cursed blood.`))});r(this,"getDescription",()=>`WEAPON BLOOD
Can be applied to weapons to deal bleed damage`);this.tileX=12,this.tileY=4,this.offsetY=-.3,this.canUseOnOther=!0}}r(ra,"itemName","cursed blood");const _r=class _r extends vt{constructor(e,t,i){super(e,t,i),this.tileX=11,this.tileY=2,this.name=_r.itemName,this.stackable=!1,this.description="A ring of emerald"}};r(_r,"itemName","emerald ring");let Ns=_r;const Nr=class Nr extends vt{constructor(e,t,i){super(e,t,i),this.tileX=13,this.tileY=2,this.name=Nr.itemName,this.stackable=!1,this.description="A ring of zircon"}};r(Nr,"itemName","zircon ring");let Xs=Nr;const Xr=class Xr extends vt{constructor(e,t,i){super(e,t,i),this.tileX=14,this.tileY=2,this.name=Xr.itemName,this.stackable=!1,this.description="A ring of amber"}};r(Xr,"itemName","amber ring");let Hs=Xr;const Hr=class Hr extends vt{constructor(e,t,i){super(e,t,i),this.tileX=12,this.tileY=2,this.name=Hr.itemName,this.stackable=!1,this.description="A ring of garnet"}};r(Hr,"itemName","garnet ring");let Bs=Hr;const Br=class Br extends vt{constructor(t,i,s){super(t,i,s);r(this,"embed",(t,i)=>{switch(t.inventory.subtractItem(i,1),t.inventory.removeItem(this),i.name){case"emerald":t.inventory.addItem(new Ns(this.level,this.x,this.y));break;case"zircon":t.inventory.addItem(new Xs(this.level,this.x,this.y));break;case"amber":t.inventory.addItem(new Hs(this.level,this.x,this.y));break;case"garnet":t.inventory.addItem(new Bs(this.level,this.x,this.y));break}this.level.game.pushMessage("You embed the gem into the ring.")});this.tileX=19,this.tileY=2,this.name=Br.itemName,this.stackable=!1,this.description="Embed a gem within this ring to imbue it with magic."}};r(Br,"itemName","gold ring");let ls=Br;const Fr=class Fr extends me{constructor(t,i,s){super(t,i,s);r(this,"smith",t=>{t.inventory.subtractItem(this,1),t.inventory.addItem(new ls(this.level,this.x,this.y)),this.level.game.pushMessage("You hammer the gold bar into a ring."),H.playSmith()});this.tileX=18,this.tileY=2,this.name=Fr.itemName,this.stackable=!0,this.description="A bar of gold. Hit it with a hammer to make a ring."}};r(Fr,"itemName","gold bar");let Fs=Fr;const Ur=class Ur extends me{constructor(t,i,s){super(t,i,s);r(this,"smelt",t=>{if(t.inventory.isFull()){this.level.game.pushMessage("You don't have enough space in your inventory to smelt the gold ore.");return}this.stackCount>=3&&(t.inventory.subtractItem(this,3),t.inventory.addItem(new Fs(this.level,this.x,this.y)),H.playSmith(),this.level.game.pushMessage("You smelt the gold ore into a gold bar."))});this.tileX=18,this.tileY=0,this.name=Ur.itemName,this.stackable=!0,this.description="Some gold ore"}};r(Ur,"itemName","gold");let At=Ur;class aa extends me{constructor(t,i,s){super(t,i,s);r(this,"getDescription",()=>`STONE
Some fragments of stone.`);this.tileX=15,this.tileY=0,this.stackable=!0}}r(aa,"itemName","stones");const Gr=class Gr extends Et{constructor(e,t,i){super(e,t,i),this.tileX=30,this.tileY=0,this.name=Gr.itemName,this.description="allows mining rocks without equipping",this.canMine=!0}};r(Gr,"itemName","pickaxe");let Ne=Gr;const Wr=class Wr extends dt{constructor(t,i,s){super(t,i,s);r(this,"onUse",t=>{t.health=Math.min(t.maxHealth,t.health+1),(t!=null&&t.getRoom?t.getRoom():this.level.game.rooms[t.levelID])===this.level.game.room&&H.heal()});r(this,"useOnOther",(t,i)=>{i instanceof Et&&i.name!=="dagger"?i.disassemble():i.name==="dagger"?this.level.game.pushMessage("You probably shouldn't disassemble your dagger..."):i.name==="hammer"&&i!==this?(i.disassemble(t),this.level.game.pushMessage("I only needed one of those anyways...")):i.name==="geode"?(i.split(t.inventory),this.level.game.pushMessage("You hit the geode with the hammer.")):i.name==="pickaxe"?i.disassemble():i.name==="gold bar"?i.smith(t):i.name==="gold"?i.smelt(t):i.name==="fishing rod"&&i.disassemble()});r(this,"disassemble",t=>{let i=this.x,s=this.y,a=Math.ceil(O.rand()*5+5);t.inventory.removeItem(this),t.inventory.addItem(new ei(this.level,i,s,a))});this.tileX=21,this.tileY=2,this.offsetY=-.3,this.canUseOnOther=!0,this.description="useful for breaking weapons down into fragments",this.name=Wr.itemName}};r(Wr,"itemName","hammer");let Ke=Wr;class Ni extends Wi{constructor(t,i,s){super(t,i,s);r(this,"fuelCap");r(this,"getDescription",()=>`LANTERN - Fuel: ${Math.round(this.fuel/this.fuelCap*100)}%, Capacity: ${this.fuelCap/50}`);this.fuel=250,this.tileX=29,this.tileY=0,this.fuelCap=250,this.name="lantern",this.canRefuel=!0,this.maxBrightness=20,this.minBrightness=5,this.radius=7,this.broken=this.fuel<=0}}r(Ni,"itemName","lantern");const Vr=class Vr extends dt{constructor(t,i,s){super(t,i,s);r(this,"onUse",t=>{let i=t.inventory.hasItem(Ni);i instanceof Ni&&i.fuel<=i.fuelCap-50&&(t.game.pushMessage("You add some fuel to your lantern."),this.stackCount-=1,this.stackCount<=0&&t.inventory.removeItem(this))});r(this,"useOnOther",(t,i)=>{if(i instanceof Wi&&i.canRefuel&&i.fuel<=0&&i.broken){let s=Math.min(this.stackCount*25,i.fuelCap);i.fuel+=s,this.stackCount-=s/25,i.broken=!1,this.level.game.pushMessage(`You add refuel your ${i.name} with ${s/25} coal.`),this.stackCount<=0&&t.inventory.removeItem(this)}});this.tileX=17,this.tileY=0,this.stackable=!0,this.stackCount=Math.ceil(O.rand()*7+3),this.name=Vr.itemName,this.description="A piece of coal. Fuels lantern.",this.canUseOnOther=!0}};r(Vr,"itemName","coal");let Xi=Vr;class si extends Wi{constructor(e,t,i){super(e,t,i),this.tileX=28,this.tileY=0,this.name="torch",this.fuelCap=500,this.fuel=500,this.radius=7,this.maxBrightness=5,this.minBrightness=2,this.stackable=!0}}r(si,"itemName","torch");class Vi extends xi{constructor(t,i,s){super();r(this,"globalId");r(this,"x");r(this,"y");r(this,"dead");r(this,"parent");r(this,"dir");r(this,"bloomOffsetY");r(this,"lightSource");r(this,"hitPlayer",t=>{});r(this,"hitEnemy",t=>{});r(this,"tick",()=>{});r(this,"draw",t=>{});r(this,"drawTopLayer",t=>{});this.globalId=se.generate("PROJ"),this.x=i,this.y=s,this.dead=!1,this.parent=t,this.drawableY=s,this.hasBloom=!1,this.bloomColor="#00BFFF",this.bloomOffsetY=0}get distanceToParent(){return Math.abs(this.x-this.parent.x)+Math.abs(this.y-this.parent.y)}setTarget(t,i,s,a){}}const ki=class ki{};r(ki,"momentaryLight",(e,t,i,s,a,n,c,l)=>{const d=ki.newLightSource(t,i,a,s,c);setTimeout(()=>{e.updateLightSources(d),setTimeout(()=>{e.updateLightSources(d,!0)},n)},l)}),r(ki,"newLightSource",(e,t,i,s,a)=>new Vt(e,t,s,i,a)),r(ki,"addLightSource",(e,t)=>{e.lightSources.push(t)}),r(ki,"removeLightSource",(e,t)=>{e.lightSources=e.lightSources.filter(i=>i!==t)});let Xe=ki;class wh extends Vi{constructor(t,i,s){super(t,i,s);r(this,"state");r(this,"frame");r(this,"delay");r(this,"parent");r(this,"offsetFrame");r(this,"drawTopLayer",t=>{this.dead||(this.offsetFrame<0&&(this.offsetFrame+=10*t),this.offsetFrame>=0&&(this.frame+=.25*t),this.frame>17&&(this.dead=!0),m.drawFX(Math.floor(this.frame),6,1,2,this.x,this.y-1,1,2))});this.state=0,this.frame=6,this.offsetFrame=-Q.distance(this.parent.x,this.parent.y,this.x,this.y)*50,this.delay=0,Xe.momentaryLight(this.parent.game.rooms[this.parent.levelID],this.x+.5,this.y+.5,.5,[255,100,0],250,10,1)}}class zs extends dt{constructor(t,i,s,a){super(t,i,s);r(this,"onUse",t=>{t.health=Math.min(t.maxHealth,t.health+1),(t!=null&&t.getRoom?t.getRoom():this.level.game.rooms[t.levelID])===this.level.game.room&&H.heal(),t.inventory.removeItem(this)});r(this,"useOnOther",(t,i)=>{if(i instanceof vt&&i.durabilityMax-i.durability>=1&&i.name==="spellbook"){let s=Math.min(i.durabilityMax-i.durability,this.stackCount);i.durability+=s,this.stackCount-=s,i.broken=!1,this.level.game.pushMessage(`You feel your ${i.name}'s power return as you add ${s} pages to it.`),this.stackCount<=0&&t.inventory.removeItem(this)}});this.tileX=25,this.tileY=2,this.offsetY=-.3,this.name="spellbook pages",this.canUseOnOther=!0,this.stackable=!0,this.stackCount=a||Math.ceil(O.rand()*3),this.description="Can be used to restore power to a depleted spellbook"}}r(zs,"itemName","weapon fragments");const jr=class jr extends Et{constructor(t,i,s){super(t,i,s);r(this,"targets");r(this,"isTargeting");r(this,"getTargets",()=>{var a;this.targets=[];let i=((a=this.wielder)!=null&&a.getRoom?this.wielder.getRoom():this.game.rooms[this.wielder.levelID]).entities;this.targets=i.filter(n=>!n.pushable&&Q.distance(this.wielder.x,this.wielder.y,n.x,n.y)<=this.range&&n.destroyable);let s=this.targets.filter(n=>n.isEnemy===!0);return s.length>0?s:this.targets});r(this,"disassemble",()=>{if(this.equipped){this.game.pushMessage("I should probably unequip this before I try to disassemble it...");return}this.game.pushMessage("You tear the remaining pages out of your spellbook.");let t=this.wielder.inventory,i=this.x,s=this.y,a=Math.floor(this.durability);this.toggleEquip(),t.removeItem(this),t.addItem(new zs(this.level,i,s,a))});r(this,"weaponMove",(t,i)=>{var d,u;this.getTargets();let s=this.wielder.direction,a=!1,n=this.targets;const c=h=>{switch(s){case E.UP:return h.y<=i;case E.RIGHT:return h.x>=t;case E.DOWN:return h.y>=i;case E.LEFT:return h.x<=t;default:return!1}};n.length>0?this.isTargeting=!0:this.isTargeting=!1,n=n.filter(c);const l=[];for(let h of n){const f=(d=this.wielder)!=null&&d.getRoom?this.wielder.getRoom():this.game.rooms[this.wielder.levelID];f.roomArray[h.x][h.y].isSolid()||(h.hurt(this.wielder,1),f.projectiles.push(new wh(this.wielder,h.x,h.y)),l.push(h),a=!0)}return this.targets=l,a&&(this.hitSound(),this.wielder.setHitXY(t,i),((u=this.wielder)!=null&&u.getRoom?this.wielder.getRoom():this.game.rooms[this.wielder.levelID]).tick(this.wielder),this.shakeScreen(t,i),H.playMagic(),this.cooldown=this.cooldownMax,setTimeout(()=>{this.isTargeting=!1},100)),!a});r(this,"drawBeams",(t,i,s)=>{var n;const a=(n=this.wielder)!=null&&n.getRoom?this.wielder.getRoom():this.game.rooms[this.wielder.levelID];if(a.beamEffects=[],this.isTargeting)for(let c of this.targets)a.addBeamEffect(t,i,c.x-c.drawX,c.y-c.drawY,c),a.beamEffects[a.beamEffects.length-1].render(t,i,c.x-c.drawX,c.y-c.drawY,"cyan",2,s)});this.range=4,this.tileX=25,this.tileY=0,this.canMine=!0,this.name=jr.itemName,this.isTargeting=!1,this.durability=10,this.durabilityMax=10,this.description="Hits multiple enemies within a range of 4 tiles.",this.degradeable=!1,this.cooldownMax=25}};r(jr,"itemName","spellbook");let Qe=jr;const qr=class qr extends dt{constructor(t,i,s){super(t,i,s);r(this,"onUse",t=>{const{Bomb:i}=require("../entity/object/bomb");i.add(t.game.room,t.game,t.x,t.y),t.inventory.removeItem(this),H.mine()});this.tileX=20,this.tileY=2,this.offsetY=-.3,this.name=qr.itemName,this.description="explodes"}};r(qr,"itemName","bomb");let Us=qr;class oa extends Et{constructor(t,i,s){super(t,i,s);r(this,"hitDelay");r(this,"hitSound",()=>{H.swing(),H.playWarHammer()});r(this,"adjustedDamage",()=>{var s,a;let t=((s=this.wielder)==null?void 0:s.health)/((a=this.wielder)==null?void 0:a.maxHealth),i=1;return t<=1&&(i=1),t<=.75&&(i=2),t<=.5&&(i=4),t<=.25&&(i=8),i});r(this,"attack",t=>{t.hurt(this.wielder,this.adjustedDamage()),this.statusEffect(t)});r(this,"shakeScreen",()=>{this.wielder.beginSlowMotion(),setTimeout(()=>{switch(this.wielder.endSlowMotion(),this.wielder.direction){case E.DOWN:this.game.shakeScreen(0,-10*this.adjustedDamage(),!1);break;case E.UP:this.game.shakeScreen(0,-10*this.adjustedDamage(),!1);break;case E.LEFT:this.game.shakeScreen(-5,-10*this.adjustedDamage(),!1);break;case E.RIGHT:this.game.shakeScreen(5,-10*this.adjustedDamage(),!1);break}},this.hitDelay)});this.tileX=24,this.tileY=2,this.damage=2,this.name="greataxe",this.hitDelay=225,this.offsetY=0,this.iconOffset=.2,this.durability=25,this.durabilityMax=25,this.useCost=5,this.twoHanded=!0}}r(oa,"itemName","greataxe");const $r=class $r extends me{constructor(t,i,s){super(t,i,s);r(this,"getDescription",()=>`GEODE
When in doubt hit it with a hammer.`);r(this,"split",t=>{if(t.isFull())this.level.game.pushMessage("You don't have enough space in your inventory to split the geode.");else{const i=Math.min(1,Q.randomNormalInt(1,3));let s=[ze,ce,_e],a=s[Math.floor(O.rand()*s.length)];this.level.game.pushMessage(`You split the geode and find ${i} ${a.itemName}.`);for(let n=0;n<i;n++)t.addItem(new a(this.level,this.x,this.y));t.removeItem(this)}});this.tileX=15,this.tileY=2,this.name=$r.itemName,this.stackable=!1}};r($r,"itemName","geode");let Se=$r;class ps extends Et{constructor(t,i,s){super(t,i,s);r(this,"hitDelay");r(this,"hitSound",()=>{H.swing(),H.playSlice()});r(this,"weaponMove",(t,i)=>{var n,c;let s=[];switch(this.wielder.direction){case E.DOWN:s=[{x:t-1,y:i},{x:t+1,y:i},{x:t-1,y:i-1},{x:t+1,y:i-1}];break;case E.UP:s=[{x:t+1,y:i},{x:t-1,y:i},{x:t+1,y:i+1},{x:t-1,y:i+1}];break;case E.LEFT:s=[{x:t,y:i+1},{x:t,y:i-1},{x:t+1,y:i+1},{x:t+1,y:i-1}];break;case E.RIGHT:s=[{x:t,y:i-1},{x:t,y:i+1},{x:t-1,y:i-1},{x:t-1,y:i+1}];break}if(this.checkForPushables(t,i))return!0;const a=this.executeAttack(t,i,!0,1,!0,!0,!0,!1);if(a){if(s.length>0)for(const d of s)((n=this.wielder)!=null&&n.getRoom?this.wielder.getRoom():this.game.rooms[this.wielder.levelID]).roomArray[d.x][d.y].isSolid()||this.hitEntitiesAt(d.x,d.y,1);((c=this.wielder)!=null&&c.getRoom?this.wielder.getRoom():this.game.rooms[this.wielder.levelID]).tick(this.wielder)}return!a});r(this,"shakeScreen",()=>{setTimeout(()=>{switch(this.wielder.direction){case E.DOWN:this.game.shakeScreen(0,-5,!1);break;case E.UP:this.game.shakeScreen(0,-5,!1);break;case E.LEFT:this.game.shakeScreen(-5,-5,!1);break;case E.RIGHT:this.game.shakeScreen(5,-5,!1);break}},this.hitDelay)});this.tileX=23,this.tileY=2,this.damage=1,this.name="scythe",this.hitDelay=150,this.useCost=2,this.offsetY=0,this.iconOffset=.2,this.degradeable=!1,this.twoHanded=!0}}r(ps,"itemName","scythe");class no extends dt{constructor(t,i,s){super(t,i,s);r(this,"onUse",t=>{this.broken||(t.stall(),t.game.pushMessage("turn skipped"),this.durability-=1,this.durability<=0&&(this.broken=!0))});r(this,"getDescription",()=>`HOURGLASS
Skips a turn`);this.tileX=0,this.tileY=2,this.offsetY=-.3,this.durability=30,this.durabilityMax=30}}const Zr=class Zr extends dt{constructor(t,i,s){super(t,i,s);r(this,"onDrop",()=>{this.level.game.lastDroppedScythePiece==="blade"?(this.level.game.lastDroppedScythePiece=null,this.level.items.push(new Bi(this.level,this.x,this.y)),this.level.items=this.level.items.filter(t=>t!==this)):this.level.game.lastDroppedScythePiece===null&&(this.level.game.lastDroppedScythePiece="blade")});r(this,"useOnOther",(t,i)=>{if(i instanceof Bi){t.inventory.removeItem(this),t.inventory.removeItem(i),t.game.pushMessage("You combine the scythe blade and handle.");const s=t!=null&&t.getRoom?t.getRoom():t.game.rooms[t.levelID],a=new ps(s,t.x,t.y);t.inventory.addItem(a)}});this.tileX=30,this.tileY=2,this.stackable=!1,this.name=Zr.itemName,this.description="The blade of a scythe. Find the handle to use it.",this.canUseOnOther=!0}};r(Zr,"itemName","scythe blade");let Hi=Zr;const zr=class zr extends dt{constructor(t,i,s){super(t,i,s);r(this,"onDrop",()=>{this.level.game.lastDroppedScythePiece==="handle"?(this.level.game.lastDroppedScythePiece=null,this.level.items.push(new Hi(this.level,this.x,this.y)),this.level.items=this.level.items.filter(t=>t!==this)):this.level.game.lastDroppedScythePiece===null&&(this.level.game.lastDroppedScythePiece="handle")});r(this,"useOnOther",(t,i)=>{if(i instanceof Hi){t.inventory.removeItem(this),t.inventory.removeItem(i),t.game.pushMessage("You combine the scythe blade and handle.");const s=t!=null&&t.getRoom?t.getRoom():t.game.rooms[t.levelID],a=new ps(s,t.x,t.y);t.inventory.addItem(a)}});this.tileX=29,this.tileY=2,this.stackable=!1,this.name=zr.itemName,this.description="The handle of a scythe. Find the blade to use it.",this.canUseOnOther=!0}};r(zr,"itemName","scythe handle");let Bi=zr;const Kr=class Kr extends me{constructor(t,i,s){super(t,i,s);r(this,"disassemble",()=>{this.level.game.pushMessage(`You dissassemble your ${this.name} into fragments.`);let t=this.level.game.players[this.level.game.localPlayerID].inventory,i=this.x,s=this.y,a=Math.floor(10+O.rand()*10);this.level.game.pushMessage(`You dissassemble your fishing rod into ${a} fragments.`),t.removeItem(this),t.addItem(new ei(this.level,i,s),a)});this.tileX=31,this.tileY=2,this.offsetY=-.1,this.description="useful for catching fish",this.name=Kr.itemName}};r(Kr,"itemName","fishing rod");let Je=Kr;const Qr=class Qr extends dt{constructor(t,i,s){super(t,i,s);r(this,"onDrop",()=>{this.level.game.lastDroppedShieldPiece==="left"?(this.level.game.lastDroppedShieldPiece=null,this.level.items.push(new Ui(this.level,this.x,this.y)),this.level.items=this.level.items.filter(t=>t!==this)):this.level.game.lastDroppedShieldPiece===null&&(this.level.game.lastDroppedScythePiece="blade")});r(this,"useOnOther",(t,i)=>{if(i instanceof Ui){t.inventory.removeItem(this),t.inventory.removeItem(i),t.game.pushMessage("You combine the shield fragments into a shield.");const s=t!=null&&t.getRoom?t.getRoom():t.game.rooms[t.levelID],a=new Wt(s,t.x,t.y);t.inventory.addItem(a)}});this.tileX=1,this.tileY=2,this.stackable=!1,this.name=Qr.itemName,this.description="The left fragment of a shield. Find the right fragment to use it.",this.canUseOnOther=!0}};r(Qr,"itemName","left shield fragment");let Fi=Qr;const Jr=class Jr extends dt{constructor(t,i,s){super(t,i,s);r(this,"onDrop",()=>{this.level.game.lastDroppedShieldPiece==="right"?(this.level.game.lastDroppedShieldPiece=null,this.level.items.push(new Fi(this.level,this.x,this.y)),this.level.items=this.level.items.filter(t=>t!==this)):this.level.game.lastDroppedShieldPiece===null&&(this.level.game.lastDroppedShieldPiece="right")});r(this,"useOnOther",(t,i)=>{if(i instanceof Fi){t.inventory.removeItem(this),t.inventory.removeItem(i),t.game.pushMessage("You combine the shield fragments into a shield.");const s=t!=null&&t.getRoom?t.getRoom():t.game.rooms[t.levelID],a=new Wt(s,t.x,t.y);t.inventory.addItem(a)}});this.tileX=2,this.tileY=2,this.stackable=!1,this.name=Jr.itemName,this.description="The right fragment of a shield. Find the left fragment to use it.",this.canUseOnOther=!0}};r(Jr,"itemName","right shield fragment");let Ui=Jr;const xh={dualdagger:Zs,warhammer:ms,spear:we,spellbook:Qe,greataxe:oa,scythe:ps,hourglass:no,fishingrod:Je,scytheblade:Hi,scythehandle:Bi,shieldleftfragment:Fi,shieldrightfragment:Ui,armor:Wt,pickaxe:Ne,hammer:Ke,heart:ue,weaponpoison:sa,weaponblood:ra,coin:ct,weaponfragments:ei,spellbookPage:zs,backpack:hs,candle:ii,torch:si,lantern:Ni,redgem:ce,bluegem:ze,greengem:_e,geode:Se,gold:At,stone:aa,coal:Xi,bomb:Us},ni=class ni{};r(ni,"drops",[{itemType:"dualdagger",dropRate:500,category:["weapon","melee"],unique:!0},{itemType:"warhammer",dropRate:250,category:["weapon","melee"],unique:!0},{itemType:"spear",dropRate:150,category:["weapon","melee"],unique:!0},{itemType:"spellbook",dropRate:250,category:["weapon","magic"],unique:!0},{itemType:"greataxe",dropRate:500,category:["weapon","melee"],unique:!0},{itemType:"scythe",dropRate:500,category:["reaper"],unique:!0},{itemType:"scytheblade",dropRate:10,category:["reaper"],unique:!0},{itemType:"scythehandle",dropRate:10,category:["reaper"],unique:!0},{itemType:"shieldleftfragment",dropRate:10,category:["occultist"],unique:!0},{itemType:"shieldrightfragment",dropRate:10,category:["occultist"],unique:!0},{itemType:"weaponpoison",dropRate:3,category:["frog"],unique:!0},{itemType:"armor",dropRate:350,category:["equipment"],unique:!0},{itemType:"pickaxe",dropRate:25,category:["tool"]},{itemType:"hammer",dropRate:25,category:["tool"]},{itemType:"fishingrod",dropRate:40,category:["tool"]},{itemType:"hourglass",dropRate:10,category:["reaper"],unique:!0},{itemType:"heart",dropRate:20,category:["consumable"]},{itemType:"weaponblood",dropRate:100,category:["consumable"]},{itemType:"coin",dropRate:10,category:["coin"]},{itemType:"weaponfragments",dropRate:100,category:["consumable","melee"]},{itemType:"spellbookPage",dropRate:100,category:["consumable","magic"]},{itemType:"backpack",dropRate:100,category:["upgrade"]},{itemType:"candle",dropRate:100,category:["light"]},{itemType:"torch",dropRate:250,category:["light"]},{itemType:"lantern",dropRate:500,category:["light"]},{itemType:"redgem",dropRate:25,category:["gem","resource"]},{itemType:"bluegem",dropRate:25,category:["gem","resource"]},{itemType:"greengem",dropRate:25,category:["gem","resource"]},{itemType:"geode",dropRate:100,category:["gem","resource"]},{itemType:"gold",dropRate:200,category:["resource"]},{itemType:"stone",dropRate:200,category:["resource"]},{itemType:"coal",dropRate:100,category:["fuel","lantern","resource","light"]},{itemType:"bomb",dropRate:100,category:["bomb","weapon"]}]),r(ni,"getDrop",(e,t=[],i=!1,s=0,a=1)=>{if(e.cloned)return;const n=e.room.depth+s,c=e.dropChance||1;if(!i&&c>1&&O.rand()>1/c)return null;let l=ni.drops.filter(h=>h.minDepth===void 0||h.minDepth<=n);if(t.length===0&&(l=l.filter(h=>h.unique===void 0||h.unique===!1)),t.length>0&&(l=l.filter(h=>t.includes(h.itemType)||h.category.some(f=>t.includes(f)))),l.length===0)return null;let d=0,u=[];for(const h of l){const f=O.rand(),p=1/h.dropRate;if(f<p){const y=ni.addNewItem(h.itemType,e);if(y&&(u.push(y),d++,d>=a))break}}if(i&&d===0&&l.length>0){const h=l.reduce((p,y)=>p.dropRate<y.dropRate?p:y),f=ni.addNewItem(h.itemType,e);f&&u.push(f)}return u.length>0?u:null}),r(ni,"addNewItem",(e,t)=>{const i=xh[e];if(!i)return console.error(`Item type "${e}" is not recognized.`),null;let s=i.add(t.room,t.x,t.y);return s.name==="coin"&&(s.stackCount=Q.randomNormalInt(0,14)),(s instanceof ze||s instanceof ce||s instanceof _e)&&(s.stackCount=Q.randomNormalInt(0,5)),t.drops.push(s),s});let Wa=ni;const st=class st extends Vi{constructor(t,i,s,a,n){super(n,t,i);r(this,"points");r(this,"prevStartX");r(this,"prevStartY");r(this,"prevEndX");r(this,"prevEndY");r(this,"active",!0);r(this,"time",0);r(this,"alpha",1);r(this,"targetX");r(this,"targetY");r(this,"color");r(this,"compositeOperation");r(this,"gravity",st.GRAVITY);r(this,"motionInfluence",st.MOTION_INFLUENCE);r(this,"turbulence",st.TURBULENCE);r(this,"velocityDecay",st.VELOCITY_DECAY);r(this,"angleChange",st.ANGLE_CHANGE);r(this,"maxVelocity",st.MAX_VELOCITY);r(this,"damping",st.DAMPING);r(this,"springStiffness",st.SPRING_STIFFNESS);r(this,"springDamping",st.SPRING_DAMPING);r(this,"iterations",st.ITERATIONS);r(this,"segments",st.SEGMENTS);r(this,"type");r(this,"tick",()=>{this.parent.dead&&this.destroy()});r(this,"draw",t=>{this.drawableY=this.y-.01,this.render(this.targetX,this.targetY,this.x,this.y,this.color,2,t,this.compositeOperation)});const c=t*x.TILESIZE+.5*x.TILESIZE,l=i*x.TILESIZE+.5*x.TILESIZE,d=s*x.TILESIZE+.5*x.TILESIZE,u=a*x.TILESIZE+.5*x.TILESIZE;this.x=t,this.y=i,this.targetX=s,this.targetY=a,this.points=this.initializePoints(c,l,d,u),this.prevStartX=c,this.prevStartY=l,this.prevEndX=d,this.prevEndY=u,this.color="cyan",this.compositeOperation="source-over"}setPhysics(t,i,s,a,n,c,l,d,u,h,f){this.gravity=t??st.GRAVITY,this.motionInfluence=i??st.MOTION_INFLUENCE,this.turbulence=s??st.TURBULENCE,this.velocityDecay=a??st.VELOCITY_DECAY,this.angleChange=n??st.ANGLE_CHANGE,this.maxVelocity=c??st.MAX_VELOCITY,this.damping=l??st.DAMPING,this.springStiffness=d??st.SPRING_STIFFNESS,this.springDamping=u??st.SPRING_DAMPING,this.iterations=h??st.ITERATIONS,this.segments=f??st.SEGMENTS}setTarget(t,i,s,a){this.x=t,this.y=i,this.targetX=s,this.targetY=a}render(t,i,s,a,n=this.color,c=2,l=1/60,d=this.compositeOperation){const u=this.x*x.TILESIZE+.5*x.TILESIZE,h=this.y*x.TILESIZE+.5*x.TILESIZE,f=this.targetX*x.TILESIZE+.5*x.TILESIZE,p=this.targetY*x.TILESIZE+.5*x.TILESIZE,y=(u-this.prevStartX)*this.motionInfluence*l,g=(h-this.prevStartY)*this.motionInfluence*l,w=(f-this.prevEndX)*this.motionInfluence*l,b=(p-this.prevEndY)*this.motionInfluence*l;for(let v=1;v<4;v++){const k=1-v/4;this.points[v].x+=y*k,this.points[v].y+=g*k}for(let v=this.points.length-4;v<this.points.length-1;v++){const k=1-(this.points.length-v)/4;this.points[v].x+=w*k,this.points[v].y+=b*k}this.simulateRope(u,h,f,p,l);const T=m.ctx;T.save(),m.ctx.globalCompositeOperation=d;for(let v=0;v<this.points.length-1;v++){const k=this.points[v],D=this.points[v+1],N=D.x-k.x,U=D.y-k.y,Z=Math.max(Math.abs(N),Math.abs(U)),j=N/Z,V=U/Z;let J=k.x,z=k.y;for(let tt=0;tt<=Z;tt++){for(let ft=0;ft<c;ft++)for(let at=0;at<c;at++)T.fillStyle=n,T.fillRect(Math.round(J+ft),Math.round(z+at),1,1);J+=j,z+=V}}T.restore(),this.prevStartX=u,this.prevStartY=h,this.prevEndX=f,this.prevEndY=p}initializePoints(t,i,s,a){const n=[];for(let c=0;c<this.segments;c++){const l=c/(this.segments-1);n.push({x:t+(s-t)*l,y:i+(a-i)*l,oldX:t+(s-t)*l,oldY:i+(a-i)*l,velocityX:0,velocityY:0,angle:O.rand()*Math.PI*2})}return n}applyTurbulence(t,i){t.angle+=Math.sin(this.time*.1+i*.5)*this.angleChange;const s=Math.cos(t.angle)*this.turbulence,a=Math.sin(t.angle)*this.turbulence;t.velocityX+=s,t.velocityY+=a,t.velocityX=Math.min(Math.max(t.velocityX,-this.maxVelocity),this.maxVelocity),t.velocityY=Math.min(Math.max(t.velocityY,-this.maxVelocity),this.maxVelocity)}simulateRope(t,i,s,a,n){const c=Math.ceil(this.iterations*n);for(let l=0;l<c;l++){for(let u=1;u<this.points.length-1;u++){const h=this.points[u],f=this.points[u-1],p=this.points[u+1],y=(f.x-h.x)*this.springStiffness,g=(f.y-h.y)*this.springStiffness,w=(p.x-h.x)*this.springStiffness,b=(p.y-h.y)*this.springStiffness;this.applyTurbulence(h,u),h.velocityX=(h.velocityX+y+w)*this.damping,h.velocityY=(h.velocityY+g+b)*this.damping;const T=f.velocityX-h.velocityX,v=f.velocityY-h.velocityY,k=p.velocityX-h.velocityX,D=p.velocityY-h.velocityY;h.velocityX+=(T+k)*this.springDamping,h.velocityY+=(v+D)*this.springDamping,h.oldX=h.x,h.oldY=h.y,h.x+=h.velocityX,h.y+=h.velocityY+this.gravity}const d=Math.sqrt(Math.pow(s-t,2)+Math.pow(a-i,2))/(this.segments-1);for(let u=0;u<2;u++)for(let h=0;h<this.points.length-1;h++){const f=this.points[h],p=this.points[h+1],y=p.x-f.x,g=p.y-f.y,w=Math.sqrt(y*y+g*g),T=(d-w)/w/2,v=y*T,k=g*T;h>0&&(f.x-=v*1.5,f.y-=k*1.5),h<this.points.length-2&&(p.x+=v*1.5,p.y+=k*1.5)}}this.points[0].x=t,this.points[0].y=i,this.points[0].oldX=t,this.points[0].oldY=i,this.points[this.points.length-1].x=s,this.points[this.points.length-1].y=a,this.points[this.points.length-1].oldX=s,this.points[this.points.length-1].oldY=a}static renderBeam(t,i,s,a,n="cyan",c=2,l=1){const d=m.ctx;d.globalAlpha=l;const u=t*x.TILESIZE+.5*x.TILESIZE,h=i*x.TILESIZE+.5*x.TILESIZE,f=s*x.TILESIZE+.5*x.TILESIZE,p=a*x.TILESIZE+.5*x.TILESIZE;d.save(),d.beginPath(),d.moveTo(u,h),d.lineTo(f,p),d.lineWidth=c,d.strokeStyle=n,d.stroke(),d.restore()}destroy(){this.active=!1,this.points=[],this.dead=!0}isActive(){return this.active}};r(st,"SEGMENTS",30),r(st,"GRAVITY",2),r(st,"ITERATIONS",5),r(st,"MOTION_INFLUENCE",1),r(st,"TURBULENCE",.5),r(st,"VELOCITY_DECAY",.1),r(st,"ANGLE_CHANGE",.01),r(st,"MAX_VELOCITY",100),r(st,"DAMPING",.8),r(st,"SPRING_STIFFNESS",.01),r(st,"SPRING_DAMPING",.1);let de=st;class yn extends Vi{constructor(t,i,s,a=1,n=!0){super(t,i,s);r(this,"frame");r(this,"parent");r(this,"tileX");r(this,"tileY");r(this,"health");r(this,"autoRegistered");r(this,"remove",()=>{this.parent.shielded=!1,this.parent.removeLightSource(this.lightSource),this.parent.room.projectiles=this.parent.room.projectiles.filter(i=>i!==this);let t=this.parent.room.projectiles.find(i=>i instanceof de&&i.parent===this.parent);t&&(t.dead=!0),this.parent.shadeColor="black",this.lightSource=null,this.parent.shield=null});r(this,"updateLightSourcePos",()=>{if(this.lightSource===null)return;let t=this.parent.room.lightSources.indexOf(this.lightSource);this.parent.room.lightSources[t].x=this.parent.x+.5,this.parent.room.lightSources[t].y=this.parent.y+.5});r(this,"hurt",t=>{const i=Math.max(0,t-this.health);return this.health-=t,this.parent.maxHealth-=t,this.health<=0&&this.remove(),i});r(this,"tick",()=>{var t;if(!this.parent||!this.parent.room){this.dead=!0;return}(t=this.parent)!=null&&t.dead&&this.remove(),this.dead&&this.parent&&this.parent.room&&(this.parent.room.projectiles=this.parent.room.projectiles.filter(i=>i!==this))});r(this,"draw",t=>{this.dead||(m.ctx.save(),m.ctx.globalAlpha=1,this.frame+=.1*t,this.frame>=4&&(this.frame=0),this.drawableY=this.parent.drawableY-.05,m.ctx.globalCompositeOperation="difference",this.parent.shielded&&m.drawFX(18+Math.floor(this.frame),9,1,1,this.parent.x-this.parent.drawX,this.parent.y-this.parent.drawY,1,1),m.ctx.restore())});if(this.parent=t,this.frame=0,this.health=a,this.autoRegistered=!1,!this.parent||!this.parent.room){this.dead=!0;return}this.parent.shielded=!0,this.lightSource=Xe.newLightSource(this.x+.5,this.y+.5,[20,0,40],3.5,20),this.parent.addLightSource(this.lightSource),n&&(this.parent.room.projectiles.push(this),this.autoRegistered=!0),this.parent.room.updateLighting()}}const is=class is extends yi{constructor(t,i,s,a,n,c,l,d,u,h,f,p,y,g,w,b){super();r(this,"room");r(this,"x");r(this,"y");r(this,"z");r(this,"s");r(this,"dx");r(this,"dy");r(this,"targetX");r(this,"targetY");r(this,"targetZ");r(this,"dz");r(this,"color");r(this,"alpha");r(this,"delay");r(this,"expirationTimer");r(this,"tileX");r(this,"tileY");r(this,"size");r(this,"render",()=>{let t=x.TILESIZE;this.z*t,this.s>.5,m.ctx.imageSmoothingEnabled=!1;let i=this.tileX+this.size;m.drawFX(i,this.tileY,1,1,this.x-this.alpha/2,this.y-this.z-this.alpha/2,1,1,this.shadeColor(),this.shadeAmount())});r(this,"draw",t=>{m.ctx.imageSmoothingEnabled=!1,this.targetX?this.x+=.2*(this.targetX-this.x)*t:this.x+=this.dx*t,this.targetY?this.y+=.2*(this.targetY-this.y)*t:this.y+=this.dy*t,this.targetZ?this.z+=.2*(this.targetZ-this.z)*t:this.z+=this.dz*t,this.dx*=Math.pow(.97,t),this.dy*=Math.pow(.97,t),this.z<=0&&(this.z=0,this.dz*=-.8),this.dz-=.01*t,this.expirationTimer-=t,this.expirationTimer<=0&&(this.dead=!0),!this.dead&&(this.drawableY=this.y,this.render())});this.room=t,this.x=i,this.y=s,this.z=a,this.s=n,this.dx=c,this.dy=l,this.dz=d,this.tileX=u,this.tileY=h,this.size=f,this.alpha=1,p!==void 0&&(this.delay=p),this.targetX=g,this.targetY=w,this.targetZ=b,this.expirationTimer=100,y!==void 0&&(this.expirationTimer=y)}};r(is,"shotgun",(t,i,s,a,n,c,l)=>{for(let d=0;d<4;d++)t.particles.push(new is(t,i,s,0,O.rand()*.5+.3,0,0,0,c,l,0))}),r(is,"spawnCluster",(t,i,s,a,n)=>{for(let c=Math.floor(O.rand()*3);c<5;c++)t.particles.push(new is(t,i+O.rand()*.05-.025,s+O.rand()*.05-.025,O.rand()*.5,.0625*(c+8),.025*(O.rand()*2-1),.025*(O.rand()*2-1),.2*(O.rand()-1),a,n,[2,1,0,1,2,2,2][c]))});let Ce=is;class na extends yi{constructor(t,i,s,a){super();r(this,"room");r(this,"xp");r(this,"x");r(this,"y");r(this,"alpha",.25);r(this,"color");r(this,"outlineColor");r(this,"frame",0);r(this,"xoffset",0);r(this,"getXoffset",()=>{if(this.room.particles.length>0){let t=this.room.particles.filter(i=>i instanceof na);if(t.length%3===0)return .5;if(t.length%3===1)return 0;if(t.length%3===2)return .25}});r(this,"drawTopLayer",t=>{if(m.ctx.save(),this.dead){m.ctx.restore();return}this.frame>15&&(this.alpha-=.005*t),this.y-=.03*t,this.frame+=t,m.measureText(this.xp.toString()).width,this.alpha<=.002&&(this.alpha=0,this.dead=!0),m.ctx.globalAlpha=this.alpha;const i=m.measureText(`+${this.xp}xp`).width/2;m.ctx.fillStyle=this.color,m.fillText(`+${this.xp} xp`,(this.x+.4+this.xoffset)*x.TILESIZE-i,(this.y-.75)*x.TILESIZE),m.ctx.globalAlpha=1,m.ctx.restore()});this.room=t,this.xp=a,this.x=i,this.y=s,this.color="yellow",this.outlineColor=x.OUTLINE,this.xoffset=0}}var gt=(o=>(o[o.ENEMY=0]="ENEMY",o[o.FRIENDLY=1]="FRIENDLY",o[o.RESOURCE=2]="RESOURCE",o[o.PROP=3]="PROP",o[o.CHEST=4]="CHEST",o))(gt||{});class mt extends xi{constructor(t,i,s,a){super();r(this,"globalId");r(this,"room");r(this,"x");r(this,"y");r(this,"w");r(this,"h");r(this,"direction");r(this,"drawX");r(this,"drawY");r(this,"dead");r(this,"game");r(this,"health");r(this,"maxHealth");r(this,"defaultMaxHealth");r(this,"tileX");r(this,"tileY");r(this,"hasShadow");r(this,"skipNextTurns");r(this,"destroyable");r(this,"pushable");r(this,"chainPushable");r(this,"interactable");r(this,"deathParticleColor");r(this,"healthBar");r(this,"drop");r(this,"sleepingZFrame",0);r(this,"alertTicks");r(this,"exclamationFrame");r(this,"lastX");r(this,"lastY");r(this,"hitBy");r(this,"crushX");r(this,"crushY");r(this,"crushVertical");r(this,"crushed");r(this,"rumbling");r(this,"animationSpeed");r(this,"drawYOffset");r(this,"name");r(this,"orthogonalAttack");r(this,"diagonalAttack");r(this,"forwardOnlyAttack");r(this,"attackRange");r(this,"diagonalAttackRange");r(this,"lightSource");r(this,"drawMoveSpeed");r(this,"unconscious");r(this,"hitWarnings");r(this,"imageParticleX",0);r(this,"imageParticleY",26);r(this,"dropChance",1);r(this,"isEnemy");r(this,"shielded");r(this,"buffed");r(this,"buffedBefore");r(this,"frame");r(this,"shield");r(this,"shieldedBefore");r(this,"shadeMultiplier",1);r(this,"hurting");r(this,"hurtFrame");r(this,"softShadeColor");r(this,"shadeColor");r(this,"dying");r(this,"dyingFrame");r(this,"alpha");r(this,"cloned");r(this,"hasBloom");r(this,"bloomColor","#FFFFFF");r(this,"bloomAlpha",1);r(this,"softBloomAlpha",1);r(this,"bloomSize",1);r(this,"bloomOffsetY",0);r(this,"target");r(this,"moving");r(this,"dropTable");r(this,"drops");r(this,"opaque",!1);r(this,"opacity",0);r(this,"hasHitParticles",!0);r(this,"hasDamageNumbers",!0);r(this,"armored",!1);r(this,"justHurt",!1);r(this,"stunned",!1);r(this,"collidable",!0);r(this,"canDestroyOthers",!1);r(this,"canCrushOthers",!1);r(this,"beamIds",[]);r(this,"_imageParticleTiles");r(this,"hitSound");r(this,"hoverText",()=>this.name);r(this,"applyShield",(t=1,i=!1)=>{(!this.shieldedBefore||i)&&(this.shield=new yn(this,this.x,this.y,t),this.shielded=!0,this.shieldedBefore=!0,i||(this.health+=t,this.maxHealth=this.defaultMaxHealth+t),this.shadeColor="purple",this.shadeMultiplier=.5,this.hasBloom=!0,this.bloomColor="#2E0854",this.bloomAlpha=1)});r(this,"removeShield",()=>{this.shield&&(this.health-=this.shield.health,this.maxHealth-=this.shield.health,this.shield.remove(),this.shadeColor=this.room.shadeColor,this.shadeMultiplier=1,this.hasBloom=!1,this.bloomAlpha=0)});r(this,"applyBuff",()=>{this.buffed=!0,this.buffedBefore=!0,this.shadeColor="cyan",this.shadeMultiplier=.5,this.hasBloom=!0,this.bloomColor="#00FFFF",this.bloomAlpha=.5,this.lightSource=Xe.newLightSource(this.x+.5,this.y+.5,[0,40,40],3.5,20),this.addLightSource(this.lightSource),this.room.updateLighting()});r(this,"removeBuff",()=>{let t=this.room.projectiles.filter(i=>i instanceof de&&i.parent===this);t&&t.forEach(i=>{i.dead=!0}),this.shadeColor=this.room.shadeColor,this.shadeMultiplier=1,this.hasBloom=!1,this.bloomAlpha=0,this.removeLightSource(this.lightSource),this.lightSource=null,this.room.updateLighting()});r(this,"getDrop",(t=[],i=!1)=>{if(this.cloned)return;const s=this.dropTable&&this.dropTable.length>0?this.dropTable:t;Wa.getDrop(this,s,i,3),this.drop instanceof Et&&this.type===0&&(this.drop.durability=Math.floor(O.rand()*.31*this.drop.durabilityMax),this.drop.durabilityMax)});r(this,"addLightSource",t=>{this.cloned||this.room.lightSources.push(t)});r(this,"removeLightSource",t=>{this.room.lightSources=this.room.lightSources.filter(i=>i!==t),this.room.updateLighting()});r(this,"addBeamId",t=>{this.beamIds.push(t)});r(this,"removeBeamId",t=>{this.beamIds=this.beamIds.filter(i=>i!==t)});r(this,"behavior",()=>{});r(this,"hit",()=>0);r(this,"hurtCallback",()=>{});r(this,"pointIn",(t,i)=>t>=this.x&&t<this.x+this.w&&i>=this.y&&i<this.y+this.h);r(this,"createDamageNumber",(t,i="none")=>{let s="red",a=x.OUTLINE;i==="poison"&&(s="green"),i==="blood"&&(s="#8B0000",a="red"),i==="heal"&&(s="#B8A4FF",a=x.OUTLINE),this.room.particles.push(new oo(this.room,this.x,this.y,t,s,a))});r(this,"updateDrawXY",t=>{this.updateHurtFrame(t),this.animateDying(t),this.updateShadeColor(t),this.doneMoving()||(this.drawX*=this.drawMoveSpeed**t,this.drawY*=this.drawMoveSpeed**t,this.drawX=Math.abs(this.drawX)<.01?0:this.drawX,this.drawY=Math.abs(this.drawY)<.01?0:this.drawY)});r(this,"setDrawXY",(t,i)=>{this.drawX+=this.x-t,this.drawY+=this.y-i});r(this,"tryMove",(t,i,s=!0)=>{const a=this.canDestroyOthers;let n=(u,h)=>u>=t&&u<t+this.w&&h>=i&&h<i+this.h,c=u=>{let h=!0;if((u.x>=t+this.w||u.x+u.w<=t)&&(h=!1),(u.y>=i+this.h||u.y+u.h<=i)&&(h=!1),a&&u.destroyable&&u.w<=1&&u.h<=1&&h===!0){if(u.hurt(this,u.health),!this.canCrushOthers){const f=this.closestTile(u);this.drawX+=1*(f.x-u.x),this.drawY+=1*(f.y-u.y)}this.game.shakeScreen(5*this.drawX,5*this.drawY),h=!this.canCrushOthers}return h},l=!1;for(const u of this.room.entities)u!==this&&c(u)&&s&&(l=!0);if(l)return;for(const u in this.game.players)if(n(this.game.players[u].x,this.game.players[u].y))return;let d=[];for(let u=0;u<this.w;u++)for(let h=0;h<this.h;h++)if(!this.room.roomArray[t+u][i+h].isSolid()&&!(this.room.roomArray[t+u][i+h]instanceof ot)&&!(this.room.roomArray[t+u][i+h]instanceof wt))d.push(this.room.roomArray[t+u][i+h]);else return;for(let u of d)u.onCollideEnemy(this);this.x=t,this.y=i,this.bigEnemyShake()});r(this,"bigEnemyShake",()=>{(this.w>1||this.h>1)&&setTimeout(()=>{this.game.shakeScreen(0*this.drawX,5)},300)});r(this,"getPlayer",()=>{let i=138291380921,s=null;for(const a in this.game.players)if(this.game.rooms[this.game.players[a].levelID]===this.room){let n=this.playerDistance(this.game.players[a]);n<i&&(i=n,s=this.game.players[a])}return i===138291380921?!1:s});r(this,"onHurt",(t=1,i="none")=>{});r(this,"hurt",(t,i,s="none")=>{this.handleEnemyCase(t);let a=0;this.shielded&&(a=this.shield.health,a>0&&this.shield.hurt(i)),this.armored&&this.health===this.defaultMaxHealth&&H.playParry(),this.health-=i,this.onHurt(i,s),this.startHurting(),this.hasDamageNumbers&&this.createDamageNumber(i,s),this.playHitSound(),this.healthBar.hurt(),this.isEnemy&&t&&ht.emit(xt.DAMAGE_DONE,{amount:i}),(s==="none"||this.health<=0||!this.isEnemy)&&this.createHitParticles(),this.health<=0?(this.kill(),this.bloomAlpha=0):this.hurtCallback()});r(this,"wander",()=>{const t=this.x,i=this.y;for(let s=0;s<4;s++){const a=[E.UP,E.DOWN,E.LEFT,E.RIGHT],n=a[Math.floor(O.rand()*a.length)];let c=this.x,l=this.y;switch(n){case E.UP:l=this.y-1;break;case E.DOWN:l=this.y+1;break;case E.LEFT:c=this.x-1;break;case E.RIGHT:c=this.x+1;break}if(this.tryMove(c,l),this.setDrawXY(t,i),this.x!==t||this.y!==i){this.direction=n,this.setDrawXY(c,l);break}}});r(this,"runAway",()=>{const t=this.getPlayer();if(!t){this.wander();return}if(Q.distance(this.x,this.y,t.x,t.y)>10){this.wander();return}const s=this.x,a=this.y,n=[{x:this.x-1,y:this.y},{x:this.x+1,y:this.y},{x:this.x,y:this.y-1},{x:this.x,y:this.y+1}].map(h=>({position:h,distance:Q.distance(t.x,t.y,h.x,h.y)}));n.sort((h,f)=>f.distance-h.distance);const l=O.rand()<.3&&n.length>1?n[1].position:n[0].position,d=l.x,u=l.y;if(this.tryMove(d,u),this.setDrawXY(s,a),this.x!==s||this.y!==a){const h=this.x-s,f=this.y-a;h>0?this.direction=E.RIGHT:h<0?this.direction=E.LEFT:f>0?this.direction=E.DOWN:f<0&&(this.direction=E.UP),this.setDrawXY(d,u)}else this.wander()});r(this,"startHurting",()=>{this.hurting=!0,this.hurtFrame+=15,this.shadeColor="#FF0000",this.shadeMultiplier=1.5});r(this,"stopHurting",()=>{this.hurting=!1,this.hurtFrame=0,this.shadeColor="#000000"});r(this,"interact",t=>{});r(this,"handleEnemyCase",t=>{});r(this,"playHitSound",()=>{this.hitSound&&H.delayPlay(this.hitSound,50)});r(this,"createHitParticles",(t,i)=>{this.cloned||this.hasHitParticles&&(t||(t=this.imageParticleX),i||(i=this.imageParticleY),Ce.spawnCluster(this.room,this.x+.5,this.y+.5,t,i))});r(this,"dropLoot",()=>{let t,i;if(this.crushed?(t=this.lastX,i=this.lastY):(t=this.x,i=this.y),this.drops.length===0&&this.isEnemy&&this.drops.push(new ct(this.room,this.x,this.y)),this.drops.length>0){const s=[];for(let c=0;c<this.w;c++)for(let l=0;l<this.h;l++){const d=t+c,u=i+l;this.room.roomArray[d]&&this.room.roomArray[d][u]&&!this.room.roomArray[d][u].isSolid()&&s.push({x:d,y:u})}s.length===0&&this.room.roomArray[t]&&this.room.roomArray[t][i]&&!this.room.roomArray[t][i].isSolid()&&s.push({x:t,y:i});const a=new Set,n=s.length>0?Math.floor(O.rand()*s.length):0;this.drops.forEach((c,l)=>{if(c.level=this.room,s.length>0){const d=s[(n+l)%s.length];c.x=d.x,c.y=d.y,a.add(`${d.x},${d.y}`)}else this.room.roomArray[t]&&this.room.roomArray[t][i]&&!this.room.roomArray[t][i].isSolid()&&(c.x=t,c.y=i,a.add(`${t},${i}`));this.room.items.push(c),c.onDrop(),this.name!=="chest"&&c.autoPickup()}),this.isEnemy&&(this.w>1||this.h>1)&&s.length>0&&s.filter(l=>!a.has(`${l.x},${l.y}`)).forEach(l=>{const d=new ct(this.room,l.x,l.y);d.level=this.room,this.room.items.push(d),d.onDrop(),this.name!=="chest"&&d.autoPickup()})}});r(this,"kill",t=>{if(this.dead=!0,this.cloned)return;this.emitEnemyKilled(),this.dropLoot();const i=this.clone();this.room.deadEntities.push(i),this.removeLightSource(this.lightSource),this.uniqueKillBehavior()});r(this,"uniqueKillBehavior",()=>{});r(this,"updateHurtFrame",t=>{this.hurting&&(this.hurtFrame-=t,this.hurtFrame<0&&this.stopHurting())});r(this,"shadeAmount",()=>{if(x.SMOOTH_LIGHTING&&!x.SHADE_INLINE_IN_ENTITY_LAYER||!this.room.softVis[this.x])return 0;let t=this.room.softVis[this.x][this.y]*1;return this.shadeMultiplier>1?Math.min(1,t):t});r(this,"updateShadeColor",t=>{this.shadeMultiplier>1&&(this.shadeMultiplier-=.01*t),this.shadeMultiplier<1&&(this.shadeMultiplier=1);let i=!1;const s=v=>{const k=parseInt(v.slice(1),16),D=k>>16&255,N=k>>8&255,U=k&255;return[D,N,U]},a=v=>{const[k,D,N]=v;return"#"+((1<<24)+(k<<16)+(D<<8)+N).toString(16).slice(1).toUpperCase()},[n,c,l]=s(this.softShadeColor),[d,u,h]=s(this.shadeColor);let f=n-d,p=c-u,y=l-h,g=!1,w=!1,b=!1;if(Math.abs(f)>1&&(g=!0),Math.abs(p)>1&&(w=!0),Math.abs(y)>1&&(b=!0),!g&&!w&&!b)return this.softShadeColor;let T=[n,c,l];return g&&(f*=.1*t,T[0]=this.room.clamp(Math.round(n-f),0,255),i=!0),w&&(p*=.1*t,T[1]=this.room.clamp(Math.round(c-p),0,255),i=!0),b&&(y*=.1*t,T[2]=this.room.clamp(Math.round(l-y),0,255),i=!0),i&&(this.softShadeColor=a(T)),this.softShadeColor});r(this,"emitEnemyKilled",()=>{let t=1.5**this.room.depth;console.log(t);let i=1;this.isEnemy&&(i=5);const s=Math.ceil(this.defaultMaxHealth*i*t);!this.isEnemy||(ht.emit(xt.ENEMY_KILLED,{enemyId:this.name,xp:s}),!this.getPlayer())||setTimeout(()=>{this.room.particles.push(new na(this.room,this.x,this.y,s))},350)});r(this,"doneMoving",()=>{let t=.01;return Math.abs(this.drawX)<t&&Math.abs(this.drawY)<t});r(this,"nearestPlayer",()=>{let i=138291380921,s=null;for(const a in this.game.players)if(this.game.rooms[this.game.players[a].levelID]===this.room){let n=this.playerDistance(this.game.players[a]);n<i&&(i=n,s=this.game.players[a])}return i===138291380921?!1:[i,s]});r(this,"playerDistance",t=>Math.max(Math.abs(this.x-t.x),Math.abs(this.y-t.y)));r(this,"closestTile",t=>{let i={x:0,y:0},s=1e6;for(let a=0;a<this.w;a++)for(let n=0;n<this.h;n++){let c=Math.abs(t.x-(this.x+a))+Math.abs(t.y-(this.y+n));c<s&&(s=c,i={x:this.x+a,y:this.y+n})}return i});r(this,"facePlayer",t=>{if(this.w===1&&this.h===1){const l=this.x+.5,d=this.y+.5;let u=t.x-l,h=t.y-d;Math.abs(u)===Math.abs(h)||(Math.abs(u)>Math.abs(h)?(u>0&&(this.direction=E.RIGHT),u<0&&(this.direction=E.LEFT)):(h>0&&(this.direction=E.DOWN),h<0&&(this.direction=E.UP)));return}const i=t.y>=this.y&&t.y<this.y+this.h,s=t.x>=this.x&&t.x<this.x+this.w;if(i&&s)return;const a=this.closestTile(t);let n=t.x-a.x,c=t.y-a.y;Math.abs(n)>Math.abs(c)?(n>0&&(this.direction=E.RIGHT),n<0&&(this.direction=E.LEFT)):(c>0&&(this.direction=E.DOWN),c<0&&(this.direction=E.UP))});r(this,"animateDying",t=>{this.cloned&&(this.dyingFrame-=t/3,this.alpha=Math.max(0,this.alpha-t/50),this.dyingFrame<=0&&(this.dead=!0,this.dying=!1,this.uniqueKillBehavior(),this.room.clearDeadStuff()))});r(this,"draw",t=>{this.dead||(m.ctx.save(),m.ctx.globalAlpha=this.alpha,this.updateDrawXY(t),this.hasShadow&&this.drawShadow(t),m.drawMob(this.tileX,this.tileY+this.direction*2,1,2,this.x-this.drawX,this.y-this.drawYOffset-this.drawY,1,2,this.shadeColor,this.shadeAmount()),m.ctx.globalAlpha=1)});r(this,"drawShadow",t=>{this.cloned||Di.draw(this.x-this.drawX,this.y-this.drawY,this.w,this.h)});r(this,"tick",()=>{this.behavior(),this.shielded&&this.shield.updateLightSourcePos()});r(this,"emitEntityData",()=>{ht.emit("EntityData",{name:this.name,location:{x:this.x,y:this.y}})});r(this,"drawTopLayer",t=>{this.drawableY=this.y-this.drawY,this.healthBar.draw(t,this.health,this.maxHealth,this.x,this.y,!0)});r(this,"drawSleepingZs",(t,i=0,s=0)=>{this.sleepingZFrame+=t;let a=2,n=this.sleepingZFrame*.01;n-=Math.floor(n);for(let c=a-1;c>=0;c--){let l=(n+c)*7,d=Math.min(1-(n+c)/a,2*(n+c)/a),u=0;c===0&&(u=1),n>=.33&&n<.66&&(u=c),n>=.33&&n<.66&&(u=c);let h=m.measureText("Z").width;m.ctx.globalAlpha=d,m.fillTextOutline("Z",(this.x+.5)*x.TILESIZE-h/2+u+i,(this.y-.6)*x.TILESIZE-l+s,x.OUTLINE,"white"),m.ctx.globalAlpha=1}});r(this,"drawExclamation",(t,i=0,s=0)=>{this.exclamationFrame+=t;let a=0,n=[0,-1,-2,-3,-5,-7,-4];this.exclamationFrame>n.length?a=n[n.length-1]:a=n[this.exclamationFrame];let c=m.measureText("!").width;m.ctx.globalAlpha=1,a!==!1&&m.fillTextOutline("!",(this.x+.5)*x.TILESIZE-c/2+i,(this.y-.75)*x.TILESIZE+a+s,x.OUTLINE,x.WARNING_RED)});r(this,"crush",()=>{this.crushed=!0;let t;for(let i in this.game.players)t=this.game.players[i];this.x==t.x&&(this.crushVertical=!0),this.kill()});r(this,"crushAnim",t=>{this.crushVertical&&this.crushY>=0?this.crushY*=.95:this.crushX>=0&&(this.crushX*=.95)});r(this,"rumble",(t,i,s)=>{let a={x:0,y:0};if(t){const c=Math.floor(i)%2===1?.0325:0;s===E.LEFT||s===E.RIGHT?a.y=c:(s===E.UP||s===E.DOWN||!s)&&(a.x=c),this.animationSpeed=.2}return a});r(this,"attemptProjectilePlacement",(t,i,s=!1,a=!0,n=!1)=>{for(const c of t){const l=this.x+c.x,d=this.y+c.y;if(!this.isValidProjectilePosition(l,d,s,a)){if(n)break;continue}if(this.placeProjectile(i,l,d),n)break}});r(this,"isValidProjectilePosition",(t,i,s,a)=>{if(!this.isWithinRoomBounds(t,i)||a&&!this.isPathClear(this.x,this.y,t,i)||s&&this.isEntityColliding(t,i))return!1;const n=this.room.roomArray[t][i];return n&&!n.isSolid()&&!n.isDoor});r(this,"isEntityColliding",(t,i)=>this.room.entities.some(s=>s.x===t&&s.y===i));r(this,"placeProjectile",(t,i,s,a)=>{this.room.projectiles.push(new t(this,i,s,a))});r(this,"isPathClear",(t,i,s,a)=>{var u;const n=Math.sign(s-t),c=Math.sign(a-i);let l=t,d=i;for(;l!==s||d!==a;)if(l+=n,d+=c,!this.isWithinRoomBounds(l,d)||(u=this.room.roomArray[l][d])!=null&&u.isSolid())return!1;return!0});r(this,"getLuminance",()=>this.room.roomArray[this.x][this.y]?this.room.vis[this.x][this.y]:null);r(this,"getAverageLuminance",()=>{let t=0,i=0;for(let s=this.x-2;s<=this.x+2;s++)if(this.room.roomArray[s]&&this.room.roomArray[s][this.y])for(let a=this.y-2;a<=this.y+2;a++)this.room.vis[s][a]&&(t+=this.room.vis[s][a],i++);return t/i});r(this,"getOpenTile",()=>{let t,i;do t=Math.floor(O.rand()*3+this.x-1),i=Math.floor(O.rand()*3+this.y-1);while(t===this.x&&i===this.y||this.room.roomArray[t][i].isSolid()||this.room.roomArray[t][i]instanceof wt||this.room.roomArray[t][i]instanceof ot||this.room.roomArray[t][i]instanceof et||this.room.entities.some(s=>s.x===t&&s.y===i));return!t||!i?{x:this.x,y:this.y}:{x:t,y:i}});r(this,"makeBigHitWarnings",()=>{switch(this.direction){case E.LEFT:this.makeHitWarnings(this.x,this.y),this.makeHitWarnings(this.x,this.y+1);break;case E.RIGHT:this.makeHitWarnings(this.x+1,this.y),this.makeHitWarnings(this.x+1,this.y+1);break;case E.UP:this.makeHitWarnings(this.x,this.y),this.makeHitWarnings(this.x+1,this.y);break;case E.DOWN:this.makeHitWarnings(this.x,this.y+1),this.makeHitWarnings(this.x+1,this.y+1);break}});r(this,"makeHitWarnings",(t=this.x,i=this.y,s=!1,a=null)=>{if(this.unconscious)return;const n=this.getPlayer(),l=n.x===t&&n.y===i?0:.45;let d=this.orthogonalAttack,u=this.diagonalAttack,h=this.forwardOnlyAttack;const f=this.direction,p=this.attackRange,y=this.diagonalAttackRange;switch(a){case"diagonal":u=!0,d=!1,h=!1;break;case"orthogonal":d=!0,u=!1,h=!1;break;case"forward":h=!0,d=!0,u=!1;break}const g=(D,N)=>(D?[[-1,0],[1,0],[0,-1],[0,1]]:[[-1,-1],[1,1],[1,-1],[-1,1]]).flatMap(([Z,j])=>Array.from({length:N},(V,J)=>[(J+1)*Z,(J+1)*j])),w={[E.LEFT]:[-1,0],[E.RIGHT]:[1,0],[E.UP]:[0,-1],[E.DOWN]:[0,1]};let b=[];if(h){const[D,N]=w[f];b=Array.from({length:p},(U,Z)=>[(Z+1)*D,(Z+1)*N])}else d&&b.push(...g(!0,p)),u&&b.push(...g(!1,y));const T=b.map(([D,N])=>({x:D,y:N,distance:Q.distance(D,N,n.x-t,n.y-i)})).sort((D,N)=>D.distance-N.distance),v=Math.ceil(T.length*(1-l));T.slice(0,v).forEach(({x:D,y:N})=>{const U=t+D,Z=i+N;if(this.isWithinRoomBounds(U,Z)){const j=new Ht(this.game,U,Z,t,i,!0,s,this);this.room.hitwarnings.push(j)}})});r(this,"isWithinRoomBounds",(t,i)=>{const s=t>=this.room.roomX&&t<this.room.roomX+this.room.width,a=i>=this.room.roomY&&i<this.room.roomY+this.room.height,n=this.room.roomArray[t]&&this.room.roomArray[t][i]!==void 0;return s&&a&&n});this.globalId=se.generate("EN"),this.constructor.__isCloning?this.cloned=!0:this.cloned=!1,this.room=t,this.x=s,this.y=a,this.w=1,this.h=1,this.game=i,this.drawX=0,this.drawY=0,this.health=1,this.maxHealth=1,this.defaultMaxHealth=1,this.tileX=0,this.tileY=0,this.hasShadow=!0,this.skipNextTurns=0,this.direction=E.DOWN,this.destroyable=!0,this.pushable=!1,this.chainPushable=!0,this.interactable=!1,this.healthBar=new gn,this.alertTicks=0,this.exclamationFrame=0,this.lastX=s,this.lastY=a,this.hitBy=null,this.crushX=1,this.crushY=1,this.crushVertical=!1,this.crushed=!1,this.rumbling=!1,this.animationSpeed=.1,this.drawYOffset=1.175,this.hitWarnings=[],this.orthogonalAttack=!1,this.diagonalAttack=!1,this.forwardOnlyAttack=!1,this.attackRange=1,this.diagonalAttackRange=1,this.drawMoveSpeed=.9,this.unconscious=!1,this.dropChance=.02,this.isEnemy=!1,this.shielded=!1,this.shield=null,this.frame=0,this.shieldedBefore=!1,this._imageParticleTiles={x:0,y:0},this.hitSound=null,this.shadeColor=this.room.shadeColor,this.hurting=!1,this.hurtFrame=0,this.softShadeColor="#000000",this.dying=!1,this.dyingFrame=30,this.alpha=1,this.dead=!1,this.hasBloom=!1,this.bloomColor="#FFFFFF",this.moving=!1,this.dropTable=[],this.drops=[],this.canDestroyOthers=!1,this.canCrushOthers=!1,this.beamIds=[],this.drop&&this.drops.push(this.drop)}static add(t,i,s,a,...n){if(!t.roomArray[s]||!t.roomArray[s][a])return console.warn(`Cannot add entity: tile at (${s}, ${a}) does not exist`),null;if(t.roomArray[s][a].isSolid())return console.warn(`Cannot add entity: tile at (${s}, ${a}) is solid`),null;const c=new this(t,i,s,a,...n);return t.entities.push(c),c}static cloneEntity(t){t.constructor.__isCloning=!0;const i=new t.constructor(t.room,t.game,t.x,t.y);return delete t.constructor.__isCloning,Object.assign(i,{cloned:!0,dead:!1,dying:!0,drawableY:t.drawableY,tileX:t.tileX,tileY:t.tileY,frame:t.frame,direction:t.direction,drawX:t.drawX,drawY:t.drawY,alpha:t.alpha,shadeColor:t.shadeColor,shadeMultiplier:t.shadeMultiplier,softShadeColor:t.softShadeColor,hasBloom:t.hasBloom,bloomColor:t.bloomColor,bloomAlpha:1,softBloomAlpha:1,dyingFrame:30}),t.room.deadEntities.push(i),i}clone(){const t=mt.cloneEntity(this);return t.dead=!1,t.dying=!0,t}get imageParticleTiles(){return this._imageParticleTiles}get type(){return 0}calculateProjectileOffsets(t,i,s){const a=t-this.x,n=i-this.y;let c=[];const l=a!==0?Math.sign(a):0,d=n!==0?Math.sign(n):0;for(let u=1;u<=s;u++)c.push({x:u*l,y:u*d});return c}}class Ge extends mt{constructor(t,i,s,a){super(t,i,s,a);r(this,"draw",t=>{this.dead||(m.ctx.save(),m.ctx.globalAlpha=this.alpha,this.dead||(this.hasShadow&&this.drawShadow(t),this.updateDrawXY(t),m.drawObj(this.tileX,this.tileY,1,2,this.x-this.drawX,this.y-this.drawYOffset-this.drawY,1,2,this.room.shadeColor,this.shadeAmount())),m.ctx.restore())});r(this,"drawTopLayer",t=>{this.drawableY=this.y});this.room=t,this.health=1,this.maxHealth=1,this.tileX=0,this.tileY=0,this.hasShadow=!0,this.pushable=!0,this.name="crate",this.imageParticleX=3,this.imageParticleY=26,O.rand()<.1?this.drops.push(new ei(this.room,this.x,this.y,10)):this.drops.push(new ct(this.room,this.x,this.y))}get type(){return gt.PROP}}class We extends mt{constructor(t,i,s,a){super(t,i,s,a);r(this,"draw",t=>{this.dead||(m.ctx.save(),m.ctx.globalAlpha=this.alpha,this.dead||(this.hasShadow&&this.drawShadow(t),this.updateDrawXY(t),m.drawObj(this.tileX,this.tileY,1,2,this.x-this.drawX,this.y-this.drawYOffset-this.drawY,1,2,this.room.shadeColor,this.shadeAmount())),m.ctx.restore())});r(this,"drawTopLayer",t=>{this.drawableY=this.y});this.room=t,this.health=1,this.tileX=1,this.tileY=0,this.hasShadow=!0,this.pushable=!0,this.name="barrel",this.imageParticleX=3,this.imageParticleY=25,O.rand()<.1?this.drops.push(new ei(this.room,this.x,this.y)):this.drops.push(new ct(this.room,this.x,this.y))}get type(){return gt.PROP}}class rt extends oe{constructor(t,i,s,a){super(t,i,s);r(this,"on");r(this,"tickCount");r(this,"frame");r(this,"t");r(this,"tick",()=>{if(this.tickCount++,this.tickCount>=4&&(this.tickCount=0),this.on=this.tickCount===0,this.on)for(const t in this.room.game.players)this.room===this.room.game.rooms[this.room.game.players[t].levelID]&&this.room.game.players[t].x===this.x&&this.room.game.players[t].y===this.y&&this.room.game.players[t].hurt(.5,"spike trap");this.tickCount===3&&this.room.hitwarnings.push(new Ht(this.room.game,this.x,this.y,this.x,this.y,!1))});r(this,"tickEnd",()=>{if(this.on)for(const t of this.room.entities)t.x===this.x&&t.y===this.y&&t.hurt(null,1)});r(this,"onCollideEnemy",t=>{this.on&&!(t instanceof Ge||t instanceof We)&&t.hurt(null,1)});r(this,"draw",t=>{m.drawTile(1,this.skin,1,1,this.x,this.y,1,1,this.room.shadeColor,this.shadeAmount());let i=0;this.t+=t,!this.on&&this.tickCount===3&&(Math.floor(this.t)%4===1&&(i=.0325),Math.floor(this.t)%4===3&&(i=-.0325));let s=[0,1,2,3,3,4,2,0],a=6+s[Math.floor(this.frame)];(this.tickCount===1||this.tickCount===0&&s[Math.floor(this.frame)]===0)&&(a=5),m.drawObj(a,1,1,1,this.x+i,this.y,1,1,this.room.shadeColor,this.shadeAmount()),m.drawObj(a,0,1,1,this.x+i,this.y-1,1,1,this.room.shadeColor,this.shadeAmount(0,0,!1)),this.on&&this.frame<s.length-1&&(s[Math.floor(this.frame)]<3?this.frame+=.4*t:this.frame+=.2*t),this.on||(this.frame=0)});a?this.tickCount=a:this.tickCount=0,this.on=!1,this.frame=0,this.t=0,this.name="spike trap"}}class bh extends Vi{constructor(t,i,s){super(t,i,s);r(this,"frame");r(this,"parent");r(this,"tileX");r(this,"tileY");r(this,"ticks",0);r(this,"remove",()=>{this.parent.room.projectiles=this.parent.room.projectiles.filter(t=>t!==this)});r(this,"tick",()=>{(this.ticks>0||this.parent.dead===!0)&&(this.remove(),this.parent.unconscious=!1,this.parent.justHurt=!1),this.ticks++});r(this,"drawTopLayer",t=>{this.dead||(m.ctx.save(),m.ctx.globalCompositeOperation="screen",m.ctx.globalAlpha=.5,this.frame+=.2*t,this.frame>4&&(this.frame=0),m.drawFX(19+Math.floor(this.frame),0,1,1,this.parent.x-this.parent.drawX,this.parent.y-this.parent.drawY-1.4,1,1),m.ctx.restore())});this.frame=0,this.parent.room.projectiles.push(this)}}const Ys=class Ys extends mt{constructor(t,i,s,a){super(t,i,s,a);r(this,"seenPlayer");r(this,"heardPlayer");r(this,"frame");r(this,"ticks");r(this,"aggro");r(this,"targetPlayer");r(this,"drop");r(this,"status");r(this,"jumpY");r(this,"jumpHeight");r(this,"effectStartTick");r(this,"startTick");r(this,"poisonHitCount");r(this,"bleedHitCount");r(this,"alertRange");r(this,"justHurt",!1);r(this,"orthogonalAttack");r(this,"diagonalAttack");r(this,"buffed");r(this,"buffedBefore");r(this,"baseDamage");r(this,"hit",()=>this.damage);r(this,"alertNearbyEnemies",()=>{if(!this.seenPlayer)return;const t=this.nearestPlayer();if(t===!1)return;const i=this.room.entities.filter(s=>s instanceof Ys);for(const s of i){if(s===this)continue;Q.distance(this.x,this.y,s.x,s.y)<=G.BASE_ENEMY_ALERT_NEARBY_RANGE&&s instanceof Ys&&!s.seenPlayer&&(s.handleSeenPlayer(t[1],!1),s.alertTicks=2)}});r(this,"handleEnemyCase",t=>{t&&t&&(this.aggro=!0,this.targetPlayer=t,t===this.game.players[this.game.localPlayerID]&&(this.alertTicks=2))});r(this,"poison",()=>{this.status.poison.active||(this.status.poison={active:!0,hitCount:0,startTick:this.ticks,effectTick:this.ticks%3},this.shadeColor="#00FF00")});r(this,"bleed",()=>{this.status.bleed.active||(this.status.bleed={active:!0,hitCount:0,startTick:this.ticks,effectTick:this.ticks%1})});r(this,"tickPoison",()=>{this.status.poison.active&&this.targetPlayer&&this.ticks%3===this.status.poison.effectTick&&this.ticks!==this.status.poison.startTick&&this.health>=1&&(this.hurt(this.targetPlayer,1,"poison"),this.shadeColor="#00FF00")});r(this,"tickBleed",()=>{this.status.bleed.active&&this.targetPlayer&&this.ticks%1===this.status.bleed.effectTick&&this.ticks!==this.status.bleed.startTick&&(this.hurt(this.targetPlayer,.5,"blood"),this.shadeColor="#FF0000",this.status.bleed.hitCount++,this.status.bleed.hitCount>=4&&(this.status.bleed={active:!1,hitCount:0,startTick:0,effectTick:0}))});r(this,"tick",()=>{this.tickPoison(),this.tickBleed(),this.behavior(),(this.x!==this.lastX||this.y!==this.lastY)&&this.emitEntityData(),this.shielded&&this.shield.updateLightSourcePos(),this.alertNearbyEnemies()});r(this,"lookForPlayer",(t=!0)=>{if(this.seenPlayer)return;const i=this.nearestPlayer();if(i===!1)return;const[s,a]=i;s>this.alertRange||(this.handleSeenPlayer(a,t),this.makeHitWarnings())});r(this,"handleSeenPlayer",(t,i=!0)=>{this.targetPlayer=t,i&&this.facePlayer(t),this.seenPlayer=!0,ht.emit("EnemySeenPlayer",{enemyType:this.constructor.name,enemyName:this.name}),t===this.game.players[this.game.localPlayerID]&&(this.alertTicks=1)});r(this,"getDisablePositions",()=>{let t=Array();for(const i of this.room.entities)i!==this&&t.push({x:i.x,y:i.y});for(let i=this.x-1;i<=this.x+1;i++)for(let s=this.y-1;s<=this.y+1;s++)this.room.roomArray[i][s]instanceof rt&&this.room.roomArray[i][s].on&&t.push({x:i,y:s});return t});r(this,"findPath",()=>{let t=Array();for(const s of this.room.entities)s!==this&&t.push({x:s.x,y:s.y});for(let s=this.x-1;s<=this.x+1;s++)for(let a=this.y-1;a<=this.y+1;a++)this.room.roomArray[s][a]instanceof rt&&this.room.roomArray[s][a].on&&t.push({x:s,y:a});let i=[];for(let s=0;s<this.room.roomX+this.room.width;s++){i[s]=[];for(let a=0;a<this.room.roomY+this.room.height;a++)this.room.roomArray[s]&&this.room.roomArray[s][a]?i[s][a]=this.room.roomArray[s][a]:i[s][a]=!1}yt.AStar.search(i,this,this.targetPlayer,t,!1,!1,!0,this.direction)});r(this,"behavior",()=>{if(this.lastX=this.x,this.lastY=this.y,!this.dead){if(this.skipNextTurns>0){this.skipNextTurns--;return}if(this.ticks++,!this.seenPlayer)this.lookForPlayer();else if(this.seenPlayer){if(this.room.playerTicked===this.targetPlayer){this.alertTicks=Math.max(0,this.alertTicks-1);let i=this.x,s=this.y,a=Array();for(const l of this.room.entities)l!==this&&a.push({x:l.x,y:l.y});for(let l=this.x-1;l<=this.x+1;l++)for(let d=this.y-1;d<=this.y+1;d++)this.room.roomArray[l][d]instanceof rt&&this.room.roomArray[l][d].on&&a.push({x:l,y:d});let n=[];for(let l=0;l<this.room.roomX+this.room.width;l++){n[l]=[];for(let d=0;d<this.room.roomY+this.room.height;d++)this.room.roomArray[l]&&this.room.roomArray[l][d]?n[l][d]=this.room.roomArray[l][d]:n[l][d]=!1}let c=yt.AStar.search(n,this,this.targetPlayer,a,!1,!1,!0,this.direction);if(c.length>0){let l=c[0].pos.x,d=c[0].pos.y,u=this.direction,h=this.targetPlayer;if(this.facePlayer(h),l>i?this.direction=E.RIGHT:l<i?this.direction=E.LEFT:d>s?this.direction=E.DOWN:d<s&&(this.direction=E.UP),u==this.direction){for(const f in this.game.players)this.game.rooms[this.game.players[f].levelID]===this.room&&this.game.players[f].x===l&&this.game.players[f].y===d&&(this.game.players[f].hurt(this.hit(),this.name),this.drawX=.5*(this.x-this.game.players[f].x),this.drawY=.5*(this.y-this.game.players[f].y),this.game.players[f]===this.game.players[this.game.localPlayerID]&&this.game.shakeScreen(10*this.drawX,10*this.drawY));this.tryMove(l,d),this.setDrawXY(l,d),this.x>l?this.direction=E.RIGHT:this.x<l?this.direction=E.LEFT:this.y>d?this.direction=E.DOWN:this.y<d&&(this.direction=E.UP)}}this.direction==E.LEFT&&(a.push({x:this.x,y:this.y+1}),a.push({x:this.x,y:this.y-1})),this.direction==E.RIGHT&&(a.push({x:this.x,y:this.y+1}),a.push({x:this.x,y:this.y-1})),this.direction==E.DOWN&&(a.push({x:this.x+1,y:this.y}),a.push({x:this.x-1,y:this.y})),this.direction==E.UP&&(a.push({x:this.x+1,y:this.y}),a.push({x:this.x-1,y:this.y})),this.makeHitWarnings()}let t=Object.values(this.game.offlinePlayers).indexOf(this.targetPlayer)!==-1;if(!this.aggro||t){let i=this.nearestPlayer();if(i!==!1){let[s,a]=i;s<=4&&(t||s<this.playerDistance(this.targetPlayer))&&a!==this.targetPlayer&&(this.targetPlayer=a,this.facePlayer(a),a===this.game.players[this.game.localPlayerID]&&(this.alertTicks=1),this.makeHitWarnings())}}}}});r(this,"onHurt",(t=1,i="none")=>{this.health>0&&i==="none"&&(this.justHurt=!0)});r(this,"stun",()=>{this.stunned||(this.stunned=!0,this.unconscious=!0,new bh(this,this.x,this.y))});r(this,"retreat",(t,i)=>{let s=this.x-this.targetPlayer.x,a=this.y-this.targetPlayer.y,n=Math.sqrt(s*s+a*a);n>0&&(s=Math.round(s/n),a=Math.round(a/n));let c=this.x,l=this.y,d=!1;if(this.orthogonalAttack&&this.diagonalAttack)if(c=this.x+s,l=this.y+a,this.room.isTileEmpty(c,l))d=!0;else{a===0&&(a=O.rand()<.5?1:-1),s===0&&(s=O.rand()<.5?1:-1);let u=this.x-a,h=this.y+s,f=this.x+a,p=this.y-s,y=O.rand()<.5,g=y?u:f,w=y?h:p,b=y?f:u,T=y?p:h;this.room.isTileEmpty(g,w)?(c=g,l=w,d=!0):this.room.isTileEmpty(b,T)&&(c=b,l=T,d=!0)}else if(this.orthogonalAttack)c=this.x+s,l=this.y+a,this.room.isTileEmpty(c,l)&&(d=!0);else if(this.diagonalAttack){a===0&&(a=O.rand()<.5?1:-1),s===0&&(s=O.rand()<.5?1:-1);let u=this.x-a,h=this.y+s,f=this.x+a,p=this.y-s,y=O.rand()<.5,g=y?u:f,w=y?h:p,b=y?f:u,T=y?p:h;this.room.isTileEmpty(g,w)?(c=g,l=w,d=!0):this.room.isTileEmpty(b,T)&&(c=b,l=T,d=!0)}d&&(this.tryMove(c,l),this.setDrawXY(t,i)),this.justHurt=!1});r(this,"jump",t=>{let i=Math.max(Math.abs(this.drawX),Math.abs(this.drawY));this.jumpY=Math.abs(Math.sin(i*Math.PI))*this.jumpHeight,this.jumpY<.01&&(this.jumpY=0),this.jumpY>this.jumpHeight&&(this.jumpY=this.jumpHeight)});r(this,"updateDrawXY",t=>{this.updateHurtFrame(t),this.animateDying(t),this.doneMoving()||(this.drawX*=this.drawMoveSpeed**t,this.drawY*=this.drawMoveSpeed**t,this.drawX=Math.abs(this.drawX)<.01?0:this.drawX,this.drawY=Math.abs(this.drawY)<.01?0:this.drawY,this.jump(t)),this.updateShadeColor(t)});r(this,"setDrawXY",(t,i)=>{this.drawX+=this.x-t,this.drawY+=this.y-i});r(this,"teleport",()=>{var i;let t=this.findFarTile();t&&(this.drawX=t.x-this.x,this.drawY=t.y-this.y,this.x=t.x,this.y=t.y,(i=this.lightSource)==null||i.updatePosition(this.x+.5,this.y+.5),this.room.updateLighting())});r(this,"findFarTile",()=>{const t=this.room.getEmptyTiles(),i=this.getPlayer();if(!i||t.length===0)return null;const s=t.map(c=>{const l=Q.distance(c.x,c.y,i.x,i.y);return{tile:c,distance:l}});s.sort((c,l)=>l.distance-c.distance);const a=s.slice(0,Math.floor(s.length/2));if(a.length===0)return null;const n=Math.floor(O.rand()*a.length);return a[n].tile});r(this,"draw",t=>{this.dead||(this.updateDrawXY(t),this.frame+=.1*t,this.frame>=4&&(this.frame=0),this.hasShadow&&this.drawShadow(t),m.drawMob(this.tileX+Math.floor(this.frame),this.tileY+this.direction*2,1,2,this.x-this.drawX,this.y-this.drawYOffset-this.drawY-this.jumpY,1,2,this.softShadeColor,this.shadeAmount())),this.dying||(this.seenPlayer||this.drawSleepingZs(t),this.alertTicks>0&&this.drawExclamation(t))});this.drawYOffset=1.5,this.name="",this.seenPlayer=!1,this.heardPlayer=!1,this.ticks=0,this.frame=0,this.health=1,this.maxHealth=1,this.tileX=17,this.tileY=8,this.aggro=!1,this.jumpY=0,this.jumpHeight=.3,this.name="generic enemy",this.dropChance=10,this.status={poison:{active:!1,hitCount:0,startTick:0,effectTick:0},bleed:{active:!1,hitCount:0,startTick:0,effectTick:0}},this.alertRange=G.BASE_ENEMY_ALERT_RANGE,this.effectStartTick=1,this.startTick=1,this.isEnemy=!0,this.poisonHitCount=0,this.bleedHitCount=0,this.drawMoveSpeed=.85,this.justHurt=!1,this.orthogonalAttack=!1,this.diagonalAttack=!1,this.baseDamage=1}get damage(){return this.buffed?2*this.baseDamage:this.baseDamage}get lastPlayerPos(){return{x:this.targetPlayer.lastX,y:this.targetPlayer.lastY}}get type(){return gt.ENEMY}};r(Ys,"difficulty",1);let it=Ys;class Lt extends it{constructor(t,i,s,a,n){super(t,i,s,a);r(this,"ticks");r(this,"frame");r(this,"seenPlayer");r(this,"targetPlayer");r(this,"aggro");r(this,"drop");r(this,"hit",()=>this.damage);r(this,"behavior",()=>{if(this.lastX=this.x,this.lastY=this.y,!this.dead){if(this.skipNextTurns>0){this.skipNextTurns--;return}if(this.seenPlayer){if(this.seenPlayer){if(this.room.playerTicked===this.targetPlayer)if(this.alertTicks=Math.max(0,this.alertTicks-1),this.ticks++,this.ticks%2===1){this.rumbling=!0;let i=this.x,s=this.y,a=Array();for(const l of this.room.entities)l!==this&&a.push({x:l.x,y:l.y});for(let l=this.x-1;l<=this.x+1;l++)for(let d=this.y-1;d<=this.y+1;d++)this.room.roomArray[l][d]instanceof rt&&this.room.roomArray[l][d].on&&a.push({x:l,y:d});let n=[];for(let l=0;l<this.room.roomX+this.room.width;l++){n[l]=[];for(let d=0;d<this.room.roomY+this.room.height;d++)this.room.roomArray[l]&&this.room.roomArray[l][d]?n[l][d]=this.room.roomArray[l][d]:n[l][d]=!1}let c=yt.AStar.search(n,this,this.targetPlayer,a,void 0,void 0,void 0,void 0,void 0,void 0,this.lastPlayerPos);if(c.length>0){let l=!1;for(const d in this.game.players)this.game.rooms[this.game.players[d].levelID]===this.room&&this.game.players[d].x===c[0].pos.x&&this.game.players[d].y===c[0].pos.y&&(this.game.players[d].hurt(this.hit(),this.name),this.drawX=.5*(this.x-this.game.players[d].x),this.drawY=.5*(this.y-this.game.players[d].y),this.game.players[d]===this.game.players[this.game.localPlayerID]&&this.game.shakeScreen(10*this.drawX,10*this.drawY),l=!0);l||(this.tryMove(c[0].pos.x,c[0].pos.y),this.setDrawXY(i,s),this.x>i?this.direction=E.RIGHT:this.x<i?this.direction=E.LEFT:this.y>s?this.direction=E.DOWN:this.y<s&&(this.direction=E.UP))}this.rumbling=!1}else this.rumbling=!0,this.makeHitWarnings();let t=Object.values(this.game.offlinePlayers).indexOf(this.targetPlayer)!==-1;if(!this.aggro||t){let i=this.nearestPlayer();if(i!==!1){let[s,a]=i;s<=4&&(t||s<this.playerDistance(this.targetPlayer))&&a!==this.targetPlayer&&(this.targetPlayer=a,this.facePlayer(a),a===this.game.players[this.game.localPlayerID]&&(this.alertTicks=1),this.ticks%2===0&&(this.rumbling=!0,this.makeHitWarnings()))}}}}else{const t=this.nearestPlayer();if(t!==!1){let[i,s]=t;i<4&&(this.rumbling=!0,this.seenPlayer=!0,this.targetPlayer=s,this.facePlayer(s),s===this.game.players[this.game.localPlayerID]&&(this.alertTicks=1),this.makeHitWarnings())}}}});r(this,"draw",t=>{if(this.dead)return;m.ctx.save(),m.ctx.globalAlpha=this.alpha;let i=this.rumble(this.rumbling,this.frame).x;this.rumble(this.rumbling,this.frame,this.direction).y,this.dead||(this.updateDrawXY(t),this.ticks%2===0?(this.tileX=9,this.tileY=8):(this.tileX=4,this.tileY=0),this.frame+=.1*t,this.frame>=4&&(this.frame=0),this.hasShadow&&this.drawShadow(t),m.drawMob(this.tileX+(this.tileX===4?0:Math.floor(this.frame)),this.tileY+this.direction*2,1,2,this.x-this.drawX+i,this.y-this.drawYOffset-this.drawY+(this.tileX===4?.1875:0),1,2,this.softShadeColor,this.shadeAmount())),this.cloned||(this.seenPlayer||this.drawSleepingZs(t),this.alertTicks>0&&this.drawExclamation(t)),m.ctx.restore()});this.ticks=0,this.frame=0,this.health=2,this.maxHealth=2,this.defaultMaxHealth=2,this.tileX=9,this.tileY=8,this.seenPlayer=!1,this.aggro=!1,this.deathParticleColor="#ffffff",this.lastX=this.x,this.lastY=this.y,this.name="burrow knight",this.orthogonalAttack=!0,this.imageParticleX=3,this.imageParticleY=29,n&&(this.drop=n),this.getDrop(["weapon","warhammer","equipment","consumable","tool","coin"])}}r(Lt,"difficulty",2),r(Lt,"tileX",9),r(Lt,"tileY",8);class Ot extends mt{constructor(t,i,s,a){super(t,i,s,a);r(this,"frame");r(this,"opening");r(this,"dropX");r(this,"dropY");r(this,"layer");r(this,"interact",t=>{if(this.health===3&&!this.opening){this.health-=1,this.open();return}if(this.health!==2)return;const i=this.drops.find(a=>(a.onPickup(t),a.pickedUp));i&&(this.drops=this.drops.filter(a=>a!==i));const s=t.inventory.isFull();(this.drops.length===0||s)&&(this.health-=1,this.destroyable=!0)});r(this,"open",()=>{this.tileX=0,this.tileY=2,this.opening=!0,H.chest(),this.drop===null&&this.getDrop(["consumable","gem","coin","tool","light","weapon"],!0),this.drops.forEach(t=>{if(t.name==="coin"){let i=m.randTable([1,2,2,2,3,3,3,3,3,4,4,4,4,4,5,5,5,5,5,6,6,6,6,6,7,7,7,7,7,8,8,8,8,9,9,9,10,10,11,12,13,14,15,100],O.rand);O.rand()<.01&&(i*=Math.ceil(O.rand()*10)),t.stackCount=i}}),this.dropLoot(),this.drops.forEach(t=>{t.animateFromChest()})});r(this,"draw",t=>{this.dead||(m.ctx.save(),m.ctx.globalAlpha=this.alpha,this.opening&&(this.tileX<=6?this.tileX+=.15*t:this.opening=!1),this.dead||(this.updateDrawXY(t),this.hasShadow&&this.drawShadow(t),m.drawObj(Math.floor(this.tileX),Math.floor(this.tileY),1,2,this.x-this.drawX,this.y-this.drawYOffset-this.drawY,1,2,this.room.shadeColor,this.shadeAmount())),m.ctx.restore())});r(this,"drawTopLayer",t=>{this.drawableY=this.y-1});this.tileX=4,this.tileY=0,this.health=3,this.name="chest",this.frame=0,this.opening=!1,this.dropX=0,this.dropY=0,this.drop=null,this.destroyable=!1,this.pushable=!1,this.chainPushable=!1,this.interactable=!0,this.imageParticleX=3,this.imageParticleY=26}get type(){return gt.CHEST}}class $t extends oe{constructor(t,i,s){super(t,i,s);r(this,"variation");r(this,"draw",t=>{m.drawTile(this.variation,this.skin,1,1,this.x,this.y,1,1,this.room.shadeColor,this.shadeAmount())});this.variation=1,this.skin==hi.DUNGEON&&(this.variation=m.randTable([1,1,1,1,1,1,8,8,8,9,10,10,10,10,10,12],O.rand)),this.skin==hi.CAVE&&(this.variation=m.randTable([1,1,1,1,1,1,8,8,8,9,10,10,10,10,10,12],O.rand))}}class _t extends it{constructor(t,i,s,a,n){super(t,i,s,a);r(this,"frame");r(this,"ticks");r(this,"seenPlayer");r(this,"aggro");r(this,"ticksSinceFirstHit");r(this,"flashingFrame");r(this,"targetPlayer");r(this,"REGEN_TICKS",5);r(this,"drop");r(this,"hit",()=>this.damage);r(this,"hurt",(t,i,s="none")=>{this.handleEnemyCase(t);let a=0;this.shielded&&(a=this.shield.health,a>0&&this.shield.hurt(i)),this.ticksSinceFirstHit=0,this.health==2&&(this.unconscious=!1),this.health-=i,this.maxHealth-=a,this.startHurting(),this.healthBar.hurt(),this.createDamageNumber(i,s),this.playHitSound(),this.health==1?(this.unconscious=!0,Ce.spawnCluster(this.room,this.x+.5,this.y+.5,3,28)):this.healthBar.hurt(),this.health<=0?(Ce.spawnCluster(this.room,this.x+.5,this.y+.5,0,24),this.kill()):this.hurtCallback()});r(this,"behavior",()=>{if(this.lastX=this.x,this.lastY=this.y,!this.dead){if(this.skipNextTurns>0){this.skipNextTurns--,this.ticks++;return}if(this.health<=1){this.unconscious=!0,this.ticksSinceFirstHit++,this.ticksSinceFirstHit>=this.REGEN_TICKS&&(this.healthBar.hurt(),this.health=2,this.unconscious=!1),this.ticks++;return}if(this.ticks++,!this.seenPlayer)this.lookForPlayer();else if(this.seenPlayer){if(this.room.playerTicked===this.targetPlayer){this.alertTicks=Math.max(0,this.alertTicks-1);let i=this.x,s=this.y,a=Array();for(const l of this.room.entities)l!==this&&a.push({x:l.x,y:l.y});for(let l=this.x-1;l<=this.x+1;l++)for(let d=this.y-1;d<=this.y+1;d++)this.room.roomArray[l][d]instanceof rt&&this.room.roomArray[l][d].on&&a.push({x:l,y:d});let n=[];for(let l=0;l<this.room.roomX+this.room.width;l++){n[l]=[];for(let d=0;d<this.room.roomY+this.room.height;d++)this.room.roomArray[l]&&this.room.roomArray[l][d]?n[l][d]=this.room.roomArray[l][d]:n[l][d]=!1}let c=yt.AStar.search(n,this,this.targetPlayer,a,!1,!1,!0,this.direction,void 0,void 0);if(c.length>0){let l=c[0].pos.x,d=c[0].pos.y,u=this.direction,h=this.targetPlayer;if(this.facePlayer(h),l>i?this.direction=E.RIGHT:l<i?this.direction=E.LEFT:d>s?this.direction=E.DOWN:d<s&&(this.direction=E.UP),u==this.direction){for(const f in this.game.players)this.game.rooms[this.game.players[f].levelID]===this.room&&this.game.players[f].x===l&&this.game.players[f].y===d&&(this.game.players[f].hurt(this.hit(),this.name),this.drawX=.5*(this.x-this.game.players[f].x),this.drawY=.5*(this.y-this.game.players[f].y),this.game.players[f]===this.game.players[this.game.localPlayerID]&&this.game.shakeScreen(10*this.drawX,10*this.drawY));this.tryMove(l,d),this.setDrawXY(i,s),this.x>i?this.direction=E.RIGHT:this.x<i?this.direction=E.LEFT:this.y>s?this.direction=E.DOWN:this.y<s&&(this.direction=E.UP)}}this.direction==E.LEFT&&(a.push({x:this.x,y:this.y+1}),a.push({x:this.x,y:this.y-1})),this.direction==E.RIGHT&&(a.push({x:this.x,y:this.y+1}),a.push({x:this.x,y:this.y-1})),this.direction==E.DOWN&&(a.push({x:this.x+1,y:this.y}),a.push({x:this.x-1,y:this.y})),this.direction==E.UP&&(a.push({x:this.x+1,y:this.y}),a.push({x:this.x-1,y:this.y})),this.makeHitWarnings()}let t=Object.values(this.game.offlinePlayers).indexOf(this.targetPlayer)!==-1;if(!this.aggro||t){let i=this.nearestPlayer();if(i!==!1){let[s,a]=i;s<=4&&(t||s<this.playerDistance(this.targetPlayer))&&a!==this.targetPlayer&&(this.targetPlayer=a,this.facePlayer(a),a===this.game.players[this.game.localPlayerID]&&(this.alertTicks=1),this.makeHitWarnings())}}}}});r(this,"draw",t=>{this.dead||(m.ctx.save(),m.ctx.globalAlpha=this.alpha,this.dead||(this.updateDrawXY(t),this.tileX=5,this.tileY=8,(this.health<=1||this.dying)&&(this.tileX=3,this.tileY=0,this.ticksSinceFirstHit>=3&&(this.flashingFrame+=.1*t,Math.floor(this.flashingFrame)%2===0&&(this.tileX=2))),this.frame+=.1*t,this.frame>=4&&(this.frame=0),this.hasShadow&&this.drawShadow(t),m.drawMob(this.tileX+(this.tileX===5?Math.floor(this.frame):0),this.tileY+this.direction*2,1,2,this.x-this.drawX,this.y-this.drawYOffset-this.drawY-this.jumpY,1,2,this.softShadeColor,this.shadeAmount())),this.cloned||(this.seenPlayer||this.drawSleepingZs(t),this.alertTicks>0&&this.drawExclamation(t)),m.ctx.restore())});this.ticks=0,this.frame=0,this.health=2,this.maxHealth=2,this.defaultMaxHealth=2,this.tileX=5,this.tileY=8,this.seenPlayer=!1,this.aggro=!1,this.ticksSinceFirstHit=0,this.flashingFrame=0,this.deathParticleColor="#ffffff",this.name="skeleton",this.forwardOnlyAttack=!0,n&&(this.drop=n),this.getDrop(["weapon","consumable","tool","coin"])}}r(_t,"difficulty",2),r(_t,"tileX",5),r(_t,"tileY",8);class Gs extends mt{constructor(t,i,s,a,n){super(t,i,s,a);r(this,"drop");r(this,"uniqueKillBehavior",()=>{this.createHitParticles(0,29)});r(this,"draw",t=>{this.dead||(m.ctx.save(),m.ctx.globalAlpha=this.alpha,this.dead||(this.hasShadow&&this.drawShadow(t),this.updateDrawXY(t),(this.health<=1||this.dying)&&(this.tileX=2),m.drawObj(this.tileX,this.tileY,1,2,this.x-this.drawX,this.y-this.drawYOffset-this.drawY,1,2,this.room.shadeColor,this.shadeAmount())),m.ctx.restore())});r(this,"drawTopLayer",t=>{this.drawableY=this.y});this.room=t,this.health=2,this.tileX=3,this.tileY=0,this.hasShadow=!0,this.chainPushable=!1,this.name="plant",this.imageParticleX=0,this.imageParticleY=28,n?this.drop=n:O.rand()<.025?this.drops.push(new ue(this.room,this.x,this.y)):this.drops.push(new ct(this.room,this.x,this.y))}get type(){return gt.PROP}}class Ks extends mt{constructor(t,i,s,a){super(t,i,s,a);r(this,"hurt",(t,i)=>{var s;(s=t.inventory)!=null&&s.getWeapon().canMine&&(this.healthBar.hurt(),this.health-=i,H.mine(),this.hurtCallback(),this.createHitParticles(),this.health<=0&&this.kill(t))});r(this,"uniqueKillBehavior",()=>{this.cloned||H.delayPlay(H.breakRock,50)});r(this,"kill",t=>{var s;if(this.dead=!0,this.cloned)return;this.emitEnemyKilled();const i=this.clone();this.room.deadEntities.push(i),this.removeLightSource(this.lightSource),(t!==null&&((s=t.inventory)!=null&&s.canMine())||t===null)&&this.dropLoot(),this.uniqueKillBehavior()});r(this,"draw",t=>{this.dead||(m.ctx.save(),m.ctx.globalAlpha=this.alpha,this.dead||(this.hasShadow&&this.drawShadow(t),this.updateDrawXY(t),m.drawObj(this.tileX,this.tileY,1,2,this.x-this.drawX,this.y-1.25-this.drawY,1,2,this.room.shadeColor,this.shadeAmount())),m.ctx.restore())});r(this,"drawTopLayer",t=>{this.drawableY=this.y});this.tileX=12,this.tileY=0,this.health=1,this.chainPushable=!1,this.name="resource",this.imageParticleX=0,this.imageParticleY=25}get type(){return gt.RESOURCE}}class Qs extends Ks{constructor(e,t,i,s){super(e,t,i,s),this.tileX=12,this.tileY=0,this.health=1,this.name="coal",O.rand()<.1&&this.drops.push(new Se(this.room,this.x,this.y)),this.drops.push(new Xi(this.room,this.x,this.y))}}class Js extends Ks{constructor(e,t,i,s){super(e,t,i,s),this.tileX=13,this.tileY=0,this.health=2,this.name="gold",O.rand()<.2&&this.drops.push(new Se(this.room,this.x,this.y)),this.drops.push(new At(this.room,this.x,this.y))}}class tr extends Ks{constructor(e,t,i,s){super(e,t,i,s),this.tileX=14,this.tileY=0,this.health=3,this.name="emerald",O.rand()<.2&&this.drops.push(new Se(this.room,this.x,this.y)),this.drops.push(new _e(this.room,this.x,this.y))}}class Ci extends oe{constructor(t,i,s,a,n,c,l){super(t,i,s);r(this,"tileX");r(this,"tileY");r(this,"topEdge");r(this,"_buffer");r(this,"isSolid",()=>!0);r(this,"canCrushEnemy",()=>!0);r(this,"draw",t=>{const i=x.TILESIZE,s=this.topEdge?2:1;(!this._buffer||this._buffer.width!==i||this._buffer.height!==s*i)&&(this._buffer=document.createElement("canvas"),this._buffer.width=i,this._buffer.height=s*i);const a=this._buffer.getContext("2d");a.clearRect(0,0,this._buffer.width,this._buffer.height);const n=m.ctx,c=a.globalCompositeOperation;m.ctx=a,a.globalCompositeOperation="source-over",m.drawTile(this.tileX,this.tileY,1,1,0,0,1,1,this.room.shadeColor,this.shadeAmount()),a.globalCompositeOperation="source-in",m.drawTile(1,this.skin,1,1,0,0,1,1,this.room.shadeColor,this.shadeAmount()),this.topEdge&&(a.globalCompositeOperation="destination-over",m.drawTile(22,0,1,2,0,0,1,2,this.room.shadeColor,this.shadeAmount())),m.ctx=n,a.globalCompositeOperation=c,m.ctx.save(),m.ctx.globalCompositeOperation="source-over",m.ctx.drawImage(this._buffer,this.x*i,this.y*i),m.ctx.restore()});this.tileX=this.skin===1?24:20,this.tileY=1,a?this.tileX--:n&&this.tileX++,c?this.tileY--:l&&this.tileY++,this.topEdge=c}}class ho extends Vi{constructor(t,i,s,a){super(i,s,a);r(this,"ANIM_COUNT",3);r(this,"room");r(this,"enemy");r(this,"frame");r(this,"tick",()=>{this.room===this.room.game.room&&H.enemySpawn();let t=!1;for(const i in this.room.game.players)this.room.game.players[i].x===this.x&&this.room.game.players[i].y===this.y&&(this.room.game.players[i].hurt(.5,"reaper"),t=!0);t?this.room.hitwarnings.push(new Ht(this.room.game,this.x,this.y,this.x,this.y)):(this.dead=!0,this.enemy.skipNextTurns=1,this.room.entities.push(this.enemy),this.enemy.createHitParticles(),this.lightSource.dead=!0)});r(this,"drawTopLayer",t=>{if(!this.dead){this.frame+=.25*t,this.frame>=8&&(this.frame=0);for(let i=0;i<this.ANIM_COUNT;i++)m.drawFX(Math.floor(this.frame),27,1,1,this.x+Math.round(0)/16,this.y-.5,1,1)}});this.room=t,this.enemy=i,this.frame=0,this.hasBloom=!0,this.bloomColor="#00BFFF",this.bloomOffsetY=-.5,this.lightSource=new Vt(this.x+.5,this.y+.5,1,[0,50,150],1),this.room.lightSources.push(this.lightSource),this.room.updateLighting()}}class wn extends yi{constructor(t,i){super();r(this,"x");r(this,"y");r(this,"z");r(this,"dz");r(this,"frame");r(this,"dead");r(this,"draw",t=>{this.dead||(m.drawFX(Math.floor(this.frame),3,1,1,this.x,this.y-this.z,1,1),this.z+=this.dz*t,this.dz*=.9,this.frame+=.3*t,this.frame>6&&(this.dead=!0))});this.x=t,this.y=i,this.dead=!1,this.frame=0,this.z=0,this.dz=.1}}class Ws extends Vi{constructor(t,i,s){super(t,i,s);r(this,"state");r(this,"frame");r(this,"parent");r(this,"delay");r(this,"frameOffset");r(this,"offsetX");r(this,"hitWarning");r(this,"tileX");r(this,"tileY");r(this,"setMarkerFrame",()=>{this.offsetX=Math.floor((this.dir+1)%8/2)});r(this,"tick",()=>{if((this.parent.dead||this.state===3)&&(this.parent.removeLightSource(this.lightSource),this.dead=!0),!this.dead&&this.state===0&&(this.bloomAlpha=1),this.state++,!this.dead&&this.state===1){this.bloomAlpha=.5;const t=this.parent.room.lightSources.find(i=>i===this.lightSource);t.b=.4,this.parent.room.hitwarnings.push(new Ht(this.parent.game,this.x,this.y,this.parent.x,this.parent.y,!0))}!this.dead&&this.state===2&&(this.bloomAlpha=0,Xe.momentaryLight(this.parent.room,this.x,this.y,3,this.parent.projectileColor,500,5,350),this.parent.removeLightSource(this.lightSource),this.frame=0,this.delay=m.rand(0,10,O.rand))});r(this,"hitPlayer",t=>{!this.dead&&this.state===2&&t.hurt(1,this.parent.name)});r(this,"draw",t=>{if(!this.dead&&this.state>=0)if(this.state===0)this.frame+=.25*t,this.frame>=4&&(this.frame=0),m.drawFX(22+Math.floor(this.frame),this.tileY,1,1,this.x,this.y,1,1);else if(this.state===1)this.frame+=.25*t,this.frame>=4&&(this.frame=0),m.drawFX(18+Math.floor(this.frame),this.tileY,1,1,this.x,this.y-.2,1,1);else{if(this.delay>0){this.delay--;return}this.frame+=.3*t,this.frame>17&&(this.dead=!0),m.drawFX(Math.floor(this.frame),6,1,2,this.x,this.y-1,1,2)}});this.tileY=t.name==="wizard bomber"?7:8,this.parent=t,this.frame=0,this.state=0,this.lightSource=new Vt(this.x+.5,this.y+.5,4,t.projectileColor,.1),this.parent.addLightSource(this.lightSource),this.hasBloom=!0,this.bloomColor=Q.rgbToHex(this.parent.projectileColor[0],this.parent.projectileColor[1],this.parent.projectileColor[2]),this.bloomAlpha=.5,this.softBloomAlpha=0}}class qe extends it{constructor(t,i,s,a,n){super(t,i,s,a);r(this,"ticks");r(this,"state");r(this,"frame");r(this,"seenPlayer");r(this,"projectileColor");r(this,"ATTACK_RADIUS",5);r(this,"newLightSource",(t,i,s,a,n)=>{this.lightSource=new Vt(t,i,s,a,n)});r(this,"addLightSource",t=>{this.room.lightSources.push(t)});r(this,"removeLightSource",t=>{this.room.lightSources=this.room.lightSources.filter(i=>i!==t)});r(this,"hit",()=>1);r(this,"withinAttackingRangeOfPlayer",()=>{let t=!1;for(const i in this.game.players)(this.x-this.game.players[i].x)**2+(this.y-this.game.players[i].y)**2<=this.ATTACK_RADIUS**2&&(t=!0);return t});r(this,"shuffle",t=>{let i,s,a;for(a=t.length-1;a>0;a--)i=Math.floor(O.rand()*(a+1)),s=t[a],t[a]=t[i],t[i]=s;return t});r(this,"behavior",()=>{if(this.lastX=this.x,this.lastY=this.y,!this.dead){if(this.skipNextTurns>0){this.skipNextTurns--;return}if(!this.seenPlayer)this.lookForPlayer();else if(this.seenPlayer)switch(this.alertTicks=Math.max(0,this.alertTicks-1),this.state){case 1:const t=this.nearestPlayer();if(t!==!1){const[h,f]=t;this.calculateProjectileOffsets(f.x,f.y,10),this.attemptProjectilePlacement([{x:-1,y:0},{x:-2,y:0},{x:1,y:0},{x:2,y:0},{x:0,y:-1},{x:0,y:-2},{x:0,y:1},{x:0,y:2}],Ws,!1)}this.state=2;break;case 2:this.state=0;break;case 3:let i=this.x,s=this.y,a=1e5,n,c=this.shuffle(this.room.getEmptyTiles());c=c.filter(h=>!this.room.projectiles.some(f=>f.x===h.x&&f.y===h.y));let l=m.randTable([2,2,3,3,3,3,3],O.rand),d=[];for(const h in this.game.players)d.push(h);let u=m.randTable(d,O.rand);for(let h of c){let f=h,p=Math.abs(f.x-this.game.players[u].x)+Math.abs(f.y-this.game.players[u].y);Math.abs(p-l)<Math.abs(a-l)&&(a=p,n=f)}n&&(this.tryMove(n.x,n.y),this.drawX=this.x-i,this.drawY=this.y-s,this.frame=0,this.room.particles.push(new wn(i,s)),this.withinAttackingRangeOfPlayer()?this.state=1:this.state=0);break;case 0:this.state=3;break}}});r(this,"draw",t=>{this.dead||(m.ctx.save(),m.ctx.globalAlpha=this.alpha,this.dead||(this.updateDrawXY(t),this.state===1?this.tileX=7:this.tileX=6,this.hasShadow&&this.drawShadow(t),this.frame>=0?(m.drawMob(Math.floor(this.frame)+6,2,1,2,this.x,this.y-1.5,1,2,this.softShadeColor,this.shadeAmount()),this.frame+=.2*t,this.frame>11&&(this.frame=-1)):m.drawMob(this.tileX,this.tileY,1,2,this.x-this.drawX,this.y-1.3-this.drawY,1,2,this.softShadeColor,this.shadeAmount()),this.seenPlayer||this.drawSleepingZs(t),this.alertTicks>0&&this.drawExclamation(t)),m.ctx.restore())});this.ticks=0,this.health=1,this.maxHealth=1,this.defaultMaxHealth=1,this.tileX=6,this.tileY=0,this.frame=0,this.state=1,this.seenPlayer=!1,this.alertTicks=0,this.name="wizard bomber",n&&(this.drop=n),this.getDrop(["weapon","equipment","consumable","tool","coin"])}}r(qe,"difficulty",3),r(qe,"tileX",6),r(qe,"tileY",0);class Mt extends qe{constructor(t,i,s,a,n){super(t,i,s,a);r(this,"draw",t=>{this.dead||(m.ctx.save(),m.ctx.globalAlpha=this.alpha,this.dead||(this.updateDrawXY(t),this.state===1?this.tileX=7:this.tileX=6,this.hasShadow&&this.state!==3&&this.drawShadow(t),this.frame>=0?(m.drawMob(Math.floor(this.frame)+6,2,1,2,this.x,this.y-1.3,1,2,this.softShadeColor,this.shadeAmount()),this.frame+=.4*t,this.frame>12&&(this.frame=-1)):m.drawMob(this.tileX,this.tileY,1,2,this.x-this.drawX,this.y-1.3-this.drawY,1,2,this.softShadeColor,this.shadeAmount()),this.cloned||(this.seenPlayer||this.drawSleepingZs(t),this.alertTicks>0&&this.drawExclamation(t))),m.ctx.restore())});this.ticks=0,this.health=1,this.maxHealth=1,this.defaultMaxHealth=1,this.tileX=6,this.tileY=0,this.frame=0,this.state=1,this.seenPlayer=!1,this.alertTicks=0,this.name="wizard bomber",this.projectileColor=[0,50,150],n&&(this.drop=n),this.getDrop(["weapon","equipment","consumable","tool","coin"])}}r(Mt,"difficulty",3),r(Mt,"tileX",6),r(Mt,"tileY",0);class te extends it{constructor(t,i,s,a,n){super(t,i,s,a);r(this,"frame");r(this,"ticks");r(this,"seenPlayer");r(this,"aggro");r(this,"targetPlayer");r(this,"drop");r(this,"dir");r(this,"hit",()=>this.damage);r(this,"behavior",()=>{if(this.lastX=this.x,this.lastY=this.y,!this.dead){if(this.skipNextTurns>0){this.skipNextTurns--;return}if(this.ticks++,!this.seenPlayer)this.lookForPlayer();else if(this.seenPlayer){if(this.room.playerTicked===this.targetPlayer){this.alertTicks=Math.max(0,this.alertTicks-1);let i=this.x,s=this.y,a=Array();for(const l of this.room.entities)l!==this&&a.push({x:l.x,y:l.y});for(let l=this.x-1;l<=this.x+1;l++)for(let d=this.y-1;d<=this.y+1;d++)this.room.roomArray[l][d]instanceof rt&&this.room.roomArray[l][d].on&&a.push({x:l,y:d});let n=[];for(let l=0;l<this.room.roomX+this.room.width;l++){n[l]=[];for(let d=0;d<this.room.roomY+this.room.height;d++)this.room.roomArray[l]&&this.room.roomArray[l][d]?n[l][d]=this.room.roomArray[l][d]:n[l][d]=!1}let c=yt.AStar.search(n,this,this.targetPlayer,a,!1,!1,!0,this.direction);if(c.length>0){let l=c[0].pos.x,d=c[0].pos.y,u=this.direction,h=this.targetPlayer;if(this.facePlayer(h),l>i?this.direction=E.RIGHT:l<i?this.direction=E.LEFT:d>s?this.direction=E.DOWN:d<s&&(this.direction=E.UP),u==this.direction){for(const f in this.game.players)this.game.rooms[this.game.players[f].levelID]===this.room&&this.game.players[f].x===l&&this.game.players[f].y===d&&(this.game.players[f].hurt(this.hit(),this.name),this.drawX=.5*(this.x-this.game.players[f].x),this.drawY=.5*(this.y-this.game.players[f].y),this.game.players[f]===this.game.players[this.game.localPlayerID]&&this.game.shakeScreen(10*this.drawX,10*this.drawY));this.tryMove(l,d),this.setDrawXY(i,s),this.x>i?this.direction=E.RIGHT:this.x<i?this.direction=E.LEFT:this.y>s?this.direction=E.DOWN:this.y<s&&(this.direction=E.UP)}}this.direction==E.LEFT&&(a.push({x:this.x,y:this.y+1}),a.push({x:this.x,y:this.y-1})),this.direction==E.RIGHT&&(a.push({x:this.x,y:this.y+1}),a.push({x:this.x,y:this.y-1})),this.direction==E.DOWN&&(a.push({x:this.x+1,y:this.y}),a.push({x:this.x-1,y:this.y})),this.direction==E.UP&&(a.push({x:this.x+1,y:this.y}),a.push({x:this.x-1,y:this.y})),this.makeHitWarnings()}let t=Object.values(this.game.offlinePlayers).indexOf(this.targetPlayer)!==-1;if(!this.aggro||t){let i=this.nearestPlayer();if(i!==!1){let[s,a]=i;s<=4&&(t||s<this.playerDistance(this.targetPlayer))&&a!==this.targetPlayer&&(this.targetPlayer=a,this.facePlayer(a),a===this.game.players[this.game.localPlayerID]&&(this.alertTicks=1),this.makeHitWarnings())}}}}});r(this,"draw",t=>{this.dead||(m.ctx.globalAlpha=this.alpha,this.updateDrawXY(t),this.frame+=.1*t,this.frame>=4&&(this.frame=0),this.hasShadow&&this.drawShadow(t),m.drawMob(this.tileX+Math.floor(this.frame),this.tileY+this.direction*2,1,2,this.x-this.drawX,this.y-this.drawYOffset-this.drawY-this.jumpY,1,2,this.softShadeColor,this.shadeAmount()),this.cloned||(this.seenPlayer||this.drawSleepingZs(t),this.alertTicks>0&&this.drawExclamation(t)),m.ctx.globalAlpha=1)});this.ticks=0,this.frame=0,this.health=1,this.maxHealth=1,this.defaultMaxHealth=1,this.tileX=17,this.tileY=8,this.seenPlayer=!1,this.aggro=!1,this.dir=E.DOWN,this.name="zombie",this.forwardOnlyAttack=!0,this.jumpHeight=.35,n&&(this.drop=n),this.getDrop(["consumable","tool","coin"])}}r(te,"difficulty",1),r(te,"tileX",17),r(te,"tileY",8);class Pt extends it{constructor(t,i,s,a,n){super(t,i,s,a);r(this,"frame");r(this,"ticks");r(this,"seenPlayer");r(this,"aggro");r(this,"targetPlayer");r(this,"drop");r(this,"tryMove",(t,i)=>{let s=(c,l)=>c>=t&&c<t+this.w&&l>=i&&l<i+this.h,a=c=>!(c.x>=t+this.w||c.x+c.w<=t||c.y>=i+this.h||c.y+c.h<=i);for(const c of this.room.entities)if(c!==this&&a(c))return;for(const c in this.game.players)if(s(this.game.players[c].x,this.game.players[c].y))return;let n=[];for(let c=0;c<this.w;c++)for(let l=0;l<this.h;l++)if(!this.room.roomArray[t+c][i+l].isSolid())n.push(this.room.roomArray[t+c][i+l]);else return;for(let c of n)c.onCollideEnemy(this);this.x=t,this.y=i});r(this,"hit",()=>this.damage);r(this,"jump",t=>{let i=Math.max(Math.abs(this.drawX),Math.abs(this.drawY)),s=Math.abs(Math.sin(i*Math.PI))*this.jumpHeight;s<.01&&(s=0),s>this.jumpHeight&&(s=this.jumpHeight),this.jumpY=s});r(this,"behavior",()=>{if(!this.dead){if(this.skipNextTurns>0){this.skipNextTurns--;return}if(this.ticks++,!this.seenPlayer)this.lookForPlayer();else if(this.seenPlayer){if(this.room.playerTicked===this.targetPlayer){this.alertTicks=Math.max(0,this.alertTicks-1);let i=this.x,s=this.y,a=Array();for(const l of this.room.entities)l!==this&&a.push({x:l.x,y:l.y});for(let l=this.x-1;l<=this.x+1;l++)for(let d=this.y-1;d<=this.y+1;d++)this.room.roomArray[l][d]instanceof rt&&this.room.roomArray[l][d].on&&a.push({x:l,y:d}),this.room.roomArray[l][d]instanceof ot&&a.push({x:l,y:d});let n=[];for(let l=0;l<this.room.roomX+this.room.width;l++){n[l]=[];for(let d=0;d<this.room.roomY+this.room.height;d++)this.room.roomArray[l]&&this.room.roomArray[l][d]?n[l][d]=this.room.roomArray[l][d]:n[l][d]=!1}a.push({x:this.x+1,y:this.y}),a.push({x:this.x-1,y:this.y}),a.push({x:this.x,y:this.y+1}),a.push({x:this.x,y:this.y-1}),a.push({x:this.x,y:this.y});let c=yt.AStar.search(n,this,this.targetPlayer,a,!0);if(c=c.filter(l=>{const d=Math.abs(l.pos.x-this.x),u=Math.abs(l.pos.y-this.y);return d===1&&u===1}),this.justHurt)this.retreat(i,s);else if(c.length>0){let l=c[0].pos.x,d=c[0].pos.y,u=!1;for(const h in this.game.players)this.game.rooms[this.game.players[h].levelID]===this.room&&this.game.players[h].x===l&&this.game.players[h].y===d&&(this.game.players[h].hurt(this.hit(),this.name),this.drawX=.5*(this.x-this.game.players[h].x),this.drawY=.5*(this.y-this.game.players[h].y),u=!0,this.game.players[h]===this.game.players[this.game.localPlayerID]&&this.game.shakeScreen(10*this.drawX,10*this.drawY));u||(this.tryMove(l,d),this.setDrawXY(i,s))}this.makeHitWarnings()}let t=Object.values(this.game.offlinePlayers).indexOf(this.targetPlayer)!==-1;if(!this.aggro||t){let i=this.nearestPlayer();if(i!==!1){let[s,a]=i;s<=4&&(t||s<this.playerDistance(this.targetPlayer))&&a!==this.targetPlayer&&(this.targetPlayer=a,this.facePlayer(a),a===this.game.players[this.game.localPlayerID]&&(this.alertTicks=1),this.makeHitWarnings())}}}}});r(this,"draw",t=>{if(this.dead)return;m.ctx.save(),m.ctx.globalAlpha=this.alpha;let i=this.health<=1||this.cloned===!0?2:0;this.dead||(this.updateDrawXY(t),this.frame+=.1*t,this.frame>=4&&(this.frame=0),this.hasShadow&&this.drawShadow(t),m.drawMob(this.tileX+Math.floor(this.frame),this.tileY+i,1,2,this.x-this.drawX,this.y-this.drawYOffset-this.drawY-this.jumpY,1,2,this.softShadeColor,this.shadeAmount()*(1+this.jumpY/3))),this.cloned||(this.seenPlayer||this.drawSleepingZs(t),this.alertTicks>0&&this.drawExclamation(t)),m.ctx.restore()});this.ticks=0,this.frame=0,this.health=2,this.maxHealth=2,this.defaultMaxHealth=2,this.tileX=31,this.tileY=8,this.seenPlayer=!1,this.aggro=!1,this.name="bishop",this.jumpHeight=1,this.diagonalAttackRange=1,this.diagonalAttack=!0,this.orthogonalAttack=!1,this.imageParticleX=0,this.imageParticleY=26,n&&(this.drop=n),this.armored=!0,this.getDrop(["weapon","equipment","consumable","tool","coin"])}}r(Pt,"difficulty",2),r(Pt,"tileX",31),r(Pt,"tileY",8);class Bt extends it{constructor(t,i,s,a,n){super(t,i,s,a);r(this,"ticks");r(this,"frame");r(this,"seenPlayer");r(this,"aggro");r(this,"targetPlayer");r(this,"drop");r(this,"hit",()=>this.damage);r(this,"behavior",()=>{if(this.lastX=this.x,this.lastY=this.y,!this.dead){if(this.skipNextTurns>0){this.skipNextTurns--;return}if(!this.seenPlayer)this.lookForPlayer();else if(this.seenPlayer){if(this.room.playerTicked===this.targetPlayer)if(this.alertTicks=Math.max(0,this.alertTicks-1),this.ticks++,this.ticks%2===1){this.rumbling=!0;let i=this.x,s=this.y,a=Array();for(const l of this.room.entities)l!==this&&a.push({x:l.x,y:l.y});for(let l=this.x-1;l<=this.x+1;l++)for(let d=this.y-1;d<=this.y+1;d++)this.room.roomArray[l][d]instanceof rt&&this.room.roomArray[l][d].on&&a.push({x:l,y:d});let n=[];for(let l=0;l<this.room.roomX+this.room.width;l++){n[l]=[];for(let d=0;d<this.room.roomY+this.room.height;d++)this.room.roomArray[l]&&this.room.roomArray[l][d]?n[l][d]=this.room.roomArray[l][d]:n[l][d]=!1}this.target=this.getAverageLuminance()>0?this.targetPlayer:this.room.getExtremeLuminanceFromPoint(this.x,this.y).darkest;let c=yt.AStar.search(n,this,this.target,a,void 0,void 0,void 0,void 0,void 0,void 0,this.lastPlayerPos);if(c.length>0){let l=!1;for(const d in this.game.players)this.game.rooms[this.game.players[d].levelID]===this.room&&this.game.players[d].x===c[0].pos.x&&this.game.players[d].y===c[0].pos.y&&(this.game.players[d].hurt(this.hit(),this.name),this.drawX=.5*(this.x-this.game.players[d].x),this.drawY=.5*(this.y-this.game.players[d].y),this.game.players[d]===this.game.players[this.game.localPlayerID]&&this.game.shakeScreen(10*this.drawX,10*this.drawY),l=!0);l||(this.tryMove(c[0].pos.x,c[0].pos.y),this.setDrawXY(i,s),this.x>i?this.direction=E.RIGHT:this.x<i?this.direction=E.LEFT:this.y>s?this.direction=E.DOWN:this.y<s&&(this.direction=E.UP))}this.rumbling=!1}else this.rumbling=!0,this.makeHitWarnings();let t=Object.values(this.game.offlinePlayers).indexOf(this.targetPlayer)!==-1;if(!this.aggro||t){let i=this.nearestPlayer();if(i!==!1){let[s,a]=i;s<=4&&(t||s<this.playerDistance(this.targetPlayer))&&a!==this.targetPlayer&&(this.targetPlayer=a,this.facePlayer(a),a===this.game.players[this.game.localPlayerID]&&(this.alertTicks=1),this.ticks%2===0&&this.makeHitWarnings())}}}}});r(this,"draw",t=>{if(!this.dead){if(m.ctx.save(),m.ctx.globalAlpha=this.alpha,!this.dead){this.updateDrawXY(t),this.ticks%2===0?(this.tileX=9,this.tileY=4):(this.tileX=8,this.tileY=4);let i=this.rumble(this.rumbling,this.frame,this.direction).x,s=this.rumble(this.rumbling,this.frame,this.direction).y;this.frame+=.1*t,this.frame>=4&&(this.frame=0),this.hasShadow&&this.drawShadow(t),m.drawMob(this.tileX,this.tileY+this.direction,1,1,this.x-this.drawX+i,this.y-this.drawYOffset-this.drawY+s,1*this.crushX,1*this.crushY,this.softShadeColor,this.shadeAmount()),this.crushed&&this.crushAnim(t)}this.cloned||(this.seenPlayer||this.drawSleepingZs(t,0,.75*x.TILESIZE),this.alertTicks>0&&this.drawExclamation(t,0,.75*x.TILESIZE)),m.ctx.restore()}});this.ticks=0,this.frame=0,this.health=1,this.maxHealth=1,this.defaultMaxHealth=1,this.tileX=8,this.tileY=4,this.seenPlayer=!1,this.aggro=!1,this.name="crab",this.orthogonalAttack=!0,this.imageParticleX=3,this.imageParticleY=24,this.baseDamage=.5,this.drawYOffset=.25,this.getDrop(["weapon","equipment","consumable","tool","coin"])}get alertText(){return`New Enemy Spotted: Crab 
    Health: ${this.health}
    Attack Pattern: Omnidirectional
    Moves every other turn`}}r(Bt,"difficulty",1),r(Bt,"tileX",8),r(Bt,"tileY",4);const ss=class ss extends yi{constructor(t,i,s,a,n,c,l,d,u,h,f,p,y,g){super();r(this,"level");r(this,"x");r(this,"y");r(this,"z");r(this,"s");r(this,"dx");r(this,"dy");r(this,"targetX");r(this,"targetY");r(this,"targetZ");r(this,"dz");r(this,"color");r(this,"alpha");r(this,"delay");r(this,"expirationTimer");r(this,"render",()=>{let t=x.TILESIZE,s=.5*(this.s*this.alpha),a=m.ctx.fillStyle;m.ctx.fillStyle=this.color,m.ctx.imageSmoothingEnabled=!1,m.ctx.beginPath(),m.ctx.arc(Math.round(this.x*t),Math.round((this.y-this.z)*t),Math.round(s*t),0,2*Math.PI,!1),m.ctx.fill(),m.ctx.fillStyle=a});r(this,"draw",t=>{this.targetX?this.x+=.1*(this.targetX-this.x):this.x+=this.dx,this.targetY?this.y+=.1*(this.targetY-this.y):this.y+=this.dy,this.targetZ?this.z+=.1*(this.targetZ-this.z):this.z+=this.dz,this.dx*=.97,this.dy*=.97,this.z<=0&&(this.z=0,this.dz*=-.8),this.dz-=.01,this.alpha<.2?this.alpha-=.007:this.alpha-=.02,this.alpha<=.1&&(this.dead=!0),this.expirationTimer--,this.expirationTimer<=0&&(this.dead=!0),!this.dead&&(this.drawableY=this.y,this.render())});this.level=t,this.x=i,this.y=s,this.z=a,this.s=n,this.dx=c,this.dy=l,this.dz=d,this.color=u,this.alpha=1,h!==void 0&&(this.delay=h),this.targetX=p,this.targetY=y,this.targetZ=g,this.expirationTimer=1e6,f!==void 0&&(this.expirationTimer=f)}};r(ss,"shotgun",(t,i,s,a,n,c)=>{for(let l=0;l<4;l++)t.particles.push(new ss(t,i,s,0,O.rand()*.5+.3,0,0,0,c,0,1e7,a+O.rand()-.5,n+O.rand()-.5,0))}),r(ss,"spawnCluster",(t,i,s,a)=>{for(let n=0;n<4;n++)t.particles.push(new ss(t,i+O.rand()*.05-.025,s+O.rand()*.05-.025,O.rand()*.5,.0625*(n+8),.025*(O.rand()*2-1),.025*(O.rand()*2-1),.2*(O.rand()-1),a,0))});let xe=ss;class Ft extends it{constructor(t,i,s,a,n){super(t,i,s,a);r(this,"startX");r(this,"startY");r(this,"targetX");r(this,"targetY");r(this,"visualTargetX");r(this,"visualTargetY");r(this,"ticks");r(this,"frame");r(this,"state");r(this,"trailFrame");r(this,"drop");r(this,"maxChargeDistance",3);r(this,"trailAlpha",1);r(this,"hit",()=>this.damage);r(this,"canMoveOver",(t,i)=>{for(const a of this.room.entities)if(a!==this&&t===a.x&&i===a.y)return!1;let s=this.room.roomArray[t][i];return!(s.isSolid()||s instanceof ot)});r(this,"behavior",()=>{if(this.lastX=this.x,this.lastY=this.y,!this.dead){if(this.skipNextTurns>0){this.skipNextTurns--;return}if(this.ticks++,this.state===0){let t=!1,i=0,s=0;for(const a in this.game.players){const n=this.game.players[a].x,c=this.game.players[a].y,l=Math.abs(this.x-n),d=Math.abs(this.y-c);if(this.x===n&&d<=this.maxChargeDistance||this.y===c&&l<=this.maxChargeDistance){if(this.x===n){this.y<c?s=1:s=-1;for(let u=this.y;u!==c;u+=s)this.canMoveOver(this.x,u)||(t=!0)}else if(this.y===c){this.x<n?i=1:i=-1;for(let u=this.x;u!==n;u+=i)this.canMoveOver(u,this.y)||(t=!0)}if((i!==0||s!==0)&&!t){this.state=1,this.targetX=this.x,this.targetY=this.y;let u=0;for(;this.canMoveOver(this.targetX+i,this.targetY+s)&&u<this.maxChargeDistance;)this.targetX+=i,this.targetY+=s,u++,(this.targetX===n&&this.targetY===c||this.targetX===n-1&&this.targetY===c||this.targetX===n+1&&this.targetY===c||this.targetX===n&&this.targetY===c-1||this.targetX===n&&this.targetY===c+1)&&this.room.hitwarnings.push(new Ht(this.game,this.targetX,this.targetY,this.x,this.y));this.visualTargetX=this.targetX+.5*i,this.visualTargetY=this.targetY+.5*s,s===1&&(this.visualTargetY+=.65),i>0?this.direction=E.RIGHT:i<0?this.direction=E.LEFT:s<0?this.direction=E.UP:s>0&&(this.direction=E.DOWN);break}}}}else if(this.state===1){this.state=2,this.trailFrame=0;for(const t in this.game.players)(this.y===this.game.players[t].y&&(this.x<this.game.players[t].x&&this.game.players[t].x<=this.targetX||this.targetX<=this.game.players[t].x&&this.game.players[t].x<this.x)||this.x===this.game.players[t].x&&(this.y<this.game.players[t].y&&this.game.players[t].y<=this.targetY||this.targetY<=this.game.players[t].y&&this.game.players[t].y<this.y))&&this.game.players[t].hurt(this.hit(),this.name);this.startX=this.x,this.startY=this.y,this.drawX=this.targetX-this.x,this.drawY=this.targetY-this.y,this.x=this.targetX,this.y=this.targetY}else this.state===2&&(this.state=0)}});r(this,"draw",t=>{if(!this.dead){if(m.ctx.save(),m.ctx.globalAlpha=this.alpha,!this.dead){if(this.updateDrawXY(t),this.frame+=.1*t,this.frame>=4&&(this.frame=0),(this.state===2&&Math.abs(this.drawX)>.1||Math.abs(this.drawY)>.1)&&(xe.spawnCluster(this.room,this.x-this.drawX+.5,this.y-this.drawY+.5,"black"),xe.spawnCluster(this.room,this.x-this.drawX+.5,this.y-this.drawY+.5,"white")),this.state===2||this.trailAlpha<1){this.trailFrame+=.03*t;let i=this.trailFrame;i>=0&&i<=1&&(m.ctx.strokeStyle="white",this.trailAlpha=1-i,m.ctx.globalAlpha=this.trailAlpha,m.ctx.lineWidth=x.TILESIZE*.25,m.ctx.beginPath(),m.ctx.moveTo((this.startX+.5)*x.TILESIZE,(this.startY+.5)*x.TILESIZE),m.ctx.lineCap="round",m.ctx.lineTo((this.x-this.drawX+.5)*x.TILESIZE,(this.y-this.drawY+.5)*x.TILESIZE),m.ctx.stroke(),m.ctx.globalAlpha=1),this.trailAlpha<=0&&(this.trailAlpha=1)}this.hasShadow&&this.drawShadow(t),m.drawMob(this.tileX+Math.floor(this.frame),this.tileY+this.direction*2,1,2,this.x-this.drawX,this.y-this.drawYOffset-this.drawY,1,2,this.softShadeColor,this.shadeAmount()),this.cloned||(this.state===0?this.drawSleepingZs(t):this.state===1&&this.drawExclamation(t))}this.drawChargeBeam(t),m.ctx.restore()}});r(this,"drawChargeBeam",t=>{if(!this.dying&&(this.drawableY=this.y,this.healthBar.draw(t,this.health,this.maxHealth,this.x,this.y,!0),this.drawX+=-.1*this.drawX,this.drawY+=-.1*this.drawY,this.state===1&&(this.trailFrame+=.2*t,Math.floor(this.trailFrame)%2===0))){let i=(this.x+.5)*x.TILESIZE,s=(this.y-.25)*x.TILESIZE;this.direction===E.LEFT?i-=3:this.direction===E.RIGHT?i+=3:this.direction===E.DOWN?s+=2:this.direction===E.UP&&(s-=8);let a=this.visualTargetX,n=this.visualTargetY;const c=this.direction===E.LEFT?-1:this.direction===E.RIGHT?1:0,l=this.direction===E.UP?-1:this.direction===E.DOWN?1:0;Math.max(Math.abs(this.visualTargetX-this.x),Math.abs(this.visualTargetY-this.y))>this.maxChargeDistance&&(a=this.x+c*this.maxChargeDistance,n=this.y+l*this.maxChargeDistance,l===1&&(n+=.65),c>0?a+=.5:c<0&&(a-=.5)),m.ctx.strokeStyle="white",m.ctx.lineWidth=x.TILESIZE*.1,m.ctx.beginPath(),m.ctx.moveTo(Math.round(i),Math.round(s)),m.ctx.lineCap="round",m.ctx.lineTo(Math.round((a+.5)*x.TILESIZE),Math.round((n-.25)*x.TILESIZE)),m.ctx.stroke(),m.ctx.globalAlpha=1}});this.ticks=0,this.frame=0,this.health=1,this.maxHealth=1,this.defaultMaxHealth=1,this.tileX=13,this.tileY=8,this.trailFrame=0,this.alertTicks=0,this.deathParticleColor="#ffffff",this.lastX=this.x,this.lastY=this.y,this.name="charge knight",this.state=0,n&&(this.drop=n),this.getDrop(["weapon","equipment","consumable","tool","coin"])}}r(Ft,"difficulty",5),r(Ft,"tileX",13),r(Ft,"tileY",8);class Ut extends it{constructor(t,i,s,a,n){super(t,i,s,a);r(this,"frame");r(this,"ticks");r(this,"seenPlayer");r(this,"ticksSinceFirstHit");r(this,"flashingFrame");r(this,"targetPlayer");r(this,"aggro");r(this,"REGEN_TICKS",5);r(this,"drops");r(this,"hit",()=>this.damage);r(this,"behavior",()=>{if(this.lastX=this.x,this.lastY=this.y,!this.dead){if(this.skipNextTurns>0){this.skipNextTurns--;return}if(this.health===1)this.ticksSinceFirstHit++,this.ticksSinceFirstHit>=this.REGEN_TICKS&&(this.health++,this.ticksSinceFirstHit=0);else if(this.seenPlayer){if(this.seenPlayer){if(this.room.playerTicked===this.targetPlayer){if(this.alertTicks=Math.max(0,this.alertTicks-1),this.ticks++,this.ticks%2===0){this.rumbling=!0,this.makeBigHitWarnings();return}const i=this.x,s=this.y;let a=Array();for(const l of this.room.entities)if(l!==this)for(let d=0;d<l.w;d++)for(let u=0;u<l.h;u++)a.push({x:l.x+d,y:l.y+u});for(let l=this.x-1;l<=this.x+this.w;l++)for(let d=this.y-1;d<=this.y+this.h;d++)this.room.roomArray[l]&&this.room.roomArray[l][d]&&this.room.roomArray[l][d]instanceof rt&&this.room.roomArray[l][d].on&&a.push({x:l,y:d});let n=[];for(let l=0;l<this.room.roomX+this.room.width;l++){n[l]=[];for(let d=0;d<this.room.roomY+this.room.height;d++)this.room.roomArray[l]&&this.room.roomArray[l][d]?n[l][d]=this.room.roomArray[l][d]:n[l][d]=!1}let c=yt.AStar.search(n,this,this.targetPlayer,a,!1,!1,!0,this.direction);if(c.length>0){const l=c[0].pos.x,d=c[0].pos.y;l>i?this.direction=E.RIGHT:l<i?this.direction=E.LEFT:d>s?this.direction=E.DOWN:d<s&&(this.direction=E.UP);let u=!1;if(this.health>=3){for(const h in this.game.players)if(this.game.rooms[this.game.players[h].levelID]===this.room){let f=!1;for(let p=0;p<this.w;p++){for(let y=0;y<this.h;y++)if(this.game.players[h].x===l+p&&this.game.players[h].y===d+y){f=!0;break}if(f)break}f&&(this.game.players[h].hurt(this.hit(),this.name),this.drawX=.5*(this.x-this.game.players[h].x),this.drawY=.5*(this.y-this.game.players[h].y),this.game.players[h]===this.game.players[this.game.localPlayerID]&&this.game.shakeScreen(10*this.drawX,10*this.drawY),u=!0)}}u||(this.tryMove(l,d),this.setDrawXY(i,s),this.x>i?this.direction=E.RIGHT:this.x<i?this.direction=E.LEFT:this.y>s?this.direction=E.DOWN:this.y<s&&(this.direction=E.UP))}else this.facePlayer(this.targetPlayer);this.health<this.maxHealth&&(this.ticksSinceFirstHit++,this.ticksSinceFirstHit>=this.REGEN_TICKS&&(this.health++,this.ticksSinceFirstHit=0))}let t=Object.values(this.game.offlinePlayers).indexOf(this.targetPlayer)!==-1;if(!this.aggro||t){let i=this.nearestPlayer();if(i!==!1){let[s,a]=i;s<=4&&(t||s<this.playerDistance(this.targetPlayer))&&a!==this.targetPlayer&&(this.targetPlayer=a,this.facePlayer(a),a===this.game.players[this.game.localPlayerID]&&(this.alertTicks=1),this.health>=3&&this.ticks%2===0&&(this.rumbling=!0),this.makeBigHitWarnings())}}}}else{let t=this.nearestPlayer();if(t!==!1){let[i,s]=t;i<=4&&(this.targetPlayer=s,this.facePlayer(s),this.seenPlayer=!0,s===this.game.players[this.game.localPlayerID]&&(this.alertTicks=1),this.makeBigHitWarnings())}}}});r(this,"draw",t=>{if(!this.dead){if(m.ctx.save(),m.ctx.globalAlpha=this.alpha,!this.dead){let i=this.rumble(this.rumbling,this.frame).x;this.rumble(this.rumbling,this.frame,this.direction).y,this.updateDrawXY(t),this.frame+=.1*t,this.frame>=4&&(this.frame=0);const s=this.ticks%2===0?2*Math.floor((this.tileX+this.frame)/2)+1:this.tileX,a=this.ticks%2===0?this.tileY:this.tileY+4;this.hasShadow&&this.drawShadow(t),m.drawMob(s,a,2,4,this.x-this.drawX+i,this.y-2.5-this.drawY,2,4,this.softShadeColor,this.shadeAmount()),this.cloned||(this.seenPlayer||this.drawSleepingZs(t,x.TILESIZE*.5,x.TILESIZE*-1),this.alertTicks>0&&this.drawExclamation(t,x.TILESIZE*.5,x.TILESIZE*-1))}m.ctx.restore()}});r(this,"drawTopLayer",t=>{this.drawableY=this.y,this.healthBar.draw(t,this.health,this.maxHealth,this.x+.5,this.y,!0)});for(this.w=2,this.h=2,this.ticks=0,this.frame=0,this.health=6,this.maxHealth=6,this.defaultMaxHealth=6,this.tileX=29,this.tileY=0,this.seenPlayer=!1,this.aggro=!1,this.ticksSinceFirstHit=0,this.flashingFrame=0,this.deathParticleColor="#ffffff",this.chainPushable=!1,this.name="giant knight",this.orthogonalAttack=!0,this.drops=[],n&&this.drops.push(n);this.drops.length<4;){let c=O.rand();c<.005?this.drops.push(new we(this.room,this.x,this.y)):c<.04?this.drops.push(new ce(this.room,this.x,this.y)):c<.075?this.drops.push(new ce(this.room,this.x,this.y)):c<.1?this.drops.push(new ce(this.room,this.x,this.y)):this.drops.push(new ct(this.room,this.x,this.y))}}}r(Ut,"difficulty",4),r(Ut,"tileX",29),r(Ut,"tileY",0);class Nt extends it{constructor(t,i,s,a,n){super(t,i,s,a);r(this,"frame");r(this,"ticks");r(this,"seenPlayer");r(this,"ticksSinceFirstHit");r(this,"flashingFrame");r(this,"targetPlayer");r(this,"aggro");r(this,"unconscious");r(this,"REGEN_TICKS",5);r(this,"drops");r(this,"hit",()=>this.damage);r(this,"hurt",(t,i,s="none")=>{this.handleEnemyCase(t);let a=0;this.shielded&&(a=this.shield.health,a>0&&this.shield.hurt(i)),this.ticksSinceFirstHit=0,this.health==4&&(this.unconscious=!1),this.health-=i,this.maxHealth-=a,this.startHurting(),this.healthBar.hurt(),this.createDamageNumber(i,s),this.playHitSound(),this.health==2?(this.unconscious=!0,Ce.spawnCluster(this.room,this.x+1,this.y+1,3,28)):this.healthBar.hurt(),this.health<=0?(Ce.spawnCluster(this.room,this.x+1,this.y+1,0,24),this.kill()):this.hurtCallback()});r(this,"behavior",()=>{if(this.lastX=this.x,this.lastY=this.y,!this.dead){if(this.skipNextTurns>0){this.skipNextTurns--,this.ticks++;return}if(this.health<=2){this.unconscious=!0,this.ticksSinceFirstHit++,this.ticksSinceFirstHit>=this.REGEN_TICKS&&(this.healthBar.hurt(),this.health=4,this.unconscious=!1),this.ticks++;return}if(this.ticks++,!this.seenPlayer)this.lookForPlayer();else if(this.seenPlayer){if(this.room.playerTicked===this.targetPlayer){this.alertTicks=Math.max(0,this.alertTicks-1);let i=this.x,s=this.y;const a=this.targetPlayer,n=a.y>=this.y&&a.y<this.y+this.h,c=a.x>=this.x&&a.x<this.x+this.w;if(n!==c){let h=this.direction;if(n?h=a.x<this.x?E.LEFT:E.RIGHT:c&&(h=a.y<this.y?E.UP:E.DOWN),h!==this.direction){this.direction=h,this.makeBigHitWarnings(),this.ticks++;return}}let l=Array();for(const h of this.room.entities)if(h!==this)for(let f=0;f<(h.w||1);f++)for(let p=0;p<(h.h||1);p++)l.push({x:h.x+f,y:h.y+p});for(let h=this.x-1;h<=this.x+this.w;h++)for(let f=this.y-1;f<=this.y+this.h;f++)this.room.roomArray[h]&&this.room.roomArray[h][f]&&this.room.roomArray[h][f]instanceof rt&&this.room.roomArray[h][f].on&&l.push({x:h,y:f});let d=[];for(let h=0;h<this.room.roomX+this.room.width;h++){d[h]=[];for(let f=0;f<this.room.roomY+this.room.height;f++)this.room.roomArray[h]&&this.room.roomArray[h][f]?d[h][f]=this.room.roomArray[h][f]:d[h][f]=!1}let u=yt.AStar.search(d,this,this.targetPlayer,l,!1,!1,!0,this.direction,void 0,void 0);if(u.length>0){let h=u[0].pos.x,f=u[0].pos.y,p=this.direction;if(this.targetPlayer,h>i?this.direction=E.RIGHT:h<i?this.direction=E.LEFT:f>s?this.direction=E.DOWN:f<s&&(this.direction=E.UP),p===this.direction){let y=!1,g=(w,b,T)=>w.x>=b&&w.x<b+this.w&&w.y>=T&&w.y<T+this.h;for(const w in this.game.players){const b=this.closestTile(this.game.players[w]);this.game.rooms[this.game.players[w].levelID]===this.room&&g(this.game.players[w],h,f)&&(this.game.players[w].hurt(this.hit(),this.name),this.drawX=.5*(b.x-this.game.players[w].x),this.drawY=.5*(b.y-this.game.players[w].y),this.game.players[w]===this.game.players[this.game.localPlayerID]&&this.game.shakeScreen(10*this.drawX,10*this.drawY),y=!0)}y||(this.tryMove(h,f),this.setDrawXY(i,s),this.x>i?this.direction=E.RIGHT:this.x<i?this.direction=E.LEFT:this.y>s?this.direction=E.DOWN:this.y<s&&(this.direction=E.UP))}}else this.facePlayer(this.targetPlayer);if(this.direction==E.LEFT)for(let h=0;h<this.h;h++)l.push({x:this.x,y:this.y+h+1}),l.push({x:this.x,y:this.y+h-1});if(this.direction==E.RIGHT)for(let h=0;h<this.h;h++)l.push({x:this.x+this.w-1,y:this.y+h+1}),l.push({x:this.x+this.w-1,y:this.y+h-1});if(this.direction==E.DOWN)for(let h=0;h<this.w;h++)l.push({x:this.x+h+1,y:this.y+this.h-1}),l.push({x:this.x+h-1,y:this.y+this.h-1});if(this.direction==E.UP)for(let h=0;h<this.w;h++)l.push({x:this.x+h+1,y:this.y}),l.push({x:this.x+h-1,y:this.y});this.makeBigHitWarnings()}let t=Object.values(this.game.offlinePlayers).indexOf(this.targetPlayer)!==-1;if(!this.aggro||t){let i=this.nearestPlayer();if(i!==!1){let[s,a]=i;s<=4&&(t||s<this.playerDistance(this.targetPlayer))&&a!==this.targetPlayer&&(this.targetPlayer=a,this.facePlayer(a),a===this.game.players[this.game.localPlayerID]&&(this.alertTicks=1),this.makeBigHitWarnings())}}}}});r(this,"draw",t=>{this.dead||(m.ctx.save(),m.ctx.globalAlpha=this.alpha,this.dead||(this.updateDrawXY(t),this.tileX=33,this.tileY=12,(this.health<=2||this.cloned)&&(this.tileX=35,this.tileY=12,this.ticksSinceFirstHit>=3&&(this.flashingFrame+=.1*t,Math.floor(this.flashingFrame)%2===0&&(this.tileX=33))),this.frame+=.1*t,this.frame>=4&&(this.frame=0),this.hasShadow&&this.drawShadow(t),m.drawMob(this.tileX,this.tileY+this.direction*3,2,3,this.x-this.drawX,this.y-1.5-this.drawY-this.jumpY,2,3,this.softShadeColor,this.shadeAmount()),this.cloned||(this.seenPlayer||this.drawSleepingZs(t,x.TILESIZE*.5,x.TILESIZE*-1),this.alertTicks>0&&this.drawExclamation(t,x.TILESIZE*.5,x.TILESIZE*-1))),m.ctx.restore())});r(this,"drawTopLayer",t=>{this.drawableY=this.y,this.healthBar.draw(t,this.health,this.maxHealth,this.x+.5,this.y-.5,!0)});this.w=2,this.h=2,this.ticks=0,this.frame=0,this.health=6,this.maxHealth=6,this.defaultMaxHealth=6,this.tileX=33,this.tileY=12,this.seenPlayer=!1,this.aggro=!1,this.unconscious=!1,this.ticksSinceFirstHit=0,this.flashingFrame=0,this.deathParticleColor="#ffffff",this.chainPushable=!1,this.name="giant skeleton",this.dropChance=1,this.drops=[],this.direction=E.DOWN,this.forwardOnlyAttack=!0,this.drawMoveSpeed=.9,this.canDestroyOthers=!0,n&&this.drops.push(n);const c=Math.floor(O.rand()*3)+2;for(;this.drops.length<c&&!this.cloned;)this.getDrop()}}r(Nt,"difficulty",4),r(Nt,"tileX",21),r(Nt,"tileY",0);class fe extends it{constructor(t,i,s,a,n){super(t,i,s,a);r(this,"ticks");r(this,"frame");r(this,"seenPlayer");r(this,"aggro");r(this,"targetPlayer");r(this,"drop");r(this,"frameLength");r(this,"startFrame");r(this,"animationSpeed");r(this,"tickCount");r(this,"rumbling");r(this,"jumping");r(this,"jumpDistance");r(this,"hit",()=>this.damage);r(this,"behavior",()=>{if(this.lastX=this.x,this.lastY=this.y,this.tileX=1,this.frameLength=3,this.animationSpeed=.1,!this.dead){if(this.skipNextTurns>0){this.skipNextTurns--;return}if(!this.seenPlayer)this.tileX=12,this.lookForPlayer();else if(this.seenPlayer){if(this.tileX=1,this.room.playerTicked===this.targetPlayer)if(this.alertTicks=Math.max(0,this.alertTicks-1),this.ticks++,this.ticks%2===1){this.rumbling=!0,this.x,this.y;let i=Array();for(const d of this.room.entities)d!==this&&i.push({x:d.x,y:d.y});for(let d=this.x-1;d<=this.x+1;d++)for(let u=this.y-1;u<=this.y+1;u++)this.room.roomArray[d][u]instanceof rt&&this.room.roomArray[d][u].on&&i.push({x:d,y:u});let s=[];for(let d=0;d<this.room.roomX+this.room.width;d++){s[d]=[];for(let u=0;u<this.room.roomY+this.room.height;u++)this.room.roomArray[d]&&this.room.roomArray[d][u]?s[d][u]=this.room.roomArray[d][u]:s[d][u]=!1}let a={x:this.targetPlayer.x,y:this.targetPlayer.y},n=this.targetPlayer.x-this.x,c=this.targetPlayer.y-this.y;if(n===0&&c<=1||n<=1&&c===0||n===0&&c>=-1||n>=-1&&c===0){let d=this.targetPlayer.x+n,u=this.targetPlayer.y+c;this.room.roomArray[d]&&this.room.roomArray[d][u]&&(this.room.roomArray[d][u].isSolid()||(a={x:d,y:u}))}let l=yt.AStar.search(s,this,a,i,!1,!1,!1,void 0,void 0,!1,this.lastPlayerPos);if(l[1]){let d=!1;for(const u in this.game.players)this.game.rooms[this.game.players[u].levelID]===this.room&&this.game.players[u].x===l[1].pos.x&&this.game.players[u].y===l[1].pos.y&&(this.game.players[u].hurt(this.hit(),this.name),this.drawX+=1.5*(this.x-this.game.players[u].x),this.drawY+=1.5*(this.y-this.game.players[u].y),this.game.players[u]===this.game.players[this.game.localPlayerID]&&this.game.shakeScreen(5*this.drawX,5*this.drawY),d=!0);if(!d&&l.length>1){let u=l[1].pos.x,h=l[1].pos.y;this.tryMove(u,h),this.setDrawXY(this.lastX,this.lastY),this.jumping&&(this.frame=8,this.animationSpeed=1),this.x>u?this.direction=E.RIGHT:this.x<u?this.direction=E.LEFT:this.y>h?this.direction=E.DOWN:this.y<h&&(this.direction=E.UP)}}this.rumbling=!1}else this.makeHitWarnings(),this.rumbling=!0,this.tileX=3,this.frame=0,this.frameLength=2,this.animationSpeed=.2;let t=Object.values(this.game.offlinePlayers).indexOf(this.targetPlayer)!==-1;if(!this.aggro||t){let i=this.nearestPlayer();if(i!==!1){let[s,a]=i;s<=4&&(t||s<this.playerDistance(this.targetPlayer))&&a!==this.targetPlayer&&(this.targetPlayer=a,this.facePlayer(a),a===this.game.players[this.game.localPlayerID]&&(this.alertTicks=1),this.ticks%2===0&&this.makeHitWarnings())}}}}});r(this,"jump",t=>{if(this.jumping){let i=Math.max(Math.abs(this.drawX),Math.abs(this.drawY));i>1&&(this.jumpDistance=2),this.jumpY=Math.sin(i/this.jumpDistance*Math.PI)*this.jumpHeight,this.jumpY<.01&&this.jumpY>-.01&&(this.jumpY=0,this.jumpDistance=1),this.jumpY>this.jumpHeight&&(this.jumpY=this.jumpHeight)}});r(this,"makeHitWarnings",()=>{const i=this.getPlayer(),s=this.orthogonalAttack,a=this.diagonalAttack,n=this.forwardOnlyAttack,c=this.direction,l=this.attackRange,d=this.diagonalAttackRange,u=(w,b)=>(w?[[-2,0],[2,0],[0,-2],[0,2]]:[[-1,-1],[1,1],[1,-1],[-1,1]]).flatMap(([v,k])=>Array.from({length:b},(D,N)=>[(N+1)*v,(N+1)*k])),h={[E.LEFT]:[-1,0],[E.RIGHT]:[1,0],[E.UP]:[0,-1],[E.DOWN]:[0,1]};let f=[];if(n){const[w,b]=h[c];f=Array.from({length:l},(T,v)=>[(v+1)*w,(v+1)*b])}else s&&f.push(...u(!0,l)),a&&f.push(...u(!1,d));const p=f.map(([w,b])=>({x:w,y:b,distance:Q.distance(w,b,i.x-this.x,i.y-this.y)})).sort((w,b)=>w.distance-b.distance),y=Math.ceil(p.length*(1-.25));p.slice(0,y).forEach(({x:w,y:b})=>{const T=this.x+w,v=this.y+b;if(this.isWithinRoomBounds(T,v)){const k=new Ht(this.game,T,v,this.x,this.y,!0,!1,this);this.room.hitwarnings.push(k)}})});r(this,"draw",t=>{if(!this.dead){if(m.ctx.save(),m.ctx.globalAlpha=this.alpha,!this.dead){this.updateDrawXY(t),this.frame+=this.animationSpeed*t,this.frame>=this.frameLength&&(this.frame=0);let i=this.rumble(this.rumbling,this.frame).x;this.rumble(this.rumbling,this.frame).y,this.drawX!==0||this.drawY!==0?this.jumping=!0:this.jumping=!1,this.jumping?(this.frameLength=10,this.animationSpeed=.4):(this.frameLength=3,this.animationSpeed=.1),this.hasShadow&&this.drawShadow(t),m.drawMob(this.tileX+(this.tileX!==12&&!this.rumbling?Math.floor(this.frame):0),this.tileY,1,2,this.x+i-this.drawX,this.y-this.drawYOffset-this.drawY-this.jumpY,1,2,this.softShadeColor,this.shadeAmount())}this.cloned||(this.seenPlayer||this.drawSleepingZs(t),this.alertTicks>0&&this.drawExclamation(t)),m.ctx.restore()}});this.ticks=0,this.frame=0,this.health=1,this.maxHealth=1,this.defaultMaxHealth=1,this.tileX=12,this.tileY=16,this.seenPlayer=!1,this.aggro=!1,this.deathParticleColor="#ffffff",this.frameLength=3,this.startFrame=0,this.animationSpeed=.1,this.tickCount=0,this.jumping=!1,this.jumpDistance=1,this.drop=n||new ct(this.room,this.x,this.y),this.name="frog",this.orthogonalAttack=!0,this.diagonalAttack=!0,this.jumpHeight=1,this.imageParticleX=3,this.imageParticleY=30,this.baseDamage=.5,n&&(this.drop=n),this.getDrop(["weapon","consumable","tool","coin","poison"])}}r(fe,"difficulty",1),r(fe,"tileX",12),r(fe,"tileY",16);class Jt extends qe{constructor(t,i,s,a,n){super(t,i,s,a);r(this,"ATTACK_RADIUS",5);r(this,"hit",()=>1);r(this,"withinAttackingRangeOfPlayer",()=>{let t=!1;for(const i in this.game.players)(this.x-this.game.players[i].x)**2+(this.y-this.game.players[i].y)**2<=this.ATTACK_RADIUS**2&&(t=!0);return t});r(this,"shuffle",t=>{let i,s,a;for(a=t.length-1;a>0;a--)i=Math.floor(O.rand()*(a+1)),s=t[a],t[a]=t[i],t[i]=s;return t});r(this,"behavior",()=>{if(this.lastX=this.x,this.lastY=this.y,!this.dead){if(this.skipNextTurns>0){this.skipNextTurns--;return}if(!this.seenPlayer)this.lookForPlayer();else if(this.seenPlayer)switch(this.alertTicks=Math.max(0,this.alertTicks-1),this.state){case 1:const t=this.nearestPlayer();if(t!==!1){const[h,f]=t;this.calculateProjectileOffsets(f.x,f.y,10),this.attemptProjectilePlacement([{x:-1,y:0},{x:1,y:0},{x:0,y:-1},{x:0,y:1}],Ws,!1)}this.state=2;break;case 2:this.attemptProjectilePlacement([{x:-1,y:-1},{x:1,y:1},{x:1,y:-1},{x:-1,y:1}],Ws,!1),this.state=0;break;case 3:let i=this.x,s=this.y,a=1e5,n,c=this.shuffle(this.room.getEmptyTiles());if(c=c.filter(h=>!this.room.projectiles.some(f=>f.x===h.x&&f.y===h.y)),c.length===0||Object.keys(this.game.players).length===0){this.state=0;break}let l=m.randTable([2,2,3,3,3,3,3],O.rand),d=[];for(const h in this.game.players)d.push(h);let u=m.randTable(d,O.rand);if(!this.game.players[u]){this.state=0;break}for(let h of c){let f=h,p=Math.abs(f.x-this.game.players[u].x)+Math.abs(f.y-this.game.players[u].y);Math.abs(p-l)<Math.abs(a-l)&&(a=p,n=f)}n||(n=c[0]),this.tryMove(n.x,n.y),this.drawX=this.x-i,this.drawY=this.y-s,this.frame=0,this.room.particles.push(new wn(i,s)),this.withinAttackingRangeOfPlayer()?this.state=1:this.state=0;break;case 0:this.state=3;break}}});r(this,"draw",t=>{this.dead||(m.ctx.save(),m.ctx.globalAlpha=this.alpha,this.dead||(this.updateDrawXY(t),this.state===1?this.tileX=36:this.tileX=35,this.hasShadow&&this.state!==0&&this.drawShadow(t),this.frame>=0?(m.drawMob(Math.floor(this.frame)+5,18,1,2,this.x,this.y-1.3,1,2,this.softShadeColor,this.shadeAmount()),this.frame+=.4*t,this.frame>12&&(this.frame=-1)):m.drawMob(this.tileX,this.tileY,1,2,this.x-this.drawX,this.y-1.3-this.drawY,1,2,this.softShadeColor,this.shadeAmount()),this.cloned||(this.seenPlayer||this.drawSleepingZs(t),this.alertTicks>0&&this.drawExclamation(t))),m.ctx.restore())});this.ticks=0,this.health=1,this.maxHealth=1,this.defaultMaxHealth=1,this.tileX=35,this.tileY=8,this.frame=0,this.state=1,this.seenPlayer=!1,this.alertTicks=0,this.name="fire wizard",this.projectileColor=[200,20,0],n&&(this.drop=n),this.jumpHeight=.5,this.getDrop(["weapon","equipment","consumable","tool","coin"])}}r(Jt,"difficulty",3),r(Jt,"tileX",35),r(Jt,"tileY",8);class Xt extends it{constructor(t,i,s,a,n){super(t,i,s,a);r(this,"frame");r(this,"ticks");r(this,"seenPlayer");r(this,"aggro");r(this,"targetPlayer");r(this,"drop");r(this,"justHurt",!1);r(this,"hit",()=>this.damage);r(this,"behavior",()=>{if(this.lastX=this.x,this.lastY=this.y,this.health<=1&&(this.imageParticleY=29),!this.dead){if(this.skipNextTurns>0){this.skipNextTurns--;return}if(this.ticks++,this.seenPlayer){if(this.seenPlayer){if(this.room.playerTicked===this.targetPlayer){this.alertTicks=Math.max(0,this.alertTicks-1);let i=this.x,s=this.y,a=Array();for(const l of this.room.entities)l!==this&&a.push({x:l.x,y:l.y});for(let l=this.x-1;l<=this.x+1;l++)for(let d=this.y-1;d<=this.y+1;d++)this.room.roomArray[l][d]instanceof rt&&this.room.roomArray[l][d].on&&a.push({x:l,y:d});let n=[];for(let l=0;l<this.room.roomX+this.room.width;l++){n[l]=[];for(let d=0;d<this.room.roomY+this.room.height;d++)this.room.roomArray[l]&&this.room.roomArray[l][d]?n[l][d]=this.room.roomArray[l][d]:n[l][d]=!1}let c=yt.AStar.search(n,this,this.targetPlayer,a,!0,!1,void 0,void 0,void 0,!1);if(this.justHurt)this.retreat(i,s);else if(c.length>0){a.push({x:i+1,y:s}),a.push({x:i-1,y:s}),a.push({x:i,y:s+1}),a.push({x:i,y:s-1});let l=c[0].pos.x,d=c[0].pos.y;for(const u in this.game.players)this.game.rooms[this.game.players[u].levelID]===this.room&&this.game.players[u].x===l&&this.game.players[u].y===d&&(this.game.players[u].hurt(this.hit(),this.name),this.drawX=.5*(this.x-this.game.players[u].x),this.drawY=.5*(this.y-this.game.players[u].y),this.game.players[u]===this.game.players[this.game.localPlayerID]&&this.game.shakeScreen(10*this.drawX,10*this.drawY));this.tryMove(l,d),this.setDrawXY(i,s)}this.makeHitWarnings()}let t=Object.values(this.game.offlinePlayers).indexOf(this.targetPlayer)!==-1;if(!this.aggro||t){let i=this.nearestPlayer();if(i!==!1){let[s,a]=i;s<=4&&(t||s<this.playerDistance(this.targetPlayer))&&a!==this.targetPlayer&&(this.targetPlayer=a,this.facePlayer(a),a===this.game.players[this.game.localPlayerID]&&(this.alertTicks=1),this.makeHitWarnings())}}}}else{this.justHurt=!1;let t=this.nearestPlayer();if(t!==!1){let[i,s]=t;i<=4&&(this.targetPlayer=s,this.facePlayer(s),this.seenPlayer=!0,s===this.game.players[this.game.localPlayerID]&&(this.alertTicks=1),this.makeHitWarnings())}}}});r(this,"jump",t=>{let i=Math.max(Math.abs(this.drawX),Math.abs(this.drawY)),s=Math.abs(Math.sin(i*Math.PI))*this.jumpHeight;s<.01&&(s=0),s>this.jumpHeight&&(s=this.jumpHeight),this.jumpY=s});r(this,"draw",t=>{let i=this.health<=1?0:-2;this.cloned&&(i=0),!this.dead&&(m.ctx.save(),m.ctx.globalAlpha=this.alpha,this.dead||(this.updateDrawXY(t),this.frame+=.1*t,this.frame>=4&&(this.frame=0),this.hasShadow&&this.drawShadow(t),m.drawMob(this.tileX+Math.floor(this.frame),this.tileY+i,1,2,this.x-this.drawX,this.y-this.drawYOffset-this.drawY-this.jumpY,1,2,this.softShadeColor,this.shadeAmount()*(1+this.jumpY/3))),this.cloned||(this.seenPlayer||this.drawSleepingZs(t),this.alertTicks>0&&this.drawExclamation(t)),m.ctx.restore())});this.ticks=0,this.frame=0,this.health=2,this.maxHealth=2,this.defaultMaxHealth=2,this.tileX=23,this.tileY=10,this.seenPlayer=!1,this.aggro=!1,this.name="queen",this.orthogonalAttack=!0,this.diagonalAttack=!0,this.jumpHeight=1,this.imageParticleX=6,this.imageParticleY=28,n&&(this.drop=n),this.armored=!0,this.getDrop(["weapon","equipment","consumable","tool","coin"])}}r(Xt,"difficulty",4),r(Xt,"tileX",23),r(Xt,"tileY",8);class Ct extends it{constructor(t,i,s,a,n){super(t,i,s,a);r(this,"frame");r(this,"ticks");r(this,"seenPlayer");r(this,"aggro");r(this,"targetPlayer");r(this,"drop");r(this,"hit",()=>this.damage);r(this,"behavior",()=>{if(this.lastX=this.x,this.lastY=this.y,!this.dead){if(this.skipNextTurns>0){this.skipNextTurns--;return}if(this.ticks++,!this.seenPlayer)this.lookForPlayer();else if(this.seenPlayer){if(this.room.playerTicked===this.targetPlayer){this.alertTicks=Math.max(0,this.alertTicks-1);let i=this.x,s=this.y,a=Array();for(const l of this.room.entities)l!==this&&a.push({x:l.x,y:l.y});for(let l=this.x-1;l<=this.x+1;l++)for(let d=this.y-1;d<=this.y+1;d++)this.room.roomArray[l][d]instanceof rt&&this.room.roomArray[l][d].on&&a.push({x:l,y:d});let n=[];for(let l=0;l<this.room.roomX+this.room.width;l++){n[l]=[];for(let d=0;d<this.room.roomY+this.room.height;d++)this.room.roomArray[l]&&this.room.roomArray[l][d]?n[l][d]=this.room.roomArray[l][d]:n[l][d]=!1}let c=yt.AStar.search(n,this,this.targetPlayer,a,!1,!1,!0,this.direction);if(c.length>0){let l=c[0].pos.x,d=c[0].pos.y,u=this.direction,h=this.targetPlayer;if(this.facePlayer(h),l>i?this.direction=E.RIGHT:l<i?this.direction=E.LEFT:d>s?this.direction=E.DOWN:d<s&&(this.direction=E.UP),u==this.direction){for(const f in this.game.players)this.game.rooms[this.game.players[f].levelID]===this.room&&this.game.players[f].x===l&&this.game.players[f].y===d&&u==this.direction&&(this.game.players[f].hurt(this.hit(),this.name),this.drawX=.5*(this.x-this.game.players[f].x),this.drawY=.5*(this.y-this.game.players[f].y),this.game.players[f]===this.game.players[this.game.localPlayerID]&&this.game.shakeScreen(10*this.drawX,10*this.drawY));this.tryMove(l,d),this.setDrawXY(i,s),this.x>i?this.direction=E.RIGHT:this.x<i?this.direction=E.LEFT:this.y>s?this.direction=E.DOWN:this.y<s&&(this.direction=E.UP)}}this.direction==E.LEFT&&(a.push({x:this.x,y:this.y+1}),a.push({x:this.x,y:this.y-1})),this.direction==E.RIGHT&&(a.push({x:this.x,y:this.y+1}),a.push({x:this.x,y:this.y-1})),this.direction==E.DOWN&&(a.push({x:this.x+1,y:this.y}),a.push({x:this.x-1,y:this.y})),this.direction==E.UP&&(a.push({x:this.x+1,y:this.y}),a.push({x:this.x-1,y:this.y})),this.makeHitWarnings()}let t=Object.values(this.game.offlinePlayers).indexOf(this.targetPlayer)!==-1;if(!this.aggro||t){let i=this.nearestPlayer();if(i!==!1){let[s,a]=i;s<=4&&(t||s<this.playerDistance(this.targetPlayer))&&a!==this.targetPlayer&&(this.targetPlayer=a,this.facePlayer(a),a===this.game.players[this.game.localPlayerID]&&(this.alertTicks=1),this.makeHitWarnings())}}}}});r(this,"draw",t=>{this.dead||(m.ctx.save(),m.ctx.globalAlpha=this.alpha,this.dead||(this.updateDrawXY(t),this.tileX=27,this.tileY=8,(this.health<=1||this.dying)&&(this.tileX=17,this.tileY=8),this.frame+=.1*t,this.frame>=4&&(this.frame=0),this.hasShadow&&this.drawShadow(t),m.drawMob(this.tileX+(this.tileX===5?Math.floor(this.frame):0),this.tileY+this.direction*2,1,2,this.x-this.drawX,this.y-this.drawYOffset-this.drawY,1,2,this.softShadeColor,this.shadeAmount())),this.cloned||(this.seenPlayer||this.drawSleepingZs(t),this.alertTicks>0&&this.drawExclamation(t)),m.ctx.restore())});this.ticks=0,this.frame=0,this.health=2,this.maxHealth=2,this.defaultMaxHealth=2,this.tileX=17,this.tileY=8,this.seenPlayer=!1,this.aggro=!1,this.deathParticleColor="#ffffff",this.name="armored zombie",this.forwardOnlyAttack=!0,this.armored=!0,n&&(this.drop=n),this.getDrop(["weapon","equipment","consumable","tool","coin"])}}r(Ct,"difficulty",2),r(Ct,"tileX",17),r(Ct,"tileY",8);class Gt extends it{constructor(t,i,s,a,n){super(t,i,s,a);r(this,"frame");r(this,"ticks");r(this,"seenPlayer");r(this,"aggro");r(this,"targetPlayer");r(this,"drop");r(this,"hit",()=>this.damage);r(this,"behavior",()=>{if(this.lastX=this.x,this.lastY=this.y,!this.dead){if(this.skipNextTurns>0){this.skipNextTurns--;return}if(this.ticks++,this.seenPlayer){if(this.seenPlayer){if(this.room.playerTicked===this.targetPlayer){this.alertTicks=Math.max(0,this.alertTicks-1);let i=this.x,s=this.y,a=Array();for(const l of this.room.entities)l!==this&&a.push({x:l.x,y:l.y});for(let l=this.x-1;l<=this.x+1;l++)for(let d=this.y-1;d<=this.y+1;d++)this.room.roomArray[l][d]instanceof rt&&this.room.roomArray[l][d].on&&a.push({x:l,y:d});let n=[];for(let l=0;l<this.room.roomX+this.room.width;l++){n[l]=[];for(let d=0;d<this.room.roomY+this.room.height;d++)this.room.roomArray[l]&&this.room.roomArray[l][d]?n[l][d]=this.room.roomArray[l][d]:n[l][d]=!1}let c=yt.AStar.search(n,this,this.targetPlayer,a,!1,!1,void 0,void 0,void 0,!1,this.lastPlayerPos);if(!this.justHurt){if(c.length>0&&!this.unconscious){let l=c[0].pos.x,d=c[0].pos.y;for(const u in this.game.players)this.game.rooms[this.game.players[u].levelID]===this.room&&this.game.players[u].x===l&&this.game.players[u].y===d&&(this.game.players[u].hurt(this.hit(),this.name),this.drawX=.5*(this.x-this.game.players[u].x),this.drawY=.5*(this.y-this.game.players[u].y),this.game.players[u]===this.game.players[this.game.localPlayerID]&&this.game.shakeScreen(10*this.drawX,10*this.drawY));this.tryMove(l,d),this.setDrawXY(i,s)}}this.makeHitWarnings()}let t=Object.values(this.game.offlinePlayers).indexOf(this.targetPlayer)!==-1;if(!this.aggro||t){let i=this.nearestPlayer();if(i!==!1){let[s,a]=i;s<=4&&(t||s<this.playerDistance(this.targetPlayer))&&a!==this.targetPlayer&&(this.targetPlayer=a,this.facePlayer(a),a===this.game.players[this.game.localPlayerID]&&(this.alertTicks=1),this.makeHitWarnings())}}}}else{let t=this.nearestPlayer();if(t!==!1){let[i,s]=t;i<=4&&(this.targetPlayer=s,this.facePlayer(s),this.seenPlayer=!0,s===this.game.players[this.game.localPlayerID]&&(this.alertTicks=1),this.makeHitWarnings())}}}});r(this,"draw",t=>{this.dead||(m.ctx.save(),m.ctx.globalAlpha=this.alpha,this.health<=1||this.cloned,this.dead||(this.updateDrawXY(t),this.frame+=.1*t,this.frame>=4&&(this.frame=0),this.hasShadow&&this.drawShadow(t),m.drawMob(this.tileX+Math.floor(this.frame),this.tileY,1,2,this.x-this.drawX,this.y-this.drawYOffset-this.drawY-this.jumpY,1,2,this.softShadeColor,this.shadeAmount())),this.cloned||(this.seenPlayer||this.drawSleepingZs(t),this.alertTicks>0&&this.drawExclamation(t)),m.ctx.restore())});this.ticks=0,this.frame=0,this.health=1,this.maxHealth=1,this.defaultMaxHealth=1,this.tileX=51,this.tileY=8,this.seenPlayer=!1,this.aggro=!1,this.name="rook",this.orthogonalAttack=!0,this.diagonalAttack=!1,this.jumpHeight=.5,n&&(this.drop=n),this.armored=!0,this.getDrop(["weapon","equipment","consumable","tool","coin"])}}r(Gt,"difficulty",4),r(Gt,"tileX",51),r(Gt,"tileY",8);class Dt extends it{constructor(t,i,s,a,n){super(t,i,s,a);r(this,"frame");r(this,"ticks");r(this,"seenPlayer");r(this,"aggro");r(this,"ticksSinceFirstHit");r(this,"flashingFrame");r(this,"targetPlayer");r(this,"REGEN_TICKS",5);r(this,"drop");r(this,"hit",()=>this.damage);r(this,"hurt",(t,i,s="none")=>{this.handleEnemyCase(t);let a=0;this.shielded&&(a=this.shield.health,a>0&&this.shield.hurt(i)),this.ticksSinceFirstHit=0,this.health==2&&(this.unconscious=!1),this.health-=i,this.maxHealth-=a,this.startHurting(),this.healthBar.hurt(),this.createDamageNumber(i,s),this.playHitSound(),this.health===2&&H.playParry(),this.health===1?(this.unconscious=!0,Ce.spawnCluster(this.room,this.x+.5,this.y+.5,3,28)):this.health===2?Ce.spawnCluster(this.room,this.x+.5,this.y+.5,6,26):this.healthBar.hurt(),this.health<=0?(Ce.spawnCluster(this.room,this.x+.5,this.y+.5,0,24),this.kill()):this.hurtCallback()});r(this,"behavior",()=>{if(this.lastX=this.x,this.lastY=this.y,!this.dead){if(this.skipNextTurns>0){this.skipNextTurns--,this.ticks++;return}if(this.health<=1){this.unconscious=!0,this.ticksSinceFirstHit++,this.ticksSinceFirstHit>=this.REGEN_TICKS&&(this.healthBar.hurt(),this.health=2,this.unconscious=!1),this.ticks++;return}if(this.ticks++,!this.seenPlayer)this.lookForPlayer();else if(this.seenPlayer){if(this.room.playerTicked===this.targetPlayer){this.alertTicks=Math.max(0,this.alertTicks-1);let i=this.x,s=this.y,a=Array();for(const l of this.room.entities)l!==this&&a.push({x:l.x,y:l.y});for(let l=this.x-1;l<=this.x+1;l++)for(let d=this.y-1;d<=this.y+1;d++)this.room.roomArray[l][d]instanceof rt&&this.room.roomArray[l][d].on&&a.push({x:l,y:d});let n=[];for(let l=0;l<this.room.roomX+this.room.width;l++){n[l]=[];for(let d=0;d<this.room.roomY+this.room.height;d++)this.room.roomArray[l]&&this.room.roomArray[l][d]?n[l][d]=this.room.roomArray[l][d]:n[l][d]=!1}let c=yt.AStar.search(n,this,this.targetPlayer,a,!1,!1,!0,this.direction,void 0,void 0);if(c.length>0){let l=c[0].pos.x,d=c[0].pos.y,u=this.direction,h=this.targetPlayer;if(this.facePlayer(h),l>i?this.direction=E.RIGHT:l<i?this.direction=E.LEFT:d>s?this.direction=E.DOWN:d<s&&(this.direction=E.UP),u==this.direction){for(const f in this.game.players)this.game.rooms[this.game.players[f].levelID]===this.room&&this.game.players[f].x===l&&this.game.players[f].y===d&&(this.game.players[f].hurt(this.hit(),this.name),this.drawX=.5*(this.x-this.game.players[f].x),this.drawY=.5*(this.y-this.game.players[f].y),this.game.players[f]===this.game.players[this.game.localPlayerID]&&this.game.shakeScreen(10*this.drawX,10*this.drawY));this.tryMove(l,d),this.setDrawXY(i,s),this.x>i?this.direction=E.RIGHT:this.x<i?this.direction=E.LEFT:this.y>s?this.direction=E.DOWN:this.y<s&&(this.direction=E.UP)}}this.direction==E.LEFT&&(a.push({x:this.x,y:this.y+1}),a.push({x:this.x,y:this.y-1})),this.direction==E.RIGHT&&(a.push({x:this.x,y:this.y+1}),a.push({x:this.x,y:this.y-1})),this.direction==E.DOWN&&(a.push({x:this.x+1,y:this.y}),a.push({x:this.x-1,y:this.y})),this.direction==E.UP&&(a.push({x:this.x+1,y:this.y}),a.push({x:this.x-1,y:this.y})),this.makeHitWarnings()}let t=Object.values(this.game.offlinePlayers).indexOf(this.targetPlayer)!==-1;if(!this.aggro||t){let i=this.nearestPlayer();if(i!==!1){let[s,a]=i;s<=4&&(t||s<this.playerDistance(this.targetPlayer))&&a!==this.targetPlayer&&(this.targetPlayer=a,this.facePlayer(a),a===this.game.players[this.game.localPlayerID]&&(this.alertTicks=1),this.makeHitWarnings())}}}}});r(this,"draw",t=>{this.dead||(m.ctx.save(),m.ctx.globalAlpha=this.alpha,this.dead||(this.updateDrawXY(t),this.tileX=27,this.tileY=16,this.health<=2&&(this.tileX=5,this.tileY=8),(this.health<=1||this.dying)&&(this.tileX=3,this.tileY=0,this.ticksSinceFirstHit>=3&&(this.flashingFrame+=.1*t,Math.floor(this.flashingFrame)%2===0&&(this.tileX=2))),this.frame+=.1*t,this.frame>=4&&(this.frame=0),this.hasShadow&&this.drawShadow(t),m.drawMob(this.tileX+(this.tileX%5&&!this.unconscious&&!this.dying?Math.floor(this.frame):0),this.tileY+this.direction*2,1,2,this.x-this.drawX,this.y-this.drawYOffset-this.drawY-this.jumpY,1,2,this.softShadeColor,this.shadeAmount())),this.cloned||(this.seenPlayer||this.drawSleepingZs(t),this.alertTicks>0&&this.drawExclamation(t)),m.ctx.restore())});!this.cloned&&(this.ticks=0,this.frame=0,this.health=3,this.maxHealth=3,this.defaultMaxHealth=3,this.tileX=17,this.tileY=16,this.seenPlayer=!1,this.aggro=!1,this.ticksSinceFirstHit=0,this.flashingFrame=0,this.deathParticleColor="#ffffff",this.name="armored skeleton",this.forwardOnlyAttack=!0,this.armored=!0,n&&(this.drop=n),this.getDrop(["weapon","consumable","tool","coin"]))}}r(Dt,"difficulty",2),r(Dt,"tileX",5),r(Dt,"tileY",8);class he extends it{constructor(t,i,s,a,n){super(t,i,s,a);r(this,"ticks");r(this,"frame");r(this,"seenPlayer");r(this,"aggro");r(this,"targetPlayer");r(this,"drop");r(this,"state");r(this,"revealTick");r(this,"jumpDistance");r(this,"hit",()=>this.damage);r(this,"toggleReveal",()=>{let t=this.ticks-this.revealTick;this.state===2&&t>8&&(this.state=1),this.revealTick=this.ticks});r(this,"jump",t=>{let i=Math.max(Math.abs(this.drawX),Math.abs(this.drawY));i>1&&(this.jumpDistance=2),this.jumpY=Math.sin(i/this.jumpDistance*Math.PI)*this.jumpHeight,this.jumpY<.01&&this.jumpY>-.01&&(this.jumpY=0,this.jumpDistance=1),this.jumpY>this.jumpHeight&&(this.jumpY=this.jumpHeight)});r(this,"isTileFree",(t,i)=>{if(!this.room.roomArray[t]||!this.room.roomArray[t][i])return!1;const s=this.room.roomArray[t][i];if(s.isSolid()||s instanceof rt&&s.on)return!1;for(const a of this.room.entities)if(a!==this&&a.x===t&&a.y===i)return!1;return!0});r(this,"getTwoTileCandidates",(t,i)=>{const s=[{dx:1,dy:0,axis:"x"},{dx:-1,dy:0,axis:"x"},{dx:0,dy:1,axis:"y"},{dx:0,dy:-1,axis:"y"}],a=[];for(const n of s){const c=t+n.dx,l=i+n.dy,d=t+2*n.dx,u=i+2*n.dy;this.isTileFree(c,l)&&this.isTileFree(d,u)&&a.push({endX:d,endY:u,axis:n.axis,dx:n.dx,dy:n.dy})}return a});r(this,"pickBestCandidate",(t,i,s,a,n,c)=>{const l=n===0?0:n>0?1:-1,d=c===0?0:c>0?1:-1;return t.sort((u,h)=>{const f=Math.abs(u.endX-i)+Math.abs(u.endY-s),p=Math.abs(h.endX-i)+Math.abs(h.endY-s);if(f!==p)return f-p;if(a){if(u.axis!==h.axis)return u.axis==="x"?-1:1}else if(u.axis!==h.axis)return u.axis==="y"?-1:1;const y=(u.dx!==0?u.dx===l:u.dy===d)?-1:1,g=(h.dx!==0?h.dx===l:h.dy===d)?-1:1;return y!==g?y-g:0}),t[0]});r(this,"getOneTileCandidates",(t,i)=>{const s=[{dx:1,dy:0},{dx:-1,dy:0},{dx:0,dy:1},{dx:0,dy:-1}],a=[];for(const n of s){const c=t+n.dx,l=i+n.dy;this.isTileFree(c,l)&&a.push({x:c,y:l})}return a});r(this,"pickBestOneTileCandidate",(t,i,s,a,n,c)=>(t.sort((l,d)=>{const u=Math.abs(l.x-i)+Math.abs(l.y-s),h=Math.abs(d.x-i)+Math.abs(d.y-s);if(u!==h)return u-h;const f=Math.abs(l.x-i)>Math.abs(l.y-s)?"x":"y",p=Math.abs(d.x-i)>Math.abs(d.y-s)?"x":"y";if(a){if(f!==p)return f==="x"?-1:1}else if(f!==p)return f==="y"?-1:1;const y=(l.x>i?n<0:l.x<i?n>0:l.y>s?c<0:l.y<s&&c>0)?-1:1,g=(d.x>i?n<0:d.x<i?n>0:d.y>s?c<0:d.y<s&&c>0)?-1:1;return y!==g?y-g:0}),t[0]));r(this,"attackOrMoveTo",(t,i,s,a)=>{let n=!1;for(const c in this.game.players)this.game.rooms[this.game.players[c].levelID]===this.room&&this.game.players[c].x===t&&this.game.players[c].y===i&&(this.game.players[c].hurt(this.hit(),this.name),this.drawX=.5*(this.x-this.game.players[c].x),this.drawY=.5*(this.y-this.game.players[c].y),this.game.players[c]===this.game.players[this.game.localPlayerID]&&this.game.shakeScreen(10*this.drawX,10*this.drawY),n=!0);n||(this.tryMove(t,i),this.setDrawXY(s,a),this.x>s?this.direction=E.RIGHT:this.x<s?this.direction=E.LEFT:this.y>a?this.direction=E.DOWN:this.y<a&&(this.direction=E.UP))});r(this,"behavior",()=>{if(this.lastX=this.x,this.lastY=this.y,!this.dead){if(this.skipNextTurns>0){this.skipNextTurns--;return}if(this.rumbling=this.ticks%2===1,!this.seenPlayer)this.lookForPlayer();else if(this.seenPlayer){if(this.room.playerTicked===this.targetPlayer)if(this.alertTicks=Math.max(0,this.alertTicks-1),this.ticks++,this.ticks%2===1){this.rumbling=!0;let i=this.x,s=this.y,a=Array();for(const g of this.room.entities)g!==this&&a.push({x:g.x,y:g.y});for(let g=this.x-1;g<=this.x+1;g++)for(let w=this.y-1;w<=this.y+1;w++)this.room.roomArray[g][w]instanceof rt&&this.room.roomArray[g][w].on&&a.push({x:g,y:w});let n=[];for(let g=0;g<this.room.roomX+this.room.width;g++){n[g]=[];for(let w=0;w<this.room.roomY+this.room.height;w++)this.room.roomArray[g]&&this.room.roomArray[g][w]?n[g][w]=this.room.roomArray[g][w]:n[g][w]=!1}this.target=this.getAverageLuminance()>0?this.targetPlayer:this.room.getExtremeLuminanceFromPoint(this.x,this.y).darkest;let c={x:this.targetPlayer.x,y:this.targetPlayer.y};const l=Math.abs(this.targetPlayer.x-this.x)+Math.abs(this.targetPlayer.y-this.y);if(this.target===this.targetPlayer&&l===2){let g=this.targetPlayer.lastX-this.x,w=this.targetPlayer.lastY-this.y;if(g!==0&&w!==0&&(Math.abs(g)>=Math.abs(w)?w=0:g=0),g===0&&Math.abs(w)<=1||w===0&&Math.abs(g)<=1){const b=this.targetPlayer.x+Math.sign(g),T=this.targetPlayer.y+Math.sign(w);this.room.roomArray[b]&&this.room.roomArray[b][T]&&!this.room.roomArray[b][T].isSolid()&&(c={x:b,y:T})}}else this.target!==this.targetPlayer&&(c={x:this.target.x,y:this.target.y});const d=c.x-i,u=c.y-s,h=Math.abs(d)>=Math.abs(u);let f=this.x,p=this.y;const y=yt.AStar.search(n,this,c,a,!1,!1,!1,void 0,void 0,!1,this.lastPlayerPos);if(y.length>0){let g=y[0];const w=y[1];if(w){const T=w.pos.x===i||w.pos.y===s,v=h?w.pos.y===s:w.pos.x===i;T&&v&&(g=w)}if(f=g.pos.x,p=g.pos.y,Math.abs(f-i)+Math.abs(p-s)===1){const T=f-i,v=p-s,k=f+(T!==0?Math.sign(T):0),D=p+(v!==0?Math.sign(v):0);this.isTileFree(k,D)&&(f=k,p=D)}}if(l===1){const g=this.getOneTileCandidates(i,s);if(g.length>0){const w=this.pickBestOneTileCandidate(g,c.x,c.y,h,d,u);this.attackOrMoveTo(w.x,w.y,i,s)}}else if(Math.abs(f-i)+Math.abs(p-s)>=1)this.attackOrMoveTo(f,p,i,s);else{const w=this.getTwoTileCandidates(i,s);if(w.length>0){const b=this.pickBestCandidate(w,c.x,c.y,h,d,u);this.attackOrMoveTo(b.endX,b.endY,i,s)}else{const b=this.getOneTileCandidates(i,s);if(b.length>0){const T=this.pickBestOneTileCandidate(b,c.x,c.y,h,d,u);this.attackOrMoveTo(T.x,T.y,i,s)}}}this.rumbling=!1}else this.rumbling=!0,this.makeHitWarnings();let t=Object.values(this.game.offlinePlayers).indexOf(this.targetPlayer)!==-1;if(!this.aggro||t){let i=this.nearestPlayer();if(i!==!1){let[s,a]=i;s<=4&&(t||s<this.playerDistance(this.targetPlayer))&&a!==this.targetPlayer&&(this.targetPlayer=a,this.facePlayer(a),a===this.game.players[this.game.localPlayerID]&&(this.alertTicks=1),this.ticks%2===0&&(this.rumbling=!0,this.makeHitWarnings()))}}}}});r(this,"makeHitWarnings",()=>{const i=this.getPlayer(),s=this.orthogonalAttack,a=this.diagonalAttack,n=this.forwardOnlyAttack,c=this.direction,l=this.attackRange,d=this.diagonalAttackRange,u=(w,b)=>(w?[[-2,0],[2,0],[0,-2],[0,2],[-1,0],[1,0],[0,-1],[0,1]]:[[-1,-1],[1,1],[1,-1],[-1,1]]).flatMap(([v,k])=>Array.from({length:b},(D,N)=>[(N+1)*v,(N+1)*k])),h={[E.LEFT]:[-1,0],[E.RIGHT]:[1,0],[E.UP]:[0,-1],[E.DOWN]:[0,1]};let f=[];if(n){const[w,b]=h[c];f=Array.from({length:l},(T,v)=>[(v+1)*w,(v+1)*b])}else s&&f.push(...u(!0,l)),a&&f.push(...u(!1,d));const p=f.map(([w,b])=>({x:w,y:b,distance:Q.distance(w,b,i.x-this.x,i.y-this.y)})).sort((w,b)=>w.distance-b.distance),y=Math.ceil(p.length*(1-.25));p.slice(0,y).forEach(({x:w,y:b})=>{const T=this.x+w,v=this.y+b;if(this.isWithinRoomBounds(T,v)){const k=new Ht(this.game,T,v,this.x,this.y,!0,!1,this);this.room.hitwarnings.push(k)}})});r(this,"draw",t=>{if(!this.dead){if(m.ctx.save(),m.ctx.globalAlpha=this.alpha,!this.dead){switch(this.updateDrawXY(t),this.ticks%2===0?(this.tileX=11,this.tileY=4):(this.tileX=11,this.tileY=4),this.direction){case E.UP:break;case E.LEFT:break;case E.RIGHT:break}let i=Math.max(this.rumble(this.rumbling,this.frame,this.direction).x,Math.max(this.rumble(this.rumbling,this.frame,this.direction).y));this.frame+=.1*t,this.frame>=4&&(this.frame=0),this.hasShadow&&this.drawShadow(t),this.state===0&&m.drawMob(this.tileX,this.tileY,2,2,this.x-this.drawX+i-.5,this.y-this.drawYOffset-this.drawY-this.jumpY,2*this.crushX,2*this.crushY,this.softShadeColor,this.shadeAmount()),this.crushed&&this.crushAnim(t)}this.cloned||(this.seenPlayer||this.drawSleepingZs(t,0,.75*x.TILESIZE),this.alertTicks>0&&this.drawExclamation(t,0,.75*x.TILESIZE)),m.ctx.restore()}});this.ticks=0,this.frame=0,this.health=1,this.maxHealth=1,this.defaultMaxHealth=1,this.tileX=11,this.tileY=4,this.seenPlayer=!1,this.aggro=!1,this.name="spider",this.orthogonalAttack=!0,this.diagonalAttack=!1,this.imageParticleX=3,this.imageParticleY=24,this.state=0,this.drawYOffset=1.2,this.revealTick=0,this.hasShadow=!0,this.jumpHeight=1,this.jumpDistance=1,this.getDrop(["weapon","equipment","consumable","tool","coin"])}get alertText(){return`New Enemy Spotted: Spider 
    Health: ${this.health}
    Attack Pattern: Omnidirectional
    Moves every other turn`}}r(he,"difficulty",1),r(he,"tileX",8),r(he,"tileY",4);class be extends it{constructor(t,i,s,a,n){super(t,i,s,a);r(this,"frame");r(this,"ticks");r(this,"seenPlayer");r(this,"aggro");r(this,"targetPlayer");r(this,"drop");r(this,"dir");r(this,"hit",()=>this.damage);r(this,"poison",()=>{});r(this,"bleed",()=>{});r(this,"behavior",()=>{if(this.lastX=this.x,this.lastY=this.y,!this.dead){if(this.skipNextTurns>0){this.skipNextTurns--;return}if(this.ticks++,!this.seenPlayer)this.lookForPlayer();else if(this.seenPlayer){if(this.room.playerTicked===this.targetPlayer){this.alertTicks=Math.max(0,this.alertTicks-1);let i=this.x,s=this.y,a=Array();for(const l of this.room.entities)l!==this&&a.push({x:l.x,y:l.y});for(let l=this.x-1;l<=this.x+1;l++)for(let d=this.y-1;d<=this.y+1;d++)this.room.roomArray[l][d]instanceof rt&&this.room.roomArray[l][d].on&&a.push({x:l,y:d});let n=[];for(let l=0;l<this.room.roomX+this.room.width;l++){n[l]=[];for(let d=0;d<this.room.roomY+this.room.height;d++)this.room.roomArray[l]&&this.room.roomArray[l][d]?n[l][d]=this.room.roomArray[l][d]:n[l][d]=!1}let c=yt.AStar.search(n,this,this.targetPlayer,a,!1,!1,!0,this.direction);if(c.length>0){let l=c[0].pos.x,d=c[0].pos.y,u=this.direction,h=this.targetPlayer;if(this.facePlayer(h),l>i?this.direction=E.RIGHT:l<i?this.direction=E.LEFT:d>s?this.direction=E.DOWN:d<s&&(this.direction=E.UP),u==this.direction){for(const f in this.game.players)this.game.rooms[this.game.players[f].levelID]===this.room&&this.game.players[f].x===l&&this.game.players[f].y===d&&(this.game.players[f].hurt(this.hit(),this.name),this.drawX=.5*(this.x-this.game.players[f].x),this.drawY=.5*(this.y-this.game.players[f].y),this.game.players[f]===this.game.players[this.game.localPlayerID]&&this.game.shakeScreen(10*this.drawX,10*this.drawY));this.tryMove(l,d),this.setDrawXY(i,s),this.x>i?this.direction=E.RIGHT:this.x<i?this.direction=E.LEFT:this.y>s?this.direction=E.DOWN:this.y<s&&(this.direction=E.UP)}}this.direction==E.LEFT&&(a.push({x:this.x,y:this.y+1}),a.push({x:this.x,y:this.y-1})),this.direction==E.RIGHT&&(a.push({x:this.x,y:this.y+1}),a.push({x:this.x,y:this.y-1})),this.direction==E.DOWN&&(a.push({x:this.x+1,y:this.y}),a.push({x:this.x-1,y:this.y})),this.direction==E.UP&&(a.push({x:this.x+1,y:this.y}),a.push({x:this.x-1,y:this.y})),this.makeHitWarnings()}let t=Object.values(this.game.offlinePlayers).indexOf(this.targetPlayer)!==-1;if(!this.aggro||t){let i=this.nearestPlayer();if(i!==!1){let[s,a]=i;s<=4&&(t||s<this.playerDistance(this.targetPlayer))&&a!==this.targetPlayer&&(this.targetPlayer=a,this.facePlayer(a),a===this.game.players[this.game.localPlayerID]&&(this.alertTicks=1),this.makeHitWarnings())}}}}});r(this,"draw",t=>{this.dead||(m.ctx.globalAlpha=this.alpha,this.updateDrawXY(t),this.frame+=.1*t,this.frame>=4&&(this.frame=0),this.hasShadow&&this.drawShadow(t),m.drawMob(this.tileX+Math.floor(this.frame),this.tileY+this.direction*2,1,2,this.x-this.drawX,this.y-this.drawYOffset-this.drawY-this.jumpY,1,2,this.softShadeColor,this.shadeAmount()),this.cloned||(this.seenPlayer||this.drawSleepingZs(t),this.alertTicks>0&&this.drawExclamation(t)),m.ctx.globalAlpha=1)});this.ticks=0,this.frame=0,this.health=1,this.maxHealth=1,this.defaultMaxHealth=1,this.tileX=17,this.tileY=16,this.seenPlayer=!1,this.aggro=!1,this.dir=E.DOWN,this.name="mummy",this.forwardOnlyAttack=!0,this.jumpHeight=.35,this.alertRange=2,this.baseDamage=.5,n&&(this.drop=n),this.getDrop(["consumable","tool","coin"])}}r(be,"difficulty",1),r(be,"tileX",17),r(be,"tileY",16);class Le extends it{constructor(t,i,s,a,n){super(t,i,s,a);r(this,"frame");r(this,"ticks");r(this,"seenPlayer");r(this,"aggro");r(this,"targetPlayer");r(this,"drop");r(this,"hit",()=>this.damage);r(this,"lookForPlayer",(t=!0)=>{if(this.seenPlayer)return;const i=this.nearestPlayer();if(i===!1)return;const[s,a]=i;s>this.alertRange||(this.targetPlayer=a,t&&this.facePlayer(a),this.seenPlayer=!0,ht.emit("EnemySeenPlayer",{enemyType:this.constructor.name,enemyName:this.name}),a===this.game.players[this.game.localPlayerID]&&(this.alertTicks=1),this.conditionalHitWarnings())});r(this,"behavior",()=>{var t;if(this.lastX=this.x,this.lastY=this.y,!this.dead){if(this.skipNextTurns>0){this.skipNextTurns--;return}if(this.ticks++,this.seenPlayer){if(this.seenPlayer){if(this.room.playerTicked===this.targetPlayer){this.alertTicks=Math.max(0,this.alertTicks-1);let s=this.x,a=this.y,n=Array();for(const d of this.room.entities)d!==this&&n.push({x:d.x,y:d.y});for(let d=this.x-1;d<=this.x+1;d++)for(let u=this.y-1;u<=this.y+1;u++)this.room.roomArray[d][u]instanceof rt&&this.room.roomArray[d][u].on&&n.push({x:d,y:u});const c=this.targetPlayer.x-this.x,l=this.targetPlayer.y-this.y;if(Math.abs(c)===1&&Math.abs(l)===1&&!this.unconscious){this.targetPlayer.hurt(this.hit(),this.name),this.drawX=.5*(this.x-this.targetPlayer.x),this.drawY=.5*(this.y-this.targetPlayer.y),this.targetPlayer===this.game.players[this.game.localPlayerID]&&this.game.shakeScreen(10*this.drawX,10*this.drawY),this.conditionalHitWarnings();return}if(!this.justHurt){if(!this.unconscious){let d=0,u=0;Math.abs(c)>Math.abs(l)?d=Math.sign(c):Math.abs(l)>0&&(u=Math.sign(l));const h=this.x+d,f=this.y+u,p=this.targetPlayer.x===h&&this.targetPlayer.y===f,y=(t=this.room.roomArray[h])==null?void 0:t[f],g=y instanceof rt&&y.on;!p&&!g&&(this.tryMove(h,f),this.setDrawXY(s,a)),this.conditionalHitWarnings()}}}let i=Object.values(this.game.offlinePlayers).indexOf(this.targetPlayer)!==-1;if(!this.aggro||i){let s=this.nearestPlayer();if(s!==!1){let[a,n]=s;a<=4&&(i||a<this.playerDistance(this.targetPlayer))&&n!==this.targetPlayer&&(this.targetPlayer=n,this.facePlayer(n),n===this.game.players[this.game.localPlayerID]&&(this.alertTicks=1),this.conditionalHitWarnings())}}}}else{let i=this.nearestPlayer();if(i!==!1){let[s,a]=i;s<=4&&(this.targetPlayer=a,this.facePlayer(a),this.seenPlayer=!0,a===this.game.players[this.game.localPlayerID]&&(this.alertTicks=1),this.conditionalHitWarnings())}}}});r(this,"conditionalHitWarnings",()=>{const t=Q.distance(this.x,this.y,this.targetPlayer.x,this.targetPlayer.y);(t>=2||!this.targetPlayer)&&this.makeHitWarnings(void 0,void 0,!0,"orthogonal"),t<3&&this.targetPlayer&&this.makeHitWarnings()});r(this,"draw",t=>{this.dead||(m.ctx.save(),m.ctx.globalAlpha=this.alpha,this.dead||(this.updateDrawXY(t),this.frame+=.1*t,this.frame>=4&&(this.frame=0),this.hasShadow&&this.drawShadow(t),m.drawMob(this.tileX+Math.floor(this.frame),this.tileY,1,2,this.x-this.drawX,this.y-this.drawYOffset-this.drawY-this.jumpY,1,2,this.softShadeColor,this.shadeAmount())),this.cloned||(this.seenPlayer||this.drawSleepingZs(t),this.alertTicks>0&&this.drawExclamation(t)),m.ctx.restore())});this.ticks=0,this.frame=0,this.health=1,this.maxHealth=1,this.defaultMaxHealth=1,this.tileX=23,this.tileY=12,this.seenPlayer=!1,this.aggro=!1,this.name="pawn",this.orthogonalAttack=!1,this.diagonalAttack=!0,this.jumpHeight=.5,n&&(this.drop=n),this.armored=!0,this.getDrop(["weapon","equipment","consumable","tool","coin"])}}r(Le,"difficulty",4),r(Le,"tileX",51),r(Le,"tileY",8);class Li extends it{constructor(t,i,s,a,n){super(t,i,s,a);r(this,"ticks");r(this,"frame");r(this,"seenPlayer");r(this,"aggro");r(this,"targetPlayer");r(this,"drop");r(this,"revealTick");r(this,"jumpDistance");r(this,"hit",()=>this.damage);r(this,"toggleReveal",()=>{this.ticks-this.revealTick,this.revealTick=this.ticks});r(this,"jump",t=>{let i=Math.max(Math.abs(this.drawX),Math.abs(this.drawY));i>1&&(this.jumpDistance=2),this.jumpY=Math.sin(i/this.jumpDistance*Math.PI)*this.jumpHeight,this.jumpY<.01&&this.jumpY>-.01&&(this.jumpY=0,this.jumpDistance=1),this.jumpY>this.jumpHeight&&(this.jumpY=this.jumpHeight)});r(this,"isTileFree",(t,i)=>{if(!this.room.roomArray[t]||!this.room.roomArray[t][i])return!1;const s=this.room.roomArray[t][i];if(s.isSolid()||s instanceof rt&&s.on)return!1;for(const a of this.room.entities)if(a!==this&&a.x===t&&a.y===i)return!1;return!0});r(this,"getTwoTileCandidates",(t,i)=>{const s=[{dx:1,dy:0,axis:"x"},{dx:-1,dy:0,axis:"x"},{dx:0,dy:1,axis:"y"},{dx:0,dy:-1,axis:"y"}],a=[];for(const n of s){const c=t+n.dx,l=i+n.dy,d=t+2*n.dx,u=i+2*n.dy;this.isTileFree(c,l)&&this.isTileFree(d,u)&&a.push({endX:d,endY:u,axis:n.axis,dx:n.dx,dy:n.dy})}return a});r(this,"pickBestCandidate",(t,i,s,a,n,c)=>{const l=n===0?0:n>0?1:-1,d=c===0?0:c>0?1:-1;return t.sort((u,h)=>{const f=Math.abs(u.endX-i)+Math.abs(u.endY-s),p=Math.abs(h.endX-i)+Math.abs(h.endY-s);if(f!==p)return f-p;if(a){if(u.axis!==h.axis)return u.axis==="x"?-1:1}else if(u.axis!==h.axis)return u.axis==="y"?-1:1;const y=(u.dx!==0?u.dx===l:u.dy===d)?-1:1,g=(h.dx!==0?h.dx===l:h.dy===d)?-1:1;return y!==g?y-g:0}),t[0]});r(this,"getOneTileCandidates",(t,i)=>{const s=[{dx:1,dy:0},{dx:-1,dy:0},{dx:0,dy:1},{dx:0,dy:-1}],a=[];for(const n of s){const c=t+n.dx,l=i+n.dy;this.isTileFree(c,l)&&a.push({x:c,y:l})}return a});r(this,"pickBestOneTileCandidate",(t,i,s,a,n,c)=>(t.sort((l,d)=>{const u=Math.abs(l.x-i)+Math.abs(l.y-s),h=Math.abs(d.x-i)+Math.abs(d.y-s);if(u!==h)return u-h;const f=Math.abs(l.x-i)>Math.abs(l.y-s)?"x":"y",p=Math.abs(d.x-i)>Math.abs(d.y-s)?"x":"y";if(a){if(f!==p)return f==="x"?-1:1}else if(f!==p)return f==="y"?-1:1;const y=(l.x>i?n<0:l.x<i?n>0:l.y>s?c<0:l.y<s&&c>0)?-1:1,g=(d.x>i?n<0:d.x<i?n>0:d.y>s?c<0:d.y<s&&c>0)?-1:1;return y!==g?y-g:0}),t[0]));r(this,"attackOrMoveTo",(t,i,s,a)=>{let n=!1;for(const c in this.game.players)this.game.rooms[this.game.players[c].levelID]===this.room&&this.game.players[c].x===t&&this.game.players[c].y===i&&(this.game.players[c].hurt(this.hit(),this.name),this.drawX=.5*(this.x-this.game.players[c].x),this.drawY=.5*(this.y-this.game.players[c].y),this.game.players[c]===this.game.players[this.game.localPlayerID]&&this.game.shakeScreen(10*this.drawX,10*this.drawY),n=!0);n||(this.tryMove(t,i),this.setDrawXY(s,a),this.x>s?this.direction=E.RIGHT:this.x<s?this.direction=E.LEFT:this.y>a?this.direction=E.DOWN:this.y<a&&(this.direction=E.UP))});r(this,"behavior",()=>{if(this.lastX=this.x,this.lastY=this.y,!this.dead){if(this.skipNextTurns>0){this.skipNextTurns--;return}if(!this.seenPlayer)this.lookForPlayer();else if(this.seenPlayer){if(this.room.playerTicked===this.targetPlayer)if(this.alertTicks=Math.max(0,this.alertTicks-1),this.ticks++,this.ticks%2===1){this.rumbling=!0;let i=this.x,s=this.y,a=Array();for(const g of this.room.entities)g!==this&&a.push({x:g.x,y:g.y});for(let g=this.x-1;g<=this.x+1;g++)for(let w=this.y-1;w<=this.y+1;w++)this.room.roomArray[g][w]instanceof rt&&this.room.roomArray[g][w].on&&a.push({x:g,y:w});let n=[];for(let g=0;g<this.room.roomX+this.room.width;g++){n[g]=[];for(let w=0;w<this.room.roomY+this.room.height;w++)this.room.roomArray[g]&&this.room.roomArray[g][w]?n[g][w]=this.room.roomArray[g][w]:n[g][w]=!1}this.target=this.getAverageLuminance()>0?this.targetPlayer:this.room.getExtremeLuminanceFromPoint(this.x,this.y).darkest;let c={x:this.targetPlayer.x,y:this.targetPlayer.y};const l=Math.abs(this.targetPlayer.x-this.x)+Math.abs(this.targetPlayer.y-this.y);if(this.target===this.targetPlayer&&l===2){let g=this.targetPlayer.lastX-this.x,w=this.targetPlayer.lastY-this.y;if(g!==0&&w!==0&&(Math.abs(g)>=Math.abs(w)?w=0:g=0),g===0&&Math.abs(w)<=1||w===0&&Math.abs(g)<=1){const b=this.targetPlayer.x+Math.sign(g),T=this.targetPlayer.y+Math.sign(w);this.room.roomArray[b]&&this.room.roomArray[b][T]&&!this.room.roomArray[b][T].isSolid()&&(c={x:b,y:T})}}else this.target!==this.targetPlayer&&(c={x:this.target.x,y:this.target.y});const d=c.x-i,u=c.y-s,h=Math.abs(d)>=Math.abs(u);let f=this.x,p=this.y;const y=yt.AStar.search(n,this,c,a,!1,!1,!1,void 0,void 0,!1,this.lastPlayerPos);if(y.length>0){let g=y[0];const w=y[1];if(w){const T=w.pos.x===i||w.pos.y===s,v=h?w.pos.y===s:w.pos.x===i;T&&v&&(g=w)}if(f=g.pos.x,p=g.pos.y,Math.abs(f-i)+Math.abs(p-s)===1){const T=f-i,v=p-s,k=f+(T!==0?Math.sign(T):0),D=p+(v!==0?Math.sign(v):0);this.isTileFree(k,D)&&(f=k,p=D)}}if(l===1){const g=this.getOneTileCandidates(i,s);if(g.length>0){const w=this.pickBestOneTileCandidate(g,c.x,c.y,h,d,u);this.attackOrMoveTo(w.x,w.y,i,s)}}else if(Math.abs(f-i)+Math.abs(p-s)>=1)this.attackOrMoveTo(f,p,i,s);else{const w=this.getTwoTileCandidates(i,s);if(w.length>0){const b=this.pickBestCandidate(w,c.x,c.y,h,d,u);this.attackOrMoveTo(b.endX,b.endY,i,s)}else{const b=this.getOneTileCandidates(i,s);if(b.length>0){const T=this.pickBestOneTileCandidate(b,c.x,c.y,h,d,u);this.attackOrMoveTo(T.x,T.y,i,s)}}}this.rumbling=!1}else this.rumbling=!0,this.makeHitWarnings();let t=Object.values(this.game.offlinePlayers).indexOf(this.targetPlayer)!==-1;if(!this.aggro||t){let i=this.nearestPlayer();if(i!==!1){let[s,a]=i;s<=4&&(t||s<this.playerDistance(this.targetPlayer))&&a!==this.targetPlayer&&(this.targetPlayer=a,this.facePlayer(a),a===this.game.players[this.game.localPlayerID]&&(this.alertTicks=1),this.ticks%2===0&&this.makeHitWarnings())}}}}});r(this,"makeHitWarnings",()=>{const i=this.getPlayer(),s=this.orthogonalAttack,a=this.diagonalAttack,n=this.forwardOnlyAttack,c=this.direction,l=this.attackRange,d=this.diagonalAttackRange,u=(w,b)=>(w?[[-2,0],[2,0],[0,-2],[0,2],[-1,0],[1,0],[0,-1],[0,1]]:[[-1,-1],[1,1],[1,-1],[-1,1]]).flatMap(([v,k])=>Array.from({length:b},(D,N)=>[(N+1)*v,(N+1)*k])),h={[E.LEFT]:[-1,0],[E.RIGHT]:[1,0],[E.UP]:[0,-1],[E.DOWN]:[0,1]};let f=[];if(n){const[w,b]=h[c];f=Array.from({length:l},(T,v)=>[(v+1)*w,(v+1)*b])}else s&&f.push(...u(!0,l)),a&&f.push(...u(!1,d));const p=f.map(([w,b])=>({x:w,y:b,distance:Q.distance(w,b,i.x-this.x,i.y-this.y)})).sort((w,b)=>w.distance-b.distance),y=Math.ceil(p.length*(1-.25));p.slice(0,y).forEach(({x:w,y:b})=>{const T=this.x+w,v=this.y+b;if(this.isWithinRoomBounds(T,v)){const k=new Ht(this.game,T,v,this.x,this.y,!0,!1,this);this.room.hitwarnings.push(k)}})});r(this,"draw",t=>{if(!this.dead){if(m.ctx.save(),m.ctx.globalAlpha=this.alpha,!this.dead){switch(this.updateDrawXY(t),this.ticks%2===0?(this.tileX=13,this.tileY=4):(this.tileX=13,this.tileY=4),this.direction){case E.UP:break;case E.LEFT:break;case E.RIGHT:break}let i=Math.max(this.rumble(this.rumbling,this.frame,this.direction).x,Math.max(this.rumble(this.rumbling,this.frame,this.direction).y));this.frame+=.1*t,this.frame>=4&&(this.frame=0),this.hasShadow&&this.drawShadow(t),m.drawMob(this.tileX,this.tileY,2,2,this.x-this.drawX+i-.5,this.y-this.drawYOffset-this.drawY-this.jumpY,2*this.crushX,2*this.crushY,this.softShadeColor,this.shadeAmount()),this.crushed&&this.crushAnim(t)}this.cloned||(this.seenPlayer||this.drawSleepingZs(t,0,.75*x.TILESIZE),this.alertTicks>0&&this.drawExclamation(t,0,.75*x.TILESIZE)),m.ctx.restore()}});this.ticks=0,this.frame=0,this.health=1,this.maxHealth=1,this.defaultMaxHealth=1,this.tileX=13,this.tileY=4,this.seenPlayer=!1,this.aggro=!1,this.name="beetle",this.orthogonalAttack=!0,this.diagonalAttack=!1,this.imageParticleX=3,this.imageParticleY=24,this.drawYOffset=1.2,this.revealTick=0,this.hasShadow=!0,this.jumpHeight=1,this.jumpDistance=1,this.attackRange=1,this.getDrop(["weapon","equipment","consumable","tool","coin"])}get alertText(){return`New Enemy Spotted: Beetle 
    Health: ${this.health}
    Attack Pattern: Omnidirectional
    Moves every other turn`}}r(Li,"difficulty",1),r(Li,"tileX",8),r(Li,"tileY",4);const _s=class _s extends it{constructor(t,i,s,a,n=[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,16,17,18,19]){super(t,i,s,a);r(this,"ticks");r(this,"seenPlayer");r(this,"enemySpawnType");r(this,"enemyTable");r(this,"spawnFrequency");r(this,"spawnOffset");r(this,"hit",()=>1);r(this,"setSpawnFrequency",(t=1)=>{this.spawnFrequency=4,this.spawnFrequency=3+t;const i=this.room.entities.filter(s=>s instanceof _s);this.spawnOffset=(i.indexOf(this)+1)*4});r(this,"behavior",()=>{if(this.lastX=this.x,this.lastY=this.y,!this.dead){if(this.skipNextTurns>0){this.skipNextTurns--;return}if(this.tileX=6,(this.ticks+this.spawnOffset)%this.spawnFrequency===0){let t=this.room.getEmptyTiles().filter(i=>Math.abs(i.x-this.x)<=1&&Math.abs(i.y-this.y)<=1);if(this.enemySpawnType===8){const i=[{x:this.x,y:this.y},{x:this.x+1,y:this.y+1},{x:this.x-1,y:this.y-1},{x:this.x+1,y:this.y-1},{x:this.x-1,y:this.y+1}];t=t.filter(s=>!i.some(a=>a.x===s.x&&a.y===s.y))}if(t.length>0){this.tileX=7;const i=m.randTable(t,O.rand);let s;switch(this.enemySpawnType){case 0:s=new Le(this.room,this.game,i.x,i.y);break;case 1:s=new Bt(this.room,this.game,i.x,i.y);break;case 2:s=new fe(this.room,this.game,i.x,i.y);break;case 3:s=new te(this.room,this.game,i.x,i.y);break;case 4:s=new _t(this.room,this.game,i.x,i.y);break;case 5:s=new Mt(this.room,this.game,i.x,i.y);break;case 6:s=new Ft(this.room,this.game,i.x,i.y);break;case 7:s=new Gt(this.room,this.game,i.x,i.y);break;case 8:s=new Pt(this.room,this.game,i.x,i.y);break;case 9:s=new Ct(this.room,this.game,i.x,i.y);break;case 10:if(this.room.type!==R.BIGDUNGEON){s=new _t(this.room,this.game,i.x,i.y);break}s=new Nt(this.room,this.game,i.x,i.y);for(let a=0;a<2;a++)for(let n=0;n<2;n++)this.room.roomArray[i.x+a][i.y+n]=new bt(this.room,i.x+a,i.y+n);break;case 11:s=new Xt(this.room,this.game,i.x,i.y);break;case 12:s=new Lt(this.room,this.game,i.x,i.y);break;case 13:if(this.room.type!==R.BIGDUNGEON){s=new Lt(this.room,this.game,i.x,i.y);break}s=new Ut(this.room,this.game,i.x,i.y);for(let a=0;a<2;a++)for(let n=0;n<2;n++)this.room.roomArray[i.x+a][i.y+n]=new bt(this.room,i.x+a,i.y+n);break;case 14:s=new te(this.room,this.game,i.x,i.y);break;case 15:s=new Jt(this.room,this.game,i.x,i.y);break;case 16:s=new Dt(this.room,this.game,i.x,i.y);break;case 17:s=new he(this.room,this.game,i.x,i.y);break;case 18:s=new be(this.room,this.game,i.x,i.y);break;case 19:s=new Li(this.room,this.game,i.x,i.y);break}this.setSpawnFrequency(s.maxHealth),this.room.projectiles.push(new ho(this.room,s,i.x,i.y)),this.room.hitwarnings.push(new Ht(this.game,i.x,i.y,this.x,this.y))}}this.ticks++}});r(this,"uniqueKillBehavior",()=>{this.room.currentSpawnerCount--});r(this,"draw",t=>{m.ctx.save(),m.ctx.globalAlpha=this.alpha,this.dead||(this.updateDrawXY(t),this.frame+=.1*t,this.frame>=4&&(this.frame=0),this.hasShadow&&this.drawShadow(t),m.drawMob(this.tileX,this.tileY,1,2,this.x-this.drawX,this.y-this.drawYOffset-this.drawY,1,2,this.softShadeColor,this.shadeAmount())),this.dying||(this.seenPlayer||this.drawSleepingZs(t),this.alertTicks>0&&this.drawExclamation(t)),m.ctx.restore()});this.ticks=0,this.health=4,this.maxHealth=4,this.defaultMaxHealth=4,this.tileX=6,this.tileY=4,this.seenPlayer=!0,this.spawnFrequency=4,this.room.currentSpawnerCount++,this.enemyTable=n;const c=m.randTable(this.enemyTable,O.rand);this.enemySpawnType=c,this.spawnOffset=0,this.dropChance=1,this.chainPushable=!1,this.getDrop(["reaper"],!1),this.name="reaper",console.log("spawner created spawner type",this.enemySpawnType)}};r(_s,"tileX",6),r(_s,"tileY",4);let Ee=_s;class er extends Et{constructor(t,i,s){super(t,i,s);r(this,"weaponMove",(t,i)=>{let s=2*t-this.wielder.x,a=2*i-this.wielder.y,n=3*t-2*this.wielder.x,c=3*i-2*this.wielder.y,l=3;if(!this.game.rooms[this.wielder.levelID].tileInside(t,i)||this.game.rooms[this.wielder.levelID].roomArray[t][i].isSolid())return!0;!this.game.rooms[this.wielder.levelID].tileInside(s,a)||this.game.rooms[this.wielder.levelID].roomArray[s][a].isSolid()?l=1:(!this.game.rooms[this.wielder.levelID].tileInside(n,c)||this.game.rooms[this.wielder.levelID].roomArray[n][c].isSolid())&&(l=2);let d=[],u=4,h=5,f=5;for(let g of this.game.rooms[this.wielder.levelID].entities)if(g.pushable){if(g.pointIn(t,i))return!0;g.pointIn(s,a)&&l>=2&&(d.push({enemy:g,dist:2}),u=2),g.pointIn(n,c)&&l>=3&&(d.push({enemy:g,dist:3}),u=Math.min(u,3))}else g.destroyable?(g.pointIn(t,i)&&l>=1&&(h=1,d.push({enemy:g,dist:1})),g.pointIn(s,a)&&l>=2&&(h=Math.min(h,2),d.push({enemy:g,dist:2})),g.pointIn(n,c)&&l>=3&&(h=Math.min(h,3),d.push({enemy:g,dist:3}))):(g.pointIn(t,i)&&l>=1&&(f=1),g.pointIn(s,a)&&l>=2&&(f=Math.min(f,2)),g.pointIn(n,c)&&l>=3&&(f=Math.min(f,3)));let p=n,y=c;if(f<h&&f<u)return!0;if(h<=u){for(const w of d){let b=w.enemy;w.dist===3?b.hurt(this.wielder,.5):b.hurt(this.wielder,1)}this.hitSound(),this.wielder.setHitXY(t,i),xe.shotgun(this.game.rooms[this.wielder.levelID],this.wielder.x+.5,this.wielder.y,p+.5,y,"black"),xe.shotgun(this.game.rooms[this.wielder.levelID],this.wielder.x+.5,this.wielder.y,p+.5,y,"#ffddff");let g=new xe(this.game.rooms[this.wielder.levelID],.5*(t+this.wielder.x)+.5,.5*(i+this.wielder.y),0,1,0,0,0,"white",0);return g.expirationTimer=10,this.game.rooms[this.wielder.levelID].particles.push(g),this.game.rooms[this.wielder.levelID].tick(this.wielder),this.shakeScreen(t,i),this.degrade(),!1}return!0});this.tileX=26,this.tileY=0,this.name="shotgun"}}r(er,"itemName","shotgun");let Ao=150,Eh="#5a595b",Sh="#292c36",ko="white";class ut extends mt{constructor(t,i,s,a,n){super(t,i,s,a);r(this,"playerOpened");r(this,"open",!1);r(this,"openTime",0);r(this,"costItems");r(this,"item");r(this,"isInf",!1);r(this,"quantity",1);r(this,"buyAnimAmount",0);r(this,"setCost",(t=1,i,s,a=1)=>{if(!i||!s){const n=[new ze(this.room,0,0),new _e(this.room,0,0),new ce(this.room,0,0),new ct(this.room,0,0)],c=m.randTable(n,O.rand);c instanceof ct?c.stackCount=m.randTable([20,25,30],O.rand):c.stackCount=m.randTable([1,2,3],O.rand),c.stackCount*=t,this.costItems=[c]}else{const n=m.randTable(s,O.rand),c=m.randTable(i,O.rand);c.stackCount=n,this.costItems=[c]}this.quantity=a});r(this,"hoverText",()=>this.open?this.quantity>0?`Buy ${this.item.name}`:"Out of stock":"Vending Machine");r(this,"interact",t=>{(this.isInf||this.quantity>0)&&(this.open&&(this.playerOpened.openVendingMachine=null),this.open=!0,this.playerOpened=t,this.openTime=Date.now(),this.playerOpened.openVendingMachine&&this.playerOpened.openVendingMachine!==this&&this.playerOpened.openVendingMachine.close(),this.playerOpened.openVendingMachine=this)});r(this,"close",()=>{this.open=!1,this.playerOpened.openVendingMachine=null});r(this,"space",()=>{if(this.open){for(const n of this.costItems)if(!this.playerOpened.inventory.hasItemCount(n)){let c=0;n instanceof ct?c=this.playerOpened.inventory.coinCount():this.playerOpened.inventory.items.forEach(u=>{u instanceof n.constructor&&(c+=u.stackCount)});const l=this.costItems[0].stackCount-c,d=this.costItems[0].stackCount>1?"s":"";this.game.pushMessage(`You need ${l} more ${this.costItems[0].constructor.itemName}${d} to buy that. `);return}let t=new this.item.constructor(this.room,this.x,this.y);if(!this.playerOpened.inventory.addItem(t)){this.game.pushMessage("Your inventory is full. Cannot purchase the item.");return}for(const n of this.costItems)this.playerOpened.inventory.subtractItemCount(n);const s=this.costItems[0].stackCount,a=s>1?"s":"";this.isInf||(this.quantity--,this.quantity<=0&&this.close()),this.game.pushMessage(`Purchased ${t.constructor.itemName} for ${s} ${this.costItems[0].constructor.itemName}${a}`),this.game.pushMessage(`${this.quantity} available to buy.`),this.buyAnimAmount=.99,this.playerOpened===this.game.players[this.game.localPlayerID]&&this.game.shakeScreen(0,4)}});r(this,"draw",t=>{let i=19;!this.isInf&&this.quantity===0&&(i=20),this.hasShadow&&this.drawShadow(t),m.drawObj(i,0,1,2,this.x,this.y-1,1,2,this.room.shadeColor,this.shadeAmount())});r(this,"drawTopLayer",t=>{if(this.open&&this.playerOpened.inventory.isOpen){this.close();return}if(this.drawableY=this.y,this.open&&this.playerOpened===this.game.players[this.game.localPlayerID]){let i=Math.min(18,18*(Date.now()-this.openTime)/Ao),s=2,a=-2,n=1,c=(this.costItems.length+2)*(i+2*s+a)-a,l=i+2*s+a-a,d=(this.x+.5)*x.TILESIZE,u=(this.y-1.5)*x.TILESIZE;m.ctx.fillStyle=ko,m.ctx.fillRect(Math.round(d-.5*c)-n,Math.round(u-.5*l)-n,Math.round(c+2*n),Math.round(l+2*n));for(let h=0;h<this.costItems.length+2;h++)m.ctx.fillStyle=Sh,m.ctx.fillRect(Math.round(d-.5*c+h*(i+2*s+a)),Math.round(u-.5*l),Math.round(i+2*s),Math.round(i+2*s)),h!==this.costItems.length&&(m.ctx.fillStyle=Eh,m.ctx.fillRect(Math.round(d-.5*c+h*(i+2*s+a)+s),Math.round(u-.5*l+s),Math.round(i),Math.round(i)));if(Date.now()-this.openTime>=Ao)for(let h=0;h<this.costItems.length+2;h++){let f=Math.round(d-.5*c+h*(i+2*s+a)+s+Math.floor(.5*i)-.5*x.TILESIZE),p=Math.round(u-.5*l+s+Math.floor(.5*i)-.5*x.TILESIZE),y=f/x.TILESIZE,g=p/x.TILESIZE;if(h<this.costItems.length){let w=1;this.playerOpened.inventory.hasItemCount(this.costItems[h])||(w=.15),this.costItems[h].drawIcon(t,y,g,w)}else h===this.costItems.length?m.drawFX(2,0,1,1,y,g,1,1):h===this.costItems.length+1&&this.item.drawIcon(t,y,g,1,this.quantity)}this.buyAnimAmount*=this.buyAnimAmount,m.ctx.globalAlpha=this.buyAnimAmount,m.ctx.fillStyle=ko,m.ctx.fillRect(Math.round(d-.5*c)-n,Math.round(u-.5*l)-n,Math.round(c+2*n),Math.round(l+2*n)),m.ctx.globalAlpha=1}});this.destroyable=!1,this.pushable=!1,this.chainPushable=!1,this.interactable=!0,this.costItems=[],this.item=n,this.name="vending machine",this.item instanceof er?this.setCost(3):this.item instanceof ue?this.setCost(1,[new ct(t,0,0)],[9,10,11],2):this.item instanceof we?this.setCost(2):this.item instanceof Wt?this.setCost(3):this.item instanceof Zs?this.setCost(3):this.item instanceof Ni?this.setCost(2):this.item instanceof ms?this.setCost(2):this.item instanceof Qe?this.setCost(3):this.item instanceof si?this.setCost(2):this.item instanceof ii?this.setCost(1,[new ct(t,0,0)],[9,10,11],2):this.item instanceof Ne?this.setCost(1,[new ct(t,0,0)],[Q.randomNormalInt(15,25)]):this.item instanceof Je?this.setCost(1,[new ct(t,0,0)],[Q.randomNormalInt(25,40)]):this.item instanceof Ke&&this.setCost(1,[new ct(t,0,0)],[Q.randomNormalInt(15,25)])}get type(){return gt.PROP}}r(ut,"isPointInVendingMachineBounds",(t,i,s)=>{var N;if(!s.open||s!==((N=s.playerOpened)==null?void 0:N.openVendingMachine))return!1;const a=x.WIDTH/2,n=x.HEIGHT/2,c=(s.x-s.playerOpened.x)*x.TILESIZE,l=(s.y-s.playerOpened.y)*x.TILESIZE,d=a+c,u=n+l;let h=18,f=2,p=-2,y=(s.costItems.length+2)*(h+2*f+p)-p,g=h+2*f+p-p,w=d,b=u-2*x.TILESIZE;const T=Math.round(w-.5*y),v=T+Math.round(y),k=Math.round(b-.5*g),D=k+Math.round(g);return t>=T&&t<=v&&i>=k&&i<=D});class kt extends et{constructor(t,i,s,a){super(t,i,s);r(this,"frame");r(this,"tileYOffset");r(this,"isBottomWall");r(this,"torchOffset");r(this,"lightSource");r(this,"isSolid",()=>!0);r(this,"canCrushEnemy",()=>!0);r(this,"isOpaque",()=>{const t=this.room.wallInfo.get(`${this.x},${this.y}`);return t?!t.isTopWall&&!t.isInnerWall||t.isLeftWall||t.isRightWall:!0});r(this,"draw",t=>{this.drawWall(t);const i=this.room.wallInfo.get(`${this.x},${this.y}`);i||(this.tileYOffset=6),this.frame+=.3*t,this.frame>=12&&(this.frame=0),this.tileYOffset=(i==null?void 0:i.innerWallType)==="bottomInner"||(i==null?void 0:i.innerWallType)==="surroundedInner"?0:6,this.isBottomWall||m.drawTile(0,this.skin,1,1,this.x,this.y,1,1,this.room.shadeColor,this.shadeAmount()),m.drawFX(Math.floor(this.frame),32,1,2,this.x,this.y-1-this.torchOffset,1,2),this.isBottomWall&&m.drawTile(0,this.skin,1,1,this.x,this.y-.6,1,1,this.room.shadeColor,1)});this.isBottomWall=a,this.torchOffset=a?1:0,this.lightSource=new Vt(this.x+.5,this.y+.5-this.torchOffset,5,q.TORCH_LIGHT_COLOR,1.5),this.room.lightSources.push(this.lightSource),this.frame=O.rand()*12,this.tileYOffset=6,this.hasBloom=!0,this.bloomColor="#FFA500",this.bloomAlpha=1,this.softBloomAlpha=0}}const Oi=class Oi{constructor(){r(this,"cursorSize",5);r(this,"clickX",0);r(this,"clickY",0);r(this,"rawClickX",0);r(this,"rawClickY",0);r(this,"tileX",6);r(this,"lastMouseX",0);r(this,"lastMouseY",0);r(this,"posChangeTime",Date.now());r(this,"cursorTimeout",5e3);r(this,"frame",0);r(this,"setIcon",e=>{switch(e){case"arrow":this.tileX=8;break;case"sword":this.tileX=7;break;case"hand":this.tileX=6;break;case"wait":this.tileX=9;break;case"grab":this.tileX=10;break;case"up":this.tileX=11;break;case"right":this.tileX=12;break;case"down":this.tileX=13;break;case"left":this.tileX=14;break;case"mine":this.tileX=15;break}});r(this,"draw",(e,t=!1)=>{!t&&Date.now()-this.posChangeTime<this.cursorTimeout&&this.drawCursor(),this.drawAnimation(e)})}static getInstance(){return Oi.instance||(Oi.instance=new Oi),Oi.instance}drawCursor(){m.ctx.save();const e=Date.now()-this.posChangeTime,t=this.cursorTimeout-200;let i=1;e>t&&(i=1-(e-t)/200),m.ctx.globalAlpha=i,m.drawFX(this.tileX,0,1,1,I.mouseX/x.TILESIZE-8/x.TILESIZE,I.mouseY/x.TILESIZE-8/x.TILESIZE,1,1),m.ctx.restore()}drawAnimation(e){this.frame>5||(m.drawFX(9+Math.ceil(this.frame),1,1,1,this.clickX/x.TILESIZE-8/x.TILESIZE,this.clickY/x.TILESIZE-8/x.TILESIZE,1,1),this.frame=this.frame+e/5)}startClickAnim(){this.frame=0,this.clickX=I.mouseX,this.clickY=I.mouseY,this.rawClickX=I.rawMouseX,this.rawClickY=I.rawMouseY}recalculateClickPosition(){this.rawClickX!==void 0&&this.rawClickY!==void 0&&(document.getElementById("gameCanvas").getBoundingClientRect(),this.clickX=Math.floor(this.rawClickX/m.scale),this.clickY=Math.floor(this.rawClickY/m.scale))}getPosition(){return(I.mouseX!==this.lastMouseX||I.mouseY!==this.lastMouseY)&&(this.posChangeTime=Date.now()),this.lastMouseX=I.mouseX,this.lastMouseY=I.mouseY,{x:I.mouseX,y:I.mouseY}}getTilePosition(){return{x:Math.floor(I.mouseX/x.TILESIZE),y:Math.floor(I.mouseY/x.TILESIZE)}}getInventoryPosition(){return{x:I.mouseX,y:I.mouseY}}};r(Oi,"instance");let pt=Oi;var W=(o=>(o[o.I=0]="I",o[o.M=1]="M",o[o.M_UP=2]="M_UP",o[o.Q=3]="Q",o[o.LEFT=4]="LEFT",o[o.RIGHT=5]="RIGHT",o[o.UP=6]="UP",o[o.DOWN=7]="DOWN",o[o.SPACE=8]="SPACE",o[o.COMMA=9]="COMMA",o[o.PERIOD=10]="PERIOD",o[o.LEFT_CLICK=11]="LEFT_CLICK",o[o.RIGHT_CLICK=12]="RIGHT_CLICK",o[o.MOUSE_MOVE=13]="MOUSE_MOVE",o[o.NUMBER_1=14]="NUMBER_1",o[o.NUMBER_2=15]="NUMBER_2",o[o.NUMBER_3=16]="NUMBER_3",o[o.NUMBER_4=17]="NUMBER_4",o[o.NUMBER_5=18]="NUMBER_5",o[o.NUMBER_6=19]="NUMBER_6",o[o.NUMBER_7=20]="NUMBER_7",o[o.NUMBER_8=21]="NUMBER_8",o[o.NUMBER_9=22]="NUMBER_9",o[o.MINUS=23]="MINUS",o[o.EQUALS=24]="EQUALS",o[o.ESCAPE=25]="ESCAPE",o[o.F=26]="F",o))(W||{});const I={_pressed:{},isTapHold:!1,tapStartTime:null,IS_TAP_HOLD_THRESH:300,keyDownListener:function(o){},iListener:function(){},mListener:function(){},mUpListener:function(){},qListener:function(){},leftListener:function(){},rightListener:function(){},upListener:function(){},downListener:function(){},aListener:function(){I.leftListener()},dListener:function(){I.rightListener()},wListener:function(){I.upListener()},sListener:function(){I.downListener()},spaceListener:function(){},leftSwipeListener:function(){},rightSwipeListener:function(){},upSwipeListener:function(){},downSwipeListener:function(){},tapListener:function(){},commaListener:function(){},periodListener:function(){},numKeyListener:function(o){},equalsListener:function(){},minusListener:function(){},escapeListener:function(){},fListener:function(){},mouseLeftClickListeners:[],mouseRightClickListeners:[],mouseMoveListeners:[],mouseDownListeners:[],mouseUpListeners:[],touchStartListeners:[],touchEndListeners:[],mouseX:0,mouseY:0,mouseDown:!1,lastPressTime:0,lastPressKey:"",lastMouseDownTime:0,lastMouseDownX:0,lastMouseDownY:0,mouseDownHandled:!1,SPACE:"Space",LEFT:"ArrowLeft",UP:"ArrowUp",RIGHT:"ArrowRight",DOWN:"ArrowDown",W:"KeyW",A:"KeyA",S:"KeyS",D:"KeyD",M:"KeyM",N:"KeyN",I:"KeyI",Q:"KeyQ",NUMBER_1:"Digit1",NUMBER_2:"Digit2",NUMBER_3:"Digit3",NUMBER_4:"Digit4",NUMBER_5:"Digit5",NUMBER_6:"Digit6",NUMBER_7:"Digit7",NUMBER_8:"Digit8",NUMBER_9:"Digit9",COMMA:"Comma",PERIOD:"Period",MINUS:"Minus",EQUALS:"Equal",ESCAPE:"Escape",F:"KeyF",rawMouseX:0,rawMouseY:0,isDown:function(o){return this._pressed[o]},onKeydown:o=>{if(!o.repeat)switch(o.key&&I.keyDownListener(o.key),o.cancelable&&o.key!="F12"&&o.key!="F5"&&o.preventDefault(),I.lastPressTime=Date.now(),I.lastPressKey=o.key,I._pressed[o.code]=!0,o.code){case I.LEFT:I.leftListener();break;case I.A:I.aListener();break;case I.RIGHT:I.rightListener();break;case I.D:I.dListener();break;case I.UP:I.upListener();break;case I.W:I.wListener();break;case I.DOWN:I.downListener();break;case I.S:I.sListener();break;case I.SPACE:I.spaceListener();break;case I.M:I.mListener();break;case I.I:I.iListener();break;case I.Q:I.qListener();break;case I.COMMA:I.commaListener();break;case I.PERIOD:I.periodListener();break;case I.NUMBER_1:case I.NUMBER_2:case I.NUMBER_3:case I.NUMBER_4:case I.NUMBER_5:case I.NUMBER_6:case I.NUMBER_7:case I.NUMBER_8:case I.NUMBER_9:I.numKeyListener(parseInt(o.code.slice(-1)));break;case I.EQUALS:I.equalsListener();break;case I.MINUS:I.minusListener();break;case I.ESCAPE:I.escapeListener();break;case I.F:I.fListener();break}},onKeyup:function(o){delete this._pressed[o.code],o.key===this.lastPressKey&&(this.lastPressTime=0,this.lastPressKey=0),o.code===I.M&&I.mUpListener()},mouseLeftClickListener:function(o,e){for(let t=0;t<I.mouseLeftClickListeners.length;t++)I.mouseLeftClickListeners[t](o,e)},mouseRightClickListener:function(o,e){for(let t=0;t<I.mouseRightClickListeners.length;t++)I.mouseRightClickListeners[t](o,e)},mouseMoveListener:function(o,e){for(let t=0;t<I.mouseMoveListeners.length;t++)I.mouseMoveListeners[t](o,e)},mouseDownListener:function(o,e,t){for(let i=0;i<I.mouseDownListeners.length;i++)I.mouseDownListeners[i](o,e,t)},mouseUpListener:function(o,e,t){for(let i=0;i<I.mouseUpListeners.length;i++)I.mouseUpListeners[i](o,e,t)},mouseClickListener:function(o){if(o.button===0||o.button===2){let e=window.document.getElementById("gameCanvas").getBoundingClientRect(),t=o.clientX-e.left,i=o.clientY-e.top,s=Math.floor(t/m.scale),a=Math.floor(i/m.scale);console.log(`Input.mouseClickListener: raw x: ${t}, y: ${i}, scale: ${m.scale}, scaledX: ${s}, scaledY: ${a}`),o.button===0?I.mouseLeftClickListener(s,a):o.button===2&&I.mouseRightClickListener(s,a)}},updateMousePos:function(o){m.inputReceived=!0;let e=window.document.getElementById("gameCanvas").getBoundingClientRect(),t=o.clientX-e.left,i=o.clientY-e.top;I.rawMouseX=t,I.rawMouseY=i,I.mouseX=Math.floor(t/m.scale),I.mouseY=Math.floor(i/m.scale),I.mouseMoveListener(I.mouseX,I.mouseY)},recalculateMousePosition:function(){I.rawMouseX!==void 0&&I.rawMouseY!==void 0&&(I.mouseX=Math.floor(I.rawMouseX/m.scale),I.mouseY=Math.floor(I.rawMouseY/m.scale),pt.getInstance().recalculateClickPosition())},handleMouseDown:function(o){I.mouseDown||(pt.getInstance().startClickAnim(),I.mouseDown=!0,I.mouseDownStartTime=Date.now(),I.isMouseHold=!1,I.mouseDownListener(I.mouseX,I.mouseY,o.button),I._holdCheckInterval||(I._holdCheckInterval=setInterval(I.checkIsMouseHold,16)))},handleMouseUp:function(o){I.mouseDown=!1,I.mouseDownStartTime=null,I.mouseUpListener(I.mouseX,I.mouseY,o.button),I.lastMouseDownTime=0,I.mouseDownHandled=!1,I._holdCheckInterval&&(clearInterval(I._holdCheckInterval),I._holdCheckInterval=null),setTimeout(()=>{I.isMouseHold=!1},50)},_holdCheckInterval:null,checkIsMouseHold:function(){!I.mouseDown||I.mouseDownStartTime===null||Date.now()>=I.mouseDownStartTime+I.HOLD_THRESH&&(I.isMouseHold||(I.isMouseHold=!0,I.holdCallback&&I.holdCallback()))},getTouches:function(o){return m.inputReceived=!0,o.touches||o.originalEvent.touches},xDown:null,yDown:null,currentX:0,currentY:0,swiped:!1,handleTouchStart:function(o){m.inputReceived=!0,o.preventDefault();const e=I.getTouches(o)[0];I.xDown=e.clientX,I.yDown=e.clientY,I.currentX=e.clientX,I.currentY=e.clientY,I.tapStartTime=Date.now(),I.updateMousePos({clientX:I.currentX,clientY:I.currentY}),I.swiped=!1,I.mouseDown=!0,I.mouseDownStartTime=Date.now(),I.isMouseHold=!1,I.mouseDownListener(I.mouseX,I.mouseY,0),I._holdCheckInterval||(I._holdCheckInterval=setInterval(I.checkIsMouseHold,16))},handleTouchMove:function(o){if(o.preventDefault(),I.currentX=o.touches[0].clientX,I.currentY=o.touches[0].clientY,I.updateMousePos({clientX:I.currentX,clientY:I.currentY}),!I.swiped){var e=I.xDown-I.currentX,t=I.yDown-I.currentY;e**2+t**2>=x.SWIPE_THRESH&&(Math.abs(e)>Math.abs(t)?(e>0?(I.leftSwipeListener(),I.lastSwipeDirection=E.LEFT):(I.rightSwipeListener(),I.lastSwipeDirection=E.RIGHT),I.swiped=!0,I.lastSwipeTime=Date.now(),I.swipeHoldActive=!0,I.swipeHoldRepeating=!1):(t>0?(I.upSwipeListener(),I.lastSwipeDirection=E.UP):(I.downSwipeListener(),I.lastSwipeDirection=E.DOWN),I.swiped=!0,I.lastSwipeTime=Date.now(),I.swipeHoldActive=!0,I.swipeHoldRepeating=!1))}},handleTouchEnd:function(o){o.preventDefault(),!I.isTapHold&&!I.swiped&&I.tapListener(),I.isTapHold=!1,I.tapStartTime=null,I.swipeHoldActive=!1,I.swipeHoldRepeating=!1,I.lastSwipeTime=0,I.lastSwipeDirection=null,I.mouseDown=!1,I.mouseDownStartTime=null,I.mouseUpListener(I.mouseX,I.mouseY,0),I._holdCheckInterval&&(clearInterval(I._holdCheckInterval),I._holdCheckInterval=null),setTimeout(()=>{I.isMouseHold=!1},50)},checkIsTapHold:function(){I.tapStartTime!==null&&Date.now()>=I.tapStartTime+I.IS_TAP_HOLD_THRESH&&(I.isTapHold=!0)},set isMouseHold(o){this._isMouseHold=o},get isMouseHold(){return this._isMouseHold},_isMouseHold:!1,mouseDownStartTime:null,HOLD_THRESH:200,holdCallback:null,lastSwipeTime:0,lastSwipeDirection:null,swipeHoldActive:!1,swipeHoldRepeating:!1};window.addEventListener("keyup",function(o){I.onKeyup(o)},!1);window.addEventListener("keydown",function(o){I.onKeydown(o)},!1);window.document.getElementById("gameCanvas").addEventListener("mousemove",o=>I.updateMousePos(o),!1);window.document.getElementById("gameCanvas").addEventListener("mousedown",o=>I.handleMouseDown(o),!1);window.document.getElementById("gameCanvas").addEventListener("mouseup",o=>I.handleMouseUp(o),!1);window.document.getElementById("gameCanvas").addEventListener("contextmenu",o=>o.preventDefault(),!1);class xn extends oe{constructor(t,i,s,a){super(t,s,a);r(this,"game");r(this,"draw",t=>{m.drawTile(13,this.skin,1,1,this.x,this.y,1,1,this.room.shadeColor,this.shadeAmount())});r(this,"onCollide",t=>{});this.game=i}}class bn{static draw(){m.ctx.save(),m.ctx.globalAlpha=.1,H.audioMuted?m.drawFX(17,0,1,1,0,.5,1,1):m.drawFX(16,0,1,1,0,.5,1,1),m.ctx.restore()}static toggleMute(){H.toggleMute()}}class pe{constructor(e,t,i,s,a,n,c=!1,l){r(this,"toggleable");r(this,"toggled");r(this,"x");r(this,"y");r(this,"width");r(this,"height");r(this,"text");r(this,"parent");r(this,"onClick");r(this,"noFill");r(this,"textColor");r(this,"toggleMuteText",()=>{var e;bn.toggleMute(),this.text=H.audioMuted?"Sound Muted":"Sound Unmuted",(e=this.parent)==null||e.game.pushMessage(this.text)});this.toggleable=c,this.toggled=!1,this.x=e,this.y=t,this.width=i,this.height=s,this.text=a,this.onClick=n,this.parent=l,this.noFill=!1,this.textColor=void 0}isPointInButton(e,t){return e>=this.x&&e<=this.x+this.width&&t>=this.y&&t<=this.y+this.height}}class En{constructor(e){r(this,"buttons");r(this,"closeButton");r(this,"open");r(this,"selectedButton");r(this,"game");r(this,"player");r(this,"showCloseButton",!0);r(this,"selectionTimeoutId",null);r(this,"lastButtonClickTime",0);r(this,"lastButtonClickIndex",-1);r(this,"BUTTON_CLICK_DEBOUNCE_TIME",150);r(this,"startGame",()=>{this.close()});r(this,"exitGame",()=>{});r(this,"openSettings",()=>{});r(this,"scaleUp",()=>{this.game.increaseScale()});r(this,"scaleDown",()=>{this.game.decreaseScale()});this.buttons=[],this.open=!1,this.selectedButton=0,e instanceof fi?(this.game=e.game,this.player=e,this.showCloseButton=!0,this.initializeCloseButton(),this.initializeMainMenu()):(this.game=e.game,this.player=e.player,this.showCloseButton=e.showCloseButton!==!1,this.showCloseButton&&this.initializeCloseButton())}static drawOpenMenuButton(){m.ctx.save(),m.ctx.fillStyle="rgba(255, 255, 0, 1)",m.ctx.globalAlpha=.1,m.drawFX(18,0,1,1,0,.5,1,1),m.fillText("Menu",10,10),m.ctx.globalAlpha=1,m.ctx.restore()}initializeCloseButton(){const e=Math.round(x.TILESIZE*1.5-2),t=Math.round(x.TILESIZE*1.5-2);this.closeButton=new pe(0,-1,Math.round(e),Math.round(t),"X",()=>this.close(),!1,this)}initializeMainMenu(){this.addButton(new pe(0,0,0,0,"- Scale",this.scaleDown,!1,this)),this.addButton(new pe(0,0,0,0,"+ Scale",this.scaleUp,!1,this));const e=new pe(0,0,0,0,"Mute Sound",()=>{},!1,this);e.onClick=e.toggleMuteText,this.addButton(e);const t=new pe(0,0,0,0,"Smooth Lighting",()=>{x.SMOOTH_LIGHTING=!x.SMOOTH_LIGHTING;const a=x.SMOOTH_LIGHTING?"enabled":"disabled";this.game.pushMessage(`Smooth lighting is now ${a}`);try{const{saveSettings:n}=require("../game/settingsPersistence");n(this.game)}catch{}},!1,this);this.addButton(t);const i=new pe(0,0,0,0,"Hover Text",()=>{x.HOVER_TEXT_ENABLED=!x.HOVER_TEXT_ENABLED;const a=x.HOVER_TEXT_ENABLED?"enabled":"disabled";this.game.pushMessage(`Hover text is now ${a}`);try{const{saveSettings:n}=require("../game/settingsPersistence");n(this.game)}catch{}},!1,this);this.addButton(i);const s=new pe(0,0,0,0,"New Game",()=>{try{this.game.newGame()}catch{this.game.pushMessage("New Game failed.")}},!1,this);this.addButton(s),this.positionButtons()}buildStartMenu(){this.buttons=[];const e=new pe(0,0,0,0,"Welcome to Turnarchist",()=>{},!1,this);e.noFill=!0,e.textColor="rgb(255, 255, 0)",this.addButton(e);const t=new pe(0,0,0,0,"Continue",()=>{try{const{loadFromCookies:s}=require("../game/savePersistence");s(this.game).then(a=>{a?(this.game.pushMessage("Loaded save."),this.close(),this.game.startedFadeOut=!0,this.game.startMenuActive=!1):this.game.pushMessage("Load failed.")})}catch{this.game.pushMessage("Load failed.")}},!1,this),i=new pe(0,0,0,0,"New Game",()=>{this.close(),this.game.startedFadeOut=!0,this.game.startMenuActive=!1},!1,this);this.addButton(t),this.addButton(i),this.positionButtons()}addButton(e){this.buttons.push(e)}draw(){this.open&&(m.ctx.save(),m.ctx.fillStyle="rgba(0, 0, 0, 0)",m.ctx.fillRect(0,0,x.WIDTH,x.HEIGHT),this.buttons.forEach(e=>{this.drawButton(e)}),this.showCloseButton&&this.closeButton&&this.drawCloseButton(),m.ctx.restore())}drawButton(e){m.ctx.save(),m.ctx.imageSmoothingEnabled=!1,m.ctx.strokeStyle="transparent",m.ctx.lineWidth=0,e.noFill||(m.ctx.fillStyle=this.selectedButton===this.buttons.indexOf(e)?"rgba(75, 75, 75, 0.5)":"rgba(100, 100, 100, 0.5)",m.ctx.fillRect(Math.round(e.x),Math.round(e.y),Math.round(e.width),Math.round(e.height))),m.ctx.fillStyle="rgba(255, 255, 0, 1)",e.textColor&&(m.ctx.fillStyle=e.textColor);const t=m.measureText(e.text).width,i=e.x+(e.width-t)/2,s=e.y+e.height/2-m.letter_height/2;m.fillText(e.text,Math.round(i),Math.round(s)),m.ctx.restore()}drawCloseButton(){m.ctx.save(),m.ctx.imageSmoothingEnabled=!1,m.ctx.fillStyle="rgba(220, 60, 60, 1)",m.ctx.fillRect(Math.round(this.closeButton.x),Math.round(this.closeButton.y),Math.round(this.closeButton.width),Math.round(this.closeButton.height)),m.ctx.strokeStyle="rgba(0, 0, 0, 1)",m.ctx.lineWidth=1,this.closeButton&&m.ctx.strokeRect(this.closeButton.x,this.closeButton.y,this.closeButton.width,this.closeButton.height),m.ctx.fillStyle="rgba(255, 255, 255, 1)";const e=m.measureText(this.closeButton.text).width,t=this.closeButton.x+(this.closeButton.width-e)/2,i=this.closeButton.y+this.closeButton.height/2-m.letter_height/2;m.fillText(this.closeButton.text,t,i),m.ctx.restore()}inputHandler(e){if(this.open)switch(e){case W.ESCAPE:this.open=!1;break;case W.UP:this.up();break;case W.DOWN:this.down();break;case W.SPACE:this.select();break;case W.LEFT_CLICK:const{x:t,y:i}=pt.getInstance().getPosition();this.mouseInputHandler(t,i);break;case W.RIGHT_CLICK:break}}mouseInputHandler(e,t){if(!this.open)return;if(this.showCloseButton&&this.isPointInCloseButton(e,t)){const s=Date.now();if(s-this.lastButtonClickTime<this.BUTTON_CLICK_DEBOUNCE_TIME)return;this.lastButtonClickTime=s,this.closeButton.onClick();return}const i=this.isPointInMenuBounds(e,t);if(i.inBounds&&i.buttonIndex>=0){const s=this.buttons[i.buttonIndex],a=Date.now();if(i.buttonIndex===this.lastButtonClickIndex&&a-this.lastButtonClickTime<this.BUTTON_CLICK_DEBOUNCE_TIME)return;this.lastButtonClickTime=a,this.lastButtonClickIndex=i.buttonIndex,this.selectionTimeoutId!==null&&clearTimeout(this.selectionTimeoutId),this.selectedButton=i.buttonIndex,this.selectionTimeoutId=setTimeout(()=>{this.selectedButton=-1,this.selectionTimeoutId=null},100),s.onClick()}}close(){this.open=!1}openMenu(){this.open=!0,this.selectedButton=-1,this.buttons.forEach((e,t)=>{})}toggleOpen(){this.open?this.close():this.openMenu()}select(){this.buttons[this.selectedButton]&&this.buttons[this.selectedButton].onClick()}up(){this.buttons.length>0&&(this.selectedButton=(this.selectedButton-1+this.buttons.length)%this.buttons.length)}down(){this.buttons.length>0&&(this.selectedButton=(this.selectedButton+1)%this.buttons.length)}positionButtons(){const e=x.WIDTH,t=x.HEIGHT,i=this.buttons.length;this.showCloseButton&&this.closeButton&&(this.closeButton.x=1,this.closeButton.y=x.TILESIZE/2);const s=Math.min(260,Math.floor(e*.8)),a=8,n=6,c=8,l=16,d=this.getScaleButtonIndices(),u=i-(d.length>0?1:0),h=n*Math.max(0,u-1),f=Math.max(0,t-a*2-h),p=22,y=u>0?Math.floor(f/u):p,g=Math.min(p,Math.max(12,y));if(u<=0)return;const w=u*g+h,b=a,T=t-a*2;let v=b+Math.floor((T-w)/2);for(let k=0;k<this.buttons.length;k++){const D=this.buttons[k];if(D.text==="- Scale"||D.text==="+ Scale"){this.buttons[k].text==="- Scale"&&this.buttons[k];const N=this.buttons[k].text==="- Scale"?k+1:k-1,U=this.buttons[N],Z=m.measureText("- Scale").width,j=m.measureText("+ Scale").width,V=Math.min(s,Z+l),J=Math.min(s,j+l),z=V+c+J,tt=Math.floor((e-z)/2),ft=v,at=this.buttons[k].text==="- Scale"?this.buttons[k]:this.buttons[N];at.x=tt,at.y=ft,at.width=V,at.height=g;const Rt=U;Rt.x=tt+V+c,Rt.y=ft,Rt.width=J,Rt.height=g,this.buttons[k].text==="- Scale"&&(k=Math.max(k,N)),v+=g+n}else{const N=m.measureText(D.text).width,U=Math.min(s,N+l);D.width=U,D.x=Math.floor((e-U)/2),D.y=v,D.height=g,v+=g+n}}}getScaleButtonIndices(){const e=[];return this.buttons.forEach((t,i)=>{(t.text==="- Scale"||t.text==="+ Scale")&&e.push(i)}),e}isPointInMenuBounds(e,t){if(!this.open)return{inBounds:!1,buttonIndex:-1};for(let i=0;i<this.buttons.length;i++){const s=this.buttons[i];if(e>=s.x&&e<=s.x+s.width&&t>=s.y&&t<=s.y+s.height)return{inBounds:!0,buttonIndex:i}}return{inBounds:!1,buttonIndex:-1}}isPointInCloseButton(e,t){return!!this.closeButton&&e>=this.closeButton.x&&e<=this.closeButton.x+this.closeButton.width&&t>=this.closeButton.y&&t<=this.closeButton.y+this.closeButton.height}}class Th{constructor(){r(this,"xp");r(this,"level");this.xp=0,this.level=1}static draw(e){const t=$e.getXp();m.ctx.save(),m.ctx.fillStyle="rgba(255, 255, 0, 1)",m.ctx.globalAlpha=.1,m.fillText(`XP: ${t}`,1,20),m.ctx.restore()}}let Ei=100,hr="#5a595b",Oo="#292c36",lr="#85a8e6",Ih="white";class vh{constructor(e,t){r(this,"globalId");r(this,"player");r(this,"items");r(this,"rows",4);r(this,"cols",5);r(this,"selX",0);r(this,"selY",0);r(this,"game");r(this,"isOpen",!1);r(this,"openTime",Date.now());r(this,"coins",0);r(this,"equipAnimAmount");r(this,"weapon",null);r(this,"_expansion",0);r(this,"grabbedItem",null);r(this,"_mouseDownStartX",null);r(this,"_mouseDownStartY",null);r(this,"_mouseDownItem",null);r(this,"_wasHoldDetected",!1);r(this,"_isDragging",!1);r(this,"_dragStartItem",null);r(this,"_dragStartSlot",null);r(this,"itemEquipAnimations",new Map);r(this,"foundItems",[]);r(this,"dragEndTime",Date.now());r(this,"closeTime",Date.now());r(this,"usingItem",null);r(this,"usingItemIndex",null);r(this,"mostRecentInput","keyboard");r(this,"buttonY");r(this,"buttonX");r(this,"clear",()=>{this.items.fill(null),this.equipAnimAmount.fill(0)});r(this,"open",()=>{this.isOpen=!this.isOpen,this.isOpen&&(this.openTime=Date.now())});r(this,"toggleOpen",()=>{this.isOpen?this.close():this.open()});r(this,"close",()=>{this.isOpen&&(this.isOpen=!1,this.closeTime=Date.now(),this.selY>0&&(this.selY=0),this.usingItem=null,this.usingItemIndex=null)});r(this,"left",()=>{this.selX>0&&this.selX--});r(this,"right",()=>{this.selX<this.cols-1&&this.selX++});r(this,"up",()=>{this.selY>0&&this.selY--});r(this,"down",()=>{this.selY<this.rows+this._expansion-1&&this.selY++});r(this,"space",()=>{this.itemUse()});r(this,"itemAtSelectedSlot",()=>{let e=this.selX+this.selY*this.cols;return e<0||e>=this.items.length?null:this.items[e]});r(this,"getIndexOfItem",e=>e===null?-1:this.items.indexOf(e));r(this,"itemUse",()=>{let e=this.selX+this.selY*this.cols;if(e<0||e>=this.items.length)return;const t=this.items[e];if(this.usingItem){if(t===null){this.usingItem=null,this.usingItemIndex=null;return}t instanceof me&&this.usingItem.useOnOther(this.player,t),this.usingItem=null,this.usingItemIndex=null}else if(t instanceof dt)t.canUseOnOther?(this.usingItem=t,this.usingItemIndex=e):t.onUse(this.player);else if(t instanceof vt){if(t.toggleEquip(),t instanceof Et){if(t.broken||t.cooldown>0)return;this.weapon=t.equipped?t:null}t.equipped&&this.items.forEach((i,s)=>{i instanceof vt&&i!==t&&!t.coEquippable(i)&&(i.equipped=!1,this.equipAnimAmount[s]=0)})}});r(this,"canPickup",e=>!!(!this.isFull()||e instanceof ct||this.items.find(t=>t!==null&&t.constructor===e.constructor)&&e.stackable));r(this,"leftQuickbar",()=>{this.mostRecentInput="keyboard",this.left()});r(this,"rightQuickbar",()=>{this.mostRecentInput="keyboard",this.right()});r(this,"spaceQuickbar",()=>{this.mostRecentInput="keyboard",this.itemUse()});r(this,"mouseMove",()=>{this.mostRecentInput="mouse";const{x:e,y:t}=pt.getInstance().getPosition(),i=this.isPointInInventoryBounds(e,t);if(i.inBounds){const s=this.isOpen?Math.min(18,18*(Date.now()-this.openTime)/Ei):18,a=2,n=-2,c=this.selX,l=this.selY;this.selX=Math.max(0,Math.min(Math.floor((e-i.startX)/(s+2*a+n)),this.cols-1)),this.selY=this.isOpen?Math.max(0,Math.min(Math.floor((t-i.startY)/(s+2*a+n)),this.rows+this._expansion-1)):0,c!==this.selX||this.selY}});r(this,"moveItemToSlot",(e,t,i,s)=>{e!==null&&(this.equipAnimAmount[t],i&&this.equipAnimAmount[s],i===null?(this.items[t]=e,this.equipAnimAmount[t]=this.itemEquipAnimations.get(e)??0):(this.items[t]=i,this.items[s]=e,this.equipAnimAmount[t]=this.itemEquipAnimations.get(i)??0,this.equipAnimAmount[s]=this.itemEquipAnimations.get(e)??0))});r(this,"grabItem",e=>{if(e===null||this.grabbedItem!==null)return;const t=this.getIndexOfItem(e);t!==-1&&(this.items[t]=null,this.grabbedItem=e)});r(this,"releaseItem",()=>{if(this.grabbedItem===null)return;const e=this.selX+this.selY*this.cols;this.items[e]===null?this.items[e]=this.grabbedItem:this.items[e]=this.grabbedItem,this.grabbedItem=null});r(this,"drawDraggedItem",e=>{if(this.grabbedItem===null)return;const{x:t,y:i}=pt.getInstance().getPosition(),s=Math.round(t-.5*x.TILESIZE),a=Math.round(i-.5*x.TILESIZE),n=s/x.TILESIZE,c=a/x.TILESIZE;this.grabbedItem.drawIcon(e,n,c)});r(this,"drop",()=>{if(!this.isOpen)return;let e=this.selX+this.selY*this.cols;if(e<0||e>=this.items.length)return;const t=this.items[e];t!==null&&this.dropItem(t,e)});r(this,"dropItem",(e,t)=>{const i=this.player.getRoom?this.player.getRoom():this.game.levels[this.player.depth].rooms[this.player.levelID];e.level=i,e.x=this.player.x,e.y=this.player.y,e.alpha=1,e.pickedUp=!1,e.dropFromInventory(),this.equipAnimAmount[t]=0,e.drawableY=this.player.y,i.items.push(e),this.items[t]=null});r(this,"dropFromInventory",()=>{});r(this,"hasItem",e=>this.items.find(t=>t instanceof e)||null);r(this,"hasItemCount",e=>e===null?!1:e instanceof ct?this.coinCount()>=e.stackCount:this.items.some(t=>t!==null&&t.constructor===e.constructor&&t.stackCount>=e.stackCount));r(this,"subtractItemCount",e=>{if(e!==null){if(e instanceof ct){this.subtractCoins(e.stackCount);return}this.items.forEach((t,i)=>{t!==null&&t.constructor===e.constructor&&(t.stackCount-=e.stackCount,t.stackCount<=0&&(this.items[i]=null))})}});r(this,"subtractItem",(e,t)=>{if(e!==null){if(e instanceof ct){this.subtractCoins(e.stackCount);return}this.items.forEach((i,s)=>{i!==null&&i.constructor===e.constructor&&(i.stackCount-=t,i.stackCount<=0&&(this.items[s]=null))})}});r(this,"coinCount",()=>this.coins);r(this,"subtractCoins",e=>{this.coins=Math.max(0,this.coins-e)});r(this,"addCoins",e=>{this.coins+=e});r(this,"isFull",()=>this.items.filter(e=>e!==null).length>=(this.rows+this._expansion)*this.cols);r(this,"addItem",(e,t=null)=>{if(e===null)return!1;if(e instanceof ct)return this.coins+=e.stackCount,ht.emit(xt.COIN_COLLECTED,{amount:e.stackCount}),!0;if(e instanceof vt&&e.setWielder(this.player),e.stackable){t&&(e.stackCount=t);for(let i=0;i<this.items.length;i++)if(this.items[i]!==null&&this.items[i].constructor===e.constructor)return this.items[i].stackCount+=e.stackCount,!0}if(!this.isFull()){for(let i=0;i<this.items.length;i++)if(this.items[i]===null)return this.items[i]=e,!0}return!1});r(this,"removeItem",e=>{if(e===null)return;const t=this.items.indexOf(e);t!==-1&&(this.items[t]=null)});r(this,"canMine",()=>this.hasItem(Ne)!==null);r(this,"canFish",()=>this.hasItem(Je)!==null);r(this,"getArmor",()=>this.items.find(e=>e instanceof Wt&&e.equipped)||null);r(this,"hasWeapon",()=>this.weapon!==null);r(this,"getWeapon",()=>this.weapon);r(this,"tick",()=>{this.items.forEach(e=>{e!==null&&e.tickInInventory()}),this.checkForDragStart()});r(this,"textWrap",(e,t,i,s)=>{if(e==="")return i;let a=e.split(" "),n="";for(;a.length>0;)m.measureText(n+a[0]).width>s?(m.fillText(n,t,i),n="",i+=8):(n!==""&&(n+=" "),n+=a[0],a.splice(0,1));return n.trim()!==""&&(m.fillText(n,t,i),i+=8),i});r(this,"drawCoins",e=>{let t=19;this.coins>=3&&(t=20),this.coins>=7&&(t=21);const i=this.getQuickbarStartX(),s=18,a=2,n=-2,c=this.cols*(s+2*a+n)-n;let d=(i+c-5)/x.TILESIZE-1,u=x.HEIGHT/x.TILESIZE-1.3;const h=(x.WIDTH-36)/x.TILESIZE;d>h&&(d=h),x.WIDTH<180?(u-=1.25,d+=1.15):d+=1.5,x.WIDTH<145&&(d-=1.15),m.drawItem(t,0,1,2,d,u-1,1,2);const f=`${this.coins}`;m.measureText(f).width,m.fillTextOutline(f,d*x.TILESIZE+10-m.measureText(this.coins.toString()).width+5,u*x.TILESIZE+9+2,x.OUTLINE,"white")});r(this,"pointInside",(e,t)=>{const i=Math.min(18,18*(Date.now()-this.openTime)/Ei),s=2,a=-2,n=1,c=this.cols*(i+2*s+a)-a,l=(this.rows+this._expansion)*(i+2*s+a)-a,d=Math.round(.5*x.WIDTH-.5*c)-n,u=this.isOpen?Math.round(.5*x.HEIGHT-.5*l)-n:x.HEIGHT-(i+2*s)-5-n,h=this.isOpen?l+2*n:i+2*s+2*n;return e>=d&&e<=d+c+2*n&&t>=u&&t<=u+h});r(this,"drawQuickbar",e=>{var p,y;const{x:t,y:i}=pt.getInstance().getPosition(),s=this.isPointInInventoryBounds(t,i).inBounds,a=18,n=2,c=-2,l=1,d=Math.floor(this.cols*(a+2*n+c)-c),u=Math.floor(a+2*n),h=Math.round(.5*x.WIDTH-.5*d),f=Math.floor(x.HEIGHT-u-2);s||this.mostRecentInput;for(let g=0;g<this.cols;g++){const w=g;if(g!==this.selX){m.ctx.fillStyle=hr,m.ctx.fillRect(Math.floor(h+g*(a+2*n+c)+n),Math.floor(f+n),Math.floor(a),Math.floor(a)),m.ctx.clearRect(Math.floor(h+g*(a+2*n+c)+n+1),Math.floor(f+n+1),Math.floor(a-2),Math.floor(a-2)),m.ctx.fillStyle=lr,m.ctx.globalAlpha=.3;const b=Math.floor(a*(1-this.equipAnimAmount[w]));m.ctx.fillRect(Math.floor(h+g*(a+2*n+c)+n),Math.floor(f+n+b),Math.floor(a),Math.floor(a-b)),m.ctx.globalAlpha=1}if(w<this.items.length&&this.items[w]!==null){const b=h+g*(a+2*n+c)+n+Math.floor(.5*a)-.5*x.TILESIZE,T=f+n+Math.floor(.5*a)-.5*x.TILESIZE,v=b/x.TILESIZE,k=T/x.TILESIZE;(p=this.items[w])==null||p.drawIcon(e,v,k)}}{const g=Math.floor(h+this.selX*(a+2*n+c)),w=Math.floor(f),b=s?l:0;m.ctx.fillStyle=hr,m.ctx.fillRect(Math.floor(g+n-b),Math.floor(w+n-b),Math.floor(a+2*b),Math.floor(a+2*b));const T=s?a:a-2,v=s?0:1;m.ctx.clearRect(Math.floor(h+this.selX*(a+2*n+c)+n+v),Math.floor(f+n+v),Math.floor(T),Math.floor(T));const k=this.selX;m.ctx.fillStyle=lr,m.ctx.globalAlpha=.3;const D=(a+2*b)*(1-this.equipAnimAmount[k]);if(m.ctx.fillRect(Math.round(h+this.selX*(a+2*n+c)+n-b),Math.round(f+n+D-b),Math.round(a+2*b),Math.round(a+2*b-D)),m.ctx.globalAlpha=1,this.drawUsingItem(e,h,f,a,n,c),k<this.items.length&&this.items[k]!==null){const N=g+n+Math.floor(.5*a)-.5*x.TILESIZE,U=w+n+Math.floor(.5*a)-.5*x.TILESIZE,Z=N/x.TILESIZE,j=U/x.TILESIZE;(y=this.items[k])==null||y.drawIcon(e,Z,j)}this.drawUsingItem(e,h,f,a,n,c)}this.drawUsingItem(e,h,f,a,n,c)});r(this,"drawUsingItem",(e,t,i,s,a,n)=>{if(m.ctx.globalCompositeOperation="source-over",this.usingItem&&this.usingItemIndex!==null){const c=this.usingItemIndex%this.cols,l=Math.floor(this.usingItemIndex/this.cols),d=t+c*(s+2*a+n),u=i+l*(s+2*a+n);m.ctx.strokeStyle="yellow",m.ctx.lineWidth=2,m.ctx.strokeRect(d,u,s+2*a,s+2*a),m.ctx.lineWidth=1}});r(this,"updateEquipAnimAmount",e=>{this.equipAnimAmount.forEach((t,i)=>{const s=this.items[i];if(s instanceof vt){let a=s.equipped?1:0,n=this.itemEquipAnimations.get(s)??t;n+=.2*e*(a-n),n=Math.max(0,Math.min(1,n)),this.itemEquipAnimations.set(s,n),this.equipAnimAmount[i]=n}else this.equipAnimAmount[i]=0,s&&this.itemEquipAnimations.delete(s)})});r(this,"draw",e=>{var y,g;m.ctx.imageSmoothingEnabled=!1,m.ctx.imageSmoothingQuality="low";const{x:t,y:i}=pt.getInstance().getPosition(),s=this.isPointInInventoryBounds(t,i).inBounds,a=Math.floor(Math.min(18,18*(Date.now()-this.openTime)/Ei)),n=2,c=-2,l=Math.floor(this.rows+this._expansion),d=1,u=Math.floor(this.cols*(a+2*n+c)-c),h=Math.floor(l*(a+2*n+c)-c),f=Math.round(.5*x.WIDTH-.5*u)-d,p=Math.round(.5*x.HEIGHT-.5*h)-d;if(this.drawCoins(e),this.drawQuickbar(e),this.updateEquipAnimAmount(e),this.drawInventoryButton(e),En.drawOpenMenuButton(),Th.draw(e),this.isOpen){m.ctx.fillStyle="rgba(0, 0, 0, 0.8)",m.ctx.fillRect(0,0,x.WIDTH,x.HEIGHT),m.ctx.globalAlpha=1;const w=Math.floor(Math.min(18,18*(Date.now()-this.openTime)/Ei)),b=2,T=-2,v=Math.floor(1+Math.round(.5*Math.sin(Date.now()*.01)+.5)),k=this.rows+this._expansion,D=1,N=Math.floor(this.cols*(w+2*b+T)-T),U=Math.floor(k*(w+2*b+T)-T);m.ctx.fillStyle=Ih;const Z=Math.round(.5*x.WIDTH-.5*N)-D,j=Math.round(.5*x.HEIGHT-.5*U)-D;if(m.ctx.fillRect(Z,j,N+2*D,U+2*D),s||this.mostRecentInput==="keyboard"){const J=Math.round(.5*x.WIDTH-.5*N+this.selX*(w+2*b+T))-v-D,z=Math.round(.5*x.HEIGHT-.5*U+this.selY*(w+2*b+T))-v-D;m.ctx.fillRect(J,z,w+2*b+2*v+2*D,w+2*b+2*v+2*D)}for(let J=0;J<this.cols;J++)for(let z=0;z<this.rows+this._expansion;z++){const tt=Math.round(.5*x.WIDTH-.5*N+J*(w+2*b+T)),ft=Math.round(.5*x.HEIGHT-.5*U+z*(w+2*b+T));m.ctx.fillStyle=Oo,m.ctx.fillRect(tt,ft,w+2*b,w+2*b),m.ctx.fillStyle=hr,m.ctx.fillRect(tt+b,ft+b,w,w);const at=J+z*this.cols;m.ctx.fillStyle=lr;const Rt=Math.round(w*(1-this.equipAnimAmount[at]));if(m.ctx.fillRect(tt+b,ft+b+Rt,w,w-Rt),at<this.items.length&&this.items[at]!==null){const jt=Math.round(.5*x.WIDTH-.5*N+J*(w+2*b+T)+b+Math.floor(.5*w)-.5*x.TILESIZE),ri=Math.round(.5*x.HEIGHT-.5*U+z*(w+2*b+T)+b+Math.floor(.5*w)-.5*x.TILESIZE),xa=jt/x.TILESIZE,Ie=ri/x.TILESIZE;(y=this.items[at])==null||y.drawIcon(e,xa,Ie)}}if(Date.now()-this.openTime>=Ei&&(this.items.forEach((J,z)=>{if(J===null)return;const tt=z%this.cols,ft=Math.floor(z/this.cols),at=Math.round(.5*x.WIDTH-.5*N+tt*(w+2*b+T)+b+Math.floor(.5*w)-.5*x.TILESIZE),Rt=Math.round(.5*x.HEIGHT-.5*U+ft*(w+2*b+T)+b+Math.floor(.5*w)-.5*x.TILESIZE),jt=at/x.TILESIZE,ri=Rt/x.TILESIZE;J.drawIcon(e,jt,ri)}),s||this.mostRecentInput==="keyboard")){m.ctx.fillStyle=Oo,m.ctx.fillRect(Math.round(.5*x.WIDTH-.5*N+this.selX*(w+2*b+T)-v),Math.round(.5*x.HEIGHT-.5*U+this.selY*(w+2*b+T)-v),w+2*b+2*v,w+2*b+2*v);const J=Math.round(.5*x.WIDTH-.5*N+this.selX*(w+2*b+T)+b-v),z=Math.round(.5*x.HEIGHT-.5*U+this.selY*(w+2*b+T)+b-v);m.ctx.fillStyle=hr,m.ctx.fillRect(J,z,w+2*v,w+2*v);const tt=this.selX+this.selY*this.cols;if(tt<this.items.length&&this.items[tt]!==null){m.ctx.fillStyle=lr;const ft=Math.round((w+2*v)*(1-this.equipAnimAmount[tt]));m.ctx.fillRect(Math.round(.5*x.WIDTH-.5*N+this.selX*(w+2*b+T)+b-v),Math.round(.5*x.HEIGHT-.5*U+this.selY*(w+2*b+T)+b-v+ft),w+2*v,w+2*v-ft);const at=Math.round(.5*x.WIDTH-.5*N+this.selX*(w+2*b+T)+b+Math.floor(.5*w)-.5*x.TILESIZE),Rt=Math.round(.5*x.HEIGHT-.5*U+this.selY*(w+2*b+T)+b+Math.floor(.5*w)-.5*x.TILESIZE),jt=at/x.TILESIZE,ri=Rt/x.TILESIZE;(g=this.items[tt])==null||g.drawIcon(e,jt,ri)}}const V=this.selX+this.selY*this.cols;if(V<this.items.length&&this.items[V]!==null){const J=this.items[V];m.ctx.fillStyle="white";let z="";J instanceof vt&&(z=J.equipped?"[SPACE] to unequip":"[SPACE] to equip"),J instanceof dt&&(z="[SPACE] to use");const tt=m.measureText(z).width;m.fillText(z,Math.round(.5*(x.WIDTH-tt)),5);const ft=J.getDescription().split(`
`);let at=Math.round(.5*x.HEIGHT-.5*U+(this.rows+this.expansion)*(w+2*b+T)+b+5);ft.forEach(Rt=>{at=this.textWrap(Rt,5,at,x.WIDTH-10)})}}this.isOpen&&this.drawUsingItem(e,f+1,p+1,a,n,c),this.drawDraggedItem(e)});r(this,"isPointInInventoryBounds",(e,t)=>{const i=this.isOpen?Math.min(18,18*(Date.now()-this.openTime)/Ei):18,s=2,a=-2,n=1,c=this.cols*(i+2*s+a)-a;let l,d,u;return this.isOpen?(u=(this.rows+this._expansion)*(i+2*s+a)-a,l=Math.round(.5*x.WIDTH-.5*c),d=Math.round(.5*x.HEIGHT-.5*u)):(u=i+2*s,l=Math.round(.5*x.WIDTH-.5*c),d=Math.round(x.HEIGHT-u-5)),{inBounds:e>=l-n&&e<=l+c+n&&t>=d-n&&t<=d+u+n,startX:l,startY:d}});r(this,"isPointInQuickbarBounds",(e,t)=>{const i=this.isOpen?Math.min(18,18*(Date.now()-this.openTime)/Ei):18,s=2,a=-2,n=this.cols*(i+2*s+a)-a,c=Math.round(.5*x.WIDTH-.5*n),l=Math.round(x.HEIGHT-(i+2*s)-5),d=i+2*s;return{inBounds:e>=c&&e<=c+n&&t>=l&&t<=l+d,startX:c,startY:l}});r(this,"isPointInInventoryButton",(e,t)=>{const i=e/x.TILESIZE,s=t/x.TILESIZE;return i>=this.buttonX&&i<=this.buttonX+1&&s>=this.buttonY&&s<=this.buttonY+1});r(this,"drawInventoryButton",e=>{m.ctx.save(),this.buttonX=x.WIDTH/x.TILESIZE-1.25,this.buttonY=x.HEIGHT/x.TILESIZE-1.25,x.WIDTH<145&&(this.buttonY-=1.25),m.drawFX(0,0,1,1,this.buttonX,this.buttonY,1,1),m.ctx.restore()});r(this,"getQuickbarStartX",()=>{const s=Math.floor(this.cols*20- -2);return Math.round(.5*x.WIDTH-.5*s)});r(this,"handleMouseDown",(e,t,i)=>{if(this.player.menu.open||i!==0)return;if(this.isPointInInventoryBounds(e,t).inBounds){const a=this.itemAtSelectedSlot();a!==null&&(this._dragStartItem=a,this._dragStartSlot=this.selX+this.selY*this.cols)}});r(this,"initiateDrag",()=>{this._dragStartItem===null||this._isDragging||(this._isDragging=!0,this.grabbedItem=this._dragStartItem,this._dragStartSlot!==null&&(this.items[this._dragStartSlot]=null))});r(this,"onHoldDetected",()=>{this.initiateDrag()});r(this,"checkForDragStart",()=>{I.mouseDown&&I.isMouseHold?this.initiateDrag():I.isTapHold&&this.initiateDrag()});r(this,"handleMouseUp",(e,t,i)=>{if(this.player.menu.open||i!==0)return;const s=this.isPointInInventoryBounds(e,t),a=this.isPointInQuickbarBounds(e,t);if(this.isOpen?s.inBounds:a.inBounds)if(this._isDragging&&this.grabbedItem!==null){const c=this.selX+this.selY*this.cols;this.placeItemInSlot(c)}else this._dragStartItem!==null&&this.itemUse();else this.grabbedItem!==null&&(this.dropItem(this.grabbedItem,this._dragStartSlot),this.grabbedItem=null,this.items[this._dragStartSlot]=null,this.dragEndTime=Date.now());this._isDragging=!1,this._dragStartItem=null,this._dragStartSlot=null,this.grabbedItem=null});r(this,"placeItemInSlot",e=>{var i;if(this.grabbedItem===null)return;const t=this.items[e];t===null?this.items[e]=this.grabbedItem:(this._dragStartSlot!==null&&(this.items[this._dragStartSlot]=t),this.items[e]=this.grabbedItem);try{const s=this._dragStartSlot??e,a=e;(i=this.game.replayManager)==null||i.recordAction({type:"InventoryMove",fromIndex:s,toIndex:a})}catch{}this.grabbedItem=null});this.globalId=se.generate("INV"),this.game=e,this.player=t,this.buttonX=(Math.round(x.WIDTH/2)+3)/x.TILESIZE,this.buttonY=10,I.mouseDownListeners.push((a,n,c)=>this.handleMouseDown(a,n,c)),I.mouseUpListeners.push((a,n,c)=>this.handleMouseUp(a,n,c)),I.holdCallback=()=>this.onHoldDetected(),this.items=new Array((this.rows+this._expansion)*this.cols).fill(null),this.equipAnimAmount=new Array((this.rows+this._expansion)*this.cols).fill(0);let i=a=>{a!==null&&(a instanceof vt&&a.setWielder(this.player),a instanceof Et&&this.weapon===null&&(a.toggleEquip(),this.weapon=a),this.addItem(a))};(x.DEVELOPER_MODE?x.STARTING_DEV_INVENTORY:x.STARTING_INVENTORY).forEach(a=>{i(new a({game:this.game},0,0))})}get isDragging(){return this._isDragging}get expansion(){return this._expansion}set expansion(e){if(e!==this._expansion){const t=(this.rows+this._expansion)*this.cols;this._expansion=e;const i=(this.rows+this._expansion)*this.cols;i>t?(this.items.push(...Array(i-t).fill(null)),this.equipAnimAmount.push(...Array(i-t).fill(0))):i<t&&(this.items.length=i,this.equipAnimAmount.length=i)}}expandInventory(e){this.expansion+=e}}let Ah=class{constructor(e,t){r(this,"game");r(this,"mapData",[]);r(this,"oldMapData",[]);r(this,"depth");r(this,"scale");r(this,"offsetX",0);r(this,"offsetY",0);r(this,"softOffsetX",0);r(this,"softOffsetY",0);r(this,"player");r(this,"seenTilesByMapGroup",new globalThis.Map);r(this,"visibilityRadius",4);r(this,"getDownLaddersFromRoom",e=>{const t=[];if(e.roomArray){for(let i=e.roomX;i<e.roomX+e.width;i++)for(let s=e.roomY;s<e.roomY+e.height;s++)if(e.roomArray[i]&&e.roomArray[i][s]){const a=e.roomArray[i][s];a&&a.constructor&&a.constructor.name==="DownLadder"&&t.push(a)}}return t});r(this,"saveMapData",()=>{this.clearMap();const e=this.game.room.mapGroup.toString();for(const i of this.game.levels[this.player.depth].rooms)e===i.mapGroup.toString()&&(i.entered===!0||x.DEVELOPER_MODE)&&this.mapData.push({room:i,walls:i.innerWalls,doors:i.doors,entities:i.entities,items:i.items,players:this.game.players,downLadders:this.getDownLaddersFromRoom(i),seenTiles:this.seenTilesByMapGroup.get(e)||new Set});const t=this.mapData.map(i=>i.room).filter(i=>i.entered);if(t.length>0){const i=[...t].sort((c,l)=>c.roomX-l.roomX),s=[...t].sort((c,l)=>c.roomY-l.roomY),a=i[i.length-1].roomX,n=s[0].roomY;this.offsetX=a,this.offsetY=n}else this.offsetX=0,this.offsetY=0});r(this,"clearMap",()=>{this.mapData=[]});r(this,"saveOldMap",()=>{this.oldMapData=[...this.mapData]});r(this,"renderMap",e=>{m.ctx.save(),this.setInitialCanvasSettings(1),this.translateCanvas(0);for(const t of this.mapData)this.drawRoom(t,e);this.resetCanvasTransform(),m.ctx.restore()});r(this,"updateOffsetXY",()=>{let e=this.offsetX-this.softOffsetX,t=this.offsetY-this.softOffsetY;Math.abs(e)>.01?(this.softOffsetX+=e*.1,this.softOffsetX=this.softOffsetX):this.softOffsetX=this.offsetX,Math.abs(t)>.01?(this.softOffsetY+=t*.1,this.softOffsetY=this.softOffsetY):this.softOffsetY=this.offsetY});r(this,"updateSeenTiles",()=>{const e=Math.floor(this.player.x),t=Math.floor(this.player.y),i=this.game.room.mapGroup.toString();this.seenTilesByMapGroup.has(i)||this.seenTilesByMapGroup.set(i,new Set);const s=this.seenTilesByMapGroup.get(i);for(let a=-this.visibilityRadius;a<=this.visibilityRadius;a++)for(let n=-this.visibilityRadius;n<=this.visibilityRadius;n++)if(Math.sqrt(a*a+n*n)<=this.visibilityRadius){const l=`${e+a},${t+n}`;s.add(l)}});r(this,"isTileSeen",(e,t)=>{const i=this.game.room.mapGroup.toString(),s=this.seenTilesByMapGroup.get(i);if(!s)return!1;const a=`${Math.floor(e)},${Math.floor(t)}`;return s.has(a)});r(this,"draw",e=>{this.updateSeenTiles(),this.updateOffsetXY(),this.renderMap(e)});r(this,"setInitialCanvasSettings",e=>{m.ctx.globalAlpha=e,m.ctx.globalCompositeOperation="source-over"});r(this,"translateCanvas",e=>{m.ctx.translate(Math.floor(.95*x.WIDTH)-15*this.scale-Math.floor(this.softOffsetX),Math.floor(.05*x.HEIGHT)-1*this.scale-e-Math.floor(this.softOffsetY))});r(this,"drawRoom",(e,t)=>{this.drawRoomOutline(e.room),this.drawRoomWalls(e.walls),this.drawRoomDoors(e.doors),this.drawRoomEntities(e.entities),this.drawRoomItems(e.items),this.drawRoomPlayers(e.players,t),this.drawRoomDownLadders(e.downLadders),this.drawFogOfWar(e.room)});r(this,"drawFogOfWar",e=>{const t=this.scale;m.ctx.save(),m.ctx.fillStyle="#1a1a1a";const i=this.game.room.mapGroup.toString();let s=this.seenTilesByMapGroup.get(i);this.mapData.length>0&&this.mapData[0].seenTiles&&(s=this.mapData[0].seenTiles);for(let a=e.roomX;a<e.roomX+e.width;a++)for(let n=e.roomY;n<e.roomY+e.height;n++){const c=`${Math.floor(a)},${Math.floor(n)}`;(!s||!s.has(c))&&m.ctx.fillRect(a*t,n*t,1*t,1*t)}m.ctx.restore()});r(this,"drawRoomOutline",e=>{const t=this.scale;m.ctx.fillStyle="#5A5A5A",m.ctx.fillRect(e.roomX*t+0,e.roomY*t+0,e.width*t-0,e.height*t-0),e.type===R.UPLADDER&&(m.ctx.fillStyle="#101460"),e.type===R.DOWNLADDER&&(m.ctx.fillStyle="#601410"),m.ctx.fillStyle="black",m.ctx.fillRect(e.roomX*t+1,e.roomY*t+1,e.width*t-2,e.height*t-2)});r(this,"drawRoomWalls",e=>{const t=this.scale;m.ctx.save();for(const i of e)m.ctx.fillStyle="#404040",m.ctx.fillRect(i.x*t,i.y*t,1*t,1*t);m.ctx.restore()});r(this,"drawRoomDoors",e=>{const t=this.scale;m.ctx.save();for(const i of e)i.opened===!1&&(m.ctx.fillStyle="#5A5A5A"),i.opened===!0&&(m.ctx.fillStyle="black",m.ctx.fillRect(i.x*t,i.y*t,1*t,1*t)),m.ctx.fillStyle="#5A5A5A";m.ctx.restore()});r(this,"drawRoomPlayers",(e,t)=>{const i=this.scale;m.ctx.save();for(const s in e)m.ctx.fillStyle="white",this.game.levels[e[s].depth].rooms[e[s].levelID].mapGroup===this.game.room.mapGroup&&m.ctx.fillRect(e[s].x*i,e[s].y*i,1*i,1*i);m.ctx.restore()});r(this,"drawUnderRoomPlayers",(e,t)=>{const i=this.scale;m.ctx.save();for(const s in e)this.game.rooms[e[s].levelID].mapGroup,this.game.room.mapGroup,Math.floor(Date.now()/300)%2&&(m.ctx.fillStyle="#4D8C8C",m.ctx.fillRect((e[s].x-1)*i,(e[s].y-1)*i,1*i,1*i),m.ctx.fillRect(e[s].x*i,(e[s].y-1)*i,1*i,1*i),m.ctx.fillRect((e[s].x+1)*i,(e[s].y-1)*i,1*i,1*i),m.ctx.fillRect((e[s].x-1)*i,e[s].y*i,1*i,1*i),m.ctx.fillRect((e[s].x+1)*i,e[s].y*i,1*i,1*i),m.ctx.fillRect((e[s].x-1)*i,(e[s].y+1)*i,1*i,1*i),m.ctx.fillRect(e[s].x*i,(e[s].y+1)*i,1*i,1*i),m.ctx.fillRect((e[s].x+1)*i,(e[s].y+1)*i,1*i,1*i));m.ctx.restore()});r(this,"drawRoomEntities",e=>{const t=this.scale;m.ctx.save();for(const i of e)this.setEntityColor(i),m.ctx.fillRect(i.x*t,i.y*t,1*t,1*t);m.ctx.restore()});r(this,"drawRoomDownLadders",e=>{const t=this.scale;m.ctx.save();for(const i of e)m.ctx.fillStyle="#00FFFF",m.ctx.fillRect(i.x*t,i.y*t,1*t,1*t);m.ctx.restore()});r(this,"setEntityColor",e=>{e.type===gt.ENEMY&&(m.ctx.fillStyle="yellow"),e.type===gt.PROP&&(m.ctx.fillStyle="#847e87"),e.type===gt.RESOURCE&&(m.ctx.fillStyle="#5a595b"),e.type===gt.FRIENDLY&&(m.ctx.fillStyle="cyan")});r(this,"drawRoomItems",e=>{const t=this.scale;m.ctx.save();for(const i of e)i.x,i.y,m.ctx.fillStyle="#ac3232",i.pickedUp||m.ctx.fillRect(i.x*t,i.y*t,1*t,1*t);m.ctx.restore()});r(this,"resetCanvasTransform",()=>{m.ctx.setTransform(1,0,0,1,0,0)});this.game=e,this.scale=1,this.player=t}};class He extends it{constructor(t,i,s,a){super(t,i,s,a);r(this,"ticks");r(this,"seenPlayer");r(this,"shieldedEnemies");r(this,"range");r(this,"lastHealth");r(this,"hit",()=>1);r(this,"uniqueKillBehavior",()=>{this.unshieldEnemies(),this.removeLightSource(this.lightSource),this.lightSource=null});r(this,"behavior",()=>{this.lastX=this.x,this.lastY=this.y;let t=this.enemyShieldCandidates();if(!this.dead){if(this.skipNextTurns>0){this.skipNextTurns--;return}this.ticks++,this.ticks%2===0&&(this.shieldEnemies(t),this.updateShieldedEnemies(),this.runAway())}this.shieldedEnemies.length>0?this.shadeColor="#2E0854":this.shadeColor="#000000",this.lightSource&&this.lightSource.updatePosition(this.x+.5,this.y+.5)});r(this,"onHurt",(t=1)=>{this.health<this.lastHealth&&this.health%2===0&&this.health>0&&this.teleport(),this.lastHealth=this.health});r(this,"updateShieldedEnemies",()=>{this.shieldedEnemies.forEach(t=>{t.dead&&(this.shieldedEnemies=this.shieldedEnemies.filter(i=>i!==t))})});r(this,"shieldEnemies",t=>{t.length>0&&t.forEach(i=>{const s=Q.distance(this.x,this.y,i.x,i.y);O.rand()*10>s&&this.applyShieldTo(i)})});r(this,"enemyShieldCandidates",()=>this.room.entities.filter(i=>i instanceof it&&Q.distance(this.x,this.y,i.x,i.y)<=this.range&&!i.shielded&&!i.dead&&i!==this&&!i.shieldedBefore).slice(0,G.MAX_OCCULTIST_SHIELDS));r(this,"unshieldEnemies",()=>{if(this.shieldedEnemies.length>0){for(let t of this.shieldedEnemies)t.cloned||t.removeShield();this.shieldedEnemies=[]}});r(this,"applyShieldTo",t=>{if(this.shadeMultiplier=1.5,t.applyShield(),this.shieldedEnemies.push(t),t.shielded&&t.shield){let i=new de(t.x,t.y,this.x,this.y,t);i.compositeOperation="source-over",i.color="#2E0854",i.turbulence=.4,i.gravity=.1,i.iterations=1,i.segments=100,i.angleChange=.001,i.springDamping=.01,i.drawableY=t.drawableY,i.type="shield",this.room.projectiles.push(i)}});r(this,"updateBeam",t=>{for(let i of this.room.projectiles)if(i instanceof de){if(!this.shieldedEnemies.includes(i.parent)||i.type!=="shield")continue;switch(i.setTarget(this.x-this.drawX,this.y-this.drawY,i.parent.x-i.parent.drawX,i.parent.y-i.parent.drawY),i.drawableY=i.parent.drawableY,Math.floor(this.frame)){case 0:i.color="#2e0854";break;case 1:i.color="#331988";break;case 2:i.color="#4729db";break;case 3:i.color="#331988";break}}});r(this,"draw",t=>{this.dead||(m.ctx.save(),m.ctx.globalAlpha=this.alpha,this.drawableY=this.y,this.dead||(this.updateDrawXY(t),this.updateBeam(t),this.frame+=.1*t,this.frame>=4&&(this.frame=0),this.hasShadow&&this.drawShadow(t),m.drawMob(this.tileX+Math.floor(this.frame),this.tileY,1,2,this.x-this.drawX,this.y-this.drawYOffset-this.drawY,1,2,this.softShadeColor,this.shadeAmount())),m.ctx.restore())});this.ticks=0,this.health=4,this.lastHealth=this.health,this.maxHealth=4,this.tileX=55,this.tileY=8,this.seenPlayer=!0,this.name="occultist",this.range=6,this.aggro=!1,this.frame=0,this.hasShadow=!0,this.shieldedBefore=!1,this.shieldedEnemies=[],this.shadeColor="#000000",this.lightSource=Xe.newLightSource(this.x+.5,this.y+.5,[20,0,40],3.5,20),this.addLightSource(this.lightSource),this.room.updateLighting(),this.hasBloom=!0,this.bloomColor="#2E0854",this.bloomAlpha=1,this.softBloomAlpha=0,this.dropChance=1,this.getDrop(["occultist"],!1),this.pushable=!1,this.chainPushable=!1}}r(He,"tileX",55),r(He,"tileY",8);const kh={CrabEnemy:Bt,FrogEnemy:fe,ZombieEnemy:te,SkullEnemy:_t,EnergyWizardEnemy:Mt,ChargeEnemy:Ft,RookEnemy:Gt,BishopEnemy:Pt,ArmoredzombieEnemy:Ct,BigSkullEnemy:Nt,QueenEnemy:Xt,KnightEnemy:Lt,BigKnightEnemy:Ut,FireWizardEnemy:Jt,Spawner:Ee,OccultistEnemy:He};class Sn{constructor(e,t){r(this,"game");r(this,"player");r(this,"isOpen",!1);r(this,"openTime",Date.now());r(this,"entries");r(this,"seenEnemies");r(this,"frame",0);r(this,"activeEntryIndex",0);r(this,"buttonY");r(this,"buttonX");r(this,"open",()=>{this.seenEnemies.size===0&&(this.seenEnemies=this.game.tutorialListener.seenEnemies),this.isOpen=!0,this.openTime=Date.now()});r(this,"close",()=>{this.isOpen=!1});r(this,"entryUp",()=>{this.activeEntryIndex=(this.activeEntryIndex-1+this.entries.length)%this.entries.length});r(this,"entryDown",()=>{this.activeEntryIndex=(this.activeEntryIndex+1)%this.entries.length});r(this,"toggleOpen",()=>{this.isOpen?this.close():this.open()});r(this,"addEntry",e=>{const t=kh[e.name];this.entries.push({name:e.name,description:t.prototype.description,tileX:t.prototype.tileX,tileY:t.prototype.tileY})});r(this,"draw",e=>{if(!this.isOpen)return;m.ctx.save(),m.ctx.fillStyle="rgba(0, 0, 0, 0.8)",m.ctx.fillRect(0,0,x.WIDTH,x.HEIGHT);const t=Math.min(18,18*(Date.now()-this.openTime)/100),i=2,s=-2,a=1,n=5*(t+2*i+s)-s,c=4*(t+2*i+s)-s,l=Math.round(.5*x.WIDTH-.5*n)-a,d=Math.round(.5*x.HEIGHT-.5*c)-a;m.ctx.fillStyle="white",m.ctx.fillRect(l,d,n+2*a,c+2*a),m.ctx.fillStyle="black";const u=10;this.entries.length===0?m.fillText("No enemies seen yet",l+u,d+u):(this.entries.forEach((h,f)=>{m.fillText(h.name,l+u,d+u+f*20)}),this.drawEnemySprite(this.entries[this.activeEntryIndex].tileX,this.entries[this.activeEntryIndex].tileY,e)),this.drawLogbookButton(e),m.ctx.restore()});r(this,"drawEnemySprite",(e,t,i)=>{this.frame+=Math.round(.1*i*10)/10,this.frame>=4&&(this.frame=0),m.drawMob(e,t,1,1,1,1,1,1,"Black",0)});r(this,"drawLogbookButton",e=>{m.ctx.save(),this.buttonX=q.SCREEN_W-2,this.buttonY=q.SCREEN_H-2.25,m.drawFX(0,0,2,2,this.buttonX,this.buttonY,2,2),m.ctx.restore()});r(this,"handleMouseDown",(e,t,i)=>{i===0&&this.isPointInLogbookButton(e,t)&&this.toggleOpen()});r(this,"handleMouseUp",(e,t,i)=>{});r(this,"onHoldDetected",()=>{});r(this,"isPointInLogbookButton",(e,t)=>{const i=e/x.TILESIZE,s=t/x.TILESIZE;return i>=this.buttonX&&i<=this.buttonX+2&&s>=this.buttonY&&s<=this.buttonY+2});r(this,"tick",()=>{this.isOpen});this.game=e,this.player=t,this.entries=[],this.activeEntryIndex=0,this.buttonX=Math.round((Math.round(x.WIDTH/2)+3)/x.TILESIZE),this.buttonY=Math.round(10),this.seenEnemies=new Set}}class Oh{constructor(e){r(this,"player");r(this,"mostRecentInput");r(this,"mostRecentMoveInput");r(this,"moveStartTime");r(this,"mouseHoldInitialDirection",null);r(this,"handleNumKey",e=>{if(!this.player.menu.open){if(this.setMostRecentInput("keyboard"),e<=5)this.player.actionProcessor.process({type:"InventorySelect",index:e-1});else if(x.DEVELOPER_MODE)switch(e){case 6:x.SET_SHADE_LAYER_COMPOSITE_OPERATION(!0);break;case 7:x.SET_SHADE_LAYER_COMPOSITE_OPERATION(!1);break}}});r(this,"ignoreDirectionInput",()=>this.player.inventory.isOpen||this.player.dead||this.player.game.levelState!==Qt.IN_LEVEL||this.player.menu.open||this.player.inventory.isPointInQuickbarBounds(I.mouseX,I.mouseY).inBounds&&this.player.game.isMobile);r(this,"setMostRecentInput",e=>{this.mostRecentInput=e});r(this,"setMostRecentMoveInput",e=>{this.mostRecentMoveInput=e});r(this,"mouseAngle",()=>{const e=pt.getInstance().getPosition(),t={x:x.WIDTH/2,y:x.HEIGHT/2},i=e.x-t.x,s=e.y-t.y;return Math.atan2(s,i)});r(this,"faceMouse",()=>{if(this.mostRecentMoveInput==="keyboard"||x.isMobile)return;const e=this.mouseAngle();e>=-Math.PI/4&&e<Math.PI/4?this.player.direction=E.RIGHT:e>=Math.PI/4&&e<3*Math.PI/4?this.player.direction=E.DOWN:e>=-3*Math.PI/4&&e<-Math.PI/4?this.player.direction=E.UP:this.player.direction=E.LEFT});this.player=e,this.mostRecentInput="keyboard",this.mostRecentMoveInput="keyboard",this.moveStartTime=0,e.isLocalPlayer&&this.setupListeners()}setupListeners(){try{I.mouseRightClickListeners.length=0,I.mouseLeftClickListeners.length=0}catch{}I.leftSwipeListener=()=>this.handleInput(W.LEFT),I.rightSwipeListener=()=>this.handleInput(W.RIGHT),I.upSwipeListener=()=>this.handleInput(W.UP),I.downSwipeListener=()=>this.handleInput(W.DOWN),I.commaListener=()=>this.handleInput(W.COMMA),I.periodListener=()=>this.handleInput(W.PERIOD),I.tapListener=()=>this.handleTap(),I.mouseMoveListener=()=>this.handleInput(W.MOUSE_MOVE),I.mouseRightClickListeners.push(()=>this.handleInput(W.RIGHT_CLICK)),I.mouseDownListeners.push((e,t,i)=>this.handleMouseDown(e,t,i)),I.numKeyListener=e=>this.handleInput(W.NUMBER_1+e-1),I.equalsListener=()=>this.handleInput(W.EQUALS),I.minusListener=()=>this.handleInput(W.MINUS),I.escapeListener=()=>this.handleInput(W.ESCAPE),I.fListener=()=>this.handleInput(W.F)}handleInput(e){if(!(this.player.busyAnimating||this.player.game.cameraAnimation.active)&&!((this.player.game.levelState===Qt.TRANSITIONING||this.player.game.levelState===Qt.TRANSITIONING_LADDER)&&e!==W.MOUSE_MOVE)){if(this.player.menu.open){this.player.menu.inputHandler(e);return}if(!this.player.game.started&&e!==W.MOUSE_MOVE){if(this.player.game.startMenuActive)return;this.player.game.startedFadeOut=!0;return}switch(e){case W.I:{const i=this.player.inventory;this.player.actionProcessor.process({type:i.isOpen?"CloseInventory":"OpenInventory"});break}case W.Q:this.player.actionProcessor.process({type:"InventoryDrop"});break;case W.F:break;case W.LEFT:this.ignoreDirectionInput()||this.player.actionProcessor.process({type:"Move",direction:E.LEFT,targetX:this.player.x-1,targetY:this.player.y});break;case W.RIGHT:this.ignoreDirectionInput()||this.player.actionProcessor.process({type:"Move",direction:E.RIGHT,targetX:this.player.x+1,targetY:this.player.y});break;case W.UP:this.ignoreDirectionInput()||this.player.actionProcessor.process({type:"Move",direction:E.UP,targetX:this.player.x,targetY:this.player.y-1});break;case W.DOWN:this.ignoreDirectionInput()||this.player.actionProcessor.process({type:"Move",direction:E.DOWN,targetX:this.player.x,targetY:this.player.y+1});break;case W.SPACE:const t=this.player;if(this.setMostRecentInput("keyboard"),t.game.chatOpen)return;if(t.dead){t.restart();return}if(this.player.openVendingMachine&&this.player.openVendingMachine.open){this.player.openVendingMachine.space();break}(t.inventory.isOpen||t.game.levelState===Qt.IN_LEVEL)&&(this.setMostRecentInput("keyboard"),this.player.actionProcessor.process({type:"InventoryUse"}));break;case W.COMMA:this.setMostRecentInput("keyboard"),this.player.actionProcessor.process({type:"InventoryLeft"});break;case W.PERIOD:this.setMostRecentInput("keyboard"),this.player.actionProcessor.process({type:"InventoryRight"});break;case W.LEFT_CLICK:this.handleMouseLeftClick();break;case W.RIGHT_CLICK:this.handleMouseRightClick();break;case W.MOUSE_MOVE:if(this.setMostRecentInput("mouse"),this.player.inventory.mouseMove(),I.mouseDown&&I.mouseDownHandled){let i=!1;const s=I.mouseX-I.lastMouseDownX,a=I.mouseY-I.lastMouseDownY,n=Math.sqrt(s*s+a*a),c=x.TILESIZE*1.5;n>c&&(i=!0),this.mouseHoldInitialDirection!==null&&this.player.direction!==this.mouseHoldInitialDirection&&(i=!0),i&&(I.mouseDownHandled=!1,I.lastMouseDownTime=0,this.mouseHoldInitialDirection=null)}(!this.ignoreDirectionInput()||x.isMobile)&&(this.faceMouse(),this.player.setTileCursorPosition());break;case W.NUMBER_1:case W.NUMBER_2:case W.NUMBER_3:case W.NUMBER_4:case W.NUMBER_5:case W.NUMBER_6:case W.NUMBER_7:case W.NUMBER_8:case W.NUMBER_9:this.setMostRecentInput("keyboard"),this.handleNumKey(e-13);break;case W.EQUALS:this.player.game.increaseScale();break;case W.MINUS:this.player.game.decreaseScale();break;case W.ESCAPE:this.player.inventory.close();break}}}handleMouseRightClick(){this.setMostRecentInput("mouse");const{x:e,y:t}=pt.getInstance().getPosition();this.player.inventory.isPointInInventoryBounds(e,t).inBounds&&this.player.inventory.drop()}handleMouseDown(e,t,i){var l,d;if(i!==0)return;const s=this.player;if(s.game.levelState!==Qt.IN_LEVEL){if(!s.game.started&&s.game.startMenuActive){(l=s.game.startMenu)==null||l.mouseInputHandler(e,t),I.mouseDownHandled=!0;return}I.mouseDownHandled=!1;return}if(this.setMostRecentInput("mouse"),s.dead){this.handleDeathScreenInput(e,t),I.mouseDownHandled=!0;return}if(!s.game.started){s.game.startMenuActive?(d=s.game.startMenu)==null||d.mouseInputHandler(e,t):s.game.startedFadeOut=!0,I.mouseDownHandled=!0;return}I.lastMouseDownTime=Date.now(),I.lastMouseDownX=e,I.lastMouseDownY=t;const a=s.inventory;if(a.isOpen&&!a.isPointInInventoryBounds(e,t).inBounds||a.isPointInInventoryButton(e,t)){a.toggleOpen(),I.mouseDownHandled=!0;return}if(this.player.menu.open){this.player.menu.mouseInputHandler(e,t),I.mouseDownHandled=!0;return}if(this.isPointInMenuButtonBounds(e,t)){this.handleMenuButtonClick(),I.mouseDownHandled=!0;return}if(s.openVendingMachine){ut.isPointInVendingMachineBounds(e,t,s.openVendingMachine)?s.openVendingMachine.space():s.openVendingMachine.close(),I.mouseDownHandled=!0;return}a.isPointInInventoryButton(e,t)||a.isPointInQuickbarBounds(e,t).inBounds||a.isOpen||this.isPointInMenuButtonBounds(e,t)?I.mouseDownHandled=!1:!s.busyAnimating&&!s.game.cameraAnimation.active?(this.mouseHoldInitialDirection=this.player.direction,s.moveWithMouse(),I.mouseDownHandled=!0):I.mouseDownHandled=!1}handleMouseLeftClick(){var l;const e=this.player,t=pt.getInstance(),{x:i,y:s}=t.getPosition();if(e.game.levelState!==Qt.IN_LEVEL){!e.game.started&&e.game.startMenuActive&&((l=e.game.startMenu)==null||l.mouseInputHandler(i,s));return}if(this.setMostRecentInput("mouse"),e.dead){this.handleDeathScreenInput(i,s);return}const a=e.inventory;if((a.isOpen&&!a.isPointInInventoryBounds(i,s).inBounds||a.isPointInInventoryButton(i,s))&&a.toggleOpen(),this.player.menu.open){this.player.menu.mouseInputHandler(i,s);return}if(this.isPointInMenuButtonBounds(i,s)){this.handleMenuButtonClick();return}if(e.openVendingMachine){if(ut.isPointInVendingMachineBounds(i,s,e.openVendingMachine))e.openVendingMachine.space();else{e.openVendingMachine.close(),this.setMostRecentInput("mouse");const{x:d,y:u}=pt.getInstance().getPosition();this.player.inventory.isPointInInventoryBounds(d,u)}return}!a.isPointInInventoryButton(i,s)&&!a.isPointInQuickbarBounds(i,s).inBounds&&!a.isOpen&&!I.mouseDownHandled&&e.moveWithMouse()}handleTap(){var a;if(I.mouseDownHandled)return;if(this.player.dead){this.handleDeathScreenInput(I.mouseX,I.mouseY);return}else if(!this.player.game.started){this.player.game.startMenuActive?(a=this.player.game.startMenu)==null||a.mouseInputHandler(I.mouseX,I.mouseY):this.player.game.startedFadeOut=!0;return}if(this.player.menu.open){this.player.menu.mouseInputHandler(I.mouseX,I.mouseY);return}const e=I.mouseX,t=I.mouseY;if(this.isPointInMenuButtonBounds(e,t)){this.handleMenuButtonClick();return}const i=this.player.inventory.isPointInInventoryBounds(e,t).inBounds,s=this.player.inventory.isPointInQuickbarBounds(e,t).inBounds;if(this.player.openVendingMachine&&this.player.openVendingMachine.open){const n=ut.isPointInVendingMachineBounds(I.mouseX,I.mouseY,this.player.openVendingMachine);if(n){this.player.openVendingMachine.space();return}else if(!n){this.player.openVendingMachine.close(),this.setMostRecentInput("mouse");const{x:c,y:l}=pt.getInstance().getPosition();this.player.inventory.isPointInInventoryBounds(c,l)}return}!this.player.inventory.isOpen&&this.player.inventory.isPointInInventoryButton(e,t)?this.player.inventory.open():this.player.inventory.isOpen?i?this.handleInput(W.LEFT_CLICK):this.player.inventory.close():s&&this.handleInput(W.LEFT_CLICK)}handleKeyboardKey(e){switch(e.toUpperCase()){case"A":case"ARROWLEFT":this.handleInput(W.LEFT);break;case"D":case"ARROWRIGHT":this.handleInput(W.RIGHT);break;case"W":case"ARROWUP":this.handleInput(W.UP);break;case"S":case"ARROWDOWN":this.handleInput(W.DOWN);break;case" ":this.handleInput(W.SPACE);break;case"I":this.handleInput(W.I);break;case"Q":this.handleInput(W.Q);break}}isPointInMuteButtonBounds(e,t){const i=x.TILESIZE;return e>=0&&e<=i&&t>=0&&t<=i*1.5}handleMuteButtonClick(){bn.toggleMute(),this.player.game.pushMessage(H.audioMuted?"Audio muted":"Audio unmuted")}isPointInMenuButtonBounds(e,t){const i=x.TILESIZE;return e>=0&&e<=i*1.5&&t>=0&&t<=i}handleMenuButtonClick(){this.player.menu.toggleOpen()}handleDeathScreenInput(e,t){this.isInteractingWithFeedbackButton(e,t)?this.player.game.feedbackButton.onClick():this.player.restart()}isInteractingWithFeedbackButton(e,t){return this.player.game.feedbackButton&&this.player.game.feedbackButton.isPointInButton(e,t)}}class Mh{constructor(e){r(this,"player");this.player=e}process(e){var t;try{(t=this.player.game.replayManager)==null||t.recordAction(e)}catch{}switch(e.type){case"Move":this.player.movement.move(e.direction,e.targetX,e.targetY);break;case"MouseMove":this.player.movement.moveMouse(e.direction,e.targetX,e.targetY);break;case"OpenInventory":this.player.inventory.open();break;case"CloseInventory":this.player.inventory.close();break;case"InventoryLeft":this.player.inventory.leftQuickbar();break;case"InventoryRight":this.player.inventory.rightQuickbar();break;case"InventoryUse":this.player.inventory.spaceQuickbar();break;case"InventoryDrop":this.player.inventory.drop();break;case"InventorySelect":this.player.inventory.selX=Math.max(0,Math.min(e.index,this.player.inventory.cols-1)),this.player.inventory.selY=0,this.player.inventory.spaceQuickbar();break;case"InventoryMove":{const i=Math.max(0,Math.min(e.fromIndex,this.player.inventory.cols*(this.player.inventory.rows+this.player.inventory.expansion)-1)),s=Math.max(0,Math.min(e.toIndex,this.player.inventory.cols*(this.player.inventory.rows+this.player.inventory.expansion)-1)),a=this.player.inventory.items[i];if(a){const n=this.player.inventory.items[s];this.player.inventory.items[i]=n,this.player.inventory.items[s]=a}break}case"Restart":this.player.restart();break;case"Attack":console.warn("Attack action received but not yet implemented.");break;case"Interact":this.player.tryMove(e.target.x,e.target.y);break}}}class Ph{constructor(e){r(this,"player");r(this,"moveQueue",[]);r(this,"isProcessingQueue",!1);r(this,"animationFrameId",null);r(this,"moveRange",1);r(this,"lastMoveTime",0);r(this,"lastChangeDirectionTime",0);r(this,"adjustedCooldown",0);r(this,"moveRangeCheck",(e,t)=>{const i=Math.abs(this.player.x-e),s=Math.abs(this.player.y-t);return i<=this.moveRange&&s<=this.moveRange&&(i===0||s===0)&&i+s!==0});r(this,"queueHandler",()=>{if(!this.isProcessingQueue)return;const e=Date.now(),t=x.MOVEMENT_COOLDOWN;if(e-this.lastMoveTime>=t)if(this.moveQueue.length>0){const i=this.moveQueue.shift();this.handleMoveLoop(i),this.lastMoveTime=e}else this.stopQueueProcessing();this.animationFrameId=requestAnimationFrame(this.queueHandler)});this.player=e}move(e,t,i){if(!(e in E)||!this.player)return;const s=this.getTargetCoords(e,t,i);if(!s)return;const{x:a,y:n}=s;if(this.canMove()){const c=Date.now();this.lastMoveTime=c,this.lastChangeDirectionTime=c,this.player.inputHandler.setMostRecentMoveInput("keyboard"),this.player.lastDirection=this.player.direction,this.player.direction=e,this.player.tryMove(a,n)}else this.queueMove(a,n,e)}moveMouse(e,t,i){if(!(e in E)||!this.player||x.isMobile)return;const s=this.getTargetCoords(e,t,i);if(!s)return;const{x:a,y:n}=s;if(!(a===void 0||n===void 0))if(this.canMove()){const c=Date.now();this.lastMoveTime=c,this.player.inputHandler.setMostRecentMoveInput("mouse"),this.player.direction=e,this.player.tryMove(a,n)}else this.queueMove(a,n,e)}getTargetCoords(e,t,i){if(t!==void 0&&i!==void 0&&t!==null&&i!==null)return{x:t,y:i};switch(e){case E.LEFT:return{x:this.player.x-1,y:this.player.y};case E.RIGHT:return{x:this.player.x+1,y:this.player.y};case E.UP:return{x:this.player.x,y:this.player.y-1};case E.DOWN:return{x:this.player.x,y:this.player.y+1};default:return null}}inventoryClosedRecently(){const e=Date.now()-this.player.inventory.dragEndTime,t=Date.now()-this.player.inventory.closeTime;return e<10||t<10}canMove(){if(this.player.busyAnimating||this.inventoryClosedRecently())return!1;const e=Date.now();let t=x.MOVEMENT_COOLDOWN;return e-this.lastMoveTime>=t}canQueue(){if(this.player.busyAnimating||this.inventoryClosedRecently())return!1;const e=Date.now();let t=x.MOVEMENT_QUEUE_COOLDOWN;return e-this.lastMoveTime>=t}queueMove(e,t,i){this.canQueue()&&(e===void 0||t===void 0||this.moveQueue.length>0||(this.moveQueue.push({x:e,y:t,direction:i}),this.startQueueProcessing()))}handleMoveLoop({x:e,y:t,direction:i}){this.player.inputHandler.mostRecentMoveInput==="mouse"?this.moveMouse(i,e,t):this.move(i,e,t)}startQueueProcessing(){this.isProcessingQueue||(this.isProcessingQueue=!0,this.animationFrameId=requestAnimationFrame(()=>this.queueHandler()))}stopQueueProcessing(){this.isProcessingQueue=!1,this.animationFrameId!==null&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null)}}const Be=class Be{};r(Be,"settings",{enabled:!0,globalAlpha:.15,fillStyle:"#006A6E",globalCompositeOperation:"screen"}),r(Be,"underwater",!1),r(Be,"draw",e=>{Be.settings.enabled&&(m.ctx.save(),m.ctx.globalAlpha=Be.settings.globalAlpha,m.ctx.globalCompositeOperation=Be.settings.globalCompositeOperation,m.ctx.fillStyle=Be.settings.fillStyle,m.ctx.fillRect(0,0,x.WIDTH,x.HEIGHT),m.ctx.restore())});let rs=Be;class lo{static getHoverText(e,t,i,s,a){var p;if(I.mouseX===void 0||I.mouseY===void 0||a==="none")return[];const n=x.WIDTH/2,c=x.HEIGHT/2,l=Math.floor((I.mouseX-n+x.TILESIZE/2)/x.TILESIZE),d=Math.floor((I.mouseY-c+x.TILESIZE/2)/x.TILESIZE),u=e+l,h=t+d,f=[];if(a==="inGame"&&!s.inventory.isPointInQuickbarBounds(e,t).inBounds){for(const g of i.entities)g.x===u&&g.y===h&&f.push(g.hoverText());for(const g of i.items)g.x===u&&g.y===h&&f.push(g.hoverText());const y=i.getTile(u,h);y&&f.push(y.getName())}else a==="inventory"?s.inventory.itemAtSelectedSlot()&&f.push((p=s.inventory.itemAtSelectedSlot())==null?void 0:p.hoverText()):s.openVendingMachine&&f.push(s.openVendingMachine.hoverText());return f}static draw(e,t,i,s,a,n,c,l){const d=lo.getHoverText(t,i,s,a,l);if(d.length!==0&&(m.ctx.save(),l!=="none")){for(const u of d){d.indexOf(u)*6,l==="inventory"?m.ctx.globalAlpha=1:m.ctx.globalAlpha=.5,m.ctx.fillStyle="yellow",m.measureText(u).width/2;let h=t,f=i;switch(l){case"inGame":h=n+8,f=c+8;break;case"inventory":h=n+8,f=c+8;break;case"vendingMachine":h=n+8,f=c+8;break}m.fillTextOutline(u,h,f,"black","yellow")}m.ctx.restore()}}}var Rh="2.0.4",Va=500,Mo="user-agent",cs="",Po="?",Er="function",di="undefined",ds="object",ja="string",Zt="browser",Ue="cpu",Pe="device",ge="engine",ne="os",as="result",_="name",C="type",Y="vendor",X="version",zt="architecture",Vs="major",L="model",Ps="console",$="mobile",lt="tablet",Tt="smarttv",Ae="wearable",cr="xr",Rs="embedded",bs="inapp",co="brands",Ii="formFactors",fo="fullVersionList",os="platform",uo="platformVersion",ha="bitness",bi="sec-ch-ua",Dh=bi+"-full-version-list",Ch=bi+"-arch",Lh=bi+"-"+ha,Yh=bi+"-form-factors",_h=bi+"-"+$,Nh=bi+"-"+L,Tn=bi+"-"+os,Xh=Tn+"-version",In=[co,fo,$,L,os,uo,zt,Ii,ha],dr="Amazon",qi="Apple",Ro="ASUS",Do="BlackBerry",Si="Google",Co="Huawei",Sa="Lenovo",Lo="Honor",fr="LG",Ta="Microsoft",Ia="Motorola",va="Nvidia",Yo="OnePlus",Aa="OPPO",Es="Samsung",_o="Sharp",Ss="Sony",ka="Xiaomi",Oa="Zebra",No="Chrome",Xo="Chromium",ai="Chromecast",pr="Edge",Ts="Firefox",Is="Opera",Ma="Facebook",Ho="Sogou",$i="Mobile ",vs=" Browser",qa="Windows",Hh=typeof window!==di,Kt=Hh&&window.navigator?window.navigator:void 0,li=Kt&&Kt.userAgentData?Kt.userAgentData:void 0,Bh=function(o,e){var t={},i=e;if(!Sr(e)){i={};for(var s in e)for(var a in e[s])i[a]=e[s][a].concat(i[a]?i[a]:[])}for(var n in o)t[n]=i[n]&&i[n].length%2===0?i[n].concat(o[n]):o[n];return t},la=function(o){for(var e={},t=0;t<o.length;t++)e[o[t].toUpperCase()]=o[t];return e},$a=function(o,e){if(typeof o===ds&&o.length>0){for(var t in o)if(Ve(e)==Ve(o[t]))return!0;return!1}return gs(o)?Ve(e)==Ve(o):!1},Sr=function(o,e){for(var t in o)return/^(browser|cpu|device|engine|os)$/.test(t)||(e?Sr(o[t]):!1)},gs=function(o){return typeof o===ja},Pa=function(o){if(o){for(var e=[],t=fs(/\\?\"/g,o).split(","),i=0;i<t.length;i++)if(t[i].indexOf(";")>-1){var s=Tr(t[i]).split(";v=");e[i]={brand:s[0],version:s[1]}}else e[i]=Tr(t[i]);return e}},Ve=function(o){return gs(o)?o.toLowerCase():o},Ra=function(o){return gs(o)?fs(/[^\d\.]/g,o).split(".")[0]:void 0},je=function(o){for(var e in o){var t=o[e];typeof t==ds&&t.length==2?this[t[0]]=t[1]:this[t]=void 0}return this},fs=function(o,e){return gs(e)?e.replace(o,cs):e},As=function(o){return fs(/\\?\"/g,o)},Tr=function(o,e){if(gs(o))return o=fs(/^\s\s*/,o),typeof e===di?o:o.substring(0,Va)},Da=function(o,e){if(!(!o||!e))for(var t=0,i,s,a,n,c,l;t<e.length&&!c;){var d=e[t],u=e[t+1];for(i=s=0;i<d.length&&!c&&d[i];)if(c=d[i++].exec(o),c)for(a=0;a<u.length;a++)l=c[++s],n=u[a],typeof n===ds&&n.length>0?n.length===2?typeof n[1]==Er?this[n[0]]=n[1].call(this,l):this[n[0]]=n[1]:n.length>=3&&(typeof n[1]===Er&&!(n[1].exec&&n[1].test)?n.length>3?this[n[0]]=l?n[1].apply(this,n.slice(2)):void 0:this[n[0]]=l?n[1].call(this,l,n[2]):void 0:n.length==3?this[n[0]]=l?l.replace(n[1],n[2]):void 0:n.length==4?this[n[0]]=l?n[3].call(this,l.replace(n[1],n[2])):void 0:n.length>4&&(this[n[0]]=l?n[3].apply(this,[l.replace(n[1],n[2])].concat(n.slice(4))):void 0)):this[n]=l||void 0;t+=2}},Me=function(o,e){for(var t in e)if(typeof e[t]===ds&&e[t].length>0){for(var i=0;i<e[t].length;i++)if($a(e[t][i],o))return t===Po?void 0:t}else if($a(e[t],o))return t===Po?void 0:t;return e.hasOwnProperty("*")?e["*"]:o},Bo={ME:"4.90","NT 3.51":"3.51","NT 4.0":"4.0",2e3:["5.0","5.01"],XP:["5.1","5.2"],Vista:"6.0",7:"6.1",8:"6.2","8.1":"6.3",10:["6.4","10.0"],NT:""},Fo={embedded:"Automotive",mobile:"Mobile",tablet:["Tablet","EInk"],smarttv:"TV",wearable:"Watch",xr:["VR","XR"],"?":["Desktop","Unknown"],"*":void 0},Fh={Chrome:"Google Chrome",Edge:"Microsoft Edge","Edge WebView2":"Microsoft Edge WebView2","Chrome WebView":"Android WebView","Chrome Headless":"HeadlessChrome","Huawei Browser":"HuaweiBrowser","MIUI Browser":"Miui Browser","Opera Mobi":"OperaMobile",Yandex:"YaBrowser"},Uo={browser:[[/\b(?:crmo|crios)\/([\w\.]+)/i],[X,[_,$i+"Chrome"]],[/webview.+edge\/([\w\.]+)/i],[X,[_,pr+" WebView"]],[/edg(?:e|ios|a)?\/([\w\.]+)/i],[X,[_,"Edge"]],[/(opera mini)\/([-\w\.]+)/i,/(opera [mobiletab]{3,6})\b.+version\/([-\w\.]+)/i,/(opera)(?:.+version\/|[\/ ]+)([\w\.]+)/i],[_,X],[/opios[\/ ]+([\w\.]+)/i],[X,[_,Is+" Mini"]],[/\bop(?:rg)?x\/([\w\.]+)/i],[X,[_,Is+" GX"]],[/\bopr\/([\w\.]+)/i],[X,[_,Is]],[/\bb[ai]*d(?:uhd|[ub]*[aekoprswx]{5,6})[\/ ]?([\w\.]+)/i],[X,[_,"Baidu"]],[/\b(?:mxbrowser|mxios|myie2)\/?([-\w\.]*)\b/i],[X,[_,"Maxthon"]],[/(kindle)\/([\w\.]+)/i,/(lunascape|maxthon|netfront|jasmine|blazer|sleipnir)[\/ ]?([\w\.]*)/i,/(avant|iemobile|slim(?:browser|boat|jet))[\/ ]?([\d\.]*)/i,/(?:ms|\()(ie) ([\w\.]+)/i,/(flock|rockmelt|midori|epiphany|silk|skyfire|ovibrowser|bolt|iron|vivaldi|iridium|phantomjs|bowser|qupzilla|falkon|rekonq|puffin|brave|whale(?!.+naver)|qqbrowserlite|duckduckgo|klar|helio|(?=comodo_)?dragon|otter|dooble|(?:lg |qute)browser)\/([-\w\.]+)/i,/(heytap|ovi|115|surf)browser\/([\d\.]+)/i,/(ecosia|weibo)(?:__| \w+@)([\d\.]+)/i],[_,X],[/quark(?:pc)?\/([-\w\.]+)/i],[X,[_,"Quark"]],[/\bddg\/([\w\.]+)/i],[X,[_,"DuckDuckGo"]],[/(?:\buc? ?browser|(?:juc.+)ucweb)[\/ ]?([\w\.]+)/i],[X,[_,"UCBrowser"]],[/microm.+\bqbcore\/([\w\.]+)/i,/\bqbcore\/([\w\.]+).+microm/i,/micromessenger\/([\w\.]+)/i],[X,[_,"WeChat"]],[/konqueror\/([\w\.]+)/i],[X,[_,"Konqueror"]],[/trident.+rv[: ]([\w\.]{1,9})\b.+like gecko/i],[X,[_,"IE"]],[/ya(?:search)?browser\/([\w\.]+)/i],[X,[_,"Yandex"]],[/slbrowser\/([\w\.]+)/i],[X,[_,"Smart "+Sa+vs]],[/(avast|avg)\/([\w\.]+)/i],[[_,/(.+)/,"$1 Secure"+vs],X],[/\bfocus\/([\w\.]+)/i],[X,[_,Ts+" Focus"]],[/\bopt\/([\w\.]+)/i],[X,[_,Is+" Touch"]],[/coc_coc\w+\/([\w\.]+)/i],[X,[_,"Coc Coc"]],[/dolfin\/([\w\.]+)/i],[X,[_,"Dolphin"]],[/coast\/([\w\.]+)/i],[X,[_,Is+" Coast"]],[/miuibrowser\/([\w\.]+)/i],[X,[_,"MIUI"+vs]],[/fxios\/([\w\.-]+)/i],[X,[_,$i+Ts]],[/\bqihoobrowser\/?([\w\.]*)/i],[X,[_,"360"]],[/\b(qq)\/([\w\.]+)/i],[[_,/(.+)/,"$1Browser"],X],[/(oculus|sailfish|huawei|vivo|pico)browser\/([\w\.]+)/i],[[_,/(.+)/,"$1"+vs],X],[/samsungbrowser\/([\w\.]+)/i],[X,[_,Es+" Internet"]],[/metasr[\/ ]?([\d\.]+)/i],[X,[_,Ho+" Explorer"]],[/(sogou)mo\w+\/([\d\.]+)/i],[[_,Ho+" Mobile"],X],[/(electron)\/([\w\.]+) safari/i,/(tesla)(?: qtcarbrowser|\/(20\d\d\.[-\w\.]+))/i,/m?(qqbrowser|2345(?=browser|chrome|explorer))\w*[\/ ]?v?([\w\.]+)/i],[_,X],[/(lbbrowser|rekonq)/i],[_],[/ome\/([\w\.]+) \w* ?(iron) saf/i,/ome\/([\w\.]+).+qihu (360)[es]e/i],[X,_],[/((?:fban\/fbios|fb_iab\/fb4a)(?!.+fbav)|;fbav\/([\w\.]+);)/i],[[_,Ma],X,[C,bs]],[/(kakao(?:talk|story))[\/ ]([\w\.]+)/i,/(naver)\(.*?(\d+\.[\w\.]+).*\)/i,/(daum)apps[\/ ]([\w\.]+)/i,/safari (line)\/([\w\.]+)/i,/\b(line)\/([\w\.]+)\/iab/i,/(alipay)client\/([\w\.]+)/i,/(twitter)(?:and| f.+e\/([\w\.]+))/i,/(instagram|snapchat|klarna)[\/ ]([-\w\.]+)/i],[_,X,[C,bs]],[/\bgsa\/([\w\.]+) .*safari\//i],[X,[_,"GSA"],[C,bs]],[/musical_ly(?:.+app_?version\/|_)([\w\.]+)/i],[X,[_,"TikTok"],[C,bs]],[/\[(linkedin)app\]/i],[_,[C,bs]],[/(chromium)[\/ ]([-\w\.]+)/i],[_,X],[/headlesschrome(?:\/([\w\.]+)| )/i],[X,[_,No+" Headless"]],[/wv\).+chrome\/([\w\.]+).+edgw\//i],[X,[_,pr+" WebView2"]],[/ wv\).+(chrome)\/([\w\.]+)/i],[[_,No+" WebView"],X],[/droid.+ version\/([\w\.]+)\b.+(?:mobile safari|safari)/i],[X,[_,"Android"+vs]],[/chrome\/([\w\.]+) mobile/i],[X,[_,$i+"Chrome"]],[/(chrome|omniweb|arora|[tizenoka]{5} ?browser)\/v?([\w\.]+)/i],[_,X],[/version\/([\w\.\,]+) .*mobile(?:\/\w+ | ?)safari/i],[X,[_,$i+"Safari"]],[/iphone .*mobile(?:\/\w+ | ?)safari/i],[[_,$i+"Safari"]],[/version\/([\w\.\,]+) .*(safari)/i],[X,_],[/webkit.+?(mobile ?safari|safari)(\/[\w\.]+)/i],[_,[X,"1"]],[/(webkit|khtml)\/([\w\.]+)/i],[_,X],[/(?:mobile|tablet);.*(firefox)\/([\w\.-]+)/i],[[_,$i+Ts],X],[/(navigator|netscape\d?)\/([-\w\.]+)/i],[[_,"Netscape"],X],[/(wolvic|librewolf)\/([\w\.]+)/i],[_,X],[/mobile vr; rv:([\w\.]+)\).+firefox/i],[X,[_,Ts+" Reality"]],[/ekiohf.+(flow)\/([\w\.]+)/i,/(swiftfox)/i,/(icedragon|iceweasel|camino|chimera|fennec|maemo browser|minimo|conkeror)[\/ ]?([\w\.\+]+)/i,/(seamonkey|k-meleon|icecat|iceape|firebird|phoenix|palemoon|basilisk|waterfox)\/([-\w\.]+)$/i,/(firefox)\/([\w\.]+)/i,/(mozilla)\/([\w\.]+) .+rv\:.+gecko\/\d+/i,/(amaya|dillo|doris|icab|ladybird|lynx|mosaic|netsurf|obigo|polaris|w3m|(?:go|ice|up)[\. ]?browser)[-\/ ]?v?([\w\.]+)/i,/\b(links) \(([\w\.]+)/i],[_,[X,/_/g,"."]],[/(cobalt)\/([\w\.]+)/i],[_,[X,/[^\d\.]+./,cs]]],cpu:[[/\b((amd|x|x86[-_]?|wow|win)64)\b/i],[[zt,"amd64"]],[/(ia32(?=;))/i,/\b((i[346]|x)86)(pc)?\b/i],[[zt,"ia32"]],[/\b(aarch64|arm(v?[89]e?l?|_?64))\b/i],[[zt,"arm64"]],[/\b(arm(v[67])?ht?n?[fl]p?)\b/i],[[zt,"armhf"]],[/( (ce|mobile); ppc;|\/[\w\.]+arm\b)/i],[[zt,"arm"]],[/((ppc|powerpc)(64)?)( mac|;|\))/i],[[zt,/ower/,cs,Ve]],[/ sun4\w[;\)]/i],[[zt,"sparc"]],[/\b(avr32|ia64(?=;)|68k(?=\))|\barm(?=v([1-7]|[5-7]1)l?|;|eabi)|(irix|mips|sparc)(64)?\b|pa-risc)/i],[[zt,Ve]]],device:[[/\b(sch-i[89]0\d|shw-m380s|sm-[ptx]\w{2,4}|gt-[pn]\d{2,4}|sgh-t8[56]9|nexus 10)/i],[L,[Y,Es],[C,lt]],[/\b((?:s[cgp]h|gt|sm)-(?![lr])\w+|sc[g-]?[\d]+a?|galaxy nexus)/i,/samsung[- ]((?!sm-[lr]|browser)[-\w]+)/i,/sec-(sgh\w+)/i],[L,[Y,Es],[C,$]],[/(?:\/|\()(ip(?:hone|od)[\w, ]*)(?:\/|;)/i],[L,[Y,qi],[C,$]],[/\((ipad);[-\w\),; ]+apple/i,/applecoremedia\/[\w\.]+ \((ipad)/i,/\b(ipad)\d\d?,\d\d?[;\]].+ios/i],[L,[Y,qi],[C,lt]],[/(macintosh);/i],[L,[Y,qi]],[/\b(sh-?[altvz]?\d\d[a-ekm]?)/i],[L,[Y,_o],[C,$]],[/\b((?:brt|eln|hey2?|gdi|jdn)-a?[lnw]09|(?:ag[rm]3?|jdn2|kob2)-a?[lw]0[09]hn)(?: bui|\)|;)/i],[L,[Y,Lo],[C,lt]],[/honor([-\w ]+)[;\)]/i],[L,[Y,Lo],[C,$]],[/\b((?:ag[rs][2356]?k?|bah[234]?|bg[2o]|bt[kv]|cmr|cpn|db[ry]2?|jdn2|got|kob2?k?|mon|pce|scm|sht?|[tw]gr|vrd)-[ad]?[lw][0125][09]b?|605hw|bg2-u03|(?:gem|fdr|m2|ple|t1)-[7a]0[1-4][lu]|t1-a2[13][lw]|mediapad[\w\. ]*(?= bui|\)))\b(?!.+d\/s)/i],[L,[Y,Co],[C,lt]],[/(?:huawei)([-\w ]+)[;\)]/i,/\b(nexus 6p|\w{2,4}e?-[atu]?[ln][\dx][012359c][adn]?)\b(?!.+d\/s)/i],[L,[Y,Co],[C,$]],[/oid[^\)]+; (2[\dbc]{4}(182|283|rp\w{2})[cgl]|m2105k81a?c)(?: bui|\))/i,/\b((?:red)?mi[-_ ]?pad[\w- ]*)(?: bui|\))/i],[[L,/_/g," "],[Y,ka],[C,lt]],[/\b(poco[\w ]+|m2\d{3}j\d\d[a-z]{2})(?: bui|\))/i,/\b; (\w+) build\/hm\1/i,/\b(hm[-_ ]?note?[_ ]?(?:\d\w)?) bui/i,/\b(redmi[\-_ ]?(?:note|k)?[\w_ ]+)(?: bui|\))/i,/oid[^\)]+; (m?[12][0-389][01]\w{3,6}[c-y])( bui|; wv|\))/i,/\b(mi[-_ ]?(?:a\d|one|one[_ ]plus|note lte|max|cc)?[_ ]?(?:\d?\w?)[_ ]?(?:plus|se|lite|pro)?)(?: bui|\))/i,/ ([\w ]+) miui\/v?\d/i],[[L,/_/g," "],[Y,ka],[C,$]],[/droid.+; (cph2[3-6]\d[13579]|((gm|hd)19|(ac|be|in|kb)20|(d[en]|eb|le|mt)21|ne22)[0-2]\d|p[g-k]\w[1m]10)\b/i,/(?:one)?(?:plus)? (a\d0\d\d)(?: b|\))/i],[L,[Y,Yo],[C,$]],[/; (\w+) bui.+ oppo/i,/\b(cph[12]\d{3}|p(?:af|c[al]|d\w|e[ar])[mt]\d0|x9007|a101op)\b/i],[L,[Y,Aa],[C,$]],[/\b(opd2(\d{3}a?))(?: bui|\))/i],[L,[Y,Me,{OnePlus:["203","304","403","404","413","415"],"*":Aa}],[C,lt]],[/(vivo (5r?|6|8l?|go|one|s|x[il]?[2-4]?)[\w\+ ]*)(?: bui|\))/i],[L,[Y,"BLU"],[C,$]],[/; vivo (\w+)(?: bui|\))/i,/\b(v[12]\d{3}\w?[at])(?: bui|;)/i],[L,[Y,"Vivo"],[C,$]],[/\b(rmx[1-3]\d{3})(?: bui|;|\))/i],[L,[Y,"Realme"],[C,$]],[/(ideatab[-\w ]+|602lv|d-42a|a101lv|a2109a|a3500-hv|s[56]000|pb-6505[my]|tb-?x?\d{3,4}(?:f[cu]|xu|[av])|yt\d?-[jx]?\d+[lfmx])( bui|;|\)|\/)/i,/lenovo ?(b[68]0[08]0-?[hf]?|tab(?:[\w- ]+?)|tb[\w-]{6,7})( bui|;|\)|\/)/i],[L,[Y,Sa],[C,lt]],[/lenovo[-_ ]?([-\w ]+?)(?: bui|\)|\/)/i],[L,[Y,Sa],[C,$]],[/\b(milestone|droid(?:[2-4x]| (?:bionic|x2|pro|razr))?:?( 4g)?)\b[\w ]+build\//i,/\bmot(?:orola)?[- ]([\w\s]+)(\)| bui)/i,/((?:moto(?! 360)[-\w\(\) ]+|xt\d{3,4}[cgkosw\+]?[-\d]*|nexus 6)(?= bui|\)))/i],[L,[Y,Ia],[C,$]],[/\b(mz60\d|xoom[2 ]{0,2}) build\//i],[L,[Y,Ia],[C,lt]],[/((?=lg)?[vl]k\-?\d{3}) bui| 3\.[-\w; ]{10}lg?-([06cv9]{3,4})/i],[L,[Y,fr],[C,lt]],[/(lm(?:-?f100[nv]?|-[\w\.]+)(?= bui|\))|nexus [45])/i,/\blg[-e;\/ ]+(?!.*(?:browser|netcast|android tv|watch|webos))(\w+)/i,/\blg-?([\d\w]+) bui/i],[L,[Y,fr],[C,$]],[/(nokia) (t[12][01])/i],[Y,L,[C,lt]],[/(?:maemo|nokia).*(n900|lumia \d+|rm-\d+)/i,/nokia[-_ ]?(([-\w\. ]*))/i],[[L,/_/g," "],[C,$],[Y,"Nokia"]],[/(pixel (c|tablet))\b/i],[L,[Y,Si],[C,lt]],[/droid.+;(?: google)? (g(01[13]a|020[aem]|025[jn]|1b60|1f8f|2ybb|4s1m|576d|5nz6|8hhn|8vou|a02099|c15s|d1yq|e2ae|ec77|gh2x|kv4x|p4bc|pj41|r83y|tt9q|ur25|wvk6)|pixel[\d ]*a?( pro)?( xl)?( fold)?( \(5g\))?)( bui|\))/i],[L,[Y,Si],[C,$]],[/(google) (pixelbook( go)?)/i],[Y,L],[/droid.+; (a?\d[0-2]{2}so|[c-g]\d{4}|so[-gl]\w+|xq-\w\w\d\d)(?= bui|\).+chrome\/(?![1-6]{0,1}\d\.))/i],[L,[Y,Ss],[C,$]],[/sony tablet [ps]/i,/\b(?:sony)?sgp\w+(?: bui|\))/i],[[L,"Xperia Tablet"],[Y,Ss],[C,lt]],[/(alexa)webm/i,/(kf[a-z]{2}wi|aeo(?!bc)\w\w)( bui|\))/i,/(kf[a-z]+)( bui|\)).+silk\//i],[L,[Y,dr],[C,lt]],[/((?:sd|kf)[0349hijorstuw]+)( bui|\)).+silk\//i],[[L,/(.+)/g,"Fire Phone $1"],[Y,dr],[C,$]],[/(playbook);[-\w\),; ]+(rim)/i],[L,Y,[C,lt]],[/\b((?:bb[a-f]|st[hv])100-\d)/i,/\(bb10; (\w+)/i],[L,[Y,Do],[C,$]],[/(?:\b|asus_)(transfo[prime ]{4,10} \w+|eeepc|slider \w+|nexus 7|padfone|p00[cj])/i],[L,[Y,Ro],[C,lt]],[/ (z[bes]6[027][012][km][ls]|zenfone \d\w?)\b/i],[L,[Y,Ro],[C,$]],[/(nexus 9)/i],[L,[Y,"HTC"],[C,lt]],[/(htc)[-;_ ]{1,2}([\w ]+(?=\)| bui)|\w+)/i,/(zte)[- ]([\w ]+?)(?: bui|\/|\))/i,/(alcatel|geeksphone|nexian|panasonic(?!(?:;|\.))|sony(?!-bra))[-_ ]?([-\w]*)/i],[Y,[L,/_/g," "],[C,$]],[/tcl (xess p17aa)/i,/droid [\w\.]+; ((?:8[14]9[16]|9(?:0(?:48|60|8[01])|1(?:3[27]|66)|2(?:6[69]|9[56])|466))[gqswx])(_\w(\w|\w\w))?(\)| bui)/i],[L,[Y,"TCL"],[C,lt]],[/droid [\w\.]+; (418(?:7d|8v)|5087z|5102l|61(?:02[dh]|25[adfh]|27[ai]|56[dh]|59k|65[ah])|a509dl|t(?:43(?:0w|1[adepqu])|50(?:6d|7[adju])|6(?:09dl|10k|12b|71[efho]|76[hjk])|7(?:66[ahju]|67[hw]|7[045][bh]|71[hk]|73o|76[ho]|79w|81[hks]?|82h|90[bhsy]|99b)|810[hs]))(_\w(\w|\w\w))?(\)| bui)/i],[L,[Y,"TCL"],[C,$]],[/(itel) ((\w+))/i],[[Y,Ve],L,[C,Me,{tablet:["p10001l","w7001"],"*":"mobile"}]],[/droid.+; ([ab][1-7]-?[0178a]\d\d?)/i],[L,[Y,"Acer"],[C,lt]],[/droid.+; (m[1-5] note) bui/i,/\bmz-([-\w]{2,})/i],[L,[Y,"Meizu"],[C,$]],[/; ((?:power )?armor(?:[\w ]{0,8}))(?: bui|\))/i],[L,[Y,"Ulefone"],[C,$]],[/; (energy ?\w+)(?: bui|\))/i,/; energizer ([\w ]+)(?: bui|\))/i],[L,[Y,"Energizer"],[C,$]],[/; cat (b35);/i,/; (b15q?|s22 flip|s48c|s62 pro)(?: bui|\))/i],[L,[Y,"Cat"],[C,$]],[/((?:new )?andromax[\w- ]+)(?: bui|\))/i],[L,[Y,"Smartfren"],[C,$]],[/droid.+; (a(in)?(0(15|59|6[35])|142)p?)/i],[L,[Y,"Nothing"],[C,$]],[/; (x67 5g|tikeasy \w+|ac[1789]\d\w+)( b|\))/i,/archos ?(5|gamepad2?|([\w ]*[t1789]|hello) ?\d+[\w ]*)( b|\))/i],[L,[Y,"Archos"],[C,lt]],[/archos ([\w ]+)( b|\))/i,/; (ac[3-6]\d\w{2,8})( b|\))/i],[L,[Y,"Archos"],[C,$]],[/; (n159v)/i],[L,[Y,"HMD"],[C,$]],[/(imo) (tab \w+)/i,/(infinix|tecno) (x1101b?|p904|dp(7c|8d|10a)( pro)?|p70[1-3]a?|p904|t1101)/i],[Y,L,[C,lt]],[/(blackberry|benq|palm(?=\-)|sonyericsson|acer|asus(?! zenw)|dell|jolla|meizu|motorola|polytron|tecno|micromax|advan)[-_ ]?([-\w]*)/i,/; (blu|hmd|imo|infinix|lava|oneplus|tcl)[_ ]([\w\+ ]+?)(?: bui|\)|; r)/i,/(hp) ([\w ]+\w)/i,/(microsoft); (lumia[\w ]+)/i,/(oppo) ?([\w ]+) bui/i],[Y,L,[C,$]],[/(kobo)\s(ereader|touch)/i,/(hp).+(touchpad(?!.+tablet)|tablet)/i,/(kindle)\/([\w\.]+)/i],[Y,L,[C,lt]],[/(surface duo)/i],[L,[Y,Ta],[C,lt]],[/droid [\d\.]+; (fp\du?)(?: b|\))/i],[L,[Y,"Fairphone"],[C,$]],[/((?:tegranote|shield t(?!.+d tv))[\w- ]*?)(?: b|\))/i],[L,[Y,va],[C,lt]],[/(sprint) (\w+)/i],[Y,L,[C,$]],[/(kin\.[onetw]{3})/i],[[L,/\./g," "],[Y,Ta],[C,$]],[/droid.+; ([c6]+|et5[16]|mc[239][23]x?|vc8[03]x?)\)/i],[L,[Y,Oa],[C,lt]],[/droid.+; (ec30|ps20|tc[2-8]\d[kx])\)/i],[L,[Y,Oa],[C,$]],[/smart-tv.+(samsung)/i],[Y,[C,Tt]],[/hbbtv.+maple;(\d+)/i],[[L,/^/,"SmartTV"],[Y,Es],[C,Tt]],[/(vizio)(?: |.+model\/)(\w+-\w+)/i,/tcast.+(lg)e?. ([-\w]+)/i],[Y,L,[C,Tt]],[/(nux; netcast.+smarttv|lg (netcast\.tv-201\d|android tv))/i],[[Y,fr],[C,Tt]],[/(apple) ?tv/i],[Y,[L,qi+" TV"],[C,Tt]],[/crkey.*devicetype\/chromecast/i],[[L,ai+" Third Generation"],[Y,Si],[C,Tt]],[/crkey.*devicetype\/([^/]*)/i],[[L,/^/,"Chromecast "],[Y,Si],[C,Tt]],[/fuchsia.*crkey/i],[[L,ai+" Nest Hub"],[Y,Si],[C,Tt]],[/crkey/i],[[L,ai],[Y,Si],[C,Tt]],[/(portaltv)/i],[L,[Y,Ma],[C,Tt]],[/droid.+aft(\w+)( bui|\))/i],[L,[Y,dr],[C,Tt]],[/(shield \w+ tv)/i],[L,[Y,va],[C,Tt]],[/\(dtv[\);].+(aquos)/i,/(aquos-tv[\w ]+)\)/i],[L,[Y,_o],[C,Tt]],[/(bravia[\w ]+)( bui|\))/i],[L,[Y,Ss],[C,Tt]],[/(mi(tv|box)-?\w+) bui/i],[L,[Y,ka],[C,Tt]],[/Hbbtv.*(technisat) (.*);/i],[Y,L,[C,Tt]],[/\b(roku)[\dx]*[\)\/]((?:dvp-)?[\d\.]*)/i,/hbbtv\/\d+\.\d+\.\d+ +\([\w\+ ]*; *([\w\d][^;]*);([^;]*)/i],[[Y,/.+\/(\w+)/,"$1",Me,{LG:"lge"}],[L,Tr],[C,Tt]],[/droid.+; ([\w- ]+) (?:android tv|smart[- ]?tv)/i],[L,[C,Tt]],[/\b(android tv|smart[- ]?tv|opera tv|tv; rv:|large screen[\w ]+safari)\b/i],[[C,Tt]],[/(playstation \w+)/i],[L,[Y,Ss],[C,Ps]],[/\b(xbox(?: one)?(?!; xbox))[\); ]/i],[L,[Y,Ta],[C,Ps]],[/(ouya)/i,/(nintendo) (\w+)/i,/(retroid) (pocket ([^\)]+))/i],[Y,L,[C,Ps]],[/droid.+; (shield)( bui|\))/i],[L,[Y,va],[C,Ps]],[/\b(sm-[lr]\d\d[0156][fnuw]?s?|gear live)\b/i],[L,[Y,Es],[C,Ae]],[/((pebble))app/i,/(asus|google|lg|oppo) ((pixel |zen)?watch[\w ]*)( bui|\))/i],[Y,L,[C,Ae]],[/(ow(?:19|20)?we?[1-3]{1,3})/i],[L,[Y,Aa],[C,Ae]],[/(watch)(?: ?os[,\/]|\d,\d\/)[\d\.]+/i],[L,[Y,qi],[C,Ae]],[/(opwwe\d{3})/i],[L,[Y,Yo],[C,Ae]],[/(moto 360)/i],[L,[Y,Ia],[C,Ae]],[/(smartwatch 3)/i],[L,[Y,Ss],[C,Ae]],[/(g watch r)/i],[L,[Y,fr],[C,Ae]],[/droid.+; (wt63?0{2,3})\)/i],[L,[Y,Oa],[C,Ae]],[/droid.+; (glass) \d/i],[L,[Y,Si],[C,cr]],[/(pico) (4|neo3(?: link|pro)?)/i],[Y,L,[C,cr]],[/(quest( \d| pro)?s?).+vr/i],[L,[Y,Ma],[C,cr]],[/mobile vr; rv.+firefox/i],[[C,cr]],[/(tesla)(?: qtcarbrowser|\/[-\w\.]+)/i],[Y,[C,Rs]],[/(aeobc)\b/i],[L,[Y,dr],[C,Rs]],[/(homepod).+mac os/i],[L,[Y,qi],[C,Rs]],[/windows iot/i],[[C,Rs]],[/droid .+?; ([^;]+?)(?: bui|; wv\)|\) applew).+?(mobile|vr|\d) safari/i],[L,[C,Me,{mobile:"Mobile",xr:"VR","*":lt}]],[/\b((tablet|tab)[;\/]|focus\/\d(?!.+mobile))/i],[[C,lt]],[/(phone|mobile(?:[;\/]| [ \w\/\.]*safari)|pda(?=.+windows ce))/i],[[C,$]],[/droid .+?; ([\w\. -]+)( bui|\))/i],[L,[Y,"Generic"]]],engine:[[/windows.+ edge\/([\w\.]+)/i],[X,[_,pr+"HTML"]],[/(arkweb)\/([\w\.]+)/i],[_,X],[/webkit\/537\.36.+chrome\/(?!27)([\w\.]+)/i],[X,[_,"Blink"]],[/(presto)\/([\w\.]+)/i,/(webkit|trident|netfront|netsurf|amaya|lynx|w3m|goanna|servo)\/([\w\.]+)/i,/ekioh(flow)\/([\w\.]+)/i,/(khtml|tasman|links)[\/ ]\(?([\w\.]+)/i,/(icab)[\/ ]([23]\.[\d\.]+)/i,/\b(libweb)/i],[_,X],[/ladybird\//i],[[_,"LibWeb"]],[/rv\:([\w\.]{1,9})\b.+(gecko)/i],[X,_]],os:[[/(windows nt) (6\.[23]); arm/i],[[_,/N/,"R"],[X,Me,Bo]],[/(windows (?:phone|mobile|iot))(?: os)?[\/ ]?([\d\.]*( se)?)/i,/(windows)[\/ ](1[01]|2000|3\.1|7|8(\.1)?|9[58]|me|server 20\d\d( r2)?|vista|xp)/i],[_,X],[/windows nt ?([\d\.\)]*)(?!.+xbox)/i,/\bwin(?=3| ?9|n)(?:nt| 9x )?([\d\.;]*)/i],[[X,/(;|\))/g,"",Me,Bo],[_,qa]],[/(windows ce)\/?([\d\.]*)/i],[_,X],[/[adehimnop]{4,7}\b(?:.*os ([\w]+) like mac|; opera)/i,/(?:ios;fbsv\/|iphone.+ios[\/ ])([\d\.]+)/i,/cfnetwork\/.+darwin/i],[[X,/_/g,"."],[_,"iOS"]],[/(mac os x) ?([\w\. ]*)/i,/(macintosh|mac_powerpc\b)(?!.+(haiku|morphos))/i],[[_,"macOS"],[X,/_/g,"."]],[/android ([\d\.]+).*crkey/i],[X,[_,ai+" Android"]],[/fuchsia.*crkey\/([\d\.]+)/i],[X,[_,ai+" Fuchsia"]],[/crkey\/([\d\.]+).*devicetype\/smartspeaker/i],[X,[_,ai+" SmartSpeaker"]],[/linux.*crkey\/([\d\.]+)/i],[X,[_,ai+" Linux"]],[/crkey\/([\d\.]+)/i],[X,[_,ai]],[/droid ([\w\.]+)\b.+(android[- ]x86)/i],[X,_],[/(ubuntu) ([\w\.]+) like android/i],[[_,/(.+)/,"$1 Touch"],X],[/(harmonyos)[\/ ]?([\d\.]*)/i,/(android|bada|blackberry|kaios|maemo|meego|openharmony|qnx|rim tablet os|sailfish|series40|symbian|tizen)\w*[-\/\.; ]?([\d\.]*)/i],[_,X],[/\(bb(10);/i],[X,[_,Do]],[/(?:symbian ?os|symbos|s60(?=;)|series ?60)[-\/ ]?([\w\.]*)/i],[X,[_,"Symbian"]],[/mozilla\/[\d\.]+ \((?:mobile|tablet|tv|mobile; [\w ]+); rv:.+ gecko\/([\w\.]+)/i],[X,[_,Ts+" OS"]],[/\b(?:hp)?wos(?:browser)?\/([\w\.]+)/i,/webos(?:[ \/]?|\.tv-20(?=2[2-9]))(\d[\d\.]*)/i],[X,[_,"webOS"]],[/web0s;.+?(?:chr[o0]me|safari)\/(\d+)/i],[[X,Me,{25:"120",24:"108",23:"94",22:"87",6:"79",5:"68",4:"53",3:"38",2:"538",1:"537","*":"TV"}],[_,"webOS"]],[/watch(?: ?os[,\/]|\d,\d\/)([\d\.]+)/i],[X,[_,"watchOS"]],[/(cros) [\w]+(?:\)| ([\w\.]+)\b)/i],[[_,"Chrome OS"],X],[/panasonic;(viera)/i,/(netrange)mmh/i,/(nettv)\/(\d+\.[\w\.]+)/i,/(nintendo|playstation) (\w+)/i,/(xbox); +xbox ([^\);]+)/i,/(pico) .+os([\w\.]+)/i,/\b(joli|palm)\b ?(?:os)?\/?([\w\.]*)/i,/linux.+(mint)[\/\(\) ]?([\w\.]*)/i,/(mageia|vectorlinux|fuchsia|arcaos|arch(?= ?linux))[;l ]([\d\.]*)/i,/([kxln]?ubuntu|debian|suse|opensuse|gentoo|slackware|fedora|mandriva|centos|pclinuxos|red ?hat|zenwalk|linpus|raspbian|plan 9|minix|risc os|contiki|deepin|manjaro|elementary os|sabayon|linspire|knoppix)(?: gnu[\/ ]linux)?(?: enterprise)?(?:[- ]linux)?(?:-gnu)?[-\/ ]?(?!chrom|package)([-\w\.]*)/i,/((?:open)?solaris)[-\/ ]?([\w\.]*)/i,/\b(aix)[; ]([1-9\.]{0,4})/i,/(hurd|linux|morphos)(?: (?:arm|x86|ppc)\w*| ?)([\w\.]*)/i,/(gnu) ?([\w\.]*)/i,/\b([-frentopcghs]{0,5}bsd|dragonfly)[\/ ]?(?!amd|[ix346]{1,2}86)([\w\.]*)/i,/(haiku) ?(r\d)?/i],[_,X],[/(sunos) ?([\d\.]*)/i],[[_,"Solaris"],X],[/\b(beos|os\/2|amigaos|openvms|hp-ux|serenityos)/i,/(unix) ?([\w\.]*)/i],[_,X]]},ur=(function(){var o={init:{},isIgnore:{},isIgnoreRgx:{},toString:{}};return je.call(o.init,[[Zt,[_,X,Vs,C]],[Ue,[zt]],[Pe,[C,L,Y]],[ge,[_,X]],[ne,[_,X]]]),je.call(o.isIgnore,[[Zt,[X,Vs]],[ge,[X]],[ne,[X]]]),je.call(o.isIgnoreRgx,[[Zt,/ ?browser$/i],[ne,/ ?os$/i]]),je.call(o.toString,[[Zt,[_,X]],[Ue,[zt]],[Pe,[Y,L]],[ge,[_,X]],[ne,[_,X]]]),o})(),Uh=function(o,e){var t=ur.init[e],i=ur.isIgnore[e]||0,s=ur.isIgnoreRgx[e]||0,a=ur.toString[e]||0;function n(){je.call(this,t)}return n.prototype.getItem=function(){return o},n.prototype.withClientHints=function(){return li?li.getHighEntropyValues(In).then(function(c){return o.setCH(new vn(c,!1)).parseCH().get()}):o.parseCH().get()},n.prototype.withFeatureCheck=function(){return o.detectFeature().get()},e!=as&&(n.prototype.is=function(c){var l=!1;for(var d in this)if(this.hasOwnProperty(d)&&!$a(i,d)&&Ve(s?fs(s,this[d]):this[d])==Ve(s?fs(s,c):c)){if(l=!0,c!=di)break}else if(c==di&&l){l=!l;break}return l},n.prototype.toString=function(){var c=cs;for(var l in a)typeof this[a[l]]!==di&&(c+=(c?" ":cs)+this[a[l]]);return c||di}),li||(n.prototype.then=function(c){var l=this,d=function(){for(var h in l)l.hasOwnProperty(h)&&(this[h]=l[h])};d.prototype={is:n.prototype.is,toString:n.prototype.toString};var u=new d;return c(u),u}),new n};function vn(o,e){if(o=o||{},je.call(this,In),e)je.call(this,[[co,Pa(o[bi])],[fo,Pa(o[Dh])],[$,/\?1/.test(o[_h])],[L,As(o[Nh])],[os,As(o[Tn])],[uo,As(o[Xh])],[zt,As(o[Ch])],[Ii,Pa(o[Yh])],[ha,As(o[Lh])]]);else for(var t in o)this.hasOwnProperty(t)&&typeof o[t]!==di&&(this[t]=o[t])}function Go(o,e,t,i){return this.get=function(s){return s?this.data.hasOwnProperty(s)?this.data[s]:void 0:this.data},this.set=function(s,a){return this.data[s]=a,this},this.setCH=function(s){return this.uaCH=s,this},this.detectFeature=function(){if(Kt&&Kt.userAgent==this.ua)switch(this.itemType){case Zt:Kt.brave&&typeof Kt.brave.isBrave==Er&&this.set(_,"Brave");break;case Pe:!this.get(C)&&li&&li[$]&&this.set(C,$),this.get(L)=="Macintosh"&&Kt&&typeof Kt.standalone!==di&&Kt.maxTouchPoints&&Kt.maxTouchPoints>2&&this.set(L,"iPad").set(C,lt);break;case ne:!this.get(_)&&li&&li[os]&&this.set(_,li[os]);break;case as:var s=this.data,a=function(n){return s[n].getItem().detectFeature().get()};this.set(Zt,a(Zt)).set(Ue,a(Ue)).set(Pe,a(Pe)).set(ge,a(ge)).set(ne,a(ne))}return this},this.parseUA=function(){return this.itemType!=as&&Da.call(this.data,this.ua,this.rgxMap),this.itemType==Zt&&this.set(Vs,Ra(this.get(X))),this},this.parseCH=function(){var s=this.uaCH,a=this.rgxMap;switch(this.itemType){case Zt:case ge:var n=s[fo]||s[co],c;if(n)for(var l in n){var d=n[l].brand||n[l],u=n[l].version;this.itemType==Zt&&!/not.a.brand/i.test(d)&&(!c||/Chrom/.test(c)&&d!=Xo||c==pr&&/WebView2/.test(d))&&(d=Me(d,Fh),c=this.get(_),c&&!/Chrom/.test(c)&&/Chrom/.test(d)||this.set(_,d).set(X,u).set(Vs,Ra(u)),c=d),this.itemType==ge&&d==Xo&&this.set(X,u)}break;case Ue:var h=s[zt];h&&(h&&s[ha]=="64"&&(h+="64"),Da.call(this.data,h+";",a));break;case Pe:if(s[$]&&this.set(C,$),s[L]&&(this.set(L,s[L]),!this.get(C)||!this.get(Y))){var f={};Da.call(f,"droid 9; "+s[L]+")",a),!this.get(C)&&f.type&&this.set(C,f.type),!this.get(Y)&&f.vendor&&this.set(Y,f.vendor)}if(s[Ii]){var p;if(typeof s[Ii]!="string")for(var y=0;!p&&y<s[Ii].length;)p=Me(s[Ii][y++],Fo);else p=Me(s[Ii],Fo);this.set(C,p)}break;case ne:var g=s[os];if(g){var w=s[uo];g==qa&&(w=parseInt(Ra(w),10)>=13?"11":"10"),this.set(_,g).set(X,w)}this.get(_)==qa&&s[L]=="Xbox"&&this.set(_,"Xbox").set(X,void 0);break;case as:var b=this.data,T=function(v){return b[v].getItem().setCH(s).parseCH().get()};this.set(Zt,T(Zt)).set(Ue,T(Ue)).set(Pe,T(Pe)).set(ge,T(ge)).set(ne,T(ne))}return this},je.call(this,[["itemType",o],["ua",e],["uaCH",i],["rgxMap",t],["data",Uh(this,o)]]),this}function ti(o,e,t){if(typeof o===ds?(Sr(o,!0)?(typeof e===ds&&(t=e),e=o):(t=o,e=void 0),o=void 0):typeof o===ja&&!Sr(e,!0)&&(t=e,e=void 0),t&&typeof t.append===Er){var i={};t.forEach(function(l,d){i[d]=l}),t=i}if(!(this instanceof ti))return new ti(o,e,t).getResult();var s=typeof o===ja?o:t&&t[Mo]?t[Mo]:Kt&&Kt.userAgent?Kt.userAgent:cs,a=new vn(t,!0),n=e?Bh(Uo,e):Uo,c=function(l){return l==as?function(){return new Go(l,s,n,a).set("ua",s).set(Zt,this.getBrowser()).set(Ue,this.getCPU()).set(Pe,this.getDevice()).set(ge,this.getEngine()).set(ne,this.getOS()).get()}:function(){return new Go(l,s,n[l],a).parseUA().get()}};return je.call(this,[["getBrowser",c(Zt)],["getCPU",c(Ue)],["getDevice",c(Pe)],["getEngine",c(ge)],["getOS",c(ne)],["getResult",c(as)],["getUA",function(){return s}],["setUA",function(l){return gs(l)&&(s=l.length>Va?Tr(l,Va):l),this}]]).setUA(s),this}ti.VERSION=Rh;ti.BROWSER=la([_,X,Vs,C]);ti.CPU=la([zt]);ti.DEVICE=la([L,Y,C,Ps,$,Tt,lt,Ae,Rs]);ti.ENGINE=ti.OS=la([_,X]);const Gh=()=>{const e=new ti(navigator.userAgent).getResult(),{browser:t,device:i,os:s}=e;return{os:s,browser:t,device:i,orientation:screen.orientation.type}};class Wh{constructor(e){r(this,"player");r(this,"flashingFrame");r(this,"guiHeartFrame");r(this,"hurtAlpha");r(this,"jumpY");r(this,"motionSpeed");r(this,"slowMotionEnabled");r(this,"jumpHeight");r(this,"hurting");r(this,"hurtingShield");r(this,"drawX");r(this,"drawY");r(this,"hitX");r(this,"hitY");r(this,"frame");r(this,"slowMotionTickDuration");r(this,"lowHealthFrame");r(this,"flashing");r(this,"hurt",()=>{this.hurting=!0,this.hurtAlpha=.25});r(this,"hurtShield",()=>{this.hurtingShield=!0});r(this,"flash",()=>{this.flashing=!0});r(this,"disableFlash",()=>{this.flashing=!1});r(this,"beginSlowMotion",()=>{this.slowMotionEnabled=!0});r(this,"endSlowMotion",()=>{this.slowMotionEnabled=!1});r(this,"setNewDrawXY",(e,t)=>{this.drawX+=e-this.player.x,this.drawY+=t-this.player.y});r(this,"enableSlowMotion",()=>{this.motionSpeed<1&&!this.slowMotionEnabled&&(this.motionSpeed*=1.08,this.motionSpeed>=1&&(this.motionSpeed=1)),this.slowMotionEnabled&&this.motionSpeed>.25&&(this.motionSpeed*=.95,this.motionSpeed<.25&&(this.motionSpeed=.25))});r(this,"updateSlowMotion",()=>{this.slowMotionTickDuration>0&&(this.slowMotionTickDuration-=1),this.slowMotionTickDuration===0&&(this.slowMotionEnabled=!1)});r(this,"drawPlayerSprite",e=>{const t=this.player;if(m.ctx.save(),this.drawSmear())m.drawMob(this.setSmearFrame().x,this.setSmearFrame().y,1,2,t.x-this.drawX-this.hitX,t.y-1.45-this.drawY-this.jumpY-this.hitY,1,2,this.shadeColor());else if(this.player.inputHandler.mostRecentMoveInput==="mouse"&&this.mouseDiagonal()&&!x.isMobile){const i=this.player.inputHandler.mouseAngle()*180/Math.PI;let s={x:1,y:18};i>-150&&i<=-120&&(s={x:3,y:18}),i>-60&&i<=-30&&(s={x:4,y:18}),i>30&&i<=60&&(s={x:2,y:18}),i>120&&i<=150&&(s={x:1,y:18}),m.drawMob(s.x,s.y,1,2,t.x-this.drawX-this.hitX,t.y-1.45-this.drawY-this.jumpY-this.hitY,1,2,this.shadeColor())}else this.frame+=.1*e,this.frame>=4&&(this.frame=0),m.drawMob(1+Math.floor(this.frame),8+t.direction*2,1,2,t.x-this.drawX-this.hitX,t.y-1.45-this.drawY-this.jumpY-this.hitY,1,2,this.shadeColor());t.inventory.getArmor()&&t.inventory.getArmor().health>0,m.ctx.restore()});r(this,"mouseDiagonal",()=>{const e=this.player.inputHandler.mouseAngle()*180/Math.PI;return e>30&&e<60||e>120&&e<150||e>-150&&e<-120||e>-60&&e<-30});r(this,"drawSmear",()=>{if(this.player.direction===this.player.lastDirection)return!1;let e=100;const t=this.player.lastDirection,i=this.player.direction;return(i===E.UP&&t===E.DOWN||i===E.DOWN&&t===E.UP||i===E.LEFT&&t===E.RIGHT||i===E.RIGHT&&t===E.LEFT)&&(e=150),Date.now()-this.player.movement.lastChangeDirectionTime<=e});r(this,"setSmearFrame",()=>{let e={x:1,y:18};const t=Date.now()-this.player.movement.lastChangeDirectionTime,i=50;if(this.player.direction===E.UP&&this.player.lastDirection===E.LEFT||this.player.direction===E.LEFT&&this.player.lastDirection===E.UP)return e.x=3,e;if(this.player.direction===E.UP&&this.player.lastDirection===E.RIGHT||this.player.direction===E.RIGHT&&this.player.lastDirection===E.UP)return e.x=4,e;if(this.player.direction===E.DOWN&&this.player.lastDirection===E.RIGHT||this.player.direction===E.RIGHT&&this.player.lastDirection===E.DOWN)return e.x=2,e;if(this.player.direction===E.DOWN&&this.player.lastDirection===E.LEFT||this.player.direction===E.LEFT&&this.player.lastDirection===E.DOWN)return e.x=1,e;if(this.player.direction===E.DOWN&&this.player.lastDirection===E.UP)return t<i&&(e.x=3),t>=i&&t<i*2&&(e.x=1,e.y=14),t>=i*2&&t<i*3&&(e.x=1),e;if(this.player.direction===E.LEFT&&this.player.lastDirection===E.RIGHT)return t<i&&(e.x=2),t>=i&&t<i*2&&(e.x=1,e.y=8),t>=i*2&&t<i*3&&(e.x=1),e;if(this.player.direction===E.UP&&this.player.lastDirection===E.DOWN)return t<i&&(e.x=2),t>=i&&t<i*2&&(e.x=1,e.y=12),t>=i*2&&t<i*3&&(e.x=4),e;if(this.player.direction===E.RIGHT&&this.player.lastDirection===E.LEFT)return t<i&&(e.x=1),t>=i&&t<i*2&&(e.x=1,e.y=8),t>=i*2&&t<i*3&&(e.x=2),e});r(this,"draw",e=>{const t=this.player;m.ctx.save(),this.updateDrawXY(e),t.drawableY=t.y,this.flashingFrame+=e*12/x.FPS,t.dead||(Di.draw(t.x-this.drawX,t.y-this.drawY,1,1),(!this.flashing||Math.floor(this.flashingFrame)%2===0)&&this.drawPlayerSprite(e)),this.drawSpellBeam(e),m.ctx.restore()});r(this,"drawSpellBeam",e=>{m.ctx.save(),this.player.inventory.getWeapon()instanceof Qe&&this.player.inventory.getWeapon().drawBeams(this.player.x-this.drawX,this.player.y-this.drawY,e),m.ctx.restore()});r(this,"shadeColor",()=>(this.player,"black"));r(this,"drawTopLayer",e=>{m.ctx.save(),this.player.healthBar.draw(e,this.player.health,this.player.maxHealth,this.player.x-this.drawX,this.player.y-this.drawY,!this.flashing||Math.floor(this.flashingFrame)%2===0),m.ctx.restore()});r(this,"updateDrawXY",e=>{this.doneMoving()||(this.drawX*=.85**e,this.drawY*=.85**e,this.drawX=Math.abs(this.drawX)<.01?0:this.drawX,this.drawY=Math.abs(this.drawY)<.01?0:this.drawY),this.doneHitting()&&this.jump(e),this.doneHitting()||this.updateHitXY(e),this.enableSlowMotion(),x.ANIMATION_SPEED=this.motionSpeed});r(this,"updateHitXY",e=>{this.hitX*=.7**e,this.hitY*=.7**e,this.hitX=Math.min(Math.max(this.hitX,-1),1),this.hitY=Math.min(Math.max(this.hitY,-1),1),Math.abs(this.hitX)<.01&&(this.hitX=0),Math.abs(this.hitY)<.01&&(this.hitY=0)});r(this,"doneMoving",()=>{let e=.01;return Math.abs(this.drawX)<e&&Math.abs(this.drawY)<e});r(this,"doneHitting",()=>{let e=.01;return Math.abs(this.hitX)<e&&Math.abs(this.hitY)<e});r(this,"snapDrawStuff",()=>{this.drawX=0,this.drawY=0,this.hitX=0,this.hitY=0,this.jumpY=0});r(this,"setHitXY",(e,t)=>{this.hitX=e,this.hitY=t});r(this,"drawGUI",(e,t=!1)=>{if(m.ctx.save(),this.player.dead){m.ctx.fillStyle=q.LEVEL_TEXT_COLOR;const i=$e.getStats(),s=i.enemies,a=s.reduce((p,y)=>(p[y]=(p[y]||0)+1,p),{}),n=[];this.player.lastHitBy!=="enemy"?n.push(`You were slain by ${this.player.lastHitBy}.`):n.push("Game Over");const c=this.player.getRoom?this.player.getRoom():this.player.game.levels[this.player.depth].rooms[this.player.levelID];n.push(`Depth reached: ${c.depth}`),n.push(`${Object.values(a).reduce((p,y)=>p+y,0)} enemies killed in total:`),Object.entries(a).forEach(([p,y])=>{n.push(`${p} x${y}`)});let l="Press space or click to restart";x.isMobile&&(l="Tap to restart");const d=m.letter_height+2,u=n.length*d+d;let h=x.HEIGHT/2-u/2;n.forEach((p,y)=>{const g=m.measureText(p).width,w=y===0||y===1||y===n.length-1?d*1.5:d;m.fillText(p,x.WIDTH/2-g/2,h),h+=w});const f=m.measureText(l).width;if(m.fillText(l,x.WIDTH/2-f/2,h),this.player.game.feedbackButton){const p=h+m.letter_height+22,g=m.measureText(this.player.game.feedbackButton.text).width+10,w=(x.WIDTH-g)/2;this.player.game.feedbackButton.x=w,this.player.game.feedbackButton.y=p,this.player.game.feedbackButton.draw()}if(!this.player.game.hasRecordedStats){const p=Date.now()-this.player.game.gameStartTimeMs,y=this.player.inventory.items.filter(g=>(g==null?void 0:g.name)&&(g==null?void 0:g.stackCount)).map(g=>({name:g.name,stackSize:g.stackCount}));this.player.game.recordGameStats({xp:i.xp,level:i.level,gameDurationMs:p,inventory:y,killedBy:this.player.lastHitBy??null,enemiesKilled:s,damageDone:i.damageDone,damageTaken:i.damageTaken,depthReached:c.depth,turnsPassed:i.turnsPassed,coinsCollected:i.coinsCollected,itemsCollected:i.itemsCollected,deviceType:Gh(),sidePathsEntered:i.sidePathsEntered,weaponChoice:i.weaponChoice,gameVersion:this.player.game.version,loadedFromSaveFile:this.player.game.loadedFromSaveFile}),this.player.game.hasRecordedStats=!0}}else{this.player.bestiary&&this.player.bestiary.draw(e),this.guiHeartFrame>0&&(this.guiHeartFrame+=e),this.guiHeartFrame>5&&(this.guiHeartFrame=0);const i=this.player.inventory.getArmor(),s=this.player.inventory.getQuickbarStartX()+(i?-34:-24);let a=s/x.TILESIZE;a<.25&&(a=.25);for(let h=0;h<this.player.maxHealth;h++){let f=0,p=0;this.player.health<=1&&(f=Math.round(Math.sin(Date.now()/25/(h+1))+h/2)/2/x.TILESIZE,p=Math.round(Math.sin(Date.now()/25/(h+2))+h/2)/2/x.TILESIZE);let y=this.guiHeartFrame>0?1:0,g=x.WIDTH>175?0:-1.25;h>=Math.floor(this.player.health)?h==Math.floor(this.player.health)&&this.player.health*2%2==1?m.drawFX(4,2,.75,.75,a+h/1.5+f,x.HEIGHT/x.TILESIZE-1+p+g,.75,.75):m.drawFX(3,2,.75,.75,a+h/1.5+f,x.HEIGHT/x.TILESIZE-1+p+g,.75,.75):m.drawFX(y,2,.75,.75,a+h/1.5+f,x.HEIGHT/x.TILESIZE-1+p+g,.75,.75)}i&&i.drawGUI(e,this.player.maxHealth,s),t||this.player.inventory.draw(e);const n=this.player.inventory.isOpen,c=this.player.inventory.isPointInQuickbarBounds(pt.getInstance().getPosition().x,pt.getInstance().getPosition().y).inBounds&&!this.player.inventory.isOpen,l=this.player.openVendingMachine&&ut.isPointInVendingMachineBounds(pt.getInstance().getPosition().x,pt.getInstance().getPosition().y,this.player.openVendingMachine),d=this.player.inventory.isPointInInventoryBounds(pt.getInstance().getPosition().x,pt.getInstance().getPosition().y).inBounds,u=n&&d||c?"inventory":l?"vendingMachine":"none";x.HOVER_TEXT_ENABLED&&lo.draw(e,this.player.x,this.player.y,this.player.getRoom?this.player.getRoom():this.player.game.levels[this.player.depth].rooms[this.player.levelID],this.player,pt.getInstance().getPosition().x,pt.getInstance().getPosition().y,u)}rs.draw(e),this.hurting&&this.drawHurt(e),this.player.mapToggled===!0&&this.player.map.draw(e),this.drawTileCursor(e),this.player.setCursorIcon(),this.player.menu.open&&this.player.menu.draw(),m.ctx.restore()});r(this,"drawCooldownBar",()=>{m.ctx.save(),this.player.cooldownRemaining>0?this.player.cooldownRemaining=1-(Date.now()-this.player.movement.lastMoveTime)/this.player.movement.adjustedCooldown:this.player.cooldownRemaining=0;const e=x.TILESIZE;m.drawFX(12+Math.max(0,Math.min(14,Math.floor(17*this.player.cooldownRemaining))),2,1,1,.45,x.HEIGHT/e-2.125,1,1),m.ctx.restore()});r(this,"drawHurt",e=>{m.ctx.save(),m.ctx.globalAlpha=this.hurtAlpha,this.hurtAlpha-=this.hurtAlpha/10*e,this.hurtAlpha<=.01&&(this.hurtAlpha=0,this.hurting=!1,this.hurtingShield=!1),m.ctx.globalCompositeOperation="source-over",m.ctx.fillStyle="#cc3333",this.hurtingShield&&(m.ctx.fillStyle="#639bff"),m.ctx.fillRect(0,0,x.WIDTH,x.HEIGHT),m.ctx.restore()});r(this,"drawLowHealth",e=>{if(m.ctx.save(),this.player.health<=1&&!this.player.dead){m.ctx.globalAlpha=.5,this.lowHealthFrame+=e;const i=m.ctx.createLinearGradient(0,x.HEIGHT,0,x.HEIGHT*2/3);[i].forEach(s=>{s.addColorStop(0,"#cc3333"),s.addColorStop(1,"rgba(0, 0, 0, 0)")}),m.ctx.globalCompositeOperation="source-over",m.ctx.fillStyle=i,m.ctx.fillRect(0,0,x.WIDTH,x.HEIGHT),m.ctx.globalCompositeOperation="source-over",m.ctx.globalAlpha=1}else this.lowHealthFrame=0;m.ctx.restore()});r(this,"heartbeat",()=>{this.guiHeartFrame=1});r(this,"drawTileCursor",e=>{if(this.player.inventory.isOpen||this.player.inputHandler.mostRecentMoveInput==="keyboard"||x.isMobile||(m.ctx.save(),!this.player.mouseInLine()||!this.player.isMouseAboveFloor()||this.player.isMouseOnPlayerTile()))return;m.drawFX(24+Math.floor(Ht.frame),5,1,1,this.player.tileCursor.x+this.player.drawX,this.player.tileCursor.y+this.player.drawY,1,1),m.ctx.restore()});r(this,"jump",e=>{let t=Math.max(Math.abs(this.drawX),Math.abs(this.drawY));this.jumpY=Math.abs(Math.sin(t*Math.PI)*this.jumpHeight),Math.abs(this.jumpY)<.01&&(this.jumpY=0),this.jumpY>this.jumpHeight&&(this.jumpY=this.jumpHeight)});this.player=e,this.jumpY=0,this.flashingFrame=0,this.guiHeartFrame=0,this.motionSpeed=1,this.hitX=0,this.hitY=0,this.drawX=0,this.drawY=0,this.hurtAlpha=.25,this.jumpHeight=.25,this.hurting=!1,this.hurtingShield=!1,this.slowMotionEnabled=!1,this.slowMotionTickDuration=0,this.flashing=!1,this.lowHealthFrame=0,this.frame=0}}class fi extends xi{constructor(t,i,s,a){super();r(this,"globalId");r(this,"id");r(this,"x");r(this,"y");r(this,"w");r(this,"h");r(this,"direction");r(this,"lastDirection");r(this,"game");r(this,"levelID");r(this,"roomGID");r(this,"health");r(this,"maxHealth");r(this,"healthBar");r(this,"dead");r(this,"lastTickHealth");r(this,"inventory");r(this,"sightRadius");r(this,"defaultSightRadius");r(this,"map");r(this,"openVendingMachine");r(this,"isLocalPlayer");r(this,"mapToggled");r(this,"lastHitBy");r(this,"turnCount");r(this,"triedMove");r(this,"tutorialRoom");r(this,"moveRange");r(this,"tileCursor");r(this,"lightEquipped");r(this,"lightSource");r(this,"hurtShield");r(this,"lightBrightness");r(this,"moveDistance");r(this,"moveQueue");r(this,"lastX");r(this,"lastY");r(this,"justMoved");r(this,"depth");r(this,"menu");r(this,"busyAnimating");r(this,"lightColor");r(this,"inputHandler");r(this,"actionProcessor");r(this,"movement");r(this,"cooldownRemaining");r(this,"renderer");r(this,"drawMoveQueue",[]);r(this,"seenEnemies",new Set);r(this,"bestiary",null);r(this,"getRoom",()=>{var i,s;return((s=(i=this.game).getRoomById)==null?void 0:s.call(i,this.roomGID))||this.game.levels[this.depth].rooms[this.levelID]});r(this,"setHitXY",(t,i,s=.5)=>{this.renderer.hitX=s*(this.x-t),this.renderer.hitY=s*(this.y-i)});r(this,"applyStatus",(t,i)=>{if(t instanceof it){if(i.poison)return t.poison(),!0;if(i.blood)return t.bleed(),!0}});r(this,"isMouseOnPlayerTile",()=>this.mouseToTile().x===this.x&&this.mouseToTile().y===this.y);r(this,"isMouseAboveFloor",(t=0)=>{var n,c,l,d;const i=this.mouseToTile(t);if(i.x===void 0||i.y===void 0)return!1;const s=i.x,a=i.y;return this.game.levelState===Qt.LEVEL_GENERATION||!this.game.started||!this.game.room||!this.game.room.roomArray||!Array.isArray(this.game.room.roomArray[s])||this.game.room.roomArray[s][a]===void 0?!1:!(!((n=this.game.room)!=null&&n.tileInside(s,a))||(c=this.game.room)!=null&&c.tileInside(s,a)&&((l=this.game.room)!=null&&l.roomArray[s][a].isSolid())&&!(((d=this.game.room)==null?void 0:d.roomArray[s][a])instanceof ot))});r(this,"mouseInLine",()=>{const t=this.mouseToTile();return t.x===void 0||t.y===void 0?!1:t.x===this.x||t.y===this.y});r(this,"canMoveWithMouse",()=>{if(this.inventory.isOpen)return null;const t=this.isMouseAboveFloor(),i=this.isMouseAboveFloor(8);if(!t&&!i)return null;const s=this.mouseToTile(),a=this.mouseToTile(8);if(s.x===void 0||s.y===void 0||a.x===void 0||a.y===void 0||!this.game.room.roomArray||!this.game.room.roomArray[s.x]||!this.game.room.roomArray[s.x][s.y])return null;let n=s.y;const c=this.checkTileForEntity(a);i&&c&&(n=a.y);const l=s.x===this.x,d=n===this.y;if(l&&d)return null;if(l){const u=n<this.y?this.y-1:this.y+1;return!this.game.room.roomArray[this.x]||!this.game.room.roomArray[this.x][u]?null:n<this.y?{direction:E.UP,x:this.x,y:u}:{direction:E.DOWN,x:this.x,y:u}}if(d){const u=s.x<this.x?this.x-1:this.x+1;return!this.game.room.roomArray[u]||!this.game.room.roomArray[u][this.y]?null:s.x<this.x?{direction:E.LEFT,x:u,y:this.y}:{direction:E.RIGHT,x:u,y:this.y}}return null});r(this,"stall",()=>{var t,i;!this.game.started||!this.game.room||!this.renderer||this.game.levelState===Qt.IN_LEVEL&&((i=(t=this.game)==null?void 0:t.room)==null||i.tick(this),this.shakeScreen(this.x-.5,this.y,this.x+.5,this.y,5),this.game.pushMessage("Equipping an item takes a turn."))});r(this,"moveWithMouse",()=>{this.inputHandler.setMostRecentMoveInput("mouse");const t=this.canMoveWithMouse();t!==null&&this.actionProcessor.process({type:"MouseMove",direction:t.direction,targetX:t.x,targetY:t.y})});r(this,"mouseToTile",(t=0)=>{if(I.mouseX===void 0||I.mouseY===void 0)return{x:void 0,y:void 0};const i=x.WIDTH/2,s=x.HEIGHT/2,a=Math.floor((I.mouseX-i+x.TILESIZE/2)/x.TILESIZE),n=Math.floor((I.mouseY+t-s+x.TILESIZE/2)/x.TILESIZE);return{x:this.x+a,y:this.y+n}});r(this,"tileToMouse",(t,i)=>{const s=x.WIDTH/2,a=x.HEIGHT/2,n=t-this.x,c=i-this.y,l=s+n*x.TILESIZE,d=a+c*x.TILESIZE;return{x:l,y:d}});r(this,"setTileCursorPosition",()=>{const t=Math.floor(x.WIDTH/2)/x.TILESIZE,i=Math.floor(x.HEIGHT/2)/x.TILESIZE,s=this.mouseToTile();let a=s.x-this.x+t-.5,n=s.y-this.y+i-.5;const c=t,l=i,d=Math.abs(a+.5-c),u=Math.abs(n+.5-l);if(d>1){const h=a>c?1:-1;a=c+h-.5}if(u>1){const h=n>l?1:-1;n=l+h-.5}this.tileCursor={x:a,y:n}});r(this,"enemyInRange",(t,i,s)=>{const a=s??1;return t===this.x&&i===this.y||t!==this.x&&i!==this.y?!1:i===this.y?Math.abs(t-this.x)<=a:t===this.x?Math.abs(i-this.y)<=a:!1});r(this,"getDirectionFromCoords",(t,i)=>t===this.x&&i===this.y||t!==this.x&&i!==this.y?"":i===this.y?t>this.x?"right":"left":t===this.x?i>this.y?"down":"up":"arrow");r(this,"setCursorIcon",()=>{if(this.inventory.isDragging){pt.getInstance().setIcon("grab");return}const t=pt.getInstance(),i=t.getPosition(),s=this.mouseToTile(),a=this.getCursorState(i,s);t.setIcon(a)});r(this,"getCursorState",(t,i)=>this.isMouseInUI(t)?"hand":this.isEntityAttackable(i)?"sword":this.isMouseAboveFloor()&&this.mouseInLine()?this.enemyInRange(i.x,i.y,1)?this.getDirectionFromCoords(i.x,i.y):"hand":"arrow");r(this,"isMouseInUI",t=>{const{x:i,y:s}=t;return this.inventory.isPointInInventoryButton(i,s)||this.isInventoryItemInteraction(i,s)});r(this,"isInventoryItemInteraction",(t,i)=>{const s=this.inventory.itemAtSelectedSlot()instanceof me;return this.inventory.isPointInQuickbarBounds(t,i).inBounds&&s||this.inventory.isOpen&&this.inventory.isPointInInventoryBounds(t,i).inBounds&&s});r(this,"isEntityAttackable",t=>this.checkTileForEntity(t)?!0:this.checkTileForEntity({x:t.x,y:this.mouseToTile(x.TILESIZE/2).y}));r(this,"checkTileForEntity",t=>{var s;const i=((s=this.inventory.weapon)==null?void 0:s.range)??1;return this.game.room.entities.some(a=>a.x===t.x&&a.y===t.y&&this.enemyInRange(a.x,a.y,i))});r(this,"restart",()=>{this.dead=!1,this.game.newGame()});r(this,"hit",()=>1);r(this,"tryCollide",(t,i,s)=>!(t.collidable===!1||i>=t.x+t.w||i+this.w<=t.x||s>=t.y+t.h||s+this.h<=t.y));r(this,"tryMove",(t,i)=>{var a,n,c;if(this.busyAnimating||this.game.levelState===Qt.TRANSITIONING||this.game.levelState===Qt.TRANSITIONING_LADDER)return;if(this.getRoom().catchUp(),!this.game.room){console.warn("oi bruv, game.room isn't even there!");return}if(this.dead)return;for(let l of this.getRoom().entities)if(l.collidable===!0&&l.x===t&&l.y===i)break;if(this.inventory.hasWeapon()&&!this.inventory.getWeapon().weaponMove(t,i))return;this.inventory.hasWeapon()||this.game.pushMessage("No weapon equipped.");for(let l of this.getRoom().entities)if(l.lastX=l.x,l.lastY=l.y,this.tryCollide(l,t,i)){if(l.pushable){let d=t-this.x,u=i-this.y,h=t+d,f=i+u,p=!1,y=!1,g=[];for(;;){p=!0;for(const w of this.getRoom().entities)if(w.lastX=w.x,w.lastY=w.y,w.pointIn(h,f)){if(!w.chainPushable){y=!0,p=!0;break}p=!1,g.push(w);break}if(p)break;h+=d*g[g.length-1].w,f+=u*g[g.length-1].h}if(g.length===0&&(this.getRoom().roomArray[h][f].canCrushEnemy()||y)){if(l.destroyable){l.hurt(this,l.health,"none"),this.getRoom()===this.game.room&&H.hit(),this.shakeScreen(this.x,this.y,l.x,l.y),this.hitShake(this.x,this.y,l.x,l.y),this.getRoom().tick(this);return}}else{this.getRoom()===this.game.room&&H.push();for(const w of g)w.lastX=w.x,w.lastY=w.y,w.x+=d,w.y+=u,w.drawX=d,w.drawY=u,w.skipNextTurns=1;if(this.getRoom().roomArray[h][f].canCrushEnemy()||y){const w=g[g.length-1];w.crush(),w.isEnemy&&H.playSquish(),this.getRoom()===this.game.room&&H.hit()}l.x+=d,l.y+=u,l.drawX=d,l.drawY=u,this.move(t,i),this.moveDistance++,this.getRoom().tick(this);return}}else if(!l.dead){l.interactable&&l.interact(this);return}}let s=(c=(n=(a=this.getRoom())==null?void 0:a.roomArray)==null?void 0:n[t])==null?void 0:c[i];if(!s){console.warn("oi bruv, tile to check for collision isn't even there!");return}if(!this.getRoom()){console.warn("oi bruv, room to check for collision isn't even there!");return}if(!this.getRoom().roomArray){console.warn("oi bruv, level to check for collision isn't even there!");return}if(s.isSolid())s instanceof ot&&(this.shakeScreen(this.x,this.y,t,i),s.canUnlock(this)?s.unlock(this):H.playLocked());else{if((s instanceof le||s instanceof wt)&&s.isLocked()){this.shakeScreen(this.x,this.y,t,i),s.lockable.canUnlock(this)?s.lockable.unlock(this):H.playLocked(),s.addLightSource(),this.game.room.updateLighting();return}this.move(t,i),s.onCollide(this),s instanceof ot||s instanceof xn||s instanceof le||s instanceof wt||this.getRoom().tick(this)}});r(this,"updateLastPosition",(t,i)=>{this.lastX=t,this.lastY=i});r(this,"hurt",(t,i,s=0)=>{this.getRoom()===this.game.room&&setTimeout(()=>{H.hurt(),H.playGrunt(),this.renderer.flash(),this.renderer.hurt()},s),this.inventory.getArmor()&&this.inventory.getArmor().health>0&&(this.inventory.getArmor().hurt(t),this.renderer.hurtShield(),this.hurtShield=!0),this.lastHitBy=i,this.healthBar.hurt(),this.enemyHurtMessage(t,i),this.hurtShield||(this.health-=t,ht.emit(xt.DAMAGE_TAKEN,{amount:t})),this.hurtShield=!1,this.health<=0&&!x.DEVELOPER_MODE&&(this.dead=!0)});r(this,"enemyHurtMessage",(t,i)=>{x.DEVELOPER_MODE||this.game.pushMessage(`The ${i} hits you for ${t} damage.`)});r(this,"beginSlowMotion",()=>{this.renderer.beginSlowMotion()});r(this,"endSlowMotion",()=>{this.renderer.endSlowMotion()});r(this,"move",(t,i)=>{this.updateLastPosition(this.x,this.y),this.getRoom()===this.game.room&&H.playerStoneFootstep(this.game.room.envType),this.openVendingMachine&&this.openVendingMachine.close(),this.renderer.setNewDrawXY(t,i),this.drawMoveQueue.push({drawX:t-this.x,drawY:i-this.y}),this.x=t,this.y=i;for(let n of this.getRoom().items)n.x===t&&n.y===i&&n.onPickup(this);let s=t-this.lastX,a=i-this.lastY;if(!(s===0&&a===0))for(let n of this.game.level.rooms)n.roomOnScreen(this),n.onScreen});r(this,"moveNoSmooth",(t,i)=>{this.x=t,this.y=i});r(this,"moveSnap",(t,i)=>{this.x=Math.round(t),this.y=Math.round(i),this.renderer.snapDrawStuff()});r(this,"update",()=>{});r(this,"finishTick",()=>{this.turnCount+=1,this.inventory.tick(),this.renderer.disableFlash();let t=this.health-this.lastTickHealth;this.lastTickHealth=this.health,t<0&&this.renderer.flash(),ht.emit(xt.TURN_PASSED,{}),this.moveDistance=0});r(this,"draw",t=>{this.renderer.draw(t)});r(this,"heal",t=>{this.health+=t,this.health>this.maxHealth&&(this.health=this.maxHealth)});r(this,"hitShake",(t,i,s,a)=>{const n=x.TILESIZE,c=Math.min(Math.max(.5*(t-s),-n),n),l=Math.min(Math.max(.5*(i-a),-n),n);this.renderer.setHitXY(c,l)});r(this,"shakeScreen",(t,i,s,a,n=10)=>{const c=x.TILESIZE,l=Math.min(Math.max(.5*(t-s),-c),c),d=Math.min(Math.max(.5*(i-a),-c),c);this.renderer.setHitXY(l,d),this.game.shakeScreen(-l*1*n,-d*1*n)});r(this,"updateSlowMotion",()=>{this.renderer.updateSlowMotion()});r(this,"drawGUI",t=>{this.renderer.drawGUI(t)});this.globalId=se.generate("P"),this.game=t,this.levelID=0,this.roomGID=void 0,this.x=i,this.y=s,this.w=1,this.h=1,this.moveDistance=0,this.direction=E.UP,this.lastDirection=E.UP,this.lastX=0,this.lastY=0,this.isLocalPlayer=a,this.depth=0,this.menu=new En(this),this.busyAnimating=!1,this.mapToggled=!0,this.health=2,this.maxHealth=2,this.healthBar=new gn,this.dead=!1,this.lastTickHealth=this.health,this.inventory=new vh(t,this),this.defaultSightRadius=3,this.sightRadius=q.LIGHTING_MAX_DISTANCE,this.map=new Ah(this.game,this),this.turnCount=0,this.triedMove=!1,this.tutorialRoom=!1,this.tileCursor={x:0,y:0},this.moveRange=1,this.lightEquipped=!1,this.lightColor=q.AMBIENT_LIGHT_COLOR,this.hurtShield=!1,this.lightBrightness=.3,this.moveQueue=[],this.justMoved=1,this.inputHandler=new Oh(this),this.actionProcessor=new Mh(this),this.movement=new Ph(this),this.renderer=new Wh(this),this.bestiary=new Sn(this.game,this),this.cooldownRemaining=0}get hitX(){var t;return((t=this.renderer)==null?void 0:t.drawX)??0}get hitY(){var t;return((t=this.renderer)==null?void 0:t.drawY)??0}get drawX(){var t;return((t=this.renderer)==null?void 0:t.drawX)??0}get drawY(){var t;return((t=this.renderer)==null?void 0:t.drawY)??0}}r(fi,"minSightRadius",2);class Pi extends Ks{constructor(e,t,i,s){super(e,t,i,s),this.room=e,this.health=2,this.tileX=8,this.tileY=2,this.hasShadow=!1,this.chainPushable=!1,this.name="rock",O.rand()<.2&&this.drops.push(new Se(this.room,this.x,this.y))}}class Re extends mt{constructor(t,i,s,a,n=0,c){super(t,i,s,a);r(this,"skinType");r(this,"uniqueKillBehavior",()=>{this.cloned||H.delayPlay(H.breakRock,50)});r(this,"onHurt",(t=1)=>{if(this.health===1){const i=this.room.getEmptyTiles().filter(s=>Math.abs(s.x-this.x)<=1&&Math.abs(s.y-this.y)<=1);if(i.length>0){for(let s of i)for(const a in this.game.players){const n=this.game.players[a].x,c=this.game.players[a].y;(n!==s.x&&c===s.y||n===s.x&&c!==s.y)&&this.room.entities.push(new _t(this.room,this.game,s.x,s.y))}H.delayPlay(H.skeleSpawn,50)}this.tileX+=2}});r(this,"draw",t=>{this.dead||(this.updateDrawXY(t),this.hasShadow&&this.drawShadow(t),m.ctx.save(),m.ctx.globalAlpha=this.alpha,m.drawObj(this.tileX,this.tileY,1,2,this.x-this.drawX,this.y-this.drawYOffset-this.drawY,1,2,this.room.shadeColor,this.shadeAmount()),m.ctx.restore())});r(this,"drawTopLayer",t=>{this.drawableY=this.y});this.skinType=n,this.room=t,this.health=2,this.tileX=11+this.skinType,this.tileY=2,this.hasShadow=!0,this.chainPushable=!1,this.name="tombstone",O.rand()<.25&&this.drops.push(new Qe(this.room,this.x,this.y)),this.hasBloom=!0,this.bloomColor="#05FF05",this.bloomAlpha=1,this.softBloomAlpha=0,this.imageParticleX=0,this.imageParticleY=25,this.lightSource=new Vt(this.x+.5,this.y+.5,7,[5,150,5],1),this.addLightSource(this.lightSource)}get type(){return gt.PROP}}class Wo extends xi{constructor(t,i,s){super();r(this,"x");r(this,"y");r(this,"room");r(this,"skin");r(this,"isDoor");r(this,"opacity");r(this,"applySkin");r(this,"shadeAmount",(t=0,i=0)=>x.SMOOTH_LIGHTING?0:this.room.softVis[this.x+t][this.y+i]);r(this,"isSolid",()=>!1);r(this,"canCrushEnemy",()=>!1);r(this,"isOpaque",()=>!1);r(this,"onCollide",t=>{});r(this,"onCollideEnemy",t=>{});r(this,"tick",()=>{});r(this,"tickEnd",()=>{});r(this,"draw",t=>{});r(this,"drawUnderPlayer",t=>{let i=1;this.applySkin&&(i=this.skin),m.drawTile(1,i,1,1,this.x,this.y,1,1,this.room.shadeColor,this.shadeAmount())});r(this,"drawAbovePlayer",t=>{});r(this,"drawAboveShading",t=>{});this.skin=t.skin,this.room=t,this.x=i,this.y=s,this.drawableY=s,this.isDoor=!1,this.opacity=1,this.applySkin=!1}}class Vh extends Vi{constructor(t,i,s,a){super(t,i,s);r(this,"state");r(this,"frame");r(this,"delay");r(this,"parent");r(this,"offsetFrame");r(this,"drawTopLayer",t=>{this.dead||(this.offsetFrame<0&&(this.offsetFrame+=10*t),this.offsetFrame>=0&&(this.frame+=.25*t),this.frame>17&&(this.dead=!0),m.drawFX(Math.floor(this.frame),6,1,2,this.x,this.y-1,1,2))});this.state=0,this.frame=6,this.parent=t,this.offsetFrame=-Q.distance(this.parent.x,this.parent.y,this.x,this.y)*100,this.delay=0,Xe.momentaryLight(this.parent.room,this.x+.5,this.y+.5,.5,[255,100,0],350,20,Math.abs(this.offsetFrame));const n=Q.distance(this.parent.x,this.parent.y,this.x,this.y);let c=n===0?1:Math.max(.5,Math.floor(1/n*4)/2);for(let l of this.parent.room.entities)l.x===this.x&&l.y===this.y&&l!==this.parent&&(l instanceof ui&&(l.fuseLength=1),l.hurt(a,c)),a.x===this.x&&a.y===this.y&&a.hurt(c,"bomb")}}class ui extends mt{constructor(t,i,s,a){super(t,i,s,a);r(this,"fuseLength",4);r(this,"lit",!1);r(this,"playerHitBy",null);r(this,"fuseSound");r(this,"soundPaused",!1);r(this,"uniqueKillBehavior",()=>{this.cloned});r(this,"tick",()=>{this.lit&&(this.fuseLength--,this.fuseLength<=0&&(this.fuseLength=0,H.stopSound(this.fuseSound),this.explode(),H.playBomb()))});r(this,"createLightSource",()=>{this.lit&&(this.lightSource=new Vt(this.x+.5,this.y+.5,3,[200,200,30],.75),this.addLightSource(this.lightSource),this.bloomAlpha=1,this.hasBloom=!0)});r(this,"hurt",(t,i)=>{this.lit||(this.lit=!0,this.createLightSource(),this.playerHitBy=t,H.playFuse())});r(this,"explode",()=>{H.stopSound(this.fuseSound);for(let t=this.x-2;t<this.x+3;t++)for(let i=this.y-2;i<this.y+3;i++)if(this.room.pointExists(t,i)&&!this.room.roomArray[t][i].isSolid()&&Q.distance(this.x,this.y,t,i)<2.5){const s=new Vh(this,t,i,this.playerHitBy);this.room.projectiles.push(s)}this.health=0,Xe.momentaryLight(this.room,this.x,this.y,7,[200,200,50],250,50,0),xe.spawnCluster(this.room,this.x+.5,this.y+.5,"white"),this.kill(),setTimeout(()=>{this.game.shakeScreen((O.rand()-.5)*5,(O.rand()-.5)*0,!1)},100),this.game.shakeScreen(0,20,!1)});r(this,"draw",t=>{this.dead||(this.frame+=t,this.health===0&&(this.frame=0),this.frame>20&&(this.frame=0),this.bloomAlpha=this.frame/10%2===0?1:.5,m.ctx.save(),m.ctx.globalAlpha=this.alpha,this.dead||(this.hasShadow&&this.drawShadow(t),this.updateDrawXY(t),this.lit?m.drawObj(this.tileX+6-Math.min(3,this.fuseLength)*2+Math.floor(this.frame/10)%2,this.tileY,1,2,this.x-this.drawX,this.y-this.drawYOffset-this.drawY,1,2,this.room.shadeColor,this.shadeAmount()):m.drawObj(this.tileX-1,this.tileY,1,2,this.x-this.drawX,this.y-this.drawYOffset-this.drawY,1,2,this.room.shadeColor,this.shadeAmount())),m.ctx.restore())});r(this,"drawTopLayer",t=>{this.drawableY=this.y});this.room=t,this.health=1,this.tileX=15,this.tileY=4,this.hasShadow=!0,this.chainPushable=!1,this.name="bomb",this.frame=0,this.hasBloom=!1,this.bloomColor="yellow",this.bloomAlpha=0,this.bloomSize=1,this.bloomOffsetY=-1,this.health=1,this.hitSound=H.potSmash,this.imageParticleX=0,this.imageParticleY=29,this.createLightSource(),this.playerHitBy=null,this.fuseSound=H.fuseLoopSound,this.soundPaused=!1}get type(){return gt.PROP}}class ci extends mt{constructor(t,i,s,a){super(t,i,s,a);r(this,"uniqueKillBehavior",()=>{this.cloned||H.delayPlay(H.breakRock,50)});r(this,"draw",t=>{this.dead||(m.ctx.save(),m.ctx.globalAlpha=this.alpha,this.dead||(this.hasShadow&&this.drawShadow(t),this.updateDrawXY(t),m.drawObj(this.tileX,this.tileY,1,2,this.x-this.drawX,this.y-this.drawYOffset-this.drawY,1,2,this.room.shadeColor,this.shadeAmount())),m.ctx.restore())});r(this,"drawTopLayer",t=>{this.drawableY=this.y});this.room=t,this.health=1,this.tileX=10,this.tileY=2,this.hasShadow=!0,this.chainPushable=!1,this.name="block",this.imageParticleX=0,this.imageParticleY=25,this.opaque=!0,O.rand()<.01&&this.drops.push(new Se(this.room,this.x,this.y))}get type(){return gt.PROP}}class jh{constructor(e){r(this,"room");r(this,"getWallType",(e,t,i,s,a,n)=>{let c=[];return t===s&&e>=i&&e<=i+a&&c.push(Ds.NORTH),t===s+n&&e>=i&&e<=i+a&&c.push(Ds.SOUTH),e===i&&t>=s&&t<=s+n&&c.push(Ds.WEST),e===i+a&&t>=s&&t<=s+n&&c.push(Ds.EAST),c});r(this,"countWallNeighbors",e=>{var i;let t=0;for(let s=e.x-1;s<=e.x+1;s++)for(let a=e.y-1;a<=e.y+1;a++)((i=this.room.roomArray[s])==null?void 0:i[a])instanceof et&&!(s===e.x&&a===e.y)&&t++;return t});this.room=e,this.buildEmptyRoom()}buildEmptyRoom(){for(let e=this.room.roomX;e<this.room.roomX+this.room.width;e++)for(let t=this.room.roomY;t<this.room.roomY+this.room.height;t++)this.room.pointInside(e,t,this.room.roomX+1,this.room.roomY+1,this.room.width-2,this.room.height-2)?this.room.roomArray[e][t]=new bt(this.room,e,t):this.room.roomArray[e][t]=new et(this.room,e,t,this.getWallType(e,t,this.room.roomX,this.room.roomY,this.room.width,this.room.height))}addWallBlocks(e){this.addWallBlocksStandard(e)}addWallBlocksStandard(e){let t=m.randTable([0,0,1,1,2,2,2,2,3],e);this.room.width>8&&e()>.5&&(t*=4);for(let i=0;i<t;i++){let s=Math.min(m.randTable([2,2,2,2,2,2,3,3,3,4,5],e),this.room.width-4),a=Math.min(s+m.rand(-2,2,e),this.room.height-4),n=m.rand(this.room.roomX+2,this.room.roomX+this.room.width-s-2,e),c=m.rand(this.room.roomY+2,this.room.roomY+this.room.height-a-2,e);for(let l=n;l<n+s;l++)for(let d=c;d<c+a;d++){let u=new et(this.room,l,d);this.room.roomArray[l][d]=u,this.room.innerWalls.push(u)}this.room.innerWalls.forEach(l=>{this.countWallNeighbors(l)<=1&&(this.room.removeWall(l.x,l.y),this.room.roomArray[l.x][l.y]=new bt(this.room,l.x,l.y),this.room.innerWalls=this.room.innerWalls.filter(d=>d!==l))})}}addWallBlocksVariant(e){var i;let t=m.randTable([2,2,3,3,4,5],e);this.room.width>10&&e()>.5&&(t+=2);for(let s=0;s<t;s++){let a=m.randTable([1,2,2,2,3,3],e),n=Math.min(Math.max(1,a),this.room.width-4),c=Math.min(Math.max(1,a+m.rand(-1,1,e)),this.room.height-4),l=m.rand(this.room.roomX+2,this.room.roomX+this.room.width-n-2,e),d=m.rand(this.room.roomY+2,this.room.roomY+this.room.height-c-2,e);for(let h=l;h<l+n;h++)for(let f=d;f<d+c;f++)if(h===l||f===d||h===l+n-1||f===d+c-1||e()>.35){let y=new et(this.room,h,f);this.room.roomArray[h][f]=y,this.room.innerWalls.push(y)}const u=m.randTable([0,1,1,2],e);for(let h=0;h<u;h++){const f=m.rand(l+1,Math.max(l+1,l+n-2),e),p=m.rand(d+1,Math.max(d+1,d+c-2),e);((i=this.room.roomArray[f])==null?void 0:i[p])instanceof et&&(this.room.removeWall(f,p),this.room.roomArray[f][p]=new bt(this.room,f,p),this.room.innerWalls=this.room.innerWalls.filter(y=>!(y.x===f&&y.y===p)))}this.room.innerWalls.forEach(h=>{this.countWallNeighbors(h)<=2&&(this.room.removeWall(h.x,h.y),this.room.roomArray[h.x][h.y]=new bt(this.room,h.x,h.y),this.room.innerWalls=this.room.innerWalls.filter(f=>f!==h))})}}}class mi extends it{constructor(t,i,s,a,n){super(t,i,s,a);r(this,"frame");r(this,"ticks");r(this,"seenPlayer");r(this,"aggro");r(this,"targetPlayer");r(this,"drop");r(this,"dir");r(this,"hit",()=>this.damage);r(this,"behavior",()=>{if(this.lastX=this.x,this.lastY=this.y,!this.dead){if(this.skipNextTurns>0){this.skipNextTurns--;return}if(this.ticks++,!this.seenPlayer)this.lookForPlayer();else if(this.seenPlayer){if(this.room.playerTicked===this.targetPlayer){this.alertTicks=Math.max(0,this.alertTicks-1);let i=this.x,s=this.y;const a=this.targetPlayer,n=a.y>=this.y&&a.y<this.y+this.h,c=a.x>=this.x&&a.x<this.x+this.w;if(n!==c){let h=this.direction;if(n?h=a.x<this.x?E.LEFT:E.RIGHT:c&&(h=a.y<this.y?E.UP:E.DOWN),h!==this.direction){this.direction=h,this.makeBigHitWarnings(),this.ticks++;return}}let l=Array();for(const h of this.room.entities)if(h!==this)for(let f=0;f<h.w;f++)for(let p=0;p<h.h;p++)l.push({x:h.x+f,y:h.y+p});for(let h=this.x-1;h<=this.x+this.w;h++)for(let f=this.y-1;f<=this.y+this.h;f++)this.room.roomArray[h]&&this.room.roomArray[h][f]&&this.room.roomArray[h][f]instanceof rt&&this.room.roomArray[h][f].on&&l.push({x:h,y:f});let d=[];for(let h=0;h<this.room.roomX+this.room.width;h++){d[h]=[];for(let f=0;f<this.room.roomY+this.room.height;f++)this.room.roomArray[h]&&this.room.roomArray[h][f]?d[h][f]=this.room.roomArray[h][f]:d[h][f]=!1}let u=yt.AStar.search(d,this,this.targetPlayer,l,!1,!1,!0,this.direction);if(u.length>0){let h=u[0].pos.x,f=u[0].pos.y,p=this.direction;if(this.targetPlayer,h>i?this.direction=E.RIGHT:h<i?this.direction=E.LEFT:f>s?this.direction=E.DOWN:f<s&&(this.direction=E.UP),p==this.direction){let y=!1;for(const g in this.game.players)if(this.game.rooms[this.game.players[g].levelID]===this.room){let w=!1;for(let b=0;b<this.w;b++){for(let T=0;T<this.h;T++)if(this.game.players[g].x===h+b&&this.game.players[g].y===f+T){w=!0;break}if(w)break}w&&(this.game.players[g].hurt(this.hit(),this.name),this.drawX=.5*(this.x-this.game.players[g].x),this.drawY=.5*(this.y-this.game.players[g].y),this.game.players[g]===this.game.players[this.game.localPlayerID]&&this.game.shakeScreen(10*this.drawX,10*this.drawY),y=!0)}y||(this.tryMove(h,f),this.setDrawXY(i,s),this.x>i?this.direction=E.RIGHT:this.x<i?this.direction=E.LEFT:this.y>s?this.direction=E.DOWN:this.y<s&&(this.direction=E.UP))}}else this.facePlayer(this.targetPlayer);this.direction==E.LEFT&&(l.push({x:this.x,y:this.y+1}),l.push({x:this.x,y:this.y-1})),this.direction==E.RIGHT&&(l.push({x:this.x,y:this.y+1}),l.push({x:this.x,y:this.y-1})),this.direction==E.DOWN&&(l.push({x:this.x+1,y:this.y}),l.push({x:this.x-1,y:this.y})),this.direction==E.UP&&(l.push({x:this.x+1,y:this.y}),l.push({x:this.x-1,y:this.y})),this.makeBigHitWarnings()}let t=Object.values(this.game.offlinePlayers).indexOf(this.targetPlayer)!==-1;if(!this.aggro||t){let i=this.nearestPlayer();if(i!==!1){let[s,a]=i;s<=4&&(t||s<this.playerDistance(this.targetPlayer))&&a!==this.targetPlayer&&(this.targetPlayer=a,this.facePlayer(a),a===this.game.players[this.game.localPlayerID]&&(this.alertTicks=1),this.makeBigHitWarnings())}}}}});r(this,"drawTopLayer",t=>{this.drawableY=this.y,this.healthBar.draw(t,this.health,this.maxHealth,this.x+.5,this.y,!0)});r(this,"draw",t=>{this.dead||(m.ctx.globalAlpha=this.alpha,this.updateDrawXY(t),this.frame+=.1*t,this.frame>=4&&(this.frame=0),this.hasShadow&&this.drawShadow(t),m.drawMob(this.tileX,this.tileY+this.direction*3,2,3,this.x-this.drawX,this.y-this.drawYOffset-this.drawY-this.jumpY,2,3,this.softShadeColor,this.shadeAmount()),this.cloned||(this.seenPlayer||this.drawSleepingZs(t),this.alertTicks>0&&this.drawExclamation(t)),m.ctx.globalAlpha=1)});this.w=2,this.h=2,this.ticks=0,this.frame=0,this.health=4,this.maxHealth=4,this.defaultMaxHealth=4,this.tileX=31,this.tileY=12,this.seenPlayer=!1,this.aggro=!1,this.dir=E.DOWN,this.name="bigzombie",this.chainPushable=!1,this.forwardOnlyAttack=!0,this.drawMoveSpeed=.9,this.jumpHeight=.35,this.drawYOffset=1.5,this.canDestroyOthers=!0,n&&(this.drop=n);const c=Math.floor(O.rand()*3)+2;for(;this.drops.length<c&&!this.cloned;)this.getDrop()}}r(mi,"difficulty",1),r(mi,"tileX",21),r(mi,"tileY",0);class ca extends Wi{constructor(e,t,i){super(e,t,i),this.fuel=100,this.tileX=27,this.tileY=2,this.name="glow bugs",this.fuelCap=100,this.radius=6,this.stackable=!0,this.maxBrightness=2,this.maxBrightness=.25,this.color=[5,75,75]}}r(ca,"itemName","glow bugs");class pi extends mt{constructor(t,i,s,a,n){super(t,i,s,a);r(this,"ticks");r(this,"frame");r(this,"seenPlayer");r(this,"aggro");r(this,"targetPlayer");r(this,"drop");r(this,"hit",()=>.5);r(this,"behavior",()=>{if(this.lastX=this.x,this.lastY=this.y,this.seenPlayer=!0,this.aggro=!0,!this.dead){if(this.skipNextTurns>0){this.skipNextTurns--;return}this.wander(),this.lightSource.x=this.x+.5,this.lightSource.y=this.y+.5,this.room.updateLighting()}});r(this,"draw",t=>{this.dead||(m.ctx.save(),m.ctx.globalAlpha=this.alpha,this.dead||(this.updateDrawXY(t),this.frame+=.15*t,this.frame>=4&&(this.frame=0),this.tileX=8+this.frame,this.hasShadow&&this.drawShadow(t),m.drawMob(Math.floor(this.tileX),this.tileY,1,1,this.x-this.drawX,this.y-this.drawYOffset-this.drawY,1,1,this.softShadeColor,this.shadeAmount()),this.crushed&&this.crushAnim(t)),this.cloned||(this.seenPlayer||this.drawSleepingZs(t,0,.75*x.TILESIZE),this.alertTicks>0&&this.drawExclamation(t,0,.75*x.TILESIZE)),m.ctx.restore())});this.ticks=0,this.frame=0,this.health=1,this.maxHealth=1,this.defaultMaxHealth=1,this.tileX=8,this.tileY=0,this.seenPlayer=!1,this.aggro=!1,this.name="glowbug",this.orthogonalAttack=!0,this.imageParticleX=3,this.imageParticleY=24,this.drawYOffset=1,this.hasShadow=!0,this.hasHitParticles=!1,this.hasDamageNumbers=!1,this.hasBloom=!0,this.bloomAlpha=1,this.bloomColor="#054B4B",this.lightSource=new Vt(this.x+.5,this.y+.5,6,[5,75,75]),this.addLightSource(this.lightSource),this.drops=[new ca(this.room,this.x,this.y)]}get alertText(){return`New Enemy Spotted: Crab 
    Health: ${this.health}
    Attack Pattern: Omnidirectional
    Moves every other turn`}}r(pi,"difficulty",1),r(pi,"tileX",8),r(pi,"tileY",4);const Mi=class Mi{constructor(){r(this,"gl");r(this,"canvas");r(this,"highQualityShaderProgram");r(this,"performanceShaderProgram");r(this,"currentShaderProgram");r(this,"positionBuffer");r(this,"texCoordBuffer");r(this,"framebuffer");r(this,"texture");r(this,"tempTexture");r(this,"tempFramebuffer");r(this,"textureWidth",0);r(this,"textureHeight",0);r(this,"tempTextureWidth",0);r(this,"tempTextureHeight",0);r(this,"downsampleCanvas");r(this,"downsampleCtx");r(this,"positionLocation");r(this,"texCoordLocation");r(this,"resolutionLocation");r(this,"textureLocation");r(this,"directionLocation");r(this,"radiusLocation");r(this,"resultCanvasCache",new Map);r(this,"maxCacheSize",10);r(this,"vertexShaderSource",`
    precision mediump float;
    attribute vec2 a_position;
    attribute vec2 a_texCoord;
    uniform vec2 u_resolution;
    varying vec2 v_texCoord;
    
    void main() {
      vec2 zeroToOne = a_position / u_resolution;
      vec2 zeroToTwo = zeroToOne * 2.0;
      vec2 clipSpace = zeroToTwo - 1.0;
      gl_Position = vec4(clipSpace * vec2(1, -1), 0, 1);
      v_texCoord = a_texCoord;
    }
  `);r(this,"highQualityFragmentShaderSource",`
    precision mediump float;
    uniform sampler2D u_texture;
    uniform vec2 u_resolution;
    uniform vec2 u_direction;
    uniform float u_radius;
    varying vec2 v_texCoord;
    
    void main() {
      vec2 texelSize = u_direction / u_resolution;
      vec4 color = vec4(0.0);
      float totalWeight = 0.0;
      
      // High quality blur with original 49 samples
      float sigma = u_radius * 0.4;
      float twoSigmaSquare = 2.0 * sigma * sigma;
      
      for (float i = -24.0; i <= 24.0; i++) {
        if (abs(i) > u_radius) continue;
        
        vec2 offset = texelSize * i;
        float weight = exp(-i * i / twoSigmaSquare);
        
        color += texture2D(u_texture, v_texCoord + offset) * weight;
        totalWeight += weight;
      }
      
      gl_FragColor = color / totalWeight;
    }
  `);r(this,"performanceFragmentShaderSource",`
    precision mediump float;
    uniform sampler2D u_texture;
    uniform vec2 u_resolution;
    uniform vec2 u_direction;
    uniform float u_radius;
    varying vec2 v_texCoord;
    
    void main() {
      vec2 texelSize = u_direction / u_resolution;
      vec4 color = vec4(0.0);
      float totalWeight = 0.0;
      
      // Performance blur with 13 samples
      float sigma = u_radius * 0.9;
      float twoSigmaSquare = 2.0 * sigma * sigma;
      
      for (float i = -12.0; i <= 12.0; i++) {
        if (abs(i) > u_radius) continue;
        
        vec2 offset = texelSize * i;
        float weight = exp(-i * i / twoSigmaSquare);
        
        color += texture2D(u_texture, v_texCoord + offset) * weight;
        totalWeight += weight;
      }
      
      gl_FragColor = color / totalWeight;
    }
  `);if(this.canvas=document.createElement("canvas"),this.canvas.width=x.WIDTH,this.canvas.height=x.HEIGHT,this.downsampleCanvas=document.createElement("canvas"),this.downsampleCtx=this.downsampleCanvas.getContext("2d"),!this.downsampleCtx)throw new Error("Failed to initialize downsample canvas context.");const e=this.canvas.getContext("webgl",{antialias:!1,depth:!1,stencil:!1,alpha:!0,premultipliedAlpha:!1,preserveDrawingBuffer:!1,powerPreference:"high-performance"}),t=this.canvas.getContext("experimental-webgl",{antialias:!1,depth:!1,stencil:!1,alpha:!0,premultipliedAlpha:!1,preserveDrawingBuffer:!1,powerPreference:"high-performance"});if(this.gl=e||t,!this.gl)throw new Error("WebGL not supported");this.gl.disable(this.gl.DEPTH_TEST),this.gl.disable(this.gl.CULL_FACE),this.gl.disable(this.gl.BLEND),this.initShaders(),this.initBuffers(),this.initTextures()}static getInstance(){return Mi.instance||(Mi.instance=new Mi),Mi.instance}initShaders(){const e=this.createShader(this.gl.VERTEX_SHADER,this.vertexShaderSource),t=this.createShader(this.gl.FRAGMENT_SHADER,this.highQualityFragmentShaderSource);if(this.highQualityShaderProgram=this.gl.createProgram(),this.gl.attachShader(this.highQualityShaderProgram,e),this.gl.attachShader(this.highQualityShaderProgram,t),this.gl.linkProgram(this.highQualityShaderProgram),!this.gl.getProgramParameter(this.highQualityShaderProgram,this.gl.LINK_STATUS))throw new Error("Unable to initialize high quality shader program: "+this.gl.getProgramInfoLog(this.highQualityShaderProgram));const i=this.createShader(this.gl.FRAGMENT_SHADER,this.performanceFragmentShaderSource);if(this.performanceShaderProgram=this.gl.createProgram(),this.gl.attachShader(this.performanceShaderProgram,e),this.gl.attachShader(this.performanceShaderProgram,i),this.gl.linkProgram(this.performanceShaderProgram),!this.gl.getProgramParameter(this.performanceShaderProgram,this.gl.LINK_STATUS))throw new Error("Unable to initialize performance shader program: "+this.gl.getProgramInfoLog(this.performanceShaderProgram));this.currentShaderProgram=this.highQualityShaderProgram,this.updateShaderProgram()}updateShaderProgram(){const t=x.HIGH_QUALITY_BLUR?this.highQualityShaderProgram:this.performanceShaderProgram;this.currentShaderProgram!==t&&(this.currentShaderProgram=t,this.gl.useProgram(this.currentShaderProgram),this.positionLocation=this.gl.getAttribLocation(this.currentShaderProgram,"a_position"),this.texCoordLocation=this.gl.getAttribLocation(this.currentShaderProgram,"a_texCoord"),this.resolutionLocation=this.gl.getUniformLocation(this.currentShaderProgram,"u_resolution"),this.textureLocation=this.gl.getUniformLocation(this.currentShaderProgram,"u_texture"),this.directionLocation=this.gl.getUniformLocation(this.currentShaderProgram,"u_direction"),this.radiusLocation=this.gl.getUniformLocation(this.currentShaderProgram,"u_radius"),this.gl.uniform1i(this.textureLocation,0))}createShader(e,t){const i=this.gl.createShader(e);if(this.gl.shaderSource(i,t),this.gl.compileShader(i),!this.gl.getShaderParameter(i,this.gl.COMPILE_STATUS)){const s=this.gl.getShaderInfoLog(i);throw this.gl.deleteShader(i),new Error("Unable to compile shader: "+s)}return i}initBuffers(){this.positionBuffer=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.positionBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array([0,0,x.WIDTH,0,0,x.HEIGHT,0,x.HEIGHT,x.WIDTH,0,x.WIDTH,x.HEIGHT]),this.gl.STATIC_DRAW),this.texCoordBuffer=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.texCoordBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]),this.gl.STATIC_DRAW)}initTextures(){this.texture=this.gl.createTexture(),this.gl.bindTexture(this.gl.TEXTURE_2D,this.texture),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR),this.tempTexture=this.gl.createTexture(),this.gl.bindTexture(this.gl.TEXTURE_2D,this.tempTexture),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR),this.framebuffer=this.gl.createFramebuffer(),this.tempFramebuffer=this.gl.createFramebuffer()}updateTexture(e,t,i,s,a,n=null){return this.gl.bindTexture(this.gl.TEXTURE_2D,e),s!==t||a!==i?(n?this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,n):this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,t,i,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,null),{width:t,height:i}):n?(this.gl.texSubImage2D(this.gl.TEXTURE_2D,0,0,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,n),{width:s,height:a}):{width:s,height:a}}getCachedCanvas(e,t){const i=`${e}x${t}`;let s=this.resultCanvasCache.get(i);if(!s){if(s=document.createElement("canvas"),s.width=e,s.height=t,this.resultCanvasCache.size>=this.maxCacheSize){const a=this.resultCanvasCache.keys().next().value;this.resultCanvasCache.delete(a)}this.resultCanvasCache.set(i,s)}return s}applyBlur(e,t){const i=e.width,s=e.height,a=x.BLUR_DOWNSAMPLE_FACTOR,n=Math.max(1,Math.floor(i/a)),c=Math.max(1,Math.floor(s/a));(this.downsampleCanvas.width!==n||this.downsampleCanvas.height!==c)&&(this.downsampleCanvas.width=n,this.downsampleCanvas.height=c),this.downsampleCtx.clearRect(0,0,n,c),this.downsampleCtx.drawImage(e,0,0,i,s,0,0,n,c);const l=this.applyBlurToCanvas(this.downsampleCanvas,t/a,n,c),d=this.getCachedCanvas(i,s),u=d.getContext("2d");return u.clearRect(0,0,i,s),u.imageSmoothingEnabled=!0,u.imageSmoothingQuality="high",u.drawImage(l,0,0,n,c,0,0,i,s),d}applyBlurToCanvas(e,t,i,s){const a=t*1,n=x.HIGH_QUALITY_BLUR?this.highQualityShaderProgram:this.performanceShaderProgram;this.currentShaderProgram!==n&&this.updateShaderProgram(),(this.canvas.width!==i||this.canvas.height!==s)&&(this.canvas.width=i,this.canvas.height=s,this.gl.viewport(0,0,i,s),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.positionBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array([0,0,i,0,0,s,0,s,i,0,i,s]),this.gl.STATIC_DRAW));const c=this.updateTexture(this.texture,i,s,this.textureWidth,this.textureHeight,e);this.textureWidth=c.width,this.textureHeight=c.height;const l=this.updateTexture(this.tempTexture,i,s,this.tempTextureWidth,this.tempTextureHeight,null);return this.tempTextureWidth=l.width,this.tempTextureHeight=l.height,this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.positionBuffer),this.gl.enableVertexAttribArray(this.positionLocation),this.gl.vertexAttribPointer(this.positionLocation,2,this.gl.FLOAT,!1,0,0),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.texCoordBuffer),this.gl.enableVertexAttribArray(this.texCoordLocation),this.gl.vertexAttribPointer(this.texCoordLocation,2,this.gl.FLOAT,!1,0,0),this.gl.uniform2f(this.resolutionLocation,i,s),this.gl.uniform1f(this.radiusLocation,a),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this.tempFramebuffer),this.gl.framebufferTexture2D(this.gl.FRAMEBUFFER,this.gl.COLOR_ATTACHMENT0,this.gl.TEXTURE_2D,this.tempTexture,0),this.gl.bindTexture(this.gl.TEXTURE_2D,this.texture),this.gl.uniform2f(this.directionLocation,1,0),this.gl.drawArrays(this.gl.TRIANGLES,0,6),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this.framebuffer),this.gl.framebufferTexture2D(this.gl.FRAMEBUFFER,this.gl.COLOR_ATTACHMENT0,this.gl.TEXTURE_2D,this.texture,0),this.gl.bindTexture(this.gl.TEXTURE_2D,this.tempTexture),this.gl.uniform2f(this.directionLocation,0,1),this.gl.drawArrays(this.gl.TRIANGLES,0,6),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null),this.gl.bindTexture(this.gl.TEXTURE_2D,this.texture),this.gl.drawArrays(this.gl.TRIANGLES,0,6),this.canvas}clearCache(){this.resultCanvasCache.clear()}dispose(){this.clearCache(),this.gl&&(this.gl.deleteProgram(this.highQualityShaderProgram),this.gl.deleteProgram(this.performanceShaderProgram),this.gl.deleteBuffer(this.positionBuffer),this.gl.deleteBuffer(this.texCoordBuffer),this.gl.deleteTexture(this.texture),this.gl.deleteTexture(this.tempTexture),this.gl.deleteFramebuffer(this.framebuffer),this.gl.deleteFramebuffer(this.tempFramebuffer))}};r(Mi,"instance");let Ki=Mi;class da extends dt{constructor(t,i,s){super(t,i,s);r(this,"onUse",t=>{t.health<t.maxHealth&&(t.health=Math.min(t.maxHealth,t.health+1),H.playEat(),this.stackCount>1?this.stackCount--:t.inventory.removeItem(this),t.game.pushMessage("You eat the apple and feel better."))});r(this,"getDescription",()=>`APPLE
Appears nutritious.`);this.tileX=6,this.tileY=2,this.stackable=!0}}r(da,"itemName","apple");class fa extends mt{constructor(t,i,s,a){super(t,i,s,a);r(this,"uniqueKillBehavior",()=>{this.cloned||H.playWood()});r(this,"draw",t=>{this.tileX=this.health===2?14:16,this.cloned===!0&&(this.tileX=16),!this.dead&&(m.ctx.save(),m.ctx.globalAlpha=this.alpha,this.dead||(this.hasShadow&&this.drawShadow(t),this.updateDrawXY(t),m.drawObj(this.tileX,this.tileY,2,3,this.x-this.drawX-.5,this.y-this.drawYOffset-this.drawY-1,2,3,this.room.shadeColor,this.shadeAmount())),m.ctx.restore())});r(this,"drawTopLayer",t=>{this.drawableY=this.y});this.room=t,this.health=2,this.maxHealth=2,this.tileX=14,this.tileY=6,this.hasShadow=!0,this.chainPushable=!1,this.name="tree",this.imageParticleX=0,this.imageParticleY=28,this.opaque=!0,this.hitSound=H.playBush,O.rand()<.5&&this.drops.push(new da(this.room,this.x,this.y))}get type(){return gt.PROP}}class gi extends it{constructor(t,i,s,a,n){super(t,i,s,a);r(this,"ticks");r(this,"frame");r(this,"seenPlayer");r(this,"aggro");r(this,"targetPlayer");r(this,"drop");r(this,"animateY",0);r(this,"softAnimateY",0);r(this,"hit",()=>1);r(this,"applyShield",()=>{});r(this,"applyBuff",()=>{});r(this,"tryMove",(t,i,s=!0)=>{const a=c=>!(c.x>=t+this.w||c.x+c.w<=t||c.y>=i+this.h||c.y+c.h<=i);for(const c of this.room.entities)if(c!==this&&a(c)&&s)return;const n=[];for(let c=0;c<this.w;c++)for(let l=0;l<this.h;l++){const d=this.room.roomArray[t+c][i+l];if(d&&!d.isSolid()&&!(d instanceof ot)&&!(d instanceof wt))n.push(d);else return}for(let c of n)c.onCollideEnemy(this);this.x=t,this.y=i});r(this,"tryCrush",()=>{let t=!1;for(const i in this.game.players){const s=this.game.players[i];this.game.rooms[s.levelID]===this.room&&s.x===this.x&&s.y===this.y&&(s.hurt(this.hit(),this.name,400),this.drawX+=.5*(this.x-s.x),this.drawY+=.5*(this.y-s.y),this.game.players[this.game.localPlayerID],t=!0)}return t});r(this,"behavior",()=>{if(this.lastX=this.x,this.lastY=this.y,!this.dead){if(this.skipNextTurns>0){this.skipNextTurns--;return}if(!this.seenPlayer)this.lookForPlayer();else if(this.seenPlayer){if(this.room.playerTicked===this.targetPlayer)if(this.alertTicks=Math.max(0,this.alertTicks-1),this.ticks++,this.ticks%2===1){this.rumbling=!0;let i=this.x,s=this.y,a=Array();for(const l of this.room.entities)l!==this&&a.push({x:l.x,y:l.y});for(let l=this.x-1;l<=this.x+1;l++)for(let d=this.y-1;d<=this.y+1;d++)this.room.roomArray[l][d]instanceof rt&&this.room.roomArray[l][d].on&&a.push({x:l,y:d});let n=[];for(let l=0;l<this.room.roomX+this.room.width;l++){n[l]=[];for(let d=0;d<this.room.roomY+this.room.height;d++)this.room.roomArray[l]&&this.room.roomArray[l][d]?n[l][d]=this.room.roomArray[l][d]:n[l][d]=!1}this.target=this.getAverageLuminance()>0?this.targetPlayer:this.room.getExtremeLuminanceFromPoint(this.x,this.y).darkest;let c=yt.AStar.search(n,this,this.target,a,void 0,void 0,void 0,void 0,void 0,void 0,this.lastPlayerPos);c.length>0?(this.tryMove(c[0].pos.x,c[0].pos.y),this.setDrawXY(i,s),this.x>i?this.direction=E.RIGHT:this.x<i?this.direction=E.LEFT:this.y>s?this.direction=E.DOWN:this.y<s&&(this.direction=E.UP),this.tryCrush(),this.animateCrush(),this.animateCrush()):(this.tryCrush(),this.animateCrush()),this.makeHitWarning(),this.rumbling=!1}else this.rumbling=!0,this.makeHitWarnings(),this.makeHitWarning();let t=Object.values(this.game.offlinePlayers).indexOf(this.targetPlayer)!==-1;if(!this.aggro||t){let i=this.nearestPlayer();if(i!==!1){let[s,a]=i;s<=4&&(t||s<this.playerDistance(this.targetPlayer))&&a!==this.targetPlayer&&(this.targetPlayer=a,this.facePlayer(a),a===this.game.players[this.game.localPlayerID]&&(this.alertTicks=1),this.ticks%2)}}}this.makeHitWarning()}});r(this,"makeHitWarning",()=>{this.room.hitwarnings.push(new Ht(this.room.game,this.x,this.y,this.x-1,this.y-1,!1,!1))});r(this,"animateCrush",()=>{this.animateY=-1,setTimeout(()=>{this.animateY=3,H.playCrush(),setTimeout(()=>{this.game.shakeScreen(2*this.x,2*this.y,!0)},100),setTimeout(()=>{this.animateY=0},500)},150)});r(this,"updateAnimateY",t=>{const i=this.animateY-this.softAnimateY;i>.001?this.softAnimateY=this.softAnimateY+i*.2*t:i<-.001?this.softAnimateY=this.softAnimateY+i*.2*t:this.softAnimateY=this.animateY,this.softAnimateY>1.25&&(this.softAnimateY=1.25)});r(this,"draw",t=>{if(this.drawableY=this.y+.1,!this.dead){if(m.ctx.save(),m.ctx.globalAlpha=this.alpha,!this.dead){this.updateDrawXY(t),this.updateAnimateY(t);let i=this.rumble(this.rumbling,this.frame,this.direction).x,s=this.rumble(this.rumbling,this.frame,this.direction).y;this.frame+=.1*t,this.frame>=4&&(this.frame=0),this.hasShadow&&this.drawShadow(t),m.drawObj(this.tileX,this.tileY,2,2,this.x-this.drawX+i-.5,this.y-this.drawYOffset-this.drawY+s+this.softAnimateY,2*this.crushX,2*this.crushY,this.softShadeColor,this.shadeAmount()),this.crushed&&this.crushAnim(t)}m.ctx.restore()}});this.ticks=0,this.frame=0,this.health=1,this.maxHealth=1,this.defaultMaxHealth=1,this.tileX=3,this.tileY=4,this.seenPlayer=!1,this.aggro=!1,this.name="crusher",this.orthogonalAttack=!0,this.imageParticleX=3,this.imageParticleY=24,this.drawYOffset=2.5,this.shouldDrawAbovePlayer=!0,this.collidable=!1,this.destroyable=!1,this.getDrop(["weapon","equipment","consumable","tool","coin"])}get alertText(){return`New Enemy Spotted: Crab 
    Health: ${this.health}
    Attack Pattern: Omnidirectional
    Moves every other turn`}}r(gi,"difficulty",1),r(gi,"tileX",8),r(gi,"tileY",4);class Yi extends it{constructor(t,i,s,a,n){super(t,i,s,a);r(this,"frame");r(this,"ticks");r(this,"seenPlayer");r(this,"aggro");r(this,"targetPlayer");r(this,"drop");r(this,"dir");r(this,"crusherPositions",[]);r(this,"crusherCount",0);r(this,"crushers",[]);r(this,"hit",()=>this.damage);r(this,"createCrusherBlocks",t=>{for(const i of t){const s=new gi(this.room,this.game,i.x,i.y);this.room.entities.push(s),this.crusherCount++,this.crushers.push(s)}});r(this,"createCrusherChains",()=>{for(const t of this.crushers){let i=new de(t.x,t.y,this.x,this.y,t);i.compositeOperation="source-over",i.color="#800000",i.turbulence=.4,i.gravity=.5,i.iterations=1,i.segments=100,i.angleChange=.001,i.springDamping=.01,i.drawableY=this.drawableY-.1,this.room.projectiles.push(i)}});r(this,"getCrusherPositions",()=>[{x:this.x-1,y:this.y},{x:this.x+1,y:this.y}]);r(this,"setCrusherDrawableY",()=>{for(const t of this.crushers)this.y>t.y?this.drawableY=this.drawableY-.1:t.drawableY=this.drawableY-.1});r(this,"initializeCrushers",()=>{this.crusherPositions.length===0&&(this.crusherPositions=this.getCrusherPositions()),this.crusherPositions.length>this.crusherCount&&(this.createCrusherBlocks(this.crusherPositions),this.createCrusherChains())});r(this,"removeCrusherChains",()=>{for(let t of this.room.projectiles)t instanceof de&&t.parent instanceof gi&&this.crushers.includes(t.parent)&&t.parent.dead&&(this.room.projectiles=this.room.projectiles.filter(i=>i!==t))});r(this,"uniqueKillBehavior",()=>{this.removeCrusherChains();for(const t of this.crushers)t.dead||t.kill();this.removeLightSource(this.lightSource)});r(this,"updateCrusherChains",t=>{for(let i of this.room.projectiles)if(i instanceof de){if(i.parent!==this.crushers[0]&&i.parent!==this.crushers[1])continue;switch(i.setTarget(this.x-this.drawX,this.y-this.drawY-.5,i.parent.x-i.parent.drawX,i.parent.y-i.parent.drawY-1.25+i.parent.softAnimateY),i.drawableY=this.drawableY-.1,Math.floor(this.frame)){case 0:i.color="#800000";break;case 1:i.color="#ff0000";break;case 2:i.color="#ff0000";break;case 3:i.color="#800000";break}}});r(this,"behavior",()=>{if(this.initializeCrushers(),this.lastX=this.x,this.lastY=this.y,!this.dead){if(this.skipNextTurns>0){this.skipNextTurns--;return}if(!this.seenPlayer)this.lookForPlayer();else if(this.seenPlayer){if(this.room.playerTicked===this.targetPlayer)if(this.alertTicks=Math.max(0,this.alertTicks-1),this.ticks++,this.ticks%2===1){this.rumbling=!0;let i=this.x,s=this.y,a=Array();for(const l of this.room.entities)l!==this&&a.push({x:l.x,y:l.y});for(let l=this.x-1;l<=this.x+1;l++)for(let d=this.y-1;d<=this.y+1;d++)this.room.roomArray[l][d]instanceof rt&&this.room.roomArray[l][d].on&&a.push({x:l,y:d});let n=[];for(let l=0;l<this.room.roomX+this.room.width;l++){n[l]=[];for(let d=0;d<this.room.roomY+this.room.height;d++)this.room.roomArray[l]&&this.room.roomArray[l][d]?n[l][d]=this.room.roomArray[l][d]:n[l][d]=!1}this.target=this.getAverageLuminance()>0?this.targetPlayer:this.room.getExtremeLuminanceFromPoint(this.x,this.y).darkest;let c=yt.AStar.search(n,this,this.target,a,void 0,void 0,void 0,void 0,void 0,void 0,this.lastPlayerPos);if(c.length>0){let l=!1;for(const d in this.game.players)this.game.rooms[this.game.players[d].levelID]===this.room&&this.game.players[d].x===c[0].pos.x&&this.game.players[d].y===c[0].pos.y&&(this.game.players[d].hurt(this.hit(),this.name),this.drawX=.5*(this.x-this.game.players[d].x),this.drawY=.5*(this.y-this.game.players[d].y),this.game.players[d]===this.game.players[this.game.localPlayerID]&&this.game.shakeScreen(10*this.drawX,10*this.drawY),l=!0);l||(this.tryMove(c[0].pos.x,c[0].pos.y),this.setDrawXY(i,s),this.x>i?this.direction=E.RIGHT:this.x<i?this.direction=E.LEFT:this.y>s?this.direction=E.DOWN:this.y<s&&(this.direction=E.UP))}this.rumbling=!1}else this.rumbling=!0,this.makeHitWarnings();let t=Object.values(this.game.offlinePlayers).indexOf(this.targetPlayer)!==-1;if(!this.aggro||t){let i=this.nearestPlayer();if(i!==!1){let[s,a]=i;s<=4&&(t||s<this.playerDistance(this.targetPlayer))&&a!==this.targetPlayer&&(this.targetPlayer=a,this.facePlayer(a),a===this.game.players[this.game.localPlayerID]&&(this.alertTicks=1),this.ticks%2===0&&this.makeHitWarnings())}}}this.lightSource&&this.lightSource.updatePosition(this.x+.5,this.y+.5)}this.removeCrusherChains()});r(this,"drawTopLayer",t=>{this.drawableY=this.y,this.healthBar.draw(t,this.health,this.maxHealth,this.x,this.y,!0)});r(this,"draw",t=>{this.dead||(m.ctx.globalAlpha=this.alpha,this.updateDrawXY(t),this.setCrusherDrawableY(),this.updateCrusherChains(t),this.frame+=.1*t,this.frame>=4&&(this.frame=0),this.hasShadow&&this.drawShadow(t),m.drawMob(this.tileX+2*Math.floor(this.frame),this.tileY,2,2,this.x-this.drawX-.5,this.y-this.drawYOffset-this.drawY-this.jumpY,2,2,this.softShadeColor,this.shadeAmount()),this.cloned||(this.seenPlayer||this.drawSleepingZs(t),this.alertTicks>0&&this.drawExclamation(t)),m.ctx.globalAlpha=1)});this.w=1,this.h=1,this.ticks=0,this.frame=0,this.health=6,this.maxHealth=6,this.defaultMaxHealth=6,this.tileX=43,this.tileY=10,this.seenPlayer=!1,this.aggro=!1,this.dir=E.DOWN,this.name="warden",this.chainPushable=!1,this.forwardOnlyAttack=!1,this.drawMoveSpeed=.9,this.jumpHeight=.35,this.drawYOffset=1.5,this.alertRange=10,this.orthogonalAttack=!0,this.crusherPositions=[],this.crusherCount=0,this.crushers=[],this.baseDamage=2,this.lightSource=new Vt(this.x+.5,this.y+.5,10,[255,10,10],1.5),this.addLightSource(this.lightSource),this.hasBloom=!0,this.bloomColor="#ff0a0a",this.bloomAlpha=1,this.room.updateLighting(),n&&(this.drop=n);const c=Math.floor(O.rand()*3)+2;for(;this.drops.length<c&&!this.cloned;)this.getDrop()}}r(Yi,"difficulty",2),r(Yi,"tileX",21),r(Yi,"tileY",0);class Ye extends it{constructor(t,i,s,a,n){super(t,i,s,a);r(this,"ticks");r(this,"frame");r(this,"seenPlayer");r(this,"aggro");r(this,"targetPlayer");r(this,"drop");r(this,"frameLength");r(this,"startFrame");r(this,"animationSpeed");r(this,"tickCount");r(this,"rumbling");r(this,"jumping");r(this,"jumpDistance");r(this,"halfJumped");r(this,"hit",()=>this.damage);r(this,"behavior",()=>{if(this.lastX=this.x,this.lastY=this.y,!this.cloned&&(this.tileX=37,this.frameLength=3,this.animationSpeed=.1,!this.dead)){if(this.skipNextTurns>0){this.skipNextTurns--;return}if(!this.seenPlayer)this.tileX=37,this.lookForPlayer();else if(this.seenPlayer){if(this.tileX=37,this.room.playerTicked===this.targetPlayer)if(this.alertTicks=Math.max(0,this.alertTicks-1),this.ticks++,this.ticks%2===1){this.rumbling=!0;let i=this.x,s=this.y,a=Array();for(const k of this.room.entities)if(k!==this&&!k.destroyable)for(let D=0;D<(k.w||1);D++)for(let N=0;N<(k.h||1);N++)a.push({x:k.x+D,y:k.y+N});for(let k=this.x-1;k<=this.x+this.w;k++)for(let D=this.y-1;D<=this.y+this.h;D++)this.room.roomArray[k]&&this.room.roomArray[k][D]&&this.room.roomArray[k][D]instanceof rt&&this.room.roomArray[k][D].on&&a.push({x:k,y:D});let n={x:this.targetPlayer.x,y:this.targetPlayer.y};const c=this.targetPlayer.x,l=this.targetPlayer.y,d=l>=this.y&&l<this.y+this.h,u=c>=this.x&&c<this.x+this.w,h=d&&c===this.x+this.w,f=d&&c===this.x-1,p=u&&l===this.y+this.h,y=u&&l===this.y-1;let g=!1,w=!1;const b=(k,D,N,U)=>{for(let Z=0;Z<N;Z++)for(let j=0;j<U;j++){const V=k+Z,J=D+j;if(!this.room.roomArray[V]||!this.room.roomArray[V][J])return!1;const z=this.room.roomArray[V][J];if(z.isSolid()||z.isDoor||z instanceof wt)return!1;for(const tt of this.room.entities)if(tt!==this&&!tt.destroyable&&!(tt.x>=k+N||tt.x+(tt.w||1)<=k||tt.y>=D+U||tt.y+(tt.h||1)<=D))return!1}return!0};if(h){g=!0;const k=c+1,D=this.y;if(b(k,D,this.w,this.h)){this.tryMove(k,D),this.setDrawXY(i,s),this.jumping&&(this.frame=8,this.animationSpeed=1),this.x>i?this.direction=E.RIGHT:this.x<i?this.direction=E.LEFT:this.y>s?this.direction=E.DOWN:this.y<s&&(this.direction=E.UP),this.rumbling=!1,w=!0;return}}else if(f){g=!0;const k=c-this.w,D=this.y;if(b(k,D,this.w,this.h)){this.tryMove(k,D),this.setDrawXY(i,s),this.jumping&&(this.frame=8,this.animationSpeed=1),this.x>i?this.direction=E.RIGHT:this.x<i?this.direction=E.LEFT:this.y>s?this.direction=E.DOWN:this.y<s&&(this.direction=E.UP),this.rumbling=!1,w=!0;return}}else if(p){g=!0;const k=this.x,D=l+1;if(b(k,D,this.w,this.h)){this.tryMove(k,D),this.setDrawXY(i,s),this.jumping&&(this.frame=8,this.animationSpeed=1),this.x>i?this.direction=E.RIGHT:this.x<i?this.direction=E.LEFT:this.y>s?this.direction=E.DOWN:this.y<s&&(this.direction=E.UP),this.rumbling=!1,w=!0;return}}else if(y){g=!0;const k=this.x,D=l-this.h;if(b(k,D,this.w,this.h)){this.tryMove(k,D),this.setDrawXY(i,s),this.jumping&&(this.frame=8,this.animationSpeed=1),this.x>i?this.direction=E.RIGHT:this.x<i?this.direction=E.LEFT:this.y>s?this.direction=E.DOWN:this.y<s&&(this.direction=E.UP),this.rumbling=!1,w=!0;return}}if(g&&!w){this.rumbling=!1;return}let T=[];for(let k=0;k<this.room.roomX+this.room.width;k++){T[k]=[];for(let D=0;D<this.room.roomY+this.room.height;D++)this.room.roomArray[k]&&this.room.roomArray[k][D]?T[k][D]=this.room.roomArray[k][D]:T[k][D]=!1}let v=yt.AStar.search(T,this,n,a,!1,!1,!1,void 0,void 0,!1,this.lastPlayerPos);if(console.log(v),v[1]){const k=(N,U,Z)=>N.x>=U&&N.x<U+this.w&&N.y>=Z&&N.y<Z+this.h;let D=!1;for(const N in this.game.players)if(this.game.rooms[this.game.players[N].levelID]===this.room&&k(this.game.players[N],v[1].pos.x,v[1].pos.y)){const U=this.closestTile(this.game.players[N]);this.game.players[N].hurt(this.hit(),this.name),this.drawX+=1.5*(U.x-this.game.players[N].x),this.drawY+=1.5*(U.y-this.game.players[N].y),this.game.players[N]===this.game.players[this.game.localPlayerID]&&this.game.shakeScreen(5*this.drawX,5*this.drawY),D=!0}if(!D&&v.length>1){let N=v[1].pos.x,U=v[1].pos.y;this.tryMove(N,U),this.setDrawXY(i,s),this.jumping&&(this.frame=8,this.animationSpeed=1),this.x>N?this.direction=E.RIGHT:this.x<N?this.direction=E.LEFT:this.y>U?this.direction=E.DOWN:this.y<U&&(this.direction=E.UP)}}this.rumbling=!1}else this.makeBigHitWarnings(),this.rumbling=!0,this.tileX=43,this.frame=0,this.frameLength=2,this.animationSpeed=.2;let t=Object.values(this.game.offlinePlayers).indexOf(this.targetPlayer)!==-1;if(!this.aggro||t){let i=this.nearestPlayer();if(i!==!1){let[s,a]=i;s<=4&&(t||s<this.playerDistance(this.targetPlayer))&&a!==this.targetPlayer&&(this.targetPlayer=a,this.facePlayer(a),a===this.game.players[this.game.localPlayerID]&&(this.alertTicks=1),this.ticks%2===0&&this.makeBigHitWarnings())}}}}});r(this,"jump",t=>{if(this.jumping&&!this.cloned){let i=Math.max(Math.abs(this.drawX),Math.abs(this.drawY));i>=1&&(this.jumpDistance=2),this.jumpY=Math.sin(i/(this.jumpDistance+1)*Math.PI)*this.jumpHeight,this.jumpY<.01&&this.jumpY>-.01&&(this.jumpY=0,this.jumpDistance=1),this.jumpY>this.jumpHeight&&(this.jumpY=this.jumpHeight)}});r(this,"bigEnemyShake",()=>{(this.w>1||this.h>1)&&setTimeout(()=>{this.game.shakeScreen(0*this.drawX,5)},500)});r(this,"makeHitWarnings",()=>{const i=this.getPlayer(),s=this.orthogonalAttack,a=this.diagonalAttack,n=this.forwardOnlyAttack,c=this.direction,l=this.attackRange,d=this.diagonalAttackRange,u=(w,b)=>(w?[[-2,0],[2,0],[0,-2],[0,2]]:[[-1,-1],[1,1],[1,-1],[-1,1]]).flatMap(([v,k])=>Array.from({length:b},(D,N)=>[(N+1)*v,(N+1)*k])),h={[E.LEFT]:[-1,0],[E.RIGHT]:[1,0],[E.UP]:[0,-1],[E.DOWN]:[0,1]};let f=[];if(n){const[w,b]=h[c];f=Array.from({length:l},(T,v)=>[(v+1)*w,(v+1)*b])}else s&&f.push(...u(!0,l)),a&&f.push(...u(!1,d));const p=f.map(([w,b])=>({x:w,y:b,distance:Q.distance(w,b,i.x-this.x,i.y-this.y)})).sort((w,b)=>w.distance-b.distance),y=Math.ceil(p.length*(1-.25));p.slice(0,y).forEach(({x:w,y:b})=>{const T=[{x:this.x,y:this.y},{x:this.x+1,y:this.y},{x:this.x,y:this.y+1},{x:this.x+1,y:this.y+1}];for(const v of T){const k=v.x+w,D=v.y+b;if(this.isWithinRoomBounds(k,D)){const N=new Ht(this.game,k,D,v.x,v.y,!0,!1,this),U=N.getPointerDir(),Z=v.x-this.x,j=v.y-this.y;let V=[];Z===1&&j===1?V=[re.South,re.East,re.SouthEast]:Z===1&&j===0?V=[re.North,re.East,re.NorthEast]:Z===0&&j===1?V=[re.South,re.West,re.SouthWest]:V=[re.North,re.West,re.NorthWest],V.includes(U)&&this.room.hitwarnings.push(N)}}})});r(this,"drawTopLayer",t=>{this.drawableY=this.y,this.healthBar.draw(t,this.health,this.maxHealth,this.x+.5,this.y,!0)});r(this,"draw",t=>{if(!this.dead){if(m.ctx.save(),m.ctx.globalAlpha=this.alpha,!this.dead){this.updateDrawXY(t),this.frame+=this.animationSpeed*t,this.frame>=this.frameLength&&(this.frame=0);let i=this.rumble(this.rumbling,this.frame).x;this.rumble(this.rumbling,this.frame).y,this.drawX!==0||this.drawY!==0?this.jumping=!0:this.jumping=!1,this.jumping?(this.frame<4&&(this.frame=4),this.frameLength=11,this.animationSpeed=.2):(this.frameLength=3,this.animationSpeed=.1),this.hasShadow&&this.drawShadow(t),m.drawMob(this.tileX+(this.tileX!==59&&!this.rumbling&&!this.cloned?Math.floor(this.frame):0)*2,this.tileY,2,3,this.x+i-this.drawX,this.y-this.drawYOffset-this.drawY-this.jumpY,2,3,this.softShadeColor,this.shadeAmount())}this.cloned||(this.seenPlayer||this.drawSleepingZs(t,.5*x.TILESIZE),this.alertTicks>0&&this.drawExclamation(t,.5*x.TILESIZE)),m.ctx.restore()}});this.ticks=0,this.frame=0,this.health=4,this.maxHealth=4,this.defaultMaxHealth=4,this.tileX=37,this.tileY=24,this.seenPlayer=!1,this.aggro=!1,this.deathParticleColor="#ffffff",this.frameLength=3,this.startFrame=0,this.animationSpeed=.1,this.tickCount=0,this.jumping=!1,this.jumpDistance=1,this.drop=n||new ct(this.room,this.x,this.y),this.name="bigfrog",this.orthogonalAttack=!0,this.diagonalAttack=!0,this.jumpHeight=2,this.imageParticleX=3,this.imageParticleY=30,this.canDestroyOthers=!0,this.halfJumped=!1,this.canCrushOthers=!0,this.dropChance=1,this.h=2,this.w=2,this.getDrop(["frog"],!0)}}r(Ye,"difficulty",1),r(Ye,"tileX",37),r(Ye,"tileY",24);class wi extends it{constructor(t,i,s,a){super(t,i,s,a);r(this,"ticks");r(this,"seenPlayer");r(this,"buffedEnemies");r(this,"range");r(this,"lastHealth");r(this,"buffedBefore");r(this,"hit",()=>1);r(this,"uniqueKillBehavior",()=>{this.unbuffEnemies(),this.removeLightSource(this.lightSource),this.lightSource=null});r(this,"behavior",()=>{this.lastX=this.x,this.lastY=this.y;let t=this.enemyBuffCandidates();if(!this.dead){if(this.skipNextTurns>0){this.skipNextTurns--;return}this.ticks++,this.ticks%2===0&&(this.buffEnemies(t),this.updateBuffedEnemies(),this.runAway())}this.buffedEnemies.length>0?this.shadeColor="#306082":this.shadeColor="#000000",this.lightSource&&this.lightSource.updatePosition(this.x+.5,this.y+.5)});r(this,"onHurt",(t=1)=>{this.health<this.lastHealth&&this.health%2===0&&this.health>0&&this.teleport(),this.lastHealth=this.health});r(this,"updateBuffedEnemies",()=>{this.buffedEnemies.forEach(t=>{t.dead&&(this.buffedEnemies=this.buffedEnemies.filter(i=>i!==t))})});r(this,"buffEnemies",t=>{t.length>0&&t.forEach(i=>{const s=Q.distance(this.x,this.y,i.x,i.y);O.rand()*10>s&&this.applyBuffTo(i)})});r(this,"enemyBuffCandidates",()=>this.room.entities.filter(i=>i instanceof it&&Q.distance(this.x,this.y,i.x,i.y)<=this.range&&!i.buffed&&!i.dead&&i!==this&&!i.buffedBefore).slice(0,G.MAX_EXALTER_BUFFS));r(this,"unbuffEnemies",()=>{if(this.buffedEnemies.length>0){for(let t of this.buffedEnemies)t.cloned||t.removeBuff();this.buffedEnemies=[]}});r(this,"applyBuffTo",t=>{if(t.destroyable&&(this.shadeMultiplier=1.5,t.applyBuff(),this.buffedEnemies.push(t),t.buffed))for(let i=0;i<5;i++){let s=new de(t.x,t.y,this.x,this.y,t);s.compositeOperation="source-over",s.color="#00FFFF",s.turbulence=1,s.gravity=0,s.iterations=3,s.segments=30,s.angleChange=1,s.springDamping=.3,s.drawableY=t.drawableY,s.type="buff",this.room.projectiles.push(s)}});r(this,"updateBeam",t=>{for(let i of this.room.projectiles)if(i instanceof de){if(!this.buffedEnemies.includes(i.parent)||i.type!=="buff")continue;switch(i.setTarget(this.x-this.drawX,this.y-this.drawY,i.parent.x-i.parent.drawX,i.parent.y-i.parent.drawY),i.drawableY=i.parent.drawableY,Math.floor(this.frame)){case 0:i.color="#00FFFF";break;case 1:i.color="#00a1dc";break;case 2:i.color="#008ea7";break;case 3:i.color="#00a1dc";break}}});r(this,"draw",t=>{this.dead||(m.ctx.save(),m.ctx.globalAlpha=this.alpha,this.drawableY=this.y,this.dead||(this.updateDrawXY(t),this.updateBeam(t),this.frame+=.1*t,this.frame>=4&&(this.frame=0),this.hasShadow&&this.drawShadow(t),m.drawMob(this.tileX+Math.floor(this.frame),this.tileY,1,2,this.x-this.drawX,this.y-this.drawYOffset-this.drawY,1,2,this.softShadeColor,this.shadeAmount())),m.ctx.restore())});this.ticks=0,this.health=4,this.lastHealth=this.health,this.maxHealth=4,this.tileX=59,this.tileY=8,this.seenPlayer=!0,this.name="exalter",this.range=6,this.aggro=!1,this.frame=0,this.hasShadow=!0,this.buffedBefore=!1,this.buffedEnemies=[],this.shadeColor="#000000",this.lightSource=Xe.newLightSource(this.x+.5,this.y+.5,[1,20,30],3.5,20),this.addLightSource(this.lightSource),this.room.updateLighting(),this.hasBloom=!0,this.bloomColor="#00FFFF",this.bloomAlpha=.5,this.softBloomAlpha=0,this.dropChance=1,this.getDrop(["exalter"],!1),this.pushable=!1,this.chainPushable=!1}}r(wi,"tileX",59),r(wi,"tileY",8);const Vo={crab:Bt,frog:fe,zombie:te,skull:_t,energywizard:Mt,charge:Ft,rook:Gt,bishop:Pt,armoredzombie:Ct,bigskull:Nt,queen:Xt,knight:Lt,bigknight:Ut,firewizard:Jt,spawner:Ee,occultist:He,bomb:ui,armoredskull:Dt,mummy:be,spider:he,bigzombie:mi,glowbug:pi,tree:fa,tombstone:Re,warden:Yi,crusher:gi,pawn:Le,beetle:Li,bigfrog:Ye,exalter:wi};var R=(o=>(o.START="START",o.DUNGEON="DUNGEON",o.BOSS="BOSS",o.BIGDUNGEON="BIGDUNGEON",o.TREASURE="TREASURE",o.FOUNTAIN="FOUNTAIN",o.COFFIN="COFFIN",o.GRASS="GRASS",o.PUZZLE="PUZZLE",o.KEYROOM="KEYROOM",o.CHESSBOARD="CHESSBOARD",o.MAZE="MAZE",o.CORRIDOR="CORRIDOR",o.SPIKECORRIDOR="SPIKECORRIDOR",o.UPLADDER="UPLADDER",o.DOWNLADDER="DOWNLADDER",o.SHOP="SHOP",o.BIGCAVE="BIGCAVE",o.CAVE="CAVE",o.SPAWNER="SPAWNER",o.ROPEHOLE="ROPEHOLE",o.ROPECAVE="ROPECAVE",o.TUTORIAL="TUTORIAL",o.GRAVEYARD="GRAVEYARD",o.FOREST="FOREST",o.ROPEUP="ROPEUP",o))(R||{}),Ds=(o=>(o.NORTH="North",o.EAST="East",o.SOUTH="South",o.WEST="West",o.TOPLEFT="TopLeft",o.TOPRIGHT="TopRight",o.BOTTOMLEFT="BottomLeft",o.BOTTOMRIGHT="BottomRight",o))(Ds||{});class qh{constructor(e,t,i,s,a,n,c,l,d,u=O.rand,h){r(this,"globalId");r(this,"pathId");r(this,"roomArray");r(this,"softVis");r(this,"vis");r(this,"softCol");r(this,"col");r(this,"renderBuffer");r(this,"oldVis");r(this,"oldCol");r(this,"entities");r(this,"deadEntities");r(this,"items");r(this,"doors");r(this,"projectiles");r(this,"particles");r(this,"hitwarnings");r(this,"colorOffscreenCanvas");r(this,"colorOffscreenCtx");r(this,"shadeOffscreenCanvas");r(this,"shadeOffscreenCtx");r(this,"shadeBlurTempCanvas");r(this,"shadeBlurTempCtx");r(this,"shadeSliceTempCanvas");r(this,"shadeSliceTempCtx");r(this,"shadeSliceBorderTiles",1);r(this,"bloomOffscreenCanvas");r(this,"bloomOffscreenCtx");r(this,"currentSpawnerCount");r(this,"game");r(this,"roomX");r(this,"roomY");r(this,"width");r(this,"height");r(this,"type");r(this,"depth");r(this,"mapGroup");r(this,"name","");r(this,"message");r(this,"turn");r(this,"playerTurnTime");r(this,"playerTicked");r(this,"skin");r(this,"entered");r(this,"lightSources");r(this,"shadeColor","#000000");r(this,"innerWalls");r(this,"wallInfo",new Map);r(this,"savePoint");r(this,"lastEnemyCount");r(this,"outerWalls");r(this,"level");r(this,"id");r(this,"tunnelDoor",null);r(this,"active");r(this,"onScreen");r(this,"lastLightingUpdate");r(this,"walls");r(this,"decorations");r(this,"blurOffsetX",5);r(this,"blurOffsetY",5);r(this,"lastDraw",0);r(this,"drawTimestamp",0);r(this,"drawInterval",4);r(this,"builder");r(this,"envType");r(this,"beamEffects",[]);r(this,"maskCanvases",[]);r(this,"blurCache",{color6px:null,color12px:null,shade5px:null,bloom8px:null,color8px:null,isValid:!1,lastLightingUpdate:0});r(this,"isUpdatingLighting",!1);r(this,"estimatedLightingTiles",0);r(this,"removeWall",(e,t)=>{this.roomArray[e][t]instanceof et&&(this.roomArray[e][t]=null)});r(this,"addDoor",(e,t,i=this,s=!1)=>{let a,n=Ti.DOOR;return i.type==="BOSS"&&(n=Ti.GUARDEDDOOR),i.type==="KEYROOM"&&(n=Ti.LOCKEDDOOR),s&&(n=Ti.TUNNELDOOR),e===i.roomX?(a=new ot(i,i.game,e,t,E.RIGHT,n),i.roomArray[e+1][t]=new $t(i,e+1,t)):e===i.roomX+i.width-1?(a=new ot(i,i.game,e,t,E.LEFT,n),i.roomArray[e-1][t]=new $t(i,e-1,t)):t===i.roomY?(a=new ot(i,i.game,e,t,E.UP,n),i.roomArray[e][t+1]=new $t(i,e,t+1)):t===i.roomY+i.height-1&&(a=new ot(i,i.game,e,t,E.DOWN,n),i.roomArray[e][t-1]=new $t(i,e,t-1)),s&&(i.tunnelDoor=a),i.doors.push(a),i.roomArray[a.x]==null,i.roomArray[a.x][a.y]=a,a});r(this,"addNewEnemy",e=>{const t=Vo[e];if(!t){console.error(`Enemy type "${e}" is not recognized.`);return}const i=this.getEmptyTiles();if(!i||i.length===0)return;let s=this.getRandomEmptyPosition(i);if(!s)return;let{x:a,y:n}=s;if(e==="bigzombie"){if(s=this.getBigRandomEmptyPosition(i),!s)return;({x:a,y:n}=s)}t.add(this,this.game,a,n)});r(this,"addNewSpawner",e=>{if(!Vo[e])return;const i=this.getEmptyTiles();if(!i||i.length===0)return;const{x:s,y:a}=this.getRandomEmptyPosition(i);Ee.add(this,this.game,s,a)});r(this,"linkExitToStart",e=>{e||(e=this.level.startRoom),this.addDoorWithOffset(e.roomX+Math.floor(e.width/2)+1,e.roomY,e,!0)&&this.addDoorWithOffset(this.roomX+Math.floor(this.width/2)-1,this.roomY,this,!0)&&(this.tunnelDoor.startRoom=!0,this.tunnelDoor.linkedDoor=e.tunnelDoor,this.tunnelDoor.linkedDoor.linkedDoor=this.tunnelDoor)});r(this,"exitLevel",()=>{m.shade_canvases={},m.text_rendering_canvases={};for(let e of this.doors){if(!e||!e.linkedDoor)continue;const t=e.linkedDoor;t.lightSource&&t.room&&!t.room.active&&t.room.entered&&(t.lightSource.b=0,t.lightSource.r=0,t.room.updateLighting())}this.active=!1,this.updateLighting(),this.particles.splice(0,this.particles.length),this.disableFuseSounds()});r(this,"disableFuseSounds",()=>{for(const e of this.entities.filter(t=>t instanceof ui)){const t=e;H.stopSound(t.fuseSound)}});r(this,"enableFuseSounds",()=>{for(const e of this.entities.filter(t=>t instanceof ui)){const t=e;t.lit&&H.playWithReverb(t.fuseSound)}});r(this,"onEnterRoom",e=>{this.enableFuseSounds();for(let t of this.level.rooms)t.roomOnScreen(e);this.entered=!0,this.clearDeadStuff(),this.calculateWallInfo(),this.resetDoorLightSources(),this.particles=[],this.alertEnemiesOnEntry(),this.message=this.name,e.map.saveMapData(),this.setReverb(),this.active=!0,this.updateLighting()});r(this,"enterLevel",(e,t)=>{var c;this.game.updateLevel(this);let i=this.__entryPositionFromLadder;i&&delete this.__entryPositionFromLadder;let s=i||t||this.getRoomCenter();this.roomArray[s.x][s.y].isSolid()&&(s=this.getRandomEmptyPosition(this.getEmptyTiles()));let a=s.x,n=s.y;if(!t&&!i)for(let l=this.roomX;l<this.roomX+this.width;l++)for(let d=this.roomY;d<this.roomY+this.height;d++){const u=(c=this.roomArray[l])==null?void 0:c[d];u instanceof wt&&(a=u.x,n=u.y)}e.moveSnap(a,n),this.onEnterRoom(e)});r(this,"enterLevelThroughDoor",(e,t,i)=>{t.doorDir===t.linkedDoor.doorDir&&(t.opened=!0,e.moveSnap(t.x,t.y+1),setTimeout(()=>{e.direction=E.DOWN},150)),t instanceof ot&&t.doorDir===E.UP?(t.opened=!0,e.moveNoSmooth(t.x,t.y+1)):t instanceof ot&&t.doorDir===E.DOWN?e.moveNoSmooth(t.x,t.y-1):t instanceof ot&&[E.RIGHT,E.LEFT].includes(t.doorDir)&&e.moveNoSmooth(t.x+i,t.y),this.onEnterRoom(e)});r(this,"alertEnemiesOnEntry",()=>{for(const e of this.entities)e instanceof it&&e.lookForPlayer(!1)});r(this,"tick",e=>{this.updateLighting(),e.updateSlowMotion(),this.lastEnemyCount=this.entities.filter(t=>t instanceof it).length;for(const t of this.hitwarnings)t.tick();for(const t of this.projectiles)t.tick();this.clearDeadStuff(),this.calculateWallInfo(),this.entities=this.entities.filter(t=>!t.dead);for(let t=this.roomX;t<this.roomX+this.width;t++)for(let i=this.roomY;i<this.roomY+this.height;i++)this.roomArray[t][i].tick();this.turn=1,this.playerTurnTime=Date.now(),this.playerTicked=e,this.updateLighting(),e.map.saveMapData(),this.clearDeadStuff()});r(this,"computerTurn",()=>{var e,t;for(const i of this.entities)i.tick();this.entities=this.entities.filter(i=>!i.dead);for(const i of this.items)i.tick();for(const i in this.game.players)for(const s of this.game.players[i].inventory.items)s&&s.tick();for(const i of this.hitwarnings)(!this.roomArray[i.x]||!this.roomArray[i.x][i.y]||this.roomArray[i.x][i.y].isSolid())&&(i.dead=!0),i.removeOverlapping();for(const i of this.projectiles){this.roomArray[i.x]&&this.roomArray[i.x][i.y]&&this.roomArray[i.x][i.y].isSolid()&&(i.dead=!0);for(const s in this.game.players)((t=(e=this.game.players[s]).getRoom)==null?void 0:t.call(e))===this&&i.x===this.game.players[s].x&&i.y===this.game.players[s].y&&i.hitPlayer(this.game.players[s]);for(const s of this.entities)i.x===s.x&&i.y===s.y&&i.hitEnemy(s)}for(let i=this.roomX;i<this.roomX+this.width;i++)for(let s=this.roomY;s<this.roomY+this.height;s++)this.roomArray[i][s].tickEnd();this.entities=this.entities.filter(i=>!i.dead),this.clearDeadStuff(),this.playerTicked.finishTick(),this.checkForNoEnemies(),this.turn=0,this.updateLighting()});r(this,"update",()=>{var e,t;if(this.turn==1){const i=(t=(e=this.game.replayManager)==null?void 0:e.isReplaying)!=null&&t.call(e)?x.REPLAY_COMPUTER_TURN_DELAY:q.COMPUTER_TURN_DELAY;Date.now()-this.playerTurnTime>=i&&this.computerTurn()}});r(this,"clearDeadStuff",()=>{this.deadEntities=this.deadEntities.filter(e=>e&&!e.dead),this.entities=this.entities.filter(e=>e&&!e.dead),this.projectiles=this.projectiles.filter(e=>e&&!e.dead),this.lightSources=this.lightSources.filter(e=>e&&!e.dead),this.hitwarnings=this.hitwarnings.filter(e=>e&&!e.dead),this.particles=this.particles.filter(e=>e&&!e.dead)});r(this,"catchUp",()=>{this.turn===1&&this.computerTurn()});r(this,"tickHitWarnings",()=>{for(const e of this.hitwarnings)e.parent&&(e.parent.dead||e.parent.unconscious)&&e.tick()});r(this,"fadeLighting",e=>{for(let t=this.roomX;t<this.roomX+this.width;t++)for(let i=this.roomY;i<this.roomY+this.height;i++){let s=this.softVis[t][i]-this.vis[t][i],a=this.softVis[t][i],n=!1;Math.abs(s)>.01&&(n=!0),n&&(s*=.05*e,a-=s,a<0&&(a=0),a>1&&(a=1),this.softVis[t][i]=a)}});r(this,"fadeRgb",e=>{for(let t=this.roomX;t<this.roomX+this.width;t++)for(let i=this.roomY;i<this.roomY+this.height;i++){const[s,a,n]=this.softCol[t][i],[c,l,d]=this.col[t][i];let u=s-c,h=a-l,f=n-d,p=!1,y=!1,g=!1;Math.abs(u)>.001&&(p=!0),Math.abs(h)>.001&&(y=!0),Math.abs(f)>.001&&(g=!0),!(!p&&!y&&!g)&&(p&&(u*=.05*e,this.softCol[t][i][0]=this.clamp(Math.round(s-u),0,255)),y&&(h*=.05*e,this.softCol[t][i][1]=this.clamp(Math.round(a-h),0,255)),g&&(f*=.05*e,this.softCol[t][i][2]=this.clamp(Math.round(n-f),0,255)))}});r(this,"resetDoorLightSources",()=>{this.doors.forEach(e=>{e&&e.lightSource&&(e.lightSource.r=0),e&&e.linkedDoor&&e.linkedDoor.lightSource&&(e.linkedDoor.lightSource.r=0)})});r(this,"tileValuesToLightSource",(e,t,i)=>{if(!i.roomArray[e]||!i.roomArray[e][t])return null;const s=i.col[e][t],a=(1-i.vis[e][t])/4;return{color:s,brightness:a,radius:9}});r(this,"updateDoorLightSources",()=>{if(!this.active)return;const e={[E.UP]:{x:0,y:-1},[E.DOWN]:{x:0,y:1},[E.LEFT]:{x:1,y:0},[E.RIGHT]:{x:-1,y:0}};let t=[];this.doors.forEach(s=>{s.linkedDoor&&s.room.entered&&t.push(s.linkedDoor)}),this.doors.forEach(s=>{s.lightSource.b=.1});for(const s of t){const a=s.linkedDoor,n=e[a.doorDir]||{x:0,y:0},c=a.x-n.x,l=a.y-n.y;let d=this.tileValuesToLightSource(c,l,this);d||(d=this.tileValuesToLightSource(a.x,a.y,this)),d&&(s.lightSource.c=d.color,s.lightSource.b=d.brightness,s.lightSource.r=q.LIGHTING_MAX_DISTANCE)}let i=new Set(this.doors.filter(s=>s&&s.linkedDoor).map(s=>s.linkedDoor.room).filter(s=>s));for(const s of Array.from(i))s.entered&&!s.isUpdatingLighting&&s.updateLighting()});r(this,"setLightingAngleStep",()=>{if(!this.active)return;const e=this.width*this.height,t=Object.values(this.game.players||{}).filter(c=>{var l;return((l=c==null?void 0:c.getRoom)==null?void 0:l.call(c))===this}).length,i=Math.ceil(360/q.LIGHTING_ANGLE_STEP);let s=0;for(const c of this.lightSources)s+=Math.min(c.r,q.LIGHTING_MAX_DISTANCE);s+=t*q.LIGHTING_MAX_DISTANCE;const a=s*i,n=e+a;this.estimatedLightingTiles=n});r(this,"updateLighting",()=>{var d;if(!this.onScreen||this.isUpdatingLighting)return;this.isUpdatingLighting=!0,this.invalidateBlurCache(),this.updateDoorLightSources();let e=[],t=[];for(let u=this.roomX;u<this.roomX+this.width;u++){e[u]=[],t[u]=[];for(let h=this.roomY;h<this.roomY+this.height;h++)e[u][h]=this.vis[u][h],t[u][h]=this.col[u][h],this.vis[u][h]=1,this.col[u][h]=[1,1,1],this.renderBuffer[u][h]=[]}try{this.lightSources=this.lightSources.filter(u=>{var p;const h=Math.floor(u.x),f=Math.floor(u.y);if(h<this.roomX-1||h>this.roomX+this.width||f<this.roomY-1||f>this.roomY+this.height)return!1;for(let y=-1;y<=1;y++)for(let g=-1;g<=1;g++)if((p=this.roomArray[h+y])!=null&&p[f+g])return!0;return!1})}catch{}for(const u of this.lightSources)if(u.shouldUpdate())for(let h=0;h<360;h+=q.LIGHTING_ANGLE_STEP)this.castTintAtAngle(h,u.x,u.y,u.r,u.c,u.b*q.LIGHTING_ANGLE_BRIGHTNESS_COMPENSATION);this.setLightingAngleStep();let i=q.LIGHTING_ANGLE_STEP;for(const u in this.game.players){let h=this.game.players[u];if(((d=h.getRoom)==null?void 0:d.call(h))===this)for(let f=0;f<360;f+=i){let p=q.AMBIENT_LIGHT_COLOR,y=5;h.lightEquipped&&(p=h.lightColor,y=h.lightBrightness);let g=0,w=0;switch(h.direction){case E.UP:w=-0;break;case E.DOWN:w=0;break;case E.LEFT:g=-0;break;case E.RIGHT:g=0}this.castTintAtAngle(f,h.x+.5+g,h.y+.5+w,q.LIGHTING_MAX_DISTANCE,p,y*q.LIGHTING_ANGLE_BRIGHTNESS_COMPENSATION)}}const s=this.roomX,a=this.roomY,n=this.width,c=this.height,l=this.renderBuffer;for(let u=s;u<s+n;u++)for(let h=a;h<a+c;h++)this.col[u][h]=this.blendColorsArray(l[u][h]);for(let u=s;u<s+n;u++)for(let h=a;h<a+c;h++)this.vis[u][h]=this.rgbToLuminance(this.col[u][h]);this.updateDoorLightSources(),this.lastLightingUpdate++,this.isUpdatingLighting=!1});r(this,"updateLightSources",(e,t)=>{if(this.oldCol=[],this.oldVis=[],this.oldCol=this.col,this.oldVis=this.vis,e)for(let i=0;i<360;i+=q.LIGHTING_ANGLE_STEP)t?this.unCastTintAtAngle(i,e.x,e.y,e.r,e.c,e.b*q.LIGHTING_ANGLE_BRIGHTNESS_COMPENSATION):this.castTintAtAngle(i,e.x,e.y,e.r,e.c,e.b*q.LIGHTING_ANGLE_BRIGHTNESS_COMPENSATION);for(let i=this.roomX;i<this.roomX+this.width;i++)for(let s=this.roomY;s<this.roomY+this.height;s++)this.col[i][s]=this.blendColorsArray(this.renderBuffer[i][s]);for(let i=this.roomX;i<this.roomX+this.width;i++)for(let s=this.roomY;s<this.roomY+this.height;s++)this.vis[i][s]=this.rgbToLuminance(this.col[i][s])});r(this,"revertLightSources",()=>{this.oldCol=[],this.oldVis=[],this.col=this.oldCol,this.vis=this.oldVis});r(this,"processTintAtAngle",(e,t,i,s,a,n,c="cast")=>{const l=Math.cos(e*Math.PI/180),d=Math.sin(e*Math.PI/180),u=[this.sRGBToLinear(a[0]),this.sRGBToLinear(a[1]),this.sRGBToLinear(a[2])];for(let h=0;h<=Math.min(q.LIGHTING_MAX_DISTANCE,s);h++){const f=Math.floor(t+l*h),p=Math.floor(i+d*h);if(!this.isPositionInRoom(f,p))return;const y=this.roomArray[f][p];if(y.isOpaque())return;let g;if(h===0?g=n*.1:g=n/Math.E**(h-.25),g<.005&&(g=0),g<=0)continue;if(this.renderBuffer[f]||(this.renderBuffer[f]=[]),this.renderBuffer[f][p]||(this.renderBuffer[f][p]=[]),x.ENEMIES_BLOCK_LIGHT&&this.entities.find(T=>T.x===f&&T.y===p&&T.opaque)){const T=[u[0],u[1],u[2],g];c==="cast"?this.renderBuffer[f][p].push(T):c==="unCast"&&(this.renderBuffer[f][p]=this.renderBuffer[f][p].filter(v=>!(Math.abs(v[0]-T[0])<1e-4&&Math.abs(v[1]-T[1])<1e-4&&Math.abs(v[2]-T[2])<1e-4&&Math.abs(v[3]-T[3])<1e-4)));return}if(y instanceof et&&y.isOpaque()&&y.isInnerWall()){const b=[u[0],u[1],u[2],g];c==="cast"?this.renderBuffer[f][p].push(b):c==="unCast"&&(this.renderBuffer[f][p]=this.renderBuffer[f][p].filter(T=>!(Math.abs(T[0]-b[0])<1e-4&&Math.abs(T[1]-b[1])<1e-4&&Math.abs(T[2]-b[2])<1e-4&&Math.abs(T[3]-b[3])<1e-4)));return}const w=[u[0],u[1],u[2],g];c==="cast"?this.renderBuffer[f][p].push(w):c==="unCast"&&(this.renderBuffer[f][p]=this.renderBuffer[f][p].filter(b=>!(Math.abs(b[0]-w[0])<1e-4&&Math.abs(b[1]-w[1])<1e-4&&Math.abs(b[2]-w[2])<1e-4&&Math.abs(b[3]-w[3])<1e-4)))}});r(this,"castTintAtAngle",(e,t,i,s,a,n)=>{this.processTintAtAngle(e,t,i,s,a,n/3,"cast")});r(this,"unCastTintAtAngle",(e,t,i,s,a,n)=>{this.processTintAtAngle(e,t,i,s,a,n/3,"unCast")});r(this,"sRGBToLinear",e=>{const t=e/255;return t<=.04045?t/12.92:Math.pow((t+.055)/1.055,2.2)});r(this,"linearToSRGB",e=>e<=.0031308?Math.round(12.92*e*255):Math.round((1.055*Math.pow(e,1/2.2)-.055)*255));r(this,"clamp",(e,t=0,i=1)=>Math.min(Math.max(e,t),i));r(this,"blendColorsArray",e=>{if(e.length===0)return[0,0,0];const t=e.reduce((n,c)=>[n[0]+c[0]*c[3],n[1]+c[1]*c[3],n[2]+c[2]*c[3]],[0,0,0]),i=.45*2.5,s=[t[0]*i,t[1]*i,t[2]*i],a=[this.clamp(s[0],0,1),this.clamp(s[1],0,1),this.clamp(s[2],0,1)];return[this.linearToSRGB(a[0]),this.linearToSRGB(a[1]),this.linearToSRGB(a[2])]});r(this,"rgbToLuminance",e=>1-(.299*e[0]+.587*e[1]+.114*e[2])/255);r(this,"draw",e=>{this.onScreen&&(this.active?(Ht.updateFrame(e),this.drawInterval=4):this.active||(this.drawInterval=8),this.drawTimestamp+=e,this.drawTimestamp-this.lastDraw>=this.drawInterval&&(this.fadeRgb(e+this.drawInterval),this.fadeLighting(e+this.drawInterval),this.lastDraw=this.drawTimestamp))});r(this,"drawColorLayer",()=>{if(!this.onScreen)return;m.ctx.save(),this.colorOffscreenCtx.clearRect(0,0,this.colorOffscreenCanvas.width,this.colorOffscreenCanvas.height);let e="";const t=this.blurOffsetX,i=this.blurOffsetY;for(let s=this.roomX;s<this.roomX+this.width;s++)for(let a=this.roomY;a<this.roomY+this.height;a++){const[n,c,l]=this.softCol[s][a];if(n===0&&c===0&&l===0)continue;const d=`rgba(${n}, ${c}, ${l}, 1)`;d!==e&&(this.colorOffscreenCtx.fillStyle=d,e=d),this.colorOffscreenCtx.fillRect((s-this.roomX+t)*x.TILESIZE,(a-this.roomY+i)*x.TILESIZE,x.TILESIZE,x.TILESIZE)}if(x.USE_WEBGL_BLUR){const s=Ki.getInstance();if(this.shouldUseBlurCache()&&this.blurCache.color6px&&this.blurCache.color12px)m.ctx.globalCompositeOperation="soft-light",m.ctx.globalAlpha=.6,m.ctx.drawImage(this.blurCache.color6px,(this.roomX-t)*x.TILESIZE,(this.roomY-i)*x.TILESIZE),m.ctx.globalCompositeOperation="lighten",m.ctx.globalAlpha=.05,m.ctx.drawImage(this.blurCache.color12px,(this.roomX-t)*x.TILESIZE,(this.roomY-i)*x.TILESIZE);else{m.ctx.globalCompositeOperation="soft-light",m.ctx.globalAlpha=.6;const a=s.applyBlur(this.colorOffscreenCanvas,8);m.ctx.drawImage(a,(this.roomX-t)*x.TILESIZE,(this.roomY-i)*x.TILESIZE),this.active||this.cacheBlurResult("color8px",a),m.ctx.globalCompositeOperation="lighten",m.ctx.globalAlpha=.05;const n=s.applyBlur(this.colorOffscreenCanvas,12);m.ctx.drawImage(n,(this.roomX-t)*x.TILESIZE,(this.roomY-i)*x.TILESIZE),this.active||this.cacheBlurResult("color12px",n)}}else m.ctx.globalCompositeOperation=x.COLOR_LAYER_COMPOSITE_OPERATION,m.ctx.globalAlpha=.6,m.ctx.filter="blur(6px)",m.ctx.drawImage(this.colorOffscreenCanvas,(this.roomX-t)*x.TILESIZE,(this.roomY-i)*x.TILESIZE),m.ctx.globalCompositeOperation="lighten",m.ctx.globalAlpha=.05,m.ctx.filter="blur(12px)",m.ctx.drawImage(this.colorOffscreenCanvas,(this.roomX-t)*x.TILESIZE,(this.roomY-i)*x.TILESIZE),m.ctx.filter="none";this.colorOffscreenCtx.clearRect(0,0,this.colorOffscreenCanvas.width,this.colorOffscreenCanvas.height),m.ctx.restore()});r(this,"drawShadeLayer",()=>{var s;if(x.isIOS||!x.SHADE_ENABLED||x.SHADE_INLINE_IN_ENTITY_LAYER||!this.onScreen)return;m.ctx.save(),m.ctx.globalCompositeOperation=x.SHADE_LAYER_COMPOSITE_OPERATION,this.shadeOffscreenCtx.clearRect(0,0,this.shadeOffscreenCanvas.width,this.shadeOffscreenCanvas.height);const e=this.shadeSliceBorderTiles,t=this.shadeSliceBorderTiles;let i="";for(let a=this.roomX-2;a<this.roomX+this.width+4;a++)for(let n=this.roomY-2;n<this.roomY+this.height+4;n++){const c=(s=this.roomArray[a])==null?void 0:s[n];let l=this.softVis[a]&&this.softVis[a][n]?this.softVis[a][n]:0;if(c instanceof kt)continue;let d=(x.SMOOTH_LIGHTING,2),u=x.SMOOTH_LIGHTING?1:0,h=l**d*u,f=a,p=n,y=1,g=1;if(c instanceof et){const T=c;if(!this.innerWalls.includes(T))switch(T.direction){case E.UP:p=n-.5,g=.5;break;case E.DOWN:p=n-.5,g=1.5;break;case E.LEFT:f=a+.25,y=.75;break;case E.RIGHT:f=a,y=.75;break;case E.DOWN_LEFT:f=a+.25,p=n-.5,y=.75,g=1.5;break;case E.DOWN_RIGHT:f=a,p=n-.5,y=.75,g=1.5;break;case E.UP_LEFT:f=a+.25,p=n-.5,y=.75,g=.5;break;case E.UP_RIGHT:f=a-.5,p=n-.5,y=.75,g=.5;break}}else if(c instanceof ot){const T=c;switch(T.opened===!0&&(h=h/2),T.doorDir){case E.UP:p=n-.5,g=1.5;break;case E.DOWN:p=n-.5,g=1.5;break;case E.RIGHT:f=a-.5,p=n-1.25,y=1.5,g=2;break;case E.LEFT:f=a,p=n-1.25,y=1.5,g=2;break}}const w=x.SMOOTH_LIGHTING?1.25:.5,b=`rgba(0, 0, 0, ${h*w})`;b!==i&&(this.shadeOffscreenCtx.fillStyle=b,i=b),this.shadeOffscreenCtx.fillRect((f-this.roomX+e)*x.TILESIZE,(p-this.roomY+t)*x.TILESIZE,y*x.TILESIZE,g*x.TILESIZE)}if(x.USE_WEBGL_BLUR){const a=Ki.getInstance();if(this.shouldUseBlurCache()&&this.blurCache.shade5px)m.ctx.globalAlpha=1,m.ctx.drawImage(this.blurCache.shade5px,(this.roomX-e)*x.TILESIZE,(this.roomY-t)*x.TILESIZE);else{m.ctx.globalAlpha=1;const n=a.applyBlur(this.shadeOffscreenCanvas,5);m.ctx.drawImage(n,(this.roomX-e)*x.TILESIZE,(this.roomY-t)*x.TILESIZE),this.active||this.cacheBlurResult("shade5px",n)}}else{m.ctx.globalAlpha=1;const a=(x.SMOOTH_LIGHTING,5);m.ctx.filter=`blur(${a}px)`,m.ctx.drawImage(this.shadeOffscreenCanvas,(this.roomX-e)*x.TILESIZE,(this.roomY-t)*x.TILESIZE),m.ctx.filter="none"}m.ctx.restore()});r(this,"buildShadeOffscreenForSlicing",()=>{var s;this.shadeOffscreenCtx.clearRect(0,0,this.shadeOffscreenCanvas.width,this.shadeOffscreenCanvas.height);const e=this.blurOffsetX,t=this.blurOffsetY;let i="";for(let a=this.roomX-2;a<this.roomX+this.width+4;a++)for(let n=this.roomY-2;n<this.roomY+this.height+4;n++){const c=(s=this.roomArray[a])==null?void 0:s[n];let l=this.softVis[a]&&this.softVis[a][n]?this.softVis[a][n]:0;if(c instanceof kt)continue;let d=x.SMOOTH_LIGHTING?1:2,u=x.SMOOTH_LIGHTING?1:0,h=l**d*u,f=a,p=n,y=1,g=1;if(c instanceof et){const T=c;if(!this.innerWalls.includes(T))switch(T.direction){case E.UP:p=n-.5,g=.5;break;case E.DOWN:p=n-.5,g=1.5;break;case E.LEFT:f=a+.25,y=.75;break;case E.RIGHT:f=a,y=.75;break;case E.DOWN_LEFT:f=a+.25,p=n-.5,y=.75,g=1.5;break;case E.DOWN_RIGHT:f=a,p=n-.5,y=.75,g=1.5;break;case E.UP_LEFT:f=a+.25,p=n-.5,y=.75,g=.5;break;case E.UP_RIGHT:f=a-.5,p=n-.5,y=.75,g=.5;break}}else if(c instanceof ot){const T=c;if(T.opened===!0)switch(h=h/2,T.doorDir){case E.UP:p=n-1.5,g=1.5,y=2,f=a-.5;break;case E.DOWN:p=n-.5,g=1.5,y=2,f=a-.5;break;case E.RIGHT:f=a-2,p=n-2,y=3,g=3;break;case E.LEFT:f=a,p=n-2,y=3,g=3;break}else switch(T.doorDir){case E.UP:p=n-.5,g=1.5;break;case E.DOWN:p=n-1,g=3,y=3,f=a-.5;break;case E.RIGHT:f=a-2,p=n-2,y=3,g=3;break;case E.LEFT:f=a,p=n-2,y=3,g=3;break}}const w=x.SMOOTH_LIGHTING?1:.5,b=`rgba(0, 0, 0, ${h*w})`;b!==i&&(this.shadeOffscreenCtx.fillStyle=b,i=b),p+=1,f+=1,this.shadeOffscreenCtx.fillRect((f-this.roomX+e)*x.TILESIZE,(p-this.roomY+t)*x.TILESIZE,y*x.TILESIZE,g*x.TILESIZE)}});r(this,"getBlurredShadeSourceForSlicing",()=>{if(x.USE_WEBGL_BLUR){const e=Ki.getInstance();if(this.shouldUseBlurCache()&&this.blurCache.shade5px)return this.blurCache.shade5px;{const t=e.applyBlur(this.shadeOffscreenCanvas,8);return this.active||this.cacheBlurResult("shade5px",t),t}}else{this.shadeBlurTempCanvas||(this.shadeBlurTempCanvas=document.createElement("canvas"),this.shadeBlurTempCanvas.width=this.shadeOffscreenCanvas.width,this.shadeBlurTempCanvas.height=this.shadeOffscreenCanvas.height,this.shadeBlurTempCtx=this.shadeBlurTempCanvas.getContext("2d"));const e=this.shadeBlurTempCtx;return e.clearRect(0,0,this.shadeBlurTempCanvas.width,this.shadeBlurTempCanvas.height),e.filter="blur(5px)",e.drawImage(this.shadeOffscreenCanvas,0,0),e.filter="none",this.shadeBlurTempCanvas}});r(this,"drawShadeSliceForTile",(e,t,i,s)=>{const a=x.TILESIZE,n=(t+1-this.roomX+this.blurOffsetX)*a,c=(i+1-this.roomY+this.blurOffsetY)*a,l=t*a,d=i*a;if(!s){m.ctx.drawImage(e,n,c,a,a,l,d,a,a);return}this.shadeSliceTempCanvas||(this.shadeSliceTempCanvas=document.createElement("canvas"),this.shadeSliceTempCanvas.width=a,this.shadeSliceTempCanvas.height=a,this.shadeSliceTempCtx=this.shadeSliceTempCanvas.getContext("2d"));const u=this.shadeSliceTempCtx;u.clearRect(0,0,a,a),u.globalCompositeOperation="source-over",u.drawImage(e,n,c,a,a,0,0,a,a);let h=null;s==="right"?(h=u.createLinearGradient(0,0,a,0),h.addColorStop(0,"rgba(0,0,0,0)"),h.addColorStop(1,"rgba(0,0,0,1)")):s==="left"?(h=u.createLinearGradient(0,0,a,0),h.addColorStop(0,"rgba(0,0,0,1)"),h.addColorStop(1,"rgba(0,0,0,0)")):s==="up"?(h=u.createLinearGradient(0,0,0,a),h.addColorStop(0,"rgba(0,0,0,0)"),h.addColorStop(1,"rgba(0,0,0,1)")):s==="down"&&(h=u.createLinearGradient(0,0,0,a),h.addColorStop(0,"rgba(0,0,0,1)"),h.addColorStop(1,"rgba(0,0,0,0)")),h&&(u.globalCompositeOperation="destination-in",u.fillStyle=h,u.fillRect(0,0,a,a)),m.ctx.drawImage(this.shadeSliceTempCanvas,l,d)});r(this,"drawBloomLayer",e=>{if(!this.onScreen)return;m.ctx.save(),this.bloomOffscreenCtx.clearRect(0,0,this.bloomOffscreenCanvas.width,this.bloomOffscreenCanvas.height);const t=this.blurOffsetX,i=this.blurOffsetY;if(this.entities.concat(this.deadEntities).length>0)for(let a of this.entities)a.hasBloom&&(a.updateBloom(e),this.bloomOffscreenCtx.globalAlpha=1*(1-this.softVis[a.x][a.y])*a.softBloomAlpha,this.bloomOffscreenCtx.fillStyle=a.bloomColor,this.bloomOffscreenCtx.fillRect((a.x-a.drawX-this.roomX+t+.5-a.bloomSize/2)*x.TILESIZE,(a.y-a.drawY-this.roomY-.5+i+.5-a.bloomSize/2)*x.TILESIZE+a.bloomOffsetY,x.TILESIZE*a.bloomSize,x.TILESIZE*a.bloomSize));for(let a=this.roomX;a<this.roomX+this.width;a++)for(let n=this.roomY;n<this.roomY+this.height;n++)this.roomArray[a][n].hasBloom&&(this.roomArray[a][n].updateBloom(e),this.bloomOffscreenCtx.globalAlpha=1*(1-this.softVis[a][n])*this.roomArray[a][n].softBloomAlpha,this.bloomOffscreenCtx.fillStyle=this.roomArray[a][n].bloomColor,this.bloomOffscreenCtx.fillRect((a-this.roomX+t)*x.TILESIZE,(n-this.roomY-.25+i)*x.TILESIZE,x.TILESIZE,x.TILESIZE*.75));if(this.projectiles.length>0)for(let a of this.projectiles)a.hasBloom&&(a.updateBloom(e),this.bloomOffscreenCtx.globalAlpha=1*(1-this.softVis[a.x][a.y])*a.softBloomAlpha,this.bloomOffscreenCtx.fillStyle=a.bloomColor,this.bloomOffscreenCtx.fillRect((a.x-this.roomX+t)*x.TILESIZE,(a.y-this.roomY+i+a.bloomOffsetY)*x.TILESIZE,x.TILESIZE,x.TILESIZE));if(x.USE_WEBGL_BLUR){const a=Ki.getInstance();if(this.shouldUseBlurCache()&&this.blurCache.bloom8px)m.ctx.globalCompositeOperation="screen",m.ctx.globalAlpha=1,m.ctx.drawImage(this.blurCache.bloom8px,(this.roomX-t)*x.TILESIZE,(this.roomY-i)*x.TILESIZE);else{m.ctx.globalCompositeOperation="screen",m.ctx.globalAlpha=1;const n=a.applyBlur(this.bloomOffscreenCanvas,8);m.ctx.drawImage(n,(this.roomX-t)*x.TILESIZE,(this.roomY-i)*x.TILESIZE),this.active||this.cacheBlurResult("bloom8px",n)}}else m.ctx.globalCompositeOperation="screen",m.ctx.globalAlpha=1,m.ctx.filter="blur(8px)",m.ctx.drawImage(this.bloomOffscreenCanvas,(this.roomX-t)*x.TILESIZE,(this.roomY-i)*x.TILESIZE),m.ctx.filter="none";this.bloomOffscreenCtx.fillStyle="rgba(0, 0, 0, 1)",this.bloomOffscreenCtx.fillRect(0,0,this.bloomOffscreenCanvas.width,this.bloomOffscreenCanvas.height),m.ctx.restore()});r(this,"drawEntities",(e,t)=>{var l,d,u;if(!this.onScreen)return;m.ctx.save();let i=x.SHADE_ENABLED&&x.SHADE_INLINE_IN_ENTITY_LAYER,s=null;i&&(this.buildShadeOffscreenForSlicing(),s=this.getBlurredShadeSourceForSlicing());let a=[];for(let h=this.roomX;h<this.roomX+this.width;h++)for(let f=this.roomY;f<this.roomY+this.height;f++){const p=this.roomArray[h][f];p.drawUnderPlayer(e),a.push(p)}let n=new Array,c=new Array;c=c.concat(this.entities,this.deadEntities),n=n.concat(a,this.decorations,c,this.hitwarnings,this.projectiles,this.particles,this.items);for(const h in this.game.players)((d=(l=this.game.players[h]).getRoom)==null?void 0:d.call(l))===this&&(t&&this.game.players[h]===this.game.players[this.game.localPlayerID]||n.push(this.game.players[h]));n.sort((h,f)=>{if(h instanceof bt||h instanceof $t)return-1;if(f instanceof bt||f instanceof $t)return 1;if(h instanceof Wo)return-1;if(f instanceof Wo)return 1;if(Math.abs(h.drawableY-f.drawableY)<.1){const p=h.shouldDrawAbovePlayer===!0,y=f.shouldDrawAbovePlayer===!0;return h instanceof fi&&y?-1:f instanceof fi&&p||h instanceof fi?1:f instanceof fi?-1:h instanceof mt?1:f instanceof mt?-1:h instanceof yi?1:f instanceof yi?-1:0}else return h.drawableY-f.drawableY});for(const h of n)if(h.draw(e),i&&s&&h instanceof oe){const f=h.x,p=h.y;if((this.softVis[f]&&this.softVis[f][p]?this.softVis[f][p]:0)>0){const g=m.ctx.globalCompositeOperation;g!==x.SHADE_LAYER_COMPOSITE_OPERATION&&(m.ctx.globalCompositeOperation=x.SHADE_LAYER_COMPOSITE_OPERATION);const w=m.ctx.globalAlpha;m.ctx.globalAlpha=1;let b;if(h instanceof ot&&h.opened)switch(h.doorDir){case E.LEFT:b="left";break;case E.RIGHT:b="right";break;case E.UP:b=void 0;break;case E.DOWN:b="down";break}else if(h instanceof et){const T=this.wallInfo.get(`${f},${p}`);if(T&&T.isBelowDoorWall){const v=(u=this.roomArray[f])==null?void 0:u[p+1];v instanceof ot&&v.opened&&(v.doorDir===E.LEFT?b="left":v.doorDir===E.RIGHT&&(b="right"))}}this.drawShadeSliceForTile(s,f,p,b),m.ctx.globalAlpha=w,g!==x.SHADE_LAYER_COMPOSITE_OPERATION&&(m.ctx.globalCompositeOperation=g)}}this.drawAbovePlayer(e);for(const h of this.items)h.drawTopLayer(e);m.ctx.restore()});r(this,"drawAbovePlayer",e=>{for(let t=this.roomX;t<this.roomX+this.width;t++)for(let i=this.roomY;i<this.roomY+this.height;i++);});r(this,"drawShade",e=>{if(!this.onScreen)return;m.ctx.save();let t=0;for(const i in this.game.players){m.ctx.globalCompositeOperation="source-over",m.ctx.globalAlpha=1;const s=this.game.players[i];(s.getRoom?s.getRoom():this.level.rooms[s.levelID])===this&&s.defaultSightRadius>t&&(t=this.game.players[i].defaultSightRadius)}m.ctx.globalAlpha=.25,m.ctx.fillStyle=this.shadeColor,m.ctx.fillRect(this.roomX*x.TILESIZE,(this.roomY-1)*x.TILESIZE,this.width*x.TILESIZE,(this.height+1)*x.TILESIZE),m.ctx.globalAlpha=1,m.ctx.globalCompositeOperation="source-over",m.ctx.restore()});r(this,"shadeOpacity",()=>(this.active,.25));r(this,"drawOverShade",e=>{m.ctx.save();for(const t of this.entities)t.drawTopLayer(e);for(const t of this.projectiles)t.drawTopLayer(e);for(const t of this.hitwarnings)t.drawTopLayer(e);for(const t of this.particles)t.drawTopLayer(e);for(let t=this.roomX;t<this.roomX+this.width;t++)for(let i=this.roomY;i<this.roomY+this.height;i++)this.roomArray[t][i].drawAboveShading(e);for(const t of this.items)t.drawAboveShading(e);m.ctx.restore()});r(this,"drawTopLayer",e=>{m.ctx.save();let t=m.ctx.font;m.ctx.font=x.SCRIPT_FONT_SIZE+"px Script",m.ctx.fillStyle=q.LEVEL_TEXT_COLOR,m.fillText(this.message,x.WIDTH/2-m.measureText(this.name).width/2,5),m.ctx.font=t,m.ctx.restore()});r(this,"createWallMask",()=>{const e=document.createElement("canvas");this.maskCanvases.push(e),e.width=this.width*x.TILESIZE,e.height=this.height*x.TILESIZE;const t=e.getContext("2d");if(!t)throw new Error("Failed to create mask canvas context.");return t.fillStyle="rgba(255, 255, 255, 1)",t.fillRect(this.roomX*x.TILESIZE,this.roomY*x.TILESIZE,e.width,e.height),e});r(this,"getExtremeLuminance",()=>{const e=[];for(let t=this.roomX;t<this.roomX+this.width;t++)for(let i=this.roomY;i<this.roomY+this.height;i++)this.vis[t]&&this.vis[t][i]!==void 0&&e.push({x:t,y:i,vis:this.vis[t][i]});return e.length===0?{darkest:null,lightest:null}:(e.sort((t,i)=>t.vis-i.vis),{darkest:e[e.length-1],lightest:e[0]})});r(this,"getExtremeLuminanceFromPoint",(e,t)=>{const i=[{x:e,y:t-1},{x:e,y:t+1},{x:e-1,y:t},{x:e+1,y:t}],s=[];return i.forEach(a=>{const{x:n,y:c}=a;this.vis[n]&&this.vis[n][c]!==void 0&&this.roomArray[n]&&this.roomArray[n][c]&&this.roomArray[n][c]instanceof bt&&s.push({x:n,y:c,vis:this.vis[n][c]})}),s.length===0?{darkest:null,lightest:null}:(s.sort((a,n)=>a.vis-n.vis),{darkest:s[s.length-1],lightest:s[0]})});r(this,"getAverageLuminance",()=>{let e=0,t=0;for(let i=this.roomX-2;i<=this.roomX+2;i++)if(this.roomArray[i]&&this.roomArray[i][this.roomY])for(let s=this.roomY-2;s<=this.roomY+2;s++)this.vis[i][s]&&(e+=this.vis[i][s],t++);return e/t});r(this,"tileInside",(e,t)=>this.pointInside(e,t,this.roomX,this.roomY,this.width,this.height));r(this,"getEmptyTiles",()=>{let e=[];for(let t=this.roomX+1;t<this.roomX+this.width-1;t++)for(let i=this.roomY+1;i<this.roomY+this.height-1;i++)!this.roomArray[t][i].isSolid()&&!(this.roomArray[t][i]instanceof rt)&&!(this.roomArray[t][i]instanceof $t)&&!(this.roomArray[t][i]instanceof le)&&!(this.roomArray[t][i]instanceof wt)&&e.push(this.roomArray[t][i]);for(const t of this.entities)e=e.filter(i=>!t.pointIn(i.x,i.y));return e});r(this,"getTile",(e,t)=>{if(this.roomArray[e])return this.roomArray[e][t]});r(this,"getBossDoor",()=>{for(const e of this.doors)if(e.linkedDoor.room.type==="DOWNLADDER")return{x:e.x,y:e.y,doorDir:e.doorDir};return null});r(this,"path",()=>{const e=new Set,t=[],i=[this];for(;i.length>0;){const s=i.shift();if(!s)continue;const a=s.globalId;if(!(!a||e.has(a))){e.add(a),t.push(s);try{const n=s.doors;if(!n)continue;for(const c of n){const l=c==null?void 0:c.linkedDoor,d=l&&l.room;if(d){const u=d.globalId;u&&!e.has(u)&&i.push(d)}}}catch{}}}return t});r(this,"hasLadder",e=>{for(let t=this.roomX;t<this.roomX+this.width;t++)if(this.roomArray[t])for(let i=this.roomY;i<this.roomY+this.height;i++){const s=this.roomArray[t][i];if(s instanceof le&&e==="up"||s instanceof wt&&e==="down"&&s.isSidePath)return!0}return!1});r(this,"hasKey",()=>{for(const e of this.items)if(e instanceof Ze)return!0;return!1});r(this,"getDistanceToNearestLadder",e=>{const t=this;if(t.hasLadder(e))return 0;const i=new Set,s=[];for(i.add(t.globalId),s.push({room:t,dist:0});s.length>0;){const{room:a,dist:n}=s.shift();for(const c of a.doors){const l=c&&c.linkedDoor&&c.linkedDoor.room;if(!l)continue;const d=l.globalId;if(!i.has(d)){if(l.hasLadder(e))return n+1;i.add(d),s.push({room:l,dist:n+1})}}}return null});r(this,"hasNoEnemies",()=>this.entities.filter(i=>i instanceof it).length===0&&this.lastEnemyCount>0);r(this,"roomCleared",()=>this.entities.filter(t=>t instanceof it).length===0);r(this,"hasHitwarning",(e,t)=>{for(const i of this.hitwarnings)if(i.x===e&&i.y===t&&!i.dead)return!0;return!1});r(this,"hasEnemy",(e,t)=>{for(const i of this.entities)if(i instanceof it&&i.x===e&&i.y===t)return!0;return!1});r(this,"isTileEmpty",(e,t)=>{if(!this.roomArray[e]||!this.roomArray[e][t])return!1;const i=this.roomArray[e][t];if(i.isSolid()||i instanceof rt||i instanceof $t||i instanceof le||i instanceof wt)return!1;for(const s of this.entities)if(s.pointIn(e,t))return!1;return!0});r(this,"hasEnemyInRadius",(e,t)=>{for(let a=-2;a<=2;a++)for(let n=-2;n<=2;n++)if(a*a+n*n<=4){const c=e+a,l=t+n;if(this.hasEnemy(c,l))return!0}return!1});r(this,"checkForNoEnemies",()=>{if(this.hasNoEnemies()){let e=!1;this.doors.forEach(t=>{t.type===Ti.GUARDEDDOOR&&(t.unGuard(),e=!0,this.game.startCameraAnimation(this.getBossDoor().x,this.getBossDoor().y,175))}),e&&this.game.pushMessage("The foes have been slain and the door allows you passage.")}});r(this,"removeDoorObstructions",()=>{let e=[];for(const t of this.doors)for(const i of this.doors){if(t===i||t===null||i===null)continue;const s=this.findPath(t,i);s.length>0&&e.push(...s)}if(e.length>0)for(let t of e)this.entities=this.entities.filter(i=>i!==t),t=null});r(this,"findPath",(e,t,i)=>{let s=Array(),a=[];for(const h of this.entities)(h instanceof ut||h instanceof Pi||h instanceof We||h instanceof Ge||h instanceof ci||h instanceof Re||h instanceof Gs)&&(s.push({x:h.x,y:h.y}),a.push(h));i&&s.push(...i);let n=[];for(let h=0;h<this.width;h++){n[h]=[];for(let f=0;f<this.height;f++){const p=this.roomX+h,y=this.roomY+f;this.roomArray[p]&&this.roomArray[p][y]?n[h][f]=this.roomArray[p][y]:n[h][f]=!1}}const c={x:e.x-this.roomX,y:e.y-this.roomY},l={x:t.x-this.roomX,y:t.y-this.roomY},d=s.map(h=>({x:h.x-this.roomX,y:h.y-this.roomY}));return yt.AStar.search(n,c,l,d,!1,!1,!1).length===0?a:[]});r(this,"wouldBlockDoor",(e,t)=>{if(this.doors.length<2)return!1;for(let i=0;i<this.doors.length;i++)for(let s=i+1;s<this.doors.length;s++){const a=this.doors[i],n=this.doors[s];if(!a||!n||this.findPath(a,n).length>0)continue;const l=[{x:e,y:t}];if(this.findPath(a,n,l).length>0)return console.warn("DOOR WOULD BE BLOCKED!"),!0}return!1});r(this,"getEmptyTilesNotBlockingDoors",()=>this.getEmptyTiles().filter(t=>!this.wouldBlockDoor(t.x,t.y)));r(this,"addDoorWithOffset",(e,t,i=this,s=!1)=>{var n,c;const a=(l,d)=>i.entities.some(u=>u instanceof ut&&u.x===l&&u.y===d);if(((n=i.roomArray[e])==null?void 0:n[t])instanceof ot){let l=null;if(e===i.roomX?l=E.RIGHT:e===i.roomX+i.width-1?l=E.LEFT:t===i.roomY?l=E.DOWN:t===i.roomY+i.height-1&&(l=E.UP),!l)return null;const d=[];switch(l){case E.RIGHT:case E.LEFT:d.push({dx:0,dy:1},{dx:0,dy:-1});break}const u=d.sort(()=>O.rand()-.5);if(a(e,t))return null;for(const h of u){const f=e+h.dx,p=t+h.dy;if(f>i.roomX&&f<i.roomX+i.width-1&&p>i.roomY&&p<i.roomY+i.height-1&&!(((c=i.roomArray[f])==null?void 0:c[p])instanceof ot)&&!a(f,p))return i.addDoor(f,p,i,s)}return null}return a(e,t)?null:i.addDoor(e,t,i,s)});r(this,"pointExists",(e,t)=>this.roomArray[e]&&this.roomArray[e][t]);r(this,"invalidateBlurCache",()=>{this.blurCache.isValid=!1,this.blurCache.lastLightingUpdate=this.lastLightingUpdate});r(this,"shouldUseBlurCache",()=>!this.active&&this.blurCache.isValid&&this.blurCache.lastLightingUpdate===this.lastLightingUpdate);r(this,"getPlayer",()=>{var e,t;for(const i in this.game.players)if(((t=(e=this.game.players[i]).getRoom)==null?void 0:t.call(e))===this)return this.game.players[i];return null});r(this,"cacheBlurResult",(e,t)=>{if(!this.active){const i=document.createElement("canvas");i.width=t.width,i.height=t.height;const s=i.getContext("2d");s&&(s.drawImage(t,0,0),this.blurCache[e]=i,this.blurCache.isValid=!0,this.blurCache.lastLightingUpdate=this.lastLightingUpdate)}});this.globalId=se.generate("R"),this.pathId="main",this.game=e,this.roomX=t,this.roomY=i,this.width=s,this.height=a,this.type=n,this.depth=c,this.mapGroup=l,this.entered=!1,this.turn=0,this.playerTurnTime=Date.now(),this.items=Array(),this.projectiles=Array(),this.hitwarnings=Array(),this.particles=Array(),this.doors=Array(),this.entities=Array(),this.lightSources=Array(),this.innerWalls=Array(),this.level=d,this.id=0,this.currentSpawnerCount=0,this.deadEntities=Array(),this.active=!1,this.lastLightingUpdate=0,this.walls=Array(),this.decorations=Array(),this.colorOffscreenCanvas=document.createElement("canvas"),this.colorOffscreenCanvas.width=(this.width+10)*x.TILESIZE,this.colorOffscreenCanvas.height=(this.height+10)*x.TILESIZE;const f=this.colorOffscreenCanvas.getContext("2d");if(!f)throw new Error("Failed to initialize color offscreen canvas context.");this.colorOffscreenCtx=f,this.shadeOffscreenCanvas=document.createElement("canvas"),this.shadeOffscreenCanvas.width=(this.width+10)*x.TILESIZE,this.shadeOffscreenCanvas.height=(this.height+10)*x.TILESIZE;const p=this.shadeOffscreenCanvas.getContext("2d");if(!p)throw new Error("Failed to initialize shade offscreen canvas context.");this.shadeOffscreenCtx=p,this.bloomOffscreenCanvas=document.createElement("canvas"),this.bloomOffscreenCanvas.width=(this.width+10)*x.TILESIZE,this.bloomOffscreenCanvas.height=(this.height+10)*x.TILESIZE;const y=this.bloomOffscreenCanvas.getContext("2d");if(!y)throw new Error("Failed to initialize bloom offscreen canvas context.");this.bloomOffscreenCtx=y,this.roomArray=[];for(let g=this.roomX-1;g<this.roomX+this.width+1;g++){this.roomArray[g]=[];for(let w=this.roomY-1;w<this.roomY+this.height+1;w++)this.roomArray[g][w]=null}this.vis=[],this.softVis=[],this.col=[],this.softCol=[];for(let g=this.roomX;g<this.roomX+this.width;g++){this.vis[g]=[],this.softVis[g]=[],this.col[g]=[],this.softCol[g]=[];for(let w=this.roomY;w<this.roomY+this.height;w++)this.vis[g][w]=1,this.softVis[g][w]=1,this.col[g][w]=[0,0,0],this.softCol[g][w]=[0,0,0]}this.renderBuffer=[];for(let g=this.roomX;g<this.roomX+this.width;g++){this.renderBuffer[g]=[];for(let w=this.roomY;w<this.roomY+this.height;w++)this.renderBuffer[g][w]=[]}this.envType=h,this.skin=h,this.builder=new jh(this)}addDoorTorches(e,t,i){var s,a;if(!(i!==E.UP&&i!==E.DOWN)&&e&&t){this.calculateWallInfo();const n=this.wallInfo.get(`${e-1},${t}`),c=this.wallInfo.get(`${e+1},${t}`);(s=this.roomArray[e-1])==null||s[t],(a=this.roomArray[e+1])==null||a[t];const l=(n==null?void 0:n.isLeftWall)===!1,d=(c==null?void 0:c.isRightWall)===!1;l&&(this.roomArray[e-1][t]=new kt(this,e-1,t)),d&&(this.roomArray[e+1][t]=new kt(this,e+1,t))}}addTorches(e,t,i,s){var d;if(this.level.environment.type===F.FOREST&&this.type!=="DOWNLADDER")return;if(i!==void 0&&s!==void 0&&((d=this.roomArray[i])==null?void 0:d[s])instanceof et){this.roomArray[i][s]=new kt(this,i,s);return}let a=[];for(let u=this.roomX+1;u<this.roomX+this.width-2;u++)for(let h=this.roomY;h<this.roomY+this.height-1;h++)this.roomArray[u][h]instanceof et&&!(this.roomArray[u][h+1]instanceof et)&&a.push(this.roomArray[u][h]);let n=[];for(let u=this.roomX+1;u<this.roomX+this.width-2;u++){const h=this.roomY+this.height-1;this.roomArray[u][h]instanceof et&&!(this.roomArray[u][h+1]instanceof et)&&n.push(this.roomArray[u][h])}const c=m.rand(0,e,t),l=e-c;for(let u=0;u<c&&a.length!=0;u++){const h=m.rand(0,a.length-1,t),f=a.splice(h,1)[0],p=f.x,y=f.y;this.roomArray[p][y]=new kt(this,p,y)}for(let u=0;u<l&&n.length!=0;u++){const h=m.rand(0,n.length-1,t),f=n.splice(h,1)[0],p=f.x,y=f.y;this.roomArray[p][y]=new kt(this,p,y,!0)}}addChasms(e){let t=m.rand(2,4,e),i=m.rand(2,4,e),s=this.roomX+2,a=this.roomX+this.width-t-2,n=this.roomY+2,c=this.roomY+this.height-i-2;if(a<s||c<n)return;let l=m.rand(s,a,e),d=m.rand(n,c,e);for(let u=l-1;u<l+t+1;u++)for(let h=d-1;h<d+i+1;h++)u===l-1||u===l+t||h===d-1||h===d+i?this.roomArray[u][h]instanceof $t||(this.roomArray[u][h]=new bt(this,u,h)):this.roomArray[u][h]=new Ci(this,u,h,u===l,u===l+t-1,h===d,h===d+i-1)}addSpikeTraps(e,t){if(this.level.environment.type===F.FOREST||this.envType===F.FOREST)return;let i=this.getEmptyTiles();for(let s=0;s<e;s++){const{x:a,y:n}=this.getRandomEmptyPosition(i);this.roomArray[a][n]=new rt(this,a,n)}}addEnemies(e,t){if(G.NO_ENEMIES===!0)return;this.envType===F.FOREST&&(e/=2);let i=this.getEmptyTiles();if(i===null)return;const s=new Set;for(const c of this.doors)for(let l=-2;l<=2;l++)for(let d=-2;d<=2;d++)s.add(`${c.x+l},${c.y+d}`);i=i.filter(c=>!s.has(`${c.x},${c.y}`));for(let c=0;c<e;c++){if(i.length===0){console.warn("No tiles left to spawn enemies");break}let l=this.getRandomEmptyPosition(i);if(l.x===null||l.y===null){c=e;break}const{x:d,y:u}=l;let h=this.level.enemyParameters.enemyTables,f=this.level.enemyParameters.maxDepthTable,p=Math.min(this.depth,f);if(h[p]&&h[p].length>0){let y=w=>{for(let b=0;b<w.w;b++)for(let T=0;T<w.h;T++)if(!i.some(v=>v.x===d+b&&v.y===u+T))return e++,!1;this.entities.push(w);for(let b=0;b<w.w;b++)for(let T=0;T<w.h;T++)i=i.filter(v=>!(v.x===d+b&&v.y===u+T));return!0};switch(m.randTable(h[p],O.rand)){case 1:Bt.add(this,this.game,d,u);break;case 2:fe.add(this,this.game,d,u);break;case 3:te.add(this,this.game,d,u);break;case 4:_t.add(this,this.game,d,u);break;case 5:Mt.add(this,this.game,d,u);break;case 6:Ft.add(this,this.game,d,u);break;case 7:Gt.add(this,this.game,d,u);break;case 8:Pt.add(this,this.game,d,u);break;case 9:Ct.add(this,this.game,d,u);break;case 10:if(y(new Nt(this,this.game,d,u)))for(let w=0;w<2;w++)for(let b=0;b<2;b++)this.roomArray[d+w][u+b]=new bt(this,d+w,u+b);break;case 11:Xt.add(this,this.game,d,u);break;case 12:Lt.add(this,this.game,d,u);break;case 13:if(y(new Ut(this,this.game,d,u)))for(let w=0;w<2;w++)for(let b=0;b<2;b++)this.roomArray[d+w][u+b]=new bt(this,d+w,u+b);break;case 14:Dt.add(this,this.game,d,u);break;case 15:Jt.add(this,this.game,d,u);break}}}let a=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,2,2,2,2,2,2,2,3,3,4,5,3];if(this.depth>0){let c=m.randTable(a,t);this.addSpawners(c,t)}let n=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];if(this.depth>1){let c=m.randTable(n,t);this.addOccultists(c,t)}}addRandomEnemies(){let e=this.getEmptyTiles().length;const t=Math.min((this.depth+2)*.05,.3),i=Math.ceil(Math.max(Q.randomNormalInt(0,e*t),e*t));this.addEnemies(i,O.rand)}addSpawners(e,t){let i=this.getEmptyTiles();if(i!==null)for(let s=0;s<e;s++){const{x:a,y:n}=this.getRandomEmptyPosition(i);let c=this.level.populator.getEnemyPoolForDepth(Math.max(0,this.depth-1)).filter(d=>d!==7);return Ee.add(this,this.game,a,n,c)}}addOccultists(e,t){let i=this.getEmptyTiles();if(i!==null)for(let s=0;s<e;s++){const{x:a,y:n}=this.getRandomEmptyPosition(i);return He.add(this,this.game,a,n)}}addBosses(e){if(G.NO_ENEMIES===!0)return;let t=this.getEmptyTiles();if(t===null)return;let i=["reaper","queen","bigskullenemy","bigzombieenemy"];e>0&&(i.push("occultist"),i.filter(c=>c!=="queen"));const s=m.randTable(i,O.rand),{x:a,y:n}=s.startsWith("big")?this.getBigRandomEmptyPosition(t):this.getRandomEmptyPosition(t);switch(s){case"reaper":const c=this.addSpawners(1,O.rand);c.dropTable=["weapon","equipment"],c.dropChance=1;break;case"queen":const l=Xt.add(this,this.game,a,n);l.dropTable=["weapon","equipment"],l.dropChance=1;break;case"bigskullenemy":const d=Nt.add(this,this.game,a,n);d.dropTable=["weapon","equipment","consumable","gem","tool"];break;case"occultist":const u=this.addOccultists(1,O.rand);u.dropTable=["weapon","equipment"],u.dropChance=1;break;case"bigzombieenemy":const h=mi.add(this,this.game,a,n);h.dropTable=["weapon","equipment","consumable","gem","tool"],h.dropChance=1;break}}addChests(e,t){let i=this.getEmptyTiles();for(let s=0;s<e;s++){const a=this.getRandomEmptyPosition(i);if(!a)break;const{x:n,y:c}=a;this.entities.push(new Ot(this,this.game,n,c))}}addBombs(e,t){let i=this.getEmptyTiles();for(let s=0;s<this.getEmptyTiles().length;s++){const{x:a,y:n}=this.getRandomEmptyPosition(i);ui.add(this,this.game,a,n)}}addResources(e,t){let i=this.getEmptyTiles();for(let s=0;s<e;s++){const{x:a,y:n}=this.getRandomEmptyPosition(i);let c=t();c<=(10-this.depth**3)/10?Qs.add(this,this.game,a,n):c<=(10-(this.depth-2)**3)/10?Js.add(this,this.game,a,n):tr.add(this,this.game,a,n)}}addVendingMachine(e,t,i,s){const a=this.getRandomEmptyPosition(this.getEmptyTiles());let n=t||a.x,c=i||a.y,l=this.depth>0?[1,1,1,1,1,2,2,2,2,2,2,1,1,1,2,2,1,1,3,4,5,5,5,5,5]:[1,1,1],d=m.randTable(l,e);if(s){ut.add(this,this.game,n,c,s);return}switch(d){case 1:ut.add(this,this.game,n,c,new ue(this,n,c));break;case 2:ut.add(this,this.game,n,c,new ii(this,n,c));break;case 3:ut.add(this,this.game,n,c,new Wt(this,n,c));break;case 4:ut.add(this,this.game,n,c,new we(this,n,c));break;case 5:ut.add(this,this.game,n,c,new si(this,n,c));break}}applyGaussianBlur(e,t){if(!e.getContext("2d"))throw new Error("Failed to get canvas context for Gaussian blur.");e.width,e.height}calculateWallInfo(){var e,t,i;this.wallInfo.clear();for(let s=this.roomX;s<this.roomX+this.width;s++)for(let a=this.roomY;a<this.roomY+this.height;a++){const n=this.getTile(s,a);if(n instanceof et||n instanceof kt){this.walls.push(n);const c=a===this.roomY,l=a===this.roomY+this.height-1,d=s===this.roomX,u=s===this.roomX+this.width-1,h=!c&&!l&&!d&&!u,f=a<this.roomY+this.height-1&&((e=this.getTile(s,a+1))==null?void 0:e.isDoor),p=a<this.roomY+this.height-1&&((t=this.getTile(s,a-1))==null?void 0:t.isDoor),y=a<this.roomY+this.height&&((i=this.getTile(s,a+1))==null?void 0:i.isDoor);let g=null;if(h){const w=this.getTile(s,a-1)instanceof et,b=this.getTile(s,a+1)instanceof et;!w&&b?g="topInner":w&&!b?g="bottomInner":w&&b?g="surroundedInner":g="isolatedInner"}this.wallInfo.set(`${s},${a}`,{isTopWall:c,isBottomWall:l,isLeftWall:d,isRightWall:u,isInnerWall:h,isBelowDoorWall:f,isDoorWall:y,innerWallType:g,isAboveDoorWall:p,shouldDrawBottom:y||f||c&&!d&&!u||h})}}}pointInside(e,t,i,s,a,n){return!(e<i||e>=i+a||t<s||t>=s+n)}getRandomEmptyPosition(e,t){if(e.length===0)return null;const i=e.splice(m.rand(0,e.length-1,O.rand),1)[0];return t&&i.x===t.x&&i.y===t.y?this.getRandomEmptyPosition(e,t):{x:i.x,y:i.y}}getBigRandomEmptyPosition(e){if(e.length===0)return null;const t=new Set(e.map(a=>`${a.x},${a.y}`)),i=e.filter(a=>t.has(`${a.x+1},${a.y}`)&&t.has(`${a.x},${a.y+1}`)&&t.has(`${a.x+1},${a.y+1}`));if(i.length===0)return null;const s=i[m.rand(0,i.length-1,O.rand)];return{x:s.x,y:s.y}}getRoomCenter(){return{x:Math.floor(this.roomX+this.width/2),y:Math.floor(this.roomY+this.height/2)}}isPositionInRoom(e,t){return!(Math.floor(e)<this.roomX||Math.floor(e)>=this.roomX+this.width||Math.floor(t)<this.roomY||Math.floor(t)>=this.roomY+this.height)}pathIsBlockedBy(e,t){const i=[];return e.isSolid()&&i.push(e),t.isSolid()&&i.push(t),i}addBeamEffect(e,t,i,s,a){const n=new de(e,t,i,s,a);this.beamEffects.push(n)}async changeReverb(e){await Fe.setReverbImpulse(e)}get roomArea(){(this.width-2)*(this.height-2);let e=[];for(let t=this.roomX+1;t<this.roomX+this.width-1;t++)for(let i=this.roomY+1;i<this.roomY+this.height-1;i++)this.roomArray[t][i]instanceof bt&&e.push({x:t,y:i});return e.length}roomOnScreen(e){const t=x.TILESIZE,i=(this.roomX-2)*t,s=(this.roomX+this.width+2)*t,a=(this.roomY-2)*t,n=(this.roomY+this.height+2)*t,c=e.x*t,l=e.y*t,d=c-e.drawX+.5*t-.5*x.WIDTH-this.game.screenShakeX,u=l-e.drawY+.5*t-.5*x.HEIGHT-this.game.screenShakeY,h=x.WIDTH,f=x.HEIGHT,p=d,y=d+h,g=u,w=u+f,b=!(s<p||i>y||n<g||a>w);this.onScreen=b}setReverb(){const e=this.roomArea;e<10?this.changeReverb("res/SFX/impulses/small.mp3"):e<55?this.changeReverb("res/SFX/impulses/medium.mp3"):this.changeReverb("res/SFX/impulses/large.mp3")}getEmptyWall(){var t,i,s,a;const e=[];for(let n=this.roomX+1;n<this.roomX+this.width-1;n++)for(let c=this.roomY-1;c<this.roomY+this.height-1;c++){const l=this.roomArray[n][c];(l instanceof et||l instanceof kt)&&(l instanceof ot||[(t=this.roomArray[n+1])==null?void 0:t[c],(i=this.roomArray[n-1])==null?void 0:i[c],(s=this.roomArray[n])==null?void 0:s[c+1],(a=this.roomArray[n])==null?void 0:a[c-1]].some(h=>h instanceof ot)||e.push(l))}return e}removeEmptyWall(e){if(!(e instanceof et))return null;const{x:t,y:i}=e;return this.roomArray[t][i]=new bt(this,t,i),this.innerWalls.length,this.innerWalls=this.innerWalls.filter(s=>s!==e),this.innerWalls.length,{x:t,y:i}}placeVendingMachineInWall(e){let t=this.getEmptyWall();if(t=t.filter(c=>{const l=c.wallInfo();return l&&!l.isInnerWall}),t.length===0)return;const i=m.randTable(t,O.rand);if(!i)return;const s=this.removeEmptyWall(i);if(!s)return;const{x:a,y:n}=s;this.addVendingMachine(O.rand,a,n,e)}}class mo extends dt{constructor(t,i,s){super(t,i,s);r(this,"count");r(this,"onUse",t=>{this.teleportToExit(t)});r(this,"teleportToExit",t=>{let i=this.level.game.rooms.filter(a=>a.type===R.DOWNLADDER);console.log("downLadders",i);const s=i[i.length-1];this.level.game.rooms.forEach(a=>{a.entered=!0,a.calculateWallInfo()}),s.game.changeLevelThroughDoor(t,s.doors[0],1),t.x=s.roomX+2,t.y=s.roomY+3;try{t.map.updateSeenTiles(),t.map.saveMapData()}catch{}});r(this,"getDescription",()=>"YOU SHOULD NOT HAVE THIS");this.count=0,this.tileX=31,this.tileY=0,this.stackable=!0}}class js extends Et{constructor(t,i,s){super(t,i,s);r(this,"weaponMove",(t,i)=>this.checkForPushables(t,i)?!0:!this.executeAttack(t,i));r(this,"degrade",()=>{});this.tileX=22,this.tileY=0,this.name="dagger",this.description="A basic but dependable weapon."}}r(js,"itemName","dagger");class ir extends Et{constructor(t,i,s){super(t,i,s);r(this,"hitDelay");r(this,"hitSound",()=>{H.hit(),H.playShortSlice()});r(this,"weaponMove",(t,i)=>{let s={x:t,y:i},a={x:t,y:i},n=[s,a];switch(this.wielder.direction){case E.DOWN:s.x=t-1,a.x=t+1;break;case E.UP:s.x=t+1,a.x=t-1;break;case E.LEFT:s.y=i+1,a.y=i-1;break;case E.RIGHT:s.y=i-1,a.y=i+1;break}if(this.checkForPushables(t,i))return!0;const c=this.executeAttack(t,i,!0,1,!0,!0,!0,!1);if(c){for(const l of n)this.game.rooms[this.wielder.levelID].roomArray[l.x][l.y].isSolid()||this.hitEntitiesAt(l.x,l.y,1);this.game.rooms[this.wielder.levelID].tick(this.wielder)}return!c});r(this,"shakeScreen",()=>{setTimeout(()=>{switch(this.wielder.direction){case E.DOWN:this.game.shakeScreen(0,-5,!1);break;case E.UP:this.game.shakeScreen(0,-5,!1);break;case E.LEFT:this.game.shakeScreen(-5,-5,!1);break;case E.RIGHT:this.game.shakeScreen(5,-5,!1);break}},this.hitDelay)});this.tileX=28,this.tileY=2,this.damage=1,this.name="sword",this.degradeable=!1,this.useCost=2,this.offsetY=-.5}}r(ir,"itemName","sword");const ta=class ta extends dt{constructor(t,i,s){super(t,i,s);r(this,"useOnOther",(t,i)=>{i.name==="gold ring"&&i.embed(t,this)});r(this,"getDescription",()=>"An amber gem. Embed it into a gold ring to imbue it with magic.");this.tileX=14,this.tileY=0,this.name=ta.itemName,this.canUseOnOther=!0,this.stackable=!0}};r(ta,"itemName","amber");let qs=ta;const P=class P{static get SHADE_ENABLED(){return P.SMOOTH_LIGHTING}};r(P,"VERSION","Alpha v1.2.0"),r(P,"DEVELOPER_MODE",!1),r(P,"isMobile",!1),r(P,"isIOS",!1),r(P,"CAMERA_SPEED",1),r(P,"FPS",120),r(P,"ALPHA_ENABLED",!0),r(P,"SHADE_LEVELS",50),r(P,"ENTITY_SHADE_LEVELS",40),r(P,"TILESIZE",16),r(P,"SCALE",null),r(P,"SOFT_SCALE",6),r(P,"MAX_SCALE",16),r(P,"MIN_SCALE",1),r(P,"smoothScaling",!1),r(P,"SWIPE_THRESH",25**2),r(P,"HOLD_THRESH",250),r(P,"KEY_REPEAT_TIME",250),r(P,"SWIPE_HOLD_REPEAT_TIME",200),r(P,"SWIPE_HOLD_INITIAL_DELAY",10),r(P,"MOVEMENT_COOLDOWN",200),r(P,"MOVEMENT_QUEUE_COOLDOWN",100),r(P,"MOVE_WITH_MOUSE",!0),r(P,"SLOW_INPUTS_NEAR_ENEMIES",!1),r(P,"CHAT_APPEAR_TIME",1e3),r(P,"CHAT_FADE_TIME",250),r(P,"ANIMATION_SPEED",1),r(P,"REPLAY_STEP_MS",10),r(P,"REPLAY_COMPUTER_TURN_DELAY",10),r(P,"REPLAY_DEBUG",!1),r(P,"DEFAULTWIDTH",P.TILESIZE),r(P,"DEFAULTHEIGHT",P.TILESIZE),r(P,"WIDTH",q.SCREEN_W*P.TILESIZE),r(P,"HEIGHT",q.SCREEN_H*P.TILESIZE),r(P,"drawOtherRooms",!0),r(P,"SCRIPT_FONT_SIZE",16),r(P,"FONT_SIZE",7),r(P,"BIG_FONT_SIZE",15),r(P,"RED","#ac3232"),r(P,"WARNING_RED","#ff0000"),r(P,"GREEN","#6abe30"),r(P,"ARMOR_GREY","#9badb7"),r(P,"OUTLINE","#222034"),r(P,"HIT_ENEMY_TEXT_COLOR","#76428a"),r(P,"HEALTH_BUFF_COLOR","#d77bba"),r(P,"MISS_COLOR","#639bff"),r(P,"XP_POPUP_ENABLED",!0),r(P,"COIN_ANIMATION",!0),r(P,"COIN_AUTO_PICKUP",!0),r(P,"PERSISTENT_HEALTH_BAR",!1),r(P,"HOVER_TEXT_ENABLED",!0),r(P,"INVENTORY_HOVER_TEXT_ENABLED",!0),r(P,"IN_GAME_HOVER_TEXT_ENABLED",!1),r(P,"VENDING_MACHINE_HOVER_TEXT_ENABLED",!0),r(P,"HOVER_TEXT_FOLLOWS_MOUSE",!0),r(P,"INVENTORY_HOVER_TEXT_FOLLOWS_MOUSE",!0),r(P,"IN_GAME_HOVER_TEXT_FOLLOWS_MOUSE",!0),r(P,"VENDING_MACHINE_HOVER_TEXT_FOLLOWS_MOUSE",!0),r(P,"CUSTOM_SHADER_COLOR_ENABLED",!1),r(P,"COLOR_LAYER_COMPOSITE_OPERATION","soft-light"),r(P,"SHADE_LAYER_COMPOSITE_OPERATION","source-over"),r(P,"SHADE_INLINE_IN_ENTITY_LAYER",!0),r(P,"USE_OPTIMIZED_SHADING",!1),r(P,"SMOOTH_LIGHTING",!1),r(P,"ctxBlurEnabled",!0),r(P,"BLUR_ENABLED",!0),r(P,"USE_WEBGL_BLUR",!1),r(P,"HIGH_QUALITY_BLUR",!1),r(P,"BLUR_DOWNSAMPLE_FACTOR",8),r(P,"ENEMIES_BLOCK_LIGHT",!1),r(P,"USE_PNG_LEVELS",!0),r(P,"SHADE_LAYER_COMPOSITE_OPERATIONS",["source-over","screen","multiply","overlay","darken","lighten"]),r(P,"COLOR_LAYER_COMPOSITE_OPERATIONS",["soft-light","overlay","multiply"]),r(P,"SET_COLOR_LAYER_COMPOSITE_OPERATION",(e=!1)=>{const t=P.COLOR_LAYER_COMPOSITE_OPERATIONS.indexOf(P.COLOR_LAYER_COMPOSITE_OPERATION);let i;e?i=(t-1+P.COLOR_LAYER_COMPOSITE_OPERATIONS.length)%P.COLOR_LAYER_COMPOSITE_OPERATIONS.length:i=(t+1)%P.COLOR_LAYER_COMPOSITE_OPERATIONS.length,P.COLOR_LAYER_COMPOSITE_OPERATION=P.COLOR_LAYER_COMPOSITE_OPERATIONS[i],console.log(`Color layer composite operation set to ${P.COLOR_LAYER_COMPOSITE_OPERATION}`)}),r(P,"SET_SHADE_LAYER_COMPOSITE_OPERATION",(e=!1)=>{const t=P.SHADE_LAYER_COMPOSITE_OPERATIONS.indexOf(P.SHADE_LAYER_COMPOSITE_OPERATION);let i;e?i=(t-1+P.SHADE_LAYER_COMPOSITE_OPERATIONS.length)%P.SHADE_LAYER_COMPOSITE_OPERATIONS.length:i=(t+1)%P.SHADE_LAYER_COMPOSITE_OPERATIONS.length,P.SHADE_LAYER_COMPOSITE_OPERATION=P.SHADE_LAYER_COMPOSITE_OPERATIONS[i],console.log(`Shade layer composite operation set to ${P.SHADE_LAYER_COMPOSITE_OPERATION}`)}),r(P,"TOGGLE_USE_OPTIMIZED_SHADING",()=>{P.USE_OPTIMIZED_SHADING=!P.USE_OPTIMIZED_SHADING}),r(P,"TOGGLE_ENEMIES_BLOCK_LIGHT",()=>{P.ENEMIES_BLOCK_LIGHT=!P.ENEMIES_BLOCK_LIGHT}),r(P,"TOGGLE_USE_WEBGL_BLUR",()=>{P.USE_WEBGL_BLUR=!P.USE_WEBGL_BLUR,console.log(`WebGL blur is now ${P.USE_WEBGL_BLUR?"enabled":"disabled"}`)}),r(P,"TOGGLE_HIGH_QUALITY_BLUR",()=>{P.HIGH_QUALITY_BLUR=!P.HIGH_QUALITY_BLUR,console.log(`High quality blur: ${P.HIGH_QUALITY_BLUR?"ON (49 samples)":"OFF (13 samples)"}`)}),r(P,"SET_SCALE",()=>{P.SCALE++,P.SCALE>P.MAX_SCALE&&(P.SCALE=P.MAX_SCALE)}),r(P,"INCREASE_SCALE",()=>{P.SCALE<P.MAX_SCALE&&(P.SCALE++,P.SCALE>P.MAX_SCALE&&(P.SCALE=P.MAX_SCALE))}),r(P,"DECREASE_SCALE",()=>{P.SCALE>P.MIN_SCALE&&(P.SCALE--,P.SCALE<P.MIN_SCALE&&(P.SCALE=P.MIN_SCALE))}),r(P,"FIND_SCALE",e=>{let t=P.MIN_SCALE,i=1/0;const a=(!e||screen.orientation.type==="landscape-primary"?window.innerHeight:window.innerWidth)*window.devicePixelRatio,n=e?8:12;for(let c=P.MIN_SCALE;c<=P.MAX_SCALE;c++){const l=a/(c*P.TILESIZE),d=Math.abs(l-n);d<i&&(i=d,t=c)}return t}),r(P,"STARTING_INVENTORY",[js,ii]),r(P,"STARTING_DEV_INVENTORY",[js,si,ir,we,mo,Qe,Je,Wt,hs,Ke,Ne,Ne,ze,qs,ce,_e,ls,At,At,At,At,At,At,At,At,At,At,At,At]);let x=P;class $h{static getParameters(e){return{minRoomCount:(e>0,0),maxRoomCount:e>0?12:6,maxRoomArea:e>0?120+10*e:40,mapWidth:25+5*e,mapHeight:25+5*e,splitProbabilities:[.75,1,.25],wallRemoveProbability:e>0?.1:1,numLoopDoorsRange:[4,8],numberOfRooms:e>0?5:3,softMaxRoomArea:e>0?.5*(120+10*e):40}}}class Cs extends mt{constructor(t,i,s,a){super(t,i,s,a);r(this,"draw",t=>{this.dead||(m.ctx.save(),m.ctx.globalAlpha=this.alpha,this.dead||(this.updateDrawXY(t),this.hasShadow&&this.drawShadow(t),m.drawObj(this.tileX,this.tileY,2,2,this.x-this.drawX-.5,this.y-this.drawYOffset-this.drawY,2,2,this.room.shadeColor,this.shadeAmount())),m.ctx.restore())});r(this,"drawTopLayer",t=>{this.drawableY=this.y});this.room=t,this.health=1,this.tileX=19,this.tileY=2,this.hasShadow=!0,this.chainPushable=!1,this.name="bush",this.imageParticleX=0,this.imageParticleY=28,this.opaque=!0,this.hitSound=H.playBush}get type(){return gt.PROP}}class ua extends dt{constructor(t,i,s){super(t,i,s);r(this,"onUse",t=>{t.health<t.maxHealth&&(t.health=Math.min(t.maxHealth,t.health+.5),H.playEat(),this.stackCount>1?this.stackCount--:t.inventory.removeItem(this),t.game.pushMessage("You eat the mushrooms and feel better."))});r(this,"getDescription",()=>`SHROOMS
I don't think I should eat these...`);this.tileX=6,this.tileY=0,this.stackable=!0}}r(ua,"itemName","mushrooms");class Qi extends mt{constructor(t,i,s,a){super(t,i,s,a);r(this,"draw",t=>{this.dead||(m.ctx.save(),m.ctx.globalAlpha=this.alpha,this.dead||(this.hasShadow&&this.drawShadow(t),this.updateDrawXY(t),m.drawObj(this.tileX,this.tileY,1,2,this.x-this.drawX,this.y-this.drawYOffset-this.drawY,1,2,this.room.shadeColor,this.shadeAmount())),m.ctx.restore())});r(this,"drawTopLayer",t=>{this.drawableY=this.y});this.room=t,this.health=1,this.tileX=9,this.tileY=2,this.hasShadow=!0,this.chainPushable=!1,this.name="mushrooms",this.imageParticleX=0,this.imageParticleY=30,this.drops.push(new ua(this.room,this.x,this.y))}get type(){return gt.PROP}}class Ji extends mt{constructor(t,i,s,a){super(t,i,s,a);r(this,"draw",t=>{this.dead||(m.ctx.save(),m.ctx.globalAlpha=this.alpha,this.dead||(this.hasShadow&&this.drawShadow(t),this.updateDrawXY(t),m.drawObj(this.tileX,this.tileY,1,2,this.x-this.drawX,this.y-this.drawYOffset-this.drawY,1,2,this.room.shadeColor,this.shadeAmount())),m.ctx.restore())});r(this,"drawTopLayer",t=>{this.drawableY=this.y});this.room=t,this.health=1,this.tileX=11,this.tileY=0,this.hasShadow=!0,this.chainPushable=!1,this.name="pot",this.hitSound=H.potSmash,this.imageParticleX=0,this.imageParticleY=29,O.rand()<.025?this.drops.push(new ue(this.room,this.x,this.y)):this.drops.push(new ct(this.room,this.x,this.y))}get type(){return gt.PROP}}class Ir extends mt{constructor(t,i,s,a){super(t,i,s,a);r(this,"draw",t=>{this.dead||(m.ctx.save(),m.ctx.globalAlpha=this.alpha,this.dead||(this.hasShadow&&this.drawShadow(t),this.updateDrawXY(t),m.drawObj(this.tileX,this.tileY,1,2,this.x-this.drawX,this.y-this.drawYOffset-this.drawY,1,2,this.room.shadeColor,this.shadeAmount())),m.ctx.restore())});r(this,"drawTopLayer",t=>{this.drawableY=this.y});this.room=t,this.health=1,this.tileX=15,this.tileY=2,this.hasShadow=!0,this.chainPushable=!1,this.name="pumpkin",this.drops.push(new ii(this.room,this.x,this.y)),this.imageParticleX=0,this.imageParticleY=25,this.bloomColor="#FFA500",this.hasBloom=!0,this.bloomAlpha=1,this.softBloomAlpha=0,this.lightSource=new Vt(this.x+.5,this.y+.5,5,[200,30,1],3),this.addLightSource(this.lightSource)}get type(){return gt.PROP}}class vr extends mt{constructor(t,i,s,a){super(t,i,s,a);r(this,"draw",t=>{this.dead||(m.ctx.save(),m.ctx.globalAlpha=this.alpha,this.dead||(this.hasShadow&&this.drawShadow(t),this.updateDrawXY(t),m.drawObj(this.tileX,this.tileY,1,2,this.x-this.drawX,this.y-this.drawYOffset-this.drawY,1,2,this.room.shadeColor,this.shadeAmount())),m.ctx.restore())});r(this,"drawTopLayer",t=>{this.drawableY=this.y});this.room=t,this.health=1,this.tileX=17,this.tileY=2,this.hasShadow=!0,this.chainPushable=!1,this.name="sprout",this.imageParticleX=0,this.imageParticleY=28}get type(){return gt.PROP}}class Ar extends mt{constructor(t,i,s,a){super(t,i,s,a);r(this,"draw",t=>{this.dead||(m.ctx.save(),m.ctx.globalAlpha=this.alpha,this.dead||(this.hasShadow&&this.drawShadow(t),this.updateDrawXY(t),m.drawObj(this.tileX,this.tileY,1,2,this.x-this.drawX,this.y-this.drawYOffset-this.drawY,1,2,this.room.shadeColor,this.shadeAmount())),m.ctx.restore())});r(this,"drawTopLayer",t=>{this.drawableY=this.y});this.room=t,this.health=1,this.tileX=1,this.tileY=4,this.hasShadow=!0,this.pushable=!0,this.name="deco block",this.imageParticleX=3,this.imageParticleY=25}get type(){return gt.PROP}}class po extends mt{constructor(t,i,s,a){super(t,i,s,a);r(this,"draw",t=>{this.dead||(m.ctx.save(),m.ctx.globalAlpha=this.alpha,this.dead||(this.hasShadow&&this.drawShadow(t),this.updateDrawXY(t),m.drawObj(this.tileX,this.tileY,1,2,this.x-this.drawX,this.y-this.drawYOffset-this.drawY,1,2,this.room.shadeColor,this.shadeAmount())),m.ctx.restore())});r(this,"drawTopLayer",t=>{this.drawableY=this.y});this.room=t,this.health=1,this.tileX=2,this.tileY=4,this.hasShadow=!0,this.chainPushable=!1,this.name="furnace",this.drops.push(new si(this.room,this.x,this.y)),this.imageParticleX=0,this.imageParticleY=25,this.bloomColor="#FFA500",this.hasBloom=!0,this.bloomAlpha=1,this.softBloomAlpha=0,this.lightSource=new Vt(this.x+.5,this.y+.5,7,[200,30,1],4),this.addLightSource(this.lightSource)}get type(){return gt.PROP}}class go extends Ks{constructor(e,t,i,s){super(e,t,i,s),this.room=e,this.health=2,this.tileX=8,this.tileY=4,this.hasShadow=!1,this.chainPushable=!1,this.name="obsidian",O.rand()<.2&&this.drops.push(new Se(this.room,this.x,this.y))}}const Za=new Map([[Bt,1],[fe,2],[te,3],[_t,4],[Mt,5],[Ft,6],[Gt,7],[Pt,8],[Ct,9],[Nt,10],[Xt,11],[Lt,12],[Ut,13],[Jt,14],[Dt,15],[be,16],[he,17],[Le,18],[Ye,19]]);class Zh{constructor(e){r(this,"type");r(this,"skin");this.type=e,this.skin=this.type}}class oi{static add(){}}const Zi={[F.DUNGEON]:{props:[{class:Ge,weight:1},{class:We,weight:1},{class:Re,weight:.01,additionalParams:[1]},{class:Re,weight:.01,additionalParams:[0]},{class:Ir,weight:.05},{class:ci,weight:1},{class:Ji,weight:1},{class:Gs,weight:1},{class:Qi,weight:.1},{class:Cs,weight:.1},{class:vr,weight:.025},{class:Ot,weight:.025},{class:Ar,weight:.05},{class:po,weight:.05}],enemies:[{class:Bt,weight:1,minDepth:0},{class:te,weight:1.2,minDepth:0},{class:_t,weight:1,minDepth:0},{class:he,weight:1,minDepth:2},{class:be,weight:1,minDepth:2},{class:Le,weight:1,minDepth:1},{class:Mt,weight:.1,minDepth:1},{class:Gt,weight:.6,minDepth:1},{class:Pt,weight:.6,minDepth:1},{class:Ct,weight:.8,minDepth:1},{class:Lt,weight:.7,minDepth:1},{class:Ft,weight:.5,minDepth:2},{class:Nt,weight:.1,minDepth:2,specialSpawnLogic:"clearFloor",size:{w:2,h:2}},{class:Xt,weight:.2,minDepth:2},{class:Ut,weight:.1,minDepth:2,specialSpawnLogic:"clearFloor",size:{w:2,h:2}},{class:Jt,weight:.1,minDepth:2},{class:Dt,weight:.5,minDepth:2},{class:Ye,weight:.1,minDepth:2,specialSpawnLogic:"clearFloor",size:{w:2,h:2}}]},[F.CAVE]:{props:[{class:oi,weight:1},{class:Qs,weight:1},{class:Js,weight:.1},{class:tr,weight:.05},{class:ci,weight:.2},{class:Pi,weight:.4},{class:Qi,weight:.3},{class:Ji,weight:.2},{class:Ot,weight:.1}],enemies:[{class:Bt,weight:1.5,minDepth:0},{class:he,weight:1.2,minDepth:1},{class:_t,weight:.8,minDepth:0},{class:Ft,weight:1,minDepth:2},{class:Ct,weight:.6,minDepth:1},{class:Mt,weight:.5,minDepth:1},{class:Nt,weight:.15,minDepth:2,specialSpawnLogic:"clearFloor",size:{w:2,h:2}},{class:Dt,weight:.7,minDepth:2}]},[F.FOREST]:{props:[{class:oi,weight:2},{class:Re,weight:.035,additionalParams:[1]},{class:Re,weight:.035,additionalParams:[0]},{class:Ir,weight:.05},{class:Cs,weight:2},{class:vr,weight:.05},{class:Qi,weight:.2},{class:Pi,weight:.1},{class:Ot,weight:.05},{class:pi,weight:.05},{class:fa,weight:.1}],enemies:[{class:pi,weight:1.5,minDepth:0},{class:fe,weight:.25,minDepth:0},{class:Bt,weight:.3,minDepth:0},{class:te,weight:.2,minDepth:0},{class:_t,weight:.1,minDepth:0},{class:Mt,weight:.4,minDepth:1},{class:Ye,weight:.1,minDepth:2,specialSpawnLogic:"clearFloor",size:{w:2,h:2}}]},[F.DESERT]:{props:[{class:oi,weight:2},{class:We,weight:8},{class:Re,weight:5,additionalParams:[1]},{class:Re,weight:2,additionalParams:[0]},{class:ci,weight:5},{class:Qi,weight:.5},{class:Cs,weight:.25},{class:Ji,weight:.15},{class:Pi,weight:.05},{class:Ot,weight:.05}],enemies:[{class:te,weight:1.8,minDepth:0},{class:fe,weight:1.5,minDepth:1},{class:be,weight:1,minDepth:2},{class:Ct,weight:1.2,minDepth:1},{class:Bt,weight:.8,minDepth:0},{class:_t,weight:1,minDepth:0},{class:he,weight:.6,minDepth:0},{class:Dt,weight:.8,minDepth:2},{class:Mt,weight:.3,minDepth:1}]},[F.GLACIER]:{props:[{class:oi,weight:2},{class:ci,weight:20},{class:Ge,weight:5},{class:Pi,weight:.6},{class:Ot,weight:.4}],enemies:[{class:Bt,weight:1,minDepth:0},{class:Ft,weight:1.2,minDepth:2},{class:Lt,weight:1,minDepth:1},{class:Ut,weight:.15,minDepth:2,specialSpawnLogic:"clearFloor",size:{w:2,h:2}},{class:Ct,weight:.8,minDepth:1},{class:Dt,weight:.9,minDepth:2},{class:Gt,weight:.7,minDepth:1},{class:Pt,weight:.7,minDepth:1},{class:Nt,weight:.1,minDepth:2,specialSpawnLogic:"clearFloor",size:{w:2,h:2}}]},[F.CASTLE]:{props:[{class:oi,weight:1},{class:Ge,weight:10},{class:We,weight:8},{class:ci,weight:6},{class:Gs,weight:.4},{class:Ji,weight:.3},{class:Ot,weight:.2}],enemies:[{class:Lt,weight:2,minDepth:0},{class:Ut,weight:.2,minDepth:2,specialSpawnLogic:"clearFloor",size:{w:2,h:2}},{class:Le,weight:1.5,minDepth:0},{class:Gt,weight:1,minDepth:0},{class:Pt,weight:1,minDepth:0},{class:Xt,weight:.5,minDepth:0},{class:Ct,weight:.25,minDepth:0},{class:Dt,weight:.25,minDepth:0},{class:Mt,weight:.1,minDepth:0},{class:Jt,weight:.1,minDepth:0},{class:Ft,weight:.1,minDepth:0}]},[F.DARK_CASTLE]:{props:[{class:oi,weight:2},{class:Ge,weight:6},{class:We,weight:4},{class:Ot,weight:.15},{class:Ar,weight:2}],enemies:[{class:Gt,weight:1.2,minDepth:1},{class:Pt,weight:1.2,minDepth:1},{class:Lt,weight:1.6,minDepth:1},{class:Xt,weight:.35,minDepth:2},{class:Mt,weight:.4,minDepth:1},{class:Jt,weight:.35,minDepth:2},{class:Ut,weight:.15,minDepth:2,specialSpawnLogic:"clearFloor",size:{w:2,h:2}},{class:Dt,weight:.8,minDepth:2}]},[F.PLACEHOLDER]:{props:[{class:oi,weight:1}],enemies:[]},[F.MAGMA_CAVE]:{props:[{class:oi,weight:1},{class:go,weight:.5},{class:Ot,weight:.05}],enemies:[{class:Ct,weight:.8,minDepth:1},{class:Pt,weight:.6,minDepth:1},{class:Mt,weight:.1,minDepth:1},{class:Lt,weight:.7,minDepth:1},{class:Gt,weight:.6,minDepth:1},{class:Dt,weight:.7,minDepth:2},{class:Ut,weight:.3,minDepth:2,specialSpawnLogic:"clearFloor",size:{w:2,h:2}},{class:Nt,weight:.35,minDepth:2,specialSpawnLogic:"clearFloor",size:{w:2,h:2}},{class:Pt,weight:.5,minDepth:2},{class:Ft,weight:.5,minDepth:2},{class:Jt,weight:.9,minDepth:2},{class:be,weight:.5,minDepth:2},{class:Xt,weight:.25,minDepth:2},{class:he,weight:.5,minDepth:2}]}};class zh{constructor(e,t={}){r(this,"room");r(this,"options");r(this,"placedPositions",[]);r(this,"availableTiles",[]);this.room=e,this.options={falloffExponent:t.falloffExponent??2,baseScore:t.baseScore??.1,maxInfluenceDistance:t.maxInfluenceDistance??10,useSeedPosition:t.useSeedPosition??!1,seedPosition:t.seedPosition??{x:0,y:0}}}generateClusteredPositions(e){if(this.placedPositions=[],this.availableTiles=this.getAvailableTiles(),this.availableTiles.length===0)return[];if(this.options.useSeedPosition&&this.isValidPosition(this.options.seedPosition))this.placePosition(this.options.seedPosition);else if(this.availableTiles.length>0){const t=Math.floor(O.rand()*this.availableTiles.length),i=this.availableTiles.splice(t,1)[0];this.placedPositions.push(i)}for(let t=1;t<e&&this.availableTiles.length>0;t++){const i=this.selectNextPosition();if(i)this.placePosition(i);else break}return[...this.placedPositions]}getAvailableTiles(){return this.room.getEmptyTiles().map(t=>({x:t.x,y:t.y}))}isValidPosition(e){return this.availableTiles.some(t=>t.x===e.x&&t.y===e.y)}placePosition(e){this.placedPositions.push(e),this.availableTiles=this.availableTiles.filter(t=>!(t.x===e.x&&t.y===e.y))}selectNextPosition(){if(this.availableTiles.length===0)return null;const e=this.availableTiles.map(a=>({position:a,score:this.calculateTileScore(a)})),t=e.reduce((a,n)=>a+n.score,0);if(t<=0){const a=Math.floor(O.rand()*this.availableTiles.length);return this.availableTiles.splice(a,1)[0]}const i=O.rand()*t;let s=0;for(const a of e)if(s+=a.score,s>=i)return a.position;return e[e.length-1].position}calculateTileScore(e){let t=this.options.baseScore;for(const i of this.placedPositions){const s=this.calculateDistance(e,i);if(s<=this.options.maxInfluenceDistance){const a=1/Math.pow(s,this.options.falloffExponent);t+=a}}return t}calculateDistance(e,t){const i=e.x-t.x,s=e.y-t.y;return Math.sqrt(i*i+s*s)}}class Kh extends oe{constructor(t,i,s,a){super(t,s,a);r(this,"game");r(this,"opened");r(this,"isSolid",()=>!this.opened);r(this,"canCrushEnemy",()=>!this.opened);r(this,"isOpaque",()=>!this.opened);r(this,"draw",t=>{m.drawTile(1,0,1,1,this.x,this.y,1,1,this.room.shadeColor,this.shadeAmount()),this.opened?m.drawTile(15,1,1,1,this.x,this.y,1,1,this.room.shadeColor,this.shadeAmount()):m.drawTile(3,this.skin,1,1,this.x,this.y,1,1,this.room.shadeColor,this.shadeAmount())});r(this,"drawAbovePlayer",t=>{this.opened?m.drawTile(14,0,1,1,this.x,this.y-1,1,1,this.room.shadeColor,this.shadeAmount()):m.drawTile(13,0,1,1,this.x,this.y-1,1,1,this.room.shadeColor,this.shadeAmount())});this.game=i,this.opened=!1}}class Qh extends oe{constructor(t,i,s,a){super(t,i,s);r(this,"w");r(this,"h");r(this,"pressed");r(this,"turnsSincePressed");r(this,"linkedDoor");r(this,"press",()=>{this.pressed=!0,this.linkedDoor.opened=!0});r(this,"unpress",()=>{this.pressed=!1,this.linkedDoor.opened=!1});r(this,"onCollide",t=>{this.press()});r(this,"onCollideEnemy",t=>{this.press()});r(this,"tickEnd",()=>{this.unpress();for(const t in this.room.game.players)this.room.game.players[t].x===this.x&&this.room.game.players[t].y===this.y&&this.press();for(const t of this.room.entities)t.x===this.x&&t.y===this.y&&this.press()});r(this,"draw",t=>{m.drawTile(1,0,1,1,this.x,this.y,1,1,this.room.shadeColor,this.shadeAmount()),this.pressed?m.drawTile(18,0,1,1,this.x,this.y,this.w,this.h,this.room.shadeColor,this.shadeAmount()):m.drawTile(17,0,1,1,this.x,this.y,this.w,this.h,this.room.shadeColor,this.shadeAmount())});this.w=1,this.h=1,this.pressed=!1,this.turnsSincePressed=1,this.linkedDoor=a}}class Jh{constructor(e){r(this,"items");this.items=e}destroyOtherItems(e){for(const t of this.items)t!==e&&t.destroy();e.level.game.pushMessage(`You choose to keep the ${e.name}.`)}}class $s extends dt{constructor(t,i,s){super(t,i,s);r(this,"onUse",t=>{t.health<t.maxHealth&&(t.health=Math.min(t.maxHealth,t.health+1),H.playEat(),this.stackCount>1?this.stackCount--:t.inventory.removeItem(this),t.game.pushMessage("You eat the fish and feel better."))});r(this,"getDescription",()=>`FISH
Looks spiky.`);this.tileX=5,this.tileY=2,this.stackable=!0,this.animateToInventory=!0}}r($s,"itemName","fish");class yo extends mt{constructor(t,i,s,a){super(t,i,s,a);r(this,"fishCount",0);r(this,"active",!1);r(this,"startFrame",0);r(this,"fish",t=>{if(!t.inventory.canFish()){this.game.pushMessage("You need a fishing rod to fish.");return}if(!this.active){this.game.pushMessage("There aren't any fish here.");return}this.game.pushMessage("Fishing..."),t.busyAnimating=!0,t.setHitXY(this.x,this.y,.5),H.playFishingCast(),setTimeout(()=>{let i="";if(H.playFishingReel(),this.tryFish()){t.inventory.addItem(new $s(this.room,this.x,this.y))===!1&&this.room.items.push(new $s(this.room,t.x,t.y)),i="You catch a fish.",H.playFishingCatch();let a=1.5**this.room.depth,n=Math.ceil((O.rand()*50+100)*a);$e.increaseXp(n),this.room.particles.push(new na(this.room,this.x,this.y,n)),this.fishCount--,this.fishCount<=0&&(this.active=!1)}else i="You don't catch anything.";this.room.game.pushMessage(i),t.busyAnimating=!1},1200),this.room.tick(t)});r(this,"tryFish",()=>O.rand()<.3);r(this,"interact",t=>{this.fish(t)});r(this,"draw",t=>{this.dead||!this.active||(this.startFrame!==0&&(this.frame=this.startFrame,this.startFrame=0),this.frame+=.12*t,this.frame>=9&&(this.frame=0),m.drawFX(23+Math.floor(this.frame),0,1,1,this.x-this.drawX,this.y-this.drawY,1,1,this.room.shadeColor,this.shadeAmount()))});r(this,"drawTopLayer",t=>{this.drawableY=this.y});this.room=t,this.health=1,this.tileX=11,this.tileY=0,this.hasShadow=!1,this.chainPushable=!1,this.name="fishing spot",this.fishCount=Math.floor(O.rand()*6)-3,this.active=this.fishCount>0,this.startFrame=Math.floor(O.rand()*9),this.imageParticleX=0,this.imageParticleY=29,this.destroyable=!1,this.interactable=!0,O.rand()<.025?this.drops.push(new ue(this.room,this.x,this.y)):this.drops.push(new ct(this.room,this.x,this.y))}get type(){return gt.PROP}}class ns extends oe{constructor(t,i,s,a,n,c,l){super(t,i,s);r(this,"tileX");r(this,"tileY");r(this,"topEdge");r(this,"interact",()=>{this.room.game.pushMessage("You jump into the pool.")});r(this,"isSolid",()=>!0);r(this,"canCrushEnemy",()=>!0);r(this,"draw",t=>{m.drawTile(1,this.skin,1,1,this.x,this.y,1,1,this.room.shadeColor,this.shadeAmount()),this.topEdge&&m.drawTile(22,3,1,2,this.x,this.y,1,2,this.room.shadeColor,this.shadeAmount()),m.drawTile(this.tileX,this.tileY,1,1,this.x,this.y,1,1,this.room.shadeColor,this.shadeAmount())});this.tileX=this.skin===1?24:20,this.tileY=4,a?this.tileX--:n&&this.tileX++,c?this.tileY--:l&&this.tileY++,this.topEdge=c,(n||a||c||l)&&this.room.entities.push(new yo(this.room,this.room.game,this.x,this.y))}}class tl extends oe{constructor(t,i,s,a,n,c,l){super(t,i,s);r(this,"tileX");r(this,"tileY");r(this,"topEdge");r(this,"interact",()=>{this.room.game.pushMessage("You jump into the pool.")});r(this,"isSolid",()=>!0);r(this,"canCrushEnemy",()=>!0);r(this,"draw",t=>{m.drawTile(1,this.skin,1,1,this.x,this.y,1,1,this.room.shadeColor,this.shadeAmount()),this.topEdge&&m.drawTile(22,3,1,2,this.x,this.y,1,2,this.room.shadeColor,this.shadeAmount()),m.drawTile(this.tileX,this.tileY,1,1,this.x,this.y,1,1,this.room.shadeColor,this.shadeAmount())});this.tileX=24,this.tileY=4,a?this.tileX--:n&&this.tileX++,c?this.tileY--:l&&this.tileY++,this.topEdge=c;const d=new Vt(this.x+.5,this.y+.5,.5,[200,50,0],3);this.room.lightSources.push(d),this.hasBloom=!0,this.bloomColor="#641900",this.bloomAlpha=1}}class ks extends et{constructor(t,i,s,a){super(t,i,s);r(this,"frame");r(this,"tileYOffset");r(this,"isBottomWall");r(this,"lightSource");r(this,"isSolid",()=>!0);r(this,"canCrushEnemy",()=>!0);r(this,"isOpaque",()=>{const t=this.room.wallInfo.get(`${this.x},${this.y}`);return t?!t.isTopWall&&!t.isInnerWall||t.isLeftWall||t.isRightWall:!0});r(this,"draw",t=>{this.drawWall(t);const i=this.room.wallInfo.get(`${this.x},${this.y}`);i||(this.tileYOffset=6),this.frame+=.3*t,this.frame>=12&&(this.frame=0),this.tileYOffset=(i==null?void 0:i.innerWallType)==="bottomInner"||(i==null?void 0:i.innerWallType)==="surroundedInner"?0:6,this.isBottomWall||m.drawTile(0,this.skin,1,1,this.x,this.y,1,1,this.room.shadeColor,this.shadeAmount()),this.isBottomWall&&m.drawTile(0,this.skin,1,1,this.x,this.y-.6,1,1,this.room.shadeColor,1)});this.isBottomWall=a,this.lightSource=new Vt(this.x+.5,this.y+.5,20,[135,206,235],3),this.room.lightSources.push(this.lightSource),this.hasBloom=!0,this.bloomColor="#00FFFF",this.bloomAlpha=1,this.softBloomAlpha=0}}const za={};for(const[o,e]of Za.entries())za[e]=o.name;class el{constructor(e,t=!1){r(this,"level");r(this,"medianDensity");r(this,"props",[]);r(this,"addedDownladder",!1);r(this,"levelEnemyPoolIds");r(this,"skipPopulation",!1);r(this,"populateRooms",()=>{if(this.skipPopulation)return;this.level.rooms.forEach(t=>{this.addEnvironmentalFeatures(t,O.rand)});for(let t of this.level.rooms)this.populate(t,O.rand);this.level.rooms.forEach(t=>{t.type===R.START||t.type===R.DOWNLADDER||t.type===R.UPLADDER||t.type===R.ROPEHOLE||t.type===R.ROPECAVE||this.populateByEnvironment(t)});const e=this.level.getFurthestFromLadder("up");e&&!this.level.isMainPath&&this.populateBoss(e,O.rand),this.level.depth!==0&&(console.log(`Adding downladder with ${this.numRooms()} rooms`),this.level.environment.type===F.DUNGEON&&this.addDownladder({caveRooms:this.numRooms(),locked:!0,linearity:1}),this.level.environment.type===F.CAVE&&this.addDownladder({caveRooms:this.numRooms(),locked:!0,envType:F.MAGMA_CAVE,linearity:1}),this.level.environment.type===F.FOREST&&this.addDownladder({caveRooms:this.numRooms(),locked:!0,envType:F.CASTLE,linearity:.8}),this.level.environment.type===F.CASTLE&&this.addDownladder({caveRooms:this.numRooms(),locked:!0,envType:F.DARK_CASTLE,linearity:.8}),this.linkExitToStart())});r(this,"populateByEnvironment",e=>{switch(e.envType){case F.CAVE:this.populateCaveEnvironment(e);break;case F.FOREST:this.populateForestEnvironment(e);break;case F.MAGMA_CAVE:this.populateMagmaCaveEnvironment(e);break;case F.CASTLE:this.populateCastleEnvironment(e);break;default:this.populateDefaultEnvironment(e);break}});r(this,"linkExitToStart",()=>{if(console.log("linkExitToStart",this.level.isMainPath),this.level.isMainPath)return;this.level.setExitRoom(!1),this.level.setStartRoom(!1);const e=this.level.exitRoom,t=this.level.startRoom;!t||!e||t.linkExitToStart(e)});r(this,"addTrainingDownladder",e=>{if(this.level.depth!==0)return;const t=this.level.rooms.find(n=>n.type===R.START);if(!t)return;const i=t.getEmptyTilesNotBlockingDoors();if(i.length===0){console.warn("No valid positions for training downladder that don't block doors");return}const s=t.getRandomEmptyPosition(i);if(s===null||s.x===void 0||s.y===void 0)return;const a=new wt(t,this.level.game,s.x,s.y,!0,F.DUNGEON,De.NONE,e,{lockType:De.NONE});t.roomArray[s.x][s.y]=a});r(this,"addDownladder",e=>{const t=this.level.rooms.filter(d=>d.type!==R.START&&d.type!==R.DOWNLADDER&&d.type!==R.UPLADDER&&d.type!==R.ROPEHOLE&&d.type!==R.BOSS),i=this.level.isMainPath?t[Math.floor(O.rand()*t.length)]:this.level.getFurthestFromLadder("up");console.log(`Selected room for downladder: Type=${i.type}, Doors=${i.doors.length}`);const s=i.getEmptyTilesNotBlockingDoors();if(s.length===0){console.warn("No valid positions for downladder that don't block doors");return}const a=i.getRandomEmptyPosition(s);if(a===null||a.x===void 0||a.y===void 0)return;console.log(`Placing downladder at position (${a.x}, ${a.y})`);const n=e!=null&&e.envType?e.envType:i.depth<2||i.depth>2&&O.rand()<.5?F.FOREST:F.CAVE,c=e&&typeof e.locked=="boolean"?{lockType:e.locked?De.LOCKED:De.NONE}:void 0,l=new wt(i,this.level.game,a.x,a.y,!0,n,De.NONE,e,c);i.roomArray[a.x][a.y]=l,l.lockable.isLocked()&&(console.log("adding key to downladder"),this.level.distributeKey(l))});r(this,"populateByType",e=>{});r(this,"numRooms",()=>{const t=Math.ceil(10*1.05**this.level.depth)-this.level.rooms.length;return Math.max(t,5)});r(this,"populateEmpty",(e,t)=>{});r(this,"populateTreasure",(e,t)=>{this.addChests(e,10,t)});r(this,"populateDungeon",(e,t)=>{m.rand(1,36,t)<=6&&this.placeVendingMachineInWall(e),e.removeDoorObstructions()});r(this,"populateBoss",(e,t)=>{this.addBosses(e,e.depth)});r(this,"populateBigDungeon",(e,t)=>{e.removeDoorObstructions()});r(this,"populateSpawner",(e,t)=>{Ee.add(e,e.game,Math.floor(e.roomX+e.width/2),Math.floor(e.roomY+e.height/2)),e.removeDoorObstructions()});r(this,"populatePuzzle",(e,t)=>{let i;for(let l=e.roomX;l<e.roomX+e.width;l++){let d=e.roomY+Math.floor(e.height/2);l===e.roomX+Math.floor(e.width/2)?(i=new Kh(e,e.game,l,d+1),e.roomArray[l][d+1]=i):e.roomArray[l][d]=new et(e,l,d)}let s=m.rand(e.roomX,e.roomX+e.width-1,t),a=m.rand(e.roomY+Math.floor(e.height/2)+3,e.roomY+e.height-2,t);e.roomArray[s][a]=new Qh(e,s,a,i);let n=e.getEmptyTiles().filter(l=>l.x>=e.roomX+1&&l.x<=e.roomX+e.width-2&&l.y>=e.roomY+Math.floor(e.height/2)+3&&l.y<=e.roomY+e.height-2),c=m.randTable([1,2,2,3,4],t);for(let l=0;l<c;l++){let d=n.splice(m.rand(0,n.length-1,t),1)[0];d&&e.entities.push(new Ge(e,e.game,d.x,d.y))}e.removeDoorObstructions()});r(this,"populateSpikeCorridor",(e,t)=>{for(let i=e.roomX;i<e.roomX+e.width;i++)for(let s=e.roomY+1;s<e.roomY+e.height-1;s++)e.roomArray[i][s]=new rt(e,i,s,m.rand(0,3,t));e.removeDoorObstructions()});r(this,"populateCave",(e,t)=>{m.rand(1,36,t);let i=e.getEmptyTiles().length,s=Math.ceil(i*m.randTable([.25,.3,.35],t));e.level.environment.type===F.CAVE&&this.addResources(e,(i-s)*m.randTable([.1,.2,.3],t),t),e.removeDoorObstructions()});r(this,"populateUpLadder",(e,t)=>{const{x:i,y:s}=e.getRoomCenter();e.roomArray[i-1][s-1]=new le(e,e.game,i-1,s-1)});r(this,"populateDownLadder",(e,t)=>{const{x:i,y:s}=e.getRoomCenter();e.roomArray[i+1][s-1]=new wt(e,e.game,i+1,s-1);const a=Math.ceil(O.rand()*5);let n=e.getEmptyTiles();n=n.filter(c=>c.x!==i||c.y!==s);for(let c=0;c<a;c++)if(n.length>0){const l=e.getRandomEmptyPosition(n);if(l===null)break;const{x:d,y:u}=l;let h=new Ot(e,e.game,d,u);h.getDrop(["consumable","gem","light","tool","fuel","backpack","weapon","coin"],!1),n.filter(f=>f.x!==d&&f.y!==u),e.entities.push(h)}e.depth===0&&this.populateWeaponGroup(e,n)});r(this,"populateWeaponGroup",(e,t)=>{const i=e.getRandomEmptyPosition(t),s=e.getRandomEmptyPosition(t,i),a=e.getRandomEmptyPosition(t,s),n=new Jh([new we(e,i.x,i.y),new ms(e,s.x,s.y),new ir(e,a.x,a.y)]);for(const c of n.items)c.grouped=!0,c.group=n,e.items.push(c)});r(this,"populateRopeHole",(e,t)=>{const{x:i,y:s}=e.getRoomCenter(),a=e.depth<1?F.FOREST:F.CAVE;let n=new wt(e,e.game,i,s,!0,a);setTimeout(()=>{e.roomArray[i][s]=n},0)});r(this,"populateRopeCave",(e,t)=>{let i="";switch(e.envType){case F.CAVE:i="Cave";break;case F.MAGMA_CAVE:i="Magma Cave";break;case F.FOREST:i="Forest";break;case F.CASTLE:i="Castle"}e.name=i;const{x:s,y:a}=e.getRoomCenter();let n=new le(e,e.game,s,a);n.isRope=!0,n.isSidePath=!0,e.roomArray[s][a]=n,e.envType===F.CAVE?this.placeVendingMachineInWall(e,new Ne(e,0,0)):this.placeVendingMachineInWall(e),e.removeDoorObstructions()});r(this,"populateShop",(e,t)=>{this.addTorches(e,2,t);const{x:i,y:s}=e.getRoomCenter();ut.add(e,e.game,i-2,s-1,new er(e,0,0)),ut.add(e,e.game,i+2,s-1,new ue(e,0,0)),ut.add(e,e.game,i-2,s+2,new Wt(e,0,0)),ut.add(e,e.game,i+2,s+2,new we(e,0,0)),e.removeDoorObstructions()});r(this,"addTorchesByArea",e=>{let t=Math.max(1,Math.floor(Math.sqrt(e.roomArea)/3)-Math.floor(Math.sqrt(e.depth)));if(e.depth===0)O.rand()<.25&&(t=0);else{const s=.9*(1-Math.exp(-.4*(e.depth-1)));O.rand()<s&&(t=0)}this.addTorches(e,t,O.rand)});r(this,"addWindowsByArea",e=>{(e.envType===F.CASTLE||e.level.environment.type===F.CASTLE)&&(Math.max(0,Math.floor(Math.sqrt(e.roomArea)/4)-Math.floor(Math.sqrt(e.depth))),e.depth===0&&O.rand()<.15)});r(this,"populate",(e,t)=>{switch(e.name="",e.type){case R.START:e.depth!==0&&(this.populateUpLadder(e,t),this.placeVendingMachineInWall(e)),this.populateEmpty(e,t),e.name="FLOOR "+-e.depth;break;case R.BOSS:this.populateBoss(e,t),e.name="BOSS";break;case R.DUNGEON:e.level.environment.type===F.CAVE&&O.rand()<=.2?this.populateCave(e,t):this.populateDungeon(e,t);break;case R.BIGDUNGEON:this.populateBigDungeon(e,t);break;case R.PUZZLE:this.populatePuzzle(e,t);break;case R.SPIKECORRIDOR:this.populateSpikeCorridor(e,t);break;case R.TREASURE:this.populateTreasure(e,t);break;case R.GRASS:this.populateDungeon(e,t);break;case R.BIGCAVE:this.populateCave(e,t);case R.CAVE:this.populateCave(e,t);break;case R.UPLADDER:this.populateUpLadder(e,t),e.name="FLOOR "+-e.depth;break;case R.DOWNLADDER:this.populateDownLadder(e,t),e.name="FLOOR "+-e.depth;break;case R.ROPEHOLE:this.populateRopeHole(e,t);break;case R.ROPECAVE:this.populateRopeCave(e,t);break;case R.SHOP:this.populateShop(e,t);break;case R.SPAWNER:this.populateSpawner(e,t);break}e.message=e.name});this.level=e,this.props=[],this.medianDensity=G.MEDIAN_ROOM_DENSITY,this.levelEnemyPoolIds=this.generateEnemyPoolIds(this.level.depth)}addProps(e,t,i){const s=i?Zi[i]:Zi[e.level.environment.type];let a=e.getEmptyTiles();for(let n=0;n<t&&a.length!==0;n++){const c=e.getRandomEmptyPosition(a);if(c===null)break;const{x:l,y:d}=c,u=Q.randTableWeighted(s.props);if(u&&u.class&&u.class.add){const h=u.additionalParams||[];u.class.add(e,e.game,l,d,...h)}}}addPropsWithClustering(e,t,i,s){const a=i?Zi[i]:Zi[e.level.environment.type],c=new zh(e,s).generateClusteredPositions(t);for(const{x:l,y:d}of c){const u=Q.randTableWeighted(a.props);if(u&&u.class&&u.class.add){const h=u.additionalParams||[];u.class.add(e,e.game,l,d,...h)}}}populateDungeonEnvironment(e){this.populateDefaultEnvironment(e)}populateCaveEnvironment(e){const t=this.getNumProps(e);this.addPropsWithClustering(e,t,e.envType,{falloffExponent:2,baseScore:.1,maxInfluenceDistance:12,useSeedPosition:!1}),this.addRandomEnemies(e)}populateForestEnvironment(e){const t=this.getNumProps(e,.75);this.addPropsWithClustering(e,t,e.envType,{falloffExponent:2,baseScore:.1,maxInfluenceDistance:12,useSeedPosition:!1}),this.addRandomEnemies(e)}populateMagmaCaveEnvironment(e){const t=this.getNumProps(e);this.addPropsWithClustering(e,t,e.envType,{falloffExponent:2,baseScore:.1,maxInfluenceDistance:12,useSeedPosition:!1}),this.addRandomEnemies(e)}populateCastleEnvironment(e){const t=this.getNumProps(e);this.addPropsWithClustering(e,t,e.envType,{falloffExponent:2,baseScore:.1,maxInfluenceDistance:12,useSeedPosition:!1}),this.addRandomEnemies(e)}getNumProps(e,t){t=t||this.medianDensity;const i=e.getEmptyTiles().length;return Q.randomNormalInt(0,i,{median:Math.ceil(t*i)})}populateDefaultEnvironment(e){const t=this.getNumProps(e);this.addPropsWithClustering(e,t,e.envType,{falloffExponent:2,baseScore:.1,maxInfluenceDistance:12,useSeedPosition:!1}),this.addRandomEnemies(e)}addDoorTorches(e,t,i,s){var a,n;if(!(s!==E.UP&&s!==E.DOWN)&&t&&i){e.calculateWallInfo();const c=e.wallInfo.get(`${t-1},${i}`),l=e.wallInfo.get(`${t+1},${i}`);(a=e.roomArray[t-1])==null||a[i],(n=e.roomArray[t+1])==null||n[i];const d=(c==null?void 0:c.isLeftWall)===!1,u=(l==null?void 0:l.isRightWall)===!1,h=s===E.DOWN;d&&(e.roomArray[t-1][i]=new kt(e,t-1,i,h)),u&&(e.roomArray[t+1][i]=new kt(e,t+1,i,h))}}addTorches(e,t,i,s,a){var u;if(e.level.environment.type===F.FOREST&&e.type!==R.DOWNLADDER)return;if(s!==void 0&&a!==void 0&&((u=e.roomArray[s])==null?void 0:u[a])instanceof et){e.roomArray[s][a]=new kt(e,s,a);return}let n=[];for(let h=e.roomX+1;h<e.roomX+e.width-2;h++)for(let f=e.roomY;f<e.roomY+e.height-1;f++)e.roomArray[h][f]instanceof et&&!(e.roomArray[h][f+1]instanceof et)&&n.push(e.roomArray[h][f]);let c=[];for(let h=e.roomX+1;h<e.roomX+e.width-2;h++){const f=e.roomY+e.height-1;e.roomArray[h][f]instanceof et&&!(e.roomArray[h][f+1]instanceof et)&&c.push(e.roomArray[h][f])}const l=m.rand(0,t,i),d=t-l;for(let h=0;h<l&&n.length!=0;h++){const f=m.rand(0,n.length-1,i),p=n.splice(f,1)[0],y=p.x,g=p.y;e.roomArray[y][g]=new kt(e,y,g)}for(let h=0;h<d&&c.length!=0;h++){const f=m.rand(0,c.length-1,i),p=c.splice(f,1)[0],y=p.x,g=p.y;e.roomArray[y][g]=new kt(e,y,g,!0)}}addDoorWindows(e,t,i,s){var a,n;if(!(s!==E.UP&&s!==E.DOWN)&&t&&i){e.calculateWallInfo();const c=e.wallInfo.get(`${t-1},${i}`),l=e.wallInfo.get(`${t+1},${i}`),d=(c==null?void 0:c.isLeftWall)===!1,u=(l==null?void 0:l.isRightWall)===!1,h=s===E.DOWN;d&&((a=e.roomArray[t-1])==null?void 0:a[i])instanceof et&&(e.roomArray[t-1][i]=new ks(e,t-1,i,h)),u&&((n=e.roomArray[t+1])==null?void 0:n[i])instanceof et&&(e.roomArray[t+1][i]=new ks(e,t+1,i,h))}}addWindows(e,t,i,s,a){var h;if(!(e.envType===F.CASTLE||e.level.environment.type===F.CASTLE))return;if(s!==void 0&&a!==void 0&&((h=e.roomArray[s])==null?void 0:h[a])instanceof et){e.roomArray[s][a]=new ks(e,s,a);return}let c=[];for(let f=e.roomX+1;f<e.roomX+e.width-2;f++)for(let p=e.roomY;p<e.roomY+e.height-1;p++)e.roomArray[f][p]instanceof et&&!(e.roomArray[f][p+1]instanceof et)&&c.push(e.roomArray[f][p]);let l=[];for(let f=e.roomX+1;f<e.roomX+e.width-2;f++){const p=e.roomY+e.height-1;e.roomArray[f][p]instanceof et&&!(e.roomArray[f][p+1]instanceof et)&&l.push(e.roomArray[f][p])}const d=m.rand(0,t,i),u=t-d;for(let f=0;f<d&&c.length!==0;f++){const p=m.rand(0,c.length-1,i),y=c.splice(p,1)[0],g=y.x,w=y.y;e.roomArray[g][w]=new ks(e,g,w)}for(let f=0;f<u&&l.length!==0;f++){const p=m.rand(0,l.length-1,i),y=l.splice(p,1)[0],g=y.x,w=y.y;e.roomArray[g][w]=new ks(e,g,w,!0)}}addRectangularTileArea(e,t,i){let s=m.rand(2,4,t),a=m.rand(2,4,t),n=e.roomX+2,c=e.roomX+e.width-s-2,l=e.roomY+2,d=e.roomY+e.height-a-2;if(c<n||d<l)return;let u=m.rand(n,c,t),h=m.rand(l,d,t),f=!0;for(let p=u-1;p<u+s+1;p++)for(let y=h-1;y<h+a+1;y++){const g=e.roomArray[p][y];(g instanceof $t&&!g.isSolid()||g instanceof ns||g instanceof Ci)&&(f=!1)}if(f?console.log("space for "+i.name):console.warn("no space for "+i.name),!!f)for(let p=u-1;p<u+s+1;p++)for(let y=h-1;y<h+a+1;y++)if(p===u-1||p===u+s||y===h-1||y===h+a){const g=e.roomArray[p][y];!(g instanceof $t&&!g.isSolid())&&!(g instanceof et)&&!(g instanceof ns)&&!(g instanceof Ci)&&(e.roomArray[p][y]=new bt(e,p,y))}else e.roomArray[p][y]=new i(e,p,y,p===u,p===u+s-1,y===h,y===h+a-1)}addChasms(e,t){this.addRectangularTileArea(e,t,Ci)}addMagmaPools(e,t){this.addRectangularTileArea(e,t,tl)}addPools(e,t){this.addRectangularTileArea(e,t,ns)}addSpikeTraps(e,t,i){if(e.level.environment.type===F.FOREST||e.envType===F.FOREST)return;let s=e.getEmptyTiles();for(let a=0;a<t;a++){const n=e.getRandomEmptyPosition(s);if(n===null)break;const{x:c,y:l}=n;e.roomArray[c][l]=new rt(e,c,l)}}addEnemiesUnified(e,t,i){if(G.NO_ENEMIES===!0)return;const s=this.getAvailableEnemiesForRoom(e,i);if(s.length===0){console.log(`No enemies available for environment ${i||e.level.environment.type} at depth ${e.depth}`);return}this.spawnEnemiesFromPool(e,t,s),this.addSpecialEnemies(e)}getAvailableEnemiesForRoom(e,t){const i=t||e.level.environment.type,s=Zi[i],a=this.levelEnemyPoolIds,n=s.enemies.map(c=>({...c,id:Za.get(c.class)})).filter(c=>c.id&&a.includes(c.id)&&(c.minDepth??0)<=e.depth);return console.log(`Depth ${e.depth}, Env ${i}: Pool [${a.map(c=>za[c]||`Unknown(${c})`).join(", ")} ] -> Available [${n.map(c=>za[c.id]||`Unknown(${c.id})`).join(", ")}]`),n}spawnEnemiesFromPool(e,t,i){var n;let s=e.getEmptyTiles();if(s.length===0)return;const a=new Set;for(const c of e.doors)for(let l=-2;l<=2;l++)for(let d=-2;d<=2;d++)a.add(`${c.x+l},${c.y+d}`);s=s.filter(c=>!a.has(`${c.x},${c.y}`));for(let c=0;c<t&&s.length!==0;c++){const l=e.getRandomEmptyPosition(s);if(l===null)break;const{x:d,y:u}=l,h=Q.randTableWeighted(i);if(!((n=h==null?void 0:h.class)!=null&&n.add))continue;const f=h.additionalParams||[];if(h.specialSpawnLogic==="clearFloor"){const p=new h.class(e,e.game,d,u,...f);this.canPlaceBigEnemy(e,p,d,u,s)?(e.entities.push(p),this.clearFloorForBigEnemy(e,d,u,p.w,p.h,p),this.removeTilesForEnemy(s,d,u,p.w,p.h)):t++}else h.class.add(e,e.game,d,u,...f),s=s.filter(p=>!(p.x===d&&p.y===u))}console.log(`Spawned ${t} enemies from pool for total empty tiles ${s.length}`)}addSpecialEnemies(e){e.depth>G.SPAWNER_MIN_DEPTH&&this.addSpawners(e,O.rand),e.depth>G.OCCULTIST_MIN_DEPTH&&this.addOccultists(e,O.rand)}generateEnemyPoolIds(e){const t=this.level.environment.type,a=Zi[t].enemies.map(h=>({id:Za.get(h.class),minDepth:h.minDepth??0})).filter(h=>typeof h.id=="number"&&h.minDepth<=e).map(h=>h.id).filter(h=>!this.level.game.encounteredEnemies.includes(h)),n=Math.min(a.length,G.NEW_ENEMIES_PER_LEVEL),c=this.getRandomElements(a,n);this.level.game.encounteredEnemies.push(...c);const l=this.level.game.encounteredEnemies.slice(),d=this.getNumberOfEnemyTypes(e),u=this.getRandomElements(l,d);return Array.from(new Set(u)).slice(0,d)}getEnemyPoolForDepth(e){return e===this.level.depth?this.levelEnemyPoolIds:this.generateEnemyPoolIds(e)}getNumberOfEnemyTypes(e){return e===0?G.DEPTH_ZERO_ENEMY_TYPES:Math.ceil(Math.sqrt(e+1))+G.ENEMY_TYPES_BASE_COUNT}getRandomElements(e,t){const i=[...e];for(let s=i.length-1;s>0;s--){const a=Math.floor(O.rand()*(s+1));[i[s],i[a]]=[i[a],i[s]]}return i.slice(0,Math.min(t,i.length))}canPlaceBigEnemy(e,t,i,s,a){var n;if(t.x+t.w>e.roomX+e.width||t.y+t.h>e.roomY+e.height||t.x<e.roomX||t.y<e.roomY)return!1;for(let c=0;c<t.w;c++)for(let l=0;l<t.h;l++){const d=(n=e.roomArray[i+c])==null?void 0:n[s+l];if((d.x===i+c||d.y===s+l)&&d.isSolid())return console.log("wall found"),!1}return!0}clearFloorForBigEnemy(e,t,i,s,a,n){for(let c=0;c<s;c++)for(let l=0;l<a;l++)e.roomArray[t+c][i+l]=new bt(e,t+c,i+l),e.entities.some(d=>d.x===t+c&&d.y===i+l)&&(e.entities=e.entities.filter(d=>d.x!==t+c&&d.y!==i+l||d===n))}removeTilesForEnemy(e,t,i,s,a){for(let n=0;n<s;n++)for(let c=0;c<a;c++){const l=e.findIndex(d=>d.x===t+n&&d.y===i+c);l!==-1&&e.splice(l,1)}}addRandomEnemies(e,t=1){const i=e.getEmptyTiles().length,s=(e.roomArea+i)/2,a=Math.min((e.depth+G.ENEMY_DENSITY_DEPTH_OFFSET)*G.ENEMY_DENSITY_DEPTH_MULTIPLIER,G.MAX_ENEMY_DENSITY),n=Math.ceil(Math.max(Q.randomNormalInt(0,s*a),s*a)),c=Math.min(n,i);this.addEnemiesUnified(e,c*t,e.envType)}addSpawners(e,t,i){let s=e.getEmptyTiles();if(s.length===0)return;let a=null;if(i!==void 0)for(let n=0;n<i;n++){const c=e.getRandomEmptyPosition(s);if(c===null)break;const{x:l,y:d}=c,u=this.getEnemyPoolForDepth(Math.max(0,e.depth)).filter(h=>h!==7);a=Ee.add(e,e.game,l,d,u),s=s.filter(h=>!(h.x===l&&h.y===d))}else{const n=Math.ceil(e.roomArea/G.SPAWNER_AREA_THRESHOLD);for(let c=0;c<n;c++){if(t()>G.SPAWNER_SPAWN_CHANCE)continue;const l=e.getRandomEmptyPosition(s);if(l===null)break;const{x:d,y:u}=l,h=this.getEnemyPoolForDepth(Math.max(0,e.depth-1)).filter(f=>f!==7);a=Ee.add(e,e.game,d,u,h),s=s.filter(f=>!(f.x===d&&f.y===u))}}return a}addOccultists(e,t,i){let s=e.getEmptyTiles();if(s.length===0)return;let a=null;if(i!==void 0)for(let n=0;n<i;n++){const c=e.getRandomEmptyPosition(s);if(c===null)break;const{x:l,y:d}=c;a=He.add(e,e.game,l,d),s=s.filter(u=>!(u.x===l&&u.y===d))}else{const n=Math.ceil(e.roomArea/G.OCCULTIST_AREA_THRESHOLD);for(let c=0;c<n;c++){if(t()>G.OCCULTIST_SPAWN_CHANCE)continue;const l=e.getRandomEmptyPosition(s);if(l===null)break;const{x:d,y:u}=l;a=He.add(e,e.game,d,u),s=s.filter(h=>!(h.x===d&&h.y===u))}}return a}addBosses(e,t){if(G.NO_ENEMIES===!0)return;let i=e.getEmptyTiles();if(i.length!==0){let s=["reaper","queen","bigskullenemy","bigzombieenemy","bigfrogenemy","exalter"];t>0&&(s.push("occultist"),s=s.filter(d=>d!=="queen")),e.envType===F.FOREST&&s.push("bigfrogenemy"),t>4&&(s.push("warden"),s=s.filter(d=>d!=="bigskullenemy"&&d!=="bigzombieenemy"&&d!=="occultist"));const a=m.randTable(s,O.rand);console.log("bosses",s,"boss",a);const n=a.startsWith("big")||a==="warden"?e.getBigRandomEmptyPosition(i):e.getRandomEmptyPosition(i);if(n===null)return;const{x:c,y:l}=n;switch(a){case"reaper":const d=this.addSpawners(e,O.rand,1);d.dropTable=["weapon","equipment"],d.dropChance=1;break;case"queen":const u=Xt.add(e,e.game,c,l);u.dropTable=["weapon","equipment"],u.dropChance=1;break;case"bigskullenemy":const h=Nt.add(e,e.game,c,l);h.dropTable=["weapon","equipment","consumable","gem","tool"];break;case"occultist":const f=this.addOccultists(e,O.rand,1);f.dropTable=["weapon","equipment"],f.dropChance=1;break;case"bigzombieenemy":const p=mi.add(e,e.game,c,l);p.dropTable=["weapon","equipment","consumable","gem","tool"],p.dropChance=1;break;case"warden":const y=Yi.add(e,e.game,c,l);y.dropTable=["weapon","equipment"],y.dropChance=1;break;case"bigfrogenemy":const g=Ye.add(e,e.game,c,l);g.dropTable=["weapon","equipment","consumable","gem","tool"];break;case"exalter":const w=wi.add(e,e.game,c,l);w.dropTable=["weapon","equipment"],w.dropChance=1;break}}}addChests(e,t,i){let s=e.getEmptyTiles();for(let a=0;a<t;a++){const n=e.getRandomEmptyPosition(s);if(!n)break;const{x:c,y:l}=n;e.entities.push(new Ot(e,e.game,c,l))}}addBombs(e,t,i){let s=e.getEmptyTiles();for(let a=0;a<e.getEmptyTiles().length;a++){const n=e.getRandomEmptyPosition(s);if(n===null)break;const{x:c,y:l}=n;ui.add(e,e.game,c,l)}}addResources(e,t,i){let s=e.getEmptyTiles();for(let a=0;a<t;a++){const n=e.getRandomEmptyPosition(s);if(n===null)break;const{x:c,y:l}=n;let d=i();d<=(10-e.depth**3)/10?Qs.add(e,e.game,c,l):d<=(10-(e.depth-2)**3)/10?Js.add(e,e.game,c,l):tr.add(e,e.game,c,l)}}addVendingMachine(e,t,i,s,a){const n=e.getRandomEmptyPosition(e.getEmptyTiles());if(n===null)return;let c=i||n.x,l=s||n.y,d=e.depth>0?[1,1,1,1,1,2,2,2,2,2,2,1,1,1,2,2,1,1,3,4,5,5,5,5,5,6,6,6,6,6,6,6,6,6,7,7,7,7,7,7,7,7,7]:[1,1,1],u=m.randTable(d,t);if(a){ut.add(e,e.game,c,l,a);return}switch(u){case 1:ut.add(e,e.game,c,l,new ue(e,c,l));break;case 2:ut.add(e,e.game,c,l,new ii(e,c,l));break;case 3:ut.add(e,e.game,c,l,new Wt(e,c,l));break;case 4:ut.add(e,e.game,c,l,new we(e,c,l));break;case 5:ut.add(e,e.game,c,l,new si(e,c,l));break;case 6:ut.add(e,e.game,c,l,new Je(e,c,l));break;case 7:ut.add(e,e.game,c,l,new Ke(e,c,l));break}}addRandomTorches(e,t="medium"){const i={none:[0,0,0],low:[0,0,0,1,1],medium:[0,0,0,1,1,2,2,3],high:[1,1,2,2,3,3,4]},s=m.randTable(i[t],O.rand);this.addTorches(e,s,O.rand)}addRandomWindows(e,t="medium"){const i={none:[0,0,0],low:[0,0,0,1,1],medium:[0,0,0,1,1,2,2,3],high:[1,1,2,2,3,3,4]};m.randTable(i[t],O.rand)}addEnvironmentalFeatures(e,t){const i=m.rand(1,36,t);switch(e.type){case R.START:e.depth!==0||this.addTorchesByArea(e);break;case R.BOSS:const s=e.getBossDoor();this.addDoorTorches(e,s.x,s.y,s.doorDir),this.addTorchesByArea(e),this.addSpikeTraps(e,m.randTable([0,0,0,1,1,2,5],t),t);break;case R.DUNGEON:this.level.environment.type===F.CAVE||this.level.environment.type===F.MAGMA_CAVE||this.level.environment.type===F.FOREST?i<20&&e.builder.addWallBlocksVariant(t):i<20&&e.builder.addWallBlocks(t),e.envType!==F.CASTLE&&(i<12&&this.addPools(e,t),i<12&&this.addChasms(e,t),i<12&&e.depth>5&&this.addMagmaPools(e,t)),this.addTorchesByArea(e),this.addWindowsByArea(e),i>15&&this.addSpikeTraps(e,m.randTable([0,0,0,1,1,2,3],t),t);break;case R.BIGDUNGEON:i<5&&e.builder.addWallBlocks(t),m.rand(1,4,t)===1&&this.addChasms(e,t),this.addTorchesByArea(e),m.rand(1,3,t)===1&&this.addSpikeTraps(e,m.randTable([3,5,7,8],t),t);break;case R.CAVE:this.level.environment.type===F.CAVE||this.level.environment.type===F.MAGMA_CAVE||this.level.environment.type===F.FOREST?i<20&&e.builder.addWallBlocksVariant(t):i<20&&e.builder.addWallBlocks(t),e.envType!==F.CASTLE&&(i<12&&this.addChasms(e,t),i<12&&this.addPools(e,t),i<12&&e.depth>5&&this.addMagmaPools(e,t)),this.level.environment.type===F.CASTLE&&this.addTorchesByArea(e),this.addWindowsByArea(e);break;case R.BIGCAVE:i>15&&this.addSpikeTraps(e,m.randTable([0,0,0,1,1,2,5],t),t);break;case R.TREASURE:this.addTorchesByArea(e);break;case R.SPAWNER:this.addTorchesByArea(e);break;case R.UPLADDER:this.addRandomTorches(e,"medium");break;case R.DOWNLADDER:this.addTorches(e,1,t,e.roomX+3,e.roomY);break;case R.ROPEHOLE:this.addRandomTorches(e,"medium");break;case R.SPIKECORRIDOR:this.addRandomTorches(e,"medium");break;case R.SHOP:this.addTorches(e,2,t);break;case R.GRASS:i%4===0&&this.addChasms(e,t),i%3===0&&this.addPools(e,t),this.addTorchesByArea(e),i>15&&this.addSpikeTraps(e,m.randTable([0,0,0,1,1,2,3],t),t);break}}placeVendingMachineInWall(e,t){const i=e.getEmptyWall();if(i.length===0)return;const s=m.randTable(i,O.rand);if(!s)return;const a=e.removeEmptyWall(s);if(!a)return;const{x:n,y:c}=a;this.addVendingMachine(e,O.rand,n,c,t),e.roomArray[n][c]=s}}const il={1:0,2:1,3:0,4:0,5:1,6:2,7:1,8:1,9:1,10:2,11:2,12:1,13:2,14:2,15:2,16:2,17:2,18:3};class An{constructor(e,t,i,s,a=!0,n,c,l=!1){r(this,"globalId");r(this,"depth");r(this,"levelArray");r(this,"width");r(this,"height");r(this,"game");r(this,"rooms");r(this,"roomsById");r(this,"paths",new Map);r(this,"pathsById",new Map);r(this,"environment");r(this,"exitRoom");r(this,"startRoom");r(this,"enemyParameters");r(this,"isMainPath",!0);r(this,"mapGroup");r(this,"populator");r(this,"skipPopulation",!1);r(this,"getLadderRoom",(e,t)=>{for(const i of e.path())if(i.hasLadder(t))return i;return null});r(this,"initializeLevelArray",()=>{this.levelArray=[];for(let e=0;e<this.width;e++){this.levelArray[e]=[];for(let t=0;t<this.height;t++)this.levelArray[e][t]=null}});r(this,"getFurthestFromLadder",e=>{let t=null,i=0;for(const s of this.rooms){const a=s.getDistanceToNearestLadder(e);a&&a>i&&(i=a,t=s)}return t});r(this,"getFurthestFromLadders",e=>{let t=null,i=-1/0;const s=e.path();for(const c of s){const l=c.getDistanceToNearestLadder("up"),d=c.getDistanceToNearestLadder("down"),u=[];if(l!=null&&u.push(l),d!=null&&u.push(d),u.length===0)continue;const h=Math.min(...u);h>i&&(i=h,t=c)}const a=t==null?void 0:t.getDistanceToNearestLadder("up"),n=t==null?void 0:t.getDistanceToNearestLadder("down");return console.log("furthestRoom",t==null?void 0:t.globalId,{up:a,down:n,furthestMinDistance:i}),t});r(this,"loadRoomsIntoLevelArray",()=>{for(let e of this.rooms)for(let t=e.roomX;t<e.roomX+e.width;t++)for(let i=e.roomY;i<e.roomY+e.height;i++)t>=0&&t<this.width&&i>=0&&i<this.height?e.roomArray[t]&&e.roomArray[t][i]?this.levelArray[t][i]=e.roomArray[t][i]:console.warn(`Room array missing tile at (${t}, ${i}) for room ${e.id}`):console.warn(`Room coordinates (${t}, ${i}) are outside level bounds (${this.width}, ${this.height})`)});this.game=e,this.globalId=se.generate("L"),this.depth=t,this.width=i,this.height=s,this.rooms=[],this.roomsById=new Map,this.isMainPath=a,this.initializeLevelArray(),this.mapGroup=n,this.environment=new Zh(c),this.populator=new el(this,l),this.skipPopulation=l,this.enemyParameters=this.getEnemyParameters()}getDownLadder(e){if(!e||e.type!==R.ROPEHOLE)return console.error("Room is not a rope hole"),null;if(e)for(let t=e.roomX;t<e.roomX+e.width;t++)for(let i=e.roomY;i<e.roomY+e.height;i++){const s=e.roomArray[t][i];if(s instanceof wt)return s}return console.error("No down ladder found"),null}getKeyRoom(e){const t=e.path();for(const i of t)if(i.hasKey())return i;return null}distributeKey(e){if(this.skipPopulation)return;const t={disableX:e.x,disableY:e.y,disableRoom:e.room};if(e.room.path().length===0){console.error("No eligible rooms found for key placement");return}const s=this.getFurthestFromLadders(e.room);let a=s.getEmptyTiles();if(t.disableRoom===s&&(a=a.filter(d=>d.x!==t.disableX&&d.y!==t.disableY)),a.length===0){console.error(`No empty tiles found in room ${s.id} for key placement, unlocking downladder ${e.room.id}`,e.lockable.removeLock());return}const n=Math.floor(O.rand()*a.length),c=a[n],l=new Ze(s,c.x,c.y);e.lockable.setKey(l),s.items.push(l)}setExitRoom(e=!0){e?this.exitRoom=this.rooms.find(t=>t.type===R.DOWNLADDER):this.exitRoom=this.getLadderRoom(this.rooms[this.rooms.length-1],"down")}setStartRoom(e=!0){e?this.startRoom=this.rooms.find(t=>t.type===R.START):this.startRoom=this.getLadderRoom(this.rooms[this.rooms.length-1],"up")}setRooms(e){this.rooms=e,this.setExitRoom(),this.setStartRoom(),this.roomsById.clear(),this.paths.clear(),this.pathsById.clear(),e.forEach(t=>{t.id=this.rooms.indexOf(t),this.roomsById.set(t.globalId,t);const i=t.pathId||"main";this.paths.has(i)||this.paths.set(i,[]),this.pathsById.has(i)||this.pathsById.set(i,new Map),this.paths.get(i).push(t),this.pathsById.get(i).set(t.globalId,t)}),this.game.roomsById=new Map(e.map(t=>[t.globalId,t]))}getRoomById(e){return this.roomsById.get(e)}getEnemyParameters(){return{enemyTables:{},maxDepthTable:this.depth,minDepths:il}}setRoomSkins(){for(let e of this.rooms)e.skin=this.environment.skin}}class kn{constructor(e,t=!1){r(this,"game");r(this,"enableDebugMessages");this.game=e,this.enableDebugMessages=t||document.cookie.includes("showgeneration=true")}validateDungeonPartitions(e,t){const i=this.validateNotEmpty(e);if(!i.isValid)return i;const s=this.validateMinimumRoomCount(e,t.minRoomCount);if(!s.isValid)return s;const a=this.validateBossRoomExists(e);if(!a.isValid)return a;const n=this.validateBossRoomDistance(e,3);if(!n.isValid)return n;const c=this.validateNoOverlaps(e);if(!c.isValid)return c;const l=this.validateStairRoomExists(e);return l.isValid?{isValid:!0}:l}validateCavePartitions(e,t){const i=this.validateNotEmpty(e);if(!i.isValid)return i;if(!this.validateMinimumRoomCount(e,t).isValid)return{isValid:!1,errorMessage:`Cave needs at least ${t} rooms, got ${e.length}`,errorType:"INSUFFICIENT_CAVE_ROOMS"};const a=this.validateNoOverlaps(e);if(!a.isValid)return a;const n=this.validateRopeCaveExists(e);return n.isValid?{isValid:!0}:n}validateTutorialPartitions(e){const t=this.validateNotEmpty(e);return t.isValid?e.length!==1?{isValid:!1,errorMessage:`Tutorial should have exactly 1 room, got ${e.length}`,errorType:"INSUFFICIENT_ROOMS"}:e[0].type!==R.TUTORIAL?{isValid:!1,errorMessage:"Tutorial room is not marked with TUTORIAL type",errorType:"INSUFFICIENT_ROOMS"}:{isValid:!0}:t}validateNotEmpty(e){if(!e||e.length===0){const t="No partitions generated";return this.logValidationError(t),{isValid:!1,errorMessage:t,errorType:"EMPTY_PARTITIONS"}}return{isValid:!0}}validateMinimumRoomCount(e,t){if(e.length<t){const i=`Not enough rooms: need ${t}, got ${e.length}`;return this.logValidationError(i),{isValid:!1,errorMessage:i,errorType:"INSUFFICIENT_ROOMS"}}return{isValid:!0}}validateBossRoomExists(e){if(!e.some(i=>i.type===R.BOSS)){const i="Boss room unreachable or missing";return this.logValidationError(i),{isValid:!1,errorMessage:i,errorType:"BOSS_ROOM_MISSING"}}return{isValid:!0}}validateBossRoomDistance(e,t){const i=e.find(s=>s.type===R.BOSS);if(!i)return this.validateBossRoomExists(e);if(i.distance<t){const s=`Boss room too close to spawn: distance ${i.distance}, minimum ${t}`;return this.logValidationError(s),{isValid:!1,errorMessage:s,errorType:"BOSS_TOO_CLOSE"}}return{isValid:!0}}validateNoOverlaps(e){for(let t=0;t<e.length;t++)for(let i=t+1;i<e.length;i++){const s=e[t],a=e[i];if(s.x<a.x+a.w&&s.x+s.w>a.x&&s.y<a.y+a.h&&s.y+s.h>a.y){const n=`Overlapping partitions detected: partition ${t} overlaps with partition ${i}`;return this.logValidationError(n),{isValid:!1,errorMessage:n,errorType:"OVERLAPPING_PARTITIONS"}}}return{isValid:!0}}validateStairRoomExists(e){if(!e.some(i=>i.type===R.DOWNLADDER)){const i="Stair room missing - dungeon cannot be completed";return this.logValidationError(i),{isValid:!1,errorMessage:i,errorType:"STAIR_ROOM_MISSING"}}return{isValid:!0}}validateRopeCaveExists(e){if(!e.some(i=>i.type===R.ROPECAVE)){const i="Rope cave starting room missing";return this.logValidationError(i),{isValid:!1,errorMessage:i,errorType:"INSUFFICIENT_CAVE_ROOMS"}}return{isValid:!0}}validateConnectivity(e){const t=e.filter(i=>i.connections.length===0);if(t.length>0){const i=`Found ${t.length} unconnected rooms`;return this.logValidationError(i),{isValid:!1,errorMessage:i,errorType:"INSUFFICIENT_ROOMS"}}return{isValid:!0}}validateRequiredRoomTypes(e,t){const i=new Set(e.map(a=>a.type)),s=t.filter(a=>!i.has(a));if(s.length>0){const a=`Missing required room types: ${s.join(", ")}`;return this.logValidationError(a),{isValid:!1,errorMessage:a,errorType:"INSUFFICIENT_ROOMS"}}return{isValid:!0}}validatePartitionQuality(e){const i=e.filter(a=>a.w<4||a.h<4);if(i.length>0){const a=`Found ${i.length} partitions smaller than minimum size 4`;return this.logValidationError(a),{isValid:!1,errorMessage:a,errorType:"INSUFFICIENT_ROOMS"}}const s=e.filter(a=>a.w<=0||a.h<=0||a.x<0||a.y<0);if(s.length>0){const a=`Found ${s.length} partitions with invalid dimensions`;return this.logValidationError(a),{isValid:!1,errorMessage:a,errorType:"INSUFFICIENT_ROOMS"}}return{isValid:!0}}logValidationError(e){this.enableDebugMessages&&(console.warn(`[LevelValidator] ${e}`),this.game&&this.game.pushMessage&&this.game.pushMessage(e))}validateWithDetailedReport(e,t,i="dungeon"){const s=[];s.push(`Validating ${i} with ${e.length} partitions`),i==="dungeon"&&(s.push(`Required minimum rooms: ${t.minRoomCount}`),s.push(`Required maximum rooms: ${t.maxRoomCount}`));const a=i==="dungeon"?this.validateDungeonPartitions(e,t):i==="cave"?this.validateCavePartitions(e,8):this.validateTutorialPartitions(e);return a.isValid?s.push("Validation passed"):s.push(`Validation failed: ${a.errorMessage}`),{...a,details:s}}}class sl{constructor(e){r(this,"game");r(this,"animationConfig");r(this,"visualizationState");r(this,"debugMode");this.game=e,this.debugMode=document.cookie.includes("showgeneration=true"),this.animationConfig={partitionSplitDelay:this.debugMode?10:0,pathfindingDelay:this.debugMode?100:0,largeStepDelay:this.debugMode?100:0,animationConstant:1,enabled:this.debugMode},this.visualizationState={currentStep:"initializing",progress:0,partitions:[],centerX:0,centerY:0}}updateAnimationConfig(e){this.animationConfig={...this.animationConfig,...e}}setVisualizationState(e,t,i,s="generating",a=0){this.visualizationState={currentStep:s,progress:a,partitions:e,centerX:t,centerY:i}}draw(e){m.ctx.fillStyle="rgba(0, 0, 0, 1)",m.ctx.fillRect(0,0,x.WIDTH,x.HEIGHT),this.debugMode?this.drawGenerationProgress(e):this.drawSimpleLoadingScreen()}drawGenerationProgress(e){this.visualizationState.partitions.length>0&&(this.visualizationState.partitions.forEach(t=>{this.drawPartition(t,e,this.visualizationState.centerX,this.visualizationState.centerY)}),this.drawProgressInfo())}drawSimpleLoadingScreen(){this.game.drawTextScreen("generating level")}drawPartition(e,t,i,s){m.ctx.fillStyle=e.fillStyle,m.ctx.fillRect(Math.round(x.WIDTH/2+e.x-i),Math.round(x.HEIGHT/2+e.y-s),e.w,e.h),this.drawPartitionConnections(e,i,s),this.debugMode&&this.drawPartitionInfo(e,i,s)}drawPartitionConnections(e,t,i){m.ctx.fillStyle="white";for(let s of e.connections)m.ctx.fillRect(Math.round(x.WIDTH/2+s.x-t),Math.round(x.HEIGHT/2+s.y-i),1,1)}drawPartitionInfo(e,t,i){const s=Math.round(x.WIDTH/2+e.x-t),a=Math.round(x.HEIGHT/2+e.y-i);m.ctx.fillStyle="yellow",m.ctx.font="8px Arial",m.ctx.fillText(`${e.type}`,s+2,a+10),m.ctx.fillText(`D:${e.distance}`,s+2,a+20)}drawProgressInfo(){m.ctx.fillStyle="rgba(0, 0, 0, 0.7)",m.ctx.fillRect(10,10,200,60),m.ctx.fillStyle="white",m.ctx.font="12px Arial",m.ctx.fillText(`Step: ${this.visualizationState.currentStep}`,20,30),m.ctx.fillText(`Partitions: ${this.visualizationState.partitions.length}`,20,45),m.ctx.fillText(`Progress: ${Math.round(this.visualizationState.progress*100)}%`,20,60)}async createAnimationDelay(e){if(!this.animationConfig.enabled)return Promise.resolve();let t=0;switch(e){case"partition":t=this.animationConfig.animationConstant*this.animationConfig.partitionSplitDelay;break;case"pathfinding":t=this.animationConfig.animationConstant*this.animationConfig.pathfindingDelay;break;case"large":t=this.animationConfig.animationConstant*this.animationConfig.largeStepDelay;break}return new Promise(i=>setTimeout(i,t))}updatePartitionStyles(e){const t=[...e].sort((a,n)=>a.area()-n.area());if(t.length===0)return;const i=t[0].area(),s=t[t.length-1].area();e.forEach(a=>{if(a.type==="START")a.fillStyle="rgb(0, 255, 0)";else if(a.type==="BOSS")a.fillStyle="rgb(255, 0, 0)";else if(a.type==="DOWNLADDER")a.fillStyle="blue";else if(a.type==="ROPEHOLE")a.fillStyle="purple";else{const c=.3+(s>i?(a.area()-i)/(s-i):0)*.7;a.fillStyle=`rgba(128, 128, 128, ${c})`}})}visualizePartitionsInConsole(e,t,i){if(!this.debugMode)return;const s=Array.from({length:i},()=>Array(t).fill(" . ")),n=(e.length-1).toString().length;e.forEach((c,l)=>{const d=l.toString().padStart(n," ");for(let u=c.x;u<c.x+c.w;u++)for(let h=c.y;h<c.y+c.h;h++)u>=0&&u<t&&h>=0&&h<i&&(s[h][u]=` ${d} `)}),console.log("Partition Layout:"),console.log("   "+[...Array(t)].map((c,l)=>l%10).join("  ")+" X"),s.forEach((c,l)=>{const d=l.toString().padStart(2," ");console.log(`${d} ${c.join("")}`)}),console.log("Y")}logGenerationStep(e,t){if(!this.debugMode)return;const i=t?`${e}: ${t}`:e;console.log(`[GenerationVisualizer] ${i}`),this.game&&this.game.pushMessage&&this.game.pushMessage(i)}createVisualEffect(e,t){if(this.debugMode)switch(e){case"partition_split":if(t){const i=t.fillStyle;t.fillStyle="yellow",setTimeout(()=>{t.fillStyle=i},200)}break;case"room_connected":t&&(t.fillStyle="lightgreen");break;case"boss_found":t&&(t.fillStyle="rgb(255, 0, 0)"),this.logGenerationStep("Boss room found!");break;case"generation_complete":this.logGenerationStep("Generation complete!");break}}updateProgress(e,t){this.visualizationState.currentStep=e,this.visualizationState.progress=Math.max(0,Math.min(1,t)),this.logGenerationStep(e,`${Math.round(t*100)}%`)}reset(){this.visualizationState={currentStep:"initializing",progress:0,partitions:[],centerX:0,centerY:0}}getAnimationConfig(){return{...this.animationConfig}}getVisualizationState(){return{...this.visualizationState}}}class nt{constructor(e,t,i){r(this,"x");r(this,"y");r(this,"other");this.x=e,this.y=t,this.other=i}}class ye{constructor(e,t,i,s,a){r(this,"x");r(this,"y");r(this,"w");r(this,"h");r(this,"type");r(this,"fillStyle");r(this,"connections");r(this,"distance");r(this,"isTopOpen");r(this,"isRightOpen");r(this,"isBottomOpen");r(this,"isLeftOpen");r(this,"pathIndex");r(this,"split",async()=>{this.isTopOpen=!0,this.isRightOpen=!0,this.isBottomOpen=!0,this.isLeftOpen=!0;let e=()=>(O.rand()-.5)*.6+.5,t=4;if(this.w>this.h){let i=Math.floor(e()*this.w),s=this.w-i-1;return i<t||s<t?[this]:[new ye(this.x,this.y,i,this.h,this.fillStyle),new ye(this.x+i+1,this.y,s,this.h,this.fillStyle)]}else{let i=Math.floor(e()*this.h),s=this.h-i-1;return i<t||s<t?[this]:[new ye(this.x,this.y,this.w,i,this.fillStyle),new ye(this.x,this.y+i+1,this.w,s,this.fillStyle)]}});r(this,"point_in",(e,t)=>e>=this.x&&e<this.x+this.w&&t>=this.y&&t<this.y+this.h);r(this,"point_next_to",(e,t)=>e>=this.x-1&&e<this.x+this.w+1&&t>=this.y&&t<this.y+this.h||e>=this.x&&e<this.x+this.w&&t>=this.y-1&&t<this.y+this.h+1);r(this,"area",()=>this.w*this.h);r(this,"overlaps",e=>e.x<this.x+this.w+1&&e.x+e.w>this.x-1&&e.y<this.y+this.h+1&&e.y+e.h>this.y-1);r(this,"setOpenWall",e=>{e.y===this.y-1&&e.x>=this.x&&e.x<this.x+this.w&&(this.isTopOpen=!1),e.y===this.y+this.h&&e.x>=this.x&&e.x<this.x+this.w&&(this.isBottomOpen=!1),e.x===this.x+this.w&&e.y>=this.y&&e.y<this.y+this.h&&(this.isRightOpen=!1),e.x===this.x-1&&e.y>=this.y&&e.y<this.y+this.h&&(this.isLeftOpen=!1)});r(this,"get_branch_point",()=>{let e=[];for(let t=this.x;t<this.x+this.w;t++)e.push({x:t,y:this.y-1}),e.push({x:t,y:this.y+this.h});for(let t=this.y;t<this.y+this.h;t++)e.push({x:this.x-1,y:t}),e.push({x:this.x+this.w,y:t});return e=e.filter(t=>!this.connections.some(i=>Math.abs(i.x-t.x)+Math.abs(i.y-t.y)<=1)),e.sort(()=>.5-O.rand()),e[0]});this.x=e,this.y=t,this.w=i,this.h=s,this.fillStyle=a,this.type=R.DUNGEON,this.connections=[],this.distance=1e3,this.isTopOpen=!0,this.isRightOpen=!0,this.isBottomOpen=!0,this.isLeftOpen=!0,this.pathIndex=0}}class Ka{constructor(){r(this,"partitions");this.partitions=[]}}class rl{constructor(e){r(this,"validator");r(this,"visualizer");this.validator=new kn(e),this.visualizer=new sl(e)}async generateDungeonPartitions(e,t,i,s,a,n){const c=new Ka;let l,d=0;this.visualizer.updateProgress("Starting dungeon generation",0);do d++,this.visualizer.updateProgress(`Generating candidate ${d}`,d*.1),await this.generateDungeonCandidate(e,c,t,i,s,a,n),l=this.validator.validateDungeonPartitions(c.partitions,a),this.visualizer.setVisualizationState(c.partitions,t/2,i/2,"validating",.8);while(!l.isValid);return this.visualizer.updateProgress("Finalizing generation",.9),await this.visualizer.createAnimationDelay("large"),this.visualizer.createVisualEffect("generation_complete"),this.visualizer.updateProgress("Generation complete",1),console.log("finished generation"),c.partitions}async generateCavePartitions(e){const t=new Ka;let i,s=0;const a=e.mapWidth??50,n=e.mapHeight??50,c=e.caveRooms??8,l=typeof e.linearity=="number",d=typeof e.branching=="number"?e.branching:l?Math.max(0,Math.min(1,1-e.linearity)):.5,u=typeof e.loopiness=="number"?e.loopiness:l?Math.max(0,Math.min(1,1-e.linearity)):.5;this.visualizer.updateProgress("Starting cave generation",0);do s++,this.visualizer.updateProgress(`Generating cave candidate ${s}`,s*.1),await this.generateCaveCandidate(t,a,n,c,d,u),i=this.validator.validateCavePartitions(t.partitions,c),this.visualizer.setVisualizationState(t.partitions,a/2,n/2,"validating cave",.8);while(!i.isValid);return this.visualizer.updateProgress("Cave generation complete",1),t.partitions}generateTutorialPartitions(e=7,t=7){const i=[new ye(0,0,e,t,"white")];i[0].type=R.TUTORIAL;const s=this.validator.validateTutorialPartitions(i);if(!s.isValid)throw new Error(`Tutorial validation failed: ${s.errorMessage}`);return i}async generateDungeonCandidate(e,t,i,s,a,n,c){const{minRoomCount:l,maxRoomCount:d,maxRoomArea:u,splitProbabilities:h,wallRemoveProbability:f,softMaxRoomArea:p}=n;for(t.partitions=[new ye(0,0,i,s,"white")],this.visualizer.updateProgress("Splitting partitions",.1),this.visualizer.setVisualizationState(t.partitions,i/2,s/2,"splitting");t.partitions.length<n.maxRoomCount;)for(let g=0;g<h.length;g++)t.partitions=await this.splitPartitions(t.partitions,h[g]),this.visualizer.setVisualizationState(t.partitions,i/2,s/2,"splitting",.1+g/h.length*.2);for(let g=0;g<100;g++)t.partitions.forEach(async w=>{let b=O.rand()>.95?p:u;w.area()>b&&(t.partitions=t.partitions.filter(T=>T!==w),t.partitions=t.partitions.concat(await this.splitPartition(w,.5)))});if(this.visualizer.updateProgress("Removing wall rooms",.4),t.partitions=this.removeWallRooms(t.partitions,i,s,f),await this.visualizer.createAnimationDelay("large"),t.partitions.length===0){t.partitions=[];return}if(this.visualizer.updateProgress("Assigning room types",.5),t.partitions.sort((g,w)=>g.area()-w.area()),this.visualizer.updatePartitionStyles(t.partitions),t.partitions.length===0){t.partitions=[];return}let y=t.partitions[0];if(!y){t.partitions=[];return}y.type=R.START,y.fillStyle="rgb(0, 255, 0)",t.partitions.length>1&&(t.partitions[t.partitions.length-1].type=R.BOSS,t.partitions[t.partitions.length-1].fillStyle="red"),this.visualizer.updateProgress("Connecting partitions",.6),await this.connectPartitions(t,y,c==null?void 0:c.branching),this.visualizer.updateProgress("Adding loop connections",.7),t.partitions.length>0&&await this.addLoopConnections(t,c==null?void 0:c.loopiness),this.visualizer.updateProgress("Adding stair room",.8),t.partitions.length>0&&await this.addStairRoom(t,e),this.visualizer.updateProgress("Calculating distances",.9),t.partitions.length>0&&(await this.calculateDistances(t,y),await this.addSpecialRooms(t))}async generateCaveCandidate(e,t,i,s,a=.5,n=.5){e.partitions=[new ye(100,100,t,i,"white")];for(let d=0;d<9;d++)e.partitions=await this.splitPartitions(e.partitions,.75);if(e.partitions.sort((d,u)=>d.area()-u.area()),e.partitions.length===0)throw new Error("No partitions generated.");let l=e.partitions[0];l.type=R.ROPECAVE;for(let d=1;d<e.partitions.length;d++)e.partitions[d].type=R.CAVE;await this.connectCavePartitions(e,l,s,a),await this.addCaveLoops(e,n),await this.calculateDistances(e,l)}async splitPartitions(e,t){for(let i of e)O.rand()<t&&(this.visualizer.createVisualEffect("partition_split",i),e=e.filter(s=>s!==i),e=e.concat(await i.split()));return e}async splitPartition(e,t){return O.rand()<t?await e.split():[e]}getWallRooms(e,t,i){return e.filter(s=>{const a=c=>{switch(c){case"left":for(let l=s.y;l<s.y+s.h;l++)if(!e.some(u=>u===s?!1:u.y<=l&&l<u.y+u.h&&u.x+u.w>0&&u.x+u.w<=s.x))return!0;return!1;case"right":for(let l=s.y;l<s.y+s.h;l++)if(!e.some(u=>u===s?!1:u.y<=l&&l<u.y+u.h&&u.x<t&&u.x>=s.x+s.w))return!0;return!1;case"top":for(let l=s.x;l<s.x+s.w;l++)if(!e.some(u=>u===s?!1:u.x<=l&&l<u.x+u.w&&u.y+u.h>0&&u.y+u.h<=s.y))return!0;return!1;case"bottom":for(let l=s.x;l<s.x+s.w;l++)if(!e.some(u=>u===s?!1:u.x<=l&&l<u.x+u.w&&u.y<i&&u.y>=s.y+s.h))return!0;return!1;default:return!1}};return[a("left"),a("right"),a("top"),a("bottom")].filter(Boolean).length===1})}removeWallRooms(e,t,i,s=1){const a=this.getWallRooms(e,t,i);for(const n of a)O.rand()<s&&(e=e.filter(c=>c!==n));return e}async connectPartitions(e,t,i){let s=[t],a=[t],n=!1;for(;a.length>0&&!n;){let c=a[0];c!==t&&this.visualizer.createVisualEffect("room_connected",c),a.splice(0,1);let l=0;const d=i===void 0?Math.floor(O.rand()*2+1):1+(O.rand()<Math.max(0,Math.min(1,i))?1:0);let u=0;const h=1e3;for(;l<d&&u<h;){let f=c.get_branch_point();for(const p of e.partitions)if(p!==c&&s.indexOf(p)===-1&&p.point_next_to(f.x,f.y)){c.connections.push(new nt(f.x,f.y,p)),p.connections.push(new nt(f.x,f.y,c)),c.setOpenWall(new nt(f.x,f.y,p)),p.setOpenWall(new nt(f.x,f.y,c)),a.push(p),s.push(p),l++,p.type===R.BOSS&&(n=!0,this.visualizer.createVisualEffect("boss_found",p));break}u++}await this.visualizer.createAnimationDelay("pathfinding")}for(const c of e.partitions)c.connections.length===0&&(e.partitions=e.partitions.filter(l=>l!==c))}async connectCavePartitions(e,t,i,s=.5){let a=[t],n=[t];for(;n.length>0&&a.length<i;){let c=n[0];n.splice(0,1);let l=0;const d=Math.max(0,Math.min(1,s)),u=1+(O.rand()<d?1:0);let h=0;const f=1e3;for(;l<u&&h<f&&a.length<i;){let p=c.get_branch_point();if(!p)break;for(const y of e.partitions)if(y!==c&&a.indexOf(y)===-1&&y.point_next_to(p.x,p.y)){c.connections.push(new nt(p.x,p.y,y)),y.connections.push(new nt(p.x,p.y,c)),n.push(y),a.push(y),l++;break}h++}}if(e.partitions=e.partitions.filter(c=>c.connections.length>0),e.partitions.length===0)throw new Error("No valid rooms after filtering.")}async addLoopConnections(e,t){if(e.partitions.length===0)return;let i=Math.floor(t===void 0?O.rand()*4+4:(O.rand()*4+4)*Math.max(0,Math.min(1,t)));for(let s=0;s<i&&e.partitions.length!==0;s++){let a=Math.floor(O.rand()*e.partitions.length),n=e.partitions[a];if(!n)continue;let c=!1,l=0;const d=10;let u=e.partitions.filter(h=>h&&!n.connections.some(f=>f.other===h));for(;!c&&l<d;){let h=n.get_branch_point();if(!h)break;for(const f of u)if(f&&f!==n&&f.point_next_to(h.x,h.y)){n.connections.push(new nt(h.x,h.y,f)),f.connections.push(new nt(h.x,h.y,n)),n.setOpenWall(new nt(h.x,h.y,f)),f.setOpenWall(new nt(h.x,h.y,n)),c=!0;break}l++}}}async addCaveLoops(e,t=.5){if(e.partitions.length===0)return;let i=Math.floor((O.rand()*4+4)*Math.max(0,Math.min(1,t)));for(let s=0;s<i&&e.partitions.length!==0;s++){let a=Math.floor(O.rand()*e.partitions.length),n=e.partitions[a];if(!n)continue;let c=!1,l=0;const d=100;let u=e.partitions.filter(h=>h&&!n.connections.some(f=>f.other===h));for(;!c&&l<d;){let h=n.get_branch_point();if(!h)break;for(const f of u)if(f&&f!==n&&f.point_next_to(h.x,h.y)){n.connections.push(new nt(h.x,h.y,f)),f.connections.push(new nt(h.x,h.y,n)),c=!0;break}l++}}}async addStairRoom(e,t){if(!e.partitions.some(l=>l.type===R.BOSS)){e.partitions=[];return}let i=e.partitions.find(l=>l.type===R.BOSS),s=!1;const a=5,n=5,c=5;for(let l=0;l<a;l++){let d=new ye(m.rand(i.x-1,i.x+i.w-2,O.rand),i.y-c-1,n,c,"white");if(d.type=R.DOWNLADDER,d.fillStyle="blue",!e.partitions.some(u=>u.overlaps(d))){s=!0,e.partitions.push(d),d.connections.push(new nt(d.x+1,d.y+c,i)),i.connections.push(new nt(d.x+1,d.y+c,d)),d.setOpenWall(new nt(d.x+1,d.y+c,i)),i.setOpenWall(new nt(d.x+1,d.y+c,d));break}}s||(console.log("No stair found"),e.partitions=[])}async calculateDistances(e,t){let i=[t],s=[];for(t.distance=0;i.length>0;){let a=i[0];i.splice(0,1),s.push(a);for(let n of a.connections){let c=n.other;c.distance=Math.min(c.distance,a.distance+1),s.indexOf(c)===-1&&i.push(c)}}}async addSpecialRooms(e){for(const t of e.partitions)t.type===R.DUNGEON&&t.distance>4&&t.area()<=30&&O.rand()<0&&(t.type=R.TREASURE);await this.visualizer.createAnimationDelay("large")}getVisualizer(){return this.visualizer}}const jo={"rgb(0, 255, 0)":R.START,"rgb(255, 0, 0)":R.BOSS,"rgb(0, 0, 255)":R.DOWNLADDER,"rgb(0, 255, 255)":R.UPLADDER,"rgb(255, 255, 0)":R.TREASURE,"rgb(255, 0, 255)":R.SHOP,"rgb(128, 0, 128)":R.FOUNTAIN,"rgb(139, 69, 19)":R.COFFIN,"rgb(255, 165, 0)":R.KEYROOM,"rgb(64, 64, 64)":R.PUZZLE,"rgb(0, 0, 0)":R.CHESSBOARD,"rgb(192, 192, 192)":R.MAZE,"rgb(255, 192, 203)":R.SPAWNER,"rgb(34, 139, 34)":R.GRASS,"rgb(101, 67, 33)":R.CAVE,"rgb(85, 107, 47)":R.GRAVEYARD,"rgb(46, 125, 50)":R.FOREST,"rgb(160, 160, 160)":R.CORRIDOR,"rgb(255, 87, 34)":R.SPIKECORRIDOR,"rgb(121, 85, 72)":R.BIGCAVE,"rgb(78, 52, 46)":R.ROPECAVE,"rgb(156, 102, 68)":R.ROPEHOLE,"rgb(141, 110, 99)":R.ROPEUP,"rgb(173, 216, 230)":R.TUTORIAL,"rgb(250, 250, 250)":R.BIGDUNGEON,"rgb(255, 255, 255)":R.DUNGEON};class al{async generatePartitionsFromPng(e,t,i,s=!1){try{const a=await this.loadImageData(e),n=this.findRectangles(a),c=this.createPartitionsFromRectangles(n,s);if(c.length===0)return console.error(" No partitions created from image!"),[];const l=new Ka;return l.partitions=c,await this.processPartitionsForGameplay(l,t,s),console.log(` Final processed partitions: ${l.partitions.length}`),l.partitions}catch(a){return console.error(" Error in PNG partition generation:",a),console.error("Stack trace:",a.stack),[]}}loadImageData(e){return new Promise((t,i)=>{const s=new Image;s.crossOrigin="Anonymous",s.onload=()=>{try{const a=document.createElement("canvas");a.width=s.width,a.height=s.height;const n=a.getContext("2d");if(!n)throw new Error("Could not get canvas context");n.drawImage(s,0,0);const c=n.getImageData(0,0,s.width,s.height);t(c)}catch(a){console.error("   Error processing image:",a),i(a)}},s.onerror=a=>{console.error(`   Failed to load image: ${a}`),i(new Error(`Failed to load image at ${e}: ${a}`))},s.src=e})}findRectangles(e){const{width:t,height:i,data:s}=e,a=new Array(t*i).fill(!1),n=[];for(let c=0;c<i;c++)for(let l=0;l<t;l++){const d=c*t+l;if(a[d])continue;const u=d*4;if(s[u+3]===0)continue;const f=s[u],p=s[u+1],y=s[u+2],g=`rgb(${f}, ${p}, ${y})`;let w=1;for(;l+w<t&&!a[c*t+(l+w)]&&this.isSameColor(s,u,(c*t+l+w)*4);)w++;let b=1;for(;c+b<i;){let v=!0;for(let k=0;k<w;k++)if(a[(c+b)*t+(l+k)]||!this.isSameColor(s,u,((c+b)*t+l+k)*4)){v=!1;break}if(v)b++;else break}for(let v=0;v<b;v++)for(let k=0;k<w;k++)a[(c+v)*t+(l+k)]=!0;const T={x:l,y:c,w,h:b,color:g};n.push(T)}return n}isSameColor(e,t,i){return e[t]===e[i]&&e[t+1]===e[i+1]&&e[t+2]===e[i+2]&&e[t+3]===e[i+3]}createPartitionsFromRectangles(e,t){return e.length===0?(console.warn("    No rectangles to create partitions from!"),[]):e.map((s,a)=>{const n=new ye(s.x,s.y,s.w,s.h,s.color);if(t){const c=this.getCaveRoomTypeFromColor(s.color);n.type=c}else{const c=jo[s.color];c?n.type=c:n.type=R.DUNGEON}return n})}getCaveRoomTypeFromColor(e){switch(e){case"rgb(0, 255, 0)":return R.ROPECAVE;case"rgb(0, 255, 255)":return R.UPLADDER;case"rgb(255, 255, 0)":return R.TREASURE;case"rgb(255, 0, 255)":return R.SHOP;default:return R.CAVE}}async processPartitionsForGameplay(e,t,i){if(e.partitions.length===0){console.error("   No partitions to process!");return}i?await this.processCavePartitions(e,t):await this.processMainPathPartitions(e,t)}async processCavePartitions(e,t){const i={};e.partitions.forEach(a=>{i[a.type]=(i[a.type]||0)+1});let s=e.partitions.find(a=>a.type===R.ROPECAVE);if(!s&&e.partitions.length>0&&(e.partitions.sort((a,n)=>a.area()-n.area()),s=e.partitions[0],s.type=R.ROPECAVE,s.fillStyle="rgb(0, 255, 0)"),e.partitions.forEach(a=>{a!==s&&a.type===R.DUNGEON&&(a.type=R.CAVE)}),this.updatePartitionVisualStyles(e.partitions),s){const a=e.partitions.indexOf(s);a>0&&(e.partitions.splice(a,1),e.partitions.unshift(s))}s&&await this.connectCavePartitions(e,s),e.partitions.length>0&&await this.addLoopConnections(e),e.partitions.length>0&&s&&(await this.calculateDistances(e,s),await this.addSpecialRooms(e))}async processMainPathPartitions(e,t){const i={};e.partitions.forEach(c=>{i[c.type]=(i[c.type]||0)+1});let s=e.partitions.find(c=>c.type===R.START),a=e.partitions.find(c=>c.type===R.BOSS);if(!s&&e.partitions.length>0&&(e.partitions.sort((c,l)=>c.area()-l.area()),s=e.partitions[0],s.type=R.START,s.fillStyle="rgb(0, 255, 0)"),!a&&e.partitions.length>1&&(e.partitions.sort((c,l)=>c.area()-l.area()),a=e.partitions[e.partitions.length-1],a.type===R.DUNGEON?(a.type=R.BOSS,a.fillStyle="red"):a=null),this.updatePartitionVisualStyles(e.partitions),s){const c=e.partitions.indexOf(s);c>0&&(e.partitions.splice(c,1),e.partitions.unshift(s))}s?await this.connectPartitions(e,s):console.error("   No spawn room found, cannot connect partitions!"),e.partitions.length>0&&await this.addLoopConnections(e),!e.partitions.some(c=>c.type===R.DOWNLADDER)&&e.partitions.length>0&&await this.addStairRoom(e,t),e.partitions.length>0&&s&&(await this.calculateDistances(e,s),await this.addSpecialRooms(e),e.partitions.forEach(c=>{}))}updatePartitionVisualStyles(e){for(const t of e){const i=t.fillStyle;switch(t.type){case R.START:t.fillStyle="rgb(0, 255, 0)";break;case R.BOSS:t.fillStyle="red";break;case R.DOWNLADDER:case R.UPLADDER:t.fillStyle="blue";break;case R.TREASURE:t.fillStyle="rgb(255, 215, 0)";break;case R.SHOP:t.fillStyle="rgb(255, 0, 255)";break;case R.FOUNTAIN:t.fillStyle="rgb(128, 0, 128)";break;case R.CAVE:case R.BIGCAVE:t.fillStyle="rgb(101, 67, 33)";break;default:t.fillStyle="white";break}t.fillStyle}}async connectPartitions(e,t){let i=[t],s=[t];for(;s.length>0;){let n=s[0];s.splice(0,1);const c=e.partitions.filter(l=>l!==n&&i.indexOf(l)===-1&&this.arePartitionsAdjacent(n,l));for(let l=0;l<c.length;l++){const d=c[l],u=this.arePartitionsAdjacent(n,d);if(u){const h=u.connectionPoint;n.connections.push(new nt(h.x,h.y,d)),d.connections.push(new nt(h.x,h.y,n)),n.setOpenWall(new nt(h.x,h.y,d)),d.setOpenWall(new nt(h.x,h.y,n)),s.push(d),i.push(d)}}}const a=e.partitions.filter(n=>n.connections.length===0);a.length>0&&a.forEach(n=>{this.connectIsolatedRoom(n,e.partitions.filter(c=>c.connections.length>0))})}connectIsolatedRoom(e,t){let i=null,s=1/0;for(const a of t){const n=Math.abs(e.x-a.x)+Math.abs(e.y-a.y);n<s&&(s=n,i=a)}if(i){const a=Math.floor((e.x+i.x)/2),n=Math.floor((e.y+i.y)/2);e.connections.push(new nt(a,n,i)),i.connections.push(new nt(a,n,e))}}async connectCavePartitions(e,t){let i=[t],s=[t];const a=e.partitions.length;for(;s.length>0&&i.length<a;){let n=s[0];s.splice(0,1);const c=e.partitions.filter(d=>d!==n&&i.indexOf(d)===-1&&this.arePartitionsAdjacent(n,d)),l=Math.min(c.length,Math.floor(O.rand()*2+1));for(let d=0;d<l&&i.length<a;d++){const u=c[d],h=this.arePartitionsAdjacent(n,u);if(h){const f=h.connectionPoint;n.connections.push(new nt(f.x,f.y,u)),u.connections.push(new nt(f.x,f.y,n)),s.push(u),i.push(u)}}}e.partitions=e.partitions.filter(n=>n.connections.length>0)}arePartitionsAdjacent(e,t){if(e.y<t.y+t.h&&t.y<e.y+e.h){if(e.x+e.w===t.x||e.x+e.w===t.x-1){const i=Math.max(e.y,t.y),s=Math.min(e.y+e.h,t.y+t.h),a=Math.floor(i+(s-i)/2);return{direction:"horizontal",connectionPoint:{x:e.x+e.w,y:a}}}if(t.x+t.w===e.x||t.x+t.w===e.x-1){const i=Math.max(e.y,t.y),s=Math.min(e.y+e.h,t.y+t.h),a=Math.floor(i+(s-i)/2);return{direction:"horizontal",connectionPoint:{x:t.x+t.w,y:a}}}}if(e.x<t.x+t.w&&t.x<e.x+e.w){if(e.y+e.h===t.y||e.y+e.h===t.y-1){const i=Math.max(e.x,t.x),s=Math.min(e.x+e.w,t.x+t.w);return{direction:"vertical",connectionPoint:{x:Math.floor(i+(s-i)/2),y:e.y+e.h}}}if(t.y+t.h===e.y||t.y+t.h===e.y-1){const i=Math.max(e.x,t.x),s=Math.min(e.x+e.w,t.x+t.w);return{direction:"vertical",connectionPoint:{x:Math.floor(i+(s-i)/2),y:t.y+t.h}}}}return null}async addLoopConnections(e){if(e.partitions.length===0)return;const t=new Map;e.partitions.forEach(s=>{const a=e.partitions.filter(n=>n!==s&&this.arePartitionsAdjacent(s,n));t.set(s,a)});const i=Math.min(4,Math.floor(e.partitions.length/2));for(let s=0;s<i;s++){const a=Math.floor(O.rand()*e.partitions.length),n=e.partitions[a],l=(t.get(n)||[]).filter(d=>!n.connections.some(u=>u.other===d));if(l.length>0){const d=l[Math.floor(O.rand()*l.length)],u=this.arePartitionsAdjacent(n,d);if(u){const h=u.connectionPoint;n.connections.push(new nt(h.x,h.y,d)),d.connections.push(new nt(h.x,h.y,n)),n.setOpenWall(new nt(h.x,h.y,d)),d.setOpenWall(new nt(h.x,h.y,n))}}}}async addStairRoom(e,t){const i=e.partitions.some(d=>d.type===R.BOSS),s=e.partitions.some(d=>d.type===R.DOWNLADDER);if(!i||s)return;let a=e.partitions.find(d=>d.type===R.BOSS);const n=5,c=5,l=5;for(let d=0;d<n;d++){const u=m.rand(a.x-1,a.x+a.w-2,O.rand),h=a.y-l-1;let f=new ye(u,h,c,l,"white");if(f.type=R.DOWNLADDER,f.fillStyle="blue",!e.partitions.some(y=>y.overlaps(f))){e.partitions.push(f);const y=f.x+1,g=f.y+l;f.connections.push(new nt(y,g,a)),a.connections.push(new nt(y,g,f)),f.setOpenWall(new nt(y,g,a)),a.setOpenWall(new nt(y,g,f));break}}}async calculateDistances(e,t){let i=[t],s=[];for(t.distance=0;i.length>0;){let a=i[0];i.splice(0,1),s.push(a);for(let n of a.connections){let c=n.other;const l=a.distance+1;l<c.distance&&(c.distance=l),s.indexOf(c)===-1&&i.push(c)}}}async addSpecialRooms(e){for(const t of e.partitions)t.type===R.DUNGEON&&t.distance>4&&t.area()<=30&&O.rand()<.1&&(t.type=R.TREASURE)}static getColorGuide(){return`PNG Level Designer Color Guide:
${Object.entries(jo).map(([t,i])=>`${t} -> ${i}`).join(`
`)}`}}class vi{constructor(){r(this,"game");r(this,"seed");r(this,"depthReached",0);r(this,"currentFloorFirstLevelID",0);r(this,"partialLevel");r(this,"levelParams");r(this,"partitionGenerator");r(this,"validator");r(this,"visualizer");r(this,"pngPartitionGenerator");r(this,"setOpenWallsForPartitions",(e,t,i)=>{for(const s of e)s.isTopOpen=!1,s.isRightOpen=!1,s.isBottomOpen=!1,s.isLeftOpen=!1,s.x===0&&(s.isLeftOpen=!0),s.y===0&&(s.isTopOpen=!0),s.x+s.w===t&&(s.isRightOpen=!0),s.y+s.h===i&&(s.isBottomOpen=!0)});r(this,"createLevel",(e,t=!0,i,s,a=!1)=>new An(this.game,e,100,100,t,i,s,a));r(this,"getRooms",(e,t,i,s,a)=>{let n=[];for(let l=0;l<e.length;l++){let d=e[l],u=new qh(this.game,d.x-1,d.y-1,d.w+2,d.h+2,d.type,t,i,this.game.levels[t],O.rand,s);u.pathId=a||"main",n.push(u)}let c=[];return e.forEach((l,d)=>{l.connections.forEach(u=>{let h=n[d].addDoor(u.x,u.y),f=c.find(p=>p.x===h.x&&p.y===h.y);f&&(f.link(h),h.link(f)),c.push(h)})}),n});r(this,"setSeed",e=>{this.seed=e});r(this,"generate",async(e,t,i=!1,s,a=F.DUNGEON,n=!1,c,l)=>{this.partitionGenerator||(this.partitionGenerator=new rl(e)),this.validator||(this.validator=new kn(e)),this.visualizer||(this.visualizer=this.partitionGenerator.getVisualizer()),this.levelParams=$h.getParameters(t),this.depthReached=t;const d=c??(i?"side":"main");let u=0;for(let k=0;k<d.length;k++)u=(u*131^d.charCodeAt(k))>>>0;O.setState((this.seed+t^u)>>>0),this.game=e;let h=this.game.rooms.length>0?this.game.rooms[this.game.rooms.length-1].mapGroup+1:0,f;const p=!i,y=this.shouldUsePngForLevel(t,d,G.PNG_LEVEL_PROBABILITY);if(p&&y){const k=await this.selectRandomLevelForDepth(t);k&&(console.log(`Using PNG level generation from: ${k}`),f=await this.pngPartitionGenerator.generatePartitionsFromPng(k,e,t,i)),(!k||f.length===0)&&(console.warn(k?"PNG generation failed, falling back to procedural generation":`No PNG levels found for depth ${t}, falling back to procedural generation`),f=await this.partitionGenerator.generateDungeonPartitions(e,this.levelParams.mapWidth,this.levelParams.mapHeight,t,this.levelParams,i?void 0:{branching:l==null?void 0:l.branching,loopiness:l==null?void 0:l.loopiness}))}else i?f=await this.partitionGenerator.generateCavePartitions(l):f=await this.partitionGenerator.generateDungeonPartitions(e,this.levelParams.mapWidth,this.levelParams.mapHeight,t,this.levelParams,i?void 0:{branching:l==null?void 0:l.branching,loopiness:l==null?void 0:l.loopiness});const g=this.validator.validateNoOverlaps(f);g.isValid||console.warn(`Overlap validation failed: ${g.errorMessage}`);let w=t>4?F.MAGMA_CAVE:F.DUNGEON,b=i?a:w,T=this.createLevel(t,!i,h,b,n);i||(this.game.levels.push(T),this.game.registerLevel(T));let v=this.getRooms(f,t,h,b,d);T.setRooms(v),T.populator.populateRooms(),T.setRoomSkins(),T.exitRoom&&T.exitRoom.linkExitToStart(),i||(this.currentFloorFirstLevelID=this.game.rooms.length),this.game.registerRooms(v),this.game.level=this.game.levels[t]||this.game.level,s(i?v.find(k=>k.type===R.ROPECAVE):v.find(k=>k.type===R.START))});r(this,"generateFirstNFloors",async(e,t,i=!1)=>{for(let s=0;s<=t;s++)await this.generate(e,s,!1,()=>{},F.DUNGEON,i,void 0,{branching:G.MAIN_PATH_BRANCHING,loopiness:G.MAIN_PATH_LOOPINESS})});r(this,"draw",e=>{this.visualizer?this.visualizer.draw(e):(m.ctx.fillStyle="rgba(0, 0, 0, 1)",m.ctx.fillRect(0,0,x.WIDTH,x.HEIGHT),this.game.drawTextScreen("generating level"))});this.validator=null,this.visualizer=null,this.pngPartitionGenerator=new al}shouldUsePngForLevel(e,t,i){let s=(this.seed^e)>>>0;for(let n=0;n<t.length;n++)s=Math.imul(s^t.charCodeAt(n),1664525)+1013904223>>>0;return(s>>>0)/4294967296<i}async selectRandomLevelForDepth(e){console.log(`Looking for PNG levels for depth ${e}...`);const t=[],i=10;for(let n=0;n<i;n++){const c=`${e}_${n}.png`,l=`res/levels/${c}`;await this.checkImageExists(l)&&(t.push(l),console.log(`   Found variation: ${c}`))}if(t.length===0)return console.log(`   No PNG levels found for depth ${e}`),null;const s=Math.floor(O.rand()*t.length),a=t[s];return console.log(`   Selected ${a} (${s+1}/${t.length} available)`),a}async checkImageExists(e){return new Promise(t=>{const i=new Image;i.onload=()=>{t(!0)},i.onerror=()=>{t(!1)},setTimeout(()=>{t(!1)},1e3),i.src=e})}}r(vi,"ANIMATION_CONSTANT",1);class ol{constructor(e){r(this,"text");r(this,"cursor");r(this,"enterCallback");r(this,"escapeCallback");r(this,"allowedCharacters","all");r(this,"element");r(this,"message","");r(this,"sentMessages");r(this,"currentMessageIndex",-1);r(this,"MAX_HISTORY",50);r(this,"handleKeyPress",e=>{const t="abcdefghijklmnopqrstuvwxyz1234567890,.!?:'()[]%-/+ ".split("");if(e.length===1){e=e.toLowerCase(),t.includes(e)&&(this.allowedCharacters==="all"||this.allowedCharacters.includes(e))&&(this.text=this.text.substring(0,this.cursor)+e+this.text.substring(this.cursor,this.text.length),this.cursor+=1,this.updateElement(),this.message=this.message.substring(0,this.cursor-1)+e+this.message.substring(this.cursor-1,this.message.length));return}else switch(e){case"Backspace":this.cursor>0&&(this.text=this.text.substring(0,this.cursor-1)+this.text.substring(this.cursor,this.text.length),this.cursor=Math.max(0,this.cursor-1),this.updateElement(),this.message=this.message.substring(0,this.cursor)+this.message.substring(this.cursor+1,this.message.length));break;case"Delete":this.cursor<this.text.length&&(this.text=this.text.substring(0,this.cursor)+this.text.substring(this.cursor+1,this.text.length),this.updateElement(),this.message=this.message.substring(0,this.cursor)+this.message.substring(this.cursor+1,this.message.length));break;case"ArrowLeft":this.cursor=Math.max(0,this.cursor-1),this.updateCursorPosition();break;case"ArrowRight":this.cursor=Math.min(this.text.length,this.cursor+1),this.updateCursorPosition();break;case"ArrowUp":this.sentMessages.length>0&&this.currentMessageIndex<this.sentMessages.length-1&&(this.currentMessageIndex++,this.text=this.sentMessages[this.sentMessages.length-1-this.currentMessageIndex],this.updateElement(),this.message=this.text);break;case"ArrowDown":this.currentMessageIndex>0?(this.currentMessageIndex--,this.text=this.sentMessages[this.sentMessages.length-1-this.currentMessageIndex],this.updateElement(),this.message=this.text):this.currentMessageIndex===0&&(this.currentMessageIndex=-1,this.clear());break;case"Enter":this.sendMessage(),this.escapeCallback();break;case"Escape":this.escapeCallback();break}});r(this,"handleTouchStart",e=>{this.focus(),e.preventDefault()});this.text="",this.cursor=0,this.enterCallback=()=>{},this.escapeCallback=()=>{},this.element=e,this.sentMessages=[]}setEnterCallback(e){this.enterCallback=e}setEscapeCallback(e){this.escapeCallback=e}clear(){this.text="",this.cursor=0,this.message="",this.updateElement()}focus(){const e=document.createElement("input");e.type="text",e.style.position="absolute",e.style.opacity="0",e.style.zIndex="-1",document.body.appendChild(e),e.focus(),e.addEventListener("blur",()=>{document.body.removeChild(e)})}sendMessage(){let e=this.message.trim();e&&(this.sentMessages.push(e),this.sentMessages.length>this.MAX_HISTORY&&this.sentMessages.shift(),ht.emit("ChatMessageSent",e),console.log(this.sentMessages),this.enterCallback(),e.startsWith("/")&&(e=e.substring(1),ht.emit("ChatCommand",e)),this.clear(),this.currentMessageIndex=-1)}updateElement(){this.element.textContent=this.text}updateCursorPosition(){}}class wo extends vt{constructor(t,i,s){super(t,i,s);r(this,"getDescription",()=>`GOLD KEY
A heavy gold key.`);this.tileX=6,this.tileY=0,this.name="goldenKey"}}r(wo,"itemName","goldenKey");const ea=class ea extends dt{constructor(t,i,s){super(t,i,s);r(this,"onUse",t=>{t.bestiary===null&&(t.bestiary=new Sn(t.game,t)),t.bestiary.toggleOpen()});this.tileX=8,this.tileY=0,this.offsetY=-.3,this.name=ea.itemName,this.description="opens the bestiary"}};r(ea,"itemName","bestiary book");let kr=ea;class On extends dt{constructor(t,i,s){super(t,i,s);r(this,"room");r(this,"count");r(this,"player");r(this,"onUse",t=>{});r(this,"spawnEntity",t=>{mt.add(this.room,this.player.game,this.player.x,this.player.y)});r(this,"commandHandler",t=>{if(this.room.game.players[0],t=t.toLowerCase(),!!t.startsWith("/new"))switch(t.split(" ")[1]){case"bishop":this.spawnEntity(new Pt(this.room,this.player.game,this.player.x,this.player.y));break}});r(this,"getDescription",()=>"YOU SHOULD NOT HAVE THIS");this.room=t,this.count=0,this.tileX=31,this.tileY=0,this.setupEventListeners(),this.player=this.room.game.players[0],this.stackable=!1}setupEventListeners(){ht.on("ChatMessage",this.commandHandler.bind(this))}}class Mn extends dt{constructor(t,i,s){super(t,i,s);r(this,"onUse",t=>{t.health=Math.min(t.maxHealth,t.health+1),this.level.game.rooms[t.levelID]===this.level.game.room&&H.heal(),t.inventory.removeItem(this)});r(this,"getDescription",()=>`GREEN POTION
Restores 1 heart`);this.tileX=7,this.tileY=0,this.offsetY=-.3}}class xo extends Et{constructor(t,i,s){super(t,i,s);r(this,"weaponMove",(t,i)=>{let s=[t],a=[i],n=1,c=0;for(let g=0;g<5;g++)t===this.wielder.x&&(s.push(t),a.push(a[c]+(i-this.wielder.y))),i===this.wielder.y&&(s.push(s[c]+(t-this.wielder.x)),a.push(i)),c++;if(!this.game.rooms[this.wielder.levelID].tileInside(t,i)||this.game.rooms[this.wielder.levelID].roomArray[t][i].isSolid())return!0;let l=1;for(let g=0;g<5;g++)(!this.game.rooms[this.wielder.levelID].tileInside(s[l],a[l])||this.game.rooms[this.wielder.levelID].roomArray[s[l]][a[l]].isSolid())&&(n=l),l++;let d=[],u=n+1,h=n+2,f=n+2;for(let g of this.game.rooms[this.wielder.levelID].entities)if(g.pushable){let w=2;if(g.pointIn(t,i))return!0;for(let b=0;b<15;b++)g.pointIn(s[w-1],a[w-1])&&n>=w&&(u=Math.min(u,w)),w++}else if(g.destroyable){g.pointIn(t,i)&&n>=1&&(h=1,d.push({enemy:g,dist:1}));let w=2;for(let b=0;b<15;b++)g.pointIn(s[w-1],a[w-1])&&n>=w&&(h=Math.min(h,w),d.push({enemy:g,dist:w})),w++}else{g.pointIn(t,i)&&n>=1&&(f=1);let w=2;for(let b=0;b<15;b++)g.pointIn(s[w-1],a[w-1])&&n>=w&&(f=Math.min(f,w)),w++}let p=t,y=i;if(f<h&&f<u)return!0;if(h<=u){d.length>0&&d.reduce((b,T)=>T.dist<b.dist?T:b).enemy.hurt(this.wielder,1),this.hitSound(),this.wielder.setHitXY(t,i),xe.shotgun(this.game.rooms[this.wielder.levelID],this.wielder.x+.5,this.wielder.y,p+.5,y,"black"),xe.shotgun(this.game.rooms[this.wielder.levelID],this.wielder.x+.5,this.wielder.y,p+.5,y,"#ffddff");let g=new xe(this.game.rooms[this.wielder.levelID],.5*(t+this.wielder.x)+.5,.5*(i+this.wielder.y),0,1,0,0,0,"white",0);return g.expirationTimer=10,this.game.rooms[this.wielder.levelID].particles.push(g),this.game.rooms[this.wielder.levelID].tick(this.wielder),this.shakeScreen(t*10,i*10),!1}return!0});this.tileX=26,this.tileY=0,this.name="Slingshot"}}r(xo,"itemName","slingshot");class Pn extends dt{constructor(t,i,s){super(t,i,s);r(this,"onUse",t=>{t.health=Math.min(t.maxHealth,t.health+1),this.level.game.rooms[t.levelID]===this.level.game.room&&H.heal(),t.inventory.removeItem(this)});r(this,"getDescription",()=>`HEALTH POTION
Restores 1 heart`);this.tileX=9,this.tileY=0,this.offsetY=-.3}}class Rn extends mt{constructor(t,i,s,a){super(t,i,s,a);r(this,"frame");r(this,"setDrawableY",()=>{for(let t of this.room.items)t.x===this.x&&t.y===this.y&&(this.drawableY,this.room.roomArray[this.x][this.y].drawableY+.001)});r(this,"draw",t=>{this.drawableY=this.y-.01,this.setDrawableY,this.dead||m.drawObj(0,4,1,2,this.x-this.drawX,this.y-this.drawYOffset-this.drawY,1,2,this.room.shadeColor,this.shadeAmount())});this.x=s,this.y=a,this.game=i,this.room=t,this.frame=0}}class Dn extends mt{constructor(t,i,s,a){super(t,i,s,a);r(this,"createDownladder",()=>{let t=this.room.depth<1?F.FOREST:F.CAVE;this.room.depth>1&&(t=O.rand()<.5?F.FOREST:F.CAVE);let i=new wt(this.room,this.game,this.x,this.y,!0,t,De.NONE);i.lockable.isLocked()&&(console.log("adding key to downladder"),this.game.levels[this.room.depth].distributeKey(i)),this.room.roomArray[this.x][this.y]=i});r(this,"draw",t=>{});r(this,"drawTopLayer",t=>{});this.room=t,this.name="DownladderMaker",this.dead=!0}}class Cn extends oe{constructor(){super(...arguments);r(this,"onCollide",t=>{t.hurt(1,"spike")});r(this,"draw",t=>{m.drawTile(11,0,1,1,this.x,this.y,1,1,this.room.shadeColor,this.shadeAmount())})}}class Ln extends bt{constructor(){super(...arguments);r(this,"draw",t=>{m.drawTile(7,this.skin,1,1,this.x,this.y,1,1,this.room.shadeColor,this.shadeAmount())})}}class nl{constructor(e){r(this,"x");r(this,"y");r(this,"dead");this.x=e.x,this.y=e.y,this.dead=e.dead}}let hl=(o,e)=>{let t=new Ht(e,o.x,o.y,o.x,o.y);return t.dead=o.dead,t};class ll{constructor(e,t){r(this,"type");r(this,"x");r(this,"y");r(this,"dead");r(this,"roomID");r(this,"roomGID");r(this,"enemySpawn");r(this,"wizardState");r(this,"wizardParentID");r(this,"wizardParentGID");r(this,"state");var i,s;this.x=e.x,this.y=e.y,this.dead=e.dead,e instanceof ho&&(this.type=0,this.roomID=t.rooms.indexOf(e.room),this.roomGID=(i=e.room)==null?void 0:i.globalId,this.enemySpawn=new _n(e.enemy,t)),e instanceof Ws&&(this.type=1,this.wizardState=e.state,this.roomID=t.rooms.indexOf(e.parent.room),this.roomGID=(s=e.parent.room)==null?void 0:s.globalId,this.wizardParentID=e.parent.room.entities.indexOf(e.parent),this.wizardParentGID=e.parent.globalId,this.state=e.state)}}let cl=(o,e)=>{var t,i;if(o.type===0){let s=o.roomGID&&((t=e.roomsById)==null?void 0:t.get(o.roomGID))||e.rooms[o.roomID],a=Qa(o.enemySpawn,e),n=new ho(s,a,o.x,o.y);return n.dead=o.dead,n}if(o.type===1){const s=o.roomGID&&((i=e.roomsById)==null?void 0:i.get(o.roomGID))||e.rooms[o.roomID];let a;if(o.wizardParentGID){const c=s.entities.find(l=>l.globalId===o.wizardParentGID);c&&c instanceof qe&&(a=c)}if(!a){const c=s.entities[o.wizardParentID];c&&c instanceof qe&&(a=c)}if(!a)return;const n=new Ws(a,o.x,o.y);return n.state=o.wizardState,n}};var Yn=(o=>(o[o.BARREL=0]="BARREL",o[o.BIGSKULL=1]="BIGSKULL",o[o.CHARGE=2]="CHARGE",o[o.CHEST=3]="CHEST",o[o.COAL=4]="COAL",o[o.CRATE=5]="CRATE",o[o.EMERALD=6]="EMERALD",o[o.GOLD=7]="GOLD",o[o.KNIGHT=8]="KNIGHT",o[o.PLANT=9]="PLANT",o[o.POT=10]="POT",o[o.SKULL=11]="SKULL",o[o.CRAB=12]="CRAB",o[o.SPAWNER=13]="SPAWNER",o[o.VENDINGMACHINE=14]="VENDINGMACHINE",o[o.WIZARD=15]="WIZARD",o[o.ZOMBIE=16]="ZOMBIE",o[o.ARMOREDSKULL=17]="ARMOREDSKULL",o[o.ARMOREDZOMBIE=18]="ARMOREDZOMBIE",o[o.BIGKNIGHT=19]="BIGKNIGHT",o[o.BIGZOMBIE=20]="BIGZOMBIE",o[o.BISHOP=21]="BISHOP",o[o.ENERGYWIZARD=22]="ENERGYWIZARD",o[o.FIREWIZARD=23]="FIREWIZARD",o[o.FROG=24]="FROG",o[o.GLOWBUG=25]="GLOWBUG",o[o.MUMMY=26]="MUMMY",o[o.OCCULTIST=27]="OCCULTIST",o[o.QUEEN=28]="QUEEN",o[o.ROOK=29]="ROOK",o[o.SPIDER=30]="SPIDER",o[o.BUSH=31]="BUSH",o[o.FISHING_SPOT=32]="FISHING_SPOT",o[o.FURNACE=33]="FURNACE",o[o.PUMPKIN=34]="PUMPKIN",o[o.SPROUT=35]="SPROUT",o[o.TOMBSTONE=36]="TOMBSTONE",o[o.DECO_BLOCK=37]="DECO_BLOCK",o[o.TREE=38]="TREE",o[o.CHEST_LAYER=39]="CHEST_LAYER",o[o.BOMB=40]="BOMB",o[o.BLOCK=41]="BLOCK",o[o.DOWNLADDER_MAKER=42]="DOWNLADDER_MAKER",o[o.ROCK=43]="ROCK",o[o.MUSHROOMS=44]="MUSHROOMS",o[o.WARDEN=45]="WARDEN",o[o.OBSIDIAN=46]="OBSIDIAN",o[o.CRUSHER=47]="CRUSHER",o[o.PAWN=48]="PAWN",o[o.BIGFROG=49]="BIGFROG",o[o.BEETLE=50]="BEETLE",o[o.EXALTER=51]="EXALTER",o))(Yn||{});class _n{constructor(e,t){r(this,"type");r(this,"roomID");r(this,"roomGID");r(this,"x");r(this,"y");r(this,"health");r(this,"maxHealth");r(this,"isShielded");r(this,"shieldHealth");r(this,"shieldedBefore");r(this,"unconscious");r(this,"direction");r(this,"dead");r(this,"skipNextTurns");r(this,"destroyable");r(this,"hasDrop");r(this,"drop");r(this,"alertTicks");r(this,"ticks");r(this,"seenPlayer");r(this,"targetPlayerID");r(this,"ticksSinceFirstHit");r(this,"drops");r(this,"startX");r(this,"startY");r(this,"targetX");r(this,"targetY");r(this,"visualTargetX");r(this,"visualTargetY");r(this,"chargeEnemyState");r(this,"enemySpawnType");r(this,"isPlayerOpened");r(this,"playerOpenedID");r(this,"open");r(this,"costItems");r(this,"item");r(this,"isInf");r(this,"quantity");r(this,"wizardState");r(this,"rumbling");r(this,"isEnemy");r(this,"buffed");r(this,"buffedBefore");r(this,"chestOpened");var i,s;this.roomID=t.rooms.indexOf(e.room),this.roomGID=(i=e.room)==null?void 0:i.globalId,this.x=e.x,this.y=e.y,this.health=e.health,this.maxHealth=e.maxHealth,this.rumbling=e.rumbling,this.isEnemy=e.isEnemy;try{this.isShielded=e.shielded===!0,this.shieldHealth=((s=e.shield)==null?void 0:s.health)??void 0}catch{}try{this.buffed=e.buffed===!0}catch{}try{this.buffedBefore=e.buffedBefore===!0}catch{}if(this.shieldedBefore=e.shieldedBefore,this.unconscious=e.unconscious,this.direction=e.direction,this.dead=e.dead,this.skipNextTurns=e.skipNextTurns,this.destroyable=e.destroyable,this.hasDrop=!1,e.drop&&(this.hasDrop=!0,this.drop=new ts(e.drop,t)),this.alertTicks=e.alertTicks,e instanceof it&&(this.ticks=e.ticks,this.seenPlayer=e.seenPlayer,e.seenPlayer&&(this.targetPlayerID=Object.keys(t.players).find(a=>t.players[a]===e.targetPlayer),this.targetPlayerID||(this.targetPlayerID=Object.keys(t.offlinePlayers).find(a=>t.offlinePlayers[a]===e.targetPlayer)))),e instanceof We&&(this.type=0),e instanceof Nt){this.type=1,this.ticksSinceFirstHit=e.ticksSinceFirstHit,this.drops=[];for(const a of e.drops)a&&this.drops.push(new ts(a,t))}if(e instanceof Ft&&(this.type=2,this.chargeEnemyState=e.state,this.startX=e.startX,this.startY=e.startY,this.targetX=e.targetX,this.targetY=e.targetY,this.visualTargetX=e.visualTargetX,this.visualTargetY=e.visualTargetY),e instanceof Ot&&(this.type=3),e instanceof Ot&&(this.chestOpened=e.health<=2),e instanceof Qs&&(this.type=4),e instanceof Ge&&(this.type=5),e instanceof tr&&(this.type=6),e instanceof Js&&(this.type=7),e instanceof Lt&&(this.type=8),e instanceof Gs&&(this.type=9),e instanceof Ji&&(this.type=10),e instanceof _t&&(this.type=11,this.ticksSinceFirstHit=e.ticksSinceFirstHit),e instanceof Bt&&(this.type=12),e instanceof Ee&&(this.type=13,this.enemySpawnType=e.enemySpawnType),e instanceof ut){this.type=14,this.isPlayerOpened=!1,e.playerOpened&&(this.isPlayerOpened=!0,this.playerOpenedID=Object.keys(t.players).find(a=>t.players[a]===e.playerOpened),this.playerOpenedID||(this.playerOpenedID=Object.keys(t.offlinePlayers).find(a=>t.offlinePlayers[a]===e.playerOpened))),this.open=e.open,this.costItems=[];for(const a of e.costItems)a&&this.costItems.push(new ts(a,t));e.item&&(this.item=new ts(e.item,t)),this.isInf=e.isInf,this.quantity=e.quantity}e instanceof qe&&(this.type=15,this.wizardState=e.state),e instanceof te&&(this.type=16),e instanceof Dt&&(this.type=17),e instanceof Ct&&(this.type=18),e instanceof Ut&&(this.type=19),e instanceof mi&&(this.type=20),e instanceof Pt&&(this.type=21),e instanceof Mt&&(this.type=22),e instanceof Jt&&(this.type=23),e instanceof fe&&(this.type=24),e instanceof pi&&(this.type=25),e instanceof be&&(this.type=26),e instanceof He&&(this.type=27),e instanceof Xt&&(this.type=28),e instanceof Gt&&(this.type=29),e instanceof he&&(this.type=30),e instanceof Cs&&(this.type=31),e instanceof yo&&(this.type=32),e instanceof po&&(this.type=33),e instanceof Ir&&(this.type=34),e instanceof vr&&(this.type=35),e instanceof Re&&(this.type=36),e instanceof Ar&&(this.type=37),e instanceof fa&&(this.type=38),e instanceof Rn&&(this.type=39),e instanceof ui&&(this.type=40),e instanceof ci&&(this.type=41),e instanceof Dn&&(this.type=42),e instanceof Pi&&(this.type=43),e instanceof Qi&&(this.type=44),e instanceof Yi&&(this.type=45),e instanceof go&&(this.type=46),e instanceof gi&&(this.type=47),e instanceof Le&&(this.type=48),e instanceof Li&&(this.type=50),e instanceof Ye&&(this.type=49),e instanceof wi&&(this.type=51)}}let Qa=(o,e)=>{var s;let t,i=o.roomGID&&((s=e.roomsById)==null?void 0:s.get(o.roomGID))||e.rooms[o.roomID];if(o.type===0&&(t=new We(i,e,o.x,o.y)),o.type===1){t=new Nt(i,e,o.x,o.y),t.ticksSinceFirstHit=o.ticksSinceFirstHit,t.drops=[];for(const a of o.drops)a&&t.drops.push(es(a,e))}if(o.type===2&&(t=new Ft(i,e,o.x,o.y),t.state=o.chargeEnemyState,t.startX=o.startX,t.startY=o.startY,t.targetX=o.targetX,t.targetY=o.targetY,t.visualTargetX=o.visualTargetX,t.visualTargetY=o.visualTargetY),o.type===3&&(t=new Ot(i,e,o.x,o.y)),t instanceof Ot&&o.health<=2&&(t.tileX=6,t.tileY=2,t.opening=!1),o.type===4&&(t=new Qs(i,e,o.x,o.y)),o.type===5&&(t=new Ge(i,e,o.x,o.y)),o.type===6&&(t=new tr(i,e,o.x,o.y)),o.type===7&&(t=new Js(i,e,o.x,o.y)),o.type===8&&(t=new Lt(i,e,o.x,o.y)),o.type===9&&(t=new Gs(i,e,o.x,o.y)),o.type===10&&(t=new Ji(i,e,o.x,o.y)),o.type===11&&(t=new _t(i,e,o.x,o.y),t.ticksSinceFirstHit=o.ticksSinceFirstHit),o.type===12&&(t=new Bt(i,e,o.x,o.y)),o.type===13&&(t=new Ee(i,e,o.x,o.y,[o.enemySpawnType]),t.enemySpawnType=o.enemySpawnType),o.type===14){let a=es(o.item,e);t=new ut(i,e,o.x,o.y,a),o.isPlayerOpened&&(t.playerOpened=e.players[o.playerOpenedID],t.playerOpened||(t.playerOpened=e.offlinePlayers[o.playerOpenedID])),t.open=o.open,t.costItems=[];for(const n of o.costItems)n&&t.costItems.push(es(n,e));t.isInf=o.isInf,t.quantity=o.quantity}o.type===16&&(t=new te(i,e,o.x,o.y)),o.type===17&&(t=new Dt(i,e,o.x,o.y)),o.type===18&&(t=new Ct(i,e,o.x,o.y)),o.type===19&&(t=new Ut(i,e,o.x,o.y)),o.type===20&&(t=new mi(i,e,o.x,o.y)),o.type===21&&(t=new Pt(i,e,o.x,o.y)),o.type===22&&(t=new Mt(i,e,o.x,o.y)),o.type===23&&(t=new Jt(i,e,o.x,o.y)),o.type===24&&(t=new fe(i,e,o.x,o.y)),o.type===25&&(t=new pi(i,e,o.x,o.y)),o.type===26&&(t=new be(i,e,o.x,o.y)),o.type===27&&(t=new He(i,e,o.x,o.y)),o.type===45&&(t=new Yi(i,e,o.x,o.y)),o.type===47&&(t=new gi(i,e,o.x,o.y)),o.type===28&&(t=new Xt(i,e,o.x,o.y)),o.type===29&&(t=new Gt(i,e,o.x,o.y)),o.type===30&&(t=new he(i,e,o.x,o.y)),o.type===31&&(t=new Cs(i,e,o.x,o.y)),o.type===32&&(t=new yo(i,e,o.x,o.y)),o.type===33&&(t=new po(i,e,o.x,o.y)),o.type===34&&(t=new Ir(i,e,o.x,o.y)),o.type===35&&(t=new vr(i,e,o.x,o.y)),o.type===36&&(t=new Re(i,e,o.x,o.y)),o.type===37&&(t=new Ar(i,e,o.x,o.y)),o.type===38&&(t=new fa(i,e,o.x,o.y)),o.type===39&&(t=new Rn(i,e,o.x,o.y)),o.type===40&&(t=new ui(i,e,o.x,o.y)),o.type===41&&(t=new ci(i,e,o.x,o.y)),o.type===42&&(t=new Dn(i,e,o.x,o.y)),o.type===43&&(t=new Pi(i,e,o.x,o.y)),o.type===44&&(t=new Qi(i,e,o.x,o.y)),o.type===46&&(t=new go(i,e,o.x,o.y)),o.type===48&&(t=new Le(i,e,o.x,o.y)),o.type===49&&(t=new Ye(i,e,o.x,o.y)),o.type===50&&(t=new Li(i,e,o.x,o.y)),o.type===51&&(t=new wi(i,e,o.x,o.y)),o.isEnemy&&(t.ticks=o.ticks,t.seenPlayer=o.seenPlayer,o.seenPlayer&&(t.targetPlayer=e.players[o.targetPlayerID],t.targetPlayer||(t.targetPlayer=e.offlinePlayers[o.targetPlayerID]))),t||(console.error("Unknown enemy type:",o.type,"EnemyType enum value:",Yn[o.type],"Falling back to barrel"),t=new We(i,e,o.x,o.y)),t.x=o.x,t.y=o.y,t.health=o.health,t.maxHealth=o.maxHealth,t.shieldedBefore=o.shieldedBefore,t.buffed=o.buffed,t.buffedBefore=o.buffedBefore;try{o.isBuffed&&t.applyBuff()}catch{}try{if(o.isShielded){const a=o.shieldHealth??1;t.shielded||t.applyShield(a,!0)}}catch{}t.unconscious=o.unconscious,t.direction=o.direction,t.dead=o.dead,t.skipNextTurns=o.skipNextTurns,t.rumbling=o.rumbling,typeof o.destroyable=="boolean"&&(t.destroyable=o.destroyable),o.hasDrop&&(t.drop=es(o.drop,e)),t.alertTicks=o.alertTicks;try{t instanceof qe&&(t.ticks=o.ticks??0,t.state=o.wizardState??t.state,t.seenPlayer=o.seenPlayer??!1)}catch{}return t};class dl{constructor(e,t){r(this,"roomID");r(this,"roomGID");r(this,"pathId");r(this,"entered");r(this,"envType");r(this,"skin");r(this,"enemies");r(this,"items");r(this,"projectiles");r(this,"hitwarnings");r(this,"active");r(this,"onScreen");r(this,"lightingUpdateInProgress");r(this,"mapGroup");r(this,"tiles");var i;this.roomID=t.rooms.indexOf(e),this.roomGID=e.globalId,this.pathId=e.pathId||"main",this.entered=e.entered,this.envType=e.envType,this.skin=e.skin,this.active=e.active,this.onScreen=e.onScreen,this.mapGroup=e.mapGroup,this.enemies=[],this.items=[],this.projectiles=[],this.hitwarnings=[],this.tiles=[];for(let s=e.roomX-1;s<e.roomX+e.width+1;s++){this.tiles[s]=[];for(let a=e.roomY-1;a<e.roomY+e.height+1;a++){const n=(i=e.roomArray[s])==null?void 0:i[a];n&&this.shouldSaveTile(n)?this.tiles[s][a]=new pl(n,t):this.tiles[s][a]=null}}for(const s of e.entities)this.enemies.push(new _n(s,t));for(const s of e.items)s&&this.items.push(new ts(s,t));for(const s of e.projectiles)s instanceof yn||this.projectiles.push(new ll(s,t));for(const s of e.hitwarnings)this.hitwarnings.push(new nl(s))}shouldSaveTile(e){return e instanceof Ci||e instanceof ns||e instanceof et||e instanceof wt||e instanceof le||e instanceof bt||e instanceof kt||e instanceof $t||e instanceof ot||e instanceof rt}}let fl=(o,e,t)=>{var a,n,c,l,d,u,h;if(e.pathId&&(o.pathId=e.pathId),o.entered=e.entered,e.envType!==void 0&&(o.envType=e.envType,o.skin=o.envType),o.active=e.active,o.onScreen=e.onScreen,o.skin=e.skin,e.tiles){try{o.lightSources=[]}catch{}for(let f=o.roomX-1;f<o.roomX+o.width+1;f++)for(let p=o.roomY-1;p<o.roomY+o.height+1;p++){const y=(a=e.tiles[f])==null?void 0:a[p];if(y){const g=gl(y,o,t);o.roomArray[f][p]=g}}try{const f=new Map;for(let p=o.roomX-1;p<o.roomX+o.width+1;p++)for(let y=o.roomY-1;y<o.roomY+o.height+1;y++){const g=(n=e.tiles[p])==null?void 0:n[y],w=(c=o.roomArray[p])==null?void 0:c[y];if(g&&g.type===3&&w instanceof ot){const b=g.properties.globalId;b&&f.set(b,w)}w&&w.lightSource&&!((l=o.lightSources)!=null&&l.includes(w.lightSource))&&o.lightSources.push(w.lightSource)}for(let p=o.roomX-1;p<o.roomX+o.width+1;p++)for(let y=o.roomY-1;y<o.roomY+o.height+1;y++){const g=(d=e.tiles[p])==null?void 0:d[y],w=(u=o.roomArray[p])==null?void 0:u[y];if(g&&g.type===3&&w instanceof ot){const b=g.properties.linkedDoorGID;b&&f.has(b)&&w.link(f.get(b))}}}catch{}try{const f=[];for(let p=o.roomX-1;p<o.roomX+o.width+1;p++)for(let y=o.roomY-1;y<o.roomY+o.height+1;y++){const g=(h=o.roomArray[p])==null?void 0:h[y];g instanceof ot&&f.push(g)}o.doors=f}catch{}}o.entities=[],o.items=[],o.projectiles=[],o.hitwarnings=[];const i=e.enemies.filter(f=>f.type!==27),s=e.enemies.filter(f=>f.type===27);for(const f of i)o.entities.push(Qa(f,t));for(const f of s)o.entities.push(Qa(f,t));for(const f of e.items)f&&o.items.push(es(f,t,void 0,o));try{const f=new Map;for(const p of o.items){const y=p==null?void 0:p.sourceChestX,g=p==null?void 0:p.sourceChestY;if(y!==void 0&&g!==void 0){const w=`${y},${g}`,b=f.get(w)||[];b.push(p),f.set(w,b)}}for(const p of o.entities)if(p instanceof Ot&&p.health<=2){const y=`${p.x},${p.y}`,g=f.get(y);if(g&&g.length){p.drops=g.slice();continue}p.drops=o.items.filter(w=>w&&w.x===p.x&&w.y===p.y)}}catch{}for(const f of e.projectiles){const p=cl(f,t);p&&!p.dead&&o.projectiles.push(p)}for(const f of e.hitwarnings)o.hitwarnings.push(hl(f,t));try{const f=o.entities.filter(p=>p instanceof wi);for(const p of f)for(const y of p.buffedEnemies)y instanceof it&&!y.dead&&!y.buffed&&!y.buffedBefore&&p.applyBuffTo(y)}catch{}try{const f=o.entities.filter(g=>g instanceof He),p=o.entities.filter(g=>g instanceof it&&g.shielded&&!g.dead);for(const g of f)g.shieldedEnemies=[];const y=new Map;for(const g of p){let w=null,b=Number.POSITIVE_INFINITY;for(const T of f){if(T===g)continue;const v=Math.max(Math.abs(T.x-g.x),Math.abs(T.y-g.y));v<b&&(b=v,w=T)}if(w){const T=y.get(w)||[];T.push(g),y.set(w,T)}}for(const[g,w]of y.entries())g.shieldedEnemies=w.slice(),g.createBeam&&w.length&&g.createBeam(w)}catch{}try{const f=o.entities.filter(p=>p instanceof wi);if(f.length){const p=o.entities.filter(y=>y instanceof it&&y.buffed&&!y.dead);for(const y of f)y.buffedEnemies=[];for(const y of p){let g=null,w=Number.POSITIVE_INFINITY;for(const b of f){const T=Math.max(Math.abs(b.x-y.x),Math.abs(b.y-y.y));T<w&&(w=T,g=b)}g&&g.applyBuffTo(y)}}}catch{}o.calculateWallInfo(),o.updateLighting()};var Nn=(o=>(o[o.ARMOR=0]="ARMOR",o[o.BLUEGEM=1]="BLUEGEM",o[o.CANDLE=2]="CANDLE",o[o.COAL=3]="COAL",o[o.COIN=4]="COIN",o[o.GOLD=5]="GOLD",o[o.GOLDENKEY=6]="GOLDENKEY",o[o.GREENGEM=7]="GREENGEM",o[o.KEY=8]="KEY",o[o.LANTERN=9]="LANTERN",o[o.REDGEM=10]="REDGEM",o[o.TORCH=11]="TORCH",o[o.DAGGER=12]="DAGGER",o[o.DUALDAGGER=13]="DUALDAGGER",o[o.SHOTGUN=14]="SHOTGUN",o[o.SPEAR=15]="SPEAR",o[o.PICKAXE=16]="PICKAXE",o[o.BACKPACK=17]="BACKPACK",o[o.SPELLBOOK=18]="SPELLBOOK",o[o.WEAPON_FRAGMENTS=19]="WEAPON_FRAGMENTS",o[o.WARHAMMER=20]="WARHAMMER",o[o.HAMMER=21]="HAMMER",o[o.WEAPON_POISON=22]="WEAPON_POISON",o[o.WEAPON_BLOOD=23]="WEAPON_BLOOD",o[o.HEART=24]="HEART",o[o.MUSHROOMS=25]="MUSHROOMS",o[o.STONE=26]="STONE",o[o.BLUE_POTION=27]="BLUE_POTION",o[o.APPLE=28]="APPLE",o[o.BESTIARY_BOOK=29]="BESTIARY_BOOK",o[o.BOMB_ITEM=30]="BOMB_ITEM",o[o.ENTITY_SPAWNER=31]="ENTITY_SPAWNER",o[o.FISH=32]="FISH",o[o.FISHING_ROD=33]="FISHING_ROD",o[o.GEODE=34]="GEODE",o[o.GLOW_BUGS=35]="GLOW_BUGS",o[o.GOD_STONE=36]="GOD_STONE",o[o.GOLD_BAR=37]="GOLD_BAR",o[o.GOLD_RING=38]="GOLD_RING",o[o.GARNET_RING=39]="GARNET_RING",o[o.ZIRCON_RING=40]="ZIRCON_RING",o[o.EMERALD_RING=41]="EMERALD_RING",o[o.AMBER_RING=42]="AMBER_RING",o[o.GREEN_POTION=43]="GREEN_POTION",o[o.GREATAXE=44]="GREATAXE",o[o.HOURGLASS=45]="HOURGLASS",o[o.ORANGE_GEM=46]="ORANGE_GEM",o[o.SCYTHE=47]="SCYTHE",o[o.SCYTHE_HANDLE=48]="SCYTHE_HANDLE",o[o.SCYTHE_BLADE=49]="SCYTHE_BLADE",o[o.SLINGSHOT=50]="SLINGSHOT",o[o.SPELLBOOK_PAGE=51]="SPELLBOOK_PAGE",o[o.SWORD=52]="SWORD",o[o.SHIELD_LEFT_FRAGMENT=53]="SHIELD_LEFT_FRAGMENT",o[o.SHIELD_RIGHT_FRAGMENT=54]="SHIELD_RIGHT_FRAGMENT",o))(Nn||{});class ts{constructor(e,t){r(this,"type");r(this,"x");r(this,"y");r(this,"roomID");r(this,"roomGID");r(this,"stackCount");r(this,"pickedUp");r(this,"sourceChestX");r(this,"sourceChestY");r(this,"equipped");var i,s;if(!e)throw new Error("Cannot create ItemState from null item");e instanceof Wt&&(this.type=0),e instanceof ze&&(this.type=1),e instanceof ii&&(this.type=2),e instanceof Xi&&(this.type=3),e instanceof ct&&(this.type=4),e instanceof At&&(this.type=5),e instanceof wo&&(this.type=6),e instanceof _e&&(this.type=7),e instanceof ue&&(this.type=24),e instanceof Ze&&(this.type=8),e instanceof Ni&&(this.type=9),e instanceof ce&&(this.type=10),e instanceof si&&(this.type=11),e instanceof js&&(this.type=12),e instanceof Zs&&(this.type=13),e instanceof er&&(this.type=14),e instanceof we&&(this.type=15),e instanceof Ne&&(this.type=16),e instanceof hs&&(this.type=17),e instanceof da&&(this.type=28),e instanceof kr&&(this.type=29),e instanceof Us&&(this.type=30),e instanceof On&&(this.type=31),e instanceof $s&&(this.type=32),e instanceof Je&&(this.type=33),e instanceof Se&&(this.type=34),e instanceof ca&&(this.type=35),e instanceof mo&&(this.type=36),e instanceof Fs&&(this.type=37),e instanceof ls&&(this.type=38),e instanceof Bs&&(this.type=39),e instanceof Xs&&(this.type=40),e instanceof Ns&&(this.type=41),e instanceof Hs&&(this.type=42),e instanceof Mn&&(this.type=43),e instanceof oa&&(this.type=44),e instanceof no&&(this.type=45),e instanceof qs&&(this.type=46),e instanceof ps&&(this.type=47),e instanceof Bi&&(this.type=48),e instanceof Hi&&(this.type=49),e instanceof ua&&(this.type=25),e instanceof xo&&(this.type=50),e instanceof Qe&&(this.type=18),e instanceof zs&&(this.type=51),e instanceof aa&&(this.type=26),e instanceof ir&&(this.type=52),e instanceof ms&&(this.type=20),e instanceof ra&&(this.type=23),e instanceof sa&&(this.type=22),e instanceof ei&&(this.type=19),e instanceof Pn&&(this.type=27),e instanceof Ke&&(this.type=21),e instanceof Fi&&(this.type=53),e instanceof Ui&&(this.type=54),this.equipped=e instanceof vt&&e.equipped,this.x=e.x,this.y=e.y,this.roomID=t.rooms.indexOf(e.level),this.roomGID=(i=e.level)==null?void 0:i.globalId,this.stackCount=e.stackCount,this.pickedUp=e.pickedUp;try{const a=e.level,n=(s=a==null?void 0:a.entities)==null?void 0:s.find(c=>c instanceof Ot&&c.health<=2&&c.x===e.x&&c.y===e.y);n&&(this.sourceChestX=n.x,this.sourceChestY=n.y)}catch{}}}let es=(o,e,t,i)=>{var n,c;let s=i||o.roomGID&&((n=e.roomsById)==null?void 0:n.get(o.roomGID))||(o.roomID!==-1?e.rooms[o.roomID]:null),a;if(o.type===0&&(a=new Wt(s,o.x,o.y)),o.type===1&&(a=new ze(s,o.x,o.y)),o.type===2&&(a=new ii(s,o.x,o.y)),o.type===3&&(a=new Xi(s,o.x,o.y)),o.type===4&&(a=new ct(s,o.x,o.y)),o.type===5&&(a=new At(s,o.x,o.y)),o.type===6&&(a=new wo(s,o.x,o.y)),o.type===7&&(a=new _e(s,o.x,o.y)),o.type===24&&(a=new ue(s,o.x,o.y)),o.type===8&&(a=new Ze(s,o.x,o.y)),o.type===9&&(a=new Ni(s,o.x,o.y)),o.type===10&&(a=new ce(s,o.x,o.y)),o.type===11&&(a=new si(s,o.x,o.y)),o.type===12&&(a=new js(s,o.x,o.y)),o.type===13&&(a=new Zs(s,o.x,o.y)),o.type===14&&(a=new er(s,o.x,o.y)),o.type===15&&(a=new we(s,o.x,o.y)),o.type===16&&(a=new Ne(s,o.x,o.y)),o.type===17&&(a=new hs(s,o.x,o.y)),o.type===28&&(a=new da(s,o.x,o.y)),o.type===29&&(a=new kr(s,o.x,o.y)),o.type===30&&(a=new Us(s,o.x,o.y)),o.type===31&&(a=new On(s,o.x,o.y)),o.type===32&&(a=new $s(s,o.x,o.y)),o.type===33&&(a=new Je(s,o.x,o.y)),o.type===34&&(a=new Se(s,o.x,o.y)),o.type===35&&(a=new ca(s,o.x,o.y)),o.type===36&&(a=new mo(s,o.x,o.y)),o.type===37&&(a=new Fs(s,o.x,o.y)),o.type===38&&(a=new ls(s,o.x,o.y)),o.type===39&&(a=new Bs(s,o.x,o.y)),o.type===40&&(a=new Xs(s,o.x,o.y)),o.type===41&&(a=new Ns(s,o.x,o.y)),o.type===42&&(a=new Hs(s,o.x,o.y)),o.type===43&&(a=new Mn(s,o.x,o.y)),o.type===44&&(a=new oa(s,o.x,o.y)),o.type===45&&(a=new no(s,o.x,o.y)),o.type===46&&(a=new qs(s,o.x,o.y)),o.type===47&&(a=new ps(s,o.x,o.y)),o.type===48&&(a=new Bi(s,o.x,o.y)),o.type===49&&(a=new Hi(s,o.x,o.y)),o.type===25&&(a=new ua(s,o.x,o.y)),o.type===50&&(a=new xo(s,o.x,o.y)),o.type===18&&(a=new Qe(s,o.x,o.y)),o.type===51&&(a=new zs(s,o.x,o.y)),o.type===26&&(a=new aa(s,o.x,o.y)),o.type===52&&(a=new ir(s,o.x,o.y)),o.type===27&&(a=new Pn(s,o.x,o.y)),o.type===19&&(a=new ei(s,o.x,o.y)),o.type===20&&(a=new ms(s,o.x,o.y)),o.type===21&&(a=new Ke(s,o.x,o.y)),o.type===22&&(a=new sa(s,o.x,o.y)),o.type===23&&(a=new ra(s,o.x,o.y)),o.type===21&&(a=new Ke(s,o.x,o.y)),o.type===53&&(a=new Fi(s,o.x,o.y)),o.type===54&&(a=new Ui(s,o.x,o.y)),a||(console.error("Unknown item type:",o.type,"ItemType enum value:",Nn[o.type],"Falling back to coal"),a=new Xi(s,o.x,o.y)),a&&!a.game&&(a.game=e),!s&&a&&!a.level){const l=(c=e.players)==null?void 0:c[e.localPlayerID],d=l!=null&&l.getRoom?l.getRoom():e.rooms[e.players[e.localPlayerID].levelID];a.level=d}return o.equipped&&(a.equipped=!0),a instanceof vt&&a.setWielder(t),a&&!a.game&&(a.game=e),a.stackCount=o.stackCount,a.pickedUp=o.pickedUp,a};class ul{constructor(e,t){r(this,"isOpen");r(this,"cols");r(this,"rows");r(this,"selX");r(this,"selY");r(this,"equipAnimAmount");r(this,"isWeaponEquipped");r(this,"weaponI");r(this,"coins");r(this,"items");r(this,"expansion");this.isOpen=e.isOpen,this.cols=e.cols,this.rows=e.rows,this.equipAnimAmount=e.equipAnimAmount.map(i=>i),this.isWeaponEquipped=!1,e.weapon&&(this.isWeaponEquipped=!0,this.weaponI=e.items.indexOf(e.weapon)),this.coins=e.coins,this.selX=e.selX,this.selY=e.selY,this.items=Array(e.cols*e.rows),this.expansion=e.expansion;for(let i=0;i<e.cols*e.rows;i++)this.items[i]=null;for(const i of e.items)i&&(this.items[e.items.indexOf(i)]=new ts(i,t))}}let ml=(o,e,t)=>{o.clear();for(let i=0;i<e.items.length;i++){const s=e.items[i];if(s){const a=es(s,t,o.player);if(!a.level){const n=t.rooms[o.player.levelID];a.level=n}a.game||(a.game=t),o.items[i]=a,a instanceof Et&&o.weapon===null&&(a.toggleEquip(),o.weapon=a)}else o.items[i]=null}o.isOpen=e.isOpen,o.cols=e.cols,o.rows=e.rows,o.selX=e.selX,o.selY=e.selY,o.equipAnimAmount=e.equipAnimAmount.map(i=>i),o.coins=e.coins,o.expansion=e.expansion,e.isWeaponEquipped&&e.weaponI<o.items.length&&(o.weapon=o.items[e.weaponI])};class qo{constructor(e,t){r(this,"x");r(this,"y");r(this,"dead");r(this,"roomID");r(this,"roomGID");r(this,"mapGroup");r(this,"roomIndexInGroup");r(this,"direction");r(this,"health");r(this,"maxHealth");r(this,"lastTickHealth");r(this,"inventory");r(this,"hasOpenVendingMachine");r(this,"openVendingMachineRoomID");r(this,"openVendingMachineRoomGID");r(this,"openVendingMachineID");r(this,"openVendingMachineGID");r(this,"sightRadius");r(this,"lightEquipped");r(this,"lightColor");r(this,"lightBrightness");var a;this.x=e.x,this.y=e.y,this.dead=e.dead;const i=e!=null&&e.getRoom?e.getRoom():t.rooms[e.levelID];this.roomGID=i==null?void 0:i.globalId,this.roomID=i?t.rooms.indexOf(i):e.levelID,this.mapGroup=i==null?void 0:i.mapGroup;const s=i;if(s){const n=t.rooms.filter(c=>c.mapGroup===s.mapGroup).sort((c,l)=>c.id-l.id);this.roomIndexInGroup=n.findIndex(c=>c===s)}this.direction=e.direction,this.health=e.health,this.maxHealth=e.maxHealth,this.lastTickHealth=e.lastTickHealth,this.inventory=new ul(e.inventory,t),this.hasOpenVendingMachine=!1,e.openVendingMachine&&(this.hasOpenVendingMachine=!0,this.openVendingMachineRoomID=t.rooms.indexOf(e.openVendingMachine.room),this.openVendingMachineRoomGID=(a=e.openVendingMachine.room)==null?void 0:a.globalId,this.openVendingMachineID=e.openVendingMachine.room.entities.indexOf(e.openVendingMachine),this.openVendingMachineGID=e.openVendingMachine.globalId),this.sightRadius=e.sightRadius,this.lightEquipped=e.lightEquipped,this.lightColor=e.lightColor,this.lightBrightness=e.lightBrightness}}let $o=(o,e,t)=>{var s,a;let i=new fi(t,e.x,e.y,o===t.localPlayerID);if(i.dead=e.dead,e.roomGID&&((s=t.roomsById)!=null&&s.has(e.roomGID))){const n=t.roomsById.get(e.roomGID);i.roomGID=e.roomGID,i.levelID=t.rooms.indexOf(n)}else{let n;if(e.mapGroup!==void 0){const c=t.rooms.filter(l=>l.mapGroup===e.mapGroup).sort((l,d)=>l.id-d.id);c.length&&(e.roomIndexInGroup!==void 0&&e.roomIndexInGroup<c.length?n=c[e.roomIndexInGroup]:n=c.find(l=>l.id===e.roomID)||c[0])}if(!n){const c=t.rooms.find(l=>l.tileInside(e.x,e.y));c&&(n=c)}n||(n=t.rooms[e.roomID]),i.roomGID=n==null?void 0:n.globalId,i.levelID=n?t.rooms.indexOf(n):0}if(t.level&&(i.depth=t.level.depth),i.direction=e.direction,i.health=e.health,i.maxHealth=e.maxHealth,i.lastTickHealth=e.lastTickHealth,ml(i.inventory,e.inventory,t),e.hasOpenVendingMachine){const n=e.openVendingMachineRoomGID&&((a=t.roomsById)==null?void 0:a.get(e.openVendingMachineRoomGID))||t.rooms[e.openVendingMachineRoomID];i.openVendingMachine=e.openVendingMachineGID?n.entities.find(c=>c.globalId===e.openVendingMachineGID):n.entities[e.openVendingMachineID]}return i.sightRadius=e.sightRadius,typeof e.lightEquipped=="boolean"&&(i.lightEquipped=e.lightEquipped),Array.isArray(e.lightColor)&&(i.lightColor=e.lightColor),typeof e.lightBrightness=="number"&&(i.lightBrightness=e.lightBrightness),i},Xn=class{constructor(e){r(this,"depth");r(this,"width");r(this,"height");r(this,"isMainPath");r(this,"mapGroup");r(this,"envType");r(this,"levelGID");this.depth=e.depth,this.width=e.width,this.height=e.height,this.isMainPath=e.isMainPath,this.mapGroup=e.mapGroup,this.envType=e.environment.type,this.levelGID=e.globalId}};class Hn{constructor(){r(this,"seed");r(this,"randomState");r(this,"players");r(this,"offlinePlayers");r(this,"level");r(this,"rooms");r(this,"levelGID");r(this,"roomGIDs");r(this,"currentPathId");r(this,"sidepathMeta");r(this,"lastDroppedScythePiece",null);r(this,"lastDroppedShieldPiece",null);r(this,"stats");this.seed=0,this.randomState=0,this.players={},this.offlinePlayers={},this.level=null,this.rooms=[]}}const gr=o=>{var e,t;try{if((t=(e=o.replayManager)==null?void 0:e.isReplaying)!=null&&t.call(e))return console.warn(" SAVE: Skipped createGameState during replay"),null}catch{}try{let i=new Hn;i.stats=$e.getStats(),i.seed=o.levelgen.seed,i.randomState=O.state,i.lastDroppedScythePiece=o.lastDroppedScythePiece,i.lastDroppedShieldPiece=o.lastDroppedShieldPiece,o.level?(i.level=new Xn(o.level),i.levelGID=o.level.globalId):console.warn(" SAVE: No game.level found!");for(const s in o.players)try{const a=o.players[s],n=o.rooms[a.levelID];i.players[s]=new qo(o.players[s],o)}catch(a){throw console.error(` SAVE: Error saving player ${s}:`,a),a}for(const s in o.offlinePlayers)try{i.offlinePlayers[s]=new qo(o.offlinePlayers[s],o)}catch(a){throw console.error(` SAVE: Error saving offline player ${s}:`,a),a}try{i.currentPathId=o.currentPathId||"main"}catch{}try{const s={};for(const a of o.rooms)s[a.mapGroup]=(s[a.mapGroup]||0)+1}catch{}for(let s=0;s<o.rooms.length;s++){const a=o.rooms[s];try{a.catchUp();const n=new dl(a,o);i.rooms.push(n),(i.roomGIDs||(i.roomGIDs=[])).push(a.globalId)}catch(n){throw console.error(` SAVE: Error saving room ${s}:`,n),n}}try{const s=new Map;for(const a of i.rooms){const n=a.pathId||"main";n!=="main"&&s.set(n,(s.get(n)||0)+1)}i.sidepathMeta=Array.from(s.entries()).map(([a,n])=>({pathId:a,rooms:n}))}catch{}return i}catch(i){throw console.error(" SAVE: Fatal error in createGameState:",i),i}},Ja=(o,e,t,i)=>{try{$e&&t.stats&&$e.setStats(t.stats),o.rooms=[],o.roomsById=new Map,o.levels=[],o.levelsById=new Map;try{const s=require("./input");s.Input.mouseDownListeners.length=0,s.Input.mouseRightClickListeners.length=0,s.Input.mouseLeftClickListeners.length=0,s.Input.mouseMoveListeners.length=0,s.Input.mouseUpListeners.length=0}catch{}if(o.levelgen=new vi,o.levelgen.setSeed(t.seed),!t.level){console.warn(" LOAD: No level state found, creating default");const s=new An(o,0,1,1,!0,0,F.DUNGEON);t.level=new Xn(s)}return i?t.level.depth=0:O.setState(t.randomState),ht.emit(xt.LEVEL_GENERATION_STARTED,{}),o.levelgen.generateFirstNFloors(o,t.level.depth,!i).then(async()=>{var s,a,n,c,l;try{o.levelgen.setSeed(t.seed),O.setState(t.randomState)}catch{}ht.emit(xt.LEVEL_GENERATION_COMPLETED,{});try{const d=t.rooms||[],u=new Map;for(const y of d){const g=y.pathId;if(!g||g==="main")continue;const w=y.mapGroup;if(typeof w!="number")continue;const b=u.get(g);(b===void 0||w<b)&&u.set(g,w)}const h=Array.from(u.entries()).map(([y,g])=>({pid:y,mg:g})).sort((y,g)=>y.mg-g.mg),f=[];for(const y of h){if(o.rooms.some(v=>v.pathId===y.pid))continue;const w=o.rooms.length;await o.levelgen.generate(o,t.level.depth,!0,()=>{},t.level.envType,!i,y.pid,t.sidepathMeta?{caveRooms:((s=t.sidepathMeta.find(v=>v.pathId===y.pid))==null?void 0:s.rooms)??void 0}:void 0);const b=o.rooms.length,T=o.rooms.filter(v=>v.pathId===y.pid);for(const v of T)f.push(v)}const p=o.levels[t.level.depth];if(p){const y=new Set(p.rooms.map(T=>T.globalId)),g=f.filter(T=>!y.has(T.globalId)).sort((T,v)=>{const k=T.pathId||"main",D=v.pathId||"main";return k!==D?k<D?-1:1:T.mapGroup!==v.mapGroup?T.mapGroup-v.mapGroup:T.id-v.id});let w=0,b=p.rooms.length;for(const T of g)T.id=b+w,p.rooms.push(T),w++;o.rooms=p.rooms,o.roomsById=new Map(o.rooms.map(T=>[T.globalId,T]));try{const T={},v={};for(const k of o.rooms){const D=k.pathId||"main";T[D]=(T[D]||0)+1,v[k.mapGroup]=(v[k.mapGroup]||0)+1}}catch{}}}catch(d){console.warn(" LOAD: Sidepath generation by pathId failed",d)}if(i)o.players[o.localPlayerID]=new fi(o,0,0,!0),o.room=o.rooms[o.players[o.localPlayerID].levelID],o.room.enterLevel(o.players[o.localPlayerID]),o.players[o.localPlayerID].map.updateSeenTiles(),o.players[o.localPlayerID].map.saveMapData();else{try{const d=new Map;for(const u of t.rooms){if(!(u!=null&&u.roomGID))continue;let h=u.roomGID&&o.getRoomById(u.roomGID)||o.rooms.find(f=>f.mapGroup===u.mapGroup&&f.pathId===(u.pathId||"main")&&f.id===u.roomID)||o.rooms.find(f=>f.mapGroup===u.mapGroup&&f.id===u.roomID)||o.rooms.find(f=>f.id===u.roomID);if(h&&h.globalId!==u.roomGID)try{se.reserve(u.roomGID),h.globalId=u.roomGID}catch{}}o.roomsById=new Map(o.rooms.map(u=>[u.globalId,u]))}catch{}for(const d in t.players)try{const u=$o(d,t.players[d],o);o.players[d]=u}catch(u){throw console.error(` LOAD: Error loading player ${d}:`,u),u}for(const d in t.offlinePlayers)try{const u=$o(d,t.offlinePlayers[d],o);o.offlinePlayers[d]=u}catch(u){throw console.error(` LOAD: Error loading offline player ${d}:`,u),u}try{for(const d of t.rooms){let u="",h;const f=d.pathId||"main";if(d.roomGID){const w=o.getRoomById(d.roomGID);w&&(h=w,u="gid")}if(!h){const w=o.rooms.find(b=>b.mapGroup===d.mapGroup&&b.pathId===f&&b.id===d.roomID);w&&(h=w,u="group+path+id")}if(!h){const w=o.rooms.find(b=>b.mapGroup===d.mapGroup&&b.id===d.roomID);w&&(h=w,u="group+id")}if(!h){const w=o.rooms.find(b=>b.id===d.roomID);w&&(h=w,u="id")}const g=h;if(g){d.pathId&&(g.pathId=d.pathId);const w=o.room;try{o.room=g,fl(g,d,o)}finally{o.room=w}}}try{const d=new Map,u=[],h=new Map;for(const f of o.rooms)for(let p=f.roomX-1;p<f.roomX+f.width+1;p++)for(let y=f.roomY-1;y<f.roomY+f.height+1;y++){const g=(a=f.roomArray[p])==null?void 0:a[y];if(g instanceof ot){const w=g.globalId;w&&d.set(w,g),g._pendingLinkedDoorGID&&u.push(g);const b=`${p},${y}`,T=h.get(b)||[];T.push(g),h.set(b,T)}}for(const f of u){const p=f._pendingLinkedDoorGID;p&&d.has(p)&&f.link(d.get(p)),f._pendingLinkedDoorGID=null}for(const[f,p]of h.entries())if(p.length===2){const[y,g]=p;y.linkedDoor||y.link(g),g.linkedDoor||g.link(y)}}catch(d){console.warn(" LOAD: Global door linking failed",d)}}catch(d){throw console.error(" LOAD: Error loading room states:",d),d}if(e.includes(o.localPlayerID)){const d=o.players[o.localPlayerID];if(d)if(o.rooms.length>0){const u=t.players[o.localPlayerID],h=u!=null&&u.roomGID?o.getRoomById(u.roomGID):void 0;let f;if((u==null?void 0:u.mapGroup)!==void 0){const b=o.rooms.filter(T=>T.mapGroup===u.mapGroup).sort((T,v)=>T.id-v.id);b.length&&((u==null?void 0:u.roomIndexInGroup)!==void 0&&u.roomIndexInGroup<b.length?f=b[u.roomIndexInGroup]:(u==null?void 0:u.roomID)!==void 0&&(f=b.find(T=>T.id===u.roomID)||b[0]))}const p=o.rooms.find(b=>b.tileInside(d.x,d.y)),y=d.levelID<o.rooms.length?o.rooms[d.levelID]:void 0,g=h||f||p||y||o.rooms[0];o.room=g,d.levelID=o.rooms.indexOf(g);try{o.currentPathId=t.currentPathId||g.pathId||"main"}catch{}if(o.updateLevel(o.room),o.currentDepth=o.level.depth,d.depth=o.level.depth,!g.tileInside(d.x,d.y)){const b=g.getRoomCenter();d.moveSnap(b.x,b.y)}o.room.enterLevel(d,{x:d.x,y:d.y}),d.map.updateSeenTiles();try{o.room.updateLighting()}catch{}const w=(n=o.room.roomArray[d.x])==null?void 0:n[d.y];if(!w||w.isSolid()){console.warn(" LOAD: Player in invalid position, moving to room center");const b=o.room.getRoomCenter();d.moveSnap(b.x,b.y)}}else throw console.error(" LOAD: Invalid levelID for local player:",d.levelID),new Error(`Invalid levelID ${d.levelID} for local player`)}}try{(l=(c=o.room)==null?void 0:c.updateLighting)==null||l.call(c)}catch{}return o.chat=[],o}).catch(s=>{throw console.error(" LOAD: Level generation failed:",s),s})}catch(s){throw console.error(" LOAD: Fatal error in loadGameState:",s),s}};var Bn=(o=>(o[o.FLOOR=0]="FLOOR",o[o.WALL=1]="WALL",o[o.WALL_TORCH=2]="WALL_TORCH",o[o.DOOR=3]="DOOR",o[o.DOWN_LADDER=4]="DOWN_LADDER",o[o.UP_LADDER=5]="UP_LADDER",o[o.POOL=6]="POOL",o[o.CHASM=7]="CHASM",o[o.SPAWN_FLOOR=8]="SPAWN_FLOOR",o[o.SPIKE_TRAP=9]="SPIKE_TRAP",o[o.SPIKE=10]="SPIKE",o[o.TRAP_DOOR=11]="TRAP_DOOR",o[o.BONES=12]="BONES",o))(Bn||{});class pl{constructor(e,t){r(this,"type");r(this,"x");r(this,"y");r(this,"properties");var i,s,a,n,c;if(!e)throw new Error("Cannot create TileState from null tile");if(this.x=e.x,this.y=e.y,this.properties={},e instanceof bt)this.type=0;else if(e instanceof kt)this.type=2,this.properties.isBottomWall=e.isBottomWall,this.properties.frame=e.frame;else if(e instanceof et)this.type=1;else if(e instanceof ot)this.type=3,this.properties.doorType=e.type,this.properties.type=e.type,this.properties.isOpen=e.isOpen,this.properties.opened=e.opened,this.properties.locked=e.locked,this.properties.lockType=(i=e.lockable)==null?void 0:i.lockType,this.properties.keyID=(s=e.lockable)==null?void 0:s.keyID,this.properties.doorDir=e.doorDir,this.properties.tunnelDoor=e.tunnelDoor,this.properties.globalId=e.globalId,this.properties.linkedDoorGID=((a=e.linkedDoor)==null?void 0:a.globalId)||null;else if(e instanceof wt){this.type=4,this.properties.isSidePath=e.isSidePath,this.properties.environment=e.environment,this.properties.lockType=(n=e.lockable)==null?void 0:n.lockType,this.properties.keyID=(c=e.lockable)==null?void 0:c.keyID;const l=e.linkedRoom||null;this.properties.linkedRoomGID=l?l.globalId:null}else if(e instanceof le){this.type=5,this.properties.isRope=e.isRope||!1;const l=e.linkedRoom||null;this.properties.linkedRoomGID=l?l.globalId:null}else if(e instanceof ns){this.type=6;const l=e.skin===1?24:20,d=4;this.properties.leftEdge=e.tileX<l,this.properties.rightEdge=e.tileX>l,this.properties.topEdge=e.topEdge,this.properties.bottomEdge=e.tileY>d}else if(e instanceof Ci){this.type=7;const l=e.skin===1?24:20,d=1;this.properties.leftEdge=e.tileX<l,this.properties.rightEdge=e.tileX>l,this.properties.topEdge=e.topEdge,this.properties.bottomEdge=e.tileY>d}else e instanceof $t?this.type=8:e instanceof rt?(this.type=9,this.properties.triggered=e.triggered):e instanceof Cn?this.type=10:e instanceof xn?this.type=11:e instanceof Ln?this.type=12:(this.type=0,console.warn("Unknown tile type, defaulting to FLOOR:",e.constructor.name))}}let gl=(o,e,t)=>{var s,a;let i;switch(o.type){case 0:i=new bt(e,o.x,o.y);break;case 1:i=new et(e,o.x,o.y);break;case 2:i=new kt(e,o.x,o.y,o.properties.isBottomWall),i.frame=o.properties.frame||0;break;case 3:const n=o.properties.doorType??o.properties.type??Ti.DOOR;i=new ot(e,t,o.x,o.y,o.properties.doorDir,n),i.isOpen=o.properties.isOpen||!1,typeof o.properties.opened=="boolean"&&(i.opened=o.properties.opened),typeof o.properties.locked=="boolean"&&(i.locked=o.properties.locked);try{i.lockable&&o.properties.lockType!==void 0&&(i.lockable.lockType=o.properties.lockType,i.lockable.keyID=o.properties.keyID)}catch{}if(i._pendingLinkedDoorGID=o.properties.linkedDoorGID||null,o.properties.globalId)try{se.reserve(o.properties.globalId),i.globalId=o.properties.globalId}catch{}break;case 4:if(i=new wt(e,t,o.x,o.y,o.properties.isSidePath||!1,o.properties.environment,o.properties.lockType,void 0,{lockType:o.properties.lockType,keyID:o.properties.keyID}),o.properties.linkedRoomGID){const c=(s=t.roomsById)==null?void 0:s.get(o.properties.linkedRoomGID);c&&(i.linkedRoom=c)}break;case 5:if(i=new le(e,t,o.x,o.y),i.isRope=!!o.properties.isRope,o.properties.linkedRoomGID){const c=(a=t.roomsById)==null?void 0:a.get(o.properties.linkedRoomGID);c&&(i.linkedRoom=c)}break;case 6:i=new ns(e,o.x,o.y,o.properties.leftEdge||!1,o.properties.rightEdge||!1,o.properties.topEdge||!1,o.properties.bottomEdge||!1);break;case 7:i=new Ci(e,o.x,o.y,o.properties.leftEdge||!1,o.properties.rightEdge||!1,o.properties.topEdge||!1,o.properties.bottomEdge||!1);break;case 8:i=new $t(e,o.x,o.y);break;case 9:i=new rt(e,o.x,o.y),i.triggered=o.properties.triggered||!1;break;case 10:i=new Cn(e,o.x,o.y);break;case 12:i=new Ln(e,o.x,o.y);break;default:console.error("Unknown tile type:",o.type,"TileType enum value:",Bn[o.type],"Falling back to floor"),i=new bt(e,o.x,o.y);break}return i.skin=e.skin,i};class bo{constructor(e=100,t=100){r(this,"rooms",[]);r(this,"canvas");r(this,"ctx");r(this,"width");r(this,"height");r(this,"settled",!1);this.width=e,this.height=t,this.canvas=document.createElement("canvas"),this.canvas.width=e,this.canvas.height=t,this.ctx=this.canvas.getContext("2d"),this.ctx.imageSmoothingEnabled=!1,this.ctx.webkitImageSmoothingEnabled=!1,this.ctx.mozImageSmoothingEnabled=!1,this.ctx.msImageSmoothingEnabled=!1}generateRoomSize(){const i=Math.max(2,Math.min(25,Q.randomNormalInt(2,25,{median:6}))),s=Math.max(2,Math.min(25,Q.randomNormalInt(2,25,{median:6})));return{width:i,height:s}}calculateMass(e,t){return e*t*.1}generateRooms(e,t=O.rand,i="center"){this.rooms=[],this.settled=!1;for(let s=0;s<e;s++){const{width:a,height:n}=this.generateRoomSize(),c=this.calculateMass(a,n);let l,d;switch(i){case"split":s<e/2?(l=this.width*.6+t()*this.width*.3,d=this.height*.1+t()*this.height*.3):(l=this.width*.1+t()*this.width*.3,d=this.height*.6+t()*this.height*.3);break;case"corners":switch(Math.floor(t()*4)){case 0:l=this.width*.1+t()*this.width*.2,d=this.height*.1+t()*this.height*.2;break;case 1:l=this.width*.7+t()*this.width*.2,d=this.height*.1+t()*this.height*.2;break;case 2:l=this.width*.1+t()*this.width*.2,d=this.height*.7+t()*this.height*.2;break;case 3:l=this.width*.7+t()*this.width*.2,d=this.height*.7+t()*this.height*.2;break}break;default:l=this.width*.3+t()*this.width*.4,d=this.height*.3+t()*this.height*.4}this.rooms.push({x:l,y:d,width:a,height:n,vx:0,vy:0,mass:c,id:s})}}roomsCollide(e,t){return!(e.x+e.width+1<=t.x||t.x+t.width+1<=e.x||e.y+e.height+1<=t.y||t.y+t.height+1<=e.y)}shouldSnap(e,t){const s=Math.min(Math.abs(e.x+e.width+1-t.x),Math.abs(t.x+t.width+1-e.x)),a=Math.min(Math.abs(e.y+e.height+1-t.y),Math.abs(t.y+t.height+1-e.y)),n=!(e.x+e.width<t.x||t.x+t.width<e.x),c=!(e.y+e.height<t.y||t.y+t.height<e.y);return s<3&&c||a<3&&n}snapRooms(e,t){const i=!(e.x+e.width<t.x||t.x+t.width<e.x),s=!(e.y+e.height<t.y||t.y+t.height<e.y);if(i)if(e.y<t.y){const a=e.y+e.height+1;t.y=a,t.vy=0,e.vy=0}else{const a=t.y+t.height+1;e.y=a,e.vy=0,t.vy=0}else if(s)if(e.x<t.x){const a=e.x+e.width+1;t.x=a,t.vx=0,e.vx=0}else{const a=t.x+t.width+1;e.x=a,e.vx=0,t.vx=0}}resolveCollision(e,t){const i=Math.min(e.x+e.width+1-t.x,t.x+t.width+1-e.x),s=Math.min(e.y+e.height+1-t.y,t.y+t.height+1-e.y);if(i<s){const a=e.x<t.x?-1:1,n=e.mass+t.mass,c=i/2;e.x+=a*c*(t.mass/n),t.x-=a*c*(e.mass/n),e.vx+=a*.1*(t.mass/n),t.vx-=a*.1*(e.mass/n)}else{const a=e.y<t.y?-1:1,n=e.mass+t.mass,c=s/2;e.y+=a*c*(t.mass/n),t.y-=a*c*(e.mass/n),e.vy+=a*.1*(t.mass/n),t.vy-=a*.1*(e.mass/n)}}simulatePhysics(e=1e3){for(let s=0;s<e;s++){let a=!1;for(let n=0;n<this.rooms.length;n++)for(let c=n+1;c<this.rooms.length;c++)this.roomsCollide(this.rooms[n],this.rooms[c])&&(this.resolveCollision(this.rooms[n],this.rooms[c]),a=!0);for(let n=0;n<this.rooms.length;n++)for(let c=n+1;c<this.rooms.length;c++)this.shouldSnap(this.rooms[n],this.rooms[c])&&this.snapRooms(this.rooms[n],this.rooms[c]);for(const n of this.rooms)n.x+=n.vx,n.y+=n.vy,n.vx*=.95,n.vy*=.95,n.x=Math.max(1,Math.min(this.width-n.width-1,n.x)),n.y=Math.max(1,Math.min(this.height-n.height-1,n.y)),(Math.abs(n.vx)>.01||Math.abs(n.vy)>.01)&&(a=!0);if(!a){console.log(`Physics settled after ${s} iterations`);break}}for(const s of this.rooms)s.x=Math.round(s.x),s.y=Math.round(s.y);this.settled=!0}generatePNG(){this.ctx.clearRect(0,0,this.width,this.height),this.ctx.imageSmoothingEnabled=!1,this.ctx.fillStyle="white";for(const e of this.rooms)this.ctx.fillRect(Math.floor(e.x),Math.floor(e.y),e.width,e.height);return this.canvas}savePNG(e){const t=this.generatePNG(),i=new Date().toISOString().replace(/[:.]/g,"-"),s=e||`level_${i}.png`,a=document.createElement("a");a.download=`generated_levels/${s}`,a.href=t.toDataURL("image/png"),document.body.appendChild(a),a.click(),document.body.removeChild(a),console.log(`Generated level PNG (${this.width}x${this.height}):`,a.href),console.log(`Suggested save path: generated_levels/${s}`)}draw(e=0,t=0,i=2){if(m.ctx){m.ctx.save(),m.ctx.imageSmoothingEnabled=!1,m.ctx.webkitImageSmoothingEnabled=!1,m.ctx.mozImageSmoothingEnabled=!1,m.ctx.msImageSmoothingEnabled=!1,m.ctx.fillStyle="rgba(0, 0, 0, 0.8)",m.ctx.fillRect(e,t,this.width*i,this.height*i),m.ctx.strokeStyle="rgba(100, 100, 100, 0.3)",m.ctx.lineWidth=1;for(let s=0;s<=this.width;s+=10)m.ctx.beginPath(),m.ctx.moveTo(e+s*i,t),m.ctx.lineTo(e+s*i,t+this.height*i),m.ctx.stroke();for(let s=0;s<=this.height;s+=10)m.ctx.beginPath(),m.ctx.moveTo(e,t+s*i),m.ctx.lineTo(e+this.width*i,t+s*i),m.ctx.stroke();for(const s of this.rooms){const a=s.width/s.height;let n;a>1.5?n=200+s.id*30%60:a<.67?n=0+s.id*30%60:n=100+s.id*30%60,m.ctx.fillStyle=`hsl(${n}, 70%, 60%)`,m.ctx.fillRect(e+Math.floor(s.x)*i,t+Math.floor(s.y)*i,s.width*i,s.height*i),m.ctx.strokeStyle="white",m.ctx.lineWidth=1,m.ctx.strokeRect(e+Math.floor(s.x)*i,t+Math.floor(s.y)*i,s.width*i,s.height*i),i>=2&&(m.ctx.fillStyle="white",m.ctx.font="10px monospace",m.ctx.textAlign="center",m.ctx.fillText(`${s.id}`,e+(s.x+s.width/2)*i,t+(s.y+s.height/2)*i-2),i>=3&&(m.ctx.font="8px monospace",m.ctx.fillText(`${s.width}${s.height}`,e+(s.x+s.width/2)*i,t+(s.y+s.height/2)*i+8)))}m.ctx.restore()}}static generateRandomLevel(e=80,t=60,i=15,s=O.rand,a="center"){const n=new bo(e,t);return n.generateRooms(i,s,a),n.simulatePhysics(),n}getRooms(){return[...this.rooms]}areRoomsAccessible(){if(this.rooms.length===0||this.rooms.length===1)return!0;const e=new Set,t=[0];for(e.add(0);t.length>0;){const i=t.shift(),s=this.rooms[i];for(let a=0;a<this.rooms.length;a++){if(e.has(a))continue;const n=this.rooms[a],c=Math.abs(s.x+s.width+1-n.x)<1||Math.abs(n.x+n.width+1-s.x)<1,l=Math.abs(s.y+s.height+1-n.y)<1||Math.abs(n.y+n.height+1-s.y)<1,d=!(s.x+s.width<n.x||n.x+n.width<s.x),u=!(s.y+s.height<n.y||n.y+n.height<s.y);(c&&u||l&&d)&&(e.add(a),t.push(a))}}return e.size===this.rooms.length}}class yl{constructor(e,t,i,s,a,n){this.x=e,this.y=t,this.duration=i,this.speed=s,this.frame=a,this.active=n,this.x=e,this.y=t,this.speed=s,this.frame=0,this.active=!1}}const Zo=["Too dark? Equip a light source to light up the area around you.","Red X's show dangerous tiles, stay off of them to avoid taking damage.","If you kill an enemy, it can't hit you on the next turn.","Use weapon fragments on your weapon to repair broken weapons.","A yellow box around an item means it can be used on another item.","Lanterns can be refueled with coal.","Some objects can be pushed and kill enemies by crushing them.","Reapers spawn other enemies. Target them first to avoid being overrun.","Occultists apply a purple occult shield to enemies, giving them an extra health.","Killing an Occultist also removes the shields of each shielded enemy.","Some enemies have helmets, giving them extra health.","The shield absorbs one damage, and regenerates within 15 turns.","Explore alternate pathways like caves to gather resources to prepare for tough battles.","Vending machine sell useful items in exchange for coins.","Different enemies have different movement and attack patterns.","Frogs can only deal half damage, but can attack two tiles away in any direction.","Sometimes you will need to switch weapons mid-fight to use the best one for the situation.","Once you reach the end of a level you can get back to the beginning easily through tunnel doors.","Dual daggers give you an extra turn. After attacking you can attack or move again.","The Warhammer does two damage for taking out enemies with more than one health.","The spear has an attack range of two, so you can hit enemies from a safe distance.","Bombs can be placed to blow up enemies, just be sure to avoid blowing yourself up.","Mushrooms heal one half health.","Weapon blood can be applied to your weapon, giving it a powerful bleed effect upon attacking.","Weapon poison can be applied to your weapon poisoning enemies upon attacking.","The spellbook can attack multiple enemies from long range, great for getting out of tough situations.","Bishops can move diagonally and might sneak up on you if you aren't careful.","Rooks can move every turn and attack from any direction.","Queens can move any direction and have two health, but retreat when hit.","Dark? Equip light source.","Red X = danger. Avoid.","Kill enemy = safe next turn.","Use fragments to repair weapons.","Yellow box = usable on items.","Coal refuels lanterns.","Push objects to crush enemies.","Kill reapers first - they spawn enemies.","Occultists give enemies purple shields.","Kill occultist = remove all shields.","Helmets = extra enemy health.","Shield: 1 damage, regens in 15 turns.","Explore caves for resources.","Vending machines: coins for items.","Enemies have unique patterns.","Frogs: half damage, 2-tile range.","Switch weapons mid-fight.","Tunnel doors = quick return to start.","Dual daggers = extra turn after attack.","Warhammer: 2 damage vs multi-health.","Spear: 2-tile range.","Bombs blow up enemies (not you).","Mushrooms: heal 0.5 health.","Weapon blood = bleed effect.","Weapon poison = poison effect.","Spellbook: multi-enemy, long range.","Bishops: diagonal movement.","Rooks: move every turn, any direction.","Queens: 2 health, retreat when hit."];class wl{static getRandomTip(){return Zo[Math.floor(O.rand()*Zo.length)]}}class xl{constructor(){r(this,"actions",[]);r(this,"startMs",0);r(this,"recording",!1);r(this,"replaying",!1);r(this,"seed");r(this,"timer",null);r(this,"baseState",null)}beginRecording(e,t){if(this.actions=[],this.startMs=Date.now(),this.recording=!0,this.replaying=!1,this.seed=e,t){const i=()=>{var s;try{if(!!((s=t.players)==null?void 0:s[t.localPlayerID])&&!!t.room&&t.levelState===Qt.IN_LEVEL&&Array.isArray(t.rooms)&&t.rooms.length>0){this.baseState||(this.baseState=gr(t));return}}catch{}setTimeout(i,16)};setTimeout(i,0)}}getStats(){return{count:this.actions.length,seed:this.seed,recording:this.recording,replaying:this.replaying}}isReplaying(){return this.replaying}isRecording(){return this.recording}clearRecording(){this.actions=[],this.seed=void 0,this.startMs=0,this.recording=!1,this.replaying=!1}stopRecording(){this.recording=!1}recordAction(e){!this.recording||this.replaying||this.actions.push({t:Date.now()-this.startMs,action:e})}replay(e,t=x.REPLAY_STEP_MS){if(this.replaying)return;this.replaying=!0,this.recording=!1;const i=this.actions.slice(),s=this.seed;if(i.length===0||s===void 0){e.pushMessage("No actions recorded; replay aborted."),this.replaying=!1;return}e.pushMessage(`Replay starting with ${i.length} actions...`);const a=()=>{var u;const c=(u=e.players)==null?void 0:u[e.localPlayerID];if(!c){setTimeout(a,16);return}let l=0;const d=()=>{var y,g,w,b;if(l>=i.length){this.replaying=!1,this.recording=!1,e.pushMessage("Replay finished.");return}try{const T=i[l].action,v=c.x,k=c.y;let D;try{D=(g=(y=c.movement)==null?void 0:y.canMove)==null?void 0:g.call(y)}catch{}const N=(w=c.getRoom)==null?void 0:w.call(c),U=N==null?void 0:N.turn;console.log("[replay] step begin",{index:l+1,total:i.length,type:T.type,before:{x:v,y:k},turn:U,canMove:D}),c.menu.open=!1,c.dead=!1,c.inventory.close(),c.actionProcessor.process(T);const Z=c.x,j=c.y,V=v!==Z||k!==j;console.log("[replay] step end",{index:l+1,type:T.type,after:{x:Z,y:j},moved:V})}catch{}const h=Math.max(x.MOVEMENT_COOLDOWN+5,t),f=h;l<i.length-1&&Math.max(1,i[l+1].t-i[l].t);let p=Math.max(f,h);try{const T=(b=c.getRoom)==null?void 0:b.call(c);T&&T.turn!==void 0&&T.turn===1&&(p+=x.REPLAY_COMPUTER_TURN_DELAY)}catch{}console.log("[replay] schedule next",{index:l+1,recordedDelay:f,minDelay:h,nextDelay:p}),l++,this.timer&&window.clearTimeout(this.timer),this.timer=window.setTimeout(d,p)};d()};if(this.baseState)try{const c=JSON.parse(JSON.stringify(this.baseState)),l=Object.keys(e.players);Ja(e,l,c,!1).then(()=>{var d;e.started=!0,e.startedFadeOut=!1,this.recording=!1;try{console.log("[replay] seed/state after load",{seed:(d=e.levelgen)==null?void 0:d.seed,expectedSeed:c.seed,randomState:O.state,expectedRandom:c.randomState})}catch{}a()}).catch(()=>{e.newGame(s),e.started=!0,e.startedFadeOut=!1,this.recording=!1;const d=()=>{e.levelState===Qt.IN_LEVEL&&(ht.off(xt.LEVEL_GENERATION_COMPLETED,d),a())};ht.on(xt.LEVEL_GENERATION_COMPLETED,d),setTimeout(d,0)});return}catch{}e.newGame(s),e.started=!0,e.startedFadeOut=!1,this.recording=!1;const n=()=>{e.levelState===Qt.IN_LEVEL&&(ht.off(xt.LEVEL_GENERATION_COMPLETED,n),a())};ht.on(xt.LEVEL_GENERATION_COMPLETED,n),setTimeout(n,0)}}class bl extends pe{constructor({text:e,linkUrl:t,x:i,y:s}){const a=m.measureText(e).width+10;super(i,s,a,16,e,()=>window.open(t,"_blank","noopener,noreferrer"),!1)}draw(){m.ctx.save(),m.ctx.imageSmoothingEnabled=!1,m.ctx.fillStyle="rgba(100, 100, 100, 0.8)",m.ctx.fillRect(Math.round(this.x),Math.round(this.y),Math.round(this.width),Math.round(this.height)),m.ctx.fillStyle=q.LEVEL_TEXT_COLOR,m.ctx.lineWidth=1,m.ctx.strokeRect(Math.round(this.x),Math.round(this.y),Math.round(this.width),Math.round(this.height)),m.ctx.fillStyle="rgba(255, 255, 255, 1)";const e=m.measureText(this.text).width,t=this.x+(this.width-e)/2,i=this.y+this.height/2-m.letter_height/2;m.ctx.fillStyle=q.LEVEL_TEXT_COLOR,m.fillText(this.text,Math.round(t),Math.round(i)),m.ctx.restore()}}class El extends bl{constructor({x:e,y:t}={x:x.WIDTH/2,y:x.HEIGHT/2}){super({text:"Provide Feedback",linkUrl:"https://forms.gle/sWzqPGCa1L9XJ3Mk8",x:e,y:t})}}function Fn(o,e){return function(){return o.apply(e,arguments)}}const{toString:Sl}=Object.prototype,{getPrototypeOf:Eo}=Object,{iterator:ma,toStringTag:Un}=Symbol,pa=(o=>e=>{const t=Sl.call(e);return o[t]||(o[t]=t.slice(8,-1).toLowerCase())})(Object.create(null)),Te=o=>(o=o.toLowerCase(),e=>pa(e)===o),ga=o=>e=>typeof e===o,{isArray:ys}=Array,us=ga("undefined");function sr(o){return o!==null&&!us(o)&&o.constructor!==null&&!us(o.constructor)&&ee(o.constructor.isBuffer)&&o.constructor.isBuffer(o)}const Gn=Te("ArrayBuffer");function Tl(o){let e;return typeof ArrayBuffer<"u"&&ArrayBuffer.isView?e=ArrayBuffer.isView(o):e=o&&o.buffer&&Gn(o.buffer),e}const Il=ga("string"),ee=ga("function"),Wn=ga("number"),rr=o=>o!==null&&typeof o=="object",vl=o=>o===!0||o===!1,yr=o=>{if(pa(o)!=="object")return!1;const e=Eo(o);return(e===null||e===Object.prototype||Object.getPrototypeOf(e)===null)&&!(Un in o)&&!(ma in o)},Al=o=>{if(!rr(o)||sr(o))return!1;try{return Object.keys(o).length===0&&Object.getPrototypeOf(o)===Object.prototype}catch{return!1}},kl=Te("Date"),Ol=Te("File"),Ml=Te("Blob"),Pl=Te("FileList"),Rl=o=>rr(o)&&ee(o.pipe),Dl=o=>{let e;return o&&(typeof FormData=="function"&&o instanceof FormData||ee(o.append)&&((e=pa(o))==="formdata"||e==="object"&&ee(o.toString)&&o.toString()==="[object FormData]"))},Cl=Te("URLSearchParams"),[Ll,Yl,_l,Nl]=["ReadableStream","Request","Response","Headers"].map(Te),Xl=o=>o.trim?o.trim():o.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,"");function ar(o,e,{allOwnKeys:t=!1}={}){if(o===null||typeof o>"u")return;let i,s;if(typeof o!="object"&&(o=[o]),ys(o))for(i=0,s=o.length;i<s;i++)e.call(null,o[i],i,o);else{if(sr(o))return;const a=t?Object.getOwnPropertyNames(o):Object.keys(o),n=a.length;let c;for(i=0;i<n;i++)c=a[i],e.call(null,o[c],c,o)}}function Vn(o,e){if(sr(o))return null;e=e.toLowerCase();const t=Object.keys(o);let i=t.length,s;for(;i-- >0;)if(s=t[i],e===s.toLowerCase())return s;return null}const Ri=typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof window<"u"?window:global,jn=o=>!us(o)&&o!==Ri;function to(){const{caseless:o,skipUndefined:e}=jn(this)&&this||{},t={},i=(s,a)=>{const n=o&&Vn(t,a)||a;yr(t[n])&&yr(s)?t[n]=to(t[n],s):yr(s)?t[n]=to({},s):ys(s)?t[n]=s.slice():(!e||!us(s))&&(t[n]=s)};for(let s=0,a=arguments.length;s<a;s++)arguments[s]&&ar(arguments[s],i);return t}const Hl=(o,e,t,{allOwnKeys:i}={})=>(ar(e,(s,a)=>{t&&ee(s)?o[a]=Fn(s,t):o[a]=s},{allOwnKeys:i}),o),Bl=o=>(o.charCodeAt(0)===65279&&(o=o.slice(1)),o),Fl=(o,e,t,i)=>{o.prototype=Object.create(e.prototype,i),o.prototype.constructor=o,Object.defineProperty(o,"super",{value:e.prototype}),t&&Object.assign(o.prototype,t)},Ul=(o,e,t,i)=>{let s,a,n;const c={};if(e=e||{},o==null)return e;do{for(s=Object.getOwnPropertyNames(o),a=s.length;a-- >0;)n=s[a],(!i||i(n,o,e))&&!c[n]&&(e[n]=o[n],c[n]=!0);o=t!==!1&&Eo(o)}while(o&&(!t||t(o,e))&&o!==Object.prototype);return e},Gl=(o,e,t)=>{o=String(o),(t===void 0||t>o.length)&&(t=o.length),t-=e.length;const i=o.indexOf(e,t);return i!==-1&&i===t},Wl=o=>{if(!o)return null;if(ys(o))return o;let e=o.length;if(!Wn(e))return null;const t=new Array(e);for(;e-- >0;)t[e]=o[e];return t},Vl=(o=>e=>o&&e instanceof o)(typeof Uint8Array<"u"&&Eo(Uint8Array)),jl=(o,e)=>{const i=(o&&o[ma]).call(o);let s;for(;(s=i.next())&&!s.done;){const a=s.value;e.call(o,a[0],a[1])}},ql=(o,e)=>{let t;const i=[];for(;(t=o.exec(e))!==null;)i.push(t);return i},$l=Te("HTMLFormElement"),Zl=o=>o.toLowerCase().replace(/[-_\s]([a-z\d])(\w*)/g,function(t,i,s){return i.toUpperCase()+s}),zo=(({hasOwnProperty:o})=>(e,t)=>o.call(e,t))(Object.prototype),zl=Te("RegExp"),qn=(o,e)=>{const t=Object.getOwnPropertyDescriptors(o),i={};ar(t,(s,a)=>{let n;(n=e(s,a,o))!==!1&&(i[a]=n||s)}),Object.defineProperties(o,i)},Kl=o=>{qn(o,(e,t)=>{if(ee(o)&&["arguments","caller","callee"].indexOf(t)!==-1)return!1;const i=o[t];if(ee(i)){if(e.enumerable=!1,"writable"in e){e.writable=!1;return}e.set||(e.set=()=>{throw Error("Can not rewrite read-only method '"+t+"'")})}})},Ql=(o,e)=>{const t={},i=s=>{s.forEach(a=>{t[a]=!0})};return ys(o)?i(o):i(String(o).split(e)),t},Jl=()=>{},tc=(o,e)=>o!=null&&Number.isFinite(o=+o)?o:e;function ec(o){return!!(o&&ee(o.append)&&o[Un]==="FormData"&&o[ma])}const ic=o=>{const e=new Array(10),t=(i,s)=>{if(rr(i)){if(e.indexOf(i)>=0)return;if(sr(i))return i;if(!("toJSON"in i)){e[s]=i;const a=ys(i)?[]:{};return ar(i,(n,c)=>{const l=t(n,s+1);!us(l)&&(a[c]=l)}),e[s]=void 0,a}}return i};return t(o,0)},sc=Te("AsyncFunction"),rc=o=>o&&(rr(o)||ee(o))&&ee(o.then)&&ee(o.catch),$n=((o,e)=>o?setImmediate:e?((t,i)=>(Ri.addEventListener("message",({source:s,data:a})=>{s===Ri&&a===t&&i.length&&i.shift()()},!1),s=>{i.push(s),Ri.postMessage(t,"*")}))(`axios@${Math.random()}`,[]):t=>setTimeout(t))(typeof setImmediate=="function",ee(Ri.postMessage)),ac=typeof queueMicrotask<"u"?queueMicrotask.bind(Ri):typeof process<"u"&&process.nextTick||$n,oc=o=>o!=null&&ee(o[ma]),M={isArray:ys,isArrayBuffer:Gn,isBuffer:sr,isFormData:Dl,isArrayBufferView:Tl,isString:Il,isNumber:Wn,isBoolean:vl,isObject:rr,isPlainObject:yr,isEmptyObject:Al,isReadableStream:Ll,isRequest:Yl,isResponse:_l,isHeaders:Nl,isUndefined:us,isDate:kl,isFile:Ol,isBlob:Ml,isRegExp:zl,isFunction:ee,isStream:Rl,isURLSearchParams:Cl,isTypedArray:Vl,isFileList:Pl,forEach:ar,merge:to,extend:Hl,trim:Xl,stripBOM:Bl,inherits:Fl,toFlatObject:Ul,kindOf:pa,kindOfTest:Te,endsWith:Gl,toArray:Wl,forEachEntry:jl,matchAll:ql,isHTMLForm:$l,hasOwnProperty:zo,hasOwnProp:zo,reduceDescriptors:qn,freezeMethods:Kl,toObjectSet:Ql,toCamelCase:Zl,noop:Jl,toFiniteNumber:tc,findKey:Vn,global:Ri,isContextDefined:jn,isSpecCompliantForm:ec,toJSONObject:ic,isAsyncFn:sc,isThenable:rc,setImmediate:$n,asap:ac,isIterable:oc};function K(o,e,t,i,s){Error.call(this),Error.captureStackTrace?Error.captureStackTrace(this,this.constructor):this.stack=new Error().stack,this.message=o,this.name="AxiosError",e&&(this.code=e),t&&(this.config=t),i&&(this.request=i),s&&(this.response=s,this.status=s.status?s.status:null)}M.inherits(K,Error,{toJSON:function(){return{message:this.message,name:this.name,description:this.description,number:this.number,fileName:this.fileName,lineNumber:this.lineNumber,columnNumber:this.columnNumber,stack:this.stack,config:M.toJSONObject(this.config),code:this.code,status:this.status}}});const Zn=K.prototype,zn={};["ERR_BAD_OPTION_VALUE","ERR_BAD_OPTION","ECONNABORTED","ETIMEDOUT","ERR_NETWORK","ERR_FR_TOO_MANY_REDIRECTS","ERR_DEPRECATED","ERR_BAD_RESPONSE","ERR_BAD_REQUEST","ERR_CANCELED","ERR_NOT_SUPPORT","ERR_INVALID_URL"].forEach(o=>{zn[o]={value:o}});Object.defineProperties(K,zn);Object.defineProperty(Zn,"isAxiosError",{value:!0});K.from=(o,e,t,i,s,a)=>{const n=Object.create(Zn);M.toFlatObject(o,n,function(u){return u!==Error.prototype},d=>d!=="isAxiosError");const c=o&&o.message?o.message:"Error",l=e==null&&o?o.code:e;return K.call(n,c,l,t,i,s),o&&n.cause==null&&Object.defineProperty(n,"cause",{value:o,configurable:!0}),n.name=o&&o.name||"Error",a&&Object.assign(n,a),n};const nc=null;function eo(o){return M.isPlainObject(o)||M.isArray(o)}function Kn(o){return M.endsWith(o,"[]")?o.slice(0,-2):o}function Ko(o,e,t){return o?o.concat(e).map(function(s,a){return s=Kn(s),!t&&a?"["+s+"]":s}).join(t?".":""):e}function hc(o){return M.isArray(o)&&!o.some(eo)}const lc=M.toFlatObject(M,{},null,function(e){return/^is[A-Z]/.test(e)});function ya(o,e,t){if(!M.isObject(o))throw new TypeError("target must be an object");e=e||new FormData,t=M.toFlatObject(t,{metaTokens:!0,dots:!1,indexes:!1},!1,function(g,w){return!M.isUndefined(w[g])});const i=t.metaTokens,s=t.visitor||u,a=t.dots,n=t.indexes,l=(t.Blob||typeof Blob<"u"&&Blob)&&M.isSpecCompliantForm(e);if(!M.isFunction(s))throw new TypeError("visitor must be a function");function d(y){if(y===null)return"";if(M.isDate(y))return y.toISOString();if(M.isBoolean(y))return y.toString();if(!l&&M.isBlob(y))throw new K("Blob is not supported. Use a Buffer instead.");return M.isArrayBuffer(y)||M.isTypedArray(y)?l&&typeof Blob=="function"?new Blob([y]):Buffer.from(y):y}function u(y,g,w){let b=y;if(y&&!w&&typeof y=="object"){if(M.endsWith(g,"{}"))g=i?g:g.slice(0,-2),y=JSON.stringify(y);else if(M.isArray(y)&&hc(y)||(M.isFileList(y)||M.endsWith(g,"[]"))&&(b=M.toArray(y)))return g=Kn(g),b.forEach(function(v,k){!(M.isUndefined(v)||v===null)&&e.append(n===!0?Ko([g],k,a):n===null?g:g+"[]",d(v))}),!1}return eo(y)?!0:(e.append(Ko(w,g,a),d(y)),!1)}const h=[],f=Object.assign(lc,{defaultVisitor:u,convertValue:d,isVisitable:eo});function p(y,g){if(!M.isUndefined(y)){if(h.indexOf(y)!==-1)throw Error("Circular reference detected in "+g.join("."));h.push(y),M.forEach(y,function(b,T){(!(M.isUndefined(b)||b===null)&&s.call(e,b,M.isString(T)?T.trim():T,g,f))===!0&&p(b,g?g.concat(T):[T])}),h.pop()}}if(!M.isObject(o))throw new TypeError("data must be an object");return p(o),e}function Qo(o){const e={"!":"%21","'":"%27","(":"%28",")":"%29","~":"%7E","%20":"+","%00":"\0"};return encodeURIComponent(o).replace(/[!'()~]|%20|%00/g,function(i){return e[i]})}function So(o,e){this._pairs=[],o&&ya(o,this,e)}const Qn=So.prototype;Qn.append=function(e,t){this._pairs.push([e,t])};Qn.toString=function(e){const t=e?function(i){return e.call(this,i,Qo)}:Qo;return this._pairs.map(function(s){return t(s[0])+"="+t(s[1])},"").join("&")};function cc(o){return encodeURIComponent(o).replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,"+")}function Jn(o,e,t){if(!e)return o;const i=t&&t.encode||cc;M.isFunction(t)&&(t={serialize:t});const s=t&&t.serialize;let a;if(s?a=s(e,t):a=M.isURLSearchParams(e)?e.toString():new So(e,t).toString(i),a){const n=o.indexOf("#");n!==-1&&(o=o.slice(0,n)),o+=(o.indexOf("?")===-1?"?":"&")+a}return o}class Jo{constructor(){this.handlers=[]}use(e,t,i){return this.handlers.push({fulfilled:e,rejected:t,synchronous:i?i.synchronous:!1,runWhen:i?i.runWhen:null}),this.handlers.length-1}eject(e){this.handlers[e]&&(this.handlers[e]=null)}clear(){this.handlers&&(this.handlers=[])}forEach(e){M.forEach(this.handlers,function(i){i!==null&&e(i)})}}const th={silentJSONParsing:!0,forcedJSONParsing:!0,clarifyTimeoutError:!1},dc=typeof URLSearchParams<"u"?URLSearchParams:So,fc=typeof FormData<"u"?FormData:null,uc=typeof Blob<"u"?Blob:null,mc={isBrowser:!0,classes:{URLSearchParams:dc,FormData:fc,Blob:uc},protocols:["http","https","file","blob","url","data"]},To=typeof window<"u"&&typeof document<"u",io=typeof navigator=="object"&&navigator||void 0,pc=To&&(!io||["ReactNative","NativeScript","NS"].indexOf(io.product)<0),gc=typeof WorkerGlobalScope<"u"&&self instanceof WorkerGlobalScope&&typeof self.importScripts=="function",yc=To&&window.location.href||"http://localhost",wc=Object.freeze(Object.defineProperty({__proto__:null,hasBrowserEnv:To,hasStandardBrowserEnv:pc,hasStandardBrowserWebWorkerEnv:gc,navigator:io,origin:yc},Symbol.toStringTag,{value:"Module"})),Yt={...wc,...mc};function xc(o,e){return ya(o,new Yt.classes.URLSearchParams,{visitor:function(t,i,s,a){return Yt.isNode&&M.isBuffer(t)?(this.append(i,t.toString("base64")),!1):a.defaultVisitor.apply(this,arguments)},...e})}function bc(o){return M.matchAll(/\w+|\[(\w*)]/g,o).map(e=>e[0]==="[]"?"":e[1]||e[0])}function Ec(o){const e={},t=Object.keys(o);let i;const s=t.length;let a;for(i=0;i<s;i++)a=t[i],e[a]=o[a];return e}function eh(o){function e(t,i,s,a){let n=t[a++];if(n==="__proto__")return!0;const c=Number.isFinite(+n),l=a>=t.length;return n=!n&&M.isArray(s)?s.length:n,l?(M.hasOwnProp(s,n)?s[n]=[s[n],i]:s[n]=i,!c):((!s[n]||!M.isObject(s[n]))&&(s[n]=[]),e(t,i,s[n],a)&&M.isArray(s[n])&&(s[n]=Ec(s[n])),!c)}if(M.isFormData(o)&&M.isFunction(o.entries)){const t={};return M.forEachEntry(o,(i,s)=>{e(bc(i),s,t,0)}),t}return null}function Sc(o,e,t){if(M.isString(o))try{return(e||JSON.parse)(o),M.trim(o)}catch(i){if(i.name!=="SyntaxError")throw i}return(t||JSON.stringify)(o)}const or={transitional:th,adapter:["xhr","http","fetch"],transformRequest:[function(e,t){const i=t.getContentType()||"",s=i.indexOf("application/json")>-1,a=M.isObject(e);if(a&&M.isHTMLForm(e)&&(e=new FormData(e)),M.isFormData(e))return s?JSON.stringify(eh(e)):e;if(M.isArrayBuffer(e)||M.isBuffer(e)||M.isStream(e)||M.isFile(e)||M.isBlob(e)||M.isReadableStream(e))return e;if(M.isArrayBufferView(e))return e.buffer;if(M.isURLSearchParams(e))return t.setContentType("application/x-www-form-urlencoded;charset=utf-8",!1),e.toString();let c;if(a){if(i.indexOf("application/x-www-form-urlencoded")>-1)return xc(e,this.formSerializer).toString();if((c=M.isFileList(e))||i.indexOf("multipart/form-data")>-1){const l=this.env&&this.env.FormData;return ya(c?{"files[]":e}:e,l&&new l,this.formSerializer)}}return a||s?(t.setContentType("application/json",!1),Sc(e)):e}],transformResponse:[function(e){const t=this.transitional||or.transitional,i=t&&t.forcedJSONParsing,s=this.responseType==="json";if(M.isResponse(e)||M.isReadableStream(e))return e;if(e&&M.isString(e)&&(i&&!this.responseType||s)){const n=!(t&&t.silentJSONParsing)&&s;try{return JSON.parse(e,this.parseReviver)}catch(c){if(n)throw c.name==="SyntaxError"?K.from(c,K.ERR_BAD_RESPONSE,this,null,this.response):c}}return e}],timeout:0,xsrfCookieName:"XSRF-TOKEN",xsrfHeaderName:"X-XSRF-TOKEN",maxContentLength:-1,maxBodyLength:-1,env:{FormData:Yt.classes.FormData,Blob:Yt.classes.Blob},validateStatus:function(e){return e>=200&&e<300},headers:{common:{Accept:"application/json, text/plain, */*","Content-Type":void 0}}};M.forEach(["delete","get","head","post","put","patch"],o=>{or.headers[o]={}});const Tc=M.toObjectSet(["age","authorization","content-length","content-type","etag","expires","from","host","if-modified-since","if-unmodified-since","last-modified","location","max-forwards","proxy-authorization","referer","retry-after","user-agent"]),Ic=o=>{const e={};let t,i,s;return o&&o.split(`
`).forEach(function(n){s=n.indexOf(":"),t=n.substring(0,s).trim().toLowerCase(),i=n.substring(s+1).trim(),!(!t||e[t]&&Tc[t])&&(t==="set-cookie"?e[t]?e[t].push(i):e[t]=[i]:e[t]=e[t]?e[t]+", "+i:i)}),e},tn=Symbol("internals");function Os(o){return o&&String(o).trim().toLowerCase()}function wr(o){return o===!1||o==null?o:M.isArray(o)?o.map(wr):String(o)}function vc(o){const e=Object.create(null),t=/([^\s,;=]+)\s*(?:=\s*([^,;]+))?/g;let i;for(;i=t.exec(o);)e[i[1]]=i[2];return e}const Ac=o=>/^[-_a-zA-Z0-9^`|~,!#$%&'*+.]+$/.test(o.trim());function Ca(o,e,t,i,s){if(M.isFunction(i))return i.call(this,e,t);if(s&&(e=t),!!M.isString(e)){if(M.isString(i))return e.indexOf(i)!==-1;if(M.isRegExp(i))return i.test(e)}}function kc(o){return o.trim().toLowerCase().replace(/([a-z\d])(\w*)/g,(e,t,i)=>t.toUpperCase()+i)}function Oc(o,e){const t=M.toCamelCase(" "+e);["get","set","has"].forEach(i=>{Object.defineProperty(o,i+t,{value:function(s,a,n){return this[i].call(this,e,s,a,n)},configurable:!0})})}let ie=class{constructor(e){e&&this.set(e)}set(e,t,i){const s=this;function a(c,l,d){const u=Os(l);if(!u)throw new Error("header name must be a non-empty string");const h=M.findKey(s,u);(!h||s[h]===void 0||d===!0||d===void 0&&s[h]!==!1)&&(s[h||l]=wr(c))}const n=(c,l)=>M.forEach(c,(d,u)=>a(d,u,l));if(M.isPlainObject(e)||e instanceof this.constructor)n(e,t);else if(M.isString(e)&&(e=e.trim())&&!Ac(e))n(Ic(e),t);else if(M.isObject(e)&&M.isIterable(e)){let c={},l,d;for(const u of e){if(!M.isArray(u))throw TypeError("Object iterator must return a key-value pair");c[d=u[0]]=(l=c[d])?M.isArray(l)?[...l,u[1]]:[l,u[1]]:u[1]}n(c,t)}else e!=null&&a(t,e,i);return this}get(e,t){if(e=Os(e),e){const i=M.findKey(this,e);if(i){const s=this[i];if(!t)return s;if(t===!0)return vc(s);if(M.isFunction(t))return t.call(this,s,i);if(M.isRegExp(t))return t.exec(s);throw new TypeError("parser must be boolean|regexp|function")}}}has(e,t){if(e=Os(e),e){const i=M.findKey(this,e);return!!(i&&this[i]!==void 0&&(!t||Ca(this,this[i],i,t)))}return!1}delete(e,t){const i=this;let s=!1;function a(n){if(n=Os(n),n){const c=M.findKey(i,n);c&&(!t||Ca(i,i[c],c,t))&&(delete i[c],s=!0)}}return M.isArray(e)?e.forEach(a):a(e),s}clear(e){const t=Object.keys(this);let i=t.length,s=!1;for(;i--;){const a=t[i];(!e||Ca(this,this[a],a,e,!0))&&(delete this[a],s=!0)}return s}normalize(e){const t=this,i={};return M.forEach(this,(s,a)=>{const n=M.findKey(i,a);if(n){t[n]=wr(s),delete t[a];return}const c=e?kc(a):String(a).trim();c!==a&&delete t[a],t[c]=wr(s),i[c]=!0}),this}concat(...e){return this.constructor.concat(this,...e)}toJSON(e){const t=Object.create(null);return M.forEach(this,(i,s)=>{i!=null&&i!==!1&&(t[s]=e&&M.isArray(i)?i.join(", "):i)}),t}[Symbol.iterator](){return Object.entries(this.toJSON())[Symbol.iterator]()}toString(){return Object.entries(this.toJSON()).map(([e,t])=>e+": "+t).join(`
`)}getSetCookie(){return this.get("set-cookie")||[]}get[Symbol.toStringTag](){return"AxiosHeaders"}static from(e){return e instanceof this?e:new this(e)}static concat(e,...t){const i=new this(e);return t.forEach(s=>i.set(s)),i}static accessor(e){const i=(this[tn]=this[tn]={accessors:{}}).accessors,s=this.prototype;function a(n){const c=Os(n);i[c]||(Oc(s,n),i[c]=!0)}return M.isArray(e)?e.forEach(a):a(e),this}};ie.accessor(["Content-Type","Content-Length","Accept","Accept-Encoding","User-Agent","Authorization"]);M.reduceDescriptors(ie.prototype,({value:o},e)=>{let t=e[0].toUpperCase()+e.slice(1);return{get:()=>o,set(i){this[t]=i}}});M.freezeMethods(ie);function La(o,e){const t=this||or,i=e||t,s=ie.from(i.headers);let a=i.data;return M.forEach(o,function(c){a=c.call(t,a,s.normalize(),e?e.status:void 0)}),s.normalize(),a}function ih(o){return!!(o&&o.__CANCEL__)}function ws(o,e,t){K.call(this,o??"canceled",K.ERR_CANCELED,e,t),this.name="CanceledError"}M.inherits(ws,K,{__CANCEL__:!0});function sh(o,e,t){const i=t.config.validateStatus;!t.status||!i||i(t.status)?o(t):e(new K("Request failed with status code "+t.status,[K.ERR_BAD_REQUEST,K.ERR_BAD_RESPONSE][Math.floor(t.status/100)-4],t.config,t.request,t))}function Mc(o){const e=/^([-+\w]{1,25})(:?\/\/|:)/.exec(o);return e&&e[1]||""}function Pc(o,e){o=o||10;const t=new Array(o),i=new Array(o);let s=0,a=0,n;return e=e!==void 0?e:1e3,function(l){const d=Date.now(),u=i[a];n||(n=d),t[s]=l,i[s]=d;let h=a,f=0;for(;h!==s;)f+=t[h++],h=h%o;if(s=(s+1)%o,s===a&&(a=(a+1)%o),d-n<e)return;const p=u&&d-u;return p?Math.round(f*1e3/p):void 0}}function Rc(o,e){let t=0,i=1e3/e,s,a;const n=(d,u=Date.now())=>{t=u,s=null,a&&(clearTimeout(a),a=null),o(...d)};return[(...d)=>{const u=Date.now(),h=u-t;h>=i?n(d,u):(s=d,a||(a=setTimeout(()=>{a=null,n(s)},i-h)))},()=>s&&n(s)]}const Or=(o,e,t=3)=>{let i=0;const s=Pc(50,250);return Rc(a=>{const n=a.loaded,c=a.lengthComputable?a.total:void 0,l=n-i,d=s(l),u=n<=c;i=n;const h={loaded:n,total:c,progress:c?n/c:void 0,bytes:l,rate:d||void 0,estimated:d&&c&&u?(c-n)/d:void 0,event:a,lengthComputable:c!=null,[e?"download":"upload"]:!0};o(h)},t)},en=(o,e)=>{const t=o!=null;return[i=>e[0]({lengthComputable:t,total:o,loaded:i}),e[1]]},sn=o=>(...e)=>M.asap(()=>o(...e)),Dc=Yt.hasStandardBrowserEnv?((o,e)=>t=>(t=new URL(t,Yt.origin),o.protocol===t.protocol&&o.host===t.host&&(e||o.port===t.port)))(new URL(Yt.origin),Yt.navigator&&/(msie|trident)/i.test(Yt.navigator.userAgent)):()=>!0,Cc=Yt.hasStandardBrowserEnv?{write(o,e,t,i,s,a){const n=[o+"="+encodeURIComponent(e)];M.isNumber(t)&&n.push("expires="+new Date(t).toGMTString()),M.isString(i)&&n.push("path="+i),M.isString(s)&&n.push("domain="+s),a===!0&&n.push("secure"),document.cookie=n.join("; ")},read(o){const e=document.cookie.match(new RegExp("(^|;\\s*)("+o+")=([^;]*)"));return e?decodeURIComponent(e[3]):null},remove(o){this.write(o,"",Date.now()-864e5)}}:{write(){},read(){return null},remove(){}};function Lc(o){return/^([a-z][a-z\d+\-.]*:)?\/\//i.test(o)}function Yc(o,e){return e?o.replace(/\/?\/$/,"")+"/"+e.replace(/^\/+/,""):o}function rh(o,e,t){let i=!Lc(e);return o&&(i||t==!1)?Yc(o,e):e}const rn=o=>o instanceof ie?{...o}:o;function Gi(o,e){e=e||{};const t={};function i(d,u,h,f){return M.isPlainObject(d)&&M.isPlainObject(u)?M.merge.call({caseless:f},d,u):M.isPlainObject(u)?M.merge({},u):M.isArray(u)?u.slice():u}function s(d,u,h,f){if(M.isUndefined(u)){if(!M.isUndefined(d))return i(void 0,d,h,f)}else return i(d,u,h,f)}function a(d,u){if(!M.isUndefined(u))return i(void 0,u)}function n(d,u){if(M.isUndefined(u)){if(!M.isUndefined(d))return i(void 0,d)}else return i(void 0,u)}function c(d,u,h){if(h in e)return i(d,u);if(h in o)return i(void 0,d)}const l={url:a,method:a,data:a,baseURL:n,transformRequest:n,transformResponse:n,paramsSerializer:n,timeout:n,timeoutMessage:n,withCredentials:n,withXSRFToken:n,adapter:n,responseType:n,xsrfCookieName:n,xsrfHeaderName:n,onUploadProgress:n,onDownloadProgress:n,decompress:n,maxContentLength:n,maxBodyLength:n,beforeRedirect:n,transport:n,httpAgent:n,httpsAgent:n,cancelToken:n,socketPath:n,responseEncoding:n,validateStatus:c,headers:(d,u,h)=>s(rn(d),rn(u),h,!0)};return M.forEach(Object.keys({...o,...e}),function(u){const h=l[u]||s,f=h(o[u],e[u],u);M.isUndefined(f)&&h!==c||(t[u]=f)}),t}const ah=o=>{const e=Gi({},o);let{data:t,withXSRFToken:i,xsrfHeaderName:s,xsrfCookieName:a,headers:n,auth:c}=e;if(e.headers=n=ie.from(n),e.url=Jn(rh(e.baseURL,e.url,e.allowAbsoluteUrls),o.params,o.paramsSerializer),c&&n.set("Authorization","Basic "+btoa((c.username||"")+":"+(c.password?unescape(encodeURIComponent(c.password)):""))),M.isFormData(t)){if(Yt.hasStandardBrowserEnv||Yt.hasStandardBrowserWebWorkerEnv)n.setContentType(void 0);else if(M.isFunction(t.getHeaders)){const l=t.getHeaders(),d=["content-type","content-length"];Object.entries(l).forEach(([u,h])=>{d.includes(u.toLowerCase())&&n.set(u,h)})}}if(Yt.hasStandardBrowserEnv&&(i&&M.isFunction(i)&&(i=i(e)),i||i!==!1&&Dc(e.url))){const l=s&&a&&Cc.read(a);l&&n.set(s,l)}return e},_c=typeof XMLHttpRequest<"u",Nc=_c&&function(o){return new Promise(function(t,i){const s=ah(o);let a=s.data;const n=ie.from(s.headers).normalize();let{responseType:c,onUploadProgress:l,onDownloadProgress:d}=s,u,h,f,p,y;function g(){p&&p(),y&&y(),s.cancelToken&&s.cancelToken.unsubscribe(u),s.signal&&s.signal.removeEventListener("abort",u)}let w=new XMLHttpRequest;w.open(s.method.toUpperCase(),s.url,!0),w.timeout=s.timeout;function b(){if(!w)return;const v=ie.from("getAllResponseHeaders"in w&&w.getAllResponseHeaders()),D={data:!c||c==="text"||c==="json"?w.responseText:w.response,status:w.status,statusText:w.statusText,headers:v,config:o,request:w};sh(function(U){t(U),g()},function(U){i(U),g()},D),w=null}"onloadend"in w?w.onloadend=b:w.onreadystatechange=function(){!w||w.readyState!==4||w.status===0&&!(w.responseURL&&w.responseURL.indexOf("file:")===0)||setTimeout(b)},w.onabort=function(){w&&(i(new K("Request aborted",K.ECONNABORTED,o,w)),w=null)},w.onerror=function(k){const D=k&&k.message?k.message:"Network Error",N=new K(D,K.ERR_NETWORK,o,w);N.event=k||null,i(N),w=null},w.ontimeout=function(){let k=s.timeout?"timeout of "+s.timeout+"ms exceeded":"timeout exceeded";const D=s.transitional||th;s.timeoutErrorMessage&&(k=s.timeoutErrorMessage),i(new K(k,D.clarifyTimeoutError?K.ETIMEDOUT:K.ECONNABORTED,o,w)),w=null},a===void 0&&n.setContentType(null),"setRequestHeader"in w&&M.forEach(n.toJSON(),function(k,D){w.setRequestHeader(D,k)}),M.isUndefined(s.withCredentials)||(w.withCredentials=!!s.withCredentials),c&&c!=="json"&&(w.responseType=s.responseType),d&&([f,y]=Or(d,!0),w.addEventListener("progress",f)),l&&w.upload&&([h,p]=Or(l),w.upload.addEventListener("progress",h),w.upload.addEventListener("loadend",p)),(s.cancelToken||s.signal)&&(u=v=>{w&&(i(!v||v.type?new ws(null,o,w):v),w.abort(),w=null)},s.cancelToken&&s.cancelToken.subscribe(u),s.signal&&(s.signal.aborted?u():s.signal.addEventListener("abort",u)));const T=Mc(s.url);if(T&&Yt.protocols.indexOf(T)===-1){i(new K("Unsupported protocol "+T+":",K.ERR_BAD_REQUEST,o));return}w.send(a||null)})},Xc=(o,e)=>{const{length:t}=o=o?o.filter(Boolean):[];if(e||t){let i=new AbortController,s;const a=function(d){if(!s){s=!0,c();const u=d instanceof Error?d:this.reason;i.abort(u instanceof K?u:new ws(u instanceof Error?u.message:u))}};let n=e&&setTimeout(()=>{n=null,a(new K(`timeout ${e} of ms exceeded`,K.ETIMEDOUT))},e);const c=()=>{o&&(n&&clearTimeout(n),n=null,o.forEach(d=>{d.unsubscribe?d.unsubscribe(a):d.removeEventListener("abort",a)}),o=null)};o.forEach(d=>d.addEventListener("abort",a));const{signal:l}=i;return l.unsubscribe=()=>M.asap(c),l}},Hc=function*(o,e){let t=o.byteLength;if(t<e){yield o;return}let i=0,s;for(;i<t;)s=i+e,yield o.slice(i,s),i=s},Bc=async function*(o,e){for await(const t of Fc(o))yield*Hc(t,e)},Fc=async function*(o){if(o[Symbol.asyncIterator]){yield*o;return}const e=o.getReader();try{for(;;){const{done:t,value:i}=await e.read();if(t)break;yield i}}finally{await e.cancel()}},an=(o,e,t,i)=>{const s=Bc(o,e);let a=0,n,c=l=>{n||(n=!0,i&&i(l))};return new ReadableStream({async pull(l){try{const{done:d,value:u}=await s.next();if(d){c(),l.close();return}let h=u.byteLength;if(t){let f=a+=h;t(f)}l.enqueue(new Uint8Array(u))}catch(d){throw c(d),d}},cancel(l){return c(l),s.return()}},{highWaterMark:2})},on=64*1024,{isFunction:mr}=M,oh=(({fetch:o,Request:e,Response:t})=>({fetch:o,Request:e,Response:t}))(M.global),{ReadableStream:nn,TextEncoder:hn}=M.global,ln=(o,...e)=>{try{return!!o(...e)}catch{return!1}},Uc=o=>{const{fetch:e,Request:t,Response:i}=Object.assign({},oh,o),s=mr(e),a=mr(t),n=mr(i);if(!s)return!1;const c=s&&mr(nn),l=s&&(typeof hn=="function"?(y=>g=>y.encode(g))(new hn):async y=>new Uint8Array(await new t(y).arrayBuffer())),d=a&&c&&ln(()=>{let y=!1;const g=new t(Yt.origin,{body:new nn,method:"POST",get duplex(){return y=!0,"half"}}).headers.has("Content-Type");return y&&!g}),u=n&&c&&ln(()=>M.isReadableStream(new i("").body)),h={stream:u&&(y=>y.body)};s&&["text","arrayBuffer","blob","formData","stream"].forEach(y=>{!h[y]&&(h[y]=(g,w)=>{let b=g&&g[y];if(b)return b.call(g);throw new K(`Response type '${y}' is not supported`,K.ERR_NOT_SUPPORT,w)})});const f=async y=>{if(y==null)return 0;if(M.isBlob(y))return y.size;if(M.isSpecCompliantForm(y))return(await new t(Yt.origin,{method:"POST",body:y}).arrayBuffer()).byteLength;if(M.isArrayBufferView(y)||M.isArrayBuffer(y))return y.byteLength;if(M.isURLSearchParams(y)&&(y=y+""),M.isString(y))return(await l(y)).byteLength},p=async(y,g)=>{const w=M.toFiniteNumber(y.getContentLength());return w??f(g)};return async y=>{let{url:g,method:w,data:b,signal:T,cancelToken:v,timeout:k,onDownloadProgress:D,onUploadProgress:N,responseType:U,headers:Z,withCredentials:j="same-origin",fetchOptions:V}=ah(y);U=U?(U+"").toLowerCase():"text";let J=Xc([T,v&&v.toAbortSignal()],k),z=null;const tt=J&&J.unsubscribe&&(()=>{J.unsubscribe()});let ft;try{if(N&&d&&w!=="get"&&w!=="head"&&(ft=await p(Z,b))!==0){let Ie=new t(g,{method:"POST",body:b,duplex:"half"}),ji;if(M.isFormData(b)&&(ji=Ie.headers.get("content-type"))&&Z.setContentType(ji),Ie.body){const[ba,nr]=en(ft,Or(sn(N)));b=an(Ie.body,on,ba,nr)}}M.isString(j)||(j=j?"include":"omit");const at=a&&"credentials"in t.prototype,Rt={...V,signal:J,method:w.toUpperCase(),headers:Z.normalize().toJSON(),body:b,duplex:"half",credentials:at?j:void 0};z=a&&new t(g,Rt);let jt=await(a?e(z,V):e(g,Rt));const ri=u&&(U==="stream"||U==="response");if(u&&(D||ri&&tt)){const Ie={};["status","statusText","headers"].forEach(Io=>{Ie[Io]=jt[Io]});const ji=M.toFiniteNumber(jt.headers.get("content-length")),[ba,nr]=D&&en(ji,Or(sn(D),!0))||[];jt=new i(an(jt.body,on,ba,()=>{nr&&nr(),tt&&tt()}),Ie)}U=U||"text";let xa=await h[M.findKey(h,U)||"text"](jt,y);return!ri&&tt&&tt(),await new Promise((Ie,ji)=>{sh(Ie,ji,{data:xa,headers:ie.from(jt.headers),status:jt.status,statusText:jt.statusText,config:y,request:z})})}catch(at){throw tt&&tt(),at&&at.name==="TypeError"&&/Load failed|fetch/i.test(at.message)?Object.assign(new K("Network Error",K.ERR_NETWORK,y,z),{cause:at.cause||at}):K.from(at,at&&at.code,y,z)}}},Gc=new Map,nh=o=>{let e=M.merge.call({skipUndefined:!0},oh,o?o.env:null);const{fetch:t,Request:i,Response:s}=e,a=[i,s,t];let n=a.length,c=n,l,d,u=Gc;for(;c--;)l=a[c],d=u.get(l),d===void 0&&u.set(l,d=c?new Map:Uc(e)),u=d;return d};nh();const so={http:nc,xhr:Nc,fetch:{get:nh}};M.forEach(so,(o,e)=>{if(o){try{Object.defineProperty(o,"name",{value:e})}catch{}Object.defineProperty(o,"adapterName",{value:e})}});const cn=o=>`- ${o}`,Wc=o=>M.isFunction(o)||o===null||o===!1,hh={getAdapter:(o,e)=>{o=M.isArray(o)?o:[o];const{length:t}=o;let i,s;const a={};for(let n=0;n<t;n++){i=o[n];let c;if(s=i,!Wc(i)&&(s=so[(c=String(i)).toLowerCase()],s===void 0))throw new K(`Unknown adapter '${c}'`);if(s&&(M.isFunction(s)||(s=s.get(e))))break;a[c||"#"+n]=s}if(!s){const n=Object.entries(a).map(([l,d])=>`adapter ${l} `+(d===!1?"is not supported by the environment":"is not available in the build"));let c=t?n.length>1?`since :
`+n.map(cn).join(`
`):" "+cn(n[0]):"as no adapter specified";throw new K("There is no suitable adapter to dispatch the request "+c,"ERR_NOT_SUPPORT")}return s},adapters:so};function Ya(o){if(o.cancelToken&&o.cancelToken.throwIfRequested(),o.signal&&o.signal.aborted)throw new ws(null,o)}function dn(o){return Ya(o),o.headers=ie.from(o.headers),o.data=La.call(o,o.transformRequest),["post","put","patch"].indexOf(o.method)!==-1&&o.headers.setContentType("application/x-www-form-urlencoded",!1),hh.getAdapter(o.adapter||or.adapter,o)(o).then(function(i){return Ya(o),i.data=La.call(o,o.transformResponse,i),i.headers=ie.from(i.headers),i},function(i){return ih(i)||(Ya(o),i&&i.response&&(i.response.data=La.call(o,o.transformResponse,i.response),i.response.headers=ie.from(i.response.headers))),Promise.reject(i)})}const lh="1.12.1",wa={};["object","boolean","number","function","string","symbol"].forEach((o,e)=>{wa[o]=function(i){return typeof i===o||"a"+(e<1?"n ":" ")+o}});const fn={};wa.transitional=function(e,t,i){function s(a,n){return"[Axios v"+lh+"] Transitional option '"+a+"'"+n+(i?". "+i:"")}return(a,n,c)=>{if(e===!1)throw new K(s(n," has been removed"+(t?" in "+t:"")),K.ERR_DEPRECATED);return t&&!fn[n]&&(fn[n]=!0,console.warn(s(n," has been deprecated since v"+t+" and will be removed in the near future"))),e?e(a,n,c):!0}};wa.spelling=function(e){return(t,i)=>(console.warn(`${i} is likely a misspelling of ${e}`),!0)};function Vc(o,e,t){if(typeof o!="object")throw new K("options must be an object",K.ERR_BAD_OPTION_VALUE);const i=Object.keys(o);let s=i.length;for(;s-- >0;){const a=i[s],n=e[a];if(n){const c=o[a],l=c===void 0||n(c,a,o);if(l!==!0)throw new K("option "+a+" must be "+l,K.ERR_BAD_OPTION_VALUE);continue}if(t!==!0)throw new K("Unknown option "+a,K.ERR_BAD_OPTION)}}const xr={assertOptions:Vc,validators:wa},ve=xr.validators;let _i=class{constructor(e){this.defaults=e||{},this.interceptors={request:new Jo,response:new Jo}}async request(e,t){try{return await this._request(e,t)}catch(i){if(i instanceof Error){let s={};Error.captureStackTrace?Error.captureStackTrace(s):s=new Error;const a=s.stack?s.stack.replace(/^.+\n/,""):"";try{i.stack?a&&!String(i.stack).endsWith(a.replace(/^.+\n.+\n/,""))&&(i.stack+=`
`+a):i.stack=a}catch{}}throw i}}_request(e,t){typeof e=="string"?(t=t||{},t.url=e):t=e||{},t=Gi(this.defaults,t);const{transitional:i,paramsSerializer:s,headers:a}=t;i!==void 0&&xr.assertOptions(i,{silentJSONParsing:ve.transitional(ve.boolean),forcedJSONParsing:ve.transitional(ve.boolean),clarifyTimeoutError:ve.transitional(ve.boolean)},!1),s!=null&&(M.isFunction(s)?t.paramsSerializer={serialize:s}:xr.assertOptions(s,{encode:ve.function,serialize:ve.function},!0)),t.allowAbsoluteUrls!==void 0||(this.defaults.allowAbsoluteUrls!==void 0?t.allowAbsoluteUrls=this.defaults.allowAbsoluteUrls:t.allowAbsoluteUrls=!0),xr.assertOptions(t,{baseUrl:ve.spelling("baseURL"),withXsrfToken:ve.spelling("withXSRFToken")},!0),t.method=(t.method||this.defaults.method||"get").toLowerCase();let n=a&&M.merge(a.common,a[t.method]);a&&M.forEach(["delete","get","head","post","put","patch","common"],y=>{delete a[y]}),t.headers=ie.concat(n,a);const c=[];let l=!0;this.interceptors.request.forEach(function(g){typeof g.runWhen=="function"&&g.runWhen(t)===!1||(l=l&&g.synchronous,c.unshift(g.fulfilled,g.rejected))});const d=[];this.interceptors.response.forEach(function(g){d.push(g.fulfilled,g.rejected)});let u,h=0,f;if(!l){const y=[dn.bind(this),void 0];for(y.unshift(...c),y.push(...d),f=y.length,u=Promise.resolve(t);h<f;)u=u.then(y[h++],y[h++]);return u}f=c.length;let p=t;for(h=0;h<f;){const y=c[h++],g=c[h++];try{p=y(p)}catch(w){g.call(this,w);break}}try{u=dn.call(this,p)}catch(y){return Promise.reject(y)}for(h=0,f=d.length;h<f;)u=u.then(d[h++],d[h++]);return u}getUri(e){e=Gi(this.defaults,e);const t=rh(e.baseURL,e.url,e.allowAbsoluteUrls);return Jn(t,e.params,e.paramsSerializer)}};M.forEach(["delete","get","head","options"],function(e){_i.prototype[e]=function(t,i){return this.request(Gi(i||{},{method:e,url:t,data:(i||{}).data}))}});M.forEach(["post","put","patch"],function(e){function t(i){return function(a,n,c){return this.request(Gi(c||{},{method:e,headers:i?{"Content-Type":"multipart/form-data"}:{},url:a,data:n}))}}_i.prototype[e]=t(),_i.prototype[e+"Form"]=t(!0)});let jc=class ch{constructor(e){if(typeof e!="function")throw new TypeError("executor must be a function.");let t;this.promise=new Promise(function(a){t=a});const i=this;this.promise.then(s=>{if(!i._listeners)return;let a=i._listeners.length;for(;a-- >0;)i._listeners[a](s);i._listeners=null}),this.promise.then=s=>{let a;const n=new Promise(c=>{i.subscribe(c),a=c}).then(s);return n.cancel=function(){i.unsubscribe(a)},n},e(function(a,n,c){i.reason||(i.reason=new ws(a,n,c),t(i.reason))})}throwIfRequested(){if(this.reason)throw this.reason}subscribe(e){if(this.reason){e(this.reason);return}this._listeners?this._listeners.push(e):this._listeners=[e]}unsubscribe(e){if(!this._listeners)return;const t=this._listeners.indexOf(e);t!==-1&&this._listeners.splice(t,1)}toAbortSignal(){const e=new AbortController,t=i=>{e.abort(i)};return this.subscribe(t),e.signal.unsubscribe=()=>this.unsubscribe(t),e.signal}static source(){let e;return{token:new ch(function(s){e=s}),cancel:e}}};function qc(o){return function(t){return o.apply(null,t)}}function $c(o){return M.isObject(o)&&o.isAxiosError===!0}const ro={Continue:100,SwitchingProtocols:101,Processing:102,EarlyHints:103,Ok:200,Created:201,Accepted:202,NonAuthoritativeInformation:203,NoContent:204,ResetContent:205,PartialContent:206,MultiStatus:207,AlreadyReported:208,ImUsed:226,MultipleChoices:300,MovedPermanently:301,Found:302,SeeOther:303,NotModified:304,UseProxy:305,Unused:306,TemporaryRedirect:307,PermanentRedirect:308,BadRequest:400,Unauthorized:401,PaymentRequired:402,Forbidden:403,NotFound:404,MethodNotAllowed:405,NotAcceptable:406,ProxyAuthenticationRequired:407,RequestTimeout:408,Conflict:409,Gone:410,LengthRequired:411,PreconditionFailed:412,PayloadTooLarge:413,UriTooLong:414,UnsupportedMediaType:415,RangeNotSatisfiable:416,ExpectationFailed:417,ImATeapot:418,MisdirectedRequest:421,UnprocessableEntity:422,Locked:423,FailedDependency:424,TooEarly:425,UpgradeRequired:426,PreconditionRequired:428,TooManyRequests:429,RequestHeaderFieldsTooLarge:431,UnavailableForLegalReasons:451,InternalServerError:500,NotImplemented:501,BadGateway:502,ServiceUnavailable:503,GatewayTimeout:504,HttpVersionNotSupported:505,VariantAlsoNegotiates:506,InsufficientStorage:507,LoopDetected:508,NotExtended:510,NetworkAuthenticationRequired:511};Object.entries(ro).forEach(([o,e])=>{ro[e]=o});function dh(o){const e=new _i(o),t=Fn(_i.prototype.request,e);return M.extend(t,_i.prototype,e,{allOwnKeys:!0}),M.extend(t,e,null,{allOwnKeys:!0}),t.create=function(s){return dh(Gi(o,s))},t}const St=dh(or);St.Axios=_i;St.CanceledError=ws;St.CancelToken=jc;St.isCancel=ih;St.VERSION=lh;St.toFormData=ya;St.AxiosError=K;St.Cancel=St.CanceledError;St.all=function(e){return Promise.all(e)};St.spread=qc;St.isAxiosError=$c;St.mergeConfig=Gi;St.AxiosHeaders=ie;St.formToJSON=o=>eh(M.isHTMLForm(o)?new FormData(o):o);St.getAdapter=hh.getAdapter;St.HttpStatusCode=ro;St.default=St;const{Axios:ad,AxiosError:od,CanceledError:nd,isCancel:hd,CancelToken:ld,VERSION:cd,all:dd,Cancel:fd,isAxiosError:ud,spread:md,toFormData:pd,AxiosHeaders:gd,HttpStatusCode:yd,formToJSON:wd,getAdapter:xd,mergeConfig:bd}=St,Zc=()=>window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1"||window.location.hostname.includes("localhost")||window.location.protocol==="file:"?"http://localhost:3000/api/v1":"https://turnarchist.onrender.com/api/v1",zc=St.create({baseURL:Zc()}),Kc=async o=>(await zc.post("/game/stats",o)).data,un=async o=>{try{return await Kc(o)}catch(e){console.error("API request failed:",e)}},_a=require("../res/tileset.png"),Na=require("../res/objset.png"),Xa=require("../res/mobset.png"),Ha=require("../res/itemset.png"),Ba=require("../res/fxset.png"),Fa=require("../res/font.png");var Qt=(o=>(o[o.IN_LEVEL=0]="IN_LEVEL",o[o.TRANSITIONING=1]="TRANSITIONING",o[o.TRANSITIONING_LADDER=2]="TRANSITIONING_LADDER",o[o.LEVEL_GENERATION=3]="LEVEL_GENERATION",o))(Qt||{}),E=(o=>(o[o.DOWN=0]="DOWN",o[o.UP=1]="UP",o[o.RIGHT=2]="RIGHT",o[o.LEFT=3]="LEFT",o[o.DOWN_RIGHT=4]="DOWN_RIGHT",o[o.UP_LEFT=5]="UP_LEFT",o[o.UP_RIGHT=6]="UP_RIGHT",o[o.DOWN_LEFT=7]="DOWN_LEFT",o[o.CENTER=8]="CENTER",o))(E||{});class mn{constructor(e){r(this,"message");r(this,"timestamp");r(this,"cachedLines",null);r(this,"cachedWidth",-1);this.message=e,this.timestamp=Date.now()}getWrappedLines(e){return this.cachedLines&&this.cachedWidth===e?this.cachedLines:(this.cachedLines=this.wrapText(this.message,e),this.cachedWidth=e,this.cachedLines)}wrapText(e,t){if(e==="")return[""];const i=e.split(" "),s=[];let a="";for(const n of i){const c=a===""?n:a+" "+n;m.measureText(c).width<=t?a=c:a!==""?(s.push(a),a=n):s.push(n)}return a!==""&&s.push(a),s.length>0?s:[""]}clearCache(){this.cachedLines=null,this.cachedWidth=-1}}let Qc=(o,e,t,i,s,a,n,c)=>o.src+","+e+","+t+","+i+","+s+","+a+","+n+",fade="+(c||"none");const Ms=[];let pn=60;const A=class A{constructor(){r(this,"globalId");r(this,"prevLevel");r(this,"room");r(this,"rooms");r(this,"level");r(this,"levels");r(this,"roomsById");r(this,"levelsById");r(this,"currentPathId","main");r(this,"levelgen");r(this,"localPlayerID","localplayer");r(this,"players");r(this,"offlinePlayers");r(this,"levelState");r(this,"transitionStartTime");r(this,"transitionX");r(this,"transitionY");r(this,"upwardTransition");r(this,"sideTransition");r(this,"sideTransitionDirection");r(this,"transition");r(this,"transitioningLadder");r(this,"screenShakeX");r(this,"screenShakeY");r(this,"shakeAmountX");r(this,"shakeAmountY");r(this,"shakeFrame");r(this,"screenShakeCutoff");r(this,"chat");r(this,"chatOpen");r(this,"chatTextBox");r(this,"previousFrameTimestamp");r(this,"player");r(this,"gameStartTimeMs");r(this,"hasRecordedStats",!1);r(this,"loadedFromSaveFile",!1);r(this,"version","1.2.0");r(this,"loginMessage","");r(this,"username");r(this,"usernameTextBox");r(this,"passwordTextBox");r(this,"worldCodes");r(this,"selectedWorldCode");r(this,"tutorialActive");r(this,"isMobile");r(this,"started");r(this,"startedFadeOut");r(this,"screenShakeActive");r(this,"runStarted",!1);r(this,"encounteredEnemies");r(this,"paused");r(this,"startScreenAlpha",1);r(this,"currentDepth");r(this,"ellipsisFrame",0);r(this,"ellipsisStartTime",0);r(this,"cameraAnimation");r(this,"cameraTargetX");r(this,"cameraTargetY");r(this,"cameraX");r(this,"cameraY");r(this,"justTransitioned",!1);r(this,"lastDroppedScythePiece",null);r(this,"lastDroppedShieldPiece",null);r(this,"tip",wl.getRandomTip());r(this,"currentLevelGenerator",null);r(this,"tutorialListener");r(this,"focusTimeout",null);r(this,"FOCUS_TIMEOUT_DURATION",15e3);r(this,"wasMuted",!1);r(this,"wasStarted",!1);r(this,"lastChatWidth",0);r(this,"savedGameState",null);r(this,"startMenu",null);r(this,"startMenuActive",!1);r(this,"feedbackButton",null);r(this,"loadGame",()=>{console.log(" loadGame() called - initializing game...");let e=document.getElementById("gameCanvas");A.ctx=e.getContext("2d",{alpha:!1}),console.log(" Canvas context created:",A.ctx);const t=document.createElement("input");t.type="text",t.autocomplete="off",t.autocapitalize="off",t.style.position="absolute",t.style.left="-1000px";const i=document.createElement("input");i.type="text",i.style.position="absolute",i.style.left="-1000px",document.body.appendChild(i),document.addEventListener("click",()=>{t.focus()},{once:!0}),this.chat=[],this.chatTextBox=new ol(i),this.chatTextBox.setEnterCallback(()=>{this.chatTextBox.text.length>0?(this.chat.push(new mn(this.chatTextBox.text)),this.chatTextBox.clear()):this.chatOpen=!1}),this.chatTextBox.setEscapeCallback(()=>{this.chatOpen=!1}),this.worldCodes=[],this.selectedWorldCode=0,A.shade_canvases={},A.text_rendering_canvases={};let s=0;const a=6;console.log(" Starting resource loading..."),console.log(" Resource URLs:",{tilesetUrl:_a,objsetUrl:Na,mobsetUrl:Xa,itemsetUrl:Ha,fxsetUrl:Ba,fontUrl:Fa}),console.log(" Resource URL types:",{tilesetUrl:typeof _a,objsetUrl:typeof Na,mobsetUrl:typeof Xa,itemsetUrl:typeof Ha,fxsetUrl:typeof Ba,fontUrl:typeof Fa}),A.tileset=new Image,A.tileset.onload=()=>{s++,console.log(" Tileset loaded, resources:",s,"/",a)},A.tileset.onerror=c=>{console.error(" Failed to load tileset:",c.message,_a)},A.tileset.src="/res/tileset.png",A.objset=new Image,A.objset.onload=()=>{s++,console.log(" Objset loaded, resources:",s,"/",a)},A.objset.onerror=()=>{console.error(" Failed to load objset:",Na)},A.objset.src="/res/objset.png",A.mobset=new Image,A.mobset.onload=()=>{s++,console.log(" Mobset loaded, resources:",s,"/",a)},A.mobset.onerror=()=>{console.error(" Failed to load mobset:",Xa)},A.mobset.src="/res/mobset.png",A.itemset=new Image,A.itemset.onload=()=>{s++,console.log(" Itemset loaded, resources:",s,"/",a)},A.itemset.onerror=()=>{console.error(" Failed to load itemset:",Ha)},A.itemset.src="/res/itemset.png",A.fxset=new Image,A.fxset.onload=()=>{s++,console.log(" Fxset loaded, resources:",s,"/",a)},A.fxset.onerror=()=>{console.error(" Failed to load fxset:",Ba)},A.fxset.src="/res/fxset.png",A.fontsheet=new Image,A.fontsheet.onload=()=>{s++,console.log(" Fontsheet loaded, resources:",s,"/",a)},A.fontsheet.onerror=()=>{console.error(" Failed to load fontsheet:",Fa)},A.fontsheet.src="/res/font.png",this.levelState=3,this.cameraX=0,this.cameraY=0,this.cameraTargetX=0,this.cameraTargetY=0;let n=()=>{if(console.log(" Checking resources loaded:",s,"/",a),s<a)console.log(" Resources not ready yet, checking again in 500ms..."),window.setTimeout(n,500);else{console.log(" All resources loaded! Starting game initialization..."),A.scale=x.SCALE,document.addEventListener("touchstart",function(c){c.target==e&&c.preventDefault()},!1),document.addEventListener("touchend",function(c){c.target==e&&c.preventDefault()},!1),document.addEventListener("touchmove",function(c){c.target==e&&c.preventDefault()},!1),document.addEventListener("touchstart",I.handleTouchStart,{passive:!1}),document.addEventListener("touchmove",I.handleTouchMove,{passive:!1}),document.addEventListener("touchend",I.handleTouchEnd,{passive:!1}),I.keyDownListener=c=>{this.keyDownListener(c)},console.log(" Starting render loop..."),window.requestAnimationFrame(this.run),this.onResize(),window.addEventListener("resize",this.onResize),window.addEventListener("orientationchange",()=>{setTimeout(this.onResize,100)}),this.players={},this.offlinePlayers={},this.chatOpen=!1,this.cameraAnimation=new yl(0,0,1e3,1,0,!1),this.feedbackButton=new El,this.screenShakeX=0,this.screenShakeY=0,this.shakeAmountX=0,this.shakeAmountY=0,this.shakeFrame=3*Math.PI/2,this.screenShakeCutoff=0,this.tutorialActive=!1,this.screenShakeActive=!1,this.levels=[],this.encounteredEnemies=[],this.newGame();try{const{getCookie:c}=require("./utility/cookies");if(!!c("wr_save_meta")){const{Menu:d}=require("./gui/menu");this.startMenu=new d({game:this,showCloseButton:!1}),this.startMenu.buildStartMenu(),this.startMenu.openMenu(),this.startMenuActive=!0}}catch{}}};n()});r(this,"updateDepth",e=>{this.currentDepth=e,this.players[this.localPlayerID].depth=e});r(this,"updateLevel",e=>{e&&e.level&&(this.level=e.level),this.level.rooms.length>0&&(this.rooms=this.level.rooms,this.roomsById=new Map(this.rooms.map(t=>[t.globalId,t])))});r(this,"getRoomById",e=>{var t;return(t=this.roomsById)==null?void 0:t.get(e)});r(this,"getLevelById",e=>{var t;return(t=this.levelsById)==null?void 0:t.get(e)});r(this,"registerLevel",e=>{this.levelsById.set(e.globalId,e)});r(this,"registerRooms",e=>{this.rooms=e,this.roomsById=new Map(e.map(t=>[t.globalId,t]))});r(this,"setCurrentRoomById",e=>{const t=this.roomsById.get(e);return t&&(this.room=t,this.updateLevel(t)),t});r(this,"setPlayer",()=>{this.player=this.players[this.localPlayerID]});r(this,"newGame",e=>{I.mouseDownListeners.length=0,I.mouseUpListeners.length=0,I.mouseMoveListeners.length=0,I.mouseLeftClickListeners.length=0,I.mouseRightClickListeners.length=0,I.touchStartListeners.length=0,I.touchEndListeners.length=0,$e.resetStats(),this.currentDepth=0,this.encounteredEnemies=[],this.levels=[],this.hasRecordedStats=!1,this.loadedFromSaveFile=!1,this.gameStartTimeMs=Date.now(),this.currentPathId="main",this.startFreshWorld(e);try{const{loadSettings:t}=require("./game/settingsPersistence");t(this)}catch{}this.levelState=3,this.replayManager.beginRecording(zi.seed,this)});r(this,"keyDownListener",e=>{if(A.inputReceived=!0,!this.started){if(this.startMenuActive)return;this.startedFadeOut=!0;return}if(this.chatOpen)this.chatTextBox.handleKeyPress(e);else{switch(e.toUpperCase()){case"M":H.toggleMute(),this.pushMessage(H.audioMuted?"Audio muted":"Audio unmuted");return;case"C":this.chatOpen=!0;return;case"/":this.chatOpen=!0,this.chatTextBox.clear(),this.chatTextBox.handleKeyPress(e);return;case"1":vi.ANIMATION_CONSTANT=1;return;case"2":vi.ANIMATION_CONSTANT=2;return;case"3":vi.ANIMATION_CONSTANT=5;return;case"4":vi.ANIMATION_CONSTANT=1e4;return;case"0":vi.ANIMATION_CONSTANT=0;return}this.players[this.localPlayerID].inputHandler.handleKeyboardKey(e)}});r(this,"changeLevelThroughLadder",(e,t)=>{e.map.saveOldMap(),t instanceof wt&&!t.linkedRoom&&t.generate();const i=t.linkedRoom;let s;t.entryUpLadderPos&&(s={...t.entryUpLadderPos},console.log(`changeLevelThroughLadder: captured entryPosition (${s.x}, ${s.y}) for newRoom gid=${i==null?void 0:i.globalId}`)),this.players[this.localPlayerID]===e&&(e.levelID=i.id,e.roomGID=i.globalId,this.prevLevel=this.room,this.prevLevel.exitLevel()),i.envType===2&&H.playForestMusic(),i.envType===1&&H.playCaveMusic(),this.updateDepth(i.depth),this.levelState=2,this.transitionStartTime=Date.now(),this.transitioningLadder=t,s?(i.__entryPositionFromLadder=s,console.log(`changeLevelThroughLadder: wrote __entryPositionFromLadder to room gid=${i==null?void 0:i.globalId}`)):console.log(`changeLevelThroughLadder: no entryPosition available for room gid=${i==null?void 0:i.globalId}`)});r(this,"changeLevelThroughDoor",(e,t,i)=>{var s;t.linkedDoor.room.entered=!0,e.roomGID=t.room.globalId;try{const a=(s=this.rooms)==null?void 0:s.indexOf(t.room);a!==void 0&&a>=0&&(e.levelID=a)}catch{}if(this.players[this.localPlayerID]===e){this.levelState=1,this.transitionStartTime=Date.now();const a=t.doorDir!==t.linkedDoor.doorDir;let n=this.players[this.localPlayerID].x,c=this.players[this.localPlayerID].y;this.prevLevel=this.room,this.prevLevel.exitLevel(),this.room=t.room,t.room.enterLevelThroughDoor(e,t,i),this.transitionX=(this.players[this.localPlayerID].x-n)*x.TILESIZE,this.transitionY=(this.players[this.localPlayerID].y-c)*x.TILESIZE,this.upwardTransition=!1,this.sideTransition=!1,this.sideTransitionDirection=i,t instanceof ot&&[2,3].includes(t.doorDir)&&a?this.sideTransition=!0:t instanceof ot&&t.doorDir===0&&a&&(this.upwardTransition=!0)}else t.room.enterLevelThroughDoor(e,t,i);e.map.saveMapData()});r(this,"run",e=>{if(this.runStarted||(console.log(" Render loop started! First frame:",e),this.runStarted=!0),this.paused){window.requestAnimationFrame(this.run);return}if(!this.previousFrameTimestamp){this.previousFrameTimestamp=e,window.requestAnimationFrame(this.run);return}let i=(e-this.previousFrameTimestamp)*60/1e3;const s=1/10,a=8;for(A.delta&&(i=A.delta),i<s?i=s:i>a&&(i=a);Ms.length>0&&Ms[0]<=e-1e3;)Ms.shift();Ms.push(e),pn=Ms.length,Math.floor(e/(1e3/60))>Math.floor(this.previousFrameTimestamp/(1e3/60))&&this.update(),Math.floor(e)>Math.floor(this.previousFrameTimestamp)+1e3&&this.refreshDimensions(),this.draw(i*x.ANIMATION_SPEED*1),window.requestAnimationFrame(this.run),this.previousFrameTimestamp=e});r(this,"update",()=>{if(this.refreshDimensions(),I.checkIsTapHold(),this.replayManager.isReplaying()||I.lastPressTime!==0&&Date.now()-I.lastPressTime>x.KEY_REPEAT_TIME&&I.onKeydown({repeat:!1,key:I.lastPressKey}),!this.replayManager.isReplaying()&&I.mouseDown&&I.mouseDownHandled&&I.lastMouseDownTime!==0&&Date.now()-I.lastMouseDownTime>x.KEY_REPEAT_TIME){const e=this.players[this.localPlayerID];e&&e.game.levelState===0&&!e.dead&&!e.menu.open&&!e.busyAnimating&&!e.game.cameraAnimation.active&&(e.moveWithMouse(),I.lastMouseDownTime=Date.now())}if(I.swipeHoldActive&&I.lastSwipeTime!==0){const e=Date.now()-I.lastSwipeTime;if(!I.swipeHoldRepeating)e>x.SWIPE_HOLD_INITIAL_DELAY&&(I.swipeHoldRepeating=!0,I.lastSwipeTime=Date.now());else if(e>x.SWIPE_HOLD_REPEAT_TIME){switch(I.lastSwipeDirection){case 3:I.leftSwipeListener();break;case 2:I.rightSwipeListener();break;case 1:I.upSwipeListener();break;case 0:I.downSwipeListener();break}I.lastSwipeTime=Date.now()}}if(this.levelState===1&&Date.now()-this.transitionStartTime>=q.LEVEL_TRANSITION_TIME&&(this.levelState=0),this.levelState===2&&Date.now()-this.transitionStartTime>=q.LEVEL_TRANSITION_TIME_LADDER&&(this.levelState=0,this.players[this.localPlayerID].map.saveMapData()),this.levelState!==3)for(const e in this.players){if(this.players[e].update(),this.levelState!==1&&this.levelState!==2){const t=this.players[e];(t.getRoom?t.getRoom():this.levels[t.depth].rooms[t.levelID]).update()}if(this.players[e].dead)for(const t in this.players)this.players[t].dead=!0}});r(this,"lerp",(e,t,i)=>(1-i)*e+i*t);r(this,"pushMessage",e=>{this.chat.push(new mn(e))});r(this,"recordGameStats",e=>{try{const t=gr(this);un({...e,gameState:t})}catch(t){console.warn("Failed to record game stats:",t),un(e)}});r(this,"convertSeedToNumber",e=>{if(/^\d+$/.test(e))return parseInt(e);let t=0;for(let i=0;i<e.length;i++){const s=e.charCodeAt(i);t=(t<<5)-t+s,t=t&t}return Math.abs(t)});r(this,"commandHandler",e=>{var i,s,a,n,c,l;e=e.toLowerCase();let t="";if(e.startsWith("new")){if(e.startsWith("new ")){const d=e.slice(4).trim(),u=this.convertSeedToNumber(d);this.pushMessage(`Starting new game with seed: ${d} (${u})`),this.newGame(u)}else e==="new"&&this.newGame();return}switch(e){case"ladder":this.pushMessage(`Distance to nearest up ladder: ${this.room.getDistanceToNearestLadder("up")}`);break;case"encounter":this.pushMessage("Encountering enemies..."+this.encounteredEnemies.length);break;case"key":const d=this.level.getKeyRoom(this.room);if(d){this.pushMessage(`Key room: ${d.id}`),d.entered=!0,d.calculateWallInfo(),this.changeLevelThroughDoor(this.players[this.localPlayerID],d.doors[0],1);const h=d.getRandomEmptyPosition(d.getEmptyTiles());this.players[this.localPlayerID].x=h.x,this.players[this.localPlayerID].y=h.y,d.updateLighting(),this.pushMessage("Downladder located")}break;case"level":this.pushMessage(`Level: ${this.level.globalId}`);break;case"down":let u;for(const h of this.level.rooms)if(h.type!==R.DOWNLADDER){for(let f=h.roomX;f<h.roomX+h.width;f++)for(let p=h.roomY;p<h.roomY+h.height;p++)if(h.roomArray[f][p]instanceof wt){u=h.roomArray[f][p];break}}u&&(u.room.entered=!0,u.room.calculateWallInfo(),this.changeLevelThroughDoor(this.players[this.localPlayerID],u.room.doors[0],1),u.lockable.removeLock(),this.players[this.localPlayerID].x=u.x,this.players[this.localPlayerID].y=u.y,u.room.updateLighting(),this.pushMessage("Downladder located"));break;case"lightup":q.LIGHTING_ANGLE_STEP+=1,this.pushMessage(`Lighting angle step is now ${q.LIGHTING_ANGLE_STEP}`);break;case"lightdown":q.LIGHTING_ANGLE_STEP>1&&(q.LIGHTING_ANGLE_STEP-=1),this.pushMessage(`Lighting angle step is now ${q.LIGHTING_ANGLE_STEP}`);break;case"savec":{try{const{saveToCookies:h}=require("./game/savePersistence");h(this),this.pushMessage("Attempted cookie save (cookies/localStorage fallback).")}catch{this.pushMessage("Cookie save failed.")}break}case"loadc":{try{const{loadFromCookies:h}=require("./game/savePersistence");h(this),this.pushMessage("Attempted cookie load (cookies/localStorage fallback).")}catch{this.pushMessage("Cookie load failed.")}break}case"replay":this.pushMessage("Starting replay..."),this.replayManager.replay(this);break;case"replayinfo":{const h=(s=(i=this.replayManager).getStats)==null?void 0:s.call(i);this.pushMessage(h?`Replay stats: actions=${h.count}, seed=${h.seed}, recording=${h.recording}, replaying=${h.replaying}`:"No replay stats available.");break}case"replayclear":(n=(a=this.replayManager).clearRecording)==null||n.call(a),this.pushMessage("Replay buffer cleared.");break;case"devmode":x.DEVELOPER_MODE=!x.DEVELOPER_MODE,console.log(`Developer mode is now ${x.DEVELOPER_MODE}`);break;case"dev":x.DEVELOPER_MODE=!x.DEVELOPER_MODE,console.log(`Developer mode is now ${x.DEVELOPER_MODE}`),this.newGame();break;case"kill":for(const h in this.players)this.players[h].dead=!0;break;case"killall":for(const h in this.players)this.players[h].game.room.entities.forEach(f=>{f.kill()});break;case"bomb":this.room.addBombs(1,()=>O.rand());break;case"col":x.SET_COLOR_LAYER_COMPOSITE_OPERATION(!1);break;case"scl":x.SET_SCALE(),this.onResize();break;case"shd":break;case"shdop":x.SET_SHADE_LAYER_COMPOSITE_OPERATION(!1);break;case"smooth":x.SMOOTH_LIGHTING=!x.SMOOTH_LIGHTING,t=x.SMOOTH_LIGHTING?"enabled":"disabled",this.pushMessage(`Smooth lighting is now ${t}`);try{const{saveSettings:h}=require("./game/settingsPersistence");h(this)}catch{}break;case"rooms":x.drawOtherRooms=!x.drawOtherRooms,t=x.drawOtherRooms?"enabled":"disabled",this.pushMessage(`Drawing other rooms is now ${t}`);break;case"opq":x.ENEMIES_BLOCK_LIGHT=!x.ENEMIES_BLOCK_LIGHT,t=x.ENEMIES_BLOCK_LIGHT?"enabled":"disabled",this.pushMessage(`Enemies block light is now ${t}`);break;case"peace":G.NO_ENEMIES=!G.NO_ENEMIES,this.newGame(),t=G.NO_ENEMIES?"enabled":"disabled",this.pushMessage(`Peaceful mode is now ${t}`);break;case"equip":G.EQUIP_USES_TURN=!G.EQUIP_USES_TURN,t=G.EQUIP_USES_TURN?"enabled":"disabled",this.pushMessage(`Equipping an item takes a turn is now ${t}`);break;case"inline":x.SHADE_INLINE_IN_ENTITY_LAYER=!x.SHADE_INLINE_IN_ENTITY_LAYER,t=x.SHADE_INLINE_IN_ENTITY_LAYER?"enabled":"disabled",this.pushMessage(`Inline tile shading ${t}`);break;case"webgl":{if(x.TOGGLE_USE_WEBGL_BLUR(),x.USE_WEBGL_BLUR)try{const{WebGLBlurRenderer:h}=require("./gui/webglBlurRenderer");h.getInstance(),this.pushMessage("WebGL blur enabled and initialized.")}catch{this.pushMessage("Failed to initialize WebGL blur. Falling back to Canvas blur."),x.USE_WEBGL_BLUR=!1}else{try{const{WebGLBlurRenderer:h}=require("./gui/webglBlurRenderer");(l=(c=h.getInstance()).clearCache)==null||l.call(c)}catch{}this.pushMessage("WebGL blur disabled.")}break}case"hq":x.TOGGLE_HIGH_QUALITY_BLUR();break;case"genroom":this.generateAndShowRoomLayout();break;case"cleargen":this.currentLevelGenerator=null,this.pushMessage("Cleared generated level display");break;case"post":rs.settings.enabled=!rs.settings.enabled,t=rs.settings.enabled?"enabled":"disabled",this.pushMessage(`Post processor is now ${t}`);break;case"save":try{this.replayManager.isReplaying()?this.pushMessage("Cannot save during replay."):(this.savedGameState=gr(this),this.pushMessage("Game state saved successfully!"),console.log("Saved game state:",this.savedGameState))}catch(h){this.pushMessage("Error saving game state: "+h.message),console.error("Save error:",h)}break;case"load":if(!this.savedGameState){this.pushMessage("No saved game state found. Use 'save' command first.");return}try{const h=Object.keys(this.players);Ja(this,h,this.savedGameState,!1),this.pushMessage("Game state loaded successfully!"),console.log("Loaded game state")}catch(h){this.pushMessage("Error loading game state: "+h.message),console.error("Load error:",h)}break;case"saveinfo":if(!this.savedGameState){this.pushMessage("No saved game state found.");return}this.pushMessage(`Saved state - Seed: ${this.savedGameState.seed}, Depth: ${this.savedGameState.level.depth}, Players: ${Object.keys(this.savedGameState.players).length}`),console.log("Saved game state details:",this.savedGameState);break;case"currentinfo":this.pushMessage(`Current state - Seed: ${this.levelgen.seed}, Depth: ${this.level.depth}, Players: ${Object.keys(this.players).length}`),console.log("Current game state details:",{seed:this.levelgen.seed,depth:this.level.depth,players:Object.keys(this.players),rooms:this.rooms.length});break;case"testsave":try{if(this.replayManager.isReplaying()){this.pushMessage("Cannot save during replay.");break}this.savedGameState=gr(this);const h=this.players[this.localPlayerID].health,f=this.players[this.localPlayerID].x,p=this.players[this.localPlayerID].y;this.players[this.localPlayerID].health=Math.max(1,this.players[this.localPlayerID].health-1),this.players[this.localPlayerID].x+=1,this.players[this.localPlayerID].y+=1,this.pushMessage(`Changes made - Health: ${h} -> ${this.players[this.localPlayerID].health}, Pos: (${f},${p}) -> (${this.players[this.localPlayerID].x},${this.players[this.localPlayerID].y})`),this.pushMessage("Use 'load' to restore the saved state")}catch(h){this.pushMessage("Error in test save: "+h.message),console.error("Test save error:",h)}break;default:if(e.startsWith("spawn "))this.room.addNewEnemy(e.slice(6));else if(e.startsWith("fill"))for(;this.room.getEmptyTiles().length>0;)this.room.addNewEnemy(e.slice(5));break}});r(this,"maxScale",()=>{let e=window.innerWidth,t=130;for(let i=x.MIN_SCALE;i<=x.MAX_SCALE;i++)if(e/i<t)return i;return x.MAX_SCALE});r(this,"increaseScale",()=>{x.INCREASE_SCALE(),this.onResize(),I.recalculateMousePosition()});r(this,"decreaseScale",()=>{x.DECREASE_SCALE(),this.onResize(),I.recalculateMousePosition()});r(this,"updateScale",e=>{x.SOFT_SCALE=x.SCALE,this.onResize(),I.recalculateMousePosition()});r(this,"refreshDimensions",()=>{A.ctx.canvas.setAttribute("width",`${x.WIDTH}`),A.ctx.canvas.setAttribute("height",`${x.HEIGHT}`)});r(this,"onResize",()=>{var c,l,d;this.localPlayerID!==void 0&&((c=this.players)!=null&&c[this.localPlayerID])&&((d=(l=this.players)==null?void 0:l[this.localPlayerID])!=null&&d.menu)&&this.players[this.localPlayerID].menu.positionButtons(),this.isMobile=/iPhone|iPad|iPod|Android|webOS|BlackBerry|IEMobile|Opera Mini|Mobile|mobile|CriOS/i.test(navigator.userAgent),x.isIOS=/iPhone|iPad|iPod/i.test(navigator.userAgent)&&!navigator.userAgent.includes("Chrome DevTools"),/Safari/.test(navigator.userAgent)&&!/Chrome/.test(navigator.userAgent)&&(x.USE_WEBGL_BLUR=!0,x.SCALE===null&&(x.SMOOTH_LIGHTING=!1)),x.SCALE===null&&(x.SCALE=x.FIND_SCALE(this.isMobile),x.SOFT_SCALE=x.SCALE);let t=0,i=Math.floor(window.innerWidth/x.DEFAULTWIDTH),s=Math.floor(window.innerHeight/x.DEFAULTHEIGHT);if(this.isMobile){this.isMobile&&console.log("Mobile detected"),x.SHADE_LEVELS=35,x.isMobile=!0,q.LIGHTING_ANGLE_STEP=8,q.LIGHTING_MAX_DISTANCE=7,x.USE_WEBGL_BLUR=!0;const u=x.SOFT_SCALE+t;A.scale=Math.min(i,s,u)}else{x.isMobile=!1;const u=x.SOFT_SCALE+t;A.scale=Math.min(i,s,u)}A.scale===0&&(i=window.innerWidth/x.DEFAULTWIDTH,s=window.innerHeight/x.DEFAULTHEIGHT,A.scale=Math.max(1,Math.min(i,s,1+t)));const a=1;A.scale*=a/window.devicePixelRatio,q.SCREEN_W=Math.floor(window.innerWidth/A.scale/x.TILESIZE),q.SCREEN_H=Math.floor(window.innerHeight/A.scale/x.TILESIZE),x.WIDTH=Math.floor(window.innerWidth/A.scale),x.HEIGHT=Math.floor(window.innerHeight/A.scale),A.ctx.canvas.setAttribute("width",`${x.WIDTH}`),A.ctx.canvas.setAttribute("height",`${x.HEIGHT}`),A.ctx.canvas.setAttribute("style",`width: ${x.WIDTH*A.scale}px; height: ${x.HEIGHT*A.scale}px;
      display: block;
      margin: 0 auto;
      image-rendering: optimizeSpeed; /* Older versions of FF */
      image-rendering: -moz-crisp-edges; /* FF 6.0+ */
      image-rendering: -webkit-optimize-contrast; /* Safari */
      image-rendering: -o-crisp-edges; /* OS X & Windows Opera (12.02+) */
      image-rendering: pixelated; /* Future-browsers */
      -ms-interpolation-mode: nearest-neighbor; /* IE */
      `);const n=x.WIDTH-20;n!==this.lastChatWidth&&(this.chat.forEach(u=>u.clearCache()),this.lastChatWidth=n)});r(this,"shakeScreen",(e,t,i=!1)=>{let s=i?Math.max(-3,Math.min(3,e)):e,a=i?Math.max(-3,Math.min(3,t)):t;this.screenShakeActive=!0,this.screenShakeX+=s,this.screenShakeY+=a,this.shakeAmountX+=Math.abs(s),this.shakeAmountY+=Math.abs(a),(s<0||a<0)&&(this.shakeFrame=3*Math.PI/2),(s>0||a>0)&&(this.shakeFrame=Math.PI/2),this.screenShakeCutoff=Date.now()});r(this,"drawRooms",(e,t=!1)=>{if(x.drawOtherRooms){if(x.drawOtherRooms){const i=this.rooms.filter(s=>s.pathId===this.currentPathId).slice().sort((s,a)=>{const n=s.roomY+s.height,c=a.roomY+a.height;return n-c});for(const s of i)(s===this.room||s.active||s.entered&&s.onScreen)&&(s.draw(e),s.drawEntities(e,t))}}else{if(!this.room||this.room.pathId!==this.currentPathId)return;this.room.draw(e),this.room.drawEntities(e,!0)}});r(this,"drawRoomShadeAndColor",e=>{for(const t of this.rooms){if(t.pathId!==this.currentPathId)continue;(t===this.room||t.active||t.entered)&&(x.SMOOTH_LIGHTING&&!x.SHADE_INLINE_IN_ENTITY_LAYER&&t.drawShadeLayer(),t.drawColorLayer(),t.drawBloomLayer(e))}for(const t of this.rooms){if(t.pathId!==this.currentPathId)continue;(t===this.room||t.active&&t.entered)&&t.drawOverShade(e)}});r(this,"drawStartScreen",e=>{var i;let t="Welcome to Turnarchist";if(A.ctx.globalAlpha=this.startScreenAlpha,!this.started&&!this.startedFadeOut?(this.startScreenAlpha=1,this.startScreenAlpha<=0&&(this.startScreenAlpha=0)):!this.started&&this.startedFadeOut&&(this.startScreenAlpha-=e*.025,this.startScreenAlpha<=0&&(this.startScreenAlpha=0,this.started=!0,H.playAmbient())),A.ctx.fillStyle="black",A.ctx.fillRect(0,0,x.WIDTH,x.HEIGHT),A.ctx.fillStyle=q.LEVEL_TEXT_COLOR,!this.startMenuActive&&!this.startedFadeOut){A.fillText(t,x.WIDTH/2-A.measureText(t).width/2,x.HEIGHT/2-A.letter_height+2);let s="Press space or click to start";this.isMobile&&(s="Tap to start"),A.fillText(s,x.WIDTH/2-A.measureText(s).width/2,x.HEIGHT/2+A.letter_height+5)}else(i=this.startMenu)==null||i.draw();A.ctx.globalAlpha=1});r(this,"drawTipScreen",e=>{let t=this.tip;A.ctx.fillStyle="black",A.ctx.fillRect(0,0,x.WIDTH,x.HEIGHT),A.ctx.fillStyle=q.LEVEL_TEXT_COLOR,A.fillText(t,x.WIDTH/2-A.measureText(t).width/2,x.HEIGHT/2-A.letter_height+2)});r(this,"draw",e=>{if(x.SOFT_SCALE!==x.SCALE&&(this.updateScale(e),this.onResize()),A.ctx.clearRect(0,0,x.WIDTH,x.HEIGHT),A.ctx.save(),A.ctx.setTransform(1,0,0,1,0,0),A.ctx.globalAlpha=1,A.ctx.globalCompositeOperation="source-over",A.ctx.fillStyle="black",A.ctx.fillRect(0,0,x.WIDTH,x.HEIGHT),this.levelState===1){this.screenShakeX=0,this.screenShakeY=0,this.screenShakeActive=!1;let t=Math.floor(this.lerp((Date.now()-this.transitionStartTime)/q.LEVEL_TRANSITION_TIME,0,-this.transitionX)),i=Math.floor(this.lerp((Date.now()-this.transitionStartTime)/q.LEVEL_TRANSITION_TIME,0,-this.transitionY)),s=t-this.transitionX,a=i-this.transitionY,n=(this.players[this.localPlayerID].x-this.players[this.localPlayerID].drawX+.5)*x.TILESIZE,c=(this.players[this.localPlayerID].y-this.players[this.localPlayerID].drawY+.5)*x.TILESIZE;A.ctx.translate(-Math.round(n+s-.5*x.WIDTH),-Math.round(c+a-.5*x.HEIGHT));let l=Math.floor(this.lerp((Date.now()-this.transitionStartTime)/q.LEVEL_TRANSITION_TIME,0,x.TILESIZE)),d=s,u=a;this.sideTransition?this.sideTransitionDirection>0?(t+=l,d+=l+x.TILESIZE):(t-=l,d-=l+x.TILESIZE):this.upwardTransition?(i-=l,u-=l+x.TILESIZE):(i+=l,u+=l+x.TILESIZE),Math.floor(7*(Date.now()-this.transitionStartTime)/q.LEVEL_TRANSITION_TIME),A.ctx.translate(t,i),x.drawOtherRooms||(this.prevLevel.draw(e),this.prevLevel.drawEntities(e),this.prevLevel.drawColorLayer(),this.prevLevel.drawShade(e),this.prevLevel.drawOverShade(e)),A.ctx.translate(-t,-i),A.ctx.translate(d,u),x.drawOtherRooms&&(this.drawRooms(e,!0),A.ctx.translate(-d,-u),A.ctx.translate(s,a),this.players[this.localPlayerID].draw(e),A.ctx.translate(-s,-a),A.ctx.translate(d,u),this.drawRoomShadeAndColor(e));for(let h=this.room.roomX-1;h<=this.room.roomX+this.room.width;h++)for(let f=this.room.roomY-1;f<=this.room.roomY+this.room.height;f++);A.ctx.translate(-d,-u),A.ctx.translate(Math.round(n+s-.5*x.WIDTH),Math.round(c+a-.5*x.HEIGHT)),this.players[this.localPlayerID].drawGUI(e),this.justTransitioned=!0}else if(this.levelState===2){let t=(this.players[this.localPlayerID].x-this.players[this.localPlayerID].drawX+.5)*x.TILESIZE,i=(this.players[this.localPlayerID].y-this.players[this.localPlayerID].drawY+.5)*x.TILESIZE;A.ctx.translate(-Math.round(t-.5*x.WIDTH),-Math.round(i-.5*x.HEIGHT));let s=6,a=Math.floor((14+s)*(Date.now()-this.transitionStartTime)/q.LEVEL_TRANSITION_TIME_LADDER);if(A.ctx.translate(Math.round(t-.5*x.WIDTH),Math.round(i-.5*x.HEIGHT)),a<7){if(this.drawRooms(e),this.drawRoomShadeAndColor(e),!x.drawOtherRooms)for(let n=this.room.roomX-1;n<=this.room.roomX+this.room.width;n++)for(let c=this.room.roomY-1;c<=this.room.roomY+this.room.height;c++)A.drawFX(7-a,10,1,1,n,c,1,1)}else if(a>=7+s&&(this.transitioningLadder&&(this.room=this.transitioningLadder.linkedRoom,this.room.enterLevel(this.players[this.localPlayerID]),this.transitioningLadder=null),this.drawRooms(e),this.drawRoomShadeAndColor(e),!x.drawOtherRooms))for(let n=this.room.roomX-1;n<=this.room.roomX+this.room.width;n++)for(let c=this.room.roomY-1;c<=this.room.roomY+this.room.height;c++)A.drawFX(a-(7+s),10,1,1,n,c,1,1);this.drawTextScreen("loading level")}else if(this.levelState===3)this.levelgen.draw(e);else if(this.levelState===0){this.drawScreenShake(e);const{cameraX:t,cameraY:i}=this.applyCamera(e);A.ctx.translate(-t,-i),this.drawRooms(e),this.drawRoomShadeAndColor(e),A.ctx.translate(t,i),this.room.drawTopLayer(e),this.players[this.localPlayerID].drawGUI(e)}this.drawChat(e),A.ctx.globalAlpha=.1,A.ctx.fillStyle=q.LEVEL_TEXT_COLOR,A.fillText(x.VERSION,x.WIDTH-A.measureText(x.VERSION).width-1,1),A.ctx.globalAlpha=1,A.ctx.globalAlpha=.1,A.ctx.fillStyle=q.LEVEL_TEXT_COLOR,A.fillText(pn+"fps",1,1),A.ctx.globalAlpha=1,!this.started&&this.levelState!==3&&this.drawStartScreen(e*10),this.currentLevelGenerator&&this.currentLevelGenerator.draw(10,10,3),pt.getInstance().draw(e,this.isMobile),A.ctx.restore()});r(this,"drawChat",e=>{var d,u;const i=x.HEIGHT-A.letter_height-38,s=(u=(d=this.players)==null?void 0:d[this.localPlayerID])!=null&&u.inventory.isOpen?.05:1,a=x.WIDTH-5,n=A.letter_height+1;if(this.chatOpen){A.ctx.fillStyle="black",A.ctx.globalAlpha=.75,A.ctx.fillRect(0,0,x.WIDTH,x.HEIGHT),A.ctx.globalAlpha=1,A.ctx.fillStyle="white",A.fillText(this.chatTextBox.text,5,i);const h=A.measureText(this.chatTextBox.text.substring(0,this.chatTextBox.cursor)).width;A.ctx.fillRect(5+h,i,1,A.letter_height)}const c=[];for(let h=0;h<this.chat.length;h++){const p=this.chat[h].getWrappedLines(a).length*n;c.push(p)}let l=i;this.chatOpen&&(l-=n);for(let h=this.chat.length-1;h>=0;h--){const f=this.chat[h],p=f.getWrappedLines(a),y=c[h],g=Date.now()-f.timestamp;let w=1;if(this.chatOpen||(g<=x.CHAT_APPEAR_TIME?w=s:g<=x.CHAT_APPEAR_TIME+x.CHAT_FADE_TIME?w=s*(1-(g-x.CHAT_APPEAR_TIME)/x.CHAT_FADE_TIME):w=0),w>0){A.ctx.fillStyle="white",A.ctx.globalAlpha=w;let b=l;for(let T=p.length-1;T>=0;T--)A.fillText(p[T],5,b),b-=n}l-=y}A.ctx.globalAlpha=1});r(this,"targetCamera",(e,t)=>{let i=Math.round((e+.5)*x.TILESIZE-.5*x.WIDTH),s=Math.round((t+.5)*x.TILESIZE-.5*x.HEIGHT);this.cameraTargetX=i,this.cameraTargetY=s});r(this,"updateCamera",e=>{const t=this.cameraTargetX-this.cameraX,i=this.cameraTargetY-this.cameraY;let s=x.CAMERA_SPEED;this.justTransitioned&&(s=1,this.justTransitioned=!1),this.cameraAnimation.active&&(s=.075),(Math.abs(t)>250||Math.abs(i)>250)&&(s=1),(Math.abs(t)>1||Math.abs(i)>1)&&s!==1?(this.cameraX+=t*s*e,this.cameraY+=i*s*e):(this.cameraX=this.cameraTargetX,this.cameraY=this.cameraTargetY)});r(this,"applyCamera",e=>{let t=this.players[this.localPlayerID];this.targetCamera(t.x-t.drawX,t.y-t.drawY),this.updateCameraAnimation(e),this.updateCamera(e);const i=Math.round(this.cameraX-this.screenShakeX),s=Math.round(this.cameraY-this.screenShakeY);return{cameraX:i,cameraY:s}});r(this,"drawScreenShake",e=>{if(!this.screenShakeActive){this.resetScreenShake();return}this.shakeAmountX*=.8**e,this.shakeAmountY*=.8**e,this.screenShakeX=Math.sin(this.shakeFrame*Math.PI)*this.shakeAmountX,this.screenShakeY=Math.sin(this.shakeFrame*Math.PI)*this.shakeAmountY,this.shakeFrame+=.15*e,Math.abs(this.shakeAmountX)<.5&&Math.abs(this.shakeAmountY)<.5&&this.resetScreenShake()});r(this,"resetScreenShake",()=>{this.shakeAmountX=0,this.shakeAmountY=0,this.shakeFrame=0,this.screenShakeX=0,this.screenShakeY=0,this.screenShakeActive=!1});r(this,"updateCameraAnimation",e=>{if(!this.cameraAnimation.active)return;this.cameraAnimation.frame/this.cameraAnimation.duration<.6&&this.targetCamera(this.cameraAnimation.x,this.cameraAnimation.y),this.cameraAnimation.frame+=e,this.cameraAnimation.frame>this.cameraAnimation.duration&&(this.cameraAnimation.active=!1)});r(this,"startCameraAnimation",(e,t,i)=>{this.cameraAnimation.active=!0,this.cameraAnimation.x=e,this.cameraAnimation.y=t,this.cameraAnimation.duration=i,this.cameraAnimation.frame=0});r(this,"drawTextScreen",(e,t=!0)=>{t&&(A.ctx.fillStyle="rgb(0, 0, 0)",A.ctx.fillRect(0,0,x.WIDTH,x.HEIGHT));const i=this.animateEllipsis(),s=A.measureText(e+i);A.ctx.fillStyle="rgb(255, 255, 255)",A.fillText(e+i,x.WIDTH/2-s.width/2,x.HEIGHT/2-s.height/2)});r(this,"animateEllipsis",()=>(Date.now()-this.ellipsisStartTime>150&&(this.ellipsisStartTime=Date.now(),this.ellipsisFrame=(this.ellipsisFrame+1)%4),".".repeat(this.ellipsisFrame)));r(this,"handleWindowBlur",()=>{this.focusTimeout=window.setTimeout(()=>{this.wasMuted=H.audioMuted,this.wasStarted=this.started,H.audioMuted=!0,this.paused=!0,this.pushMessage("Game paused - window inactive")},this.FOCUS_TIMEOUT_DURATION)});r(this,"handleWindowFocus",()=>{this.focusTimeout&&(clearTimeout(this.focusTimeout),this.focusTimeout=null),this.paused&&(H.audioMuted=this.wasMuted,this.started=this.wasStarted,this.paused=!1,this.pushMessage("Game resumed"))});this.globalId=se.generate("G"),this.roomsById=new Map,this.levelsById=new Map,window.addEventListener("load",this.loadGame),Fe.initialize(),H.loadSounds(),this.started=!1,this.tutorialListener=null,this.setupEventListeners(),ht.on(xt.LEVEL_GENERATION_STARTED,()=>{this.levelState=3}),ht.on(xt.LEVEL_GENERATION_COMPLETED,()=>{this.levelState=0})}get replayManager(){return A._replayManager||(A._replayManager=new xl),A._replayManager}startFreshWorld(e){zi.seed=e??Math.random()*4294967296>>>0,zi.randomState=zi.seed,Ja(this,[this.localPlayerID],zi,!0);try{const{loadSettings:t}=require("./game/settingsPersistence");t(this)}catch{}this.levelState=3,this.replayManager.beginRecording(zi.seed,this)}setupEventListeners(){ht.on("ChatCommand",this.commandHandler.bind(this));try{const e=()=>{try{const{saveToCookies:t}=require("./game/savePersistence");t(this)}catch{}};window.addEventListener("beforeunload",e),document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"&&e()}),window.addEventListener("pagehide",e),window.addEventListener("unload",()=>{var t;try{const{Sound:i}=require("./sound/sound");(t=i.cleanup)==null||t.call(i)}catch{}}),window.addEventListener("popstate",e),window.addEventListener("hashchange",e)}catch{}}generateAndShowRoomLayout(){const e=["center","split","corners"],t=e[Math.floor(O.rand()*e.length)],i=8+Math.floor(O.rand()*12),s=60+Math.floor(O.rand()*40),a=50+Math.floor(O.rand()*30),n=bo.generateRandomLevel(s,a,i,O.rand,t),c=n.areRoomsAccessible(),l=c?" All rooms accessible":" Some rooms inaccessible";this.currentLevelGenerator=n,this.pushMessage(`Generated ${i} rooms (${t} pattern) - ${l}`),this.pushMessage("Level layout shown on screen. Use '/cleargen' to clear.");const d=new Date().toISOString().slice(0,19).replace(/[T:]/g,"_"),u=`${t}_${s}x${a}_${i}rooms_${d}.png`;n.savePNG(u),this.pushMessage(`PNG saved as: generated_levels/${u}`),this.pushMessage("Check browser downloads or console for data URL"),x.DEVELOPER_MODE&&console.log("Generated level details:",{pattern:t,dimensions:`${s}x${a}`,numRooms:i,accessible:c,rooms:n.getRooms()})}destroy(){window.removeEventListener("blur",this.handleWindowBlur),window.removeEventListener("focus",this.handleWindowFocus),this.focusTimeout&&clearTimeout(this.focusTimeout)}};r(A,"_replayManager",null),r(A,"ctx"),r(A,"shade_canvases"),r(A,"inputReceived",!1),r(A,"scale"),r(A,"interpolatedScale"),r(A,"tileset"),r(A,"objset"),r(A,"mobset"),r(A,"itemset"),r(A,"fxset"),r(A,"fontsheet"),r(A,"delta"),r(A,"text_rendering_canvases"),r(A,"letters","abcdefghijklmnopqrstuvwxyz1234567890,.!?:'()[]%-/+"),r(A,"letter_widths",[4,4,4,4,3,3,4,4,1,4,4,3,5,5,4,4,4,4,4,3,4,5,5,5,5,3,3,4,4,4,4,4,4,4,4,4,2,1,1,4,1,1,2,2,2,2,5,3,3,3]),r(A,"letter_height",6),r(A,"letter_positions",[]),r(A,"rand",(e,t,i)=>t<e?e:Math.floor(i()*(t-e+1)+e)),r(A,"randTable",(e,t)=>e[A.rand(0,e.length-1,t)]),r(A,"measureText",e=>{let t=0;for(const i of e.toLowerCase())if(i===" ")t+=4;else for(let s=0;s<A.letters.length;s++)A.letters[s]===i&&(t+=A.letter_widths[s]+1);return{width:t,height:A.letter_height}}),r(A,"fillText",(e,t,i,s)=>{if(t=Math.round(t),i=Math.round(i),A.letter_positions.length===0)for(let a=0;a<A.letter_widths.length;a++)a===0?A.letter_positions[0]=0:A.letter_positions[a]=A.letter_positions[a-1]+A.letter_widths[a-1]+2;else{let a=A.measureText(e);if(a.width>0){let n=e+A.ctx.fillStyle;if(A.text_rendering_canvases[n])A.ctx.drawImage(A.text_rendering_canvases[n],t,i);else{A.text_rendering_canvases[n]=document.createElement("canvas"),A.text_rendering_canvases[n].width=a.width,A.text_rendering_canvases[n].height=a.height;let c=A.text_rendering_canvases[n].getContext("2d"),l=0;for(const d of e.toLowerCase())if(d===" ")l+=4;else for(let u=0;u<A.letters.length;u++)A.letters[u]===d&&(c.drawImage(A.fontsheet,A.letter_positions[u]+1,0,A.letter_widths[u],A.letter_height,l,0,A.letter_widths[u],A.letter_height),l+=A.letter_widths[u]+1);c.fillStyle=A.ctx.fillStyle,c.globalCompositeOperation="source-in",c.fillRect(0,0,A.text_rendering_canvases[n].width,A.text_rendering_canvases[n].height),A.ctx.drawImage(A.text_rendering_canvases[n],t,i)}}}}),r(A,"fillTextOutline",(e,t,i,s,a)=>{A.ctx.fillStyle=s;for(let n=-1;n<=1;n++)for(let c=-1;c<=1;c++)A.fillText(e,t+n,i+c);A.ctx.fillStyle=a,A.fillText(e,t,i)}),r(A,"drawHelper",(e,t,i,s,a,n,c,l,d,u="black",h=0,f=!1,p)=>{A.ctx.save();const y=f?x.ENTITY_SHADE_LEVELS:x.SHADE_LEVELS;h=Math.round(h*Math.max(y,12))/Math.max(y,12);let g=Qc(e,t,i,s,a,h,u,p);if(!A.shade_canvases[g]){A.shade_canvases[g]=document.createElement("canvas"),A.shade_canvases[g].width=Math.round(s*x.TILESIZE),A.shade_canvases[g].height=Math.round(a*x.TILESIZE);let w=A.shade_canvases[g].getContext("2d");if(w.clearRect(0,0,A.shade_canvases[g].width,A.shade_canvases[g].height),w.globalCompositeOperation="source-over",w.drawImage(e,Math.round(t*x.TILESIZE),Math.round(i*x.TILESIZE),Math.round(s*x.TILESIZE),Math.round(a*x.TILESIZE),0,0,Math.round(s*x.TILESIZE),Math.round(a*x.TILESIZE)),w.globalAlpha=h,w.fillStyle=u,w.fillRect(0,0,A.shade_canvases[g].width,A.shade_canvases[g].height),w.globalAlpha=1,w.globalCompositeOperation="destination-in",w.drawImage(e,Math.round(t*x.TILESIZE),Math.round(i*x.TILESIZE),Math.round(s*x.TILESIZE),Math.round(a*x.TILESIZE),0,0,Math.round(s*x.TILESIZE),Math.round(a*x.TILESIZE)),p){const b=Math.round(s*x.TILESIZE),T=Math.round(a*x.TILESIZE);let v=null;switch(p){case"left":v=w.createLinearGradient(0,0,b,0),v.addColorStop(0,"rgba(0,0,0,0)"),v.addColorStop(1,"rgba(0,0,0,1)");break;case"right":v=w.createLinearGradient(0,0,b,0),v.addColorStop(0,"rgba(0,0,0,1)"),v.addColorStop(1,"rgba(0,0,0,0)");break;case"up":v=w.createLinearGradient(0,0,0,T),v.addColorStop(0,"rgba(0,0,0,0)"),v.addColorStop(1,"rgba(0,0,0,1)");break;case"down":v=w.createLinearGradient(0,0,0,T),v.addColorStop(0,"rgba(0,0,0,1)"),v.addColorStop(1,"rgba(0,0,0,0)");break}v&&(w.globalCompositeOperation="destination-in",w.fillStyle=v,w.fillRect(0,0,b,T))}}A.ctx.drawImage(A.shade_canvases[g],Math.round(n*x.TILESIZE),Math.round(c*x.TILESIZE),Math.round(l*x.TILESIZE),Math.round(d*x.TILESIZE)),A.ctx.restore()}),r(A,"drawTile",(e,t,i,s,a,n,c,l,d="black",u=0,h)=>{A.drawHelper(A.tileset,e,t,i,s,a,n,c,l,d,u,!1,h)}),r(A,"drawObj",(e,t,i,s,a,n,c,l,d="black",u=0,h)=>{A.drawHelper(A.objset,e,t,i,s,a,n,c,l,d,u,!0,h)}),r(A,"drawMob",(e,t,i,s,a,n,c,l,d="black",u=0,h)=>{A.drawHelper(A.mobset,e,t,i,s,a,n,c,l,d,u,!0,h)}),r(A,"drawItem",(e,t,i,s,a,n,c,l,d="black",u=0,h)=>{A.drawHelper(A.itemset,e,t,i,s,a,n,c,l,d,u,!0,h)}),r(A,"drawFX",(e,t,i,s,a,n,c,l,d="black",u=0,h)=>{A.drawHelper(A.fxset,e,t,i,s,a,n,c,l,d,u,!0,h)});let m=A,Ed=new m,zi=new Hn;export{mn as ChatMessage,E as Direction,m as Game,Qt as LevelState,Ed as game,zi as gs};
