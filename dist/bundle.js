/*! For license information please see bundle.js.LICENSE.txt */
(()=>{var t={32:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Chest=void 0;const s=i(7851),o=i(606),a=i(606),r=i(9467),n=i(7366);class h extends o.Entity{constructor(t,e,i,o){super(t,e,i,o),this.interact=t=>{if(3===this.health&&!this.opening)return this.health-=1,void this.open();if(2!==this.health)return;const e=this.drops.find(e=>(e.onPickup(t),e.pickedUp));e&&(this.drops=this.drops.filter(t=>t!==e));const i=t.inventory.isFull();(0===this.drops.length||i)&&(this.health-=1,this.destroyable=!0)},this.uniqueKillBehavior=()=>{this.cloned||3===this.health&&this.open()},this.open=()=>{this.tileX=0,this.tileY=2,this.opening=!0,n.Sound.chest(),null===this.drop&&this.getDrop(["consumable","gem","coin","tool","light","weapon","shield"],!0),this.drops.forEach(t=>{if("coin"===t.name){let e=s.Game.randTable([1,2,2,2,3,3,3,3,3,4,4,4,4,4,5,5,5,5,5,6,6,6,6,6,7,7,7,7,7,8,8,8,8,9,9,9,10,10,11,12,13,14,15,100],r.Random.rand);r.Random.rand()<.01&&(e*=Math.ceil(10*r.Random.rand())),t.stackCount=e}}),this.dropLoot(),this.drops.forEach(t=>{t.animateFromChest()})},this.draw=t=>{this.dead||(s.Game.ctx.save(),s.Game.ctx.globalAlpha=this.alpha,this.opening&&(this.tileX<=6?this.tileX+=.15*t:this.opening=!1),this.dead||(this.updateDrawXY(t),this.hasShadow&&this.drawShadow(t),s.Game.drawObj(Math.floor(this.tileX),Math.floor(this.tileY),1,2,this.x-this.drawX,this.y-this.drawYOffset-this.drawY,1,2,this.room.shadeColor,this.shadeAmount())),s.Game.ctx.restore())},this.drawTopLayer=t=>{this.drawableY=this.y-1},this.tileX=4,this.tileY=0,this.health=3,this.name="chest",this.frame=0,this.opening=!1,this.dropX=0,this.dropY=0,this.drop=null,this.destroyable=!1,this.pushable=!1,this.chainPushable=!1,this.interactable=!0,this.imageParticleX=3,this.imageParticleY=26}get type(){return a.EntityType.CHEST}}e.Chest=h},66:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Lantern=void 0;const s=i(1650),o=i(1199);class a extends s.Light{constructor(t,e,i){super(t,e,i),this.getDescription=()=>`LANTERN - Fuel: ${Math.round(this.fuel/this.fuelCap*100)}%, Capacity: ${this.fuelCap/50}`,this.tryAutoRefuel=()=>{if(!this.wielder||!this.canRefuel)return!1;const t=this.wielder.inventory,e=t?.hasItem?.(o.Coal);if(!(e instanceof o.Coal))return!1;const i=Math.max(0,this.fuelCap-this.fuel);if(i<=0)return!1;const s=Math.max(0,e.stackCount),a=Math.ceil(i/25),r=Math.min(s,a);if(r<=0)return!1;const n=25*r;return this.fuel=Math.min(this.fuel+n,this.fuelCap),e.stackCount-=r,e.stackCount<=0&&t.removeItem(e),this.broken=this.fuel<=0,this.wielder.game.pushMessage(`You refuel your lantern with ${r} coal.`),!0},this.fuel=250,this.tileX=29,this.tileY=0,this.fuelCap=250,this.name="lantern",this.canRefuel=!0,this.maxBrightness=7,this.minBrightness=3,this.radius=10,this.falloffDecay=.6,this.broken=this.fuel<=0}}e.Lantern=a,a.itemName="lantern"},75:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.HealthBar=void 0;const s=i(7851),o=i(1285);e.HealthBar=class{constructor(){this.hurt=()=>{this.hurtTimer=Date.now()},this.draw=(t,e,i,a,r,n)=>{let h=Math.min(o.LevelConstants.HEALTH_BAR_TOTALTIME,Math.max(Date.now()-this.hurtTimer,0));if(h<=o.LevelConstants.HEALTH_BAR_TOTALTIME){let t=Math.floor(e),l=Math.ceil(e-t),c=Math.round(Math.min(9,Math.min(.05*(o.LevelConstants.HEALTH_BAR_TOTALTIME-h),.05*h))),d=Math.round(16*Math.min(.5,Math.min(.003*(o.LevelConstants.HEALTH_BAR_TOTALTIME-h),.003*h)))/16,m=.5+-(c*(i-1)+8)/16/2;for(let e=0;e<Math.ceil(.5*i);e++){let o=0;o=n?e<t?0:e<t+l?.5:1:1.5;let h=c*e/16+m;s.Game.drawFX(o,8,.5,.5,a+h,r-1-d/2,.5,d),h+=9/16;let u=i-e-1;if(u!==e){let e=0;e=n?u<t?0:u<t+l?.5:1:1.5;let i=c*u/16+m;s.Game.drawFX(e,8,.5,.5,a+i,r-1-d/2,.5,d),i+=9/16}}}},this.hurtTimer=0}}},126:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Spawner=void 0;const s=i(7851),o=i(3384),a=i(369),r=i(7975),n=i(8330),h=i(5097),l=i(6986),c=i(9467),d=i(5339),m=i(3180),u=i(3005),p=i(8200),y=i(9982),g=i(9357),f=i(675),w=i(7716),E=i(4159),x=i(6598),b=i(492),T=i(6493),I=i(3175),S=i(8287),v=i(9997),A=i(1429),M=i(1040),C=i(8363),D=i(5016),O=i(9200),_=i(3691),R=i(3779),G=i(721);class P extends l.Enemy{constructor(t,e,i,l,L=[1,2,3,4,5,6,7,8,9,11,12,14,15,16,17,18,20,22,23]){super(t,e,i,l),this.hit=()=>1,this.setSpawnFrequency=(t=1)=>{S.GameplaySettings.UNLIMITED_SPAWNERS?this.spawnFrequency=4:this.spawnFrequency=Math.min(12,4*this.room.currentSpawnerCount),S.GameplaySettings.THROTTLE_SPAWNERS&&(this.spawnFrequency=3+t);const e=this.room.entities.filter(t=>t instanceof P);this.spawnOffset=4*(e.indexOf(this)+1)},this.bleed=()=>{},this.poison=()=>{},this.behavior=()=>{if(this.lastX=this.x,this.lastY=this.y,!this.dead){if(this.handleSkipTurns())return;if(this.tileX=6,(this.ticks+this.spawnOffset)%this.spawnFrequency===0&&this.ticks>=this.nextSpawnTick){let t=this.room.getEmptyTiles().filter(t=>Math.abs(t.x-this.x)<=1&&Math.abs(t.y-this.y)<=1);if(8===this.enemySpawnType){const e=[{x:this.x,y:this.y},{x:this.x+1,y:this.y+1},{x:this.x-1,y:this.y-1},{x:this.x+1,y:this.y-1},{x:this.x-1,y:this.y+1}];t=t.filter(t=>!e.some(e=>e.x===t.x&&e.y===t.y))}if(t.length>0){this.tileX=7;const e=s.Game.randTable(t,c.Random.rand);let i;const o=this.mutatePositionForBigEnemy(e.x,e.y);switch(this.enemySpawnType){case 0:case 18:i=new M.PawnEnemy(this.room,this.game,e.x,e.y);break;case 1:i=new p.CrabEnemy(this.room,this.game,e.x,e.y);break;case 2:i=new w.FrogEnemy(this.room,this.game,e.x,e.y);break;case 3:i=new m.ZombieEnemy(this.room,this.game,e.x,e.y);break;case 4:i=new r.SkullEnemy(this.room,this.game,e.x,e.y);break;case 5:i=new d.EnergyWizardEnemy(this.room,this.game,e.x,e.y);break;case 6:i=new y.ChargeEnemy(this.room,this.game,e.x,e.y);break;case 7:i=new T.RookEnemy(this.room,this.game,e.x,e.y);break;case 8:i=new u.BishopEnemy(this.room,this.game,e.x,e.y);break;case 9:i=new b.ArmoredzombieEnemy(this.room,this.game,e.x,e.y);break;case 10:i=new f.BigSkullEnemy(this.room,this.game,o.x,o.y),this.clearSpaceForBigEnemy(o.x,o.y);break;case 11:i=new x.QueenEnemy(this.room,this.game,e.x,e.y);break;case 12:i=new h.KnightEnemy(this.room,this.game,e.x,e.y);break;case 13:i=new g.BigKnightEnemy(this.room,this.game,o.x,o.y),this.clearSpaceForBigEnemy(o.x,o.y);break;case 14:i=new E.FireWizardEnemy(this.room,this.game,e.x,e.y);break;case 15:i=new I.ArmoredSkullEnemy(this.room,this.game,e.x,e.y);break;case 16:i=new A.MummyEnemy(this.room,this.game,e.x,e.y);break;case 17:i=new v.SpiderEnemy(this.room,this.game,e.x,e.y);break;case 19:i=new D.BigFrogEnemy(this.room,this.game,o.x,o.y),this.clearSpaceForBigEnemy(o.x,o.y);break;case 20:i=new C.BeetleEnemy(this.room,this.game,e.x,e.y);break;case 21:i=new _.KingEnemy(this.room,this.game,e.x,e.y);break;case 22:i=new R.BoltcasterEnemy(this.room,this.game,e.x,e.y);break;case 23:i=new G.EarthWizardEnemy(this.room,this.game,e.x,e.y);break;default:console.warn("spawner tried to spawn unknown enemy type",this.enemySpawnType),i=new m.ZombieEnemy(this.room,this.game,e.x,e.y)}this.setSpawnFrequency(i?.maxHealth??1),this.nextSpawnTick=this.ticks+this.spawnFrequency,this.room.projectiles.push(new n.EnemySpawnAnimation(this.room,i,e.x,e.y)),this.room.hitwarnings.push(new a.HitWarning(this.game,e.x,e.y,this.x,this.y))}}this.ticks++}},this.mutatePositionForBigEnemy=(t,e)=>{const i=[{x:t,y:e},{x:t+1,y:e},{x:t,y:e+1},{x:t+1,y:e+1}];if(!i.some(t=>this.room.roomArray[t.x]?.[t.y]instanceof O.Wall))return{x:t,y:e};let s=t,o=e;const a=this.room.roomX,r=this.room.roomX+this.room.width-1,n=this.room.roomY,h=this.room.roomY+this.room.height-1,l=i.some(t=>{const e=this.room.roomArray[t.x]?.[t.y];return t.x===a||e instanceof O.Wall&&!0===e.wallInfo?.()?.isLeftWall}),c=i.some(t=>{const e=this.room.roomArray[t.x]?.[t.y];return t.x===r||e instanceof O.Wall&&!0===e.wallInfo?.()?.isRightWall}),d=i.some(t=>{const e=this.room.roomArray[t.x]?.[t.y];return t.y===n||e instanceof O.Wall&&!0===e.wallInfo?.()?.isTopWall}),m=i.some(t=>{const e=this.room.roomArray[t.x]?.[t.y];return t.y===h||e instanceof O.Wall&&!0===e.wallInfo?.()?.isBottomWall});l&&(s=Math.min(t+1,r-1)),c&&(s=Math.max(t-1,a+1)),d&&(o=Math.min(e+1,h-1)),m&&(o=Math.max(e-1,n+1)),s=Math.max(s,a),s=Math.min(s,r-1),o=Math.max(o,n),o=Math.min(o,h-1);const u=this.room.roomArray[s]?.[o];return u&&!0===u.isSolid?.()?{x:t,y:e}:{x:s,y:o}},this.clearSpaceForBigEnemy=(t,e)=>{for(let i=0;i<2;i++)for(let s=0;s<2;s++){let a=this.room.roomArray[t+i][e+s];if(a instanceof O.Wall){const r=a.wallInfo();r?.isInnerWall&&(this.room.roomArray[t+i][e+s]=new o.Floor(this.room,t+i,e+s))}}},this.uniqueKillBehavior=()=>{this.room.currentSpawnerCount--},this.draw=t=>{s.Game.ctx.save(),s.Game.ctx.globalAlpha=this.alpha,this.dead||(this.updateDrawXY(t),this.frame+=.1*t,this.frame>=4&&(this.frame=0),this.hasShadow&&this.drawShadow(t),s.Game.drawMob(this.tileX,this.tileY,1,2,this.x-this.drawX,this.y-this.drawYOffset-this.drawY,1,2,this.softShadeColor,this.shadeAmount(),void 0,this.outlineColor(),this.outlineOpacity())),this.dying||(this.seenPlayer||this.drawSleepingZs(t),this.alertTicks>0&&this.drawExclamation(t)),s.Game.ctx.restore()},this.ticks=0,this.health=4,this.maxHealth=4,this.defaultMaxHealth=4,this.tileX=6,this.tileY=4,this.seenPlayer=!0,this.spawnFrequency=4,this.room.currentSpawnerCount++,this.enemyTable=L;const k=s.Game.randTable(this.enemyTable,c.Random.rand);this.enemySpawnType=k,this.spawnOffset=0,this.nextSpawnTick=0,this.dropChance=1,this.chainPushable=!1,this.destroyableByOthers=!1,this.getDrop(["reaper"],!1),this.name="reaper",console.log("spawner created spawner type",this.enemySpawnType)}}e.Spawner=P,P.tileX=6,P.tileY=4},232:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Map=void 0;const s=i(7851),o=i(6291),a=i(8287),r=i(4118),n=i(606);e.Map=class{constructor(t,e){this.mapData=[],this.oldMapData=[],this.offsetX=0,this.offsetY=0,this.softOffsetX=0,this.softOffsetY=0,this.bufferCanvas=null,this.bufferCtx=null,this.mapOpen=!1,this.mapOpenProgress=0,this.mapAnimationSpeed=.18,this.suppressPerRoomFog=!1,this.framePlayerX=0,this.framePlayerY=0,this.effectiveRadius=0,this.effectiveRadiusSq=0,this.currentSeenTiles=null,this.frameDiscoveredBounds=null,this.frameMaskMinX=0,this.frameMaskMaxX=0,this.frameMaskMinY=0,this.frameMaskMaxY=0,this.seenTilesByMapGroup=new globalThis.Map,this.visibilityRadius=4,this.drawRadius=25,this.getDownLaddersFromRoom=t=>{const e=[];if(t.roomArray)for(let i=t.roomX;i<t.roomX+t.width;i++)for(let s=t.roomY;s<t.roomY+t.height;s++)if(t.roomArray[i]&&t.roomArray[i][s]){const o=t.roomArray[i][s];o&&o.constructor&&"DownLadder"===o.constructor.name&&e.push(o)}return e},this.saveMapData=()=>{this.clearMap();const t=this.game.room.mapGroup.toString();for(const e of this.game.levels[this.player.depth].rooms)t!==e.mapGroup.toString()||!0!==e.entered&&!o.GameConstants.DEVELOPER_MODE||this.mapData.push({room:e,walls:e.innerWalls,doors:e.doors,entities:e.entities,items:e.items,players:this.game.players,downLadders:this.getDownLaddersFromRoom(e),seenTiles:this.seenTilesByMapGroup.get(t)||new Set});const e=this.mapData.map(t=>t.room).filter(t=>t.entered);if(e.length>0){const t=[...e].sort((t,e)=>t.roomX-e.roomX),i=[...e].sort((t,e)=>t.roomY-e.roomY),s=t[t.length-1].roomX,o=i[0].roomY;this.offsetX=s,this.offsetY=o}else this.offsetX=0,this.offsetY=0},this.clearMap=()=>{this.mapData=[]},this.saveOldMap=()=>{this.oldMapData=[...this.mapData]},this.renderMap=t=>{if(this.updateMapAnimation(t),this.prepareFrameCaches(),this.mapOpen){const e=this.easeInOut(this.mapOpenProgress);s.Game.ctx.save(),this.drawBackdrop(e),s.Game.ctx.restore(),s.Game.ctx.save(),this.setInitialCanvasSettings(1);const i=this.scale;this.scale=1+e,this.translateCanvas(0);for(const e of this.mapData)this.drawRoom(e,t);this.resetCanvasTransform(),this.scale=i,s.Game.ctx.restore()}else if(this.mapOpenProgress>0){const e=this.easeInOut(this.mapOpenProgress);if(this.ensureBufferCanvas(),!this.bufferCanvas||!this.bufferCtx)return;const i=s.Game.ctx,o=this.scale;this.bufferCtx.save(),this.bufferCtx.setTransform(1,0,0,1,0,0),this.bufferCtx.clearRect(0,0,this.bufferCanvas.width,this.bufferCanvas.height),this.bufferCtx.imageSmoothingEnabled=!1,s.Game.ctx=this.bufferCtx,this.setInitialCanvasSettings(1),this.scale=1+e,this.translateCanvas(0),this.suppressPerRoomFog=!0;for(const e of this.mapData)this.drawRoom(e,t);this.applyFogOfWarAllRooms(),this.suppressPerRoomFog=!1,this.resetCanvasTransform(),this.scale=o,this.bufferCtx.restore(),s.Game.ctx=i,s.Game.ctx.save(),s.Game.ctx.globalCompositeOperation="source-over",s.Game.ctx.imageSmoothingEnabled=!1,s.Game.ctx.drawImage(this.bufferCanvas,0,0),s.Game.ctx.restore()}else if(a.GameplaySettings.LEGACY_MINIMAP){if(this.ensureBufferCanvas(),!this.bufferCanvas||!this.bufferCtx)return;const e=s.Game.ctx;this.bufferCtx.save(),this.bufferCtx.setTransform(1,0,0,1,0,0),this.bufferCtx.clearRect(0,0,this.bufferCanvas.width,this.bufferCanvas.height),this.bufferCtx.imageSmoothingEnabled=!1,s.Game.ctx=this.bufferCtx,this.setInitialCanvasSettings(1),this.translateCanvas(0);for(const e of this.mapData)this.drawRoom(e,t);this.resetCanvasTransform(),this.bufferCtx.globalCompositeOperation="destination-in";const i=50,a=50,r=o.GameConstants.WIDTH-i,n=0;this.bufferCtx.fillStyle="rgba(0,0,0,1)",this.bufferCtx.fillRect(r,n,i,a),this.bufferCtx.globalCompositeOperation="source-over",this.bufferCtx.restore(),s.Game.ctx=e,s.Game.ctx.save(),s.Game.ctx.globalCompositeOperation="source-over",s.Game.ctx.imageSmoothingEnabled=!1,s.Game.ctx.drawImage(this.bufferCanvas,0,0),s.Game.ctx.restore()}else{if(this.ensureBufferCanvas(),!this.bufferCanvas||!this.bufferCtx)return;const e=s.Game.ctx;this.scale,this.bufferCtx.save(),this.bufferCtx.setTransform(1,0,0,1,0,0),this.bufferCtx.clearRect(0,0,this.bufferCanvas.width,this.bufferCanvas.height),this.bufferCtx.imageSmoothingEnabled=!1,s.Game.ctx=this.bufferCtx,this.setInitialCanvasSettings(1),this.translateCanvas(0),this.suppressPerRoomFog=!0;for(const e of this.mapData)this.drawRoom(e,t);this.applyFogOfWarAllRooms(),this.suppressPerRoomFog=!1,this.resetCanvasTransform(),this.bufferCtx.restore(),s.Game.ctx=e,s.Game.ctx.save(),s.Game.ctx.globalCompositeOperation="source-over",s.Game.ctx.imageSmoothingEnabled=!1,s.Game.ctx.drawImage(this.bufferCanvas,0,0),s.Game.ctx.restore()}},this.prepareFrameCaches=()=>{this.framePlayerX=Math.floor(this.player.x),this.framePlayerY=Math.floor(this.player.y),this.effectiveRadius=this.getEffectiveDrawRadius(),this.effectiveRadiusSq=this.effectiveRadius*this.effectiveRadius;const t=this.game.room.mapGroup.toString();let e=this.seenTilesByMapGroup.get(t);this.mapData.length>0&&this.mapData[0].seenTiles&&(e=this.mapData[0].seenTiles),this.currentSeenTiles=e??null;const i=this.getDiscoveredBounds();if(this.frameDiscoveredBounds={centerX:i.centerX,centerY:i.centerY},a.GameplaySettings.LEGACY_MINIMAP||this.mapOpen||0!==this.mapOpenProgress)this.frameMaskMinX=Number.NEGATIVE_INFINITY,this.frameMaskMaxX=Number.POSITIVE_INFINITY,this.frameMaskMinY=Number.NEGATIVE_INFINITY,this.frameMaskMaxY=Number.POSITIVE_INFINITY;else{const t=this.scale||1,e=50,i=50,s=o.GameConstants.WIDTH-e,a=0,r=s+Math.floor(e/2),n=a+Math.floor(i/2),h=Math.floor(this.player.x+(s-r)/t),l=Math.floor(this.player.x+(s+e-1-r)/t),c=Math.floor(this.player.y+(a-n)/t),d=Math.floor(this.player.y+(a+i-1-n)/t);this.frameMaskMinX=Math.min(h,l),this.frameMaskMaxX=Math.max(h,l),this.frameMaskMinY=Math.min(c,d),this.frameMaskMaxY=Math.max(c,d)}},this.ensureBufferCanvas=()=>{const t=o.GameConstants.WIDTH,e=o.GameConstants.HEIGHT;this.bufferCanvas?this.bufferCanvas.width===t&&this.bufferCanvas.height===e||(this.bufferCanvas.width=t,this.bufferCanvas.height=e,this.bufferCtx=this.bufferCanvas.getContext("2d",{alpha:!0})):(this.bufferCanvas=document.createElement("canvas"),this.bufferCanvas.width=t,this.bufferCanvas.height=e,this.bufferCtx=this.bufferCanvas.getContext("2d",{alpha:!0}))},this.toggleMapOpen=()=>{const t=!this.mapOpen;t&&!0===this.player?.inventory?.isOpen||(this.mapOpen=t,t&&this.saveMapData())},this.getSeenTilesForCurrentGroup=()=>{const t=this.game.room.mapGroup.toString();let e=this.seenTilesByMapGroup.get(t);return this.mapData.length>0&&this.mapData[0].seenTiles&&(e=this.mapData[0].seenTiles),e??new Set},this.getDiscoveredBounds=()=>{const t=this.getSeenTilesForCurrentGroup();if(0===t.size){const t=Math.floor(this.player.x),e=Math.floor(this.player.y);return{minX:t,minY:e,maxX:t,maxY:e,width:1,height:1,centerX:t,centerY:e}}let e=1/0,i=1/0,s=-1/0,o=-1/0;for(const a of t){const[t,r]=a.split(",").map(t=>parseInt(t,10));t<e&&(e=t),r<i&&(i=r),t>s&&(s=t),r>o&&(o=r)}const a=Math.max(1,s-e+1),r=Math.max(1,o-i+1);return{minX:e,minY:i,maxX:s,maxY:o,width:a,height:r,centerX:Math.floor(e+a/2),centerY:Math.floor(i+r/2)}},this.computeFullMapScale=t=>{const e=Math.floor(.9*o.GameConstants.WIDTH),i=Math.floor(.9*o.GameConstants.HEIGHT),s=Math.floor(e/Math.max(1,t.width)),a=Math.floor(i/Math.max(1,t.height));return Math.max(1,Math.min(s,a))},this.updateOffsetXY=()=>{let t=this.offsetX-this.softOffsetX,e=this.offsetY-this.softOffsetY;Math.abs(t)>.01?(this.softOffsetX+=.1*t,this.softOffsetX=this.softOffsetX):this.softOffsetX=this.offsetX,Math.abs(e)>.01?(this.softOffsetY+=.1*e,this.softOffsetY=this.softOffsetY):this.softOffsetY=this.offsetY},this.updateSeenTiles=()=>{const t=Math.floor(this.player.x),e=Math.floor(this.player.y),i=this.game.room.mapGroup.toString();this.seenTilesByMapGroup.has(i)||this.seenTilesByMapGroup.set(i,new Set);const s=this.seenTilesByMapGroup.get(i);for(let i=-this.visibilityRadius;i<=this.visibilityRadius;i++)for(let o=-this.visibilityRadius;o<=this.visibilityRadius;o++)if(Math.sqrt(i*i+o*o)<=this.visibilityRadius){const a=`${t+i},${e+o}`;s.add(a)}},this.isTileSeen=(t,e)=>{if(!this.currentSeenTiles)return!1;const i=`${Math.floor(t)},${Math.floor(e)}`;return this.currentSeenTiles.has(i)},this.draw=t=>{(o.GameConstants.MAP_ENABLED||this.mapOpen||0!==this.mapOpenProgress)&&(this.updateSeenTiles(),this.updateOffsetXY(),this.renderMap(t))},this.setInitialCanvasSettings=t=>{s.Game.ctx.globalAlpha=t,s.Game.ctx.globalCompositeOperation="source-over"},this.translateCanvas=t=>{const e=this.scale;if(this.mapOpen||this.mapOpenProgress>0){const i=this.easeInOut(this.mapOpenProgress),a=Math.floor(5/6*o.GameConstants.WIDTH),r=Math.floor(1/6*o.GameConstants.HEIGHT),n=Math.floor(o.GameConstants.WIDTH/2),h=Math.floor(o.GameConstants.HEIGHT/2),l=this.getDiscoveredBounds(),c=this.player.x,d=this.player.y,m=l.centerX,u=l.centerY,p=Math.floor(a+(n-a)*i),y=Math.floor(r+(h-r)*i),g=c+(m-c)*i,f=d+(u-d)*i;s.Game.ctx.translate(p-Math.floor(g*e),y-Math.floor(f*e)-t)}else if(a.GameplaySettings.LEGACY_MINIMAP)s.Game.ctx.translate(Math.floor(.95*o.GameConstants.WIDTH)-15*e-Math.floor(this.softOffsetX),Math.floor(.05*o.GameConstants.HEIGHT)-1*e-t-Math.floor(this.softOffsetY));else{const i=Math.floor(5/6*o.GameConstants.WIDTH),a=Math.floor(1/6*o.GameConstants.HEIGHT);s.Game.ctx.translate(i-Math.floor(this.player.x*e),a-Math.floor(this.player.y*e)-t)}},this.drawBackdrop=t=>{const e=.25*Math.max(0,Math.min(1,t));e<=.001||(s.Game.ctx.save(),s.Game.ctx.globalCompositeOperation="source-over",s.Game.ctx.globalAlpha=e,s.Game.ctx.fillStyle="#808080",s.Game.ctx.fillRect(0,0,o.GameConstants.WIDTH,o.GameConstants.HEIGHT),s.Game.ctx.restore())},this.updateMapAnimation=t=>{const e=this.mapOpen?1:0,i=this.mapAnimationSpeed*(t||1);this.mapOpenProgress<e?this.mapOpenProgress=Math.min(1,this.mapOpenProgress+i):this.mapOpenProgress>e&&(this.mapOpenProgress=Math.max(0,this.mapOpenProgress-i))},this.easeInOut=t=>t<.5?2*t*t:1-Math.pow(-2*t+2,2)/2,this.drawRoom=(t,e)=>{a.GameplaySettings.LEGACY_MINIMAP&&this.drawRoomOutline(t.room),a.GameplaySettings.LEGACY_MINIMAP||this.drawRoomFloorTiles(t.room),this.drawRoomWalls(t.walls),this.drawRoomDoors(t.doors),this.drawRoomEntities(t.entities),this.drawRoomItems(t.items),this.drawRoomPlayers(t.players,e),this.drawRoomDownLadders(t.downLadders),this.suppressPerRoomFog||this.drawFogOfWar(t.room)},this.applyFogOfWarAllRooms=()=>{if(this.mapOpen)return;const t=this.scale,e=this.game.room.mapGroup.toString();let i=this.seenTilesByMapGroup.get(e);this.mapData.length>0&&this.mapData[0].seenTiles&&(i=this.mapData[0].seenTiles),s.Game.ctx.save(),s.Game.ctx.globalCompositeOperation=a.GameplaySettings.LEGACY_MINIMAP?"source-over":"destination-out",s.Game.ctx.fillStyle=a.GameplaySettings.LEGACY_MINIMAP?"#1a1a1a":"rgba(0,0,0,1)";for(const e of this.mapData){const o=e.room;for(let e=o.roomX;e<o.roomX+o.width;e++)for(let r=o.roomY;r<o.roomY+o.height;r++){if(a.GameplaySettings.LEGACY_MINIMAP||0!==this.mapOpenProgress){if(!a.GameplaySettings.LEGACY_MINIMAP&&!this.isWithinDrawRadius(e,r))continue}else{const t=Math.floor(e),i=Math.floor(r);if(t<this.frameMaskMinX||t>this.frameMaskMaxX||i<this.frameMaskMinY||i>this.frameMaskMaxY)continue}const o=`${Math.floor(e)},${Math.floor(r)}`;i&&i.has(o)||s.Game.ctx.fillRect(e*t,r*t,1*t,1*t)}}s.Game.ctx.restore()},this.drawRoomFloorTiles=t=>{const e=this.scale;s.Game.ctx.save();const i=Math.max(t.roomX,Math.min(this.framePlayerX-this.effectiveRadius,this.frameMaskMinX)),o=Math.min(t.roomX+t.width-1,Math.max(this.framePlayerX+this.effectiveRadius,this.frameMaskMaxX)),a=Math.max(t.roomY,Math.min(this.framePlayerY-this.effectiveRadius,this.frameMaskMinY)),r=Math.min(t.roomY+t.height-1,Math.max(this.framePlayerY+this.effectiveRadius,this.frameMaskMaxY));for(let n=i;n<=o;n++)for(let i=a;i<=r;i++)if(this.shouldDrawTile(n,i)){const o=n===t.roomX||n===t.roomX+t.width-1||i===t.roomY||i===t.roomY+t.height-1;s.Game.ctx.fillStyle=o?"#5A5A5A":"#0a0a0a",s.Game.ctx.fillRect(n*e,i*e,1*e,1*e)}s.Game.ctx.restore()},this.getEffectiveDrawRadius=()=>{const t=this.easeInOut?.(this.mapOpenProgress??0)??0;return Math.floor(this.drawRadius+(1e4-this.drawRadius)*t)},this.isWithinDrawRadius=(t,e)=>{if(!a.GameplaySettings.LEGACY_MINIMAP&&!this.mapOpen&&0===this.mapOpenProgress){const i=Math.floor(t),s=Math.floor(e);return i>=this.frameMaskMinX&&i<=this.frameMaskMaxX&&s>=this.frameMaskMinY&&s<=this.frameMaskMaxY}const i=Math.floor(t)-this.framePlayerX,s=Math.floor(e)-this.framePlayerY;return i*i+s*s<=this.effectiveRadiusSq},this.shouldDrawTile=(t,e)=>!!a.GameplaySettings.LEGACY_MINIMAP||!!this.isWithinDrawRadius(t,e)&&(!this.mapOpen||this.isTileSeen(t,e)),this.drawFogOfWar=t=>{if(this.mapOpen)return;const e=this.scale,i=this.game.room.mapGroup.toString();let o=this.seenTilesByMapGroup.get(i);if(this.mapData.length>0&&this.mapData[0].seenTiles&&(o=this.mapData[0].seenTiles),a.GameplaySettings.LEGACY_MINIMAP){s.Game.ctx.save(),s.Game.ctx.globalCompositeOperation="source-over",s.Game.ctx.fillStyle="#1a1a1a";for(let i=t.roomX;i<t.roomX+t.width;i++)for(let a=t.roomY;a<t.roomY+t.height;a++){const t=`${Math.floor(i)},${Math.floor(a)}`;o&&o.has(t)||s.Game.ctx.fillRect(i*e,a*e,1*e,1*e)}s.Game.ctx.restore()}else{s.Game.ctx.save(),s.Game.ctx.globalCompositeOperation="destination-out",s.Game.ctx.fillStyle="rgba(0,0,0,1)";for(let i=t.roomX;i<t.roomX+t.width;i++)for(let a=t.roomY;a<t.roomY+t.height;a++){if(!this.isWithinDrawRadius(i,a))continue;const t=`${Math.floor(i)},${Math.floor(a)}`;o&&o.has(t)||s.Game.ctx.fillRect(i*e,a*e,1*e,1*e)}s.Game.ctx.restore()}},this.getMinimapAnchor=()=>{const t=this.scale;return a.GameplaySettings.LEGACY_MINIMAP?{x:Math.floor(.95*o.GameConstants.WIDTH),y:Math.floor(.05*o.GameConstants.HEIGHT),radiusPx:this.drawRadius*t}:{x:Math.floor(5/6*o.GameConstants.WIDTH),y:Math.floor(1/6*o.GameConstants.HEIGHT),radiusPx:this.drawRadius*t}},this.isPointInMinimapBounds=(t,e)=>{if(this.mapOpen)return!1;const{x:i,y:s,radiusPx:o}=this.getMinimapAnchor(),a=t-i,r=e-s;return a*a+r*r<=o*o},this.drawRoomOutline=t=>{const e=this.scale;s.Game.ctx.fillStyle="#5A5A5A",s.Game.ctx.fillRect(t.roomX*e+0,t.roomY*e+0,t.width*e-0,t.height*e-0),t.type===r.RoomType.UPLADDER&&(s.Game.ctx.fillStyle="#101460"),t.type===r.RoomType.DOWNLADDER&&(s.Game.ctx.fillStyle="#601410"),s.Game.ctx.fillStyle="black",s.Game.ctx.fillRect(t.roomX*e+1,t.roomY*e+1,t.width*e-2,t.height*e-2)},this.drawRoomWalls=t=>{const e=this.scale;s.Game.ctx.save();for(const i of t)this.shouldDrawTile(i.x,i.y)&&(s.Game.ctx.fillStyle="#404040",s.Game.ctx.fillRect(i.x*e,i.y*e,1*e,1*e));s.Game.ctx.restore()},this.drawRoomDoors=t=>{const e=this.scale;s.Game.ctx.save();for(const i of t)this.shouldDrawTile(i.x,i.y)&&(!1===i.opened&&(s.Game.ctx.fillStyle="#5A5A5A"),!0===i.opened&&(s.Game.ctx.fillStyle="black",s.Game.ctx.fillRect(i.x*e,i.y*e,1*e,1*e)),s.Game.ctx.fillStyle="#5A5A5A");s.Game.ctx.restore()},this.drawRoomPlayers=(t,e)=>{const i=this.scale;s.Game.ctx.save();for(const e in t)s.Game.ctx.fillStyle="white",this.game.levels[t[e].depth].rooms[t[e].levelID].mapGroup===this.game.room.mapGroup&&this.shouldDrawTile(t[e].x,t[e].y)&&s.Game.ctx.fillRect(t[e].x*i,t[e].y*i,1*i,1*i);s.Game.ctx.restore()},this.drawUnderRoomPlayers=(t,e)=>{const i=this.scale;s.Game.ctx.save();for(const e in t)this.game.rooms[t[e].levelID].mapGroup,this.game.room.mapGroup,Math.floor(Date.now()/300)%2&&(s.Game.ctx.fillStyle="#4D8C8C",s.Game.ctx.fillRect((t[e].x-1)*i,(t[e].y-1)*i,1*i,1*i),s.Game.ctx.fillRect(t[e].x*i,(t[e].y-1)*i,1*i,1*i),s.Game.ctx.fillRect((t[e].x+1)*i,(t[e].y-1)*i,1*i,1*i),s.Game.ctx.fillRect((t[e].x-1)*i,t[e].y*i,1*i,1*i),s.Game.ctx.fillRect((t[e].x+1)*i,t[e].y*i,1*i,1*i),s.Game.ctx.fillRect((t[e].x-1)*i,(t[e].y+1)*i,1*i,1*i),s.Game.ctx.fillRect(t[e].x*i,(t[e].y+1)*i,1*i,1*i),s.Game.ctx.fillRect((t[e].x+1)*i,(t[e].y+1)*i,1*i,1*i));s.Game.ctx.restore()},this.drawRoomEntities=t=>{const e=this.scale;s.Game.ctx.save();for(const i of t)this.shouldDrawTile(i.x,i.y)&&(this.setEntityColor(i),s.Game.ctx.fillRect(i.x*e,i.y*e,1*e,1*e));s.Game.ctx.restore()},this.drawRoomDownLadders=t=>{const e=this.scale;s.Game.ctx.save();for(const i of t)this.shouldDrawTile(i.x,i.y)&&(s.Game.ctx.fillStyle="#00FFFF",s.Game.ctx.fillRect(i.x*e,i.y*e,1*e,1*e));s.Game.ctx.restore()},this.setEntityColor=t=>{t.type===n.EntityType.ENEMY&&(s.Game.ctx.fillStyle="yellow"),t.type===n.EntityType.PROP&&(s.Game.ctx.fillStyle="#847e87"),t.type===n.EntityType.RESOURCE&&(s.Game.ctx.fillStyle="#5a595b"),t.type===n.EntityType.FRIENDLY&&(s.Game.ctx.fillStyle="cyan")},this.drawRoomItems=t=>{const e=this.scale;s.Game.ctx.save();for(const i of t){const t=i.x,o=i.y;this.shouldDrawTile(t,o)&&(s.Game.ctx.fillStyle="#ac3232",i.pickedUp||s.Game.ctx.fillRect(t*e,o*e,1*e,1*e))}s.Game.ctx.restore()},this.resetCanvasTransform=()=>{s.Game.ctx.setTransform(1,0,0,1,0,0)},this.game=t,this.scale=1,this.player=e}}},249:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Furnace=void 0;const s=i(606),o=i(7851),a=i(606),r=i(2103),n=i(5196);class h extends s.Entity{constructor(t,e,i,s){super(t,e,i,s),this.draw=t=>{this.dead||(o.Game.ctx.save(),o.Game.ctx.globalAlpha=this.alpha,this.dead||(this.hasShadow&&this.drawShadow(t),this.updateDrawXY(t),o.Game.drawObj(this.tileX,this.tileY,1,2,this.x-this.drawX,this.y-this.drawYOffset-this.drawY,1,2,this.room.shadeColor,this.shadeAmount())),o.Game.ctx.restore())},this.drawTopLayer=t=>{this.drawableY=this.y},this.room=t,this.health=1,this.tileX=2,this.tileY=4,this.hasShadow=!0,this.chainPushable=!1,this.name="furnace",this.drops.push(new n.Torch(this.room,this.x,this.y)),this.imageParticleX=0,this.imageParticleY=25,this.bloomColor="#FFA500",this.hasBloom=!0,this.bloomAlpha=1,this.softBloomAlpha=0,this.lightSource=new r.LightSource(this.x+.5,this.y+.5,7,[200,30,1],4),this.addLightSource(this.lightSource)}get type(){return a.EntityType.PROP}}e.Furnace=h},263:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.WizardEnemy=e.WizardState=void 0;const s=i(7851),o=i(7180),a=i(1367),r=i(9467),n=i(6986),h=i(2103);var l;!function(t){t[t.idle=0]="idle",t[t.attack=1]="attack",t[t.justAttacked=2]="justAttacked",t[t.teleport=3]="teleport"}(l=e.WizardState||(e.WizardState={}));class c extends n.Enemy{constructor(t,e,i,n,c){super(t,e,i,n),this.ATTACK_RADIUS=5,this.newLightSource=(t,e,i,s,o)=>{this.lightSource=new h.LightSource(t,e,i,s,o)},this.addLightSource=t=>{this.room.lightSources.push(t)},this.removeLightSource=t=>{this.room.lightSources=this.room.lightSources.filter(e=>e!==t)},this.hit=()=>1,this.withinAttackingRangeOfPlayer=()=>{let t=!1;for(const e in this.game.players)(this.x-this.game.players[e].x)**2+(this.y-this.game.players[e].y)**2<=this.ATTACK_RADIUS**2&&(t=!0);return t},this.shuffle=t=>{let e,i,s;for(s=t.length-1;s>0;s--)e=Math.floor(r.Random.rand()*(s+1)),i=t[s],t[s]=t[e],t[e]=i;return t},this.behavior=()=>{if(this.lastX=this.x,this.lastY=this.y,!this.dead){if(this.handleSkipTurns())return;if(this.seenPlayer){if(this.seenPlayer)switch(this.alertTicks=Math.max(0,this.alertTicks-1),this.state){case l.attack:const t=this.nearestPlayer();if(!1!==t){const[e,i]=t;this.calculateProjectileOffsets(i.x,i.y,10),this.attemptProjectilePlacement([{x:-1,y:0},{x:-2,y:0},{x:1,y:0},{x:2,y:0},{x:0,y:-1},{x:0,y:-2},{x:0,y:1},{x:0,y:2}],a.WizardFireball,!1)}this.state=l.justAttacked;break;case l.justAttacked:this.state=l.idle;break;case l.teleport:let e,i=this.x,n=this.y,h=1e5,c=this.shuffle(this.room.getEmptyTiles());c=c.filter(t=>!this.room.projectiles.some(e=>e.x===t.x&&e.y===t.y));let d=s.Game.randTable([2,2,3,3,3,3,3],r.Random.rand),m=[];for(const t in this.game.players)m.push(t);let u=s.Game.randTable(m,r.Random.rand);for(let t of c){let i=t,s=Math.abs(i.x-this.game.players[u].x)+Math.abs(i.y-this.game.players[u].y);Math.abs(s-d)<Math.abs(h-d)&&(h=s,e=i)}e&&(this.tryMove(e.x,e.y),this.drawX=this.x-i,this.drawY=this.y-n,this.frame=0,this.room.particles.push(new o.WizardTeleportParticle(i,n)),this.withinAttackingRangeOfPlayer()?this.state=l.attack:this.state=l.idle);break;case l.idle:this.state=l.teleport}}else this.lookForPlayer()}},this.draw=t=>{this.dead||(s.Game.ctx.save(),s.Game.ctx.globalAlpha=this.alpha,this.dead||(this.updateDrawXY(t),this.state===l.attack?this.tileX=7:this.tileX=6,this.hasShadow&&this.drawShadow(t),this.frame>=0?(s.Game.drawMob(Math.floor(this.frame)+6,2,1,2,this.x,this.y-1.5,1,2,this.softShadeColor,this.shadeAmount(),void 0,this.outlineColor(),this.outlineOpacity()),this.frame+=.2*t,this.frame>11&&(this.frame=-1)):s.Game.drawMob(this.tileX,this.tileY,1,2,this.x-this.drawX,this.y-1.3-this.drawY,1,2,this.softShadeColor,this.shadeAmount(),void 0,this.outlineColor(),this.outlineOpacity()),this.seenPlayer||this.drawSleepingZs(t),this.alertTicks>0&&this.drawExclamation(t)),s.Game.ctx.restore())},this.ticks=0,this.health=1,this.maxHealth=1,this.defaultMaxHealth=1,this.tileX=6,this.tileY=0,this.frame=0,this.state=l.attack,this.seenPlayer=!1,this.alertTicks=0,this.name="wizard bomber",c&&(this.drop=c),this.getDrop(["weapon","equipment","consumable","tool","coin"])}}e.WizardEnemy=c,c.difficulty=3,c.tileX=6,c.tileY=0},267:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.FallenPillar=void 0;const s=i(606),o=i(7851),a=i(606);class r extends s.Entity{constructor(t,e,i,s){super(t,e,i,s),this.draw=t=>{this.dead||(o.Game.ctx.save(),o.Game.ctx.globalAlpha=this.alpha,this.dead||(this.hasShadow&&this.drawShadow(t),this.updateDrawXY(t),o.Game.drawObj(this.tileX,this.tileY,2,1,this.x-this.drawX,this.y-this.drawYOffset-this.drawY+.75,2,1,this.room.shadeColor,this.shadeAmount())),o.Game.ctx.restore())},this.drawTopLayer=t=>{this.drawableY=this.y},this.room=t,this.health=1,this.tileX=0,this.tileY=6,this.hasShadow=!0,this.pushable=!1,this.w=2,this.name="fallen pillar",this.imageParticleX=3,this.imageParticleY=25,this.hasShadow=!1,this.chainPushable=!1}get type(){return a.EntityType.PROP}}e.FallenPillar=r},336:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.getDeviceInfo=void 0;const s=i(2109);e.getDeviceInfo=()=>{const t=new s.UAParser(navigator.userAgent).getResult(),{browser:e,device:i,os:o}=t;return{os:o,browser:e,device:i,orientation:screen.orientation.type}}},369:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.HitWarning=e.HitWarningDirection=void 0;const s=i(7851),o=i(8160),a=i(6199);var r;!function(t){t[t.North=0]="North",t[t.NorthEast=1]="NorthEast",t[t.East=2]="East",t[t.SouthEast=3]="SouthEast",t[t.South=4]="South",t[t.SouthWest=5]="SouthWest",t[t.West=6]="West",t[t.NorthWest=7]="NorthWest",t[t.Center=8]="Center"}(r=e.HitWarningDirection||(e.HitWarningDirection={}));class n extends o.Drawable{constructor(t,e,i,o,h,l,c=!1,d=null){super(),this.parent=null,this._pointerDir=null,this._pointerOffset=null,this.alpha=0,this.tickedForDeath=!1,this.tick=()=>{this.tickedForDeath&&(this.dead=!0),this.tickedForDeath=!0},this.removeOverlapping=()=>{for(const t of this.game.room.entities)if(t.x===this.x&&t.y===this.y&&!1===t.pushable){this.dead=!0;break}for(const t of this.game.room.doors)if(t.x===this.x&&t.y===this.y){this.dead=!0;break}},this.fadeHitwarnings=t=>{this.tickedForDeath?(this.alpha>0&&(this.alpha-=.03*t),this.alpha<0&&(this.alpha=0)):(this.alpha<1&&(this.alpha+=.03*t),this.alpha>1&&(this.alpha=1))},this.draw=t=>{this.fadeHitwarnings(t),Math.abs(this.x-this.game.players[this.game.localPlayerID].x)<=1&&Math.abs(this.y-this.game.players[this.game.localPlayerID].y)<=1&&(s.Game.ctx.globalAlpha=this.alpha,this.isEnemy&&a.Utils.distance(this.x,this.y,this.game.players[this.game.localPlayerID].x,this.game.players[this.game.localPlayerID].y)<=1&&s.Game.drawFX(this.tileX+Math.floor(n.frame),this.tileY,1,1,this.x+this.pointerOffset.x,this.y+this.pointerOffset.y-this.offsetY,1,1),s.Game.ctx.globalAlpha=1)},this.drawTopLayer=t=>{this.fadeHitwarnings(t),s.Game.ctx.globalAlpha=this.alpha,this.isEnemy&&this.getPointerDir()!==r.North&&s.Game.drawFX(this.tileX+Math.floor(n.frame),this.tileY+1,1,1,this.x+this.pointerOffset.x,this.y+this.pointerOffset.y-this.offsetY,1,1),a.Utils.distance(this.x,this.y,this.game.players[this.game.localPlayerID].x,this.game.players[this.game.localPlayerID].y)<=1&&(this.dirOnly||s.Game.drawFX(18+Math.floor(n.frame),6,1,1,this.x,this.y-this.offsetY+0,1,1)),s.Game.ctx.globalAlpha=1},this.x=e,this.y=i,this.dead=!1,this.game=t,this.parent=d,this.tileX=0,this.tileY=22,this.eX=o,this.eY=h,this.offsetY=.2,this.dirOnly=c,this.isEnemy=void 0===l||l,this.pointerOffset=this.getPointerOffset(),this.removeOverlapping()}getPointerDir(){if(null===this._pointerDir){const t=this.eX-this.x,e=this.eY-this.y;this._pointerDir=0===t&&0===e?r.Center:0===t?e<0?r.South:r.North:0===e?t<0?r.East:r.West:t<0?e<0?r.SouthEast:r.NorthEast:e<0?r.SouthWest:r.NorthWest,this.tileX=0+2*this._pointerDir}return this._pointerDir}getPointerOffset(){if(null===this._pointerOffset){const t={[r.North]:{x:0,y:.5},[r.South]:{x:0,y:-.6},[r.West]:{x:.6,y:0},[r.East]:{x:-.6,y:0},[r.NorthEast]:{x:-.5,y:.5},[r.NorthWest]:{x:.5,y:.5},[r.SouthEast]:{x:-.5,y:-.5},[r.SouthWest]:{x:.5,y:-.5},[r.Center]:{x:0,y:-.25}};this._pointerOffset=t[this.getPointerDir()]}return this._pointerOffset}}e.HitWarning=n,n.frame=0,n.updateFrame=t=>{n.frame+=.125*t,n.frame>=2&&(n.frame=0)}},423:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.SidePathManager=void 0;const s=i(2057),o=i(2147);e.SidePathManager=class{constructor(t){this.game=t}async generateFor(t){if(t.linkedRoom)return;const e=t.room.depth+(t.isSidePath?0:1),i=this.getDeterministicPathId(t);await this.game.levelgen.generate(this.game,e,t.isSidePath,e=>this.handleLinkedRoom(t,e),t.environment,!1,i,t.opts),o.statsTracker.recordSidePathEntered({depth:this.game.currentDepth,sidePath:t.linkedRoom.envType})}switchToPathBeforeTransition(t){t.isSidePath&&t.linkedRoom&&(this.game.currentPathId=t.linkedRoom.pathId||this.game.currentPathId||"main")}getDeterministicPathId(t){if(!t.isSidePath)return"main";const e=`sp:${this.game.currentPathId||"main"}:${t.room.depth}:${t.room.roomX},${t.room.roomY}:${t.x},${t.y}`,i=t.globalId||`${t.room.globalId}:${t.x},${t.y}`;return e||i||"main"}handleLinkedRoom(t,e){t.isSidePath&&this.handleSidePathRooms(e),t.linkedRoom=e,this.linkUpLadders(t)}handleSidePathRooms(t){const e=t.level,i=this.game.rooms.filter(e=>e.mapGroup===t.mapGroup),s=e.rooms.length;i.forEach((t,i)=>{t.id=s+i,e.rooms.push(t)})}linkUpLadders(t){if(t.linkedRoom)if(t.isSidePath){const e=t.linkedRoom.level,i=t.linkedRoom.mapGroup,o=e.rooms.filter(t=>t.mapGroup===i);for(const e of o)for(let i=e.roomX;i<e.roomX+e.width;i++)for(let o=e.roomY;o<e.roomY+e.height;o++){const a=e.roomArray[i]?.[o];a instanceof s.UpLadder&&(this.setUpLadderLink(t,a),t.entryUpLadderPos||e!==t.linkedRoom||(t.entryUpLadderPos={x:a.x,y:a.y}))}}else for(let e=t.linkedRoom.roomX;e<t.linkedRoom.roomX+t.linkedRoom.width;e++)for(let i=t.linkedRoom.roomY;i<t.linkedRoom.roomY+t.linkedRoom.height;i++){const o=t.linkedRoom.roomArray[e]?.[i];if(o instanceof s.UpLadder)return this.setUpLadderLink(t,o),void(t.entryUpLadderPos={x:o.x,y:o.y})}}setUpLadderLink(t,e){t.isSidePath?(e.linkedRoom=t.room,e.isRope=!0,e.exitDownLadderPos={x:t.x,y:t.y}):e.linkedRoom=this.game.levels[t.room.depth].exitRoom}}},492:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.ArmoredzombieEnemy=void 0;const s=i(7851),o=i(6986),a=i(7455);class r extends o.Enemy{constructor(t,e,i,o,r){super(t,e,i,o),this.hit=()=>this.damage,this.behavior=()=>{if(this.lastX=this.x,this.lastY=this.y,!this.dead){if(this.handleSkipTurns())return;if(this.ticks++,this.seenPlayer){if(this.seenPlayer){if(this.room.playerTicked===this.targetPlayer){this.alertTicks=Math.max(0,this.alertTicks-1);let t=this.x,e=this.y,i=Array();for(const t of this.room.entities)t!==this&&i.push({x:t.x,y:t.y});for(let t=this.x-1;t<=this.x+1;t++)for(let e=this.y-1;e<=this.y+1;e++)this.room.roomArray[t][e]instanceof a.SpikeTrap&&this.room.roomArray[t][e].on&&i.push({x:t,y:e});const o=this.searchPathLocalized(this.targetPlayer,i);if(o.length>0){let i=o[0].pos.x,a=o[0].pos.y,r=this.direction,n=this.targetPlayer;if(this.facePlayer(n),i>t?this.direction=s.Direction.RIGHT:i<t?this.direction=s.Direction.LEFT:a>e?this.direction=s.Direction.DOWN:a<e&&(this.direction=s.Direction.UP),r==this.direction){let o=!1;for(const t in this.game.players)this.game.rooms[this.game.players[t].levelID]===this.room&&this.game.players[t].x===i&&this.game.players[t].y===a&&r==this.direction&&(this.game.players[t].hurt(this.hit(),this.name),this.drawX=.5*(this.x-this.game.players[t].x),this.drawY=.5*(this.y-this.game.players[t].y),this.game.players[t]===this.game.players[this.game.localPlayerID]&&this.game.shakeScreen(10*this.drawX,10*this.drawY));o||(this.tryMove(i,a),this.setDrawXY(t,e),this.x>t?this.direction=s.Direction.RIGHT:this.x<t?this.direction=s.Direction.LEFT:this.y>e?this.direction=s.Direction.DOWN:this.y<e&&(this.direction=s.Direction.UP))}}this.direction==s.Direction.LEFT&&(i.push({x:this.x,y:this.y+1}),i.push({x:this.x,y:this.y-1})),this.direction==s.Direction.RIGHT&&(i.push({x:this.x,y:this.y+1}),i.push({x:this.x,y:this.y-1})),this.direction==s.Direction.DOWN&&(i.push({x:this.x+1,y:this.y}),i.push({x:this.x-1,y:this.y})),this.direction==s.Direction.UP&&(i.push({x:this.x+1,y:this.y}),i.push({x:this.x-1,y:this.y})),this.makeHitWarnings()}let t=-1!==Object.values(this.game.offlinePlayers).indexOf(this.targetPlayer);if(!this.aggro||t){let e=this.nearestPlayer();if(!1!==e){let[i,s]=e;i<=4&&(t||i<this.playerDistance(this.targetPlayer))&&s!==this.targetPlayer&&(this.targetPlayer=s,this.facePlayer(s),s===this.game.players[this.game.localPlayerID]&&(this.alertTicks=1),this.makeHitWarnings())}}}}else this.lookForPlayer()}},this.draw=t=>{this.dead||(s.Game.ctx.save(),s.Game.ctx.globalAlpha=this.alpha,this.dead||(this.updateDrawXY(t),this.tileX=27,this.tileY=8,(this.health<=1||this.dying)&&(this.tileX=17,this.tileY=8),this.frame+=.1*t,this.frame>=4&&(this.frame=0),this.hasShadow&&this.drawShadow(t),s.Game.drawMob(this.tileX+(5===this.tileX?Math.floor(this.frame):0),this.tileY+2*this.direction,1,2,this.x-this.drawX,this.y-this.drawYOffset-this.drawY,1,2,this.softShadeColor,this.shadeAmount(),void 0,this.outlineColor(),this.outlineOpacity())),this.cloned||(this.seenPlayer||this.drawSleepingZs(t),this.alertTicks>0&&this.drawExclamation(t)),s.Game.ctx.restore())},this.ticks=0,this.frame=0,this.health=2,this.maxHealth=2,this.defaultMaxHealth=2,this.tileX=17,this.tileY=8,this.seenPlayer=!1,this.aggro=!1,this.deathParticleColor="#ffffff",this.name="armored zombie",this.forwardOnlyAttack=!0,this.armored=!0,r&&(this.drop=r),this.getDrop(["weapon","equipment","consumable","tool","coin"])}}e.ArmoredzombieEnemy=r,r.difficulty=2,r.tileX=17,r.tileY=8},503:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Bestiary=void 0;const s=i(7851),o=i(1285),a=i(6291),r=i(8200),n=i(7716),h=i(3180),l=i(7975),c=i(5339),d=i(9982),m=i(6493),u=i(3005),p=i(492),y=i(675),g=i(6598),f=i(5097),w=i(9357),E=i(4159),x=i(126),b=i(4438),T={CrabEnemy:r.CrabEnemy,FrogEnemy:n.FrogEnemy,ZombieEnemy:h.ZombieEnemy,SkullEnemy:l.SkullEnemy,EnergyWizardEnemy:c.EnergyWizardEnemy,ChargeEnemy:d.ChargeEnemy,RookEnemy:m.RookEnemy,BishopEnemy:u.BishopEnemy,ArmoredzombieEnemy:p.ArmoredzombieEnemy,BigSkullEnemy:y.BigSkullEnemy,QueenEnemy:g.QueenEnemy,KnightEnemy:f.KnightEnemy,BigKnightEnemy:w.BigKnightEnemy,FireWizardEnemy:E.FireWizardEnemy,Spawner:x.Spawner,OccultistEnemy:b.OccultistEnemy};e.Bestiary=class{constructor(t,e){this.isOpen=!1,this.openTime=Date.now(),this.frame=0,this.activeEntryIndex=0,this.open=()=>{0===this.seenEnemies.size&&(this.seenEnemies=this.game.tutorialListener.seenEnemies),this.isOpen=!0,this.openTime=Date.now()},this.close=()=>{this.isOpen=!1},this.entryUp=()=>{this.activeEntryIndex=(this.activeEntryIndex-1+this.entries.length)%this.entries.length},this.entryDown=()=>{this.activeEntryIndex=(this.activeEntryIndex+1)%this.entries.length},this.toggleOpen=()=>{this.isOpen?this.close():this.open()},this.addEntry=t=>{const e=T[t.name];this.entries.push({name:t.name,description:e.prototype.description,tileX:e.prototype.tileX,tileY:e.prototype.tileY})},this.draw=t=>{if(!this.isOpen)return;s.Game.ctx.save(),s.Game.ctx.fillStyle="rgba(0, 0, 0, 0.8)",s.Game.ctx.fillRect(0,0,a.GameConstants.WIDTH,a.GameConstants.HEIGHT);const e=Math.min(18,18*(Date.now()-this.openTime)/100),i=5*(e+4+-2)- -2,o=4*(e+4+-2)- -2,r=Math.round(.5*a.GameConstants.WIDTH-.5*i)-1,n=Math.round(.5*a.GameConstants.HEIGHT-.5*o)-1;s.Game.ctx.fillStyle="white",s.Game.ctx.fillRect(r,n,i+2,o+2),s.Game.ctx.fillStyle="black",0===this.entries.length?s.Game.fillText("No enemies seen yet",r+10,n+10):(this.entries.forEach((t,e)=>{s.Game.fillText(t.name,r+10,n+10+20*e)}),this.drawEnemySprite(this.entries[this.activeEntryIndex].tileX,this.entries[this.activeEntryIndex].tileY,t)),this.drawLogbookButton(t),s.Game.ctx.restore()},this.drawEnemySprite=(t,e,i)=>{this.frame+=Math.round(.1*i*10)/10,this.frame>=4&&(this.frame=0),s.Game.drawMob(t,e,1,1,1,1,1,1,"Black",0)},this.drawLogbookButton=t=>{s.Game.ctx.save(),this.buttonX=o.LevelConstants.SCREEN_W-2,this.buttonY=o.LevelConstants.SCREEN_H-2.25,s.Game.drawFX(0,0,2,2,this.buttonX,this.buttonY,2,2),s.Game.ctx.restore()},this.handleMouseDown=(t,e,i)=>{0===i&&this.isPointInLogbookButton(t,e)&&this.toggleOpen()},this.handleMouseUp=(t,e,i)=>{},this.onHoldDetected=()=>{},this.isPointInLogbookButton=(t,e)=>{const i=t/a.GameConstants.TILESIZE,s=e/a.GameConstants.TILESIZE;return i>=this.buttonX&&i<=this.buttonX+2&&s>=this.buttonY&&s<=this.buttonY+2},this.tick=()=>{this.isOpen},this.game=t,this.player=e,this.entries=[],this.activeEntryIndex=0,this.buttonX=Math.round((Math.round(a.GameConstants.WIDTH/2)+3)/a.GameConstants.TILESIZE),this.buttonY=Math.round(10),this.seenEnemies=new Set}}},521:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.BlueGem=void 0;const s=i(5180);class o extends s.Usable{constructor(t,e,i){super(t,e,i),this.useOnOther=(t,e)=>{"gold ring"===e.name&&e.embed(t,this)},this.getDescription=()=>"A gem of zircon. Embed it into a gold ring to imbue it with magic.",this.tileX=13,this.tileY=0,this.name=o.itemName,this.canUseOnOther=!0,this.stackable=!0}}e.BlueGem=o,o.itemName="zircon"},529:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.AmberRing=void 0;const s=i(8549);class o extends s.Equippable{constructor(t,e,i){super(t,e,i),this.tileX=14,this.tileY=2,this.name=o.itemName,this.stackable=!1,this.description="A ring of amber"}}e.AmberRing=o,o.itemName="amber ring"},606:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Entity=e.EntityType=e.EntityDirection=void 0;const s=i(7851),o=i(75),a=i(8160),r=i(6291),n=i(369),h=i(6199),l=i(5250),c=i(3436),d=i(4804),m=i(9200),u=i(5947),p=i(2502),y=i(6277),g=i(3458),f=i(1438),w=i(4052),E=i(4396),x=i(7366),b=i(1887),T=i(1236),I=i(9467),S=i(3446),v=i(8075),A=i(1124);var M,C;(C=e.EntityDirection||(e.EntityDirection={}))[C.DOWN=0]="DOWN",C[C.UP=1]="UP",C[C.RIGHT=2]="RIGHT",C[C.LEFT=3]="LEFT",function(t){t[t.ENEMY=0]="ENEMY",t[t.FRIENDLY=1]="FRIENDLY",t[t.RESOURCE=2]="RESOURCE",t[t.PROP=3]="PROP",t[t.CHEST=4]="CHEST"}(M=e.EntityType||(e.EntityType={}));class D extends a.Drawable{constructor(t,e,i,a,C=0){super(),this.sleepingZFrame=0,this.imageParticleX=0,this.imageParticleY=26,this.dropChance=1,this.shadeMultiplier=1,this.bloomColor="#FFFFFF",this.bloomAlpha=1,this.softBloomAlpha=1,this.bloomSize=1,this.bloomOffsetY=0,this.opaque=!1,this.opacity=0,this.hasHitParticles=!0,this.hasDamageNumbers=!0,this.armored=!1,this.justHurt=!1,this.stunned=!1,this.collidable=!0,this.canDestroyOthers=!1,this.canCrushOthers=!1,this.beamIds=[],this.extendShadow=!1,this.shadowOpacity=.3,this.lootDropped=!1,this.seeThroughAlpha=1,this.softSeeThroughAlpha=1,this.hoverText=()=>this.name,this.outlineColor=()=>{let t="black";return this.shielded&&(t=r.GameConstants.OUTLINE_SHIELD_COLOR),this.buffed&&(t=r.GameConstants.OUTLINE_BUFF_COLOR),this.shielded&&this.buffed&&(t="#5a87ff"),t},this.outlineOpacity=()=>{let t=0;return this.shielded&&(t=.25),this.buffed&&(t=.25),this.shielded&&this.buffed&&(t=.5),t},this.applyShield=(t=1,e=!1)=>{this.shieldedBefore&&!e||(this.shield=new E.EnemyShield(this,this.x,this.y,t),this.shielded=!0,this.shieldedBefore=!0,e||(this.health+=t,this.maxHealth=this.defaultMaxHealth+t),this.shadeColor="purple",this.shadeMultiplier=.5,this.hasBloom=!0,this.bloomColor="#2E0854",this.bloomAlpha=1)},this.removeShield=()=>{this.shield&&(this.health-=this.shield.health,this.maxHealth-=this.shield.health,this.shield.remove(),this.shadeColor=this.room.shadeColor,this.shadeMultiplier=1,this.hasBloom=!1,this.bloomAlpha=0)},this.applyBuff=()=>{this.buffed=!0,this.buffedBefore=!0,this.shadeColor="cyan",this.shadeMultiplier=.5,this.hasBloom=!0,this.bloomColor="#00FFFF",this.bloomAlpha=.5,this.lightSource=A.Lighting.newLightSource(this.x+.5,this.y+.5,[0,40,40],3.5,20),this.addLightSource(this.lightSource),this.room.updateLighting()},this.removeBuff=()=>{let t=this.room.projectiles.filter(t=>t instanceof v.BeamEffect&&t.parent===this);t&&t.forEach(t=>{t.dead=!0}),this.shadeColor=this.room.shadeColor,this.shadeMultiplier=1,this.hasBloom=!1,this.bloomAlpha=0,this.removeLightSource(this.lightSource),this.lightSource=null,this.room.updateLighting(),this.buffed=!1},this.getDrop=(t=[],e=!1)=>{if(this.cloned)return;const i=this.dropTable&&this.dropTable.length>0?this.dropTable:t;f.DropTable.getDrop(this,i,e,3),this.drop instanceof w.Weapon&&this.type===M.ENEMY&&(this.drop.durability=Math.floor(.31*I.Random.rand()*this.drop.durabilityMax),this.drop.durabilityMax)},this.addLightSource=t=>{this.cloned||this.room.lightSources.push(t)},this.removeLightSource=t=>{this.room.lightSources=this.room.lightSources.filter(e=>e!==t),this.room.updateLighting()},this.addBeamId=t=>{this.beamIds.push(t)},this.removeBeamId=t=>{this.beamIds=this.beamIds.filter(e=>e!==t)},this.behavior=()=>{},this.hit=()=>0,this.hurtCallback=()=>{},this.pointIn=(t,e)=>t>=this.x&&t<this.x+this.w&&e>=this.y&&e<this.y+this.h,this.createDamageNumber=(t,e="none")=>{let i="red",s=r.GameConstants.OUTLINE;"poison"===e&&(i="green"),"blood"===e&&(i="#8B0000",s="red"),"heal"===e&&(i="#B8A4FF",s=r.GameConstants.OUTLINE),this.room.particles.push(new l.DamageNumber(this.room,this.x,this.y,t,i,s))},this.updateDrawXY=t=>{this.updateHurtFrame(t),this.animateDying(t),this.updateShadeColor(t),this.doneMoving()||(this.drawX*=this.drawMoveSpeed**t,this.drawY*=this.drawMoveSpeed**t,this.drawX=Math.abs(this.drawX)<.01?0:this.drawX,this.drawY=Math.abs(this.drawY)<.01?0:this.drawY)},this.setDrawXY=(t,e)=>{this.drawX+=this.x-t,this.drawY+=this.y-e},this.shouldSeeThrough=()=>{const t=this.room.getPlayer(),e=this.room.hasEnemy(this.x,this.y-1);t?.x===this.x&&t?.y===this.y-1||e?this.seeThroughAlpha=0:this.seeThroughAlpha=1},this.updateSeeThroughAlpha=t=>{this.softSeeThroughAlpha>this.seeThroughAlpha?this.softSeeThroughAlpha-=.025*t:this.softSeeThroughAlpha<this.seeThroughAlpha&&(this.softSeeThroughAlpha+=.025*t),this.softSeeThroughAlpha<.5&&(this.softSeeThroughAlpha=.5),this.softSeeThroughAlpha>1&&(this.softSeeThroughAlpha=1)},this.tryMove=(t,e,i=!0)=>{const s=this.canDestroyOthers;let o=(i,s)=>i>=t&&i<t+this.w&&s>=e&&s<e+this.h,a=i=>{let o=!0;if((i.x>=t+this.w||i.x+i.w<=t)&&(o=!1),(i.y>=e+this.h||i.y+i.h<=e)&&(o=!1),s&&i.destroyable&&i.destroyableByOthers&&i.w<=1&&i.h<=1&&!0===o){if(i.hurt(this,i.health),!this.canCrushOthers){const t=this.closestTile(i);this.drawX+=1*(t.x-i.x),this.drawY+=1*(t.y-i.y)}const t=h.Utils.distance(this.x,this.y,this.game.players[this.game.localPlayerID].x,this.game.players[this.game.localPlayerID].y);this.game.shakeScreen(10*this.drawX*(1/t),10*this.drawY*(1/t),!0),o=!this.canCrushOthers}return o},r=!1;for(const t of this.room.entities)t!==this&&(t.z??0)===(this.z??0)&&a(t)&&i&&(r=!0);if(r)return;for(const t in this.game.players){const e=this.game.players[t];if((e?.z??0)===(this.z??0)&&o(e.x,e.y))return}let n=[];for(let i=0;i<this.w;i++)for(let s=0;s<this.h;s++){if(this.room.roomArray[t+i][e+s].isSolid()||this.room.roomArray[t+i][e+s]instanceof d.Door||this.room.roomArray[t+i][e+s]instanceof c.DownLadder)return;n.push(this.room.roomArray[t+i][e+s])}for(let t of n)t.onCollideEnemy(this);this.x=t,this.y=e,this.bigEnemyShake()},this.bigEnemyShake=()=>{(this.w>1||this.h>1)&&setTimeout(()=>{this.game.shakeScreen(0*this.drawX,5)},300)},this.getPlayer=()=>{const t=138291380921;let e=t,i=null;const s=this.z??0;for(const t in this.game.players)if(this.game.rooms[this.game.players[t].levelID]===this.room){const o=this.game.players[t];if((o?.z??0)!==s)continue;let a=this.playerDistance(this.game.players[t]);a<e&&(e=a,i=this.game.players[t])}return e!==t&&i},this.onHurt=(t=1,e="none")=>{},this.hurt=(t,e,i="none")=>{this.handleEnemyCase(t);let s=!1,o=0;this.shielded&&(o=this.shield.health,o>0&&this.shield.hurt(e)),this.armored&&this.health===this.defaultMaxHealth&&x.Sound.playParry(),this.health-=e,this.onHurt(e,i),this.startHurting(),this.hasDamageNumbers&&this.createDamageNumber(e,i),this.playHitSound(),this.healthBar.hurt(),this.isEnemy&&t&&p.globalEventBus.emit(y.EVENTS.DAMAGE_DONE,{amount:e}),("none"===i||this.health<=0||!this.isEnemy)&&this.createHitParticles(),this.health<=0?(this.kill(),this.bloomAlpha=0):this.hurtCallback()},this.wander=()=>{const t=this.x,e=this.y;for(let i=0;i<4;i++){const i=[s.Direction.UP,s.Direction.DOWN,s.Direction.LEFT,s.Direction.RIGHT],o=i[Math.floor(I.Random.rand()*i.length)];let a=this.x,r=this.y;switch(o){case s.Direction.UP:r=this.y-1;break;case s.Direction.DOWN:r=this.y+1;break;case s.Direction.LEFT:a=this.x-1;break;case s.Direction.RIGHT:a=this.x+1}if(this.tryMove(a,r),this.setDrawXY(t,e),this.x!==t||this.y!==e){this.direction=o,this.setDrawXY(a,r);break}}},this.runAway=(t=!0)=>{const e=this.getPlayer();if(!e)return void this.wander();if(I.Random.rand()<.25)return;if(h.Utils.distance(this.x,this.y,e.x,e.y)>10)return void this.wander();const i=this.x,o=this.y,a=[{x:this.x-1,y:this.y},{x:this.x+1,y:this.y},{x:this.x,y:this.y-1},{x:this.x,y:this.y+1}].map(t=>({position:t,distance:h.Utils.distance(e.x,e.y,t.x,t.y)}));a.sort((t,e)=>e.distance-t.distance);const r=I.Random.rand()<.3&&a.length>1?a[1].position:a[0].position,n=r.x,l=r.y;if(this.tryMove(n,l),this.setDrawXY(i,o),this.x!==i||this.y!==o){const t=this.x-i,e=this.y-o;t>0?this.direction=s.Direction.RIGHT:t<0?this.direction=s.Direction.LEFT:e>0?this.direction=s.Direction.DOWN:e<0&&(this.direction=s.Direction.UP),this.setDrawXY(n,l)}else this.wander()},this.startHurting=()=>{this.hurting=!0,this.hurtFrame+=15,this.shadeColor="#FF0000",this.shadeMultiplier=1.5},this.stopHurting=()=>{this.hurting=!1,this.hurtFrame=0,this.shadeColor="#000000"},this.interact=t=>{},this.handleEnemyCase=t=>{},this.playHitSound=()=>{this.hitSound&&x.Sound.delayPlay(this.hitSound,50)},this.createHitParticles=(t,e)=>{this.cloned||this.hasHitParticles&&(t||(t=this.imageParticleX),e||(e=this.imageParticleY),b.ImageParticle.spawnCluster(this.room,this.x+.5,this.y+.5,t,e))},this.dropLoot=()=>{if(this.lootDropped)return;let t,e;if(this.crushed?(t=this.lastX,e=this.lastY):(t=this.x,e=this.y),0===this.drops.length&&this.isEnemy&&this.drops.push(new T.Coin(this.room,this.x,this.y)),this.drops.length>0){const i=[];for(let s=0;s<this.w;s++)for(let o=0;o<this.h;o++){const a=t+s,r=e+o;this.room.roomArray[a]&&this.room.roomArray[a][r]&&!this.room.roomArray[a][r].isSolid()&&i.push({x:a,y:r})}0===i.length&&this.room.roomArray[t]&&this.room.roomArray[t][e]&&!this.room.roomArray[t][e].isSolid()&&i.push({x:t,y:e});const s=new Set,o=i.length>0?Math.floor(I.Random.rand()*i.length):0;this.drops.forEach((a,r)=>{if(a.level=this.room,i.length>0){const t=i[(o+r)%i.length];a.x=t.x,a.y=t.y,a.z=this.z??0,s.add(`${t.x},${t.y}`)}else this.room.roomArray[t]&&this.room.roomArray[t][e]&&!this.room.roomArray[t][e].isSolid()&&(a.x=t,a.y=e,a.z=this.z??0,s.add(`${t},${e}`));this.room.items.push(a),a.onDrop(),"chest"!==this.name&&a.autoPickup()}),this.isEnemy&&(this.w>1||this.h>1)&&i.length>0&&i.filter(t=>!s.has(`${t.x},${t.y}`)).forEach(t=>{const e=new T.Coin(this.room,t.x,t.y);e.z=this.z??0,e.level=this.room,this.room.items.push(e),e.onDrop(),"chest"!==this.name&&e.autoPickup()})}this.lootDropped=!0},this.kill=t=>{if(this.dead=!0,this.cloned)return;this.emitEnemyKilled(),this.dropLoot();const e=this.clone();this.room.deadEntities.push(e),this.removeLightSource(this.lightSource),this.uniqueKillBehavior()},this.uniqueKillBehavior=()=>{},this.updateHurtFrame=t=>{this.hurting&&(this.hurtFrame-=t,this.hurtFrame<0&&this.stopHurting())},this.shadeAmount=()=>{if(r.GameConstants.SMOOTH_LIGHTING&&!r.GameConstants.SHADE_INLINE_IN_ENTITY_LAYER||r.GameConstants.SHADING_DISABLED)return 0;if(!this.room.softVis[this.x])return 0;let t=1*this.room.softVis[this.x][this.y];return this.shadeMultiplier>1?Math.min(1,t):t},this.updateShadeColor=t=>{this.shadeMultiplier>1&&(this.shadeMultiplier-=.01*t),this.shadeMultiplier<1&&(this.shadeMultiplier=1);let e=!1;const i=t=>{const e=parseInt(t.slice(1),16);return[e>>16&255,e>>8&255,255&e]},[s,o,a]=i(this.softShadeColor),[r,n,h]=i(this.shadeColor);let l=s-r,c=o-n,d=a-h,m=!1,u=!1,p=!1;if(Math.abs(l)>1&&(m=!0),Math.abs(c)>1&&(u=!0),Math.abs(d)>1&&(p=!0),!m&&!u&&!p)return this.softShadeColor;let y=[s,o,a];return m&&(l*=.1*t,y[0]=this.room.clamp(Math.round(s-l),0,255),e=!0),u&&(c*=.1*t,y[1]=this.room.clamp(Math.round(o-c),0,255),e=!0),p&&(d*=.1*t,y[2]=this.room.clamp(Math.round(a-d),0,255),e=!0),e&&(this.softShadeColor=(t=>{const[e,i,s]=t;return"#"+((1<<24)+(e<<16)+(i<<8)+s).toString(16).slice(1).toUpperCase()})(y)),this.softShadeColor},this.emitEnemyKilled=()=>{let t=1.5**this.room.depth;console.log(t);let e=1;this.isEnemy&&(e=5);const i=Math.ceil(this.defaultMaxHealth*e*t);this.isEnemy&&(p.globalEventBus.emit(y.EVENTS.ENEMY_KILLED,{enemyId:this.name,xp:i}),this.getPlayer()&&r.GameConstants.XP_POPUP_ENABLED&&setTimeout(()=>{this.room.particles.push(new S.XPPopup(this.room,this.x,this.y,i))},350))},this.doneMoving=()=>Math.abs(this.drawX)<.01&&Math.abs(this.drawY)<.01,this.nearestPlayer=()=>{const t=138291380921;let e=t,i=null;const s=this.z??0;for(const t in this.game.players)if(this.game.rooms[this.game.players[t].levelID]===this.room){if(this.game.players[t].z!==s)continue;let o=this.playerDistance(this.game.players[t]);o<e&&(e=o,i=this.game.players[t])}return e!==t&&[e,i]},this.playerDistance=t=>Math.max(Math.abs(this.x-t.x),Math.abs(this.y-t.y)),this.closestTile=t=>{let e={x:0,y:0},i=1e6;for(let s=0;s<this.w;s++)for(let o=0;o<this.h;o++){let a=Math.abs(t.x-(this.x+s))+Math.abs(t.y-(this.y+o));a<i&&(i=a,e={x:this.x+s,y:this.y+o})}return e},this.facePlayer=t=>{if(1===this.w&&1===this.h){const e=this.x+.5,i=this.y+.5;let o=t.x-e,a=t.y-i;return void(Math.abs(o)===Math.abs(a)||(Math.abs(o)>Math.abs(a)?(o>0&&(this.direction=s.Direction.RIGHT),o<0&&(this.direction=s.Direction.LEFT)):(a>0&&(this.direction=s.Direction.DOWN),a<0&&(this.direction=s.Direction.UP))))}const e=t.y>=this.y&&t.y<this.y+this.h,i=t.x>=this.x&&t.x<this.x+this.w;if(e&&i)return;const o=this.closestTile(t);let a=t.x-o.x,r=t.y-o.y;Math.abs(a)>Math.abs(r)?(a>0&&(this.direction=s.Direction.RIGHT),a<0&&(this.direction=s.Direction.LEFT)):(r>0&&(this.direction=s.Direction.DOWN),r<0&&(this.direction=s.Direction.UP))},this.animateDying=t=>{this.cloned&&(this.dyingFrame-=t/3,this.alpha=Math.max(0,this.alpha-t/50),this.dyingFrame<=0&&(this.dead=!0,this.dying=!1,this.uniqueKillBehavior(),this.room.clearDeadStuff()))},this.draw=t=>{this.dead||(s.Game.ctx.save(),s.Game.ctx.globalAlpha=this.alpha,this.updateDrawXY(t),this.hasShadow&&this.drawShadow(t),s.Game.drawMob(this.tileX,this.tileY+2*this.direction,1,2,this.x-this.drawX,this.y-this.drawYOffset-this.drawY,1,2,this.shadeColor,this.shadeAmount(),void 0,this.outlineColor(),this.outlineOpacity()),s.Game.ctx.globalAlpha=1)},this.drawShadow=t=>{this.cloned||g.Shadow.draw(this.x-this.drawX,this.y-this.drawY,this.w,this.h,this.extendShadow,this.shadowOpacity)},this.tick=()=>{this.behavior(),this.shielded&&this.shield.updateLightSourcePos()},this.emitEntityData=()=>{p.globalEventBus.emit("EntityData",{name:this.name,location:{x:this.x,y:this.y,z:this.z??0}})},this.drawTopLayer=t=>{this.drawableY=this.y-this.drawY,this.healthBar.draw(t,this.health,this.maxHealth,this.x,this.y,!0)},this.drawSleepingZs=(t,e=0,i=0)=>{this.sleepingZFrame+=t;let o=.01*this.sleepingZFrame;o-=Math.floor(o);for(let t=1;t>=0;t--){let a=7*(o+t),n=Math.min(1-(o+t)/2,2*(o+t)/2),h=0;0===t&&(h=1),o>=.33&&o<.66&&(h=t),o>=.33&&o<.66&&(h=t);let l=s.Game.measureText("Z").width;r.GameConstants.ALPHA_ENABLED&&(s.Game.ctx.globalAlpha=n),s.Game.fillTextOutline("Z",(this.x+.5)*r.GameConstants.TILESIZE-l/2+h+e,(this.y-.6)*r.GameConstants.TILESIZE-a+i,r.GameConstants.OUTLINE,"white"),s.Game.ctx.globalAlpha=1}},this.drawExclamation=(t,e=0,i=0)=>{this.exclamationFrame+=t;let o=0,a=[0,-1,-2,-3,-5,-7,-4];o=this.exclamationFrame>a.length?a[a.length-1]:a[this.exclamationFrame];let n=s.Game.measureText("!").width;s.Game.ctx.globalAlpha=1,!1!==o&&s.Game.fillTextOutline("!",(this.x+.5)*r.GameConstants.TILESIZE-n/2+e,(this.y-.75)*r.GameConstants.TILESIZE+o+i,r.GameConstants.OUTLINE,r.GameConstants.WARNING_RED)},this.crush=()=>{let t;this.crushed=!0;for(let e in this.game.players)t=this.game.players[e];this.x==t.x&&(this.crushVertical=!0),this.kill()},this.crushAnim=t=>{this.crushVertical&&this.crushY>=0?this.crushY*=.95:this.crushX>=0&&(this.crushX*=.95)},this.rumble=(t,e,i)=>{let o={x:0,y:0};if(t){const t=Math.floor(e)%2==1?.0325:0;i===s.Direction.LEFT||i===s.Direction.RIGHT?o.y=t:i!==s.Direction.UP&&i!==s.Direction.DOWN&&i||(o.x=t),this.animationSpeed=.2}return o},this.attemptProjectilePlacement=(t,e,i=!1,s=!0,o=!1)=>{for(const a of t){const t=this.x+a.x,r=this.y+a.y;if(this.isValidProjectilePosition(t,r,i,s)){if(this.placeProjectile(e,t,r),o)break}else if(o)break}},this.isValidProjectilePosition=(t,e,i,s)=>{if(!this.isWithinRoomBounds(t,e))return!1;if(s&&!this.isPathClear(this.x,this.y,t,e))return!1;if(i&&this.isEntityColliding(t,e))return!1;const o=this.room.roomArray[t][e];return o&&!o.isSolid()&&!o.isDoor},this.isEntityColliding=(t,e)=>this.room.entities.some(i=>i.x===t&&i.y===e&&i.z===this.z),this.placeProjectile=(t,e,i,s)=>{this.room.projectiles.push(new t(this,e,i,s))},this.isPathClear=(t,e,i,s)=>{const o=Math.sign(i-t),a=Math.sign(s-e);let r=t,n=e;for(;r!==i||n!==s;)if(r+=o,n+=a,!this.isWithinRoomBounds(r,n)||this.room.roomArray[r][n]?.isSolid())return!1;return!0},this.getLuminance=()=>this.room.roomArray[this.x][this.y]?this.room.vis[this.x][this.y]:null,this.getAverageLuminance=()=>{let t=0,e=0;for(let i=this.x-2;i<=this.x+2;i++)if(this.room.roomArray[i]&&this.room.roomArray[i][this.y])for(let s=this.y-2;s<=this.y+2;s++)this.room.vis[i][s]&&(t+=this.room.vis[i][s],e++);return t/e},this.getOpenTile=()=>{let t,e;do{t=Math.floor(3*I.Random.rand()+this.x-1),e=Math.floor(3*I.Random.rand()+this.y-1)}while(t===this.x&&e===this.y||this.room.roomArray[t][e].isSolid()||this.room.roomArray[t][e]instanceof c.DownLadder||this.room.roomArray[t][e]instanceof d.Door||this.room.roomArray[t][e]instanceof m.Wall||this.room.entities.some(i=>i.x===t&&i.y===e&&i.z===this.z));return t&&e?{x:t,y:e}:{x:this.x,y:this.y}},this.makeBigHitWarnings=()=>{switch(this.direction){case s.Direction.LEFT:this.makeHitWarnings(this.x,this.y),this.makeHitWarnings(this.x,this.y+1);break;case s.Direction.RIGHT:this.makeHitWarnings(this.x+1,this.y),this.makeHitWarnings(this.x+1,this.y+1);break;case s.Direction.UP:this.makeHitWarnings(this.x,this.y),this.makeHitWarnings(this.x+1,this.y);break;case s.Direction.DOWN:this.makeHitWarnings(this.x,this.y+1),this.makeHitWarnings(this.x+1,this.y+1)}},this.makeHitWarnings=(t=this.x,e=this.y,i=!1,o=null)=>{if(this.unconscious||this.isEnemy&&!this.seenPlayer)return;const a=this.getPlayer(),r=a.x===t&&a.y===e?0:.45;let l=this.orthogonalAttack,c=this.diagonalAttack,d=this.forwardOnlyAttack;const m=this.direction,u=this.attackRange,p=this.diagonalAttackRange;switch(o){case"diagonal":c=!0,l=!1,d=!1;break;case"orthogonal":l=!0,c=!1,d=!1;break;case"forward":d=!0,l=!0,c=!1}const y=(t,e)=>(t?[[-1,0],[1,0],[0,-1],[0,1]]:[[-1,-1],[1,1],[1,-1],[-1,1]]).flatMap(([t,i])=>Array.from({length:e},(e,s)=>[(s+1)*t,(s+1)*i])),g={[s.Direction.LEFT]:[-1,0],[s.Direction.RIGHT]:[1,0],[s.Direction.UP]:[0,-1],[s.Direction.DOWN]:[0,1]};let f=[];if(d){const[t,e]=g[m];f=Array.from({length:u},(i,s)=>[(s+1)*t,(s+1)*e])}else l&&f.push(...y(!0,u)),c&&f.push(...y(!1,p));const w=f.map(([i,s])=>({x:i,y:s,distance:h.Utils.distance(i,s,a.x-t,a.y-e)})).sort((t,e)=>t.distance-e.distance),E=Math.ceil(w.length*(1-r));w.slice(0,E).forEach(({x:s,y:o})=>{const a=t+s,r=e+o;if(this.isWithinRoomBounds(a,r)){const s=new n.HitWarning(this.game,a,r,t,e,!0,i,this);this.room.hitwarnings.push(s)}})},this.isWithinRoomBounds=(t,e)=>{const i=t>=this.room.roomX&&t<this.room.roomX+this.room.width,s=e>=this.room.roomY&&e<this.room.roomY+this.room.height,o=this.room.roomArray[t]&&void 0!==this.room.roomArray[t][e];return i&&s&&o},this.globalId=u.IdGenerator.generate("EN");const D=!0===this.constructor.__isCloning;this.cloned=!!D,this.room=t,this.x=i,this.y=a,this.z=C,this.w=1,this.h=1,this.game=e,this.drawX=0,this.drawY=0,this.health=1,this.maxHealth=1,this.defaultMaxHealth=1,this.tileX=0,this.tileY=0,this.hasShadow=!0,this.skipNextTurns=0,this.direction=s.Direction.DOWN,this.destroyable=!0,this.destroyableByOthers=!0,this.pushable=!1,this.chainPushable=!0,this.interactable=!1,this.healthBar=new o.HealthBar,this.alertTicks=0,this.exclamationFrame=0,this.lastX=i,this.lastY=a,this.hitBy=null,this.crushX=1,this.crushY=1,this.crushVertical=!1,this.crushed=!1,this.rumbling=!1,this.animationSpeed=.1,this.drawYOffset=1.175,this.hitWarnings=[],this.orthogonalAttack=!1,this.diagonalAttack=!1,this.forwardOnlyAttack=!1,this.attackRange=1,this.diagonalAttackRange=1,this.drawMoveSpeed=.9,this.unconscious=!1,this.dropChance=.02,this.isEnemy=!1,this.shielded=!1,this.shield=null,this.frame=0,this.shieldedBefore=!1,this._imageParticleTiles={x:0,y:0},this.hitSound=null,this.shadeColor=this.room.shadeColor,this.hurting=!1,this.hurtFrame=0,this.softShadeColor="#000000",this.dying=!1,this.dyingFrame=30,this.alpha=1,this.dead=!1,this.hasBloom=!1,this.bloomColor="#FFFFFF",this.moving=!1,this.dropTable=[],this.drops=[],this.canDestroyOthers=!1,this.canCrushOthers=!1,this.beamIds=[],this.extendShadow=!1,this.drop&&this.drops.push(this.drop)}static add(t,e,i,s,...o){if(!t.roomArray[i]||!t.roomArray[i][s])return console.warn(`Cannot add entity: tile at (${i}, ${s}) does not exist`),null;if(t.roomArray[i][s].isSolid())return console.warn(`Cannot add entity: tile at (${i}, ${s}) is solid`),null;const a=new this(t,e,i,s,...o);return t.entities.push(a),a}static cloneEntity(t){t.constructor.__isCloning=!0;const e=new t.constructor(t.room,t.game,t.x,t.y,t.z??0);return delete t.constructor.__isCloning,Object.assign(e,{cloned:!0,dead:!1,dying:!0,drawableY:t.drawableY,tileX:t.tileX,tileY:t.tileY,frame:t.frame,direction:t.direction,drawX:t.drawX,drawY:t.drawY,z:t.z??0,alpha:t.alpha,shadeColor:t.shadeColor,shadeMultiplier:t.shadeMultiplier,softShadeColor:t.softShadeColor,hasBloom:t.hasBloom,bloomColor:t.bloomColor,bloomAlpha:1,softBloomAlpha:1,dyingFrame:30}),t.room.deadEntities.push(e),e}clone(){const t=D.cloneEntity(this);return t.dead=!1,t.dying=!0,t}get imageParticleTiles(){return this._imageParticleTiles}get type(){return M.ENEMY}calculateProjectileOffsets(t,e,i){const s=t-this.x,o=e-this.y;let a=[];const r=0!==s?Math.sign(s):0,n=0!==o?Math.sign(o):0;for(let t=1;t<=i;t++)a.push({x:t*r,y:t*n});return a}}e.Entity=D},645:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.ReverbEngine=void 0;const s=i(7851),o=i(7366),a=i(4196);class r{static isMobile(){return o.Sound.isMobile}static async unlockMobileAudio(){if(!r.mobileUnlockAttempted&&r.isMobile()){r.mobileUnlockAttempted=!0;try{const t=r.audioContext.createBuffer(1,1,22050),e=r.audioContext.createBufferSource();e.buffer=t,e.connect(r.audioContext.destination),void 0===e.start?e.noteOn(0):e.start(0),"suspended"===r.audioContext.state&&await r.audioContext.resume()}catch(t){console.warn("[REVERB-MOBILE] Failed to unlock audio context:",t)}}}static getSoundName(t){const e=t._src;return Array.isArray(e)&&e.length>0?e[0].split("/").pop()||"unknown":"string"==typeof e&&e.split("/").pop()||"unknown"}static logStep(t,e,i,s){}static async initialize(){if(r.initialized)return;let t=s.Game.inputReceived;if(!t)try{await new Promise(e=>{const i=()=>{s.Game.inputReceived?(e(),t=!0):requestAnimationFrame(i)};i()})}catch(t){return void console.error("Failed to wait for input:",t)}if(!r.audioContext&&!r.initialized&&t)try{a.Howler.ctx||await new Promise(t=>setTimeout(t,100)),r.audioContext=a.Howler.ctx||new(window.AudioContext||window.webkitAudioContext),r.isMobile()&&await r.unlockMobileAudio(),"suspended"===r.audioContext.state&&await r.audioContext.resume(),r.convolver=r.audioContext.createConvolver(),r.convolver.connect(r.audioContext.destination),await r.loadReverbBuffer("res/SFX/impulses/small.mp3"),r.setDefaultReverb(),r.originalRefreshBuffer||(r.originalRefreshBuffer=a.Howl.prototype._refreshBuffer,a.Howl.prototype._refreshBuffer=function(t){const e=r.getSoundName(this);if(r.logStep("A",e,"Intercepted _refreshBuffer",t._id),r.isMobile()&&"suspended"===r.audioContext.state&&r.audioContext.resume().then(()=>{r.logStep("A-MOBILE",e,"Resumed suspended context",t._id)}),r.originalRefreshBuffer.call(this,t),t._node&&t._node.bufferSource){r.logStep("B",e,"Setting up reverb routing",t._id),t._node.bufferSource.disconnect();let i=r.gainNodes.get(t._id);if(!i){i=r.audioContext.createGain();const s=this._volume||1;i.gain.setValueAtTime(s,r.audioContext.currentTime),i.connect(r.convolver),r.gainNodes.set(t._id,i),r.logStep("C",e,`Created gain node with volume ${s}`,t._id)}t._node.bufferSource.connect(i),r.logStep("D",e,"Connected to reverb gain node",t._id)}}),r.initialized=!0,o.Sound.initialized&&(o.Sound.audioMuted=!1),r.isMobile()}catch(t){console.error("Failed to initialize ReverbEngine:",t),r.initialized=!0,o.Sound.initialized&&(o.Sound.audioMuted=!1)}}static async loadReverbBuffer(t){try{const e=await fetch(t);if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);const i=await e.arrayBuffer();r.reverbBuffer=await r.audioContext.decodeAudioData(i)}catch(t){console.error("Error loading reverb buffer:",t)}}static setDefaultReverb(){r.reverbBuffer&&(r.convolver.buffer=r.reverbBuffer)}static async setReverbImpulse(t){if(r.initialized)try{await r.loadReverbBuffer(t),r.reverbBuffer&&(r.convolver.buffer=r.reverbBuffer)}catch(t){console.error("Error setting reverb impulse:",t)}}static applyReverb(t){const e=r.getSoundName(t);return r.logStep("E",e,"CONNECTION INTERCEPT - _refreshBuffer hook will handle reverb"),r.initialized?(r.isMobile()&&"running"!==r.audioContext.state&&r.audioContext.resume().catch(t=>{console.warn("[REVERB-MOBILE] Could not resume audio context:",t)}),t.play()):(r.logStep("E1",e,"Not initialized, playing without reverb"),t.play())}static removeReverb(t){const e=r.getSoundName(t);for(const[t,e]of r.gainNodes.entries())e&&(e.disconnect(),r.gainNodes.delete(t));r.logStep("R",e,"Reverb removed and gain nodes cleaned up")}static cleanup(){r.originalRefreshBuffer&&(a.Howl.prototype._refreshBuffer=r.originalRefreshBuffer);for(const[t,e]of r.gainNodes.entries())e&&e.disconnect();r.gainNodes.clear(),r.convolver&&r.convolver.disconnect(),r.audioContext&&"closed"!==r.audioContext.state&&r.audioContext.close(),r.initialized=!1}}e.ReverbEngine=r,r.reverbBuffer=null,r.gainNodes=new Map,r.mobileUnlockAttempted=!1,r.initialized=!1},675:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.BigSkullEnemy=void 0;const s=i(7851),o=i(6291),a=i(6986),r=i(9467),n=i(7455),h=i(1887);class l extends a.Enemy{constructor(t,e,i,a,l){super(t,e,i,a),this.REGEN_TICKS=5,this.hit=()=>this.damage,this.hurt=(t,e,i="none")=>{this.handleEnemyCase(t);let s=!1,o=0;this.shielded&&(o=this.shield.health,o>0&&this.shield.hurt(e)),this.ticksSinceFirstHit=0,4===this.health&&(this.unconscious=!1),this.health-=e,this.maxHealth-=o,this.startHurting(),this.healthBar.hurt(),this.createDamageNumber(e,i),console.log("health",this.health),console.log("damage",e),this.playHitSound(),1===this.health?(this.unconscious=!0,h.ImageParticle.spawnCluster(this.room,this.x+1,this.y+1,3,28)):this.healthBar.hurt(),this.health<=0?(h.ImageParticle.spawnCluster(this.room,this.x+1,this.y+1,0,24),this.kill()):this.hurtCallback()},this.bleed=()=>{},this.poison=()=>{},this.behavior=()=>{if(this.lastX=this.x,this.lastY=this.y,!this.dead){if(this.handleSkipTurns())return;if(this.health<=1)return this.unconscious=!0,this.ticksSinceFirstHit++,this.ticksSinceFirstHit>=this.REGEN_TICKS&&(this.healthBar.hurt(),this.health=2,this.unconscious=!1),void this.ticks++;if(this.ticks++,this.seenPlayer){if(this.seenPlayer){if(this.room.playerTicked===this.targetPlayer){this.alertTicks=Math.max(0,this.alertTicks-1);let t=this.x,e=this.y;const i=this.targetPlayer,o=i.y>=this.y&&i.y<this.y+this.h,a=i.x>=this.x&&i.x<this.x+this.w;if(o!==a){let t=this.direction;if(o?t=i.x<this.x?s.Direction.LEFT:s.Direction.RIGHT:a&&(t=i.y<this.y?s.Direction.UP:s.Direction.DOWN),t!==this.direction)return this.direction=t,this.makeBigHitWarnings(),void this.ticks++}let r=Array();for(const t of this.room.entities)if(t!==this)for(let e=0;e<(t.w||1);e++)for(let i=0;i<(t.h||1);i++)r.push({x:t.x+e,y:t.y+i});for(let t=this.x-1;t<=this.x+this.w;t++)for(let e=this.y-1;e<=this.y+this.h;e++)this.room.roomArray[t]&&this.room.roomArray[t][e]&&this.room.roomArray[t][e]instanceof n.SpikeTrap&&this.room.roomArray[t][e].on&&r.push({x:t,y:e});const h=this.searchPathLocalized(this.targetPlayer,r);if(h.length>0){let i=h[0].pos.x,o=h[0].pos.y,a=this.direction;if(this.targetPlayer,i>t?this.direction=s.Direction.RIGHT:i<t?this.direction=s.Direction.LEFT:o>e?this.direction=s.Direction.DOWN:o<e&&(this.direction=s.Direction.UP),a===this.direction){let a=!1,r=(t,e,i)=>t.x>=e&&t.x<e+this.w&&t.y>=i&&t.y<i+this.h;for(const t in this.game.players){const e=this.closestTile(this.game.players[t]);this.game.rooms[this.game.players[t].levelID]===this.room&&r(this.game.players[t],i,o)&&(this.game.players[t].hurt(this.hit(),this.name),this.drawX=.5*(e.x-this.game.players[t].x),this.drawY=.5*(e.y-this.game.players[t].y),this.game.players[t]===this.game.players[this.game.localPlayerID]&&this.game.shakeScreen(10*this.drawX,10*this.drawY),a=!0)}a||(this.tryMove(i,o),this.setDrawXY(t,e),this.x>t?this.direction=s.Direction.RIGHT:this.x<t?this.direction=s.Direction.LEFT:this.y>e?this.direction=s.Direction.DOWN:this.y<e&&(this.direction=s.Direction.UP))}}else this.facePlayer(this.targetPlayer);if(this.direction==s.Direction.LEFT)for(let t=0;t<this.h;t++)r.push({x:this.x,y:this.y+t+1}),r.push({x:this.x,y:this.y+t-1});if(this.direction==s.Direction.RIGHT)for(let t=0;t<this.h;t++)r.push({x:this.x+this.w-1,y:this.y+t+1}),r.push({x:this.x+this.w-1,y:this.y+t-1});if(this.direction==s.Direction.DOWN)for(let t=0;t<this.w;t++)r.push({x:this.x+t+1,y:this.y+this.h-1}),r.push({x:this.x+t-1,y:this.y+this.h-1});if(this.direction==s.Direction.UP)for(let t=0;t<this.w;t++)r.push({x:this.x+t+1,y:this.y}),r.push({x:this.x+t-1,y:this.y});this.makeBigHitWarnings()}let t=-1!==Object.values(this.game.offlinePlayers).indexOf(this.targetPlayer);if(!this.aggro||t){let e=this.nearestPlayer();if(!1!==e){let[i,s]=e;i<=4&&(t||i<this.playerDistance(this.targetPlayer))&&s!==this.targetPlayer&&(this.targetPlayer=s,this.facePlayer(s),s===this.game.players[this.game.localPlayerID]&&(this.alertTicks=1),this.makeBigHitWarnings())}}}}else this.lookForPlayer()}},this.draw=t=>{this.dead||(s.Game.ctx.save(),s.Game.ctx.globalAlpha=this.alpha,this.dead||(this.updateDrawXY(t),this.tileX=33,this.tileY=12,(this.health<=1||this.cloned)&&(this.tileX=35,this.tileY=12,this.ticksSinceFirstHit>=3&&(this.flashingFrame+=.1*t,Math.floor(this.flashingFrame)%2==0&&(this.tileX=33))),this.frame+=.1*t,this.frame>=4&&(this.frame=0),this.hasShadow&&this.drawShadow(t),s.Game.drawMob(this.tileX,this.tileY+3*this.direction,2,3,this.x-this.drawX,this.y-1.5-this.drawY-this.jumpY,2,3,this.softShadeColor,this.shadeAmount(),void 0,this.outlineColor(),this.outlineOpacity()),this.cloned||(this.seenPlayer||this.drawSleepingZs(t,.5*o.GameConstants.TILESIZE,-1*o.GameConstants.TILESIZE),this.alertTicks>0&&this.drawExclamation(t,.5*o.GameConstants.TILESIZE,-1*o.GameConstants.TILESIZE))),s.Game.ctx.restore())},this.drawTopLayer=t=>{this.drawableY=this.y,this.healthBar.draw(t,this.health,this.maxHealth,this.x+.5,this.y-.5,!0)},this.w=2,this.h=2,this.ticks=0,this.frame=0,this.health=4,this.maxHealth=4,this.defaultMaxHealth=4,this.tileX=33,this.tileY=12,this.seenPlayer=!1,this.aggro=!1,this.unconscious=!1,this.ticksSinceFirstHit=0,this.flashingFrame=0,this.deathParticleColor="#ffffff",this.chainPushable=!1,this.name="giant skeleton",this.dropChance=1,this.drops=[],this.direction=s.Direction.DOWN,this.forwardOnlyAttack=!0,this.drawMoveSpeed=.9,this.canDestroyOthers=!0,l&&this.drops.push(l);const c=Math.floor(3*r.Random.rand())+2;for(;this.drops.length<c&&!this.cloned;)this.getDrop()}}e.BigSkullEnemy=l,l.difficulty=4,l.tileX=21,l.tileY=0},721:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.EarthWizardEnemy=e.WizardState=void 0;const s=i(7851),o=i(7180),a=i(1367),r=i(9467),n=i(263);var h;!function(t){t[t.idle=0]="idle",t[t.attack=1]="attack",t[t.justAttacked=2]="justAttacked",t[t.teleport=3]="teleport"}(h=e.WizardState||(e.WizardState={}));class l extends n.WizardEnemy{constructor(t,e,i,n,l){super(t,e,i,n),this.ATTACK_RADIUS=5,this.hit=()=>1,this.withinAttackingRangeOfPlayer=()=>{let t=!1;for(const e in this.game.players)(this.x-this.game.players[e].x)**2+(this.y-this.game.players[e].y)**2<=this.ATTACK_RADIUS**2&&(t=!0);return t},this.shuffle=t=>{let e,i,s;for(s=t.length-1;s>0;s--)e=Math.floor(r.Random.rand()*(s+1)),i=t[s],t[s]=t[e],t[e]=i;return t},this.behavior=()=>{if(this.lastX=this.x,this.lastY=this.y,!this.dead){if(this.handleSkipTurns())return;if(this.seenPlayer){if(this.seenPlayer)switch(this.alertTicks=Math.max(0,this.alertTicks-1),this.state){case h.attack:this.attemptProjectilePlacement([{x:-2,y:-2},{x:-2,y:-1},{x:-2,y:0},{x:-2,y:1},{x:-2,y:2},{x:2,y:-2},{x:2,y:-1},{x:2,y:0},{x:2,y:1},{x:2,y:2},{x:-1,y:-2},{x:0,y:-2},{x:1,y:-2},{x:-1,y:2},{x:0,y:2},{x:1,y:2}],a.WizardFireball,!1),this.state=h.justAttacked;break;case h.justAttacked:this.attemptProjectilePlacement([{x:-1,y:0},{x:1,y:0},{x:0,y:-1},{x:0,y:1},{x:-1,y:-1},{x:1,y:1},{x:1,y:-1},{x:-1,y:1}],a.WizardFireball,!1),this.state=h.idle;break;case h.teleport:let t,e=this.x,i=this.y,n=1e5,l=this.shuffle(this.room.getEmptyTiles());if(l=l.filter(t=>!this.room.projectiles.some(e=>e.x===t.x&&e.y===t.y)),0===l.length||0===Object.keys(this.game.players).length){this.state=h.idle;break}let c=s.Game.randTable([2,2,3,3,3,3,3],r.Random.rand),d=[];for(const t in this.game.players)d.push(t);let m=s.Game.randTable(d,r.Random.rand);if(!this.game.players[m]){this.state=h.idle;break}for(let e of l){let i=e,s=Math.abs(i.x-this.game.players[m].x)+Math.abs(i.y-this.game.players[m].y);Math.abs(s-c)<Math.abs(n-c)&&(n=s,t=i)}t||(t=l[0]),this.tryMove(t.x,t.y),this.drawX=this.x-e,this.drawY=this.y-i,this.frame=0,this.room.particles.push(new o.WizardTeleportParticle(e,i)),this.withinAttackingRangeOfPlayer()?this.state=h.attack:this.state=h.idle;break;case h.idle:this.state=h.teleport}}else this.lookForPlayer()}},this.draw=t=>{this.dead||(s.Game.ctx.save(),s.Game.ctx.globalAlpha=this.alpha,this.dead||(this.updateDrawXY(t),this.state===h.attack?this.tileX=38:this.tileX=37,this.hasShadow&&this.state!==h.idle&&this.drawShadow(t),this.frame>=0?(s.Game.drawMob(Math.floor(this.frame)+5,20,1,2,this.x,this.y-1.3,1,2,this.softShadeColor,this.shadeAmount()),this.frame+=.4*t,this.frame>12&&(this.frame=-1)):s.Game.drawMob(this.tileX,this.tileY,1,2,this.x-this.drawX,this.y-1.3-this.drawY,1,2,this.softShadeColor,this.shadeAmount(),void 0,this.outlineColor(),this.outlineOpacity()),this.cloned||(this.seenPlayer||this.drawSleepingZs(t),this.alertTicks>0&&this.drawExclamation(t))),s.Game.ctx.restore())},this.ticks=0,this.health=1,this.maxHealth=1,this.defaultMaxHealth=1,this.tileX=35,this.tileY=8,this.frame=0,this.state=h.attack,this.seenPlayer=!1,this.alertTicks=0,this.name="earth wizard",this.projectileColor=[0,200,0],l&&(this.drop=l),this.jumpHeight=.5,this.getDrop(["weapon","equipment","consumable","tool","coin"])}}e.EarthWizardEnemy=l,l.difficulty=3,l.tileX=37,l.tileY=8},734:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Pool=void 0;const s=i(7851),o=i(8132),a=i(2571);class r extends o.Tile{constructor(t,e,i,o,r,n,h){super(t,e,i),this.interact=()=>{this.room.game.pushMessage("You jump into the pool.")},this.isSolid=()=>!0,this.canCrushEnemy=()=>!0,this.draw=t=>{s.Game.drawTile(1,this.skin,1,1,this.x,this.y,1,1,this.room.shadeColor,this.shadeAmount()),this.topEdge&&s.Game.drawTile(22,3,1,2,this.x,this.y,1,2,this.room.shadeColor,this.shadeAmount()),s.Game.drawTile(this.tileX,this.tileY,1,1,this.x,this.y,1,1,this.room.shadeColor,this.shadeAmount())},this.tileX=20,this.tileY=4,o?this.tileX--:r&&this.tileX++,n?this.tileY--:h&&this.tileY++,this.topEdge=n,(r||o||n||h)&&this.room.entities.push(new a.FishingSpot(this.room,this.room.game,this.x,this.y))}}e.Pool=r},752:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.TextBox=void 0;const s=i(2502);e.TextBox=class{constructor(t){this.allowedCharacters="all",this.message="",this.currentMessageIndex=-1,this.MAX_HISTORY=50,this.handleKeyPress=t=>{const e="abcdefghijklmnopqrstuvwxyz1234567890,.!?:'()[]%-/+ ".split("");if(1===t.length)return t=t.toLowerCase(),void(e.includes(t)&&("all"===this.allowedCharacters||this.allowedCharacters.includes(t))&&(this.text=this.text.substring(0,this.cursor)+t+this.text.substring(this.cursor,this.text.length),this.cursor+=1,this.updateElement(),this.message=this.message.substring(0,this.cursor-1)+t+this.message.substring(this.cursor-1,this.message.length)));switch(t){case"Backspace":this.cursor>0&&(this.text=this.text.substring(0,this.cursor-1)+this.text.substring(this.cursor,this.text.length),this.cursor=Math.max(0,this.cursor-1),this.updateElement(),this.message=this.message.substring(0,this.cursor)+this.message.substring(this.cursor+1,this.message.length));break;case"Delete":this.cursor<this.text.length&&(this.text=this.text.substring(0,this.cursor)+this.text.substring(this.cursor+1,this.text.length),this.updateElement(),this.message=this.message.substring(0,this.cursor)+this.message.substring(this.cursor+1,this.message.length));break;case"ArrowLeft":this.cursor=Math.max(0,this.cursor-1),this.updateCursorPosition();break;case"ArrowRight":this.cursor=Math.min(this.text.length,this.cursor+1),this.updateCursorPosition();break;case"ArrowUp":this.sentMessages.length>0&&this.currentMessageIndex<this.sentMessages.length-1&&(this.currentMessageIndex++,this.text=this.sentMessages[this.sentMessages.length-1-this.currentMessageIndex],this.updateElement(),this.message=this.text);break;case"ArrowDown":this.currentMessageIndex>0?(this.currentMessageIndex--,this.text=this.sentMessages[this.sentMessages.length-1-this.currentMessageIndex],this.updateElement(),this.message=this.text):0===this.currentMessageIndex&&(this.currentMessageIndex=-1,this.clear());break;case"Enter":this.sendMessage(),this.escapeCallback();break;case"Escape":this.escapeCallback()}},this.handleTouchStart=t=>{this.focus(),t.preventDefault()},this.text="",this.cursor=0,this.enterCallback=()=>{},this.escapeCallback=()=>{},this.element=t,this.sentMessages=[];const e=this.element;e&&"INPUT"===e.tagName&&(this.handleInputEventBound=t=>this.handleDomInput(t),this.handleKeydownEventBound=t=>this.handleDomKeydown(t),e.addEventListener("input",this.handleInputEventBound,!1),e.addEventListener("keydown",this.handleKeydownEventBound,!1))}setEnterCallback(t){this.enterCallback=t}setEscapeCallback(t){this.escapeCallback=t}clear(){this.text="",this.cursor=0,this.message="",this.updateElement();const t=this.element;t&&"INPUT"===t.tagName&&(t.value="")}focus(){const t=this.element;if(!t)return;const e={position:t.style.position,left:t.style.left,right:t.style.right,top:t.style.top,bottom:t.style.bottom,width:t.style.width,height:t.style.height,opacity:t.style.opacity,zIndex:t.style.zIndex,pointerEvents:t.style.pointerEvents};t.style.position="fixed",t.style.left="8px",t.style.bottom="40px",t.style.top="",t.style.right="",t.style.width="1px",t.style.height="1px",t.style.opacity="0.01",t.style.zIndex="9999",t.style.pointerEvents="auto";try{if(t.focus(),"function"==typeof t.setSelectionRange){const e=t.value?.length??0;t.setSelectionRange(e,e)}}catch{}const i=()=>{t.style.position=e.position,t.style.left=e.left,t.style.right=e.right,t.style.top=e.top,t.style.bottom=e.bottom,t.style.width=e.width,t.style.height=e.height,t.style.opacity=e.opacity,t.style.zIndex=e.zIndex,t.style.pointerEvents=e.pointerEvents,t.removeEventListener("blur",i)};t.addEventListener("blur",i)}blur(){const t=this.element;try{t.blur()}catch{}}handleDomInput(t){const e=t.target,i=e?.value??"";this.text=i,this.message=i,this.cursor=i.length,this.updateElement()}handleDomKeydown(t){const e=t.key;if("Backspace"===e||"Delete"===e||"Enter"===e||"Escape"===e||"ArrowLeft"===e||"ArrowRight"===e||"ArrowUp"===e||"ArrowDown"===e){t.preventDefault(),this.handleKeyPress(e);const i=this.element;i&&"INPUT"===i.tagName&&(i.value=this.text)}}sendMessage(){let t=this.message.trim();t&&(this.sentMessages.push(t),this.sentMessages.length>this.MAX_HISTORY&&this.sentMessages.shift(),s.globalEventBus.emit("ChatMessageSent",t),console.log(this.sentMessages),this.enterCallback(),t.startsWith("/")&&(t=t.substring(1),s.globalEventBus.emit("ChatCommand",t)),this.clear(),this.currentMessageIndex=-1)}updateElement(){const t=this.element;t&&"INPUT"===t.tagName?t.value=this.text:this.element.textContent=this.text}updateCursorPosition(){}}},783:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Backpack=void 0;const s=i(7366),o=i(5180);class a extends o.Usable{constructor(t,e,i){super(t,e,i),this.onUse=t=>{this.level.game.rooms[t.levelID]===this.level.game.room&&s.Sound.playBackpack(),t.inventory.removeItem(this),t.inventory.expansion+=1,this.level.game.pushMessage("You equip the backpack, increasing the amount you can carry.")},this.getDescription=()=>"BACKPACK\nA normal looking backpack. Increases the amount you can carry. ",this.tileX=4,this.tileY=0,this.offsetY=0,this.name=a.itemName}}e.Backpack=a,a.itemName="backpack"},788:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.FountainTile=void 0;const s=i(7851),o=i(8132);class a extends o.Tile{constructor(t,e,i,o,a){super(t,e,i),this.isSolid=()=>!0,this.canCrushEnemy=()=>!0,this.draw=t=>{s.Game.drawTile(1,this.skin,1,1,this.x,this.y,1,1,this.room.shadeColor,this.shadeAmount()),s.Game.drawTile(this.subTileX,2+this.subTileY,1,1,this.x,this.y,1,1,this.room.shadeColor,this.shadeAmount())},this.subTileX=o,this.subTileY=a}}e.FountainTile=a},824:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Particle=void 0;const s=i(8160),o=i(6291);class a extends s.Drawable{constructor(){super(...arguments),this.worldZ=0,this.drawTopLayer=t=>{},this.shadeAmount=()=>{if(o.GameConstants.SMOOTH_LIGHTING&&!o.GameConstants.SHADE_INLINE_IN_ENTITY_LAYER)return 0;const t=Math.floor(this.x),e=Math.floor(this.y);return this.room.softVis[t]?this.room.softVis[t][e]??.9:.9},this.shadeColor=()=>this.room.shadeColor}}e.Particle=a},846:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.GreenPotion=void 0;const s=i(7366),o=i(5180);class a extends o.Usable{constructor(t,e,i){super(t,e,i),this.onUse=t=>{t.health=Math.min(t.maxHealth,t.health+1),this.level.game.rooms[t.levelID]===this.level.game.room&&s.Sound.heal(),t.inventory.removeItem(this)},this.getDescription=()=>"GREEN POTION\nRestores 1 heart",this.tileX=7,this.tileY=0,this.offsetY=-.3}}e.GreenPotion=a},920:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Scythe=void 0;const s=i(4052),o=i(7366),a=i(7851);class r extends s.Weapon{constructor(t,e,i){super(t,e,i),this.hitSound=()=>{o.Sound.swing(),o.Sound.playSlice()},this.weaponMove=(t,e)=>{let i=[];switch(this.wielder.direction){case a.Direction.DOWN:i=[{x:t-1,y:e},{x:t+1,y:e},{x:t-1,y:e-1},{x:t+1,y:e-1}];break;case a.Direction.UP:i=[{x:t+1,y:e},{x:t-1,y:e},{x:t+1,y:e+1},{x:t-1,y:e+1}];break;case a.Direction.LEFT:i=[{x:t,y:e+1},{x:t,y:e-1},{x:t+1,y:e+1},{x:t+1,y:e-1}];break;case a.Direction.RIGHT:i=[{x:t,y:e-1},{x:t,y:e+1},{x:t-1,y:e-1},{x:t-1,y:e+1}]}if(this.checkForPushables(t,e))return!0;this.beginSwing();const s=this.executeAttack(t,e,!0,this.damage+this.wielder.damageBonus,!0,!0,!0,!1);if(s){if(i.length>0)for(const t of i)(this.wielder?.getRoom?this.wielder.getRoom():this.game.rooms[this.wielder.levelID]).roomArray[t.x][t.y].isSolid()||this.hitEntitiesAt(t.x,t.y,this.damage+this.wielder.damageBonus);(this.wielder?.getRoom?this.wielder.getRoom():this.game.rooms[this.wielder.levelID]).tick(this.wielder)}return this.endSwing(),!s},this.shakeScreen=()=>{setTimeout(()=>{switch(this.wielder.direction){case a.Direction.DOWN:case a.Direction.UP:this.game.shakeScreen(0,-5,!1);break;case a.Direction.LEFT:this.game.shakeScreen(-5,-5,!1);break;case a.Direction.RIGHT:this.game.shakeScreen(5,-5,!1)}},this.hitDelay)},this.tileX=23,this.tileY=2,this.damage=1,this.name="scythe",this.hitDelay=150,this.useCost=2,this.offsetY=0,this.iconOffset=.2,this.degradeable=!1,this.twoHanded=!0}}e.Scythe=r,r.itemName="scythe"},995:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Greataxe=void 0;const s=i(4052),o=i(7366),a=i(7851);class r extends s.Weapon{constructor(t,e,i){super(t,e,i),this.hitSound=()=>{o.Sound.swing(),o.Sound.playWarHammer()},this.adjustedDamage=()=>{let t=this.wielder?.health/this.wielder?.maxHealth,e=1;return t<=1&&(e=1),t<=.75&&(e=2),t<=.5&&(e=4),t<=.25&&(e=8),e},this.attack=t=>{t.hurt(this.wielder,this.adjustedDamage()),this.statusEffect(t)},this.shakeScreen=()=>{this.wielder.beginSlowMotion(),setTimeout(()=>{switch(this.wielder.endSlowMotion(),this.wielder.direction){case a.Direction.DOWN:case a.Direction.UP:this.game.shakeScreen(0,-10*this.adjustedDamage(),!1);break;case a.Direction.LEFT:this.game.shakeScreen(-5,-10*this.adjustedDamage(),!1);break;case a.Direction.RIGHT:this.game.shakeScreen(5,-10*this.adjustedDamage(),!1)}},this.hitDelay)},this.tileX=24,this.tileY=2,this.damage=2,this.name="greataxe",this.hitDelay=225,this.offsetY=0,this.iconOffset=.2,this.durability=25,this.durabilityMax=25,this.useCost=5,this.twoHanded=!0}}e.Greataxe=r,r.itemName="greataxe"},1040:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.PawnEnemy=void 0;const s=i(7851),o=i(7455),a=i(6986),r=i(6199),n=i(2502);class h extends a.Enemy{constructor(t,e,i,a,h){super(t,e,i,a),this.hit=()=>this.damage,this.lookForPlayer=(t=!0)=>{if(this.seenPlayer)return;const e=this.nearestPlayer();if(!1===e)return;const[i,s]=e;i>this.alertRange||(this.targetPlayer=s,t&&this.facePlayer(s),this.seenPlayer=!0,n.globalEventBus.emit("EnemySeenPlayer",{enemyType:this.constructor.name,enemyName:this.name}),s===this.game.players[this.game.localPlayerID]&&(this.alertTicks=1),this.conditionalHitWarnings())},this.behavior=()=>{if(this.lastX=this.x,this.lastY=this.y,!this.dead){if(this.handleSkipTurns())return;if(this.ticks++,this.seenPlayer){if(this.seenPlayer){if(this.room.playerTicked===this.targetPlayer){this.alertTicks=Math.max(0,this.alertTicks-1);let t=this.x,e=this.y,i=Array();for(const t of this.room.entities)t!==this&&i.push({x:t.x,y:t.y});for(let t=this.x-1;t<=this.x+1;t++)for(let e=this.y-1;e<=this.y+1;e++)this.room.roomArray[t][e]instanceof o.SpikeTrap&&this.room.roomArray[t][e].on&&i.push({x:t,y:e});const s=this.targetPlayer.x-this.x,a=this.targetPlayer.y-this.y;if(1===Math.abs(s)&&1===Math.abs(a)&&!this.unconscious)return this.targetPlayer.hurt(this.hit(),this.name),this.drawX=.5*(this.x-this.targetPlayer.x),this.drawY=.5*(this.y-this.targetPlayer.y),this.targetPlayer===this.game.players[this.game.localPlayerID]&&this.game.shakeScreen(10*this.drawX,10*this.drawY),void this.conditionalHitWarnings();if(this.justHurt)this.justHurt=!1;else if(!this.unconscious){const s=this.searchPathLocalized(this.targetPlayer,i,{useLastPlayerPos:!0,allowOmni:!0});if(s.length>0){const i=s[0].pos.x,a=s[0].pos.y,r=this.targetPlayer.x===i&&this.targetPlayer.y===a,n=this.room.roomArray[i]?.[a],h=n instanceof o.SpikeTrap&&n.on;r||h||(this.tryMove(i,a),this.setDrawXY(t,e))}this.conditionalHitWarnings()}}let t=-1!==Object.values(this.game.offlinePlayers).indexOf(this.targetPlayer);if(!this.aggro||t){let e=this.nearestPlayer();if(!1!==e){let[i,s]=e;i<=4&&(t||i<this.playerDistance(this.targetPlayer))&&s!==this.targetPlayer&&(this.targetPlayer=s,this.facePlayer(s),s===this.game.players[this.game.localPlayerID]&&(this.alertTicks=1),this.conditionalHitWarnings())}}}}else{let t=this.nearestPlayer();if(!1!==t){let[e,i]=t;e<=4&&(this.targetPlayer=i,this.facePlayer(i),this.seenPlayer=!0,i===this.game.players[this.game.localPlayerID]&&(this.alertTicks=1),this.conditionalHitWarnings())}}}},this.conditionalHitWarnings=()=>{const t=r.Utils.distance(this.x,this.y,this.targetPlayer.x,this.targetPlayer.y);(t>=2||!this.targetPlayer)&&this.makeHitWarnings(void 0,void 0,!0,"orthogonal"),t<3&&this.targetPlayer&&this.makeHitWarnings()},this.draw=t=>{this.dead||(s.Game.ctx.save(),s.Game.ctx.globalAlpha=this.alpha,this.dead||(this.updateDrawXY(t),this.frame+=.1*t,this.frame>=4&&(this.frame=0),this.hasShadow&&this.drawShadow(t),s.Game.drawMob(this.tileX+Math.floor(this.frame),this.tileY,1,2,this.x-this.drawX,this.y-this.drawYOffset-this.drawY-this.jumpY,1,2,this.softShadeColor,this.shadeAmount(),void 0,this.outlineColor(),this.outlineOpacity())),this.cloned||(this.seenPlayer||this.drawSleepingZs(t),this.alertTicks>0&&this.drawExclamation(t)),s.Game.ctx.restore())},this.ticks=0,this.frame=0,this.health=1,this.maxHealth=1,this.defaultMaxHealth=1,this.tileX=23,this.tileY=12,this.seenPlayer=!1,this.aggro=!1,this.name="pawn",this.orthogonalAttack=!1,this.diagonalAttack=!0,this.jumpHeight=.5,h&&(this.drop=h),this.armored=!0,this.getDrop(["weapon","equipment","consumable","tool","coin"])}}e.PawnEnemy=h,h.difficulty=4,h.tileX=51,h.tileY=8},1073:(t,e)=>{"use strict";var i;Object.defineProperty(e,"__esModule",{value:!0}),e.getEnvTypeName=e.EnvType=void 0,function(t){t[t.DUNGEON=0]="DUNGEON",t[t.CAVE=1]="CAVE",t[t.FOREST=2]="FOREST",t[t.CASTLE=3]="CASTLE",t[t.GLACIER=4]="GLACIER",t[t.DARK_CASTLE=5]="DARK_CASTLE",t[t.PLACEHOLDER=6]="PLACEHOLDER",t[t.DESERT=7]="DESERT",t[t.MAGMA_CAVE=8]="MAGMA_CAVE",t[t.DARK_DUNGEON=9]="DARK_DUNGEON",t[t.TUTORIAL=10]="TUTORIAL",t[t.FLOODED_CAVE=11]="FLOODED_CAVE"}(i=e.EnvType||(e.EnvType={})),e.getEnvTypeName=t=>{switch(t){case i.DUNGEON:return"DUNGEON";case i.CAVE:return"CAVE";case i.FOREST:return"FOREST";case i.CASTLE:return"CASTLE";case i.GLACIER:return"GLACIER";case i.DARK_CASTLE:return"DARK_CASTLE";case i.PLACEHOLDER:return"PLACEHOLDER";case i.DESERT:return"DESERT";case i.MAGMA_CAVE:return"MAGMA_CAVE";case i.DARK_DUNGEON:return"DARK_DUNGEON";case i.TUTORIAL:return"TUTORIAL";case i.FLOODED_CAVE:return"FLOODED_CAVE"}}},1085:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.astar=void 0;const s=i(7851),o=i(3436),a=i(9467);!function(t){let e;!function(t){t[t.WALL=0]="WALL",t[t.OPEN=1]="OPEN"}(e=t.GraphNodeType||(t.GraphNodeType={}));let i=t=>t?t.isSolid()||t.isDoor||t instanceof o.DownLadder?99999999:300:99999999;t.Graph=class{constructor(t){this.elements=t;for(var e,i,s=[],o=t.length,a=0;a<o;++a){i=(e=t[a]).length,s[a]=new Array(i);for(var n=0;n<i;++n)s[a][n]=new r(a,n,e[n])}this.nodes=s}toString(){for(var t,e,i,s,o="\n",a=this.nodes,r=0,n=a.length;r<n;){for(t="",i=0,s=(e=a[r++]).length;i<s;)t+=e[i++].type+" ";o=o+t+"\n"}return o}};class r{constructor(t,e,i){this.data={},this.x=t,this.y=e,this.pos={x:t,y:e},this.type=i}toString(){return"["+this.x+" "+this.y+"]"}isWall(){return this.type==e.WALL}}t.GraphNode=r;class n{constructor(t){this.content=[],this.scoreFunction=t}push(t){this.content.push(t),this.sinkDown(this.content.length-1)}pop(){var t=this.content[0],e=this.content.pop();return this.content.length>0&&(this.content[0]=e,this.bubbleUp(0)),t}remove(t){var e=this.content.indexOf(t),i=this.content.pop();e!==this.content.length-1&&(this.content[e]=i,this.scoreFunction(i)<this.scoreFunction(t)?this.sinkDown(e):this.bubbleUp(e))}size(){return this.content.length}rescoreElement(t){this.sinkDown(this.content.indexOf(t))}sinkDown(t){for(var e=this.content[t];t>0;){var i=(t+1>>1)-1,s=this.content[i];if(!(this.scoreFunction(e)<this.scoreFunction(s)))break;this.content[i]=e,this.content[t]=s,t=i}}bubbleUp(t){for(var e=this.content.length,i=this.content[t],s=this.scoreFunction(i);;){var o=t+1<<1,a=o-1,r=null;if(a<e){var n=this.content[a],h=this.scoreFunction(n);h<s&&(r=a)}if(o<e){var l=this.content[o];this.scoreFunction(l)<(null===r?s:h)&&(r=o)}if(null===r)break;this.content[t]=this.content[r],this.content[r]=i,t=r}}}t.BinaryHeap=n;class h{constructor(t,e,s,o){this.grid=[];for(var a=0,r=t.length;a<r;a++){this.grid[a]=[];for(var n=0,h=t[a].length;n<h;n++){var l=i(t[a][n]);this.grid[a][n]={org:t[a][n],f:0,g:0,h:0,cost:l,visited:!1,closed:!1,pos:{x:a,y:n},parent:null}}}if(void 0!==e)for(var c=0;c<e.length;c++)e[c].x>=0&&e[c].x<this.grid.length&&e[c].y>=0&&e[c].y<this.grid[0].length&&(this.grid[e[c].x][e[c].y].cost=99999999);s&&s.x>=0&&s.x<this.grid.length&&s.y>=0&&s.y<this.grid[0].length&&(this.grid[s.x][s.y].cost=.5)}heap(){return new n(function(t){return t.f})}_find(t){for(var e=0;e<this.grid.length;e++)for(var i=0;i<this.grid[e].length;i++)if(this.grid[e][i].org==t)return this.grid[e][i]}_search(t,e,i,o,a,r,n,l,c){n=n||this.manhattan,i=!!i,o=!!o,a=!!a,l=!!l;var d,m,u=this.heap();if(d=void 0!==t.x&&void 0!==t.y?this.grid[t.x][t.y]:this._find(t),m=void 0!==e.x&&void 0!==e.y?this.grid[e.x][e.y]:this._find(e),0==h.NO_CHECK_START_POINT&&d.cost<=0)return[];for(u.push(d);u.size()>0;){var p=u.pop();if(p===m){for(var y=p,g=[];y.parent;)g.push(y),y=y.parent;return g.reverse()}p.closed=!0;for(var f=this.neighbors(p,i,o,l),w=0,E=f.length;w<E;w++){var x=f[w];if(!(x.closed||x.cost<=0)){var b=p.g+x.cost;if(a){var T=!1;p.parent?T=!(p.parent.pos.x===p.pos.x&&p.pos.x===x.pos.x||p.parent.pos.y===p.pos.y&&p.pos.y===x.pos.y):(T=!0,x.pos.x-p.pos.x===0&&x.pos.y-p.pos.y===-1&&r===s.Direction.UP&&(T=!1),x.pos.x-p.pos.x===0&&x.pos.y-p.pos.y===1&&r===s.Direction.DOWN&&(T=!1),x.pos.x-p.pos.x===1&&x.pos.y-p.pos.y===0&&r===s.Direction.RIGHT&&(T=!1),x.pos.x-p.pos.x===-1&&x.pos.y-p.pos.y===0&&r===s.Direction.LEFT&&(T=!1)),T&&b++}var I=x.visited;(!I||b<x.g)&&(x.visited=!0,x.parent=p,x.h=x.h||n(x.pos,m.pos,c),x.g=b,x.f=x.g+x.h,I?u.rescoreElement(x):u.push(x))}}}return[]}static search(t,e,i,s,o,a,r,n,l,c,d){return new h(t,s,d)._search(e,i,o,a,r,n,l,c)}manhattan(t,e){return Math.abs(e.x-t.x)+Math.abs(e.y-t.y)}neighbors(t,e,i,s){var o=this.grid,r=[],n=t.pos.x,h=t.pos.y;if(i||(o[n-1]&&o[n-1][h]&&r.push(o[n-1][h]),o[n+1]&&o[n+1][h]&&r.push(o[n+1][h]),o[n]&&o[n][h-1]&&r.push(o[n][h-1]),o[n]&&o[n][h+1]&&r.push(o[n][h+1])),e&&(o[n-1]&&o[n-1][h-1]&&r.push(o[n-1][h-1]),o[n+1]&&o[n+1][h-1]&&r.push(o[n+1][h-1]),o[n-1]&&o[n-1][h+1]&&r.push(o[n-1][h+1]),o[n+1]&&o[n+1][h+1]&&r.push(o[n+1][h+1])),s){const t=a.Random.rand()<.5;return o[n-1]&&o[n-1][h]?1==t?void r.push(o[n-1][h-1]):void r.push(o[n-1][h+1]):o[n+1]&&o[n+1][h]?1==t?void r.push(o[n+1][h-1]):void r.push(o[n+1][h+1]):o[n]&&o[n][h-1]?1==t?void r.push(o[n-1][h-1]):void r.push(o[n+1][h-1]):o[n]&&o[n][h+1]?1==t?void r.push(o[n-1][h+1]):void r.push(o[n+1][h+1]):void 0}return r}}h.NO_CHECK_START_POINT=!1,t.AStar=h}(e.astar||(e.astar={}))},1096:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.TallSucculent=void 0;const s=i(606),o=i(7851),a=i(606),r=i(9467);class n extends s.Entity{constructor(t,e,i,s){super(t,e,i,s),this.draw=t=>{this.dead||(o.Game.ctx.save(),o.Game.ctx.globalAlpha=this.alpha,this.dead||(this.hasShadow&&this.drawShadow(t),this.updateDrawXY(t),this.frame+=.075*t,this.frame>8&&(this.frame=0),o.Game.drawObj(this.tileX+Math.floor(this.frame),this.tileY,1,3,this.x-this.drawX,this.y-this.drawYOffset-this.drawY,1,3,this.room.shadeColor,this.shadeAmount())),o.Game.ctx.restore())},this.drawTopLayer=t=>{this.drawableY=this.y},this.room=t,this.health=1,this.tileX=13,this.tileY=12,this.hasShadow=!0,this.chainPushable=!1,this.name="tall succulent",this.imageParticleX=0,this.imageParticleY=28,this.drawYOffset=2.175,this.frame=Math.floor(8*r.Random.rand())}get type(){return a.EntityType.PROP}}e.TallSucculent=n},1103:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.VendingMachine=void 0;const s=i(7851),o=i(606),a=i(1236),r=i(1199),n=i(5614),h=i(6291),l=i(7512),c=i(2270),d=i(4918),m=i(8243),u=i(521),p=i(2268),y=i(66),g=i(1470),f=i(606),w=i(9467),E=i(9058),x=i(5196),b=i(3785),T=i(8149),I=i(9915),S=i(6199),v=i(4937),A=i(1444),M=i(783);let C="white";class D extends o.Entity{constructor(t,e,i,o,f){super(t,e,i,o),this.open=!1,this.openTime=0,this.isInf=!1,this.quantity=1,this.buyAnimAmount=0,this.setCost=(t=1,e,i,o=1)=>{if(e&&i){const t=s.Game.randTable(i,w.Random.rand),o=s.Game.randTable(e,w.Random.rand);o.stackCount=t,this.costItems=[o]}else{const e=[new u.BlueGem(this.room,0,0),new n.GreenGem(this.room,0,0),new g.RedGem(this.room,0,0),new a.Coin(this.room,0,0)],i=s.Game.randTable(e,w.Random.rand);i instanceof a.Coin?i.stackCount=s.Game.randTable([20,25,30],w.Random.rand):i.stackCount=s.Game.randTable([1,2,3],w.Random.rand),i.stackCount*=t,this.costItems=[i]}this.quantity=o},this.hoverText=()=>this.open?this.quantity>0?`Buy ${this.item.name}`:"Out of stock":"Vending Machine",this.interact=t=>{if(this.isInf||this.quantity>0){this.open&&(this.playerOpened.openVendingMachine=null),this.open=!0,this.playerOpened=t,this.openTime=Date.now(),this.playerOpened.openVendingMachine&&this.playerOpened.openVendingMachine!==this&&this.playerOpened.openVendingMachine.close(),this.playerOpened.openVendingMachine=this;try{if(this.playerOpened===this.game.players[this.game.localPlayerID]&&this.game?.tutorialFlags&&!1===this.game.tutorialFlags.purchasedFromVendingMachine){const t=()=>{const t=h.GameConstants.WIDTH/2,e=h.GameConstants.HEIGHT/2,i=(this.x-this.playerOpened.x)*h.GameConstants.TILESIZE,s=(this.y-this.playerOpened.y)*h.GameConstants.TILESIZE,o=t+i-this.playerOpened.drawX,a=e+s-this.playerOpened.drawY,r=20*(this.costItems.length+2)- -2,n=o,l=a-2*h.GameConstants.TILESIZE,c=this.costItems.length;return{x:Math.round(n-.5*r+20*c)+2,y:Math.round(l-11)+2,w:18,h:18}},e=this.game.isMobile?"Tap or press space to buy":"Click or press space to buy";this.game.addPointer({id:"vm-buy-pointer",text:e,resolver:t,until:()=>!this.open,safety:[()=>!0===this.playerOpened?.dead],arrowDirection:"down",textDy:-2,timeoutMs:15e3,tags:["tutorial"],zIndex:10})}}catch{}}},this.close=()=>{this.open=!1,this.playerOpened.openVendingMachine=null},this.space=()=>{if(this.open){for(const t of this.costItems)if(!this.playerOpened.inventory.hasItemCount(t)){let e=0;t instanceof a.Coin?e=this.playerOpened.inventory.coinCount():this.playerOpened.inventory.items.forEach(i=>{i instanceof t.constructor&&(e+=i.stackCount)});const i=this.costItems[0].stackCount-e,s=this.costItems[0].stackCount>1?"s":"";return void this.game.pushMessage(`You need ${i} more ${this.costItems[0].constructor.itemName}${s} to buy that. `)}let t=new this.item.constructor(this.room,this.x,this.y);if(!this.playerOpened.inventory.addItem(t))return void this.game.pushMessage("Your inventory is full. Cannot purchase the item.");for(const t of this.costItems)this.playerOpened.inventory.subtractItemCount(t);const e=this.costItems[0].stackCount,i=e>1?"s":"";this.isInf||(this.quantity--,this.quantity<=0&&this.close()),this.game.pushMessage(`Purchased ${t.constructor.itemName} for ${e} ${this.costItems[0].constructor.itemName}${i}`),this.game.pushMessage(`${this.quantity} available to buy.`);try{this.playerOpened===this.game.players[this.game.localPlayerID]&&this.game?.tutorialFlags&&(this.game.tutorialFlags.purchasedFromVendingMachine=!0)}catch{}this.buyAnimAmount=.99,this.playerOpened===this.game.players[this.game.localPlayerID]&&this.game.shakeScreen(0,4)}},this.draw=t=>{let e=19;this.isInf||0!==this.quantity||(e=20),this.hasShadow&&this.drawShadow(t),s.Game.drawObj(e,0,1,2,this.x,this.y-1,1,2,this.room.shadeColor,this.shadeAmount())},this.drawTopLayer=t=>{if(this.open&&this.playerOpened.inventory.isOpen)this.close();else if(this.drawableY=this.y,this.open&&this.playerOpened===this.game.players[this.game.localPlayerID]){let e=Math.min(18,18*(Date.now()-this.openTime)/150),i=2,o=-2,a=1,r=(this.costItems.length+2)*(e+2*i+o)-o,n=e+2*i+o-o,l=(this.x+.5)*h.GameConstants.TILESIZE,c=(this.y-1.5)*h.GameConstants.TILESIZE;s.Game.ctx.fillStyle=C,s.Game.ctx.fillRect(Math.round(l-.5*r)-a,Math.round(c-.5*n)-a,Math.round(r+2*a),Math.round(n+2*a));for(let t=0;t<this.costItems.length+2;t++)s.Game.ctx.fillStyle="#292c36",s.Game.ctx.fillRect(Math.round(l-.5*r+t*(e+2*i+o)),Math.round(c-.5*n),Math.round(e+2*i),Math.round(e+2*i)),t!==this.costItems.length&&(s.Game.ctx.fillStyle="#5a595b",s.Game.ctx.fillRect(Math.round(l-.5*r+t*(e+2*i+o)+i),Math.round(c-.5*n+i),Math.round(e),Math.round(e)));if(Date.now()-this.openTime>=150)for(let a=0;a<this.costItems.length+2;a++){let d=Math.round(l-.5*r+a*(e+2*i+o)+i+Math.floor(.5*e)-.5*h.GameConstants.TILESIZE),m=Math.round(c-.5*n+i+Math.floor(.5*e)-.5*h.GameConstants.TILESIZE),u=d/h.GameConstants.TILESIZE,p=m/h.GameConstants.TILESIZE;if(a<this.costItems.length){let e=1;this.playerOpened.inventory.hasItemCount(this.costItems[a])||(e=.15),this.costItems[a].drawIcon(t,u,p,e)}else a===this.costItems.length?s.Game.drawFX(2,0,1,1,u,p,1,1):a===this.costItems.length+1&&this.item.drawIcon(t,u,p,1,this.quantity)}this.buyAnimAmount*=this.buyAnimAmount,h.GameConstants.ALPHA_ENABLED&&(s.Game.ctx.globalAlpha=this.buyAnimAmount),s.Game.ctx.fillStyle=C,s.Game.ctx.fillRect(Math.round(l-.5*r)-a,Math.round(c-.5*n)-a,Math.round(r+2*a),Math.round(n+2*a)),s.Game.ctx.globalAlpha=1}},this.destroyable=!1,this.pushable=!1,this.chainPushable=!1,this.interactable=!0,this.costItems=[],this.item=f,this.name="vending machine",this.item instanceof l.Shotgun?this.setCost(3):this.item instanceof d.Heart?this.setCost(1,[new a.Coin(t,0,0)],[9,10,11],2):this.item instanceof m.Spear?this.setCost(2):this.item instanceof c.Armor?this.setCost(3,[new a.Coin(t,0,0)],[S.Utils.randomNormalInt(450,950)]):this.item instanceof p.DualDagger?this.setCost(3):this.item instanceof y.Lantern?this.setCost(1,[new a.Coin(t,0,0)],[S.Utils.randomNormalInt(350,750)]):this.item instanceof E.Warhammer?this.setCost(2):this.item instanceof b.Spellbook?this.setCost(3):this.item instanceof x.Torch?this.setCost(2):this.item instanceof T.Candle?this.setCost(1,[new a.Coin(t,0,0)],[9,10,11],2):this.item instanceof I.Pickaxe?this.setCost(1,[new a.Coin(t,0,0)],[S.Utils.randomNormalInt(15,25)]):this.item instanceof v.FishingRod?this.setCost(1,[new a.Coin(t,0,0)],[S.Utils.randomNormalInt(25,40)]):this.item instanceof A.Hammer?this.setCost(1,[new a.Coin(t,0,0)],[S.Utils.randomNormalInt(15,25)]):this.item instanceof M.Backpack?this.setCost(1,[new a.Coin(t,0,0)],[S.Utils.randomNormalInt(150,250)]):this.item instanceof r.Coal&&this.setCost(1,[new a.Coin(t,0,0)],[S.Utils.randomNormalInt(3,7)],S.Utils.randomNormalInt(5,25))}get type(){return f.EntityType.PROP}}e.VendingMachine=D,D.isPointInVendingMachineBounds=(t,e,i)=>{if(!i.open||i!==i.playerOpened?.openVendingMachine)return!1;const s=h.GameConstants.WIDTH/2,o=h.GameConstants.HEIGHT/2,a=s+(i.x-i.playerOpened.x)*h.GameConstants.TILESIZE,r=o+(i.y-i.playerOpened.y)*h.GameConstants.TILESIZE;let n=20*(i.costItems.length+2)- -2,l=a,c=r-2*h.GameConstants.TILESIZE;const d=Math.round(l-.5*n),m=d+Math.round(n),u=Math.round(c-11),p=u+Math.round(22);return t>=d&&t<=m&&e>=u&&e<=p}},1124:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Lighting=void 0;const s=i(2103),o=i(1285);class a{}e.Lighting=a,a.momentaryLight=(t,e,i,s,r,n,h,l)=>{if(!1===t.isTileOnScreen(e,i,o.LevelConstants.LIGHTING_MAX_DISTANCE))return;const c=a.newLightSource(e,i,r,s,h);setTimeout(()=>{t.updateLightSources(c),setTimeout(()=>{t.updateLightSources(c,!0)},n)},l)},a.newLightSource=(t,e,i,o,a)=>new s.LightSource(t,e,o,i,a),a.addLightSource=(t,e)=>{t.lightSources.push(e)},a.removeLightSource=(t,e)=>{t.lightSources=t.lightSources.filter(t=>t!==e)}},1144:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Spike=void 0;const s=i(7851),o=i(8132);class a extends o.Tile{constructor(){super(...arguments),this.onCollide=t=>{t.hurt(1,"spike")},this.draw=t=>{s.Game.drawTile(11,0,1,1,this.x,this.y,1,1,this.room.shadeColor,this.shadeAmount())}}}e.Spike=a},1199:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Coal=void 0;const s=i(5180),o=i(66),a=i(1650),r=i(9467);class n extends s.Usable{constructor(t,e,i){super(t,e,i),this.onUse=t=>{let e=t.inventory.hasItem(o.Lantern);if(e instanceof o.Lantern){const i=25,s=Math.max(0,e.fuelCap-e.fuel);if(s<=0)return;const o=Math.min(1,this.stackCount);if(o<=0)return;const a=Math.min(o*i,s);e.fuel=Math.min(e.fuel+a,e.fuelCap),this.stackCount-=o,t.game.pushMessage("You add some fuel to your lantern."),this.stackCount<=0&&t.inventory.removeItem(this)}},this.useOnOther=(t,e)=>{if(e instanceof a.Light&&e.canRefuel){const i=25,s=Math.max(0,e.fuelCap-e.fuel);if(s<=0)return;const o=Math.min(this.stackCount,Math.ceil(s/i));if(o<=0)return;const a=Math.min(o*i,s);e.fuel=Math.min(e.fuel+a,e.fuelCap),this.stackCount-=o,e.broken=e.fuel<=0,this.level.game.pushMessage(`You refuel your ${e.name} with ${o} coal.`),this.stackCount<=0&&t.inventory.removeItem(this)}},this.tileX=17,this.tileY=0,this.stackable=!0,this.stackCount=Math.ceil(7*r.Random.rand()+3),this.name=n.itemName,this.description="A piece of coal. Fuels lantern.",this.canUseOnOther=!0}}e.Coal=n,n.itemName="coal"},1236:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Coin=void 0;const s=i(5366),o=i(7366),a=i(6291),r=i(9467);class n extends s.Item{constructor(t,e,i){super(t,e,i),this.onDrop=()=>{const t=[];for(const e of this.level.items)e instanceof n&&t.push(e);for(const e of t)this!==e&&this.x===e.x&&this.y===e.y&&(this.stackCount+=e.stackCount,this.level.items=this.level.items.filter(t=>t!==e)),this.stackCount>=3&&(this.tileX=20),this.stackCount>=7&&(this.tileX=21)},this.autoPickup=()=>{a.GameConstants.COIN_AUTO_PICKUP&&this.onPickup(this.level.game.players[this.level.game.localPlayerID])},this.pickupSound=()=>{let t=0;a.GameConstants.COIN_ANIMATION&&(t=Math.ceil(200*r.Random.rand()+400)),this.level===this.level.game.room&&o.Sound.delayPlay(o.Sound.pickupCoin,t)},this.tileX=19,this.tileY=0,this.stackCount=1,this.stackable=!0,this.name=n.itemName}get distanceToBottomRight(){return Math.sqrt((this.x+this.w-window.innerWidth)**2+(this.y+this.h-window.innerHeight)**2)}}e.Coin=n,n.itemName="coin"},1284:(t,e,i)=>{"use strict";t.exports=i.p+"assets/itemset.756f2386f2be7f75e8d1.png"},1285:(t,e)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.LevelConstants=void 0;class i{static get LIGHTING_ANGLE_BRIGHTNESS_COMPENSATION(){return i.LIGHTING_ANGLE_STEP/2}}e.LevelConstants=i,i.SCREEN_W=1,i.SCREEN_H=1,i.COMPUTER_TURN_DELAY=250,i.TURN_TIME=3e3,i.LEVEL_TRANSITION_TIME=300,i.LEVEL_TRANSITION_TIME_LADDER=1e3,i.ROOM_COUNT=50,i.HEALTH_BAR_FADEIN=100,i.HEALTH_BAR_FADEOUT=350,i.HEALTH_BAR_TOTALTIME=2e3,i.SHADED_TILE_CUTOFF=1,i.MIN_VISIBILITY=0,i.LIGHTING_ANGLE_STEP=2,i.LIGHTING_MAX_DISTANCE=7,i.LEVEL_TEXT_COLOR="yellow",i.AMBIENT_LIGHT_COLOR=[12,15,12],i.TORCH_LIGHT_COLOR=[120,35,10]},1302:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.AttackAnimation=void 0;const s=i(7851),o=i(824);class a extends o.Particle{constructor(t,e,i,o){switch(super(),this.drawTopLayer=t=>{this.drawAnimation(t)},this.drawAnimation=t=>{this.dead||(this.frame>=0&&s.Game.drawFX(this.tileX+2*Math.round(Math.max(0,this.frame)/2),this.tileY+this.tileYOffset,2,2,this.x-.5+this.xOffset,this.y-.5+this.yOffset,2,2),this.frame+=this.animationSpeed*t,this.frame>this.frames&&(this.dead=!0))},this.x=t,this.y=e-.25,this.dead=!1,this.frame=0,this.type=i,this.xOffset=0,this.yOffset=0,this.tileX=12,this.animationSpeed=1,i){case"dagger":switch(this.frames=8,this.tileY=24,this.yOffset=0,this.xOffset=0,o){case s.Direction.DOWN:this.yOffset-=.75;break;case s.Direction.UP:this.yOffset+=.5;break;case s.Direction.LEFT:this.xOffset+=.8,this.yOffset+=.25;break;case s.Direction.RIGHT:this.xOffset-=.8,this.yOffset-=.25}break;case"warhammer":switch(this.frames=8,this.tileX=12,this.tileY=32,this.yOffset=-.75,this.xOffset=-0,this.frame=-5,this.animationSpeed=2,o){case s.Direction.DOWN:this.yOffset-=.25,this.xOffset+=.125;break;case s.Direction.UP:this.yOffset+=1,this.xOffset+=.25;break;case s.Direction.LEFT:this.xOffset+=.75,this.yOffset+=.5;break;case s.Direction.RIGHT:this.xOffset-=.75,this.yOffset+=.5}break;case"dualdagger":switch(this.frames=8,this.tileY=40,this.yOffset=0,this.xOffset=0,o){case s.Direction.DOWN:this.yOffset-=1;break;case s.Direction.UP:this.yOffset+=.5;break;case s.Direction.LEFT:this.xOffset+=.8,this.yOffset-=.25;break;case s.Direction.RIGHT:this.xOffset-=.8,this.yOffset-=.25}break;case"dualdagger2":switch(this.frames=8,this.tileY=48,this.yOffset=0,this.xOffset=0,o){case s.Direction.DOWN:this.yOffset-=1;break;case s.Direction.UP:this.yOffset+=.5;break;case s.Direction.LEFT:this.xOffset+=.8,this.yOffset-=.25;break;case s.Direction.RIGHT:this.xOffset-=.8,this.yOffset-=.25}break;case"spear":switch(this.frames=5,this.tileY=32,this.tileX=22,this.animationSpeed=.5,o){case s.Direction.DOWN:this.yOffset-=.75,this.xOffset+=.125;break;case s.Direction.UP:this.yOffset+=1,this.xOffset-=.125;break;case s.Direction.LEFT:this.xOffset+=1,this.yOffset+=.25;break;case s.Direction.RIGHT:this.xOffset-=1,this.yOffset+=.25}break;case"scythe":switch(this.frames=6,this.tileY=40,this.tileX=0,this.animationSpeed=.75,o){case s.Direction.DOWN:this.yOffset-=.75,this.xOffset+=0;break;case s.Direction.UP:this.yOffset+=.75,this.xOffset-=0;break;case s.Direction.LEFT:this.xOffset+=.75,this.yOffset+=0;break;case s.Direction.RIGHT:this.xOffset-=.75,this.yOffset-=0}break;case"sword":switch(this.frames=6,this.tileY=48,this.tileX=0,this.animationSpeed=.75,o){case s.Direction.DOWN:this.yOffset-=.95,this.xOffset+=0;break;case s.Direction.UP:this.yOffset+=.95,this.xOffset-=0;break;case s.Direction.LEFT:this.xOffset+=.95,this.yOffset+=0;break;case s.Direction.RIGHT:this.xOffset-=.95,this.yOffset-=0}}switch(o){case s.Direction.DOWN:this.tileYOffset=0;break;case s.Direction.UP:this.tileYOffset=2;break;case s.Direction.LEFT:this.tileYOffset=4;break;case s.Direction.RIGHT:this.tileYOffset=6}}}e.AttackAnimation=a},1367:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.WizardFireball=void 0;const s=i(8774),o=i(7851),a=i(369),r=i(2103),n=i(1124),h=i(6199),l=i(9467);class c extends s.Projectile{constructor(t,e,i){switch(super(t,e,i),this.setMarkerFrame=()=>{this.offsetX=Math.floor((this.dir+1)%8/2)},this.tick=()=>{(this.parent.dead||3===this.state)&&(this.parent.removeLightSource(this.lightSource),this.dead=!0),this.dead||0!==this.state||(this.bloomAlpha=1),this.state++,this.dead||1!==this.state||(this.bloomAlpha=.5,this.parent.room.lightSources.find(t=>t===this.lightSource).b=.4,this.parent.room.hitwarnings.push(new a.HitWarning(this.parent.game,this.x,this.y,this.parent.x,this.parent.y,!0))),this.dead||2!==this.state||(this.bloomAlpha=0,n.Lighting.momentaryLight(this.parent.room,this.x,this.y,3,this.parent.projectileColor,500,5,350),this.parent.removeLightSource(this.lightSource),this.frame=0,this.delay=o.Game.rand(0,10,l.Random.rand))},this.hitPlayer=t=>{this.dead||2!==this.state||t.hurt(1,this.parent.name)},this.draw=t=>{if(!this.dead&&this.state>=0)if(0===this.state)this.frame+=.25*t,this.frame>=4&&(this.frame=0),o.Game.drawFX(22+Math.floor(this.frame),this.tileY,1,1,this.x,this.y,1,1);else if(1===this.state)this.frame+=.25*t,this.frame>=4&&(this.frame=0),o.Game.drawFX(18+Math.floor(this.frame),this.tileY,1,1,this.x,this.y-.2,1,1);else{if(this.delay>0)return void this.delay--;this.frame+=.3*t,this.frame>17&&(this.dead=!0),o.Game.drawFX(Math.floor(this.frame),6,1,2,this.x,this.y-1,1,2)}},this.tileY="wizard bomber"===t.name?7:8,t.name){case"wizard bomber":this.tileY=7;break;case"fire wizard":this.tileY=8;break;case"earth wizard":this.tileY=10}this.parent=t,this.frame=0,this.state=0,this.lightSource=new r.LightSource(this.x+.5,this.y+.5,4,t.projectileColor,.1),this.parent.addLightSource(this.lightSource),this.hasBloom=!0,this.bloomColor=h.Utils.rgbToHex(this.parent.projectileColor[0],this.parent.projectileColor[1],this.parent.projectileColor[2]),this.bloomAlpha=.5,this.softBloomAlpha=0}}e.WizardFireball=c},1425:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.OxygenLine=void 0;const s=i(7851),o=i(8287),a=i(8075),r=i(4804);class n{constructor(t){this.segmentsByRoom=new Map,this.beamsByRoom=new Map,this.beamRoomMap=new Map,this.totalLength=0,this.connected=!1,this.doorHistory=[],this.disconnected=!1,this.startAnchor={mode:"player"},this.player=t}attach(t,e,i,s){this.hasEquippedHelmet()&&(this.resetDoorHistory(),this.disconnected=!1,this.disconnectTile=void 0,this.anchor={room:t,roomGID:t?.globalId??"",x:e,y:i,kind:s?.kind,angle:s?.angle},console.log("[OxygenLine] attach",t?.globalId,`(${e},${i})`,s?.kind??"unknown"),this.update(!0))}attachStartToPlayer(t){this.hasEquippedHelmet()&&(this.startAnchor={mode:"player",angle:t??-Math.PI/2})}attachStartToTile(t,e,i,s){this.startAnchor={mode:"tile",room:t,x:e,y:i,kind:s?.kind,angle:s?.angle}}detach(){this.anchor=void 0,this.totalLength=0,this.connected=!1,this.disconnected=!1,this.disconnectTile=void 0,this.segmentsByRoom.clear(),this.resetDoorHistory(),this.clearBeams()}recordDoorTraversal(t,e){if(!this.anchor||!t||!e)return;const i=this.player.getRoom();if(!i||!i.underwater)return;if(this.disconnected)return;const s=this.doorHistory[this.doorHistory.length-1];if(s&&s.from===e&&s.to===t)return this.doorHistory.pop(),void this.reindexDoorHistory();const o={from:t,to:e};this.doorHistory.push(o),this.reindexDoorHistory()}resetDoorHistory(){this.doorHistory=[]}reindexDoorHistory(){this.doorHistory=this.doorHistory.map((t,e)=>({...t,segmentIndex:e}))}handleDisconnection(){const t=this.player.getRoom();if(!t)return;const e={x:this.player.lastX??this.player.x,y:this.player.lastY??this.player.y};this.disconnected=!0,this.connected=!1,this.disconnectTile={roomGID:t?.globalId??"",x:e.x,y:e.y},this.attachStartToTile(t,e.x,e.y,{kind:"player",angle:Math.PI/2}),this.rebuildSegments(t)&&this.syncBeamsWithSegments(),this.pushOxygenMessage("Your oxygen line disconnects.")}onHelmetEquipped(){this.anchor||this.disconnected||this.tryAttachToNearestSource()}onHelmetUnequipped(){this.anchor&&(this.disconnected||this.handleDisconnection())}tryReconnect(){if(!this.hasEquippedHelmet())return!1;if(!this.disconnectTile)return!1;const t=this.player.getRoom();return!!t&&t?.globalId===this.disconnectTile.roomGID&&!!this.playerIsAtReconnectPosition(t)&&(this.disconnected=!1,this.disconnectTile=void 0,this.attachStartToPlayer(-Math.PI/2),this.pushOxygenMessage("Your oxygen line reconnects."),!0)}isAttached(){return!!this.anchor}isSupplyingAir(){return!!this.anchor&&!!this.player.getRoom()?.underwater&&(this.validateDoorHistoryAgainstCurrentRoom()||this.resetDoorHistory(),this.connected)}isDisconnectedFromPlayer(){return this.disconnected}getActiveTraversalIndex(){if(0!==this.doorHistory.length)return this.doorHistory[this.doorHistory.length-1]?.segmentIndex}ensureAnchor(){return!!this.anchor||!!this.hasEquippedHelmet()&&this.tryAttachToNearestSource()}getTotalLength(){return this.totalLength}update(t=!1){if(this.disconnected&&!this.tryReconnect())return void(this.connected=!1);if(!this.anchor||!this.startAnchor)return this.anchor||this.disconnected||!this.hasEquippedHelmet()||this.tryAttachToNearestSource(),this.clearBeams(),void(this.connected=!1);const e=this.player.getRoom();if(!e)return this.connected=!1,void this.clearBeams();if(e.depth!==this.anchor.room.depth)return void this.detach();if(!e.underwater)return this.connected=!1,void this.clearBeams();if(!this.anchor.room.underwater&&"upLadder"!==this.anchor.kind)return this.connected=!1,void this.clearBeams();const i=this.rebuildSegments(e);if(!i)return this.connected=!1,void this.clearBeams();this.totalLength>o.GameplaySettings.OXYGEN_LINE_MAX_LENGTH?this.handleDisconnection():(this.connected=!0,(t||i)&&this.syncBeamsWithSegments())}rebuildSegments(t){if(!this.anchor)return!1;const e=this.anchor.room,i=new Map;this.reindexDoorHistory();const s=(t,e)=>{if(e.length>0){const s=t?.globalId??t.id?.toString()??"",o=i.get(s)??[];o.push(...e),i.set(s,o)}},o=this.resolveStartEndpoint(t),a=this.anchorEndpoint();let r=[];if(t===e&&0===this.doorHistory.length)s(t,this.buildRoomSegments(t,o,a).segments);else{const i=this.getEffectiveDoorStack();if(0===i.length)return!1;if(!this.buildSegmentsFromDoorHistory(t,e,o,s,i))return!1;r=i.map((t,e)=>({...t,segmentIndex:e}))}return this.segmentsByRoom=i,this.totalLength=this.computeLengthFromDoorHistory(o,a,r),!0}resolveStartEndpoint(t){return"player"===this.startAnchor.mode?{room:t,x:this.player.x,y:this.player.y,attachment:"player",kind:"player",angle:this.startAnchor.angle}:{room:this.startAnchor.room,x:this.startAnchor.x,y:this.startAnchor.y,attachment:"tile",kind:this.startAnchor.kind,angle:this.startAnchor.angle}}buildRoomSegments(t,e,i,s){return{segments:[{room:t,start:e,end:i,doorTraversalIndex:s}]}}syncBeamsWithSegments(){const t=new Set;for(const[e,i]of this.segmentsByRoom.entries()){t.add(e);const s=i[0]?.room;if(!s)continue;const o=this.beamsByRoom.get(e)??[];for(;o.length>i.length;){const t=o.pop();this.disposeBeam(t)}for(;o.length<i.length;){const t=i[o.length];o.push(this.createBeamForSegment(t))}i.forEach((t,e)=>{const i=o[e];if(!i)return;i.setAttachmentControls(this.buildAttachmentControl(t.start),this.buildAttachmentControl(t.end));const{start:s,end:a}=this.resolveSegmentEndpoints(t);i.setTarget(s.x,s.y,a.x,a.y),i.drawableY=Math.min(s.y,a.y)}),this.beamsByRoom.set(e,o)}for(const[e,i]of this.beamsByRoom.entries())t.has(e)||(i.forEach(t=>this.disposeBeam(t)),this.beamsByRoom.delete(e))}createBeamForSegment(t){const{start:e,end:i}=this.resolveSegmentEndpoints(t);console.log("[OxygenLine] createBeamForSegment",{room:t.room?.globalId??t.room?.id,start:{x:e.x,y:e.y,kind:t.start.kind},end:{x:i.x,y:i.y,kind:t.end.kind}});const s=new a.BeamEffect(e.x,e.y,i.x,i.y,this.player);return s.type="oxygen-line",s.color="rgba(135, 206, 235, 0.5)",s.compositeOperation="source-over",s.startAttachment=t.start.attachment,s.endAttachment=t.end.attachment,s.setAttachmentControls(this.buildAttachmentControl(t.start),this.buildAttachmentControl(t.end)),s.oxygenTraversalIndex=t.doorTraversalIndex,s.setHostRoom(t.room),s.drawOnTop=!0,s.setHostRoom(t.room),s.setPhysics(.15,.35,.05,.2,.0025,20,.9,.025,.08,3,40),t.room.projectiles.push(s),this.beamRoomMap.set(s,t.room),s}disposeBeam(t){if(!t)return;const e=this.beamRoomMap.get(t);e&&(e.projectiles=e.projectiles.filter(e=>e!==t),this.beamRoomMap.delete(t)),t.dead=!0}clearBeams(){for(const t of this.beamsByRoom.values())t.forEach(t=>this.disposeBeam(t));this.beamsByRoom.clear()}resolveEndpoint(t){if("player"===t.attachment){const t=this.player.getInterpolatedTilePosition();return{x:t.x,y:t.y-this.player.getOxygenAttachmentOffset()}}return{x:t.x,y:t.y-this.player.getOxygenBaseOffset()}}resolveSegmentEndpoints(t){const e=this.resolveEndpoint(t.start),i=this.resolveEndpoint(t.end);if(this.endpointsAreTooClose(e,i)){const s=this.calculateSeparationVector(t.start,t.end);e.x-=s.x,e.y-=s.y,i.x+=s.x,i.y+=s.y}return{start:e,end:i}}endpointsAreTooClose(t,e){const i=t.x-e.x,s=t.y-e.y;return Math.abs(i)<n.CLOSE_DISTANCE_EPSILON&&Math.abs(s)<n.CLOSE_DISTANCE_EPSILON}calculateSeparationVector(t,e){const i=n.MIN_SEGMENT_SEPARATION/2,s=e.x-t.x,o=e.y-t.y,a=Math.hypot(s,o);if(a>.001)return{x:s/a*i,y:o/a*i};const r=e.angle??t.angle;return void 0!==r?{x:Math.cos(r)*i,y:Math.sin(r)*i}:"player"===t.attachment?{x:0,y:-i}:{x:0,y:i}}tryAttachToNearestSource(){if(!this.hasEquippedHelmet())return!1;const t=this.player.getRoom();if(!t||!t.underwater)return!1;const e=t.findPrimaryUpLadderCoords();return!!e&&(this.attachStartToPlayer(-Math.PI/2),this.attach(t,e.x,e.y,{kind:"upLadder",angle:Math.PI/2}),!0)}playerIsAtReconnectPosition(t){if(!this.disconnectTile)return!1;if(this.player.x===this.disconnectTile.x&&this.player.y===this.disconnectTile.y)return!0;const e=t.roomArray?.[this.disconnectTile.x]?.[this.disconnectTile.y];if(e instanceof r.Door){const t=this.getDoorEntryPosition(e);if(t)return this.player.x===t.x&&this.player.y===t.y}return!1}getDoorEntryPosition(t){switch(t.doorDir){case s.Direction.UP:return{x:t.x,y:t.y+1};case s.Direction.DOWN:return{x:t.x,y:t.y-1};case s.Direction.LEFT:return{x:t.x+1,y:t.y};case s.Direction.RIGHT:return{x:t.x-1,y:t.y};default:return null}}hasEquippedHelmet(){return!!this.player.getEquippedDivingHelmet()}pushOxygenMessage(t){try{this.player.game.pushMessage?.(t)}catch{}}validateDoorHistoryAgainstCurrentRoom(){if(!this.anchor)return!0;const t=this.player.getRoom();if(!t)return!1;if(0===this.doorHistory.length)return!0;let e=t;for(let t=this.doorHistory.length-1;t>=0;t--){const i=this.doorHistory[t];if(!i?.to?.room||!i?.from?.room)return!1;if(i.to.room!==e)return!1;e=i.from.room}return e===this.anchor.room}anchorEndpoint(){if(!this.anchor)throw new Error("Attempted to use anchor endpoint without an anchor.");return{room:this.anchor.room,x:this.anchor.x,y:this.anchor.y,attachment:"tile",kind:this.anchor.kind,angle:this.anchor.angle}}buildAttachmentControl(t){if("player"===t.attachment)return{angle:t.angle??-Math.PI/2,weight:1,influence:1,influenceDistance:1.5};if(void 0===t.angle)return;const e=this.getAttachmentDefaults(t.kind);return{angle:t.angle,weight:e.weight,influence:e.influence,influenceDistance:e.influenceDistance,lengthScale:e.lengthScale}}getAttachmentDefaults(t){switch(t){case"door":return{weight:1,influence:1,influenceDistance:2,lengthScale:1};case"upLadder":return{weight:1,influence:3,influenceDistance:5,lengthScale:1};case"downLadder":return{weight:.6,influence:3,influenceDistance:5,lengthScale:1};case"oxygenNode":return{weight:.55,influence:2,influenceDistance:5,lengthScale:1};default:return{weight:.5,influence:2,influenceDistance:2,lengthScale:1}}}getDoorAngle(t){switch(t.doorDir){case s.Direction.UP:return Math.PI/2;case s.Direction.DOWN:return-Math.PI/2;case s.Direction.LEFT:return Math.PI;case s.Direction.RIGHT:default:return 0}}samePosition(t,e){return t.x===e.x&&t.y===e.y}computeLengthFromDoorHistory(t,e,i){let s=0,o=t.x,a=t.y;if(0===i.length)return s+this.distanceBetweenPoints(o,a,e.x,e.y);for(let t=i.length-1;t>=0;t--){const e=i[t],r=e.to;s+=this.distanceBetweenPoints(o,a,r.x,r.y);const n=e.from;o=n.x,a=n.y}return s+=this.distanceBetweenPoints(o,a,e.x,e.y),s}distanceBetweenPoints(t,e,i,s){return Math.abs(i-t)+Math.abs(s-e)}normalizeDoorStack(t){if(t.length<=1)return t.slice();const e=this.player.getRoom(),i=t.slice();if(e&&i[i.length-1]?.to?.room===e)return i;const s=i.slice().reverse().map(t=>({from:t.to,to:t.from}));return e&&s[s.length-1]?.to?.room===e?s:i}getEffectiveDoorStack(){return this.doorHistory.map((t,e)=>({...t,segmentIndex:t.segmentIndex??e}))}buildSegmentsFromDoorHistory(t,e,i,s,o){if(0===o.length)return!1;let a=t,r=i;for(let t=o.length-1;t>=0;t--){const e=o[t],i=e.to;if(i.room!==a)return!1;const n={room:a,x:i.x,y:i.y,attachment:"tile",kind:"door",angle:this.getDoorAngle(i)},h=e.segmentIndex??t;s(a,this.buildRoomSegments(a,r,n,h).segments);const l=e.from;if(!l||!l.room)return!1;a=l.room,r={room:a,x:l.x,y:l.y,attachment:"tile",kind:"door",angle:this.getDoorAngle(l)}}const n=this.anchorEndpoint();return a===n.room&&(s(a,this.buildRoomSegments(a,r,n).segments),!0)}}e.OxygenLine=n,n.MIN_SEGMENT_SEPARATION=.2,n.CLOSE_DISTANCE_EPSILON=.01},1429:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.MummyEnemy=void 0;const s=i(7851),o=i(7455),a=i(6986);class r extends a.Enemy{constructor(t,e,i,a,r){super(t,e,i,a),this.hit=()=>this.damage,this.poison=()=>{},this.bleed=()=>{},this.behavior=()=>{if(this.lastX=this.x,this.lastY=this.y,!this.dead){if(this.handleSkipTurns())return;if(this.ticks++,this.seenPlayer){if(this.seenPlayer){if(this.room.playerTicked===this.targetPlayer){this.alertTicks=Math.max(0,this.alertTicks-1);let t=this.x,e=this.y,i=Array();for(const t of this.room.entities)t!==this&&i.push({x:t.x,y:t.y});for(let t=this.x-1;t<=this.x+1;t++)for(let e=this.y-1;e<=this.y+1;e++)this.room.roomArray[t][e]instanceof o.SpikeTrap&&this.room.roomArray[t][e].on&&i.push({x:t,y:e});const a=this.searchPathLocalized(this.targetPlayer,i);if(a.length>0){let i=a[0].pos.x,o=a[0].pos.y,r=this.direction,n=this.targetPlayer;if(this.facePlayer(n),i>t?this.direction=s.Direction.RIGHT:i<t?this.direction=s.Direction.LEFT:o>e?this.direction=s.Direction.DOWN:o<e&&(this.direction=s.Direction.UP),r==this.direction){let a=!1;for(const t in this.game.players)this.game.rooms[this.game.players[t].levelID]===this.room&&this.game.players[t].x===i&&this.game.players[t].y===o&&(this.game.players[t].hurt(this.hit(),this.name),this.drawX=.5*(this.x-this.game.players[t].x),this.drawY=.5*(this.y-this.game.players[t].y),this.game.players[t]===this.game.players[this.game.localPlayerID]&&this.game.shakeScreen(10*this.drawX,10*this.drawY));a||(this.tryMove(i,o),this.setDrawXY(t,e),this.x>t?this.direction=s.Direction.RIGHT:this.x<t?this.direction=s.Direction.LEFT:this.y>e?this.direction=s.Direction.DOWN:this.y<e&&(this.direction=s.Direction.UP))}}this.direction==s.Direction.LEFT&&(i.push({x:this.x,y:this.y+1}),i.push({x:this.x,y:this.y-1})),this.direction==s.Direction.RIGHT&&(i.push({x:this.x,y:this.y+1}),i.push({x:this.x,y:this.y-1})),this.direction==s.Direction.DOWN&&(i.push({x:this.x+1,y:this.y}),i.push({x:this.x-1,y:this.y})),this.direction==s.Direction.UP&&(i.push({x:this.x+1,y:this.y}),i.push({x:this.x-1,y:this.y})),this.makeHitWarnings()}let t=-1!==Object.values(this.game.offlinePlayers).indexOf(this.targetPlayer);if(!this.aggro||t){let e=this.nearestPlayer();if(!1!==e){let[i,s]=e;i<=4&&(t||i<this.playerDistance(this.targetPlayer))&&s!==this.targetPlayer&&(this.targetPlayer=s,this.facePlayer(s),s===this.game.players[this.game.localPlayerID]&&(this.alertTicks=1),this.makeHitWarnings())}}}}else this.lookForPlayer()}},this.draw=t=>{this.dead||(s.Game.ctx.globalAlpha=this.alpha,this.updateDrawXY(t),this.frame+=.1*t,this.frame>=4&&(this.frame=0),this.hasShadow&&this.drawShadow(t),s.Game.drawMob(this.tileX+Math.floor(this.frame),this.tileY+2*this.direction,1,2,this.x-this.drawX,this.y-this.drawYOffset-this.drawY-this.jumpY,1,2,this.softShadeColor,this.shadeAmount(),void 0,this.outlineColor(),this.outlineOpacity()),this.cloned||(this.seenPlayer||this.drawSleepingZs(t),this.alertTicks>0&&this.drawExclamation(t)),s.Game.ctx.globalAlpha=1)},this.ticks=0,this.frame=0,this.health=1,this.maxHealth=1,this.defaultMaxHealth=1,this.tileX=17,this.tileY=16,this.seenPlayer=!1,this.aggro=!1,this.dir=s.Direction.DOWN,this.name="mummy",this.forwardOnlyAttack=!0,this.jumpHeight=.35,this.alertRange=2,this.baseDamage=.5,r&&(this.drop=r),this.getDrop(["consumable","tool","coin"])}}e.MummyEnemy=r,r.difficulty=1,r.tileX=17,r.tileY=16},1438:(t,e,i)=>{"use strict";var s;Object.defineProperty(e,"__esModule",{value:!0}),e.DropTable=e.ItemTypeMap=void 0;const o=i(2270),a=i(521),r=i(8149),n=i(1236),h=i(5614),l=i(4918),c=i(1470),d=i(4083),m=i(8243),u=i(9058),p=i(2268),y=i(5064),g=i(9406),f=i(2176),w=i(9991),E=i(9915),x=i(1444),b=i(1199),T=i(5196),I=i(66),S=i(3785),v=i(3346),A=i(783),M=i(4182),C=i(995),D=i(9467),O=i(6199),_=i(9432),R=i(920),G=i(4208),P=i(5734),L=i(2772),k=i(4937),N=i(2279),Y=i(6644),B=i(4478),H=i(5692),X=i(4752),F=i(8991),W=i(7494),U=i(6105);e.ItemTypeMap={dualdagger:p.DualDagger,warhammer:u.Warhammer,spear:m.Spear,spellbook:S.Spellbook,greataxe:C.Greataxe,scythe:R.Scythe,quarterstaff:W.QuarterStaff,divinghelmet:U.DivingHelmet,hourglass:G.Hourglass,fishingrod:k.FishingRod,crossbowstock:H.CrossbowStock,crossbowlimb:X.CrossbowLimb,crossbowbolt:F.CrossbowBolt,scytheblade:L.ScytheBlade,scythehandle:P.ScytheHandle,shieldleftfragment:Y.ShieldLeftFragment,shieldrightfragment:N.ShieldRightFragment,armor:o.Armor,woodenshield:B.WoodenShield,pickaxe:E.Pickaxe,hammer:x.Hammer,heart:l.Heart,weaponpoison:y.WeaponPoison,weaponblood:g.WeaponBlood,coin:n.Coin,weaponfragments:d.WeaponFragments,spellbookPage:v.SpellbookPage,backpack:A.Backpack,candle:r.Candle,torch:T.Torch,lantern:I.Lantern,redgem:c.RedGem,bluegem:a.BlueGem,greengem:h.GreenGem,geode:_.Geode,gold:f.GoldOre,stone:w.Stone,coal:b.Coal,bomb:M.BombItem};class j{}e.DropTable=j,s=j,j.drops=[{itemType:"dualdagger",dropRate:500,category:["weapon","melee"],unique:!0},{itemType:"warhammer",dropRate:750,category:["weapon","melee"],unique:!0},{itemType:"spear",dropRate:750,category:["weapon","melee"],unique:!0},{itemType:"spellbook",dropRate:500,category:["weapon","magic"],unique:!0},{itemType:"greataxe",dropRate:500,category:["weapon","melee"],unique:!0},{itemType:"quarterstaff",dropRate:100,category:["weapon","melee"],unique:!0},{itemType:"scythe",dropRate:500,category:["reaper"],unique:!0},{itemType:"scytheblade",dropRate:10,category:["reaper"],unique:!0},{itemType:"scythehandle",dropRate:10,category:["reaper"],unique:!0},{itemType:"shieldleftfragment",dropRate:10,category:["occultist"],unique:!0},{itemType:"shieldrightfragment",dropRate:10,category:["occultist"],unique:!0},{itemType:"crossbowstock",dropRate:20,category:["crossbow"],unique:!0},{itemType:"crossbowlimb",dropRate:20,category:["crossbow"],unique:!0},{itemType:"crossbowbolt",dropRate:3,category:["crossbow"],unique:!0},{itemType:"weaponpoison",dropRate:3,category:["frog"],unique:!0},{itemType:"woodenshield",dropRate:50,category:["shield"],unique:!1},{itemType:"armor",dropRate:350,category:["equipment"],unique:!0},{itemType:"divinghelmet",dropRate:50,category:["equipment","underwater"],unique:!1},{itemType:"pickaxe",dropRate:25,category:["tool"]},{itemType:"hammer",dropRate:25,category:["tool"]},{itemType:"fishingrod",dropRate:40,category:["tool"]},{itemType:"hourglass",dropRate:10,category:["reaper"],unique:!0},{itemType:"heart",dropRate:20,category:["consumable"]},{itemType:"weaponblood",dropRate:100,category:["consumable"]},{itemType:"coin",dropRate:10,category:["coin"]},{itemType:"weaponfragments",dropRate:100,category:["consumable","melee"]},{itemType:"spellbookPage",dropRate:100,category:["consumable","magic"]},{itemType:"backpack",dropRate:100,category:["upgrade"]},{itemType:"candle",dropRate:100,category:["light"]},{itemType:"torch",dropRate:250,category:["light"]},{itemType:"lantern",dropRate:500,category:["light"]},{itemType:"redgem",dropRate:750,category:["gem","resource"]},{itemType:"bluegem",dropRate:750,category:["gem","resource"]},{itemType:"greengem",dropRate:750,category:["gem","resource"]},{itemType:"geode",dropRate:500,category:["gem","resource"]},{itemType:"gold",dropRate:350,category:["resource"]},{itemType:"stone",dropRate:200,category:["resource"]},{itemType:"coal",dropRate:100,category:["fuel","lantern","resource","light"]},{itemType:"bomb",dropRate:100,category:["bomb","weapon"]}],j.getDrop=(t,e=[],i=!1,o=0,a=1)=>{if(t.cloned)return;const r=t.room.depth+o,n=t.dropChance||1;if(!i&&n>1&&D.Random.rand()>1/n)return null;let h=s.drops.filter(t=>void 0===t.minDepth||t.minDepth<=r);if(0===e.length&&(h=h.filter(t=>void 0===t.unique||!1===t.unique)),e.length>0&&(h=h.filter(t=>e.includes(t.itemType)||t.category.some(t=>e.includes(t)))),0===h.length)return null;let l=0,c=[];for(const e of h)if(D.Random.rand()<1/e.dropRate){const i=s.addNewItem(e.itemType,t);if(i&&(c.push(i),l++,l>=a))break}if(i&&0===l&&h.length>0){const e=h.reduce((t,e)=>t.dropRate<e.dropRate?t:e),i=s.addNewItem(e.itemType,t);i&&c.push(i)}return c.length>0?c:null},j.addNewItem=(t,i)=>{const s=e.ItemTypeMap[t];if(!s)return console.error(`Item type "${t}" is not recognized.`),null;let o=s.add(i.room,i.x,i.y);return"coin"===o.name&&(o.stackCount=O.Utils.randomNormalInt(0,14)),(o instanceof a.BlueGem||o instanceof c.RedGem||o instanceof h.GreenGem)&&(o.stackCount=O.Utils.randomNormalInt(0,5)),i.drops.push(o),o}},1444:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Hammer=void 0;const s=i(7366),o=i(5180),a=i(4052),r=i(4083),n=i(9467);class h extends o.Usable{constructor(t,e,i){super(t,e,i),this.onUse=t=>{t.health=Math.min(t.maxHealth,t.health+1),(t?.getRoom?t.getRoom():this.level.game.rooms[t.levelID])===this.level.game.room&&s.Sound.heal()},this.useOnOther=(t,e)=>{e instanceof a.Weapon&&"dagger"!==e.name?e.disassemble():"dagger"===e.name?this.level.game.pushMessage("You probably shouldn't disassemble your dagger..."):"hammer"===e.name&&e!==this?(e.disassemble(t),this.level.game.pushMessage("I only needed one of those anyways...")):"geode"===e.name?(e.split(t.inventory),this.level.game.pushMessage("You hit the geode with the hammer.")):"pickaxe"===e.name?e.disassemble():"gold bar"===e.name?e.smith(t):"gold ore"===e.name?e.smelt(t):"fishing rod"===e.name?e.disassemble():"iron bar"===e.name?e.smith(t):"iron ore"===e.name&&e.smelt(t)},this.disassemble=t=>{let e=this.x,i=this.y,s=Math.ceil(5*n.Random.rand()+5);t.inventory.removeItem(this),t.inventory.addItem(new r.WeaponFragments(this.level,e,i,s))},this.tileX=21,this.tileY=2,this.offsetY=-.3,this.canUseOnOther=!0,this.description="useful for breaking weapons down into fragments",this.name=h.itemName}}e.Hammer=h,h.itemName="hammer"},1470:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.RedGem=void 0;const s=i(5180);class o extends s.Usable{constructor(t,e,i){super(t,e,i),this.useOnOther=(t,e)=>{"gold ring"===e.name&&e.embed(t,this)},this.getDescription=()=>"A garnet gem. Embed it into a gold ring to imbue it with magic.",this.tileX=12,this.tileY=0,this.name=o.itemName,this.canUseOnOther=!0,this.stackable=!0}}e.RedGem=o,o.itemName="garnet"},1626:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.TombStone=void 0;const s=i(606),o=i(7851),a=i(606),r=i(7975),n=i(9467),h=i(3785),l=i(7366),c=i(2103);class d extends s.Entity{constructor(t,e,i,s,a=0,d){super(t,e,i,s),this.uniqueKillBehavior=()=>{this.cloned||l.Sound.delayPlay(l.Sound.breakRock,50)},this.onHurt=(t=1)=>{if(1===this.health){const t=this.room.getEmptyTiles().filter(t=>Math.abs(t.x-this.x)<=1&&Math.abs(t.y-this.y)<=1);if(t.length>0){for(let e of t)for(const t in this.game.players){const i=this.game.players[t].x,s=this.game.players[t].y;(i!==e.x&&s===e.y||i===e.x&&s!==e.y)&&this.room.entities.push(new r.SkullEnemy(this.room,this.game,e.x,e.y))}l.Sound.delayPlay(l.Sound.skeleSpawn,50)}this.tileX+=2}},this.draw=t=>{this.dead||(this.updateDrawXY(t),this.hasShadow&&this.drawShadow(t),o.Game.ctx.save(),o.Game.ctx.globalAlpha=this.alpha,o.Game.drawObj(this.tileX,this.tileY,1,2,this.x-this.drawX,this.y-this.drawYOffset-this.drawY,1,2,this.room.shadeColor,this.shadeAmount()),o.Game.ctx.restore())},this.drawTopLayer=t=>{this.drawableY=this.y},this.skinType=a,this.room=t,this.health=2,this.tileX=11+this.skinType,this.tileY=2,this.hasShadow=!0,this.chainPushable=!1,this.name="tombstone",n.Random.rand()<.1&&this.drops.push(new h.Spellbook(this.room,this.x,this.y)),this.hasBloom=!0,this.bloomColor="#05FF05",this.bloomAlpha=1,this.softBloomAlpha=0,this.imageParticleX=0,this.imageParticleY=25,this.lightSource=new c.LightSource(this.x+.5,this.y+.5,7,[5,150,5],1),this.addLightSource(this.lightSource)}get type(){return a.EntityType.PROP}}e.TombStone=d},1631:(t,e)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.getEnvironmentApiUrl=void 0,e.getEnvironmentApiUrl=()=>"localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname||window.location.hostname.includes("localhost")||"file:"===window.location.protocol?"http://localhost:3000/api/v1":"https://turnarchist.onrender.com/api/v1"},1645:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.BestiaryBook=void 0;const s=i(5180),o=i(503);class a extends s.Usable{constructor(t,e,i){super(t,e,i),this.onUse=t=>{null===t.bestiary&&(t.bestiary=new o.Bestiary(t.game,t)),t.bestiary.toggleOpen()},this.tileX=8,this.tileY=0,this.offsetY=-.3,this.name=a.itemName,this.description="opens the bestiary"}}e.BestiaryBook=a,a.itemName="bestiary book"},1650:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Light=void 0;const s=i(7851),o=i(8549),a=i(6291),r=i(6199),n=i(1285);class h extends o.Equippable{constructor(t,e,i){super(t,e,i),this.canRefuel=!1,this.updateLighting=()=>{const t=this.wielder?.getRoom?this.wielder.getRoom():this.wielder.game.rooms[this.wielder.levelID];t?.updateLighting()},this.isIgnited=()=>!!(this.fuel>0&&this.equipped),this.dropFromInventory=()=>{console.log("onDrop"),this.equipped&&this.toggleEquip()},this.setRadius=()=>{this.wielder.sightRadius=this.radius+this.fuelPercentage*this.radius},this.setBrightness=()=>{this.wielder.lightBrightness=this.minBrightness+this.fuelPercentage*this.maxBrightness},this.toggleEquip=()=>{if(this.fuel>0){if(this.enforceUnderwaterRestrictions())return void this.wielder.game.pushMessage?.("You can't use this underwater.");this.equipped=!this.equipped,this.isIgnited()?(this.setBrightness(),this.wielder.lightEquipped=!0,this.wielder.lightColor=this.color,this.setFov(),this.setFalloff()):(this.resetBrightness(),this.wielder.lightEquipped=!1,this.wielder.lightColor=n.LevelConstants.AMBIENT_LIGHT_COLOR,this.resetFov(),this.resetFalloff())}else this.wielder.game.pushMessage("I'll need some fuel before I can use this");this.updateLighting()},this.coEquippable=t=>!(t instanceof h),this.resetRadius=()=>{this.wielder.sightRadius=this.wielder.defaultSightRadius},this.resetBrightness=()=>{this.wielder.lightBrightness=.5},this.setFov=()=>{this.wielder&&(this.wielder.lightFov=this.fov??a.GameConstants.DEFAULT_LIGHTING_FOV_DEGREES)},this.resetFov=()=>{this.wielder&&(this.wielder.lightFov=a.GameConstants.DEFAULT_LIGHTING_FOV_DEGREES)},this.setFalloff=()=>{this.wielder&&(this.wielder.lightFalloffDecay=this.falloffDecay??1)},this.resetFalloff=()=>{this.wielder&&(this.wielder.lightFalloffDecay=1)},this.burn=()=>{if(!this.enforceUnderwaterRestrictions()&&(this.isIgnited()&&((this.wielder?.getRoom?this.wielder.getRoom():this.wielder.game.rooms[this.wielder.levelID]).roomCleared()?this.fuel-=.2:this.fuel--,this.setRadius(),this.setBrightness()),this.fuel<=0)){if(this.canRefuel&&!0===this.tryAutoRefuel?.())return this.setRadius(),this.setBrightness(),this.setFov(),this.setFalloff(),void this.updateLighting();this.stackable&&(this.stackCount--,this.fuel=this.fuelCap),this.equipped&&(this.stackable&&this.stackCount<=0||!this.stackable&&!this.canRefuel?(this.resetRadius(),this.wielder.lightEquipped=!1,this.wielder.inventory.removeItem(this),this.wielder.game.pushMessage(`${this.name} depletes.`),this.resetFov(),this.resetFalloff()):this.canRefuel&&(this.wielder.game.pushMessage(`${this.name} depletes.`),this.equipped=!1,this.resetRadius(),this.wielder.lightEquipped=!1,this.broken=!0,this.resetFov(),this.resetFalloff()),this.updateLighting())}},this.drawDurability=(t,e)=>{if(this.fuel<this.fuelCap){const i=this.fuel/this.fuelCap;let o=r.Utils.hsvToHex(120*i,1,1);const n=i*a.GameConstants.TILESIZE,h=2,l=t*a.GameConstants.TILESIZE,c=e*a.GameConstants.TILESIZE+a.GameConstants.TILESIZE-2;s.Game.ctx.fillStyle=o,s.Game.ctx.imageSmoothingEnabled=!1,s.Game.ctx.fillRect(l,c,n,h),s.Game.ctx.fillStyle="white"}},this.tickInInventory=()=>{this.burn()},this.getDescription=()=>`${this.name}: ${Math.ceil(100*this.fuelPercentage)}%`,this.tileX=28,this.tileY=0,this.fuel=0,this.fuelCap=250,this.maxBrightness=5,this.minBrightness=2,this.radius=6,this.equipped=!1,this.color=n.LevelConstants.TORCH_LIGHT_COLOR,this.waterproof=!1,this.fov=a.GameConstants.DEFAULT_LIGHTING_FOV_DEGREES??360,this.falloffDecay=1}get fuelPercentage(){return this.fuel/this.fuelCap}tryAutoRefuel(){return!1}getCurrentRoom(){if(!this.wielder)return;const t=this.wielder;return"function"==typeof t.getRoom?t.getRoom():this.wielder.game.rooms[this.wielder.levelID]}enforceUnderwaterRestrictions(){if(!this.wielder||this.waterproof)return!1;const t=this.getCurrentRoom(),e=!0===t?.underwater;return e&&this.equipped&&(this.equipped=!1,this.resetRadius(),this.resetBrightness(),this.wielder.lightEquipped=!1,this.wielder.lightColor=n.LevelConstants.AMBIENT_LIGHT_COLOR,this.resetFov(),this.resetFalloff(),this.wielder.game.pushMessage?.(`${this.name} fizzles out underwater.`),this.updateLighting()),e}}e.Light=h},1731:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.GenericParticle=void 0;const s=i(824),o=i(7851),a=i(6291),r=i(9467);class n extends s.Particle{constructor(t,e,i,s,r,n,h,l,c,d,m,u,p,y){super(),this.render=()=>{let t=a.GameConstants.TILESIZE,e=this.s*this.alpha*.5,i=o.Game.ctx.fillStyle;o.Game.ctx.fillStyle=this.color,o.Game.ctx.imageSmoothingEnabled=!1,o.Game.ctx.beginPath(),o.Game.ctx.arc(Math.round(this.x*t),Math.round((this.y-this.z)*t),Math.round(e*t),0,2*Math.PI,!1),o.Game.ctx.fill(),o.Game.ctx.fillStyle=i},this.draw=t=>{this.targetX?this.x+=.1*(this.targetX-this.x):this.x+=this.dx,this.targetY?this.y+=.1*(this.targetY-this.y):this.y+=this.dy,this.targetZ?this.z+=.1*(this.targetZ-this.z):this.z+=this.dz,this.dx*=.97,this.dy*=.97,this.z<=0&&(this.z=0,this.dz*=-.8),this.dz-=.01,this.alpha<.2?this.alpha-=.007:this.alpha-=.02,this.alpha<=.1&&(this.dead=!0),this.expirationTimer--,this.expirationTimer<=0&&(this.dead=!0),this.dead||(this.drawableY=this.y,this.render())},this.level=t,this.x=e,this.y=i,this.z=s,this.s=r,this.dx=n,this.dy=h,this.dz=l,this.color=c,this.alpha=1,void 0!==d&&(this.delay=d),this.targetX=u,this.targetY=p,this.targetZ=y,this.expirationTimer=1e6,void 0!==m&&(this.expirationTimer=m)}}e.GenericParticle=n,n.shotgun=(t,e,i,s,o,a)=>{for(let h=0;h<4;h++)t.particles.push(new n(t,e,i,0,.5*r.Random.rand()+.3,0,0,0,a,0,1e7,s+r.Random.rand()-.5,o+r.Random.rand()-.5,0))},n.spawnCluster=(t,e,i,s)=>{for(let o=0;o<4;o++)t.particles.push(new n(t,e+.05*r.Random.rand()-.025,i+.05*r.Random.rand()-.025,.5*r.Random.rand(),.0625*(o+8),.025*(2*r.Random.rand()-1),.025*(2*r.Random.rand()-1),.2*(r.Random.rand()-1),s,0))}},1754:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.fetchGameStats=e.safeRecordGameStats=e.getOrCreateUserId=e.recordGameStats=e.apiClient=void 0;const s=i(6425),o=i(1631),a=i(5949);e.apiClient=s.default.create({baseURL:(0,o.getEnvironmentApiUrl)()}),e.recordGameStats=async t=>(await e.apiClient.post("/game/stats",t)).data,e.getOrCreateUserId=()=>{const t=localStorage.getItem("userId");if(!t){const t=(0,a.v4)();return localStorage.setItem("userId",t),t}return t},e.safeRecordGameStats=async t=>{try{return await(0,e.recordGameStats)(t)}catch(t){console.error("API request failed:",t)}},e.fetchGameStats=async()=>(await e.apiClient.get("/game/stats")).data},1856:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.loadSettings=e.saveSettings=void 0;const s=i(9573),o=i(6291),a=i(7366),r="wr_settings";e.saveSettings=t=>{const e={muted:a.Sound.audioMuted??!1,softScale:o.GameConstants.SOFT_SCALE??o.GameConstants.SCALE,shade:o.GameConstants.SHADE_ENABLED,smoothLighting:o.GameConstants.SMOOTH_LIGHTING,hoverText:o.GameConstants.HOVER_TEXT_ENABLED,screenShake:o.GameConstants.SCREEN_SHAKE_ENABLED,slowInputsNearEnemies:o.GameConstants.SLOW_INPUTS_NEAR_ENEMIES};(0,s.setCookie)(r,JSON.stringify(e),180)},e.loadSettings=t=>{const e=(0,s.getCookie)(r);if(e)try{const t=JSON.parse(e);"boolean"==typeof t.muted&&(t.muted&&!a.Sound.audioMuted&&a.Sound.toggleMute(),!t.muted&&a.Sound.audioMuted&&a.Sound.toggleMute()),"number"==typeof t.softScale&&(o.GameConstants.SOFT_SCALE=t.softScale),"boolean"==typeof t.smoothLighting&&(o.GameConstants.SMOOTH_LIGHTING=t.smoothLighting),"boolean"==typeof t.hoverText&&(o.GameConstants.HOVER_TEXT_ENABLED=t.hoverText,console.log("Load hover text enabled",o.GameConstants.HOVER_TEXT_ENABLED)),"boolean"==typeof t.screenShake&&(o.GameConstants.SCREEN_SHAKE_ENABLED=t.screenShake),"boolean"==typeof t.slowInputsNearEnemies&&(o.GameConstants.SLOW_INPUTS_NEAR_ENEMIES=t.slowInputsNearEnemies)}catch(t){console.warn("Failed to parse settings cookie",t)}}},1879:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.PlayerMovement=void 0;const s=i(7851),o=i(6291),a=i(4118);e.PlayerMovement=class{constructor(t){this.moveQueue=[],this.isProcessingQueue=!1,this.animationFrameId=null,this.moveRange=1,this.lastMoveTime=0,this.lastChangeDirectionTime=0,this.adjustedCooldown=0,this.moveRangeCheck=(t,e)=>{const i=Math.abs(this.player.x-t),s=Math.abs(this.player.y-e);return i<=this.moveRange&&s<=this.moveRange&&(0===i||0===s)&&i+s!==0},this.queueHandler=()=>{if(!this.isProcessingQueue)return;const t=Date.now(),e=o.GameConstants.MOVEMENT_COOLDOWN;if(t-this.lastMoveTime>=e)if(this.moveQueue.length>0){const e=this.moveQueue.shift();this.handleMoveLoop(e),this.lastMoveTime=t}else this.stopQueueProcessing();this.animationFrameId=requestAnimationFrame(this.queueHandler)},this.player=t}move(t,e,i){if(!(t in s.Direction)||!this.player)return;const o=this.getTargetCoords(t,e,i);if(!o)return;const{x:a,y:r}=o;if(this.canMove()){const e=Date.now();this.lastMoveTime=e,this.lastChangeDirectionTime=e,this.player.inputHandler.setMostRecentMoveInput("keyboard"),this.player.lastDirection=this.player.direction,this.player.direction=t,this.player.tryMove(a,r)}else this.enemyTurnInputLockActive()||this.queueMove(a,r,t)}moveMouse(t,e,i){if(!(t in s.Direction)||!this.player||o.GameConstants.isMobile)return;const a=this.getTargetCoords(t,e,i);if(!a)return;const{x:r,y:n}=a;if(void 0!==r&&void 0!==n)if(this.canMove()){const e=Date.now();this.lastMoveTime=e,this.player.inputHandler.setMostRecentMoveInput("mouse"),this.player.direction=t,this.player.tryMove(r,n)}else this.enemyTurnInputLockActive()||this.queueMove(r,n,t)}getTargetCoords(t,e,i){if(void 0!==e&&void 0!==i&&null!==e&&null!==i)return{x:e,y:i};switch(t){case s.Direction.LEFT:return{x:this.player.x-1,y:this.player.y};case s.Direction.RIGHT:return{x:this.player.x+1,y:this.player.y};case s.Direction.UP:return{x:this.player.x,y:this.player.y-1};case s.Direction.DOWN:return{x:this.player.x,y:this.player.y+1};default:return null}}inventoryClosedRecently(){const t=Date.now()-this.player.inventory.dragEndTime,e=Date.now()-this.player.inventory.closeTime;return t<10||e<10}canMove(){if(this.player.busyAnimating)return!1;if(this.inventoryClosedRecently())return!1;if(this.enemyTurnInputLockActive())return!1;const t=Date.now();let e=o.GameConstants.MOVEMENT_COOLDOWN;return o.GameConstants.SLOW_INPUTS_NEAR_ENEMIES&&this.player.game.room.hasEnemyInRadius(this.player.x,this.player.y)&&(e*=2),t-this.lastMoveTime>=e}canQueue(){if(this.player.busyAnimating)return!1;if(this.inventoryClosedRecently())return!1;if(this.enemyTurnInputLockActive())return!1;const t=Date.now();let e=o.GameConstants.MOVEMENT_QUEUE_COOLDOWN;return o.GameConstants.SLOW_INPUTS_NEAR_ENEMIES&&this.player.game.room.hasEnemyInRadius(this.player.x,this.player.y)&&(e*=2),t-this.lastMoveTime>=e}queueMove(t,e,i){this.canQueue()&&(void 0===t||void 0===e||this.moveQueue.length>0||(this.moveQueue.push({x:t,y:e,direction:i}),this.startQueueProcessing()))}handleMoveLoop({x:t,y:e,direction:i}){"mouse"===this.player.inputHandler.mostRecentMoveInput?this.moveMouse(i,t,e):this.move(i,t,e)}startQueueProcessing(){this.isProcessingQueue||(this.isProcessingQueue=!0,this.animationFrameId=requestAnimationFrame(()=>this.queueHandler()))}stopQueueProcessing(){this.isProcessingQueue=!1,null!==this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null)}enemyTurnInputLockActive(){if(!o.GameConstants.SLOW_INPUTS_NEAR_ENEMIES)return!1;const t=this.player?.game?.room;return!!t&&t.turn===a.TurnState.computerTurn&&t.hasEnemyInRadius(this.player.x,this.player.y)}}},1887:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.BubbleImageParticle=e.ImageParticle=void 0;const s=i(824),o=i(7851),a=i(6291),r=i(9467);class n extends s.Particle{constructor(t,e,i,s,r,n,h,l,c,d,m,u,p,y,g,f){super(),this.render=()=>{a.GameConstants.TILESIZE;this.z,this.s,o.Game.ctx.imageSmoothingEnabled=!1;let t=this.tileX+this.size;o.Game.drawFX(t,this.tileY,1,1,this.x-.5,this.y-this.z-.5,1,1,this.shadeColor(),this.shadeAmount()*(1/this.alpha))},this.draw=t=>{o.Game.ctx.imageSmoothingEnabled=!1,this.targetX?this.x+=.2*(this.targetX-this.x)*t:this.x+=this.dx*t,this.targetY?this.y+=.2*(this.targetY-this.y)*t:this.y+=this.dy*t,this.targetZ?this.z+=.2*(this.targetZ-this.z)*t:this.z+=this.dz*t,this.dx*=Math.pow(.97,t),this.dy*=Math.pow(.97,t),this.z<=0&&(this.z=0,this.dz*=-.8),this.dz-=.01*t,this.expirationTimer-=t,this.expirationTimer<=0&&(this.dead=!0),this.dead||(this.drawableY=this.y,this.render())},this.room=t,this.x=e,this.y=i,this.z=s,this.s=r,this.dx=n,this.dy=h,this.dz=l,this.tileX=c,this.tileY=d,this.size=m,this.alpha=1,void 0!==u&&(this.delay=u),this.targetX=y,this.targetY=g,this.targetZ=f,this.expirationTimer=100,void 0!==p&&(this.expirationTimer=p)}}e.ImageParticle=n,n.shotgun=(t,e,i,s,o,a,h)=>{for(let s=0;s<4;s++)t.particles.push(new n(t,e,i,0,.5*r.Random.rand()+.3,0,0,0,a,h,0))},n.spawnCluster=(t,e,i,s,o)=>{for(let a=Math.floor(3*r.Random.rand());a<5;a++)t.particles.push(new n(t,e+.05*r.Random.rand()-.025,i+.05*r.Random.rand()-.025,.5*r.Random.rand(),.0625*(a+8),.025*(2*r.Random.rand()-1),.025*(2*r.Random.rand()-1),.2*(r.Random.rand()-1),s,o,[2,1,0,1,2,2,2][a]))},e.BubbleImageParticle=class extends n{constructor(t,e,i,s={}){const a=s.scale??.45+.25*r.Random.rand(),n=s.lifetime??90+30*r.Random.rand();super(t,e,i,s.height??0,a,0,0,0,s.tileX??9,s.tileY??26,s.size??0,void 0,n),this.draw=t=>{o.Game.ctx.imageSmoothingEnabled=!1,this.bobPhase+=this.bobSpeed*t,this.x+=Math.sin(this.bobPhase)*this.bobRadius*t,this.y-=this.riseSpeed*t,this.z+=(.5*this.riseSpeed+.005)*t,this.expirationTimer-=t,this.expirationTimer<=0?this.dead=!0:(this.expirationTimer<this.fadeWindow&&(this.alpha=Math.max(.001,this.expirationTimer/this.fadeWindow)),this.drawableY=this.y,this.render())},this.bobPhase=r.Random.rand()*Math.PI*2,this.bobSpeed=.01+.0025*r.Random.rand(),this.bobRadius=.01+.002*r.Random.rand(),this.riseSpeed=.015+.01*r.Random.rand(),this.fadeWindow=30}}},1929:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.XPCounter=void 0;const s=i(7851),o=i(2147);e.XPCounter=class{constructor(){this.xp=0,this.level=1}static draw(t){const e=o.statsTracker.getXp();s.Game.ctx.save(),s.Game.ctx.fillStyle="rgba(255, 255, 0, 1)",s.Game.ctx.globalAlpha=.1,s.Game.fillText(`XP: ${e}`,1,20),s.Game.ctx.restore()}}},1932:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.RookStatue=void 0;const s=i(606),o=i(7851),a=i(606),r=i(4083),n=i(1236),h=i(9467);class l extends s.Entity{constructor(t,e,i,s){super(t,e,i,s),this.draw=t=>{this.dead||(o.Game.ctx.save(),o.Game.ctx.globalAlpha=this.alpha,this.dead||(this.hasShadow&&this.drawShadow(t),this.updateDrawXY(t),o.Game.drawObj(this.tileX,this.tileY,1,2,this.x-this.drawX,this.y-this.drawYOffset-this.drawY,1,2,this.room.shadeColor,this.shadeAmount())),o.Game.ctx.restore())},this.drawTopLayer=t=>{this.drawableY=this.y},this.room=t,this.health=1,this.tileX=5,this.tileY=4,this.hasShadow=!0,this.pushable=!0,this.name="rookStatue",this.imageParticleX=3,this.imageParticleY=25,h.Random.rand()<.1?this.drops.push(new r.WeaponFragments(this.room,this.x,this.y)):this.drops.push(new n.Coin(this.room,this.x,this.y))}get type(){return a.EntityType.PROP}}e.RookStatue=l},1987:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.CoalResource=void 0;const s=i(7172),o=i(1199),a=i(9432),r=i(9467);class n extends s.Resource{constructor(t,e,i,s){super(t,e,i,s),this.tileX=12,this.tileY=0,this.health=1,this.name="coal",this.extendShadow=!0,this.shadowOpacity=.5,r.Random.rand()<.01&&this.drops.push(new a.Geode(this.room,this.x,this.y)),this.drops.push(new o.Coal(this.room,this.x,this.y))}}e.CoalResource=n},2041:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.PlayerRenderer=void 0;const s=i(7851),o=i(6291),a=i(369),r=i(1285),n=i(8900),h=i(9410),l=i(2147),c=i(6199),d=i(3785),m=i(7924),u=i(3458),p=i(1754),y=i(336),g=i(1103);e.PlayerRenderer=class{constructor(t){this.divingHelmetTileX=0,this.divingHelmetTileY=12,this.hurt=()=>{this.hurting=!0,this.hurtAlpha=.25},this.hurtShield=()=>{this.hurtingShield=!0},this.outlineColor=()=>{let t="black";const e=this.player.damageBonus>0;return this.player.inventory.getArmor()&&this.player.inventory.getArmor().health,e&&(t=o.GameConstants.PLAYER_DAMAGE_BUFF_COLOR),t},this.outlineOpacity=()=>{let t=0;const e=this.player.damageBonus>0;return this.player.inventory.getArmor()&&this.player.inventory.getArmor().health,e&&(t=.25),t},this.flash=()=>{this.flashing=!0},this.disableFlash=()=>{this.flashing=!1},this.beginSlowMotion=()=>{this.slowMotionEnabled=!0},this.endSlowMotion=()=>{this.slowMotionEnabled=!1},this.setNewDrawXY=(t,e)=>{this.drawX+=t-this.player.x,this.drawY+=e-this.player.y},this.enableSlowMotion=()=>{this.motionSpeed<1&&!this.slowMotionEnabled&&(this.motionSpeed*=1.08,this.motionSpeed>=1&&(this.motionSpeed=1)),this.slowMotionEnabled&&this.motionSpeed>.25&&(this.motionSpeed*=.95,this.motionSpeed<.25&&(this.motionSpeed=.25))},this.updateSlowMotion=()=>{this.slowMotionTickDuration>0&&(this.slowMotionTickDuration-=1),0===this.slowMotionTickDuration&&(this.slowMotionEnabled=!1)},this.getJumpOffset=()=>this.jumpY,this.drawPlayerSprite=t=>{const e=this.player,i=e.inventory.divingHelmetEquipped(),a=i?this.divingHelmetTileX:1+Math.floor(this.frame),r=i?this.divingHelmetTileY+2*e.direction:8+2*e.direction;s.Game.ctx.save();const n=i?2:0;if(this.drawSmear())s.Game.drawMob(this.setSmearFrame().x,this.setSmearFrame().y,1,2,e.x-this.drawX-this.hitX,e.y-1.45-this.drawY-this.jumpY-this.hitY,1,2,this.shadeColor(),void 0,void 0,this.outlineColor(),this.outlineOpacity());else if("mouse"===this.player.inputHandler.mostRecentMoveInput&&this.mouseDiagonal()&&!o.GameConstants.isMobile){const t=180*this.player.inputHandler.mouseAngle()/Math.PI;let i={x:1,y:18};t>-150&&t<=-120&&(i={x:3,y:18+n}),t>-60&&t<=-30&&(i={x:4,y:18+n}),t>30&&t<=60&&(i={x:2,y:18+n}),t>120&&t<=150&&(i={x:1,y:18+n}),s.Game.drawMob(i.x,i.y,1,2,e.x-this.drawX-this.hitX,e.y-1.45-this.drawY-this.jumpY-this.hitY,1,2,this.shadeColor(),void 0,void 0,this.outlineColor(),this.outlineOpacity())}else this.frame+=.1*t,this.frame>=4&&(this.frame=0),s.Game.drawMob(a,r,1,2,e.x-this.drawX-this.hitX,e.y-1.45-this.drawY-this.jumpY-this.hitY,1,2,this.shadeColor(),void 0,void 0,this.outlineColor(),this.outlineOpacity());e.inventory.getArmor()&&e.inventory.getArmor().health,s.Game.ctx.restore()},this.mouseDiagonal=()=>{const t=180*this.player.inputHandler.mouseAngle()/Math.PI;return t>30&&t<60||t>120&&t<150||t>-150&&t<-120||t>-60&&t<-30},this.trackMouseLightingDirection=()=>{if(!o.GameConstants.NARROWED_LIGHTING_FOV||o.GameConstants.isMobile||!o.GameConstants.MOVE_WITH_MOUSE)return void(this.lightingDirectionBucket=null);const t=this.player.getRoom?this.player.getRoom():this.player.game.levels[this.player.depth].rooms[this.player.levelID];if(!t)return void(this.lightingDirectionBucket=null);const e=this.player.inputHandler;if("mouse"!==e?.mostRecentMoveInput)return void(this.lightingDirectionBucket=null);const i=this.normalizeDegrees(180*e.mouseAngle()/Math.PI),s=this.getMouseDirectionBucket(i);s!==this.lightingDirectionBucket&&(this.lightingDirectionBucket=s,t.updateLighting({x:this.player.x,y:this.player.y}))},this.getMouseDirectionBucket=t=>{const e=this.normalizeDegrees(t);return Math.floor((e+22.5)/45)%8},this.normalizeDegrees=t=>{const e=t%360;return e<0?e+360:e},this.drawSmear=()=>{if(this.player.direction===this.player.lastDirection)return!1;let t=100;const e=this.player.lastDirection,i=this.player.direction;return(i===s.Direction.UP&&e===s.Direction.DOWN||i===s.Direction.DOWN&&e===s.Direction.UP||i===s.Direction.LEFT&&e===s.Direction.RIGHT||i===s.Direction.RIGHT&&e===s.Direction.LEFT)&&(t=150),Date.now()-this.player.movement.lastChangeDirectionTime<=t},this.setSmearFrame=()=>{let t={x:1,y:18};const e=Date.now()-this.player.movement.lastChangeDirectionTime,i=50,o=this.player.inventory.divingHelmetEquipped();return t.y=o?20:18,this.player.direction===s.Direction.UP&&this.player.lastDirection===s.Direction.LEFT||this.player.direction===s.Direction.LEFT&&this.player.lastDirection===s.Direction.UP?(t.x=3,t):this.player.direction===s.Direction.UP&&this.player.lastDirection===s.Direction.RIGHT||this.player.direction===s.Direction.RIGHT&&this.player.lastDirection===s.Direction.UP?(t.x=4,t):this.player.direction===s.Direction.DOWN&&this.player.lastDirection===s.Direction.RIGHT||this.player.direction===s.Direction.RIGHT&&this.player.lastDirection===s.Direction.DOWN?(t.x=2,t):this.player.direction===s.Direction.DOWN&&this.player.lastDirection===s.Direction.LEFT||this.player.direction===s.Direction.LEFT&&this.player.lastDirection===s.Direction.DOWN?(t.x=1,t):this.player.direction===s.Direction.DOWN&&this.player.lastDirection===s.Direction.UP?(e<i&&(t.x=3),e>=i&&e<100&&(t.x=1,t.y=14,o&&(t.x=0,t.y=18)),e>=100&&e<150&&(t.x=1),t):this.player.direction===s.Direction.LEFT&&this.player.lastDirection===s.Direction.RIGHT?(e<i&&(t.x=2),e>=i&&e<100&&(t.x=1,t.y=8,o&&(t.x=0,t.y=12)),e>=100&&e<150&&(t.x=1),t):this.player.direction===s.Direction.UP&&this.player.lastDirection===s.Direction.DOWN?(e<i&&(t.x=2),e>=i&&e<100&&(t.x=1,t.y=12,o&&(t.x=0,t.y=16)),e>=100&&e<150&&(t.x=4),t):this.player.direction===s.Direction.RIGHT&&this.player.lastDirection===s.Direction.LEFT?(e<i&&(t.x=1),e>=i&&e<100&&(t.x=1,t.y=8,o&&(t.x=0,t.y=12)),e>=100&&e<150&&(t.x=2),t):void 0},this.draw=t=>{const e=this.player;s.Game.ctx.save(),this.trackMouseLightingDirection(),this.updateDrawXY(t),e.drawableY=e.y,this.flashingFrame+=12*t/o.GameConstants.FPS,e.dead||(u.Shadow.draw(e.x-this.drawX,e.y-this.drawY,1,1),this.flashing&&Math.floor(this.flashingFrame)%2!=0||this.drawPlayerSprite(t)),this.drawSpellBeam(t),s.Game.ctx.restore()},this.drawSpellBeam=t=>{s.Game.ctx.save(),this.player.inventory.getWeapon()instanceof d.Spellbook&&this.player.inventory.getWeapon().drawBeams(this.player.x-this.drawX,this.player.y-this.drawY,t),s.Game.ctx.restore()},this.shadeColor=()=>{const t=this.player;if(o.GameConstants.CUSTOM_SHADER_COLOR_ENABLED){const e=this.player.getRoom?this.player.getRoom():this.player.game.levels[this.player.depth].rooms[this.player.levelID];return c.Utils.rgbToHex(e.col[t.x][t.y][0],e.col[t.x][t.y][1],e.col[t.x][t.y][2])}return"black"},this.drawTopLayer=t=>{s.Game.ctx.save(),this.player.healthBar.draw(t,this.player.health,this.player.maxHealth,this.player.x-this.drawX,this.player.y-this.drawY,!this.flashing||Math.floor(this.flashingFrame)%2==0),s.Game.ctx.restore()},this.updateDrawXY=t=>{this.doneMoving()||(this.drawX*=.85**t,this.drawY*=.85**t,this.drawX=Math.abs(this.drawX)<.01?0:this.drawX,this.drawY=Math.abs(this.drawY)<.01?0:this.drawY),this.doneHitting()&&this.jump(t),this.doneHitting()||this.updateHitXY(t),this.enableSlowMotion(),o.GameConstants.ANIMATION_SPEED=this.motionSpeed},this.updateHitXY=t=>{this.hitX*=.7**t,this.hitY*=.7**t,this.hitX=Math.min(Math.max(this.hitX,-1),1),this.hitY=Math.min(Math.max(this.hitY,-1),1),Math.abs(this.hitX)<.01&&(this.hitX=0),Math.abs(this.hitY)<.01&&(this.hitY=0)},this.doneMoving=()=>Math.abs(this.drawX)<.01&&Math.abs(this.drawY)<.01,this.doneHitting=()=>Math.abs(this.hitX)<.01&&Math.abs(this.hitY)<.01,this.snapDrawStuff=()=>{this.drawX=0,this.drawY=0,this.hitX=0,this.hitY=0,this.jumpY=0},this.setHitXY=(t,e)=>{this.hitX=t,this.hitY=e},this.drawGUI=(t,e=!1)=>{if(s.Game.ctx.save(),this.player.dead){s.Game.ctx.fillStyle=r.LevelConstants.LEVEL_TEXT_COLOR;const t=l.statsTracker.getStats(),e=t.enemies,a=e.reduce((t,e)=>(t[e]=(t[e]||0)+1,t),{}),n=[];"enemy"!==this.player.lastHitBy?n.push(`You were slain by ${this.player.lastHitBy}.`):n.push("Game Over");const h=this.player.getRoom?this.player.getRoom():this.player.game.levels[this.player.depth].rooms[this.player.levelID];n.push(`Depth reached: ${h.depth}`),n.push(`${Object.values(a).reduce((t,e)=>t+e,0)} enemies killed in total:`);const c=[];Object.entries(a).forEach(([t,e])=>{c.push(`${t} x${e}`)});let d="Press space or click to restart";o.GameConstants.isMobile&&(d="Tap to restart");const m=s.Game.letter_height+2,u=16,g=2*m+u+10+8,f=20,w=Math.max(0,o.GameConstants.HEIGHT-g-f),E=n.length*m+.5*m,x=Math.max(0,w-E),b=Math.max(1,Math.floor(x/m));let T=b;const I=c.length;let S=Math.max(1,Math.ceil(I/T));S>1&&(T=Math.max(1,b-1),S=Math.max(1,Math.ceil(I/T))),this.player.deathScreenPageCount=S;const v=Math.min(Math.max(0,this.player.deathScreenPageIndex||0),S-1);this.player.deathScreenPageIndex=v;const A=v*T,M=Math.min(I,A+T),C=c.slice(A,M);let D=f;if(n.forEach((t,e)=>{const i=s.Game.measureText(t).width,a=e<=1?1.5*m:m;s.Game.fillText(t,o.GameConstants.WIDTH/2-i/2,D),D+=a}),C.forEach(t=>{const e=s.Game.measureText(t).width;s.Game.fillText(t,o.GameConstants.WIDTH/2-e/2,D),D+=m}),S>1){const t=`Page ${v+1}/${S}`,e=s.Game.measureText(t).width,i=o.GameConstants.HEIGHT-g-6;s.Game.fillText(t,o.GameConstants.WIDTH/2-e/2,i)}const O=s.Game.measureText(d).width,_=o.GameConstants.HEIGHT-g+4;if(s.Game.fillText(d,o.GameConstants.WIDTH/2-O/2,_),this.player.game.feedbackButton){const t=_+m+6,e=s.Game.measureText(this.player.game.feedbackButton.text).width+10,i=(o.GameConstants.WIDTH-e)/2;this.player.game.feedbackButton.x=i,this.player.game.feedbackButton.y=t,this.player.game.feedbackButton.draw()}if(!o.GameConstants.isMobile&&S>1){const t="Use arrow keys to view more",e=s.Game.measureText(t).width,i=(this.player.game.feedbackButton?.y||o.GameConstants.HEIGHT-20)+u+4;i<o.GameConstants.HEIGHT-2&&s.Game.fillText(t,o.GameConstants.WIDTH/2-e/2,i)}if(!this.player.game.hasRecordedStats){const s=Date.now()-this.player.game.gameStartTimeMs,o=this.player.inventory.items.filter(t=>t?.name&&t?.stackCount).map(t=>({name:t.name,stackSize:t.stackCount})),{createGameState:a}=i(5095);(0,p.safeRecordGameStats)({userId:(0,p.getOrCreateUserId)(),xp:t.xp,level:t.level,gameDurationMs:s,inventory:o,killedBy:this.player.lastHitBy??null,enemiesKilled:e,damageDone:t.damageDone,damageTaken:t.damageTaken,depthReached:h.depth,turnsPassed:t.turnsPassed,coinsCollected:t.coinsCollected,itemsCollected:t.itemsCollected,deviceType:(0,y.getDeviceInfo)(),sidePathsEntered:t.sidePathsEntered,weaponChoice:t.weaponChoice,gameState:a(this.player.game),gameVersion:this.player.game.version,loadedFromSaveFile:this.player.game.loadedFromSaveFile}),this.player.game.hasRecordedStats=!0}}else{this.player.bestiary&&this.player.bestiary.draw(t),this.guiHeartFrame>0&&(this.guiHeartFrame+=t),this.guiHeartFrame>5&&(this.guiHeartFrame=0);const i=this.player.inventory.getArmor(),a=this.player.inventory.getQuickbarStartX()+(i?-34:-24);let r=a/o.GameConstants.TILESIZE;r<.25&&(r=.25);for(let t=0;t<this.player.maxHealth;t++){let e=0,i=0;this.player.health<=1&&this.player.health!==this.player.maxHealth&&(e=Math.round(Math.sin(Date.now()/25/(t+1))+t/2)/2/o.GameConstants.TILESIZE,i=Math.round(Math.sin(Date.now()/25/(t+2))+t/2)/2/o.GameConstants.TILESIZE);let a=this.guiHeartFrame>0?1:0,n=o.GameConstants.WIDTH>175?0:-1.25;t>=Math.floor(this.player.health)?t==Math.floor(this.player.health)&&2*this.player.health%2==1?s.Game.drawFX(4,2,.75,.75,r+t/1.5+e,o.GameConstants.HEIGHT/o.GameConstants.TILESIZE-1+i+n,.75,.75):s.Game.drawFX(3,2,.75,.75,r+t/1.5+e,o.GameConstants.HEIGHT/o.GameConstants.TILESIZE-1+i+n,.75,.75):s.Game.drawFX(a,2,.75,.75,r+t/1.5+e,o.GameConstants.HEIGHT/o.GameConstants.TILESIZE-1+i+n,.75,.75)}this.drawBreathStatus(a),i&&i.drawGUI(t,this.player.maxHealth,a),e||this.player.inventory.draw(t);const h=this.player.inventory.isOpen,l=this.player.inventory.isPointInQuickbarBounds(n.MouseCursor.getInstance().getPosition().x,n.MouseCursor.getInstance().getPosition().y).inBounds&&!this.player.inventory.isOpen,c=this.player.openVendingMachine&&g.VendingMachine.isPointInVendingMachineBounds(n.MouseCursor.getInstance().getPosition().x,n.MouseCursor.getInstance().getPosition().y,this.player.openVendingMachine),d=this.player.inventory.isPointInInventoryBounds(n.MouseCursor.getInstance().getPosition().x,n.MouseCursor.getInstance().getPosition().y).inBounds,u=!o.GameConstants.IN_GAME_HOVER_TEXT_ENABLED||h||l||this.player.openVendingMachine?o.GameConstants.INVENTORY_HOVER_TEXT_ENABLED&&(h&&d||l)?"inventory":o.GameConstants.VENDING_MACHINE_HOVER_TEXT_ENABLED&&c?"vendingMachine":"none":"inGame";o.GameConstants.HOVER_TEXT_ENABLED&&m.HoverText.draw(t,this.player.x,this.player.y,this.player.getRoom?this.player.getRoom():this.player.game.levels[this.player.depth].rooms[this.player.levelID],this.player,n.MouseCursor.getInstance().getPosition().x,n.MouseCursor.getInstance().getPosition().y,u)}const a=this.player?.game,c=a?.getWaterOverlayOrigin?.()??{x:0,y:0};h.PostProcessor.draw(t,this.player?.getRoom()?.underwater??!1,c),this.hurting&&this.drawHurt(t),!0===this.player.mapToggled&&this.player.map.draw(t),this.drawTileCursor(t),this.player.setCursorIcon(),this.player.menu.open&&this.player.menu.draw(),s.Game.ctx.restore()},this.drawBreathStatus=t=>{const e=this.player.getEquippedDivingHelmet(),i=Math.max(8,t-16),a=o.GameConstants.HEIGHT-28;if(e){const t=Math.max(0,e.currentAir/e.maxAir);return s.Game.ctx.fillStyle="rgba(8, 20, 32, 0.65)",s.Game.ctx.fillRect(i,a,64,6),s.Game.ctx.fillStyle="#2bd6ff",s.Game.ctx.fillRect(i+1,a+1,Math.max(0,62*t),4),void s.Game.fillTextOutline(`Air ${Math.ceil(e.currentAir)}/${e.maxAir}`,i,a-2,o.GameConstants.OUTLINE,"white")}if(!this.player.isDrowning)return;const r=Math.max(0,this.player.getDrowningTurnsUntilDamage());s.Game.fillTextOutline(`Drowning ${r}t`,i,a-2,o.GameConstants.OUTLINE,o.GameConstants.WARNING_RED)},this.drawCooldownBar=()=>{s.Game.ctx.save(),this.player.cooldownRemaining>0?this.player.cooldownRemaining=1-(Date.now()-this.player.movement.lastMoveTime)/this.player.movement.adjustedCooldown:this.player.cooldownRemaining=0;const t=o.GameConstants.TILESIZE;s.Game.drawFX(12+Math.max(0,Math.min(14,Math.floor(17*this.player.cooldownRemaining))),2,1,1,.45,o.GameConstants.HEIGHT/t-2.125,1,1),s.Game.ctx.restore()},this.drawHurt=t=>{s.Game.ctx.save(),s.Game.ctx.globalAlpha=this.hurtAlpha,this.hurtAlpha-=this.hurtAlpha/10*t,this.hurtAlpha<=.01&&(this.hurtAlpha=0,this.hurting=!1,this.hurtingShield=!1),s.Game.ctx.globalCompositeOperation="source-over",s.Game.ctx.fillStyle="#cc3333",this.hurtingShield&&(s.Game.ctx.fillStyle="#639bff"),s.Game.ctx.fillRect(0,0,o.GameConstants.WIDTH,o.GameConstants.HEIGHT),s.Game.ctx.restore()},this.drawLowHealth=t=>{if(s.Game.ctx.save(),this.player.health<=1&&!this.player.dead){const e=.5;s.Game.ctx.globalAlpha=e,this.lowHealthFrame+=t;const i=s.Game.ctx.createLinearGradient(0,o.GameConstants.HEIGHT,0,2*o.GameConstants.HEIGHT/3);[i].forEach(t=>{t.addColorStop(0,"#cc3333"),t.addColorStop(1,"rgba(0, 0, 0, 0)")}),s.Game.ctx.globalCompositeOperation="source-over",s.Game.ctx.fillStyle=i,s.Game.ctx.fillRect(0,0,o.GameConstants.WIDTH,o.GameConstants.HEIGHT),s.Game.ctx.globalCompositeOperation="source-over",s.Game.ctx.globalAlpha=1}else this.lowHealthFrame=0;s.Game.ctx.restore()},this.heartbeat=()=>{this.guiHeartFrame=1},this.drawTileCursor=t=>{this.player.inventory.isOpen||"keyboard"===this.player.inputHandler.mostRecentMoveInput||o.GameConstants.isMobile||(s.Game.ctx.save(),this.player.mouseInLine()&&this.player.isMouseAboveFloor()&&!this.player.isMouseOnPlayerTile()&&(s.Game.drawFX(24+Math.floor(a.HitWarning.frame),5,1,1,this.player.tileCursor.x+this.player.drawX,this.player.tileCursor.y+this.player.drawY,1,1),s.Game.ctx.restore()))},this.jump=t=>{let e=Math.max(Math.abs(this.drawX),Math.abs(this.drawY));this.jumpY=Math.abs(Math.sin(e*Math.PI)*this.jumpHeight),Math.abs(this.jumpY)<.01&&(this.jumpY=0),this.jumpY>this.jumpHeight&&(this.jumpY=this.jumpHeight)},this.player=t,this.jumpY=0,this.flashingFrame=0,this.guiHeartFrame=0,this.motionSpeed=1,this.hitX=0,this.hitY=0,this.drawX=0,this.drawY=0,this.hurtAlpha=.25,this.jumpHeight=.25,this.hurting=!1,this.hurtingShield=!1,this.slowMotionEnabled=!1,this.slowMotionTickDuration=0,this.flashing=!1,this.lowHealthFrame=0,this.frame=0,this.lightingDirectionBucket=null}}},2057:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.UpLadder=void 0;const s=i(7851),o=i(3436),a=i(7366),r=i(3067),n=i(8583),h=i(3458),l=i(2103);class c extends n.Passageway{constructor(t,e,i,n,c=r.LockType.NONE){super(t,e,i,n),this.isRope=!1,this.isSidePath=!1,this.onCollide=t=>{if(this.game)if(this.lockable.isLocked())this.lockable.canUnlock(t)&&this.lockable.unlock(t);else try{this.linkedRoom||this.linkRoom();const e=this.exitDownLadderPos;if(this.isRope&&this.linkedRoom&&(this.game.currentPathId=this.linkedRoom.pathId||"main"),t.anchorOxygenLineToTile(this.room,this.x,this.y,{kind:"upLadder",angle:Math.PI/2}),t.getOxygenLine()?.update(!0),this.game.changeLevelThroughLadder(t,this),e&&this.linkedRoom){this.linkedRoom.__entryPositionFromLadder=e;try{console.log(`UpLadder.onCollide: wrote __entryPositionFromLadder (${e.x}, ${e.y}) onto parent room gid=${this.linkedRoom?.globalId}`)}catch{}}a.Sound.forestMusic.pause(),a.Sound.caveMusic.pause()}catch(t){console.error("Error during changeLevelThroughLadder:",t)}else console.error("Game instance is undefined in UpLadder:",this)},this.getName=()=>this.isRope?"rope up":"staircase up",this.linkRoom=()=>{if(this.isRope&&!this.linkedRoom){const t=this.game.levels[this.depth];if(t){for(const e of t.rooms)if(e.mapGroup<this.room.mapGroup)for(let t=e.roomX;t<e.roomX+e.width;t++)for(let i=e.roomY;i<e.roomY+e.height;i++){const s=e.roomArray[t]?.[i];if(s instanceof o.DownLadder&&s.isSidePath)return this.linkedRoom=e,void(s.linkedRoom=this.room)}const e=t.roomsById?t.roomsById.values().next().value:t.rooms[0];return void(this.linkedRoom=t.startRoom||e)}}this.depth-1>=0&&this.game.levels[this.depth-1]&&(this.linkedRoom=this.game.levels[this.depth-1].exitRoom)},this.draw=t=>{let e=29,i=0;this.isRope&&(e=16,i=1),s.Game.drawTile(1,this.skin,1,1,this.x,this.y,1,1,this.room.shadeColor,this.shadeAmount()),this.isRope?s.Game.drawTile(e,i+0,1,2,this.x,this.y-1,1,2,this.room.shadeColor,this.shadeAmount(0,-1,!1)):s.Game.drawTile(e,i,1,1,this.x,this.y-1,1,1,this.room.shadeColor,this.shadeAmount(0,-1,!1)),s.Game.drawTile(e,i+1,1,1,this.x,this.y,1,1,this.room.shadeColor,this.shadeAmount()),h.Shadow.draw(this.x,this.y+.25)},this.drawAboveShading=t=>{this.lockable.update(t),this.lockable.drawIcon(this.x,this.y,t),this.frame>100&&(this.frame=0),this.frame+=1*t,s.Game.drawFX(2,2,1,1,this.x,this.y-1.25+.125*Math.sin(this.frame*Math.PI/50),1,1)},this.drawAbovePlayer=t=>{this.isRope&&s.Game.drawTile(16,1,1,1,this.x,this.y-1,1,1,this.room.shadeColor,this.shadeAmount())},this.depth=t.depth,this.hasBloom=!0,this.bloomColor="#966432",this.bloomAlpha=1,this.softBloomAlpha=0,this.lockable=new r.Lockable(e,{lockType:c,isTopDoor:!0}),this.lightSource=new l.LightSource(this.x+.5,this.y+.5,3,[200,100,50],.25),this.room.lightSources.push(this.lightSource),this.room.updateLighting()}isLocked(){return this.lockable.isLocked()}}e.UpLadder=c},2102:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Decoration=void 0;const s=i(8160),o=i(6291),a=i(7851);class r extends s.Drawable{constructor(t,e,i){super(),this.shadeAmount=(t=0,e=0)=>o.GameConstants.SMOOTH_LIGHTING?0:this.room.softVis[this.x+t][this.y+e],this.isSolid=()=>!1,this.canCrushEnemy=()=>!1,this.isOpaque=()=>!1,this.onCollide=t=>{},this.onCollideEnemy=t=>{},this.tick=()=>{},this.tickEnd=()=>{},this.draw=t=>{},this.drawUnderPlayer=t=>{let e=1;this.applySkin&&(e=this.skin),a.Game.drawTile(1,e,1,1,this.x,this.y,1,1,this.room.shadeColor,this.shadeAmount())},this.drawAbovePlayer=t=>{},this.drawAboveShading=t=>{},this.skin=t.skin,this.room=t,this.x=e,this.y=i,this.drawableY=i,this.isDoor=!1,this.opacity=1,this.applySkin=!1}}e.Decoration=r},2103:(t,e)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.LightSource=void 0,e.LightSource=class{constructor(t,e,i,s=[180,60,5],o=1,a=1){this.b=1,this.dead=!1,this.updatePosition=(t,e)=>{this.x=t,this.y=e},this.shouldUpdate=()=>!0,this.x=t,this.y=e,this.r=i,this.c=s,this.b=o,this.falloffDecay=a,this.oldX=t,this.oldY=e,this.oldR=i,this.oldC=s,this.oldB=o,this.hasChanged=!0}}},2109:function(t,e,i){var s;!function(o,a){"use strict";var r,n="user-agent",h="",l="function",c="undefined",d="object",m="string",u="browser",p="cpu",y="device",g="engine",f="os",w="result",E="name",x="type",b="vendor",T="version",I="architecture",S="major",v="model",A="console",M="mobile",C="tablet",D="smarttv",O="wearable",_="xr",R="embedded",G="inapp",P="brands",L="formFactors",k="fullVersionList",N="platform",Y="platformVersion",B="bitness",H="sec-ch-ua",X=H+"-full-version-list",F=H+"-arch",W=H+"-"+B,U=H+"-form-factors",j=H+"-"+M,V=H+"-"+v,z=H+"-"+N,q=z+"-version",$=[P,k,M,v,N,Y,I,L,B],Z="Amazon",K="Apple",Q="ASUS",J="BlackBerry",tt="Google",et="Huawei",it="Lenovo",st="Honor",ot="LG",at="Microsoft",rt="Motorola",nt="Nvidia",ht="OnePlus",lt="OPPO",ct="Samsung",dt="Sharp",mt="Sony",ut="Xiaomi",pt="Zebra",yt="Chrome",gt="Chromium",ft="Chromecast",wt="Edge",Et="Firefox",xt="Opera",bt="Facebook",Tt="Sogou",It="Mobile ",St=" Browser",vt="Windows",At=typeof o!==c,Mt=At&&o.navigator?o.navigator:a,Ct=Mt&&Mt.userAgentData?Mt.userAgentData:a,Dt=function(t){for(var e={},i=0;i<t.length;i++)e[t[i].toUpperCase()]=t[i];return e},Ot=function(t,e){if(typeof t===d&&t.length>0){for(var i in t)if(Pt(e)==Pt(t[i]))return!0;return!1}return!!Rt(t)&&Pt(e)==Pt(t)},_t=function(t,e){for(var i in t)return/^(browser|cpu|device|engine|os)$/.test(i)||!!e&&_t(t[i])},Rt=function(t){return typeof t===m},Gt=function(t){if(!t)return a;for(var e=[],i=Nt(/\\?\"/g,t).split(","),s=0;s<i.length;s++)if(i[s].indexOf(";")>-1){var o=Bt(i[s]).split(";v=");e[s]={brand:o[0],version:o[1]}}else e[s]=Bt(i[s]);return e},Pt=function(t){return Rt(t)?t.toLowerCase():t},Lt=function(t){return Rt(t)?Nt(/[^\d\.]/g,t).split(".")[0]:a},kt=function(t){for(var e in t){var i=t[e];typeof i==d&&2==i.length?this[i[0]]=i[1]:this[i]=a}return this},Nt=function(t,e){return Rt(e)?e.replace(t,h):e},Yt=function(t){return Nt(/\\?\"/g,t)},Bt=function(t,e){if(Rt(t))return t=Nt(/^\s\s*/,t),typeof e===c?t:t.substring(0,500)},Ht=function(t,e){if(t&&e)for(var i,s,o,r,n,h,c=0;c<e.length&&!n;){var m=e[c],u=e[c+1];for(i=s=0;i<m.length&&!n&&m[i];)if(n=m[i++].exec(t))for(o=0;o<u.length;o++)h=n[++s],typeof(r=u[o])===d&&r.length>0?2===r.length?typeof r[1]==l?this[r[0]]=r[1].call(this,h):this[r[0]]=r[1]:r.length>=3&&(typeof r[1]!==l||r[1].exec&&r[1].test?3==r.length?this[r[0]]=h?h.replace(r[1],r[2]):a:4==r.length?this[r[0]]=h?r[3].call(this,h.replace(r[1],r[2])):a:r.length>4&&(this[r[0]]=h?r[3].apply(this,[h.replace(r[1],r[2])].concat(r.slice(4))):a):r.length>3?this[r[0]]=h?r[1].apply(this,r.slice(2)):a:this[r[0]]=h?r[1].call(this,h,r[2]):a):this[r]=h||a;c+=2}},Xt=function(t,e){for(var i in e)if(typeof e[i]===d&&e[i].length>0){for(var s=0;s<e[i].length;s++)if(Ot(e[i][s],t))return"?"===i?a:i}else if(Ot(e[i],t))return"?"===i?a:i;return e.hasOwnProperty("*")?e["*"]:t},Ft={ME:"4.90","NT 3.51":"3.51","NT 4.0":"4.0",2e3:["5.0","5.01"],XP:["5.1","5.2"],Vista:"6.0",7:"6.1",8:"6.2",8.1:"6.3",10:["6.4","10.0"],NT:""},Wt={embedded:"Automotive",mobile:"Mobile",tablet:["Tablet","EInk"],smarttv:"TV",wearable:"Watch",xr:["VR","XR"],"?":["Desktop","Unknown"],"*":a},Ut={Chrome:"Google Chrome",Edge:"Microsoft Edge","Edge WebView2":"Microsoft Edge WebView2","Chrome WebView":"Android WebView","Chrome Headless":"HeadlessChrome","Huawei Browser":"HuaweiBrowser","MIUI Browser":"Miui Browser","Opera Mobi":"OperaMobile",Yandex:"YaBrowser"},jt={browser:[[/\b(?:crmo|crios)\/([\w\.]+)/i],[T,[E,It+"Chrome"]],[/webview.+edge\/([\w\.]+)/i],[T,[E,wt+" WebView"]],[/edg(?:e|ios|a)?\/([\w\.]+)/i],[T,[E,"Edge"]],[/(opera mini)\/([-\w\.]+)/i,/(opera [mobiletab]{3,6})\b.+version\/([-\w\.]+)/i,/(opera)(?:.+version\/|[\/ ]+)([\w\.]+)/i],[E,T],[/opios[\/ ]+([\w\.]+)/i],[T,[E,xt+" Mini"]],[/\bop(?:rg)?x\/([\w\.]+)/i],[T,[E,xt+" GX"]],[/\bopr\/([\w\.]+)/i],[T,[E,xt]],[/\bb[ai]*d(?:uhd|[ub]*[aekoprswx]{5,6})[\/ ]?([\w\.]+)/i],[T,[E,"Baidu"]],[/\b(?:mxbrowser|mxios|myie2)\/?([-\w\.]*)\b/i],[T,[E,"Maxthon"]],[/(kindle)\/([\w\.]+)/i,/(lunascape|maxthon|netfront|jasmine|blazer|sleipnir)[\/ ]?([\w\.]*)/i,/(avant|iemobile|slim(?:browser|boat|jet))[\/ ]?([\d\.]*)/i,/(?:ms|\()(ie) ([\w\.]+)/i,/(flock|rockmelt|midori|epiphany|silk|skyfire|ovibrowser|bolt|iron|vivaldi|iridium|phantomjs|bowser|qupzilla|falkon|rekonq|puffin|brave|whale(?!.+naver)|qqbrowserlite|duckduckgo|klar|helio|(?=comodo_)?dragon|otter|dooble|(?:lg |qute)browser)\/([-\w\.]+)/i,/(heytap|ovi|115|surf)browser\/([\d\.]+)/i,/(ecosia|weibo)(?:__| \w+@)([\d\.]+)/i],[E,T],[/quark(?:pc)?\/([-\w\.]+)/i],[T,[E,"Quark"]],[/\bddg\/([\w\.]+)/i],[T,[E,"DuckDuckGo"]],[/(?:\buc? ?browser|(?:juc.+)ucweb)[\/ ]?([\w\.]+)/i],[T,[E,"UCBrowser"]],[/microm.+\bqbcore\/([\w\.]+)/i,/\bqbcore\/([\w\.]+).+microm/i,/micromessenger\/([\w\.]+)/i],[T,[E,"WeChat"]],[/konqueror\/([\w\.]+)/i],[T,[E,"Konqueror"]],[/trident.+rv[: ]([\w\.]{1,9})\b.+like gecko/i],[T,[E,"IE"]],[/ya(?:search)?browser\/([\w\.]+)/i],[T,[E,"Yandex"]],[/slbrowser\/([\w\.]+)/i],[T,[E,"Smart "+it+St]],[/(avast|avg)\/([\w\.]+)/i],[[E,/(.+)/,"$1 Secure"+St],T],[/\bfocus\/([\w\.]+)/i],[T,[E,Et+" Focus"]],[/\bopt\/([\w\.]+)/i],[T,[E,xt+" Touch"]],[/coc_coc\w+\/([\w\.]+)/i],[T,[E,"Coc Coc"]],[/dolfin\/([\w\.]+)/i],[T,[E,"Dolphin"]],[/coast\/([\w\.]+)/i],[T,[E,xt+" Coast"]],[/miuibrowser\/([\w\.]+)/i],[T,[E,"MIUI"+St]],[/fxios\/([\w\.-]+)/i],[T,[E,It+Et]],[/\bqihoobrowser\/?([\w\.]*)/i],[T,[E,"360"]],[/\b(qq)\/([\w\.]+)/i],[[E,/(.+)/,"$1Browser"],T],[/(oculus|sailfish|huawei|vivo|pico)browser\/([\w\.]+)/i],[[E,/(.+)/,"$1"+St],T],[/samsungbrowser\/([\w\.]+)/i],[T,[E,ct+" Internet"]],[/metasr[\/ ]?([\d\.]+)/i],[T,[E,Tt+" Explorer"]],[/(sogou)mo\w+\/([\d\.]+)/i],[[E,Tt+" Mobile"],T],[/(electron)\/([\w\.]+) safari/i,/(tesla)(?: qtcarbrowser|\/(20\d\d\.[-\w\.]+))/i,/m?(qqbrowser|2345(?=browser|chrome|explorer))\w*[\/ ]?v?([\w\.]+)/i],[E,T],[/(lbbrowser|rekonq)/i],[E],[/ome\/([\w\.]+) \w* ?(iron) saf/i,/ome\/([\w\.]+).+qihu (360)[es]e/i],[T,E],[/((?:fban\/fbios|fb_iab\/fb4a)(?!.+fbav)|;fbav\/([\w\.]+);)/i],[[E,bt],T,[x,G]],[/(kakao(?:talk|story))[\/ ]([\w\.]+)/i,/(naver)\(.*?(\d+\.[\w\.]+).*\)/i,/(daum)apps[\/ ]([\w\.]+)/i,/safari (line)\/([\w\.]+)/i,/\b(line)\/([\w\.]+)\/iab/i,/(alipay)client\/([\w\.]+)/i,/(twitter)(?:and| f.+e\/([\w\.]+))/i,/(instagram|snapchat|klarna)[\/ ]([-\w\.]+)/i],[E,T,[x,G]],[/\bgsa\/([\w\.]+) .*safari\//i],[T,[E,"GSA"],[x,G]],[/musical_ly(?:.+app_?version\/|_)([\w\.]+)/i],[T,[E,"TikTok"],[x,G]],[/\[(linkedin)app\]/i],[E,[x,G]],[/(chromium)[\/ ]([-\w\.]+)/i],[E,T],[/headlesschrome(?:\/([\w\.]+)| )/i],[T,[E,yt+" Headless"]],[/wv\).+chrome\/([\w\.]+).+edgw\//i],[T,[E,wt+" WebView2"]],[/ wv\).+(chrome)\/([\w\.]+)/i],[[E,yt+" WebView"],T],[/droid.+ version\/([\w\.]+)\b.+(?:mobile safari|safari)/i],[T,[E,"Android"+St]],[/chrome\/([\w\.]+) mobile/i],[T,[E,It+"Chrome"]],[/(chrome|omniweb|arora|[tizenoka]{5} ?browser)\/v?([\w\.]+)/i],[E,T],[/version\/([\w\.\,]+) .*mobile(?:\/\w+ | ?)safari/i],[T,[E,It+"Safari"]],[/iphone .*mobile(?:\/\w+ | ?)safari/i],[[E,It+"Safari"]],[/version\/([\w\.\,]+) .*(safari)/i],[T,E],[/webkit.+?(mobile ?safari|safari)(\/[\w\.]+)/i],[E,[T,"1"]],[/(webkit|khtml)\/([\w\.]+)/i],[E,T],[/(?:mobile|tablet);.*(firefox)\/([\w\.-]+)/i],[[E,It+Et],T],[/(navigator|netscape\d?)\/([-\w\.]+)/i],[[E,"Netscape"],T],[/(wolvic|librewolf)\/([\w\.]+)/i],[E,T],[/mobile vr; rv:([\w\.]+)\).+firefox/i],[T,[E,Et+" Reality"]],[/ekiohf.+(flow)\/([\w\.]+)/i,/(swiftfox)/i,/(icedragon|iceweasel|camino|chimera|fennec|maemo browser|minimo|conkeror)[\/ ]?([\w\.\+]+)/i,/(seamonkey|k-meleon|icecat|iceape|firebird|phoenix|palemoon|basilisk|waterfox)\/([-\w\.]+)$/i,/(firefox)\/([\w\.]+)/i,/(mozilla)\/([\w\.]+) .+rv\:.+gecko\/\d+/i,/(amaya|dillo|doris|icab|ladybird|lynx|mosaic|netsurf|obigo|polaris|w3m|(?:go|ice|up)[\. ]?browser)[-\/ ]?v?([\w\.]+)/i,/\b(links) \(([\w\.]+)/i],[E,[T,/_/g,"."]],[/(cobalt)\/([\w\.]+)/i],[E,[T,/[^\d\.]+./,h]]],cpu:[[/\b((amd|x|x86[-_]?|wow|win)64)\b/i],[[I,"amd64"]],[/(ia32(?=;))/i,/\b((i[346]|x)86)(pc)?\b/i],[[I,"ia32"]],[/\b(aarch64|arm(v?[89]e?l?|_?64))\b/i],[[I,"arm64"]],[/\b(arm(v[67])?ht?n?[fl]p?)\b/i],[[I,"armhf"]],[/( (ce|mobile); ppc;|\/[\w\.]+arm\b)/i],[[I,"arm"]],[/((ppc|powerpc)(64)?)( mac|;|\))/i],[[I,/ower/,h,Pt]],[/ sun4\w[;\)]/i],[[I,"sparc"]],[/\b(avr32|ia64(?=;)|68k(?=\))|\barm(?=v([1-7]|[5-7]1)l?|;|eabi)|(irix|mips|sparc)(64)?\b|pa-risc)/i],[[I,Pt]]],device:[[/\b(sch-i[89]0\d|shw-m380s|sm-[ptx]\w{2,4}|gt-[pn]\d{2,4}|sgh-t8[56]9|nexus 10)/i],[v,[b,ct],[x,C]],[/\b((?:s[cgp]h|gt|sm)-(?![lr])\w+|sc[g-]?[\d]+a?|galaxy nexus)/i,/samsung[- ]((?!sm-[lr]|browser)[-\w]+)/i,/sec-(sgh\w+)/i],[v,[b,ct],[x,M]],[/(?:\/|\()(ip(?:hone|od)[\w, ]*)(?:\/|;)/i],[v,[b,K],[x,M]],[/\((ipad);[-\w\),; ]+apple/i,/applecoremedia\/[\w\.]+ \((ipad)/i,/\b(ipad)\d\d?,\d\d?[;\]].+ios/i],[v,[b,K],[x,C]],[/(macintosh);/i],[v,[b,K]],[/\b(sh-?[altvz]?\d\d[a-ekm]?)/i],[v,[b,dt],[x,M]],[/\b((?:brt|eln|hey2?|gdi|jdn)-a?[lnw]09|(?:ag[rm]3?|jdn2|kob2)-a?[lw]0[09]hn)(?: bui|\)|;)/i],[v,[b,st],[x,C]],[/honor([-\w ]+)[;\)]/i],[v,[b,st],[x,M]],[/\b((?:ag[rs][2356]?k?|bah[234]?|bg[2o]|bt[kv]|cmr|cpn|db[ry]2?|jdn2|got|kob2?k?|mon|pce|scm|sht?|[tw]gr|vrd)-[ad]?[lw][0125][09]b?|605hw|bg2-u03|(?:gem|fdr|m2|ple|t1)-[7a]0[1-4][lu]|t1-a2[13][lw]|mediapad[\w\. ]*(?= bui|\)))\b(?!.+d\/s)/i],[v,[b,et],[x,C]],[/(?:huawei)([-\w ]+)[;\)]/i,/\b(nexus 6p|\w{2,4}e?-[atu]?[ln][\dx][012359c][adn]?)\b(?!.+d\/s)/i],[v,[b,et],[x,M]],[/oid[^\)]+; (2[\dbc]{4}(182|283|rp\w{2})[cgl]|m2105k81a?c)(?: bui|\))/i,/\b((?:red)?mi[-_ ]?pad[\w- ]*)(?: bui|\))/i],[[v,/_/g," "],[b,ut],[x,C]],[/\b(poco[\w ]+|m2\d{3}j\d\d[a-z]{2})(?: bui|\))/i,/\b; (\w+) build\/hm\1/i,/\b(hm[-_ ]?note?[_ ]?(?:\d\w)?) bui/i,/\b(redmi[\-_ ]?(?:note|k)?[\w_ ]+)(?: bui|\))/i,/oid[^\)]+; (m?[12][0-389][01]\w{3,6}[c-y])( bui|; wv|\))/i,/\b(mi[-_ ]?(?:a\d|one|one[_ ]plus|note lte|max|cc)?[_ ]?(?:\d?\w?)[_ ]?(?:plus|se|lite|pro)?)(?: bui|\))/i,/ ([\w ]+) miui\/v?\d/i],[[v,/_/g," "],[b,ut],[x,M]],[/droid.+; (cph2[3-6]\d[13579]|((gm|hd)19|(ac|be|in|kb)20|(d[en]|eb|le|mt)21|ne22)[0-2]\d|p[g-k]\w[1m]10)\b/i,/(?:one)?(?:plus)? (a\d0\d\d)(?: b|\))/i],[v,[b,ht],[x,M]],[/; (\w+) bui.+ oppo/i,/\b(cph[12]\d{3}|p(?:af|c[al]|d\w|e[ar])[mt]\d0|x9007|a101op)\b/i],[v,[b,lt],[x,M]],[/\b(opd2(\d{3}a?))(?: bui|\))/i],[v,[b,Xt,{OnePlus:["203","304","403","404","413","415"],"*":lt}],[x,C]],[/(vivo (5r?|6|8l?|go|one|s|x[il]?[2-4]?)[\w\+ ]*)(?: bui|\))/i],[v,[b,"BLU"],[x,M]],[/; vivo (\w+)(?: bui|\))/i,/\b(v[12]\d{3}\w?[at])(?: bui|;)/i],[v,[b,"Vivo"],[x,M]],[/\b(rmx[1-3]\d{3})(?: bui|;|\))/i],[v,[b,"Realme"],[x,M]],[/(ideatab[-\w ]+|602lv|d-42a|a101lv|a2109a|a3500-hv|s[56]000|pb-6505[my]|tb-?x?\d{3,4}(?:f[cu]|xu|[av])|yt\d?-[jx]?\d+[lfmx])( bui|;|\)|\/)/i,/lenovo ?(b[68]0[08]0-?[hf]?|tab(?:[\w- ]+?)|tb[\w-]{6,7})( bui|;|\)|\/)/i],[v,[b,it],[x,C]],[/lenovo[-_ ]?([-\w ]+?)(?: bui|\)|\/)/i],[v,[b,it],[x,M]],[/\b(milestone|droid(?:[2-4x]| (?:bionic|x2|pro|razr))?:?( 4g)?)\b[\w ]+build\//i,/\bmot(?:orola)?[- ]([\w\s]+)(\)| bui)/i,/((?:moto(?! 360)[-\w\(\) ]+|xt\d{3,4}[cgkosw\+]?[-\d]*|nexus 6)(?= bui|\)))/i],[v,[b,rt],[x,M]],[/\b(mz60\d|xoom[2 ]{0,2}) build\//i],[v,[b,rt],[x,C]],[/((?=lg)?[vl]k\-?\d{3}) bui| 3\.[-\w; ]{10}lg?-([06cv9]{3,4})/i],[v,[b,ot],[x,C]],[/(lm(?:-?f100[nv]?|-[\w\.]+)(?= bui|\))|nexus [45])/i,/\blg[-e;\/ ]+(?!.*(?:browser|netcast|android tv|watch|webos))(\w+)/i,/\blg-?([\d\w]+) bui/i],[v,[b,ot],[x,M]],[/(nokia) (t[12][01])/i],[b,v,[x,C]],[/(?:maemo|nokia).*(n900|lumia \d+|rm-\d+)/i,/nokia[-_ ]?(([-\w\. ]*))/i],[[v,/_/g," "],[x,M],[b,"Nokia"]],[/(pixel (c|tablet))\b/i],[v,[b,tt],[x,C]],[/droid.+;(?: google)? (g(01[13]a|020[aem]|025[jn]|1b60|1f8f|2ybb|4s1m|576d|5nz6|8hhn|8vou|a02099|c15s|d1yq|e2ae|ec77|gh2x|kv4x|p4bc|pj41|r83y|tt9q|ur25|wvk6)|pixel[\d ]*a?( pro)?( xl)?( fold)?( \(5g\))?)( bui|\))/i],[v,[b,tt],[x,M]],[/(google) (pixelbook( go)?)/i],[b,v],[/droid.+; (a?\d[0-2]{2}so|[c-g]\d{4}|so[-gl]\w+|xq-\w\w\d\d)(?= bui|\).+chrome\/(?![1-6]{0,1}\d\.))/i],[v,[b,mt],[x,M]],[/sony tablet [ps]/i,/\b(?:sony)?sgp\w+(?: bui|\))/i],[[v,"Xperia Tablet"],[b,mt],[x,C]],[/(alexa)webm/i,/(kf[a-z]{2}wi|aeo(?!bc)\w\w)( bui|\))/i,/(kf[a-z]+)( bui|\)).+silk\//i],[v,[b,Z],[x,C]],[/((?:sd|kf)[0349hijorstuw]+)( bui|\)).+silk\//i],[[v,/(.+)/g,"Fire Phone $1"],[b,Z],[x,M]],[/(playbook);[-\w\),; ]+(rim)/i],[v,b,[x,C]],[/\b((?:bb[a-f]|st[hv])100-\d)/i,/\(bb10; (\w+)/i],[v,[b,J],[x,M]],[/(?:\b|asus_)(transfo[prime ]{4,10} \w+|eeepc|slider \w+|nexus 7|padfone|p00[cj])/i],[v,[b,Q],[x,C]],[/ (z[bes]6[027][012][km][ls]|zenfone \d\w?)\b/i],[v,[b,Q],[x,M]],[/(nexus 9)/i],[v,[b,"HTC"],[x,C]],[/(htc)[-;_ ]{1,2}([\w ]+(?=\)| bui)|\w+)/i,/(zte)[- ]([\w ]+?)(?: bui|\/|\))/i,/(alcatel|geeksphone|nexian|panasonic(?!(?:;|\.))|sony(?!-bra))[-_ ]?([-\w]*)/i],[b,[v,/_/g," "],[x,M]],[/tcl (xess p17aa)/i,/droid [\w\.]+; ((?:8[14]9[16]|9(?:0(?:48|60|8[01])|1(?:3[27]|66)|2(?:6[69]|9[56])|466))[gqswx])(_\w(\w|\w\w))?(\)| bui)/i],[v,[b,"TCL"],[x,C]],[/droid [\w\.]+; (418(?:7d|8v)|5087z|5102l|61(?:02[dh]|25[adfh]|27[ai]|56[dh]|59k|65[ah])|a509dl|t(?:43(?:0w|1[adepqu])|50(?:6d|7[adju])|6(?:09dl|10k|12b|71[efho]|76[hjk])|7(?:66[ahju]|67[hw]|7[045][bh]|71[hk]|73o|76[ho]|79w|81[hks]?|82h|90[bhsy]|99b)|810[hs]))(_\w(\w|\w\w))?(\)| bui)/i],[v,[b,"TCL"],[x,M]],[/(itel) ((\w+))/i],[[b,Pt],v,[x,Xt,{tablet:["p10001l","w7001"],"*":"mobile"}]],[/droid.+; ([ab][1-7]-?[0178a]\d\d?)/i],[v,[b,"Acer"],[x,C]],[/droid.+; (m[1-5] note) bui/i,/\bmz-([-\w]{2,})/i],[v,[b,"Meizu"],[x,M]],[/; ((?:power )?armor(?:[\w ]{0,8}))(?: bui|\))/i],[v,[b,"Ulefone"],[x,M]],[/; (energy ?\w+)(?: bui|\))/i,/; energizer ([\w ]+)(?: bui|\))/i],[v,[b,"Energizer"],[x,M]],[/; cat (b35);/i,/; (b15q?|s22 flip|s48c|s62 pro)(?: bui|\))/i],[v,[b,"Cat"],[x,M]],[/((?:new )?andromax[\w- ]+)(?: bui|\))/i],[v,[b,"Smartfren"],[x,M]],[/droid.+; (a(in)?(0(15|59|6[35])|142)p?)/i],[v,[b,"Nothing"],[x,M]],[/; (x67 5g|tikeasy \w+|ac[1789]\d\w+)( b|\))/i,/archos ?(5|gamepad2?|([\w ]*[t1789]|hello) ?\d+[\w ]*)( b|\))/i],[v,[b,"Archos"],[x,C]],[/archos ([\w ]+)( b|\))/i,/; (ac[3-6]\d\w{2,8})( b|\))/i],[v,[b,"Archos"],[x,M]],[/; (n159v)/i],[v,[b,"HMD"],[x,M]],[/(imo) (tab \w+)/i,/(infinix|tecno) (x1101b?|p904|dp(7c|8d|10a)( pro)?|p70[1-3]a?|p904|t1101)/i],[b,v,[x,C]],[/(blackberry|benq|palm(?=\-)|sonyericsson|acer|asus(?! zenw)|dell|jolla|meizu|motorola|polytron|tecno|micromax|advan)[-_ ]?([-\w]*)/i,/; (blu|hmd|imo|infinix|lava|oneplus|tcl)[_ ]([\w\+ ]+?)(?: bui|\)|; r)/i,/(hp) ([\w ]+\w)/i,/(microsoft); (lumia[\w ]+)/i,/(oppo) ?([\w ]+) bui/i],[b,v,[x,M]],[/(kobo)\s(ereader|touch)/i,/(hp).+(touchpad(?!.+tablet)|tablet)/i,/(kindle)\/([\w\.]+)/i],[b,v,[x,C]],[/(surface duo)/i],[v,[b,at],[x,C]],[/droid [\d\.]+; (fp\du?)(?: b|\))/i],[v,[b,"Fairphone"],[x,M]],[/((?:tegranote|shield t(?!.+d tv))[\w- ]*?)(?: b|\))/i],[v,[b,nt],[x,C]],[/(sprint) (\w+)/i],[b,v,[x,M]],[/(kin\.[onetw]{3})/i],[[v,/\./g," "],[b,at],[x,M]],[/droid.+; ([c6]+|et5[16]|mc[239][23]x?|vc8[03]x?)\)/i],[v,[b,pt],[x,C]],[/droid.+; (ec30|ps20|tc[2-8]\d[kx])\)/i],[v,[b,pt],[x,M]],[/smart-tv.+(samsung)/i],[b,[x,D]],[/hbbtv.+maple;(\d+)/i],[[v,/^/,"SmartTV"],[b,ct],[x,D]],[/(vizio)(?: |.+model\/)(\w+-\w+)/i,/tcast.+(lg)e?. ([-\w]+)/i],[b,v,[x,D]],[/(nux; netcast.+smarttv|lg (netcast\.tv-201\d|android tv))/i],[[b,ot],[x,D]],[/(apple) ?tv/i],[b,[v,K+" TV"],[x,D]],[/crkey.*devicetype\/chromecast/i],[[v,ft+" Third Generation"],[b,tt],[x,D]],[/crkey.*devicetype\/([^/]*)/i],[[v,/^/,"Chromecast "],[b,tt],[x,D]],[/fuchsia.*crkey/i],[[v,ft+" Nest Hub"],[b,tt],[x,D]],[/crkey/i],[[v,ft],[b,tt],[x,D]],[/(portaltv)/i],[v,[b,bt],[x,D]],[/droid.+aft(\w+)( bui|\))/i],[v,[b,Z],[x,D]],[/(shield \w+ tv)/i],[v,[b,nt],[x,D]],[/\(dtv[\);].+(aquos)/i,/(aquos-tv[\w ]+)\)/i],[v,[b,dt],[x,D]],[/(bravia[\w ]+)( bui|\))/i],[v,[b,mt],[x,D]],[/(mi(tv|box)-?\w+) bui/i],[v,[b,ut],[x,D]],[/Hbbtv.*(technisat) (.*);/i],[b,v,[x,D]],[/\b(roku)[\dx]*[\)\/]((?:dvp-)?[\d\.]*)/i,/hbbtv\/\d+\.\d+\.\d+ +\([\w\+ ]*; *([\w\d][^;]*);([^;]*)/i],[[b,/.+\/(\w+)/,"$1",Xt,{LG:"lge"}],[v,Bt],[x,D]],[/droid.+; ([\w- ]+) (?:android tv|smart[- ]?tv)/i],[v,[x,D]],[/\b(android tv|smart[- ]?tv|opera tv|tv; rv:|large screen[\w ]+safari)\b/i],[[x,D]],[/(playstation \w+)/i],[v,[b,mt],[x,A]],[/\b(xbox(?: one)?(?!; xbox))[\); ]/i],[v,[b,at],[x,A]],[/(ouya)/i,/(nintendo) (\w+)/i,/(retroid) (pocket ([^\)]+))/i],[b,v,[x,A]],[/droid.+; (shield)( bui|\))/i],[v,[b,nt],[x,A]],[/\b(sm-[lr]\d\d[0156][fnuw]?s?|gear live)\b/i],[v,[b,ct],[x,O]],[/((pebble))app/i,/(asus|google|lg|oppo) ((pixel |zen)?watch[\w ]*)( bui|\))/i],[b,v,[x,O]],[/(ow(?:19|20)?we?[1-3]{1,3})/i],[v,[b,lt],[x,O]],[/(watch)(?: ?os[,\/]|\d,\d\/)[\d\.]+/i],[v,[b,K],[x,O]],[/(opwwe\d{3})/i],[v,[b,ht],[x,O]],[/(moto 360)/i],[v,[b,rt],[x,O]],[/(smartwatch 3)/i],[v,[b,mt],[x,O]],[/(g watch r)/i],[v,[b,ot],[x,O]],[/droid.+; (wt63?0{2,3})\)/i],[v,[b,pt],[x,O]],[/droid.+; (glass) \d/i],[v,[b,tt],[x,_]],[/(pico) (4|neo3(?: link|pro)?)/i],[b,v,[x,_]],[/(quest( \d| pro)?s?).+vr/i],[v,[b,bt],[x,_]],[/mobile vr; rv.+firefox/i],[[x,_]],[/(tesla)(?: qtcarbrowser|\/[-\w\.]+)/i],[b,[x,R]],[/(aeobc)\b/i],[v,[b,Z],[x,R]],[/(homepod).+mac os/i],[v,[b,K],[x,R]],[/windows iot/i],[[x,R]],[/droid .+?; ([^;]+?)(?: bui|; wv\)|\) applew).+?(mobile|vr|\d) safari/i],[v,[x,Xt,{mobile:"Mobile",xr:"VR","*":C}]],[/\b((tablet|tab)[;\/]|focus\/\d(?!.+mobile))/i],[[x,C]],[/(phone|mobile(?:[;\/]| [ \w\/\.]*safari)|pda(?=.+windows ce))/i],[[x,M]],[/droid .+?; ([\w\. -]+)( bui|\))/i],[v,[b,"Generic"]]],engine:[[/windows.+ edge\/([\w\.]+)/i],[T,[E,wt+"HTML"]],[/(arkweb)\/([\w\.]+)/i],[E,T],[/webkit\/537\.36.+chrome\/(?!27)([\w\.]+)/i],[T,[E,"Blink"]],[/(presto)\/([\w\.]+)/i,/(webkit|trident|netfront|netsurf|amaya|lynx|w3m|goanna|servo)\/([\w\.]+)/i,/ekioh(flow)\/([\w\.]+)/i,/(khtml|tasman|links)[\/ ]\(?([\w\.]+)/i,/(icab)[\/ ]([23]\.[\d\.]+)/i,/\b(libweb)/i],[E,T],[/ladybird\//i],[[E,"LibWeb"]],[/rv\:([\w\.]{1,9})\b.+(gecko)/i],[T,E]],os:[[/(windows nt) (6\.[23]); arm/i],[[E,/N/,"R"],[T,Xt,Ft]],[/(windows (?:phone|mobile|iot))(?: os)?[\/ ]?([\d\.]*( se)?)/i,/(windows)[\/ ](1[01]|2000|3\.1|7|8(\.1)?|9[58]|me|server 20\d\d( r2)?|vista|xp)/i],[E,T],[/windows nt ?([\d\.\)]*)(?!.+xbox)/i,/\bwin(?=3| ?9|n)(?:nt| 9x )?([\d\.;]*)/i],[[T,/(;|\))/g,"",Xt,Ft],[E,vt]],[/(windows ce)\/?([\d\.]*)/i],[E,T],[/[adehimnop]{4,7}\b(?:.*os ([\w]+) like mac|; opera)/i,/(?:ios;fbsv\/|iphone.+ios[\/ ])([\d\.]+)/i,/cfnetwork\/.+darwin/i],[[T,/_/g,"."],[E,"iOS"]],[/(mac os x) ?([\w\. ]*)/i,/(macintosh|mac_powerpc\b)(?!.+(haiku|morphos))/i],[[E,"macOS"],[T,/_/g,"."]],[/android ([\d\.]+).*crkey/i],[T,[E,ft+" Android"]],[/fuchsia.*crkey\/([\d\.]+)/i],[T,[E,ft+" Fuchsia"]],[/crkey\/([\d\.]+).*devicetype\/smartspeaker/i],[T,[E,ft+" SmartSpeaker"]],[/linux.*crkey\/([\d\.]+)/i],[T,[E,ft+" Linux"]],[/crkey\/([\d\.]+)/i],[T,[E,ft]],[/droid ([\w\.]+)\b.+(android[- ]x86)/i],[T,E],[/(ubuntu) ([\w\.]+) like android/i],[[E,/(.+)/,"$1 Touch"],T],[/(harmonyos)[\/ ]?([\d\.]*)/i,/(android|bada|blackberry|kaios|maemo|meego|openharmony|qnx|rim tablet os|sailfish|series40|symbian|tizen)\w*[-\/\.; ]?([\d\.]*)/i],[E,T],[/\(bb(10);/i],[T,[E,J]],[/(?:symbian ?os|symbos|s60(?=;)|series ?60)[-\/ ]?([\w\.]*)/i],[T,[E,"Symbian"]],[/mozilla\/[\d\.]+ \((?:mobile|tablet|tv|mobile; [\w ]+); rv:.+ gecko\/([\w\.]+)/i],[T,[E,Et+" OS"]],[/\b(?:hp)?wos(?:browser)?\/([\w\.]+)/i,/webos(?:[ \/]?|\.tv-20(?=2[2-9]))(\d[\d\.]*)/i],[T,[E,"webOS"]],[/web0s;.+?(?:chr[o0]me|safari)\/(\d+)/i],[[T,Xt,{25:"120",24:"108",23:"94",22:"87",6:"79",5:"68",4:"53",3:"38",2:"538",1:"537","*":"TV"}],[E,"webOS"]],[/watch(?: ?os[,\/]|\d,\d\/)([\d\.]+)/i],[T,[E,"watchOS"]],[/(cros) [\w]+(?:\)| ([\w\.]+)\b)/i],[[E,"Chrome OS"],T],[/panasonic;(viera)/i,/(netrange)mmh/i,/(nettv)\/(\d+\.[\w\.]+)/i,/(nintendo|playstation) (\w+)/i,/(xbox); +xbox ([^\);]+)/i,/(pico) .+os([\w\.]+)/i,/\b(joli|palm)\b ?(?:os)?\/?([\w\.]*)/i,/linux.+(mint)[\/\(\) ]?([\w\.]*)/i,/(mageia|vectorlinux|fuchsia|arcaos|arch(?= ?linux))[;l ]([\d\.]*)/i,/([kxln]?ubuntu|debian|suse|opensuse|gentoo|slackware|fedora|mandriva|centos|pclinuxos|red ?hat|zenwalk|linpus|raspbian|plan 9|minix|risc os|contiki|deepin|manjaro|elementary os|sabayon|linspire|knoppix)(?: gnu[\/ ]linux)?(?: enterprise)?(?:[- ]linux)?(?:-gnu)?[-\/ ]?(?!chrom|package)([-\w\.]*)/i,/((?:open)?solaris)[-\/ ]?([\w\.]*)/i,/\b(aix)[; ]([1-9\.]{0,4})/i,/(hurd|linux|morphos)(?: (?:arm|x86|ppc)\w*| ?)([\w\.]*)/i,/(gnu) ?([\w\.]*)/i,/\b([-frentopcghs]{0,5}bsd|dragonfly)[\/ ]?(?!amd|[ix346]{1,2}86)([\w\.]*)/i,/(haiku) ?(r\d)?/i],[E,T],[/(sunos) ?([\d\.]*)/i],[[E,"Solaris"],T],[/\b(beos|os\/2|amigaos|openvms|hp-ux|serenityos)/i,/(unix) ?([\w\.]*)/i],[E,T]]},Vt=(kt.call((r={init:{},isIgnore:{},isIgnoreRgx:{},toString:{}}).init,[[u,[E,T,S,x]],[p,[I]],[y,[x,v,b]],[g,[E,T]],[f,[E,T]]]),kt.call(r.isIgnore,[[u,[T,S]],[g,[T]],[f,[T]]]),kt.call(r.isIgnoreRgx,[[u,/ ?browser$/i],[f,/ ?os$/i]]),kt.call(r.toString,[[u,[E,T]],[p,[I]],[y,[b,v]],[g,[E,T]],[f,[E,T]]]),r),zt=function(t,e){var i=Vt.init[e],s=Vt.isIgnore[e]||0,o=Vt.isIgnoreRgx[e]||0,a=Vt.toString[e]||0;function r(){kt.call(this,i)}return r.prototype.getItem=function(){return t},r.prototype.withClientHints=function(){return Ct?Ct.getHighEntropyValues($).then(function(e){return t.setCH(new qt(e,!1)).parseCH().get()}):t.parseCH().get()},r.prototype.withFeatureCheck=function(){return t.detectFeature().get()},e!=w&&(r.prototype.is=function(t){var e=!1;for(var i in this)if(this.hasOwnProperty(i)&&!Ot(s,i)&&Pt(o?Nt(o,this[i]):this[i])==Pt(o?Nt(o,t):t)){if(e=!0,t!=c)break}else if(t==c&&e){e=!e;break}return e},r.prototype.toString=function(){var t=h;for(var e in a)typeof this[a[e]]!==c&&(t+=(t?" ":h)+this[a[e]]);return t||c}),Ct||(r.prototype.then=function(t){var e=this,i=function(){for(var t in e)e.hasOwnProperty(t)&&(this[t]=e[t])};i.prototype={is:r.prototype.is,toString:r.prototype.toString};var s=new i;return t(s),s}),new r};function qt(t,e){if(t=t||{},kt.call(this,$),e)kt.call(this,[[P,Gt(t[H])],[k,Gt(t[X])],[M,/\?1/.test(t[j])],[v,Yt(t[V])],[N,Yt(t[z])],[Y,Yt(t[q])],[I,Yt(t[F])],[L,Gt(t[U])],[B,Yt(t[W])]]);else for(var i in t)this.hasOwnProperty(i)&&typeof t[i]!==c&&(this[i]=t[i])}function $t(t,e,i,s){return this.get=function(t){return t?this.data.hasOwnProperty(t)?this.data[t]:a:this.data},this.set=function(t,e){return this.data[t]=e,this},this.setCH=function(t){return this.uaCH=t,this},this.detectFeature=function(){if(Mt&&Mt.userAgent==this.ua)switch(this.itemType){case u:Mt.brave&&typeof Mt.brave.isBrave==l&&this.set(E,"Brave");break;case y:!this.get(x)&&Ct&&Ct[M]&&this.set(x,M),"Macintosh"==this.get(v)&&Mt&&typeof Mt.standalone!==c&&Mt.maxTouchPoints&&Mt.maxTouchPoints>2&&this.set(v,"iPad").set(x,C);break;case f:!this.get(E)&&Ct&&Ct[N]&&this.set(E,Ct[N]);break;case w:var t=this.data,e=function(e){return t[e].getItem().detectFeature().get()};this.set(u,e(u)).set(p,e(p)).set(y,e(y)).set(g,e(g)).set(f,e(f))}return this},this.parseUA=function(){return this.itemType!=w&&Ht.call(this.data,this.ua,this.rgxMap),this.itemType==u&&this.set(S,Lt(this.get(T))),this},this.parseCH=function(){var t=this.uaCH,e=this.rgxMap;switch(this.itemType){case u:case g:var i,s=t[k]||t[P];if(s)for(var o in s){var r=s[o].brand||s[o],n=s[o].version;this.itemType==u&&!/not.a.brand/i.test(r)&&(!i||/Chrom/.test(i)&&r!=gt||i==wt&&/WebView2/.test(r))&&(r=Xt(r,Ut),(i=this.get(E))&&!/Chrom/.test(i)&&/Chrom/.test(r)||this.set(E,r).set(T,n).set(S,Lt(n)),i=r),this.itemType==g&&r==gt&&this.set(T,n)}break;case p:var h=t[I];h&&(h&&"64"==t[B]&&(h+="64"),Ht.call(this.data,h+";",e));break;case y:if(t[M]&&this.set(x,M),t[v]&&(this.set(v,t[v]),!this.get(x)||!this.get(b))){var l={};Ht.call(l,"droid 9; "+t[v]+")",e),!this.get(x)&&l.type&&this.set(x,l.type),!this.get(b)&&l.vendor&&this.set(b,l.vendor)}if(t[L]){var c;if("string"!=typeof t[L])for(var d=0;!c&&d<t[L].length;)c=Xt(t[L][d++],Wt);else c=Xt(t[L],Wt);this.set(x,c)}break;case f:var m=t[N];if(m){var A=t[Y];m==vt&&(A=parseInt(Lt(A),10)>=13?"11":"10"),this.set(E,m).set(T,A)}this.get(E)==vt&&"Xbox"==t[v]&&this.set(E,"Xbox").set(T,a);break;case w:var C=this.data,D=function(e){return C[e].getItem().setCH(t).parseCH().get()};this.set(u,D(u)).set(p,D(p)).set(y,D(y)).set(g,D(g)).set(f,D(f))}return this},kt.call(this,[["itemType",t],["ua",e],["uaCH",s],["rgxMap",i],["data",zt(this,t)]]),this}function Zt(t,e,i){if(typeof t===d?(_t(t,!0)?(typeof e===d&&(i=e),e=t):(i=t,e=a),t=a):typeof t!==m||_t(e,!0)||(i=e,e=a),i&&typeof i.append===l){var s={};i.forEach(function(t,e){s[e]=t}),i=s}if(!(this instanceof Zt))return new Zt(t,e,i).getResult();var o=typeof t===m?t:i&&i[n]?i[n]:Mt&&Mt.userAgent?Mt.userAgent:h,r=new qt(i,!0),c=e?function(t,e){var i={},s=e;if(!_t(e))for(var o in s={},e)for(var a in e[o])s[a]=e[o][a].concat(s[a]?s[a]:[]);for(var r in t)i[r]=s[r]&&s[r].length%2==0?s[r].concat(t[r]):t[r];return i}(jt,e):jt,E=function(t){return t==w?function(){return new $t(t,o,c,r).set("ua",o).set(u,this.getBrowser()).set(p,this.getCPU()).set(y,this.getDevice()).set(g,this.getEngine()).set(f,this.getOS()).get()}:function(){return new $t(t,o,c[t],r).parseUA().get()}};return kt.call(this,[["getBrowser",E(u)],["getCPU",E(p)],["getDevice",E(y)],["getEngine",E(g)],["getOS",E(f)],["getResult",E(w)],["getUA",function(){return o}],["setUA",function(t){return Rt(t)&&(o=t.length>500?Bt(t,500):t),this}]]).setUA(o),this}Zt.VERSION="2.0.4",Zt.BROWSER=Dt([E,T,S,x]),Zt.CPU=Dt([I]),Zt.DEVICE=Dt([v,b,x,A,M,D,C,O,R]),Zt.ENGINE=Zt.OS=Dt([E,T]),typeof e!==c?(t.exports&&(e=t.exports=Zt),e.UAParser=Zt):i.amdO?(s=function(){return Zt}.call(e,i,e,t))===a||(t.exports=s):At&&(o.UAParser=Zt);var Kt=At&&(o.jQuery||o.Zepto);if(Kt&&!Kt.ua){var Qt=new Zt;Kt.ua=Qt.getResult(),Kt.ua.get=function(){return Qt.getUA()},Kt.ua.set=function(t){Qt.setUA(t);var e=Qt.getResult();for(var i in e)Kt.ua[i]=e[i]}}}("object"==typeof window?window:this)},2114:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.FeedbackButton=void 0;const s=i(6291),o=i(8089);class a extends o.LinkButton{constructor({x:t,y:e}={x:s.GameConstants.WIDTH/2,y:s.GameConstants.HEIGHT/2}){super({text:"Provide Feedback",linkUrl:"https://forms.gle/sWzqPGCa1L9XJ3Mk8",x:t,y:e})}}e.FeedbackButton=a},2124:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Crossbow=void 0;const s=i(4052),o=i(6791),a=i(8287),r=i(8991);var n;!function(t){t[t.EMPTY=0]="EMPTY",t[t.LOADED=1]="LOADED",t[t.COCKED=2]="COCKED",t[t.FIRING=3]="FIRING"}(n||(n={}));class h extends s.Weapon{constructor(t,e,i){super(t,e,i),this.toggleEquip=()=>{!this.broken&&this.cooldown<=0&&this.state===n.COCKED?(!this.equipped&&this.wielder?.inventory?.weapon&&(this.previousWeapon=this.wielder.inventory.weapon),this.equipped=!this.equipped,this.equipped?this.onEquip():this.onUnequip(),a.GameplaySettings.EQUIP_USES_TURN&&!0===this.equipped&&this.wielder?.stall()):this.state===n.EMPTY?(this.tileX=23,this.level.game.pushMessage("Use a bolt on the crossbow to load it.")):this.state===n.LOADED?this.cock():this.cooldown>0&&this.level.game.pushMessage("Cooldown: "+this.cooldown)},this.addBolt=(t=!1)=>this.state===n.EMPTY?(this.state=n.LOADED,t||this.level.game.pushMessage("You load the crossbow."),this.tileX=24,!0):(t||this.level.game.pushMessage("You already have a bolt loaded."),!1),this.cock=()=>{this.state===n.LOADED&&(this.state=n.COCKED,this.tileX=25,this.level.game.pushMessage("You cock the crossbow back and equip it."),this.disabled=!1,!this.equipped&&this.wielder?.inventory?.weapon&&(this.previousWeapon=this.wielder.inventory.weapon),this.equipped=!0)},this.fire=()=>{if(this.state===n.COCKED||this.state===n.FIRING){this.state=n.EMPTY,this.tileX=23,this.equipped=!1,this.wielder.inventory.weapon=null,this.wielder.inventory.weapon=this.previousWeapon,this.previousWeapon.equipped=!0,this.previousWeapon=null,this.disabled=!0;const t=this.wielder.inventory.hasItem(r.CrossbowBolt);null!==t&&(t.stackCount--,t.stackCount<=0&&this.wielder.inventory.removeItem(t),this.addBolt(!0))}},this.weaponMove=(t,e)=>{if(this.state!==n.COCKED)return!0;const i=this.wielder?.getRoom?this.wielder.getRoom():this.game.rooms[this.wielder.levelID];if(!i)return!0;const s=Math.sign(t-this.wielder.x),a=Math.sign(e-this.wielder.y);if(0===s==(0===a))return!0;let r=this.wielder.x,h=this.wielder.y,l=null,c=r,d=h;for(let t=1;t<=15&&(r+=s,h+=a,i.tileInside(r,h));t++){const e=i.roomArray?.[r]?.[h];if(!e||e.isSolid())break;const s=i.entities.filter(t=>t.pointIn(r,h)),o=s.find(e=>!(!e.destroyable||e.pushable||1!==t&&!0!==e.isEnemy));if(o){l=o,c=r,d=h;break}if(s.some(e=>!(!e.pushable&&e.destroyable&&(!(t>1&&e.destroyable)||e.isEnemy))))break}return!l||(this.state=n.FIRING,this.attack(l,this.damage+this.wielder.damageBonus),this.hitSound(),this.wielder.setHitXY(c,d),i.particles.push(new o.ArrowParticle(i,this.wielder.x+.5,this.wielder.y,c+.5,d)),i.tick(this.wielder),this.game.shakeScreen(5*s,5*a),this.fire(),!1)},this.tileX=23,this.tileY=4,this.name=h.itemName,this.state=n.EMPTY,this.disabled=!0,this.damage=4}}e.Crossbow=h,h.itemName="crossbow"},2125:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Succulent=void 0;const s=i(606),o=i(7851),a=i(606);class r extends s.Entity{constructor(t,e,i,s){super(t,e,i,s),this.draw=t=>{this.dead||(o.Game.ctx.save(),o.Game.ctx.globalAlpha=this.alpha,this.dead||(this.hasShadow&&this.drawShadow(t),this.updateDrawXY(t),o.Game.drawObj(this.tileX,this.tileY,1,2,this.x-this.drawX,this.y-this.drawYOffset-this.drawY,1,2,this.room.shadeColor,this.shadeAmount())),o.Game.ctx.restore())},this.drawTopLayer=t=>{this.drawableY=this.y},this.room=t,this.health=1,this.tileX=18,this.tileY=2,this.hasShadow=!0,this.chainPushable=!1,this.name="succulent",this.imageParticleX=0,this.imageParticleY=28}get type(){return a.EntityType.PROP}}e.Succulent=r},2147:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.statsTracker=e.StatsTracker=void 0;const s=i(1073),o=i(2502),a=i(6277);class r{constructor(){this.stats=r.initialStats(),this.handleEnemyKilled=t=>{this.stats.enemiesKilled+=1,this.stats.enemies.push(t.enemyId),this.stats.xp+=t.xp,this.stats.level=Math.floor(this.stats.xp/100)+1},this.handleDamageDone=t=>{this.stats.damageDone+=t.amount},this.handleDamageTaken=t=>{this.stats.damageTaken+=t.amount},this.handleTurnPassed=()=>{this.stats.turnsPassed+=1},this.handleCoinCollected=t=>{this.stats.coinsCollected+=t.amount},this.handleItemCollected=t=>{this.stats.itemsCollected+=1},this.initializeListeners()}static initialStats(){return{enemiesKilled:0,damageDone:0,damageTaken:0,turnsPassed:0,coinsCollected:0,itemsCollected:0,enemies:[],weaponChoice:null,sidePathsEntered:[],xp:0,level:1}}initializeListeners(){o.globalEventBus.on(a.EVENTS.ENEMY_KILLED,this.handleEnemyKilled),o.globalEventBus.on(a.EVENTS.DAMAGE_DONE,this.handleDamageDone),o.globalEventBus.on(a.EVENTS.DAMAGE_TAKEN,this.handleDamageTaken),o.globalEventBus.on(a.EVENTS.TURN_PASSED,this.handleTurnPassed),o.globalEventBus.on(a.EVENTS.COIN_COLLECTED,this.handleCoinCollected),o.globalEventBus.on(a.EVENTS.ITEM_COLLECTED,this.handleItemCollected)}getStats(){return this.stats}getXp(){return this.stats.xp}increaseXp(t){this.stats.xp+=t}recordWeaponChoice(t){this.stats.weaponChoice=t}recordSidePathEntered({depth:t,sidePath:e}){this.stats.sidePathsEntered.push({depth:t,sidePath:(0,s.getEnvTypeName)(e)})}resetStats(){this.stats=r.initialStats()}setStats(t){this.stats=t}}e.StatsTracker=r,e.statsTracker=new r},2176:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.GoldOre=void 0;const s=i(5366),o=i(3345),a=i(7366);class r extends s.Item{constructor(t,e,i){super(t,e,i),this.smelt=t=>{t.inventory.isFull()?this.level.game.pushMessage("You don't have enough space in your inventory to smelt the gold ore."):this.stackCount>=3&&(t.inventory.subtractItem(this,3),t.inventory.addItem(new o.GoldBar(this.level,this.x,this.y)),a.Sound.playSmith(),this.level.game.pushMessage("You smelt the gold ore into a gold bar."))},this.tileX=18,this.tileY=0,this.name=r.itemName,this.stackable=!0,this.description="Some gold ore"}}e.GoldOre=r,r.itemName="gold ore"},2247:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.StunAnimation=void 0;const s=i(8774),o=i(7851);class a extends s.Projectile{constructor(t,e,i){super(t,e,i),this.ticks=0,this.remove=()=>{this.parent.room.projectiles=this.parent.room.projectiles.filter(t=>t!==this)},this.tick=()=>{(this.ticks>0||!0===this.parent.dead)&&(this.remove(),this.parent.unconscious=!1,this.parent.justHurt=!1),this.ticks++},this.drawTopLayer=t=>{this.dead||(o.Game.ctx.save(),o.Game.ctx.globalCompositeOperation="screen",o.Game.ctx.globalAlpha=.5,this.frame+=.2*t,this.frame>4&&(this.frame=0),o.Game.drawFX(19+Math.floor(this.frame),0,1,1,this.parent.x-this.parent.drawX,this.parent.y-this.parent.drawY-1.4,1,1),o.Game.ctx.restore())},this.frame=0,this.parent.room.projectiles.push(this)}}e.StunAnimation=a},2248:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Chasm=void 0;const s=i(7851),o=i(6291),a=i(8132);class r extends a.Tile{constructor(t,e,i,a,r,n,h){super(t,e,i),this.isSolid=()=>!0,this.canCrushEnemy=()=>!0,this.draw=t=>{const e=o.GameConstants.TILESIZE,i=this.topEdge?2:1;this._buffer&&this._buffer.width===e&&this._buffer.height===i*e||(this._buffer=document.createElement("canvas"),this._buffer.width=e,this._buffer.height=i*e);const a=this._buffer.getContext("2d");a.clearRect(0,0,this._buffer.width,this._buffer.height);const r=s.Game.ctx,n=a.globalCompositeOperation;s.Game.ctx=a,a.globalCompositeOperation="source-over",s.Game.drawTile(this.tileX,this.tileY,1,1,0,0,1,1,this.room.shadeColor,this.shadeAmount()),a.globalCompositeOperation="source-in",s.Game.drawTile(1,this.skin,1,1,0,0,1,1,this.room.shadeColor,this.shadeAmount()),this.topEdge&&(a.globalCompositeOperation="destination-over",s.Game.drawTile(22,0,1,2,0,0,1,2,this.room.shadeColor,this.shadeAmount())),s.Game.ctx=r,a.globalCompositeOperation=n,s.Game.ctx.save(),s.Game.ctx.globalCompositeOperation="source-over",s.Game.ctx.drawImage(this._buffer,this.x*e,this.y*e),s.Game.ctx.restore()},this.tileX=1===this.skin?24:20,this.tileY=1,a?this.tileX--:r&&this.tileX++,n?this.tileY--:h&&this.tileY++,this.topEdge=n}}e.Chasm=r},2268:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.DualDagger=void 0;const s=i(4052),o=i(7366),a=i(1302);class r extends s.Weapon{constructor(t,e,i){super(t,e,i),this.hitSound=()=>{o.Sound.swing(),o.Sound.playShortSlice()},this.tickInInventory=()=>{this.firstAttack=!0},this.weaponMove=(t,e)=>{const i=this.getEntitiesAt(t,e).filter(t=>!t.pushable);let s=!1;for(let t of i)this.attack(t,this.damage),this.statusEffect(t),s=!0;return s&&(this.hitSound(),this.wielder.setHitXY(t,e),this.shakeScreen(t,e),this.firstAttack?this.game.rooms[this.wielder.levelID].particles.push(new a.AttackAnimation(t,e,"dualdagger",this.wielder.direction)):this.game.rooms[this.wielder.levelID].particles.push(new a.AttackAnimation(t,e,"dualdagger2",this.wielder.direction)),this.game.rooms[this.wielder.levelID].entities=this.game.rooms[this.wielder.levelID].entities.filter(t=>!t.dead),this.firstAttack||this.game.rooms[this.wielder.levelID].tick(this.wielder),this.wielder===this.game.players[this.game.localPlayerID]&&this.game.shakeScreen(10*this.wielder.hitX,10*this.wielder.hitY),this.firstAttack&&(this.game.rooms[this.wielder.levelID].tickHitWarnings(),this.game.rooms[this.wielder.levelID].clearDeadStuff(),this.firstAttack=!1,this.wielder.beginSlowMotion()),this.degrade()),!s},this.tileX=23,this.tileY=0,this.firstAttack=!0,this.name="Dual Daggers",this.useCost=2,this.description="After the first attack, enemies will not take their turn until you attack or move again."}}e.DualDagger=r,r.itemName="dual daggers"},2270:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Armor=void 0;const s=i(7851),o=i(8549),a=i(6291),r=i(4478);class n extends o.Equippable{constructor(t,e,i){super(t,e,i),this.RECHARGE_TURNS=25,this.coEquippable=t=>!(t instanceof n||t instanceof r.WoodenShield),this.getDescription=()=>"ENCHANTED SHIELD\nAn occult shield. Absorbs one hit and regenerates after "+this.RECHARGE_TURNS+" turns.",this.tickInInventory=()=>{this.rechargeTurnCounter>0&&(this.rechargeTurnCounter--,this.cooldown=this.rechargeTurnCounter,0===this.rechargeTurnCounter&&(this.rechargeTurnCounter=-1,this.cooldown=this.rechargeTurnCounter,this.health=1))},this.hurt=t=>{this.health<=0||(this.health-=Math.max(t,1),this.rechargeTurnCounter=this.RECHARGE_TURNS+1,this.cooldown=this.rechargeTurnCounter)},this.drawGUI=(t,e,i)=>{const o=(i-7)/a.GameConstants.TILESIZE,r=Math.max(o,-.2)+e/1.5+.5;let n=a.GameConstants.WIDTH>175?0:-1.25;-1===this.rechargeTurnCounter?s.Game.drawFX(5,2,.75,.75,r,a.GameConstants.HEIGHT/a.GameConstants.TILESIZE-1+n,.75,.75):1-this.rechargeTurnCounter/this.RECHARGE_TURNS<.5?s.Game.drawFX(7,2,.75,.75,r,a.GameConstants.HEIGHT/a.GameConstants.TILESIZE-1+n,.75,.75):s.Game.drawFX(8,2,.75,.75,r,a.GameConstants.HEIGHT/a.GameConstants.TILESIZE-1+n,.75,.75)},this.health=1,this.rechargeTurnCounter=-1,this.tileX=5,this.tileY=0,this.name="occult shield"}}e.Armor=n,n.itemName="occult shield"},2279:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.ShieldRightFragment=void 0;const s=i(5180),o=i(6644),a=i(2270);class r extends s.Usable{constructor(t,e,i){super(t,e,i),this.onDrop=()=>{"right"===this.level.game.lastDroppedShieldPiece?(this.level.game.lastDroppedShieldPiece=null,this.level.items.push(new o.ShieldLeftFragment(this.level,this.x,this.y)),this.level.items=this.level.items.filter(t=>t!==this)):null===this.level.game.lastDroppedShieldPiece&&(this.level.game.lastDroppedShieldPiece="right")},this.useOnOther=(t,e)=>{if(e instanceof o.ShieldLeftFragment){t.inventory.removeItem(this),t.inventory.removeItem(e),t.game.pushMessage("You combine the shield fragments into a shield.");const i=t?.getRoom?t.getRoom():t.game.rooms[t.levelID],s=new a.Armor(i,t.x,t.y);t.inventory.addItem(s)}},this.tileX=2,this.tileY=2,this.stackable=!1,this.name=r.itemName,this.description="The right fragment of a shield. Find the left fragment to use it.",this.canUseOnOther=!0}}e.ShieldRightFragment=r,r.itemName="right shield fragment"},2321:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.GarnetRing=void 0;const s=i(8549);class o extends s.Equippable{constructor(t,e,i){super(t,e,i),this.onEquip=()=>{this.wielder.damageBonus=1,this.level.game.pushMessage("You feel a surge of power in your ring.")},this.onUnequip=()=>{this.wielder.damageBonus=0,this.level.game.pushMessage("The power in your ring fades.")},this.onDrop=()=>{this.wielder.damageBonus=0,this.equipped&&(this.level.game.pushMessage("The power in your ring fades."),this.equipped=!1)},this.tileX=12,this.tileY=2,this.name=o.itemName,this.stackable=!1,this.description="A ring of garnet"}}e.GarnetRing=o,o.itemName="garnet ring"},2351:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.OrangeGem=void 0;const s=i(5180);class o extends s.Usable{constructor(t,e,i){super(t,e,i),this.useOnOther=(t,e)=>{"gold ring"===e.name&&e.embed(t,this)},this.getDescription=()=>"An amber gem. Embed it into a gold ring to imbue it with magic.",this.tileX=14,this.tileY=0,this.name=o.itemName,this.canUseOnOther=!0,this.stackable=!0}}e.OrangeGem=o,o.itemName="amber"},2394:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.WebGLBlurRenderer=void 0;const s=i(6291);class o{constructor(){if(this.textureWidth=0,this.textureHeight=0,this.tempTextureWidth=0,this.tempTextureHeight=0,this.resultCanvasCache=new Map,this.maxCacheSize=10,this.vertexShaderSource="\n    precision mediump float;\n    attribute vec2 a_position;\n    attribute vec2 a_texCoord;\n    uniform vec2 u_resolution;\n    varying vec2 v_texCoord;\n    \n    void main() {\n      vec2 zeroToOne = a_position / u_resolution;\n      vec2 zeroToTwo = zeroToOne * 2.0;\n      vec2 clipSpace = zeroToTwo - 1.0;\n      gl_Position = vec4(clipSpace * vec2(1, -1), 0, 1);\n      v_texCoord = a_texCoord;\n    }\n  ",this.highQualityFragmentShaderSource="\n    precision mediump float;\n    uniform sampler2D u_texture;\n    uniform vec2 u_resolution;\n    uniform vec2 u_direction;\n    uniform float u_radius;\n    varying vec2 v_texCoord;\n    \n    void main() {\n      vec2 texelSize = u_direction / u_resolution;\n      vec4 color = vec4(0.0);\n      float totalWeight = 0.0;\n      \n      // High quality blur with original 49 samples\n      float sigma = u_radius * 0.4;\n      float twoSigmaSquare = 2.0 * sigma * sigma;\n      \n      for (float i = -24.0; i <= 24.0; i++) {\n        if (abs(i) > u_radius) continue;\n        \n        vec2 offset = texelSize * i;\n        float weight = exp(-i * i / twoSigmaSquare);\n        \n        color += texture2D(u_texture, v_texCoord + offset) * weight;\n        totalWeight += weight;\n      }\n      \n      gl_FragColor = color / totalWeight;\n    }\n  ",this.performanceFragmentShaderSource="\n    precision mediump float;\n    uniform sampler2D u_texture;\n    uniform vec2 u_resolution;\n    uniform vec2 u_direction;\n    uniform float u_radius;\n    varying vec2 v_texCoord;\n    \n    void main() {\n      vec2 texelSize = u_direction / u_resolution;\n      vec4 color = vec4(0.0);\n      float totalWeight = 0.0;\n      \n      // Performance blur with 13 samples\n      float sigma = u_radius * 0.9;\n      float twoSigmaSquare = 2.0 * sigma * sigma;\n      \n      for (float i = -12.0; i <= 12.0; i++) {\n        if (abs(i) > u_radius) continue;\n        \n        vec2 offset = texelSize * i;\n        float weight = exp(-i * i / twoSigmaSquare);\n        \n        color += texture2D(u_texture, v_texCoord + offset) * weight;\n        totalWeight += weight;\n      }\n      \n      gl_FragColor = color / totalWeight;\n    }\n  ",this.canvas=document.createElement("canvas"),this.canvas.width=s.GameConstants.WIDTH,this.canvas.height=s.GameConstants.HEIGHT,this.downsampleCanvas=document.createElement("canvas"),this.downsampleCtx=this.downsampleCanvas.getContext("2d"),!this.downsampleCtx)throw new Error("Failed to initialize downsample canvas context.");const t=this.canvas.getContext("webgl",{antialias:!1,depth:!1,stencil:!1,alpha:!0,premultipliedAlpha:!1,preserveDrawingBuffer:!1,powerPreference:"high-performance"}),e=this.canvas.getContext("experimental-webgl",{antialias:!1,depth:!1,stencil:!1,alpha:!0,premultipliedAlpha:!1,preserveDrawingBuffer:!1,powerPreference:"high-performance"});if(this.gl=t||e,!this.gl)throw new Error("WebGL not supported");this.gl.disable(this.gl.DEPTH_TEST),this.gl.disable(this.gl.CULL_FACE),this.gl.disable(this.gl.BLEND),this.initShaders(),this.initBuffers(),this.initTextures()}static getInstance(){return o.instance||(o.instance=new o),o.instance}initShaders(){const t=this.createShader(this.gl.VERTEX_SHADER,this.vertexShaderSource),e=this.createShader(this.gl.FRAGMENT_SHADER,this.highQualityFragmentShaderSource);if(this.highQualityShaderProgram=this.gl.createProgram(),this.gl.attachShader(this.highQualityShaderProgram,t),this.gl.attachShader(this.highQualityShaderProgram,e),this.gl.linkProgram(this.highQualityShaderProgram),!this.gl.getProgramParameter(this.highQualityShaderProgram,this.gl.LINK_STATUS))throw new Error("Unable to initialize high quality shader program: "+this.gl.getProgramInfoLog(this.highQualityShaderProgram));const i=this.createShader(this.gl.FRAGMENT_SHADER,this.performanceFragmentShaderSource);if(this.performanceShaderProgram=this.gl.createProgram(),this.gl.attachShader(this.performanceShaderProgram,t),this.gl.attachShader(this.performanceShaderProgram,i),this.gl.linkProgram(this.performanceShaderProgram),!this.gl.getProgramParameter(this.performanceShaderProgram,this.gl.LINK_STATUS))throw new Error("Unable to initialize performance shader program: "+this.gl.getProgramInfoLog(this.performanceShaderProgram));this.currentShaderProgram=this.highQualityShaderProgram,this.updateShaderProgram()}updateShaderProgram(){const t=s.GameConstants.HIGH_QUALITY_BLUR?this.highQualityShaderProgram:this.performanceShaderProgram;this.currentShaderProgram!==t&&(this.currentShaderProgram=t,this.gl.useProgram(this.currentShaderProgram),this.positionLocation=this.gl.getAttribLocation(this.currentShaderProgram,"a_position"),this.texCoordLocation=this.gl.getAttribLocation(this.currentShaderProgram,"a_texCoord"),this.resolutionLocation=this.gl.getUniformLocation(this.currentShaderProgram,"u_resolution"),this.textureLocation=this.gl.getUniformLocation(this.currentShaderProgram,"u_texture"),this.directionLocation=this.gl.getUniformLocation(this.currentShaderProgram,"u_direction"),this.radiusLocation=this.gl.getUniformLocation(this.currentShaderProgram,"u_radius"),this.gl.uniform1i(this.textureLocation,0))}createShader(t,e){const i=this.gl.createShader(t);if(this.gl.shaderSource(i,e),this.gl.compileShader(i),!this.gl.getShaderParameter(i,this.gl.COMPILE_STATUS)){const t=this.gl.getShaderInfoLog(i);throw this.gl.deleteShader(i),new Error("Unable to compile shader: "+t)}return i}initBuffers(){this.positionBuffer=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.positionBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array([0,0,s.GameConstants.WIDTH,0,0,s.GameConstants.HEIGHT,0,s.GameConstants.HEIGHT,s.GameConstants.WIDTH,0,s.GameConstants.WIDTH,s.GameConstants.HEIGHT]),this.gl.STATIC_DRAW),this.texCoordBuffer=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.texCoordBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]),this.gl.STATIC_DRAW)}initTextures(){this.texture=this.gl.createTexture(),this.gl.bindTexture(this.gl.TEXTURE_2D,this.texture),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR),this.tempTexture=this.gl.createTexture(),this.gl.bindTexture(this.gl.TEXTURE_2D,this.tempTexture),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR),this.framebuffer=this.gl.createFramebuffer(),this.tempFramebuffer=this.gl.createFramebuffer()}updateTexture(t,e,i,s,o,a=null){return this.gl.bindTexture(this.gl.TEXTURE_2D,t),s!==e||o!==i?(a?this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,a):this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,e,i,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,null),{width:e,height:i}):a?(this.gl.texSubImage2D(this.gl.TEXTURE_2D,0,0,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,a),{width:s,height:o}):{width:s,height:o}}getCachedCanvas(t,e){const i=`${t}x${e}`;let s=this.resultCanvasCache.get(i);if(!s){if(s=document.createElement("canvas"),s.width=t,s.height=e,this.resultCanvasCache.size>=this.maxCacheSize){const t=this.resultCanvasCache.keys().next().value;this.resultCanvasCache.delete(t)}this.resultCanvasCache.set(i,s)}return s}applyBlur(t,e){const i=t.width,o=t.height,a=s.GameConstants.BLUR_DOWNSAMPLE_FACTOR,r=Math.max(1,Math.floor(i/a)),n=Math.max(1,Math.floor(o/a));this.downsampleCanvas.width===r&&this.downsampleCanvas.height===n||(this.downsampleCanvas.width=r,this.downsampleCanvas.height=n),this.downsampleCtx.clearRect(0,0,r,n),this.downsampleCtx.drawImage(t,0,0,i,o,0,0,r,n);const h=this.applyBlurToCanvas(this.downsampleCanvas,e/a,r,n),l=this.getCachedCanvas(i,o),c=l.getContext("2d");return c.clearRect(0,0,i,o),c.imageSmoothingEnabled=!0,c.imageSmoothingQuality="high",c.drawImage(h,0,0,r,n,0,0,i,o),l}applyBlurToCanvas(t,e,i,o){const a=1*e,r=s.GameConstants.HIGH_QUALITY_BLUR?this.highQualityShaderProgram:this.performanceShaderProgram;this.currentShaderProgram!==r&&this.updateShaderProgram(),this.canvas.width===i&&this.canvas.height===o||(this.canvas.width=i,this.canvas.height=o,this.gl.viewport(0,0,i,o),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.positionBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array([0,0,i,0,0,o,0,o,i,0,i,o]),this.gl.STATIC_DRAW));const n=this.updateTexture(this.texture,i,o,this.textureWidth,this.textureHeight,t);this.textureWidth=n.width,this.textureHeight=n.height;const h=this.updateTexture(this.tempTexture,i,o,this.tempTextureWidth,this.tempTextureHeight,null);return this.tempTextureWidth=h.width,this.tempTextureHeight=h.height,this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.positionBuffer),this.gl.enableVertexAttribArray(this.positionLocation),this.gl.vertexAttribPointer(this.positionLocation,2,this.gl.FLOAT,!1,0,0),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.texCoordBuffer),this.gl.enableVertexAttribArray(this.texCoordLocation),this.gl.vertexAttribPointer(this.texCoordLocation,2,this.gl.FLOAT,!1,0,0),this.gl.uniform2f(this.resolutionLocation,i,o),this.gl.uniform1f(this.radiusLocation,a),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this.tempFramebuffer),this.gl.framebufferTexture2D(this.gl.FRAMEBUFFER,this.gl.COLOR_ATTACHMENT0,this.gl.TEXTURE_2D,this.tempTexture,0),this.gl.bindTexture(this.gl.TEXTURE_2D,this.texture),this.gl.uniform2f(this.directionLocation,1,0),this.gl.drawArrays(this.gl.TRIANGLES,0,6),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this.framebuffer),this.gl.framebufferTexture2D(this.gl.FRAMEBUFFER,this.gl.COLOR_ATTACHMENT0,this.gl.TEXTURE_2D,this.texture,0),this.gl.bindTexture(this.gl.TEXTURE_2D,this.tempTexture),this.gl.uniform2f(this.directionLocation,0,1),this.gl.drawArrays(this.gl.TRIANGLES,0,6),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null),this.gl.bindTexture(this.gl.TEXTURE_2D,this.texture),this.gl.drawArrays(this.gl.TRIANGLES,0,6),this.canvas}clearCache(){this.resultCanvasCache.clear()}dispose(){this.clearCache(),this.gl&&(this.gl.deleteProgram(this.highQualityShaderProgram),this.gl.deleteProgram(this.performanceShaderProgram),this.gl.deleteBuffer(this.positionBuffer),this.gl.deleteBuffer(this.texCoordBuffer),this.gl.deleteTexture(this.texture),this.gl.deleteTexture(this.tempTexture),this.gl.deleteFramebuffer(this.framebuffer),this.gl.deleteFramebuffer(this.tempFramebuffer))}}e.WebGLBlurRenderer=o},2440:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.CrusherEnemy=void 0;const s=i(7851),o=i(7455),a=i(6986),r=i(4804),n=i(3436),h=i(7366),l=i(369);class c extends a.Enemy{constructor(t,e,i,a,c){super(t,e,i,a),this.animateY=0,this.softAnimateY=0,this.hit=()=>1,this.applyShield=()=>{},this.applyBuff=()=>{},this.tryMove=(t,e,i=!0)=>{const s=i=>!(i.x>=t+this.w||i.x+i.w<=t||i.y>=e+this.h||i.y+i.h<=e);for(const t of this.room.entities)if(t!==this&&s(t)&&i)return;const o=[];for(let i=0;i<this.w;i++)for(let s=0;s<this.h;s++){const a=this.room.roomArray[t+i][e+s];if(!a||a.isSolid()||a instanceof r.Door||a instanceof n.DownLadder)return;o.push(a)}for(let t of o)t.onCollideEnemy(this);this.x=t,this.y=e},this.tryCrush=()=>{let t=!1;for(const e in this.game.players){const i=this.game.players[e];this.game.rooms[i.levelID]===this.room&&i.x===this.x&&i.y===this.y&&(i.hurt(this.hit(),this.name,400),this.drawX+=.5*(this.x-i.x),this.drawY+=.5*(this.y-i.y),this.game.players[this.game.localPlayerID],t=!0)}return t},this.behavior=()=>{if(this.lastX=this.x,this.lastY=this.y,!this.dead){if(this.handleSkipTurns())return;if(this.seenPlayer){if(this.seenPlayer){if(this.room.playerTicked===this.targetPlayer)if(this.alertTicks=Math.max(0,this.alertTicks-1),this.ticks++,this.ticks%2==1){this.rumbling=!0;let t=this.x,e=this.y,i=Array();for(const t of this.room.entities)t!==this&&i.push({x:t.x,y:t.y});for(let t=this.x-1;t<=this.x+1;t++)for(let e=this.y-1;e<=this.y+1;e++)this.room.roomArray[t][e]instanceof o.SpikeTrap&&this.room.roomArray[t][e].on&&i.push({x:t,y:e});this.target=this.getAverageLuminance()>0?this.targetPlayer:this.room.getExtremeLuminanceFromPoint(this.x,this.y).darkest;const a=this.searchPathLocalized(this.target,i,{useLastPlayerPos:!0});a.length>0?(this.tryMove(a[0].pos.x,a[0].pos.y),this.setDrawXY(t,e),this.x>t?this.direction=s.Direction.RIGHT:this.x<t?this.direction=s.Direction.LEFT:this.y>e?this.direction=s.Direction.DOWN:this.y<e&&(this.direction=s.Direction.UP),this.tryCrush(),this.animateCrush(),this.animateCrush()):(this.tryCrush(),this.animateCrush()),this.makeHitWarning(),this.rumbling=!1}else this.rumbling=!0,this.makeHitWarnings(),this.makeHitWarning();let t=-1!==Object.values(this.game.offlinePlayers).indexOf(this.targetPlayer);if(!this.aggro||t){let e=this.nearestPlayer();if(!1!==e){let[i,s]=e;i<=4&&(t||i<this.playerDistance(this.targetPlayer))&&s!==this.targetPlayer&&(this.targetPlayer=s,this.facePlayer(s),s===this.game.players[this.game.localPlayerID]&&(this.alertTicks=1),this.ticks)}}}}else this.lookForPlayer();this.makeHitWarning()}},this.makeHitWarning=()=>{this.room.hitwarnings.push(new l.HitWarning(this.room.game,this.x,this.y,this.x-1,this.y-1,!1,!1))},this.animateCrush=()=>{this.animateY=-1,setTimeout(()=>{this.animateY=3,h.Sound.playCrush(),setTimeout(()=>{this.game.shakeScreen(2*this.x,2*this.y,!0)},100),setTimeout(()=>{this.animateY=0},500)},150)},this.updateAnimateY=t=>{const e=this.animateY-this.softAnimateY;this.softAnimateY=e>.001||e<-.001?this.softAnimateY+.2*e*t:this.animateY,this.softAnimateY>1.25&&(this.softAnimateY=1.25)},this.draw=t=>{if(this.drawableY=this.y+.1,!this.dead){if(s.Game.ctx.save(),s.Game.ctx.globalAlpha=this.alpha,!this.dead){this.updateDrawXY(t),this.updateAnimateY(t);let e=this.rumble(this.rumbling,this.frame,this.direction).x,i=this.rumble(this.rumbling,this.frame,this.direction).y;this.frame+=.1*t,this.frame>=4&&(this.frame=0),this.hasShadow&&this.drawShadow(t),s.Game.drawObj(this.tileX,this.tileY,2,2,this.x-this.drawX+e-.5,this.y-this.drawYOffset-this.drawY+i+this.softAnimateY,2*this.crushX,2*this.crushY,this.softShadeColor,this.shadeAmount()),this.crushed&&this.crushAnim(t)}s.Game.ctx.restore()}},this.ticks=0,this.frame=0,this.health=1,this.maxHealth=1,this.defaultMaxHealth=1,this.tileX=3,this.tileY=4,this.seenPlayer=!1,this.aggro=!1,this.name="crusher",this.orthogonalAttack=!0,this.imageParticleX=3,this.imageParticleY=24,this.drawYOffset=2.5,this.shouldDrawAbovePlayer=!0,this.collidable=!1,this.destroyable=!1,this.getDrop(["weapon","equipment","consumable","tool","coin"])}get alertText(){return`New Enemy Spotted: Crab \n    Health: ${this.health}\n    Attack Pattern: Omnidirectional\n    Moves every other turn`}}e.CrusherEnemy=c,c.difficulty=1,c.tileX=8,c.tileY=4},2502:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.globalEventBus=void 0;const s=i(3718);class o{constructor(){this.eventEmitter=new s.EventEmitter}static getInstance(){return o.instance||(o.instance=new o),o.instance}emit(t,e){this.eventEmitter.emit(t,e)}on(t,e){this.eventEmitter.on(t,e)}off(t,e){this.eventEmitter.off(t,e)}}e.globalEventBus=o.getInstance()},2508:(t,e,i)=>{"use strict";t.exports=i.p+"assets/font.87527e9249dc5d78475e.png"},2571:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.FishingSpot=void 0;const s=i(606),o=i(7851),a=i(4918),r=i(606),n=i(9467),h=i(1236),l=i(7366),c=i(2694),d=i(2147),m=i(3446),u=i(6291);class p extends s.Entity{constructor(t,e,i,s){super(t,e,i,s),this.fishCount=0,this.active=!1,this.startFrame=0,this.fish=t=>{t.inventory.canFish()?this.active?(this.game.pushMessage("Fishing..."),t.busyAnimating=!0,t.setHitXY(this.x,this.y,.5),l.Sound.playFishingCast(),setTimeout(()=>{let e="";if(l.Sound.playFishingReel(),this.tryFish()){!1===t.inventory.addItem(new c.Fish(this.room,this.x,this.y))&&this.room.items.push(new c.Fish(this.room,t.x,t.y)),e="You catch a fish.",l.Sound.playFishingCatch();let i=1.5**this.room.depth,s=Math.ceil((50*n.Random.rand()+100)*i);d.statsTracker.increaseXp(s),u.GameConstants.XP_POPUP_ENABLED&&this.room.particles.push(new m.XPPopup(this.room,this.x,this.y,s)),this.fishCount--,this.fishCount<=0&&(this.active=!1)}else e="You don't catch anything.";this.room.game.pushMessage(e),t.busyAnimating=!1},1200),this.room.tick(t)):this.game.pushMessage("There aren't any fish here."):this.game.pushMessage("You need a fishing rod to fish.")},this.tryFish=()=>n.Random.rand()<.3,this.interact=t=>{this.fish(t)},this.draw=t=>{!this.dead&&this.active&&(0!==this.startFrame&&(this.frame=this.startFrame,this.startFrame=0),this.frame+=.12*t,this.frame>=9&&(this.frame=0),o.Game.drawFX(23+Math.floor(this.frame),0,1,1,this.x-this.drawX,this.y-this.drawY,1,1,this.room.shadeColor,this.shadeAmount()))},this.drawTopLayer=t=>{this.drawableY=this.y},this.room=t,this.health=1,this.tileX=11,this.tileY=0,this.hasShadow=!1,this.chainPushable=!1,this.name="fishing spot",this.fishCount=Math.floor(6*n.Random.rand())-3,this.active=this.fishCount>0,this.startFrame=Math.floor(9*n.Random.rand()),this.imageParticleX=0,this.imageParticleY=29,this.destroyable=!1,this.interactable=!0,n.Random.rand()<.025?this.drops.push(new a.Heart(this.room,this.x,this.y)):this.drops.push(new h.Coin(this.room,this.x,this.y))}get type(){return r.EntityType.PROP}}e.FishingSpot=p},2614:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.guiButton=void 0;const s=i(7366),o=i(8696);e.guiButton=class{constructor(t,e,i,a,r,n,h=!1,l){this.toggleMuteText=()=>{o.MuteButton.toggleMute(),this.text=s.Sound.audioMuted?"Sound Muted":"Sound Unmuted",this.parent?.game.pushMessage(this.text)},this.toggleable=h,this.toggled=!1,this.x=t,this.y=e,this.width=i,this.height=a,this.text=r,this.onClick=n,this.parent=l,this.noFill=!1,this.textColor=void 0}isPointInButton(t,e){return t>=this.x&&t<=this.x+this.width&&e>=this.y&&e<=this.y+this.height}}},2661:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.DarkPillar=void 0;const s=i(606),o=i(7851),a=i(606);class r extends s.Entity{constructor(t,e,i,s){super(t,e,i,s),this.draw=t=>{this.dead||(o.Game.ctx.save(),o.Game.ctx.globalAlpha=this.alpha,this.dead||(this.hasShadow&&this.drawShadow(t),this.updateDrawXY(t),o.Game.drawObj(this.tileX,this.tileY,1,2,this.x-this.drawX,this.y-this.drawYOffset-this.drawY,1,2,this.room.shadeColor,this.shadeAmount())),o.Game.ctx.restore())},this.drawTopLayer=t=>{this.drawableY=this.y},this.room=t,this.health=1,this.tileX=7,this.tileY=6,this.hasShadow=!0,this.pushable=!0,this.name="dark pillar",this.imageParticleX=3,this.imageParticleY=25}get type(){return a.EntityType.PROP}}e.DarkPillar=r},2694:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Fish=void 0;const s=i(5180),o=i(7366);class a extends s.Usable{constructor(t,e,i){super(t,e,i),this.onUse=t=>{t.health<t.maxHealth&&(t.health=Math.min(t.maxHealth,t.health+1),o.Sound.playEat(),this.stackCount>1?this.stackCount--:t.inventory.removeItem(this),t.game.pushMessage("You eat the fish and feel better."))},this.getDescription=()=>"FISH\nLooks spiky.",this.tileX=5,this.tileY=2,this.stackable=!0}}e.Fish=a,a.itemName="fish"},2772:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.ScytheBlade=void 0;const s=i(5180),o=i(920),a=i(5734);class r extends s.Usable{constructor(t,e,i){super(t,e,i),this.onDrop=()=>{"blade"===this.level.game.lastDroppedScythePiece?(this.level.game.lastDroppedScythePiece=null,this.level.items.push(new a.ScytheHandle(this.level,this.x,this.y)),this.level.items=this.level.items.filter(t=>t!==this)):null===this.level.game.lastDroppedScythePiece&&(this.level.game.lastDroppedScythePiece="blade")},this.useOnOther=(t,e)=>{if(e instanceof a.ScytheHandle){t.inventory.removeItem(this),t.inventory.removeItem(e),t.game.pushMessage("You combine the scythe blade and handle.");const i=t?.getRoom?t.getRoom():t.game.rooms[t.levelID],s=new o.Scythe(i,t.x,t.y);t.inventory.addItem(s)}},this.tileX=30,this.tileY=2,this.stackable=!1,this.name=r.itemName,this.description="The blade of a scythe. Find the handle to use it.",this.canUseOnOther=!0}}e.ScytheBlade=r,r.itemName="scythe blade"},2890:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.PlayerInputHandler=void 0;const s=i(3628),o=i(7851),a=i(8900),r=i(1103),n=i(6291),h=i(8696),l=i(7366);e.PlayerInputHandler=class{constructor(t){this.mouseHoldInitialDirection=null,this.handleNumKey=t=>{if(!this.player.menu.open)if(this.setMostRecentInput("keyboard"),t<=5)this.player.actionProcessor.process({type:"InventorySelect",index:t-1});else if(n.GameConstants.DEVELOPER_MODE)switch(t){case 6:n.GameConstants.SET_SHADE_LAYER_COMPOSITE_OPERATION(!0);break;case 7:n.GameConstants.SET_SHADE_LAYER_COMPOSITE_OPERATION(!1)}},this.ignoreDirectionInput=()=>this.player.inventory.isOpen||this.player.dead||this.player.game.levelState!==o.LevelState.IN_LEVEL||this.player.menu.open||this.player.inventory.isPointInQuickbarBounds(s.Input.mouseX,s.Input.mouseY).inBounds&&this.player.game.isMobile,this.setMostRecentInput=t=>{this.mostRecentInput=t},this.setMostRecentMoveInput=t=>{this.mostRecentMoveInput=t},this.mouseAngle=()=>{const t=a.MouseCursor.getInstance().getPosition(),e=n.GameConstants.WIDTH/2,i=n.GameConstants.HEIGHT/2,s=t.x-e,o=t.y-i;return Math.atan2(o,s)},this.faceMouse=()=>{if(!n.GameConstants.MOVE_WITH_MOUSE||"keyboard"===this.mostRecentMoveInput||n.GameConstants.isMobile)return;const t=this.mouseAngle();t>=-Math.PI/4&&t<Math.PI/4?this.player.direction=o.Direction.RIGHT:t>=Math.PI/4&&t<3*Math.PI/4?this.player.direction=o.Direction.DOWN:t>=-3*Math.PI/4&&t<-Math.PI/4?this.player.direction=o.Direction.UP:this.player.direction=o.Direction.LEFT},this.player=t,this.mostRecentInput="keyboard",this.mostRecentMoveInput="keyboard",this.moveStartTime=0,t.isLocalPlayer&&this.setupListeners()}setupListeners(){try{s.Input.mouseRightClickListeners.length=0,s.Input.mouseLeftClickListeners.length=0}catch{}s.Input.leftSwipeListener=()=>this.handleInput(s.InputEnum.LEFT),s.Input.rightSwipeListener=()=>this.handleInput(s.InputEnum.RIGHT),s.Input.upSwipeListener=()=>this.handleInput(s.InputEnum.UP),s.Input.downSwipeListener=()=>this.handleInput(s.InputEnum.DOWN),s.Input.commaListener=()=>this.handleInput(s.InputEnum.COMMA),s.Input.periodListener=()=>this.handleInput(s.InputEnum.PERIOD),s.Input.tapListener=()=>this.handleTap(),s.Input.mouseMoveListener=()=>this.handleInput(s.InputEnum.MOUSE_MOVE),s.Input.mouseRightClickListeners.push(()=>this.handleInput(s.InputEnum.RIGHT_CLICK)),s.Input.mouseDownListeners.push((t,e,i)=>this.handleMouseDown(t,e,i)),s.Input.numKeyListener=t=>this.handleInput(s.InputEnum.NUMBER_1+t-1),s.Input.equalsListener=()=>this.handleInput(s.InputEnum.EQUALS),s.Input.minusListener=()=>this.handleInput(s.InputEnum.MINUS),s.Input.escapeListener=()=>this.handleInput(s.InputEnum.ESCAPE),s.Input.fListener=()=>this.handleInput(s.InputEnum.F),s.Input.wheelListener=t=>this.handleMouseWheel(t)}handleInput(t){if(this.player.game.cameraAnimation.active)switch(t){case s.InputEnum.SPACE:case s.InputEnum.LEFT_CLICK:return void(this.player.game.cameraAnimation.fast=!0);default:return}if(!this.player.busyAnimating&&(this.player.game.levelState!==o.LevelState.TRANSITIONING&&this.player.game.levelState!==o.LevelState.TRANSITIONING_LADDER||t===s.InputEnum.MOUSE_MOVE))if(this.player.menu.open)this.player.menu.inputHandler(t);else if(this.player.game.started||t===s.InputEnum.MOUSE_MOVE)switch(t){case s.InputEnum.I:{const t=this.player.inventory;this.player.actionProcessor.process({type:t.isOpen?"CloseInventory":"OpenInventory"});break}case s.InputEnum.Q:this.player.actionProcessor.process({type:"InventoryDrop"});break;case s.InputEnum.F:break;case s.InputEnum.LEFT:if(this.player.dead){this.navigateDeathScreen(-1);break}this.ignoreDirectionInput()||this.player.actionProcessor.process({type:"Move",direction:o.Direction.LEFT,targetX:this.player.x-1,targetY:this.player.y});break;case s.InputEnum.RIGHT:if(this.player.dead){this.navigateDeathScreen(1);break}this.ignoreDirectionInput()||this.player.actionProcessor.process({type:"Move",direction:o.Direction.RIGHT,targetX:this.player.x+1,targetY:this.player.y});break;case s.InputEnum.UP:if(this.player.dead){this.navigateDeathScreen(-1);break}this.ignoreDirectionInput()||this.player.actionProcessor.process({type:"Move",direction:o.Direction.UP,targetX:this.player.x,targetY:this.player.y-1});break;case s.InputEnum.DOWN:if(this.player.dead){this.navigateDeathScreen(1);break}this.ignoreDirectionInput()||this.player.actionProcessor.process({type:"Move",direction:o.Direction.DOWN,targetX:this.player.x,targetY:this.player.y+1});break;case s.InputEnum.SPACE:if(this.player.game.cameraAnimation.active){this.player.game.cameraAnimation.fast=!0;break}const e=this.player;if(this.setMostRecentInput("keyboard"),e.game.chatOpen)return;if(e.dead)return void e.restart();if(this.player.openVendingMachine&&this.player.openVendingMachine.open){this.player.openVendingMachine.space();break}(e.inventory.isOpen||e.game.levelState===o.LevelState.IN_LEVEL)&&(this.setMostRecentInput("keyboard"),this.player.actionProcessor.process({type:"InventoryUse"}));break;case s.InputEnum.COMMA:this.setMostRecentInput("keyboard"),this.player.actionProcessor.process({type:"InventoryLeft"});break;case s.InputEnum.PERIOD:this.setMostRecentInput("keyboard"),this.player.actionProcessor.process({type:"InventoryRight"});break;case s.InputEnum.LEFT_CLICK:if(this.player.game.cameraAnimation.active){this.player.game.cameraAnimation.fast=!0;break}this.handleMouseLeftClick();break;case s.InputEnum.RIGHT_CLICK:this.handleMouseRightClick();break;case s.InputEnum.MOUSE_MOVE:if(this.setMostRecentInput("mouse"),this.player.inventory.mouseMove(),s.Input.mouseDown&&s.Input.mouseDownHandled){let t=!1;const e=s.Input.mouseX-s.Input.lastMouseDownX,i=s.Input.mouseY-s.Input.lastMouseDownY;Math.sqrt(e*e+i*i)>1.5*n.GameConstants.TILESIZE&&(t=!0),null!==this.mouseHoldInitialDirection&&this.player.direction!==this.mouseHoldInitialDirection&&(t=!0),t&&(s.Input.mouseDownHandled=!1,s.Input.lastMouseDownTime=0,this.mouseHoldInitialDirection=null)}this.ignoreDirectionInput()&&!n.GameConstants.isMobile||(this.faceMouse(),this.player.setTileCursorPosition());break;case s.InputEnum.NUMBER_1:case s.InputEnum.NUMBER_2:case s.InputEnum.NUMBER_3:case s.InputEnum.NUMBER_4:case s.InputEnum.NUMBER_5:case s.InputEnum.NUMBER_6:case s.InputEnum.NUMBER_7:case s.InputEnum.NUMBER_8:case s.InputEnum.NUMBER_9:this.setMostRecentInput("keyboard"),this.handleNumKey(t-13);break;case s.InputEnum.EQUALS:this.player.game.increaseScale();break;case s.InputEnum.MINUS:this.player.game.decreaseScale();break;case s.InputEnum.ESCAPE:this.player.inventory.close()}else{if(this.player.game.startMenuActive)return;this.player.game.startedFadeOut=!0}}handleMouseWheel(t){if(this.player.game.levelState!==o.LevelState.IN_LEVEL)return;const e=this.player.inventory,i=t>0?1:-1,s=this.player.inventory.cols;let a=(this.player.inventory.selX+i)%s;a<0&&(a+=s),this.player.inventory.selX=a,this.player.inventory.selY=0,this.setMostRecentInput("keyboard"),e.mostRecentInput="keyboard"}handleMouseRightClick(){this.setMostRecentInput("mouse");const{x:t,y:e}=a.MouseCursor.getInstance().getPosition();this.player.inventory.isPointInInventoryBounds(t,e).inBounds&&this.player.inventory.drop()}handleMouseDown(t,e,i){if(0!==i)return;const a=this.player;if(a.game.cameraAnimation.active)return a.game.cameraAnimation.fast=!0,void(s.Input.mouseDownHandled=!0);if(n.GameConstants.MOBILE_KEYBOARD_SUPPORT&&a.game.isMobile&&!a.game.chatOpen){if(a.dead)return;if(a.game.isPointInChatHotspot(t,e))return a.game.chatOpen=!0,a.game.chatTextBox.focus(),void(s.Input.mouseDownHandled=!0)}else if(n.GameConstants.MOBILE_KEYBOARD_SUPPORT&&a.game.isMobile&&a.game.chatOpen&&!a.game.isPointInChatHotspot(t,e))return a.game.chatOpen=!1,a.game.chatTextBox.blur?.(),void(s.Input.mouseDownHandled=!0);if(a.game.levelState!==o.LevelState.IN_LEVEL)return!a.game.started&&a.game.startMenuActive?(a.game.startMenu?.mouseInputHandler(t,e),void(s.Input.mouseDownHandled=!0)):void(s.Input.mouseDownHandled=!1);if(this.setMostRecentInput("mouse"),a.map?.mapOpen)return a.map.toggleMapOpen(),void(s.Input.mouseDownHandled=!0);if(a.dead)return this.handleDeathScreenInput(t,e),void(s.Input.mouseDownHandled=!0);if(!a.game.started)return a.game.startMenuActive?a.game.startMenu?.mouseInputHandler(t,e):a.game.startedFadeOut=!0,void(s.Input.mouseDownHandled=!0);s.Input.lastMouseDownTime=Date.now(),s.Input.lastMouseDownX=t,s.Input.lastMouseDownY=e;const h=a.inventory;return h.isOpen&&!h.isPointInInventoryBounds(t,e).inBounds||h.isPointInInventoryButton(t,e)?(h.toggleOpen(),void(s.Input.mouseDownHandled=!0)):this.player.menu.open?(this.player.menu.mouseInputHandler(t,e),void(s.Input.mouseDownHandled=!0)):this.isPointInMenuButtonBounds(t,e)?(this.handleMenuButtonClick(),void(s.Input.mouseDownHandled=!0)):a.map&&a.map.isPointInMinimapBounds(t,e)?(a.map.toggleMapOpen(),void(s.Input.mouseDownHandled=!0)):a.openVendingMachine?(r.VendingMachine.isPointInVendingMachineBounds(t,e,a.openVendingMachine)?a.openVendingMachine.space():a.openVendingMachine.close(),void(s.Input.mouseDownHandled=!0)):void(h.isPointInInventoryButton(t,e)||h.isPointInQuickbarBounds(t,e).inBounds||h.isOpen||this.isPointInMenuButtonBounds(t,e)||a.busyAnimating||a.game.cameraAnimation.active?s.Input.mouseDownHandled=!1:(this.mouseHoldInitialDirection=this.player.direction,a.moveWithMouse(),s.Input.mouseDownHandled=!0))}handleMouseLeftClick(){const t=this.player,e=a.MouseCursor.getInstance(),{x:i,y:n}=e.getPosition();if(t.game.levelState!==o.LevelState.IN_LEVEL)return void(!t.game.started&&t.game.startMenuActive&&t.game.startMenu?.mouseInputHandler(i,n));if(this.setMostRecentInput("mouse"),t.dead)return void this.handleDeathScreenInput(i,n);const h=t.inventory;if((h.isOpen&&!h.isPointInInventoryBounds(i,n).inBounds||h.isPointInInventoryButton(i,n))&&h.toggleOpen(),this.player.menu.open)this.player.menu.mouseInputHandler(i,n);else if(this.isPointInMenuButtonBounds(i,n))this.handleMenuButtonClick();else if(t.openVendingMachine)if(r.VendingMachine.isPointInVendingMachineBounds(i,n,t.openVendingMachine))t.openVendingMachine.space();else{t.openVendingMachine.close(),this.setMostRecentInput("mouse");const{x:e,y:i}=a.MouseCursor.getInstance().getPosition();this.player.inventory.isPointInInventoryBounds(e,i)}else!h.isPointInInventoryButton(i,n)&&!h.isPointInQuickbarBounds(i,n).inBounds&&!h.isOpen&&!s.Input.mouseDownHandled&&t.moveWithMouse()}handleTap(){if(s.Input.mouseDownHandled)return;if(this.player.game.cameraAnimation.active)return void(this.player.game.cameraAnimation.fast=!0);if(this.player.dead)return void this.handleDeathScreenInput(s.Input.mouseX,s.Input.mouseY);if(!this.player.game.started)return void(this.player.game.startMenuActive?this.player.game.startMenu?.mouseInputHandler(s.Input.mouseX,s.Input.mouseY):this.player.game.startedFadeOut=!0);if(this.player.menu.open)return void this.player.menu.mouseInputHandler(s.Input.mouseX,s.Input.mouseY);const t=s.Input.mouseX,e=s.Input.mouseY;if(this.isPointInMenuButtonBounds(t,e))return void this.handleMenuButtonClick();const i=this.player.inventory.isPointInInventoryBounds(t,e).inBounds,o=this.player.inventory.isPointInQuickbarBounds(t,e).inBounds;if(this.player.openVendingMachine&&this.player.openVendingMachine.open){const t=r.VendingMachine.isPointInVendingMachineBounds(s.Input.mouseX,s.Input.mouseY,this.player.openVendingMachine);if(t)return void this.player.openVendingMachine.space();if(!t){this.player.openVendingMachine.close(),this.setMostRecentInput("mouse");const{x:t,y:e}=a.MouseCursor.getInstance().getPosition();this.player.inventory.isPointInInventoryBounds(t,e)}return}!this.player.inventory.isOpen&&this.player.inventory.isPointInInventoryButton(t,e)?this.player.inventory.open():this.player.inventory.isOpen?i?this.handleInput(s.InputEnum.LEFT_CLICK):this.player.inventory.close():o&&this.handleInput(s.InputEnum.LEFT_CLICK)}handleKeyboardKey(t){switch(t.toUpperCase()){case"A":case"ARROWLEFT":this.handleInput(s.InputEnum.LEFT);break;case"D":case"ARROWRIGHT":this.handleInput(s.InputEnum.RIGHT);break;case"W":case"ARROWUP":this.handleInput(s.InputEnum.UP);break;case"S":case"ARROWDOWN":this.handleInput(s.InputEnum.DOWN);break;case" ":this.handleInput(s.InputEnum.SPACE);break;case"I":this.handleInput(s.InputEnum.I);break;case"Q":this.handleInput(s.InputEnum.Q)}}isPointInMuteButtonBounds(t,e){const i=n.GameConstants.TILESIZE;return t>=0&&t<=i&&e>=0&&e<=1.5*i}handleMuteButtonClick(){h.MuteButton.toggleMute(),this.player.game.pushMessage(l.Sound.audioMuted?"Audio muted":"Audio unmuted")}isPointInMenuButtonBounds(t,e){const i=n.GameConstants.TILESIZE;return t>=0&&t<=1.5*i&&e>=0&&e<=i}handleMenuButtonClick(){this.player.menu.toggleOpen()}handleDeathScreenInput(t,e){this.isInteractingWithFeedbackButton(t,e)?this.player.game.feedbackButton.onClick():this.player.restart()}isInteractingWithFeedbackButton(t,e){return this.player.game.feedbackButton&&this.player.game.feedbackButton.isPointInButton(t,e)}navigateDeathScreen(t){this.setMostRecentInput("keyboard");const e=Math.max(1,this.player.deathScreenPageCount||1);if(e<=1)return;let i=((this.player.deathScreenPageIndex||0)+t)%e;i<0&&(i+=e),this.player.deathScreenPageIndex=i}}},2953:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.GlowStick=void 0;const s=i(1650);class o extends s.Light{constructor(t,e,i){super(t,e,i),this.fuel=100,this.tileX=27,this.tileY=2,this.name=o.itemName,this.fuelCap=100,this.radius=10,this.stackable=!0,this.maxBrightness=2,this.color=[5,150,50],this.waterproof=!0,this.falloffDecay=.7}}e.GlowStick=o,o.itemName="glow stick"},3005:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.BishopEnemy=void 0;const s=i(7851),o=i(7455),a=i(4804),r=i(6986);class n extends r.Enemy{constructor(t,e,i,r,n){super(t,e,i,r),this.tryMove=(t,e)=>{let i=(i,s)=>i>=t&&i<t+this.w&&s>=e&&s<e+this.h,s=i=>!(i.x>=t+this.w||i.x+i.w<=t||i.y>=e+this.h||i.y+i.h<=e);for(const t of this.room.entities)if(t!==this&&s(t))return;for(const t in this.game.players)if(i(this.game.players[t].x,this.game.players[t].y))return;let o=[];for(let i=0;i<this.w;i++)for(let s=0;s<this.h;s++){if(this.room.roomArray[t+i][e+s].isSolid())return;o.push(this.room.roomArray[t+i][e+s])}for(let t of o)t.onCollideEnemy(this);this.x=t,this.y=e},this.hit=()=>this.damage,this.jump=t=>{let e=Math.max(Math.abs(this.drawX),Math.abs(this.drawY)),i=Math.abs(Math.sin(e*Math.PI))*this.jumpHeight;i<.01&&(i=0),i>this.jumpHeight&&(i=this.jumpHeight),this.jumpY=i},this.behavior=()=>{if(!this.dead){if(this.handleSkipTurns())return;if(this.ticks++,this.seenPlayer){if(this.seenPlayer){if(this.room.playerTicked===this.targetPlayer){this.alertTicks=Math.max(0,this.alertTicks-1);let t=this.x,e=this.y,i=Array();for(const t of this.room.entities)t!==this&&i.push({x:t.x,y:t.y});for(let t=this.x-1;t<=this.x+1;t++)for(let e=this.y-1;e<=this.y+1;e++)this.room.roomArray[t][e]instanceof o.SpikeTrap&&this.room.roomArray[t][e].on&&i.push({x:t,y:e}),this.room.roomArray[t][e]instanceof a.Door&&i.push({x:t,y:e});i.push({x:this.x+1,y:this.y}),i.push({x:this.x-1,y:this.y}),i.push({x:this.x,y:this.y+1}),i.push({x:this.x,y:this.y-1}),i.push({x:this.x,y:this.y});let s=this.searchPathLocalized(this.targetPlayer,i,{diagonals:!0,allowOmni:!0});if(s=s.filter(t=>{const e=Math.abs(t.pos.x-this.x),i=Math.abs(t.pos.y-this.y);return 1===e&&1===i}),this.justHurt)this.retreat(t,e);else if(s.length>0){let i=s[0].pos.x,o=s[0].pos.y,a=!1;for(const t in this.game.players)this.game.rooms[this.game.players[t].levelID]===this.room&&this.game.players[t].x===i&&this.game.players[t].y===o&&(this.game.players[t].hurt(this.hit(),this.name),this.drawX=.5*(this.x-this.game.players[t].x),this.drawY=.5*(this.y-this.game.players[t].y),a=!0,this.game.players[t]===this.game.players[this.game.localPlayerID]&&this.game.shakeScreen(10*this.drawX,10*this.drawY));a||(this.tryMove(i,o),this.setDrawXY(t,e))}this.makeHitWarnings()}let t=-1!==Object.values(this.game.offlinePlayers).indexOf(this.targetPlayer);if(!this.aggro||t){let e=this.nearestPlayer();if(!1!==e){let[i,s]=e;i<=4&&(t||i<this.playerDistance(this.targetPlayer))&&s!==this.targetPlayer&&(this.targetPlayer=s,this.facePlayer(s),s===this.game.players[this.game.localPlayerID]&&(this.alertTicks=1),this.makeHitWarnings())}}}}else this.lookForPlayer()}},this.draw=t=>{if(this.dead)return;s.Game.ctx.save(),s.Game.ctx.globalAlpha=this.alpha;let e=this.health<=1||!0===this.cloned?2:0;this.dead||(this.updateDrawXY(t),this.frame+=.1*t,this.frame>=4&&(this.frame=0),this.hasShadow&&this.drawShadow(t),s.Game.drawMob(this.tileX+Math.floor(this.frame),this.tileY+e,1,2,this.x-this.drawX,this.y-this.drawYOffset-this.drawY-this.jumpY,1,2,this.softShadeColor,this.shadeAmount()*(1+this.jumpY/3),void 0,this.outlineColor(),this.outlineOpacity())),this.cloned||(this.seenPlayer||this.drawSleepingZs(t),this.alertTicks>0&&this.drawExclamation(t)),s.Game.ctx.restore()},this.ticks=0,this.frame=0,this.health=2,this.maxHealth=2,this.defaultMaxHealth=2,this.tileX=31,this.tileY=8,this.seenPlayer=!1,this.aggro=!1,this.name="bishop",this.jumpHeight=1,this.diagonalAttackRange=1,this.diagonalAttack=!0,this.orthogonalAttack=!1,this.imageParticleX=0,this.imageParticleY=26,n&&(this.drop=n),this.armored=!0,this.getDrop(["weapon","equipment","consumable","tool","coin"])}}e.BishopEnemy=n,n.difficulty=2,n.tileX=31,n.tileY=8},3067:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Lockable=e.LockType=void 0;const s=i(7851),o=i(5926),a=i(7366),r=i(9467),n=i(6291);var h;!function(t){t[t.NONE=0]="NONE",t[t.LOCKED=1]="LOCKED",t[t.GUARDED=2]="GUARDED",t[t.TUNNEL=3]="TUNNEL"}(h=e.LockType||(e.LockType={}));class l{constructor(t,e){this.locked=!1,this.unlocking=!1,this.iconAlpha=1,this.iconYOffset=0,this.frame=0,this.keyID=0,this.game=t,this.lockType=e.lockType,this.keyID=e.keyID||0,this.iconTileX=e.iconTileX||2,this.iconXOffset=e.iconXOffset||0,this.isTopDoor=e.isTopDoor||!1,this.initializeLockState()}initializeLockState(){switch(this.lockType){case h.LOCKED:this.lock();break;case h.GUARDED:this.guard();break;case h.TUNNEL:this.lock(),this.iconTileX=10,this.iconXOffset=1/32;break;case h.NONE:this.removeLock()}}isLocked(){return this.locked}isUnlocking(){return this.unlocking}lock(){this.locked=!0,this.iconTileX=10,this.iconXOffset=1/32}guard(){this.lockType=h.GUARDED,this.locked=!0,this.iconTileX=9,this.iconXOffset=1/32}removeLock(){this.lockType=h.NONE,this.locked=!1}removeLockIcon(){this.iconYOffset=0,this.unlocking=!1,this.iconTileX=2,this.iconXOffset=0,this.iconAlpha=1}canUnlock(t){if(n.GameConstants.DEVELOPER_MODE)return!0;if(this.lockType===h.LOCKED){const e=this.hasKeyWithID(this.keyID,t);return console.log(this.keyID),null!==e?(this.game.pushMessage("You use the key to unlock."),console.log("key.doorID",e.doorID,"lock.keyID",this.keyID),!0):(t.inventory.hasItem(o.Key)?this.game.pushMessage("The key doesn't fit the lock."):this.game.pushMessage("It's locked tightly and won't budge."),!1)}return this.lockType!==h.GUARDED||!this.game.room.entities.some(t=>t.constructor.name.includes("Enemy")&&!t.dead)||(this.game.pushMessage("There are still remaining foes guarding this..."),!1)}unlock(t){if(this.lockType===h.LOCKED){const e=this.hasKeyWithID(this.keyID,t);(null!==e||n.GameConstants.DEVELOPER_MODE)&&(t.inventory.removeItem(e),a.Sound.unlock(),this.removeLock(),this.unlocking=!0)}else this.lockType===h.TUNNEL&&(this.locked=!1,this.unlocking=!0)}hasKeyWithID(t,e){const i=e.inventory;for(const e of i.items)if(e instanceof o.Key&&e.doorID===t)return e;return null}unGuard(){this.lockType===h.GUARDED&&(this.removeLock(),a.Sound.unlock(),this.game.tutorialActive=!1),setTimeout(()=>{this.removeLockIcon()},1e3)}update(t){this.frame>100&&(this.frame=0),this.frame+=1*t}drawIcon(t,e,i){s.Game.ctx.globalAlpha=this.iconAlpha;let o=.125;this.unlocking&&(this.iconAlpha*=.92**i,this.iconYOffset-=.035*i,o=0,this.iconAlpha<=.01&&this.removeLockIcon());const a=(this.isTopDoor,e-1.25);this.lockType!==h.NONE||this.unlocking?(s.Game.drawFX(this.iconTileX,2,1,1,t+this.iconXOffset,a+o*Math.sin(this.frame*Math.PI/50)+this.iconYOffset,1,1),s.Game.ctx.globalAlpha=1):s.Game.drawFX(2,2,1,1,t,e-1.25+o*Math.sin(this.frame*Math.PI/50),1,1)}setKey(t){this.keyID=l.generateID(),t.doorID=this.keyID}static generateID(){return Math.floor(1e6*r.Random.rand())}}e.Lockable=l},3122:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.DarkPot=void 0;const s=i(606),o=i(7851),a=i(606),r=i(9467),n=i(7366);class h extends s.Entity{constructor(t,e,i,s){super(t,e,i,s),this.draw=t=>{this.dead||(o.Game.ctx.save(),o.Game.ctx.globalAlpha=this.alpha,this.dead||(this.hasShadow&&this.drawShadow(t),this.updateDrawXY(t),o.Game.drawObj(this.tileX,this.tileY,1,2,this.x-this.drawX,this.y-this.drawYOffset-this.drawY,1,2,this.room.shadeColor,this.shadeAmount())),o.Game.ctx.restore())},this.drawTopLayer=t=>{this.drawableY=this.y},this.room=t,this.health=1,this.tileX=8,this.tileY=6,this.hasShadow=!0,this.chainPushable=!1,this.name="dark pot",this.hitSound=n.Sound.potSmash,this.imageParticleX=0,this.imageParticleY=29,r.Random.rand()}get type(){return a.EntityType.PROP}}e.DarkPot=h},3130:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Menu=void 0;const s=i(7851),o=i(2614),a=i(3628),r=i(6291),n=i(8900),h=i(4254);e.Menu=class{constructor(t){this.showCloseButton=!0,this.selectionTimeoutId=null,this.lastButtonClickTime=0,this.lastButtonClickIndex=-1,this.BUTTON_CLICK_DEBOUNCE_TIME=150,this.startGame=()=>{this.close()},this.exitGame=()=>{},this.openSettings=()=>{},this.scaleUp=()=>{this.game.increaseScale()},this.scaleDown=()=>{this.game.decreaseScale()},this.buttons=[],this.open=!1,this.selectedButton=0,t instanceof h.Player?(this.game=t.game,this.player=t,this.showCloseButton=!0,this.initializeCloseButton(),this.initializeMainMenu()):(this.game=t.game,this.player=t.player,this.showCloseButton=!1!==t.showCloseButton,this.showCloseButton&&this.initializeCloseButton())}static drawOpenMenuButton(){s.Game.ctx.save(),s.Game.ctx.fillStyle="rgba(255, 255, 0, 1)",s.Game.ctx.globalAlpha=.1,Math.round(1.5*r.GameConstants.TILESIZE-2),Math.round(r.GameConstants.TILESIZE/2-1),r.GameConstants.TILESIZE,r.GameConstants.WIDTH,r.GameConstants.TILESIZE,s.Game.drawFX(18,0,1,1,0,.5,1,1),s.Game.fillText("Menu",10,10),s.Game.ctx.globalAlpha=1,s.Game.ctx.restore()}initializeCloseButton(){const t=Math.round(1.5*r.GameConstants.TILESIZE-2),e=Math.round(1.5*r.GameConstants.TILESIZE-2);this.closeButton=new o.guiButton(0,-1,Math.round(t),Math.round(e),"X",()=>this.close(),!1,this)}initializeMainMenu(){this.addButton(new o.guiButton(0,0,0,0,"- Scale",this.scaleDown,!1,this)),this.addButton(new o.guiButton(0,0,0,0,"+ Scale",this.scaleUp,!1,this));const t=new o.guiButton(0,0,0,0,"Mute Sound",()=>{},!1,this);t.onClick=t.toggleMuteText,this.addButton(t);const e=new o.guiButton(0,0,0,0,"Smooth Lighting",()=>{r.GameConstants.SMOOTH_LIGHTING=!r.GameConstants.SMOOTH_LIGHTING;const t=r.GameConstants.SMOOTH_LIGHTING?"enabled":"disabled";this.game.pushMessage(`Smooth lighting is now ${t}`);try{const{saveSettings:t}=i(1856);t(this.game)}catch{}},!1,this);this.addButton(e);const s=()=>r.GameConstants.SCREEN_SHAKE_ENABLED?"Disable Screen Shake":"Enable Screen Shake",a=new o.guiButton(0,0,0,0,s(),()=>{r.GameConstants.SCREEN_SHAKE_ENABLED=!r.GameConstants.SCREEN_SHAKE_ENABLED,a.text=s();const t=r.GameConstants.SCREEN_SHAKE_ENABLED?"enabled":"disabled";this.game.pushMessage(`Screen shake is now ${t}`);try{const{saveSettings:t}=i(1856);t(this.game)}catch{}},!1,this);this.addButton(a);const n=new o.guiButton(0,0,0,0,"Hover Text",()=>{r.GameConstants.HOVER_TEXT_ENABLED=!r.GameConstants.HOVER_TEXT_ENABLED;const t=r.GameConstants.HOVER_TEXT_ENABLED?"enabled":"disabled";this.game.pushMessage(`Hover text is now ${t}`);try{const{saveSettings:t}=i(1856);t(this.game)}catch{}},!1,this);this.addButton(n);const h=new o.guiButton(0,0,0,0,"Slow Inputs Near Enemies",()=>{r.GameConstants.SLOW_INPUTS_NEAR_ENEMIES=!r.GameConstants.SLOW_INPUTS_NEAR_ENEMIES;const t=r.GameConstants.SLOW_INPUTS_NEAR_ENEMIES?"enabled":"disabled";try{const{saveSettings:t}=i(1856);t(this.game)}catch{}this.game.pushMessage(`Slow inputs near enemies is now ${t}`)},!1,this);this.addButton(h),new o.guiButton(0,0,0,0,"Save Game",()=>{try{const{saveToCookies:t}=i(6760);t(this.game)}catch(t){this.game.pushMessage("Save failed.")}},!1,this),new o.guiButton(0,0,0,0,"Load Game",()=>{try{const{loadFromCookies:t}=i(6760);t(this.game)}catch(t){this.game.pushMessage("Load failed.")}},!1,this);const l=new o.guiButton(0,0,0,0,"New Game",()=>{try{this.game.newGame()}catch(t){this.game.pushMessage("New Game failed.")}},!1,this);this.addButton(l),new o.guiButton(0,0,0,0,"Clear Save",()=>{try{const{clearCookieSave:t}=i(6760);t(),this.game.pushMessage("Cleared cookie/localStorage save.")}catch(t){this.game.pushMessage("Clear Save failed.")}},!1,this),this.positionButtons()}buildStartMenu(){this.buttons=[];const t=new o.guiButton(0,0,0,0,"Welcome to Turnarchist",()=>{},!1,this);if(t.noFill=!0,t.textColor="rgb(255, 255, 0)",this.addButton(t),r.GameConstants.SAVING_ENABLED){const t=new o.guiButton(0,0,0,0,"Continue",()=>{try{const{loadFromCookies:t}=i(6760);t(this.game).then(t=>{t?(this.game.pushMessage("Loaded save."),this.close(),this.game.startedFadeOut=!0,this.game.startMenuActive=!1):this.game.pushMessage("Load failed.")})}catch(t){this.game.pushMessage("Load failed.")}},!1,this);this.addButton(t)}const e=new o.guiButton(0,0,0,0,"New Game",()=>{this.close(),this.game.startedFadeOut=!0,this.game.startMenuActive=!1},!1,this);this.addButton(e),this.positionButtons()}addButton(t){this.buttons.push(t)}draw(){this.open&&(s.Game.ctx.save(),s.Game.ctx.fillStyle="rgba(0, 0, 0, 0)",s.Game.ctx.fillRect(0,0,r.GameConstants.WIDTH,r.GameConstants.HEIGHT),this.buttons.forEach(t=>{this.drawButton(t)}),this.showCloseButton&&this.closeButton&&this.drawCloseButton(),s.Game.ctx.restore())}drawButton(t){s.Game.ctx.save(),s.Game.ctx.imageSmoothingEnabled=!1,s.Game.ctx.strokeStyle="transparent",s.Game.ctx.lineWidth=0,t.noFill||(s.Game.ctx.fillStyle=this.selectedButton===this.buttons.indexOf(t)?"rgba(75, 75, 75, 0.5)":"rgba(100, 100, 100, 0.5)",s.Game.ctx.fillRect(Math.round(t.x),Math.round(t.y),Math.round(t.width),Math.round(t.height))),s.Game.ctx.fillStyle="rgba(255, 255, 0, 1)",t.textColor&&(s.Game.ctx.fillStyle=t.textColor);const e=s.Game.measureText(t.text).width,i=t.x+(t.width-e)/2,o=t.y+t.height/2-s.Game.letter_height/2;s.Game.fillText(t.text,Math.round(i),Math.round(o)),s.Game.ctx.restore()}drawCloseButton(){s.Game.ctx.save(),s.Game.ctx.imageSmoothingEnabled=!1,s.Game.ctx.fillStyle="rgba(220, 60, 60, 1)",s.Game.ctx.fillRect(Math.round(this.closeButton.x),Math.round(this.closeButton.y),Math.round(this.closeButton.width),Math.round(this.closeButton.height)),s.Game.ctx.strokeStyle="rgba(0, 0, 0, 1)",s.Game.ctx.lineWidth=1,this.closeButton&&s.Game.ctx.strokeRect(this.closeButton.x,this.closeButton.y,this.closeButton.width,this.closeButton.height),s.Game.ctx.fillStyle="rgba(255, 255, 255, 1)";const t=s.Game.measureText(this.closeButton.text).width,e=this.closeButton.x+(this.closeButton.width-t)/2,i=this.closeButton.y+this.closeButton.height/2-s.Game.letter_height/2;s.Game.fillText(this.closeButton.text,e,i),s.Game.ctx.restore()}inputHandler(t){if(this.open)switch(t){case a.InputEnum.ESCAPE:this.open=!1;break;case a.InputEnum.UP:this.up();break;case a.InputEnum.DOWN:this.down();break;case a.InputEnum.SPACE:this.select();break;case a.InputEnum.LEFT_CLICK:const{x:t,y:e}=n.MouseCursor.getInstance().getPosition();this.mouseInputHandler(t,e);case a.InputEnum.RIGHT_CLICK:}}mouseInputHandler(t,e){if(!this.open)return;if(this.showCloseButton&&this.isPointInCloseButton(t,e)){const t=Date.now();if(t-this.lastButtonClickTime<this.BUTTON_CLICK_DEBOUNCE_TIME)return;return this.lastButtonClickTime=t,void this.closeButton.onClick()}const i=this.isPointInMenuBounds(t,e);if(i.inBounds&&i.buttonIndex>=0){const t=this.buttons[i.buttonIndex],e=Date.now();if(i.buttonIndex===this.lastButtonClickIndex&&e-this.lastButtonClickTime<this.BUTTON_CLICK_DEBOUNCE_TIME)return;this.lastButtonClickTime=e,this.lastButtonClickIndex=i.buttonIndex,null!==this.selectionTimeoutId&&clearTimeout(this.selectionTimeoutId),this.selectedButton=i.buttonIndex,this.selectionTimeoutId=setTimeout(()=>{this.selectedButton=-1,this.selectionTimeoutId=null},100),t.onClick()}}close(){this.open=!1}openMenu(){this.open=!0,this.selectedButton=-1,this.buttons.forEach((t,e)=>{})}toggleOpen(){this.open?this.close():this.openMenu()}select(){this.buttons[this.selectedButton]&&this.buttons[this.selectedButton].onClick()}up(){this.buttons.length>0&&(this.selectedButton=(this.selectedButton-1+this.buttons.length)%this.buttons.length)}down(){this.buttons.length>0&&(this.selectedButton=(this.selectedButton+1)%this.buttons.length)}positionButtons(){const t=r.GameConstants.WIDTH,e=r.GameConstants.HEIGHT,i=this.buttons.length;this.showCloseButton&&this.closeButton&&(this.closeButton.x=1,this.closeButton.y=r.GameConstants.TILESIZE/2);const o=Math.min(260,Math.floor(.8*t)),a=i-(this.getScaleButtonIndices().length>0?1:0),n=6*Math.max(0,a-1),h=Math.max(0,e-16-n),l=a>0?Math.floor(h/a):22,c=Math.min(22,Math.max(12,l));if(a<=0)return;const d=a*c+n,m=e-16;let u=8+Math.floor((m-d)/2);for(let e=0;e<this.buttons.length;e++){const i=this.buttons[e];if("- Scale"===i.text||"+ Scale"===i.text){"- Scale"===this.buttons[e].text&&this.buttons[e];const i="- Scale"===this.buttons[e].text?e+1:e-1,a=this.buttons[i],r=s.Game.measureText("- Scale").width,n=s.Game.measureText("+ Scale").width,h=Math.min(o,r+16),l=Math.min(o,n+16),d=h+8+l,m=Math.floor((t-d)/2),p=u,y="- Scale"===this.buttons[e].text?this.buttons[e]:this.buttons[i];y.x=m,y.y=p,y.width=h,y.height=c;const g=a;g.x=m+h+8,g.y=p,g.width=l,g.height=c,"- Scale"===this.buttons[e].text&&(e=Math.max(e,i)),u+=c+6}else{const e=s.Game.measureText(i.text).width,a=Math.min(o,e+16);i.width=a,i.x=Math.floor((t-a)/2),i.y=u,i.height=c,u+=c+6}}}getScaleButtonIndices(){const t=[];return this.buttons.forEach((e,i)=>{"- Scale"!==e.text&&"+ Scale"!==e.text||t.push(i)}),t}isPointInMenuBounds(t,e){if(!this.open)return{inBounds:!1,buttonIndex:-1};for(let i=0;i<this.buttons.length;i++){const s=this.buttons[i];if(t>=s.x&&t<=s.x+s.width&&e>=s.y&&e<=s.y+s.height)return{inBounds:!0,buttonIndex:i}}return{inBounds:!1,buttonIndex:-1}}isPointInCloseButton(t,e){return!!this.closeButton&&t>=this.closeButton.x&&t<=this.closeButton.x+this.closeButton.width&&e>=this.closeButton.y&&e<=this.closeButton.y+this.closeButton.height}}},3139:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Trapdoor=void 0;const s=i(7851),o=i(8132);class a extends o.Tile{constructor(t,e,i,o){super(t,i,o),this.draw=t=>{s.Game.drawTile(13,this.skin,1,1,this.x,this.y,1,1,this.room.shadeColor,this.shadeAmount())},this.onCollide=t=>{},this.game=e}}e.Trapdoor=a},3164:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.PawnStatue=void 0;const s=i(606),o=i(7851),a=i(606),r=i(4083),n=i(1236),h=i(9467);class l extends s.Entity{constructor(t,e,i,s){super(t,e,i,s),this.draw=t=>{this.dead||(o.Game.ctx.save(),o.Game.ctx.globalAlpha=this.alpha,this.dead||(this.hasShadow&&this.drawShadow(t),this.updateDrawXY(t),o.Game.drawObj(this.tileX,this.tileY,1,2,this.x-this.drawX,this.y-this.drawYOffset-this.drawY,1,2,this.room.shadeColor,this.shadeAmount())),o.Game.ctx.restore())},this.drawTopLayer=t=>{this.drawableY=this.y},this.room=t,this.health=1,this.tileX=6,this.tileY=4,this.hasShadow=!0,this.pushable=!0,this.name="pawnStatue",this.imageParticleX=3,this.imageParticleY=25,h.Random.rand()<.1?this.drops.push(new r.WeaponFragments(this.room,this.x,this.y)):this.drops.push(new n.Coin(this.room,this.x,this.y))}get type(){return a.EntityType.PROP}}e.PawnStatue=l},3172:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.GenerationVisualizer=void 0;const s=i(7851),o=i(6291);e.GenerationVisualizer=class{constructor(t){this.game=t,this.debugMode=document.cookie.includes("showgeneration=true"),this.animationConfig={partitionSplitDelay:this.debugMode?10:0,pathfindingDelay:this.debugMode?100:0,largeStepDelay:this.debugMode?100:0,animationConstant:1,enabled:this.debugMode},this.visualizationState={currentStep:"initializing",progress:0,partitions:[],centerX:0,centerY:0}}updateAnimationConfig(t){this.animationConfig={...this.animationConfig,...t}}setVisualizationState(t,e,i,s="generating",o=0){this.visualizationState={currentStep:s,progress:o,partitions:t,centerX:e,centerY:i}}draw(t){s.Game.ctx.fillStyle="rgba(0, 0, 0, 1)",s.Game.ctx.fillRect(0,0,o.GameConstants.WIDTH,o.GameConstants.HEIGHT),this.debugMode?this.drawGenerationProgress(t):this.drawSimpleLoadingScreen()}drawGenerationProgress(t){this.visualizationState.partitions.length>0&&(this.visualizationState.partitions.forEach(e=>{this.drawPartition(e,t,this.visualizationState.centerX,this.visualizationState.centerY)}),this.drawProgressInfo())}drawSimpleLoadingScreen(){this.game.drawTextScreen("generating level")}drawPartition(t,e,i,a){s.Game.ctx.fillStyle=t.fillStyle,s.Game.ctx.fillRect(Math.round(o.GameConstants.WIDTH/2+t.x-i),Math.round(o.GameConstants.HEIGHT/2+t.y-a),t.w,t.h),this.drawPartitionConnections(t,i,a),this.debugMode&&this.drawPartitionInfo(t,i,a)}drawPartitionConnections(t,e,i){s.Game.ctx.fillStyle="white";for(let a of t.connections)s.Game.ctx.fillRect(Math.round(o.GameConstants.WIDTH/2+a.x-e),Math.round(o.GameConstants.HEIGHT/2+a.y-i),1,1)}drawPartitionInfo(t,e,i){const a=Math.round(o.GameConstants.WIDTH/2+t.x-e),r=Math.round(o.GameConstants.HEIGHT/2+t.y-i);s.Game.ctx.fillStyle="yellow",s.Game.ctx.font="8px Arial",s.Game.ctx.fillText(`${t.type}`,a+2,r+10),s.Game.ctx.fillText(`D:${t.distance}`,a+2,r+20)}drawProgressInfo(){s.Game.ctx.fillStyle="rgba(0, 0, 0, 0.7)",s.Game.ctx.fillRect(10,10,200,60),s.Game.ctx.fillStyle="white",s.Game.ctx.font="12px Arial",s.Game.ctx.fillText(`Step: ${this.visualizationState.currentStep}`,20,30),s.Game.ctx.fillText(`Partitions: ${this.visualizationState.partitions.length}`,20,45),s.Game.ctx.fillText(`Progress: ${Math.round(100*this.visualizationState.progress)}%`,20,60)}async createAnimationDelay(t){if(!this.animationConfig.enabled)return Promise.resolve();let e=0;switch(t){case"partition":e=this.animationConfig.animationConstant*this.animationConfig.partitionSplitDelay;break;case"pathfinding":e=this.animationConfig.animationConstant*this.animationConfig.pathfindingDelay;break;case"large":e=this.animationConfig.animationConstant*this.animationConfig.largeStepDelay}return new Promise(t=>setTimeout(t,e))}updatePartitionStyles(t){const e=[...t].sort((t,e)=>t.area()-e.area());if(0===e.length)return;const i=e[0].area(),s=e[e.length-1].area();t.forEach(t=>{if("START"===t.type)t.fillStyle="rgb(0, 255, 0)";else if("BOSS"===t.type)t.fillStyle="rgb(255, 0, 0)";else if("DOWNLADDER"===t.type)t.fillStyle="blue";else if("ROPEHOLE"===t.type)t.fillStyle="purple";else{const e=.3+.7*(s>i?(t.area()-i)/(s-i):0);t.fillStyle=`rgba(128, 128, 128, ${e})`}})}visualizePartitionsInConsole(t,e,i){if(!this.debugMode)return;const s=Array.from({length:i},()=>Array(e).fill(" . ")),o=(t.length-1).toString().length;t.forEach((t,a)=>{const r=a.toString().padStart(o," ");for(let o=t.x;o<t.x+t.w;o++)for(let a=t.y;a<t.y+t.h;a++)o>=0&&o<e&&a>=0&&a<i&&(s[a][o]=` ${r} `)}),console.log("Partition Layout:"),console.log("   "+[...Array(e)].map((t,e)=>e%10).join("  ")+" X"),s.forEach((t,e)=>{const i=e.toString().padStart(2," ");console.log(`${i} ${t.join("")}`)}),console.log("Y")}logGenerationStep(t,e){if(!this.debugMode)return;const i=e?`${t}: ${e}`:t;console.log(`[GenerationVisualizer] ${i}`),this.game&&this.game.pushMessage&&this.game.pushMessage(i)}createVisualEffect(t,e){if(this.debugMode)switch(t){case"partition_split":if(e){const t=e.fillStyle;e.fillStyle="yellow",setTimeout(()=>{e.fillStyle=t},200)}break;case"room_connected":e&&(e.fillStyle="lightgreen");break;case"boss_found":e&&(e.fillStyle="rgb(255, 0, 0)"),this.logGenerationStep("Boss room found!");break;case"generation_complete":this.logGenerationStep("Generation complete!")}}updateProgress(t,e){this.visualizationState.currentStep=t,this.visualizationState.progress=Math.max(0,Math.min(1,e)),this.logGenerationStep(t,`${Math.round(100*e)}%`)}reset(){this.visualizationState={currentStep:"initializing",progress:0,partitions:[],centerX:0,centerY:0}}getAnimationConfig(){return{...this.animationConfig}}getVisualizationState(){return{...this.visualizationState}}}},3175:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.ArmoredSkullEnemy=void 0;const s=i(7851),o=i(7455),a=i(1887),r=i(6986),n=i(7366);class h extends r.Enemy{constructor(t,e,i,r,h){super(t,e,i,r),this.REGEN_TICKS=5,this.hit=()=>this.damage,this.hurt=(t,e,i="none")=>{this.handleEnemyCase(t);let s=!1,o=0;this.shielded&&(o=this.shield.health,o>0&&this.shield.hurt(e)),this.ticksSinceFirstHit=0,2==this.health&&(this.unconscious=!1),this.health-=e,this.maxHealth-=o,this.startHurting(),this.healthBar.hurt(),this.createDamageNumber(e,i),this.playHitSound(),2===this.health&&n.Sound.playParry(),1===this.health?(this.unconscious=!0,a.ImageParticle.spawnCluster(this.room,this.x+.5,this.y+.5,3,28)):2===this.health?a.ImageParticle.spawnCluster(this.room,this.x+.5,this.y+.5,6,26):this.healthBar.hurt(),this.health<=0?(a.ImageParticle.spawnCluster(this.room,this.x+.5,this.y+.5,0,24),this.kill()):this.hurtCallback()},this.behavior=()=>{if(this.lastX=this.x,this.lastY=this.y,!this.dead){if(this.skipNextTurns>0)return this.skipNextTurns--,void this.ticks++;if(this.health<=1)return this.unconscious=!0,this.ticksSinceFirstHit++,this.ticksSinceFirstHit>=this.REGEN_TICKS&&(this.healthBar.hurt(),this.health=2,this.unconscious=!1),void this.ticks++;if(this.ticks++,this.seenPlayer){if(this.seenPlayer){if(this.room.playerTicked===this.targetPlayer){this.alertTicks=Math.max(0,this.alertTicks-1);let t=this.x,e=this.y,i=Array();for(const t of this.room.entities)t!==this&&i.push({x:t.x,y:t.y});for(let t=this.x-1;t<=this.x+1;t++)for(let e=this.y-1;e<=this.y+1;e++)this.room.roomArray[t][e]instanceof o.SpikeTrap&&this.room.roomArray[t][e].on&&i.push({x:t,y:e});const a=this.searchPathLocalized(this.targetPlayer,i);if(a.length>0){let i=a[0].pos.x,o=a[0].pos.y,r=this.direction,n=this.targetPlayer;if(this.facePlayer(n),i>t?this.direction=s.Direction.RIGHT:i<t?this.direction=s.Direction.LEFT:o>e?this.direction=s.Direction.DOWN:o<e&&(this.direction=s.Direction.UP),r==this.direction){let a=!1;for(const t in this.game.players)this.game.rooms[this.game.players[t].levelID]===this.room&&this.game.players[t].x===i&&this.game.players[t].y===o&&(this.game.players[t].hurt(this.hit(),this.name),this.drawX=.5*(this.x-this.game.players[t].x),this.drawY=.5*(this.y-this.game.players[t].y),this.game.players[t]===this.game.players[this.game.localPlayerID]&&this.game.shakeScreen(10*this.drawX,10*this.drawY));a||(this.tryMove(i,o),this.setDrawXY(t,e),this.x>t?this.direction=s.Direction.RIGHT:this.x<t?this.direction=s.Direction.LEFT:this.y>e?this.direction=s.Direction.DOWN:this.y<e&&(this.direction=s.Direction.UP))}}this.direction==s.Direction.LEFT&&(i.push({x:this.x,y:this.y+1}),i.push({x:this.x,y:this.y-1})),this.direction==s.Direction.RIGHT&&(i.push({x:this.x,y:this.y+1}),i.push({x:this.x,y:this.y-1})),this.direction==s.Direction.DOWN&&(i.push({x:this.x+1,y:this.y}),i.push({x:this.x-1,y:this.y})),this.direction==s.Direction.UP&&(i.push({x:this.x+1,y:this.y}),i.push({x:this.x-1,y:this.y})),this.makeHitWarnings()}let t=-1!==Object.values(this.game.offlinePlayers).indexOf(this.targetPlayer);if(!this.aggro||t){let e=this.nearestPlayer();if(!1!==e){let[i,s]=e;i<=4&&(t||i<this.playerDistance(this.targetPlayer))&&s!==this.targetPlayer&&(this.targetPlayer=s,this.facePlayer(s),s===this.game.players[this.game.localPlayerID]&&(this.alertTicks=1),this.makeHitWarnings())}}}}else this.lookForPlayer()}},this.draw=t=>{this.dead||(s.Game.ctx.save(),s.Game.ctx.globalAlpha=this.alpha,this.dead||(this.updateDrawXY(t),this.tileX=27,this.tileY=16,this.health<=2&&(this.tileX=5,this.tileY=8),(this.health<=1||this.dying)&&(this.tileX=3,this.tileY=0,this.ticksSinceFirstHit>=3&&(this.flashingFrame+=.1*t,Math.floor(this.flashingFrame)%2==0&&(this.tileX=2))),this.frame+=.1*t,this.frame>=4&&(this.frame=0),this.hasShadow&&this.drawShadow(t),s.Game.drawMob(this.tileX+(this.tileX%5&&!this.unconscious&&!this.dying?Math.floor(this.frame):0),this.tileY+2*this.direction,1,2,this.x-this.drawX,this.y-this.drawYOffset-this.drawY-this.jumpY,1,2,this.softShadeColor,this.shadeAmount(),void 0,this.outlineColor(),this.outlineOpacity())),this.cloned||(this.seenPlayer||this.drawSleepingZs(t),this.alertTicks>0&&this.drawExclamation(t)),s.Game.ctx.restore())},this.cloned||(this.ticks=0,this.frame=0,this.health=3,this.maxHealth=3,this.defaultMaxHealth=3,this.tileX=17,this.tileY=16,this.seenPlayer=!1,this.aggro=!1,this.ticksSinceFirstHit=0,this.flashingFrame=0,this.deathParticleColor="#ffffff",this.name="armored skeleton",this.forwardOnlyAttack=!0,this.armored=!0,h&&(this.drop=h),this.getDrop(["weapon","consumable","tool","coin"]))}}e.ArmoredSkullEnemy=h,h.difficulty=2,h.tileX=5,h.tileY=8},3180:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.ZombieEnemy=void 0;const s=i(7851),o=i(7455),a=i(6986);class r extends a.Enemy{constructor(t,e,i,a,r){super(t,e,i,a),this.hit=()=>this.damage,this.behavior=()=>{if(this.lastX=this.x,this.lastY=this.y,!this.dead){if(this.handleSkipTurns())return;if(this.ticks++,this.seenPlayer){if(this.seenPlayer){if(this.room.playerTicked===this.targetPlayer){this.alertTicks=Math.max(0,this.alertTicks-1);let t=this.x,e=this.y,i=Array();for(const t of this.room.entities)t!==this&&i.push({x:t.x,y:t.y});for(let t=this.x-1;t<=this.x+1;t++)for(let e=this.y-1;e<=this.y+1;e++)this.room.roomArray[t][e]instanceof o.SpikeTrap&&this.room.roomArray[t][e].on&&i.push({x:t,y:e});const a=this.searchPathLocalized(this.targetPlayer,i);if(a.length>0){let i=a[0].pos.x,o=a[0].pos.y,r=this.direction,n=this.targetPlayer;if(this.facePlayer(n),i>t?this.direction=s.Direction.RIGHT:i<t?this.direction=s.Direction.LEFT:o>e?this.direction=s.Direction.DOWN:o<e&&(this.direction=s.Direction.UP),r==this.direction){let a=!1;for(const t in this.game.players)this.game.rooms[this.game.players[t].levelID]===this.room&&this.game.players[t].x===i&&this.game.players[t].y===o&&(this.game.players[t].hurt(this.hit(),this.name),this.drawX=.5*(this.x-this.game.players[t].x),this.drawY=.5*(this.y-this.game.players[t].y),this.game.players[t]===this.game.players[this.game.localPlayerID]&&this.game.shakeScreen(10*this.drawX,10*this.drawY));a||(this.tryMove(i,o),this.setDrawXY(t,e),this.x>t?this.direction=s.Direction.RIGHT:this.x<t?this.direction=s.Direction.LEFT:this.y>e?this.direction=s.Direction.DOWN:this.y<e&&(this.direction=s.Direction.UP))}}this.direction==s.Direction.LEFT&&(i.push({x:this.x,y:this.y+1}),i.push({x:this.x,y:this.y-1})),this.direction==s.Direction.RIGHT&&(i.push({x:this.x,y:this.y+1}),i.push({x:this.x,y:this.y-1})),this.direction==s.Direction.DOWN&&(i.push({x:this.x+1,y:this.y}),i.push({x:this.x-1,y:this.y})),this.direction==s.Direction.UP&&(i.push({x:this.x+1,y:this.y}),i.push({x:this.x-1,y:this.y})),this.makeHitWarnings()}let t=-1!==Object.values(this.game.offlinePlayers).indexOf(this.targetPlayer);if(!this.aggro||t){let e=this.nearestPlayer();if(!1!==e){let[i,s]=e;i<=4&&(t||i<this.playerDistance(this.targetPlayer))&&s!==this.targetPlayer&&(this.targetPlayer=s,this.facePlayer(s),s===this.game.players[this.game.localPlayerID]&&(this.alertTicks=1),this.makeHitWarnings())}}}}else this.lookForPlayer()}},this.draw=t=>{this.dead||(s.Game.ctx.globalAlpha=this.alpha,this.updateDrawXY(t),this.frame+=.1*t,this.frame>=4&&(this.frame=0),this.hasShadow&&this.drawShadow(t),s.Game.drawMob(this.tileX+Math.floor(this.frame),this.tileY+2*this.direction,1,2,this.x-this.drawX,this.y-this.drawYOffset-this.drawY-this.jumpY,1,2,this.softShadeColor,this.shadeAmount(),void 0,this.outlineColor(),this.outlineOpacity()),this.cloned||(this.seenPlayer||this.drawSleepingZs(t),this.alertTicks>0&&this.drawExclamation(t)),s.Game.ctx.globalAlpha=1)},this.ticks=0,this.frame=0,this.health=1,this.maxHealth=1,this.defaultMaxHealth=1,this.tileX=17,this.tileY=8,this.seenPlayer=!1,this.aggro=!1,this.dir=s.Direction.DOWN,this.name="zombie",this.forwardOnlyAttack=!0,this.jumpHeight=.35,r&&(this.drop=r),this.getDrop(["consumable","tool","coin"])}}e.ZombieEnemy=r,r.difficulty=1,r.tileX=17,r.tileY=8},3201:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Barrel=void 0;const s=i(606),o=i(7851),a=i(606);class r extends s.Entity{constructor(t,e,i,s){super(t,e,i,s),this.draw=t=>{this.dead||(o.Game.ctx.save(),o.Game.ctx.globalAlpha=this.alpha,this.dead||(this.hasShadow&&this.drawShadow(t),this.updateDrawXY(t),o.Game.drawObj(this.tileX,this.tileY,1,2,this.x-this.drawX,this.y-this.drawYOffset-this.drawY,1,2,this.room.shadeColor,this.shadeAmount())),o.Game.ctx.restore())},this.drawTopLayer=t=>{this.drawableY=this.y},this.room=t,this.health=1,this.tileX=1,this.tileY=0,this.hasShadow=!0,this.pushable=!0,this.name="barrel",this.imageParticleX=3,this.imageParticleY=25}get type(){return a.EntityType.PROP}}e.Barrel=r},3202:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.DarkCrate=void 0;const s=i(606),o=i(7851),a=i(606);class r extends s.Entity{constructor(t,e,i,s){super(t,e,i,s),this.draw=t=>{this.dead||(o.Game.ctx.save(),o.Game.ctx.globalAlpha=this.alpha,this.dead||(this.hasShadow&&this.drawShadow(t),this.updateDrawXY(t),o.Game.drawObj(this.tileX,this.tileY,1,2,this.x-this.drawX,this.y-this.drawYOffset-this.drawY,1,2,this.room.shadeColor,this.shadeAmount())),o.Game.ctx.restore())},this.drawTopLayer=t=>{this.drawableY=this.y},this.room=t,this.health=1,this.maxHealth=1,this.tileX=6,this.tileY=6,this.hasShadow=!0,this.pushable=!0,this.name="dark crate",this.imageParticleX=3,this.imageParticleY=26}get type(){return a.EntityType.PROP}}e.DarkCrate=r},3263:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.ObsidianBlock=void 0;const s=i(7851),o=i(606),a=i(7366),r=i(7172);class n extends r.Resource{constructor(t,e,i,o){super(t,e,i,o),this.draw=t=>{this.dead||(s.Game.ctx.save(),s.Game.ctx.globalAlpha=this.alpha,this.dead||(this.updateDrawXY(t),this.hasShadow&&this.drawShadow(t),s.Game.drawObj(this.tileX,this.tileY,2,2,this.x-this.drawX-.5,this.y-this.drawYOffset-this.drawY,2,2,this.room.shadeColor,this.shadeAmount())),s.Game.ctx.restore())},this.drawTopLayer=t=>{this.drawableY=this.y},this.room=t,this.health=1,this.tileX=18,this.tileY=6,this.hasShadow=!0,this.chainPushable=!1,this.name="obsidian block",this.imageParticleX=6,this.imageParticleY=24,this.opaque=!0,this.hitSound=a.Sound.breakRock,this.extendShadow=!0,this.shadowOpacity=.5}get type(){return o.EntityType.PROP}}e.ObsidianBlock=n},3296:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.PngPartitionGenerator=void 0;const s=i(7053),o=i(4118),a=i(9467),r=i(7851),n={"rgb(0, 255, 0)":o.RoomType.START,"rgb(255, 0, 0)":o.RoomType.BOSS,"rgb(0, 0, 255)":o.RoomType.DOWNLADDER,"rgb(0, 255, 255)":o.RoomType.UPLADDER,"rgb(255, 255, 0)":o.RoomType.TREASURE,"rgb(255, 0, 255)":o.RoomType.SHOP,"rgb(128, 0, 128)":o.RoomType.FOUNTAIN,"rgb(139, 69, 19)":o.RoomType.COFFIN,"rgb(255, 165, 0)":o.RoomType.KEYROOM,"rgb(64, 64, 64)":o.RoomType.PUZZLE,"rgb(0, 0, 0)":o.RoomType.CHESSBOARD,"rgb(192, 192, 192)":o.RoomType.MAZE,"rgb(255, 192, 203)":o.RoomType.SPAWNER,"rgb(34, 139, 34)":o.RoomType.GRASS,"rgb(101, 67, 33)":o.RoomType.CAVE,"rgb(85, 107, 47)":o.RoomType.GRAVEYARD,"rgb(46, 125, 50)":o.RoomType.FOREST,"rgb(160, 160, 160)":o.RoomType.CORRIDOR,"rgb(255, 87, 34)":o.RoomType.SPIKECORRIDOR,"rgb(121, 85, 72)":o.RoomType.BIGCAVE,"rgb(78, 52, 46)":o.RoomType.ROPECAVE,"rgb(156, 102, 68)":o.RoomType.ROPEHOLE,"rgb(141, 110, 99)":o.RoomType.ROPEUP,"rgb(173, 216, 230)":o.RoomType.TUTORIAL,"rgb(250, 250, 250)":o.RoomType.BIGDUNGEON,"rgb(255, 255, 255)":o.RoomType.DUNGEON};e.PngPartitionGenerator=class{async generatePartitionsFromPng(t,e,i,o=!1){try{const i=await this.loadImageData(t),a=this.findRectangles(i),r=this.createPartitionsFromRectangles(a,o);if(0===r.length)return console.error(" No partitions created from image!"),[];const n=new s.PartialLevel;return n.partitions=r,await this.processPartitionsForGameplay(n,e,o),console.log(` Final processed partitions: ${n.partitions.length}`),n.partitions}catch(t){return console.error(" Error in PNG partition generation:",t),console.error("Stack trace:",t.stack),[]}}loadImageData(t){return new Promise((e,i)=>{const s=new Image;s.crossOrigin="Anonymous",s.onload=()=>{try{const t=document.createElement("canvas");t.width=s.width,t.height=s.height;const i=t.getContext("2d");if(!i)throw new Error("Could not get canvas context");i.drawImage(s,0,0);const o=i.getImageData(0,0,s.width,s.height);e(o)}catch(t){console.error("   Error processing image:",t),i(t)}},s.onerror=e=>{console.error(`   Failed to load image: ${e}`),i(new Error(`Failed to load image at ${t}: ${e}`))},s.src=t})}findRectangles(t){const{width:e,height:i,data:s}=t,o=new Array(e*i).fill(!1),a=[];for(let t=0;t<i;t++)for(let r=0;r<e;r++){const n=t*e+r;if(o[n])continue;const h=4*n;if(0===s[h+3])continue;const l=`rgb(${s[h]}, ${s[h+1]}, ${s[h+2]})`;let c=1;for(;r+c<e&&!o[t*e+(r+c)]&&this.isSameColor(s,h,4*(t*e+r+c));)c++;let d=1;for(;t+d<i;){let i=!0;for(let a=0;a<c;a++)if(o[(t+d)*e+(r+a)]||!this.isSameColor(s,h,4*((t+d)*e+r+a))){i=!1;break}if(!i)break;d++}for(let i=0;i<d;i++)for(let s=0;s<c;s++)o[(t+i)*e+(r+s)]=!0;const m={x:r,y:t,w:c,h:d,color:l};a.push(m)}return a}isSameColor(t,e,i){return t[e]===t[i]&&t[e+1]===t[i+1]&&t[e+2]===t[i+2]&&t[e+3]===t[i+3]}createPartitionsFromRectangles(t,e){return 0===t.length?(console.warn("    No rectangles to create partitions from!"),[]):t.map((t,i)=>{const a=new s.Partition(t.x,t.y,t.w,t.h,t.color);if(e){const e=this.getCaveRoomTypeFromColor(t.color);a.type=e}else{const e=n[t.color];a.type=e||o.RoomType.DUNGEON}return a})}getCaveRoomTypeFromColor(t){switch(t){case"rgb(0, 255, 0)":return o.RoomType.ROPECAVE;case"rgb(0, 255, 255)":return o.RoomType.UPLADDER;case"rgb(255, 255, 0)":return o.RoomType.TREASURE;case"rgb(255, 0, 255)":return o.RoomType.SHOP;default:return o.RoomType.CAVE}}async processPartitionsForGameplay(t,e,i){0!==t.partitions.length?i?await this.processCavePartitions(t,e):await this.processMainPathPartitions(t,e):console.error("   No partitions to process!")}async processCavePartitions(t,e){const i={};t.partitions.forEach(t=>{i[t.type]=(i[t.type]||0)+1});let s=t.partitions.find(t=>t.type===o.RoomType.ROPECAVE);if(!s&&t.partitions.length>0&&(t.partitions.sort((t,e)=>t.area()-e.area()),s=t.partitions[0],s.type=o.RoomType.ROPECAVE,s.fillStyle="rgb(0, 255, 0)"),t.partitions.forEach(t=>{t!==s&&t.type===o.RoomType.DUNGEON&&(t.type=o.RoomType.CAVE)}),this.updatePartitionVisualStyles(t.partitions),s){const e=t.partitions.indexOf(s);e>0&&(t.partitions.splice(e,1),t.partitions.unshift(s))}s&&await this.connectCavePartitions(t,s),t.partitions.length>0&&await this.addLoopConnections(t),t.partitions.length>0&&s&&(await this.calculateDistances(t,s),await this.addSpecialRooms(t))}async processMainPathPartitions(t,e){const i={};t.partitions.forEach(t=>{i[t.type]=(i[t.type]||0)+1});let s=t.partitions.find(t=>t.type===o.RoomType.START),a=t.partitions.find(t=>t.type===o.RoomType.BOSS);if(!s&&t.partitions.length>0&&(t.partitions.sort((t,e)=>t.area()-e.area()),s=t.partitions[0],s.type=o.RoomType.START,s.fillStyle="rgb(0, 255, 0)"),!a&&t.partitions.length>1&&(t.partitions.sort((t,e)=>t.area()-e.area()),a=t.partitions[t.partitions.length-1],a.type===o.RoomType.DUNGEON?(a.type=o.RoomType.BOSS,a.fillStyle="red"):a=null),this.updatePartitionVisualStyles(t.partitions),s){const e=t.partitions.indexOf(s);e>0&&(t.partitions.splice(e,1),t.partitions.unshift(s))}s?await this.connectPartitions(t,s):console.error("   No spawn room found, cannot connect partitions!"),t.partitions.length>0&&await this.addLoopConnections(t),!t.partitions.some(t=>t.type===o.RoomType.DOWNLADDER)&&t.partitions.length>0&&await this.addStairRoom(t,e),t.partitions.length>0&&s&&(await this.calculateDistances(t,s),await this.addSpecialRooms(t),t.partitions.forEach(t=>{}))}updatePartitionVisualStyles(t){for(const e of t){switch(e.fillStyle,e.type){case o.RoomType.START:e.fillStyle="rgb(0, 255, 0)";break;case o.RoomType.BOSS:e.fillStyle="red";break;case o.RoomType.DOWNLADDER:case o.RoomType.UPLADDER:e.fillStyle="blue";break;case o.RoomType.TREASURE:e.fillStyle="rgb(255, 215, 0)";break;case o.RoomType.SHOP:e.fillStyle="rgb(255, 0, 255)";break;case o.RoomType.FOUNTAIN:e.fillStyle="rgb(128, 0, 128)";break;case o.RoomType.CAVE:case o.RoomType.BIGCAVE:e.fillStyle="rgb(101, 67, 33)";break;default:e.fillStyle="white"}e.fillStyle}}async connectPartitions(t,e){let i=[e],o=[e];for(;o.length>0;){let e=o[0];o.splice(0,1);const a=t.partitions.filter(t=>t!==e&&-1===i.indexOf(t)&&this.arePartitionsAdjacent(e,t));for(let t=0;t<a.length;t++){const r=a[t],n=this.arePartitionsAdjacent(e,r);if(n){const t=n.connectionPoint;e.connections.push(new s.PartitionConnection(t.x,t.y,r)),r.connections.push(new s.PartitionConnection(t.x,t.y,e)),e.setOpenWall(new s.PartitionConnection(t.x,t.y,r)),r.setOpenWall(new s.PartitionConnection(t.x,t.y,e)),o.push(r),i.push(r)}}}const a=t.partitions.filter(t=>0===t.connections.length);a.length>0&&a.forEach(e=>{this.connectIsolatedRoom(e,t.partitions.filter(t=>t.connections.length>0))})}connectIsolatedRoom(t,e){let i=null,o=1/0;for(const s of e){const e=Math.abs(t.x-s.x)+Math.abs(t.y-s.y);e<o&&(o=e,i=s)}if(i){const e=Math.floor((t.x+i.x)/2),o=Math.floor((t.y+i.y)/2);t.connections.push(new s.PartitionConnection(e,o,i)),i.connections.push(new s.PartitionConnection(e,o,t))}}async connectCavePartitions(t,e){let i=[e],o=[e];const r=t.partitions.length;for(;o.length>0&&i.length<r;){let e=o[0];o.splice(0,1);const n=t.partitions.filter(t=>t!==e&&-1===i.indexOf(t)&&this.arePartitionsAdjacent(e,t)),h=Math.min(n.length,Math.floor(2*a.Random.rand()+1));for(let t=0;t<h&&i.length<r;t++){const a=n[t],r=this.arePartitionsAdjacent(e,a);if(r){const t=r.connectionPoint;e.connections.push(new s.PartitionConnection(t.x,t.y,a)),a.connections.push(new s.PartitionConnection(t.x,t.y,e)),o.push(a),i.push(a)}}}t.partitions=t.partitions.filter(t=>t.connections.length>0)}arePartitionsAdjacent(t,e){if(t.y<e.y+e.h&&e.y<t.y+t.h){if(t.x+t.w===e.x||t.x+t.w===e.x-1){const i=Math.max(t.y,e.y),s=Math.min(t.y+t.h,e.y+e.h),o=Math.floor(i+(s-i)/2);return{direction:"horizontal",connectionPoint:{x:t.x+t.w,y:o}}}if(e.x+e.w===t.x||e.x+e.w===t.x-1){const i=Math.max(t.y,e.y),s=Math.min(t.y+t.h,e.y+e.h),o=Math.floor(i+(s-i)/2);return{direction:"horizontal",connectionPoint:{x:e.x+e.w,y:o}}}}if(t.x<e.x+e.w&&e.x<t.x+t.w){if(t.y+t.h===e.y||t.y+t.h===e.y-1){const i=Math.max(t.x,e.x),s=Math.min(t.x+t.w,e.x+e.w);return{direction:"vertical",connectionPoint:{x:Math.floor(i+(s-i)/2),y:t.y+t.h}}}if(e.y+e.h===t.y||e.y+e.h===t.y-1){const i=Math.max(t.x,e.x),s=Math.min(t.x+t.w,e.x+e.w);return{direction:"vertical",connectionPoint:{x:Math.floor(i+(s-i)/2),y:e.y+e.h}}}}return null}async addLoopConnections(t){if(0===t.partitions.length)return;const e=new Map;t.partitions.forEach(i=>{const s=t.partitions.filter(t=>t!==i&&this.arePartitionsAdjacent(i,t));e.set(i,s)});const i=Math.min(4,Math.floor(t.partitions.length/2));for(let o=0;o<i;o++){const i=Math.floor(a.Random.rand()*t.partitions.length),o=t.partitions[i],r=(e.get(o)||[]).filter(t=>!o.connections.some(e=>e.other===t));if(r.length>0){const t=r[Math.floor(a.Random.rand()*r.length)],e=this.arePartitionsAdjacent(o,t);if(e){const i=e.connectionPoint;o.connections.push(new s.PartitionConnection(i.x,i.y,t)),t.connections.push(new s.PartitionConnection(i.x,i.y,o)),o.setOpenWall(new s.PartitionConnection(i.x,i.y,t)),t.setOpenWall(new s.PartitionConnection(i.x,i.y,o))}}}}async addStairRoom(t,e){const i=t.partitions.some(t=>t.type===o.RoomType.BOSS),n=t.partitions.some(t=>t.type===o.RoomType.DOWNLADDER);if(!i||n)return;let h=t.partitions.find(t=>t.type===o.RoomType.BOSS),l=!1;for(let e=0;e<5;e++){const e=r.Game.rand(h.x-1,h.x+h.w-2,a.Random.rand),i=h.y-5-1;let n=new s.Partition(e,i,5,5,"white");if(n.type=o.RoomType.DOWNLADDER,n.fillStyle="blue",!t.partitions.some(t=>t.overlaps(n))){l=!0,t.partitions.push(n);const e=n.x+1,i=n.y+5;n.connections.push(new s.PartitionConnection(e,i,h)),h.connections.push(new s.PartitionConnection(e,i,n)),n.setOpenWall(new s.PartitionConnection(e,i,h)),h.setOpenWall(new s.PartitionConnection(e,i,n));break}}}async calculateDistances(t,e){let i=[e],s=[];for(e.distance=0;i.length>0;){let t=i[0];i.splice(0,1),s.push(t);for(let e of t.connections){let o=e.other;const a=t.distance+1;a<o.distance&&(o.distance=a),-1===s.indexOf(o)&&i.push(o)}}}async addSpecialRooms(t){for(const e of t.partitions)e.type===o.RoomType.DUNGEON&&e.distance>4&&e.area()<=30&&a.Random.rand()<.1&&(e.type=o.RoomType.TREASURE)}static getColorGuide(){return`PNG Level Designer Color Guide:\n${Object.entries(n).map(([t,e])=>`${t} -> ${e}`).join("\n")}`}}},3345:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.GoldBar=void 0;const s=i(5366),o=i(7510),a=i(7366);class r extends s.Item{constructor(t,e,i){super(t,e,i),this.smith=t=>{t.inventory.subtractItem(this,1),t.inventory.addItem(new o.GoldRing(this.level,this.x,this.y)),this.level.game.pushMessage("You hammer the gold bar into a ring."),a.Sound.playSmith()},this.tileX=18,this.tileY=2,this.name=r.itemName,this.stackable=!0,this.description="A bar of gold. Hit it with a hammer to make a ring."}}e.GoldBar=r,r.itemName="gold bar"},3346:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.SpellbookPage=void 0;const s=i(7366),o=i(5180),a=i(8549),r=i(9467);class n extends o.Usable{constructor(t,e,i,o){super(t,e,i),this.onUse=t=>{t.health=Math.min(t.maxHealth,t.health+1),(t?.getRoom?t.getRoom():this.level.game.rooms[t.levelID])===this.level.game.room&&s.Sound.heal(),t.inventory.removeItem(this)},this.useOnOther=(t,e)=>{if(e instanceof a.Equippable&&e.durabilityMax-e.durability>=1&&"spellbook"===e.name){let i=Math.min(e.durabilityMax-e.durability,this.stackCount);e.durability+=i,this.stackCount-=i,e.broken=!1,this.level.game.pushMessage(`You feel your ${e.name}'s power return as you add ${i} pages to it.`),this.stackCount<=0&&t.inventory.removeItem(this)}},this.tileX=25,this.tileY=2,this.offsetY=-.3,this.name="spellbook pages",this.canUseOnOther=!0,this.stackable=!0,this.stackCount=o||Math.ceil(3*r.Random.rand()),this.description="Can be used to restore power to a depleted spellbook"}}e.SpellbookPage=n,n.itemName="weapon fragments"},3379:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.ZirconRing=void 0;const s=i(8549);class o extends s.Equippable{constructor(t,e,i){super(t,e,i),this.onEquip=()=>{this.wielder.magicDamageBonus=1,this.level.game.pushMessage("A magic boosting force surrounds you.")},this.onUnequip=()=>{this.wielder.magicDamageBonus=0,this.level.game.pushMessage("The magic boosting force fades away.")},this.onDrop=()=>{this.wielder.magicDamageBonus=0,this.equipped&&(this.level.game.pushMessage("The magic boosting force fades away."),this.equipped=!1)},this.tileX=13,this.tileY=2,this.name=o.itemName,this.stackable=!1,this.description="A ring of zircon"}}e.ZirconRing=o,o.itemName="zircon ring"},3384:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Floor=void 0;const s=i(7851),o=i(8132),a=i(9467);class r extends o.Tile{constructor(t,e,i){super(t,e,i),this.draw=t=>{s.Game.drawTile(this.variation,this.skin,1,1,this.x,this.y,1,1,this.room.shadeColor,this.shadeAmount())},this.variation=1,this.skin==o.SkinType.DUNGEON&&(this.variation=s.Game.randTable([1,1,1,1,1,1,8,8,8,9,10,10,10,10,10,12],a.Random.rand)),this.skin==o.SkinType.CAVE&&(this.variation=s.Game.randTable([1,1,1,1,1,1,8,8,8,9,10,10,10,10,10,12],a.Random.rand)),this.skin==o.SkinType.FOREST&&(this.variation=s.Game.randTable([1,1,1,1,1,1,8,8,8,9,10,10,10,10,10,12],a.Random.rand)),this.skin==o.SkinType.DESERT&&(this.variation=s.Game.randTable([1,1,1,1,1,1,8,8,8,9,10,10,10,10,10,12],a.Random.rand)),this.skin==o.SkinType.MAGMA_CAVE&&(this.variation=s.Game.randTable([1,1,1,1,1,1,8,8,8,9,10,10,10,10,10,12],a.Random.rand),8!==this.variation&&9!==this.variation&&10!==this.variation||(this.hasBloom=!0,this.bloomAlpha=1,this.bloomColor="#641900")),this.skin==o.SkinType.DARK_DUNGEON&&(this.variation=s.Game.randTable([1,1,1,1,1,1,1,1,1,1,8,9,10,12],a.Random.rand),a.Random.rand()<.2&&(this.hasBloom=!0,this.bloomAlpha=1,this.bloomColor="#306082"))}}e.Floor=r},3427:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Slingshot=void 0;const s=i(4052),o=i(1731);class a extends s.Weapon{constructor(t,e,i){super(t,e,i),this.weaponMove=(t,e)=>{let i=[t],s=[e],a=1,r=0;for(let o=0;o<5;o++)t===this.wielder.x&&(i.push(t),s.push(s[r]+(e-this.wielder.y))),e===this.wielder.y&&(i.push(i[r]+(t-this.wielder.x)),s.push(e)),r++;if(!this.game.rooms[this.wielder.levelID].tileInside(t,e)||this.game.rooms[this.wielder.levelID].roomArray[t][e].isSolid())return!0;let n=1;for(let t=0;t<5;t++)this.game.rooms[this.wielder.levelID].tileInside(i[n],s[n])&&!this.game.rooms[this.wielder.levelID].roomArray[i[n]][s[n]].isSolid()||(a=n),n++;let h=[],l=a+1,c=a+2,d=a+2;for(let o of this.game.rooms[this.wielder.levelID].entities)if(o.pushable){let r=2;if(o.pointIn(t,e))return!0;for(let t=0;t<15;t++)o.pointIn(i[r-1],s[r-1])&&a>=r&&(l=Math.min(l,r)),r++}else if(o.destroyable){o.pointIn(t,e)&&a>=1&&(c=1,h.push({enemy:o,dist:1}));let r=2;for(let t=0;t<15;t++)o.pointIn(i[r-1],s[r-1])&&a>=r&&(c=Math.min(c,r),h.push({enemy:o,dist:r})),r++}else{o.pointIn(t,e)&&a>=1&&(d=1);let r=2;for(let t=0;t<15;t++)o.pointIn(i[r-1],s[r-1])&&a>=r&&(d=Math.min(d,r)),r++}let m=t,u=e;if(d<c&&d<l)return!0;if(c<=l){h.length>0&&h.reduce((t,e)=>e.dist<t.dist?e:t).enemy.hurt(this.wielder,1),this.hitSound(),this.wielder.setHitXY(t,e),o.GenericParticle.shotgun(this.game.rooms[this.wielder.levelID],this.wielder.x+.5,this.wielder.y,m+.5,u,"black"),o.GenericParticle.shotgun(this.game.rooms[this.wielder.levelID],this.wielder.x+.5,this.wielder.y,m+.5,u,"#ffddff");let i=new o.GenericParticle(this.game.rooms[this.wielder.levelID],.5*(t+this.wielder.x)+.5,.5*(e+this.wielder.y),0,1,0,0,0,"white",0);return i.expirationTimer=10,this.game.rooms[this.wielder.levelID].particles.push(i),this.game.rooms[this.wielder.levelID].tick(this.wielder),this.shakeScreen(10*t,10*e),!1}return!0},this.tileX=26,this.tileY=0,this.name="Slingshot"}}e.Slingshot=a,a.itemName="slingshot"},3436:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.DownLadder=void 0;const s=i(7851),o=i(6291),a=i(6277),r=i(2502),n=i(1073),h=i(3067),l=i(8583),c=i(423);class d extends l.Passageway{constructor(t,e,i,l,d=!1,m=n.EnvType.DUNGEON,u=h.LockType.NONE,p,y){super(t,e,i,l),this.isSidePath=!1,this.getName=()=>this.isSidePath?"rope down":"staircase down",this.generate=async()=>{this.linkedRoom?console.log("LinkedRoom already exists:",this.linkedRoom):await this.sidePathManager.generateFor(this)},this.onCollide=t=>{let e=!0;for(const t in this.game.players){const i=this.game.players[t];(i.getRoom?i.getRoom():this.game.levels[i.depth].rooms[i.levelID])===this.room&&i.x===this.x&&i.y===this.y||(e=!1)}e?(r.globalEventBus.emit(a.EVENTS.LEVEL_GENERATION_STARTED,{}),this.generate().then(()=>{r.globalEventBus.emit(a.EVENTS.LEVEL_GENERATION_COMPLETED,{}),this.sidePathManager.switchToPathBeforeTransition(this);for(const t in this.game.players){const e=this.game.players[t];e.anchorOxygenLineToTile(this.room,this.x,this.y,{kind:"downLadder",angle:Math.PI/2}),e.getOxygenLine()?.update(!0),this.game.changeLevelThroughLadder(this.game.players[t],this)}})):t===this.game.players[this.game.localPlayerID]&&this.game.pushMessage("all players must be present")},this.draw=t=>{let e=4;this.isSidePath&&(e=16,this.lockable.isLocked()&&(e=17)),s.Game.drawTile(1,this.skin,1,1,this.x,this.y,1,1,this.room.shadeColor,this.shadeAmount()),s.Game.drawTile(e,0,1,1,this.x,this.y,1,1,this.room.shadeColor,this.shadeAmount())},this.drawAboveShading=t=>{this.lockable.update(t),this.lockable.drawIcon(this.x,this.y,t),this.updateFrame(t)},this.drawAbovePlayer=t=>{},this.linkedRoom=null,this.depth=t.depth,this.isSidePath=d,this.environment=m,this.opts=p,this.sidePathManager=new c.SidePathManager(e);const g=y?y.lockType:d&&!o.GameConstants.DEVELOPER_MODE?h.LockType.LOCKED:u;this.lockable=new h.Lockable(e,{lockType:g,keyID:y?.keyID,isTopDoor:!1}),this.addLightSource()}isLocked(){return this.lockable.isLocked()}}e.DownLadder=d},3446:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.XPPopup=void 0;const s=i(7851),o=i(6291),a=i(824);class r extends a.Particle{constructor(t,e,i,a){super(),this.alpha=.25,this.frame=0,this.xoffset=0,this.getXoffset=()=>{if(this.room.particles.length>0){let t=this.room.particles.filter(t=>t instanceof r);if(t.length%3==0)return.5;if(t.length%3==1)return 0;if(t.length%3==2)return.25}},this.drawTopLayer=t=>{if(s.Game.ctx.save(),this.dead)return void s.Game.ctx.restore();this.frame>15&&(this.alpha-=.005*t),this.y-=.03*t,this.frame+=t,s.Game.measureText(this.xp.toString()).width,this.alpha<=.002&&(this.alpha=0,this.dead=!0),s.Game.ctx.globalAlpha=this.alpha;const e=s.Game.measureText(`+${this.xp}xp`).width/2;s.Game.ctx.fillStyle=this.color,s.Game.fillText(`+${this.xp} xp`,(this.x+.4+this.xoffset)*o.GameConstants.TILESIZE-e,(this.y-.75)*o.GameConstants.TILESIZE),s.Game.ctx.globalAlpha=1,s.Game.ctx.restore()},this.room=t,this.xp=a,this.x=e,this.y=i,this.color="yellow",this.outlineColor=o.GameConstants.OUTLINE,this.xoffset=0}}e.XPPopup=r},3458:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Shadow=void 0;const s=i(7851),o=i(6291);e.Shadow=class{static draw(t,e,i=1,a=1,r=!1,n=.3){o.GameConstants.TILESIZE,s.Game.ctx.save(),s.Game.ctx.globalAlpha=n,i>1||a>1?s.Game.drawFX(30,3,2,2,t,e+.5,2,2,"black"):r?s.Game.drawFX(30,3,2,2,t-.5,e-.5,2,2,"black"):s.Game.drawFX(30,1,2,2,t-.5,e-.5,2,2,"black"),s.Game.ctx.restore()}}},3534:(t,e,i)=>{"use strict";e.v=void 0;const s=i(6199),o=i(7851),a=i(6291),r=i(824);class n extends r.Particle{constructor(t,e){super(),this.drawTopLayer=t=>{if(this.dead)return;const e=s.Utils.distance(this.x,this.y,this.room.game.players[this.room.game.localPlayerID].x,this.room.game.players[this.room.game.localPlayerID].y);this.frame+=t/10;const i=1*Math.sin(this.frame+e),r=1*Math.cos(this.frame+e);o.Game.ctx.fillStyle="#FFFF00",o.Game.ctx.fillRect((this.x+.5)*a.GameConstants.TILESIZE-1+Math.round(i),(this.y+.5)*a.GameConstants.TILESIZE-1+Math.round(r),2,2)},this.x=t,this.y=e-.25,this.dead=!1,this.frame=0}}e.v=n},3565:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.GoldenKey=void 0;const s=i(8549);class o extends s.Equippable{constructor(t,e,i){super(t,e,i),this.getDescription=()=>"GOLD KEY\nA heavy gold key.",this.tileX=6,this.tileY=0,this.name="goldenKey"}}e.GoldenKey=o,o.itemName="goldenKey"},3574:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.ReplayManager=void 0;const s=i(7851),o=i(6291),a=i(2502),r=i(6277),n=i(5095),h=i(9467);e.ReplayManager=class{constructor(){this.actions=[],this.startMs=0,this.recording=!1,this.replaying=!1,this.seed=void 0,this.timer=null,this.baseState=null}beginRecording(t,e){if(this.actions=[],this.startMs=Date.now(),this.recording=!0,this.replaying=!1,this.seed=t,e){const t=()=>{try{const t=e.players?.[e.localPlayerID];if(t&&e.room&&e.levelState===s.LevelState.IN_LEVEL&&Array.isArray(e.rooms)&&e.rooms.length>0)return void(this.baseState||(this.baseState=(0,n.createGameState)(e)))}catch{}setTimeout(t,16)};setTimeout(t,0)}}getStats(){return{count:this.actions.length,seed:this.seed,recording:this.recording,replaying:this.replaying}}isReplaying(){return this.replaying}isRecording(){return this.recording}clearRecording(){this.actions=[],this.seed=void 0,this.startMs=0,this.recording=!1,this.replaying=!1}stopRecording(){this.recording=!1}recordAction(t){this.recording&&!this.replaying&&this.actions.push({t:Date.now()-this.startMs,action:t})}replay(t,e=o.GameConstants.REPLAY_STEP_MS){if(this.replaying)return;this.replaying=!0,this.recording=!1;const i=this.actions.slice(),l=this.seed;if(0===i.length||void 0===l)return t.pushMessage("No actions recorded; replay aborted."),void(this.replaying=!1);t.pushMessage(`Replay starting with ${i.length} actions...`);const c=()=>{const s=t.players?.[t.localPlayerID];if(!s)return void setTimeout(c,16);let a=0;const r=()=>{if(a>=i.length)return this.replaying=!1,this.recording=!1,void t.pushMessage("Replay finished.");try{const t=i[a].action,e=s.x,o=s.y;let r;try{r=s.movement?.canMove?.()}catch{}const n=s.getRoom?.(),h=n?.turn;console.log("[replay] step begin",{index:a+1,total:i.length,type:t.type,before:{x:e,y:o},turn:h,canMove:r}),s.menu.open=!1,s.dead=!1,s.inventory.close(),s.actionProcessor.process(t);const l=s.x,c=s.y,d=e!==l||o!==c;console.log("[replay] step end",{index:a+1,type:t.type,after:{x:l,y:c},moved:d})}catch(t){}const n=Math.max(o.GameConstants.MOVEMENT_COOLDOWN+5,e),h=n;a<i.length-1&&Math.max(1,i[a+1].t-i[a].t);let l=Math.max(h,n);try{const t=s.getRoom?.();t&&void 0!==t.turn&&1===t.turn&&(l+=o.GameConstants.REPLAY_COMPUTER_TURN_DELAY)}catch{}console.log("[replay] schedule next",{index:a+1,recordedDelay:h,minDelay:n,nextDelay:l}),a++,this.timer&&window.clearTimeout(this.timer),this.timer=window.setTimeout(r,l)};r()};if(this.baseState)try{const e=JSON.parse(JSON.stringify(this.baseState)),i=Object.keys(t.players);return void(0,n.loadGameState)(t,i,e,!1).then(()=>{t.started=!0,t.startedFadeOut=!1,this.recording=!1;try{console.log("[replay] seed/state after load",{seed:t.levelgen?.seed,expectedSeed:e.seed,randomState:h.Random.state,expectedRandom:e.randomState})}catch{}c()}).catch(()=>{t.newGame(l),t.started=!0,t.startedFadeOut=!1,this.recording=!1;const e=()=>{t.levelState===s.LevelState.IN_LEVEL&&(a.globalEventBus.off(r.EVENTS.LEVEL_GENERATION_COMPLETED,e),c())};a.globalEventBus.on(r.EVENTS.LEVEL_GENERATION_COMPLETED,e),setTimeout(e,0)})}catch{}t.newGame(l),t.started=!0,t.startedFadeOut=!1,this.recording=!1;const d=()=>{t.levelState===s.LevelState.IN_LEVEL&&(a.globalEventBus.off(r.EVENTS.LEVEL_GENERATION_COMPLETED,d),c())};a.globalEventBus.on(r.EVENTS.LEVEL_GENERATION_COMPLETED,d),setTimeout(d,0)}}},3628:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Input=e.InputEnum=void 0;const s=i(6291),o=i(7851),a=i(8900),r=i(7851);var n;(n=e.InputEnum||(e.InputEnum={}))[n.I=0]="I",n[n.M=1]="M",n[n.M_UP=2]="M_UP",n[n.Q=3]="Q",n[n.LEFT=4]="LEFT",n[n.RIGHT=5]="RIGHT",n[n.UP=6]="UP",n[n.DOWN=7]="DOWN",n[n.SPACE=8]="SPACE",n[n.COMMA=9]="COMMA",n[n.PERIOD=10]="PERIOD",n[n.LEFT_CLICK=11]="LEFT_CLICK",n[n.RIGHT_CLICK=12]="RIGHT_CLICK",n[n.MOUSE_MOVE=13]="MOUSE_MOVE",n[n.NUMBER_1=14]="NUMBER_1",n[n.NUMBER_2=15]="NUMBER_2",n[n.NUMBER_3=16]="NUMBER_3",n[n.NUMBER_4=17]="NUMBER_4",n[n.NUMBER_5=18]="NUMBER_5",n[n.NUMBER_6=19]="NUMBER_6",n[n.NUMBER_7=20]="NUMBER_7",n[n.NUMBER_8=21]="NUMBER_8",n[n.NUMBER_9=22]="NUMBER_9",n[n.MINUS=23]="MINUS",n[n.EQUALS=24]="EQUALS",n[n.ESCAPE=25]="ESCAPE",n[n.F=26]="F",e.Input={_pressed:{},isTapHold:!1,tapStartTime:null,IS_TAP_HOLD_THRESH:300,keyDownListener:function(t){},iListener:function(){},mListener:function(){},mUpListener:function(){},qListener:function(){},leftListener:function(){},rightListener:function(){},upListener:function(){},downListener:function(){},aListener:function(){e.Input.leftListener()},dListener:function(){e.Input.rightListener()},wListener:function(){e.Input.upListener()},sListener:function(){e.Input.downListener()},spaceListener:function(){},leftSwipeListener:function(){},rightSwipeListener:function(){},upSwipeListener:function(){},downSwipeListener:function(){},tapListener:function(){},commaListener:function(){},periodListener:function(){},numKeyListener:function(t){},equalsListener:function(){},minusListener:function(){},escapeListener:function(){},fListener:function(){},wheelListener:function(t){},mouseLeftClickListeners:[],mouseRightClickListeners:[],mouseMoveListeners:[],mouseDownListeners:[],mouseUpListeners:[],touchStartListeners:[],touchEndListeners:[],mouseX:0,mouseY:0,mouseDown:!1,lastPressTime:0,lastPressKey:"",lastMouseDownTime:0,lastMouseDownX:0,lastMouseDownY:0,mouseDownHandled:!1,SPACE:"Space",LEFT:"ArrowLeft",UP:"ArrowUp",RIGHT:"ArrowRight",DOWN:"ArrowDown",W:"KeyW",A:"KeyA",S:"KeyS",D:"KeyD",M:"KeyM",N:"KeyN",I:"KeyI",Q:"KeyQ",NUMBER_1:"Digit1",NUMBER_2:"Digit2",NUMBER_3:"Digit3",NUMBER_4:"Digit4",NUMBER_5:"Digit5",NUMBER_6:"Digit6",NUMBER_7:"Digit7",NUMBER_8:"Digit8",NUMBER_9:"Digit9",COMMA:"Comma",PERIOD:"Period",MINUS:"Minus",EQUALS:"Equal",ESCAPE:"Escape",F:"KeyF",rawMouseX:0,rawMouseY:0,isDown:function(t){return this._pressed[t]},onKeydown:t=>{if(!t.repeat)switch(t.key&&e.Input.keyDownListener(t.key),t.cancelable&&"F12"!=t.key&&"F5"!=t.key&&t.preventDefault(),e.Input.lastPressTime=Date.now(),e.Input.lastPressKey=t.key,e.Input._pressed[t.code]=!0,t.code){case e.Input.LEFT:e.Input.leftListener();break;case e.Input.A:e.Input.aListener();break;case e.Input.RIGHT:e.Input.rightListener();break;case e.Input.D:e.Input.dListener();break;case e.Input.UP:e.Input.upListener();break;case e.Input.W:e.Input.wListener();break;case e.Input.DOWN:e.Input.downListener();break;case e.Input.S:e.Input.sListener();break;case e.Input.SPACE:e.Input.spaceListener();break;case e.Input.M:e.Input.mListener();break;case e.Input.I:e.Input.iListener();break;case e.Input.Q:e.Input.qListener();break;case e.Input.COMMA:e.Input.commaListener();break;case e.Input.PERIOD:e.Input.periodListener();break;case e.Input.NUMBER_1:case e.Input.NUMBER_2:case e.Input.NUMBER_3:case e.Input.NUMBER_4:case e.Input.NUMBER_5:case e.Input.NUMBER_6:case e.Input.NUMBER_7:case e.Input.NUMBER_8:case e.Input.NUMBER_9:e.Input.numKeyListener(parseInt(t.code.slice(-1)));break;case e.Input.EQUALS:e.Input.equalsListener();break;case e.Input.MINUS:e.Input.minusListener();break;case e.Input.ESCAPE:e.Input.escapeListener();break;case e.Input.F:e.Input.fListener()}},onKeyup:function(t){delete this._pressed[t.code],t.key===this.lastPressKey&&(this.lastPressTime=0,this.lastPressKey=0),t.code===e.Input.M&&e.Input.mUpListener()},mouseLeftClickListener:function(t,i){for(let s=0;s<e.Input.mouseLeftClickListeners.length;s++)e.Input.mouseLeftClickListeners[s](t,i)},mouseRightClickListener:function(t,i){for(let s=0;s<e.Input.mouseRightClickListeners.length;s++)e.Input.mouseRightClickListeners[s](t,i)},mouseMoveListener:function(t,i){for(let s=0;s<e.Input.mouseMoveListeners.length;s++)e.Input.mouseMoveListeners[s](t,i)},mouseDownListener:function(t,i,s){for(let o=0;o<e.Input.mouseDownListeners.length;o++)e.Input.mouseDownListeners[o](t,i,s)},mouseUpListener:function(t,i,s){for(let o=0;o<e.Input.mouseUpListeners.length;o++)e.Input.mouseUpListeners[o](t,i,s)},mouseClickListener:function(t){if(0===t.button||2===t.button){let i=window.document.getElementById("gameCanvas").getBoundingClientRect(),s=t.clientX-i.left,a=t.clientY-i.top,r=Math.floor(s/o.Game.scale),n=Math.floor(a/o.Game.scale);console.log(`Input.mouseClickListener: raw x: ${s}, y: ${a}, scale: ${o.Game.scale}, scaledX: ${r}, scaledY: ${n}`),0===t.button?e.Input.mouseLeftClickListener(r,n):2===t.button&&e.Input.mouseRightClickListener(r,n)}},updateMousePos:function(t){o.Game.inputReceived=!0;let i=window.document.getElementById("gameCanvas").getBoundingClientRect(),s=t.clientX-i.left,a=t.clientY-i.top;e.Input.rawMouseX=s,e.Input.rawMouseY=a,e.Input.mouseX=Math.floor(s/o.Game.scale),e.Input.mouseY=Math.floor(a/o.Game.scale),e.Input.mouseMoveListener(e.Input.mouseX,e.Input.mouseY)},recalculateMousePosition:function(){void 0!==e.Input.rawMouseX&&void 0!==e.Input.rawMouseY&&(e.Input.mouseX=Math.floor(e.Input.rawMouseX/o.Game.scale),e.Input.mouseY=Math.floor(e.Input.rawMouseY/o.Game.scale),a.MouseCursor.getInstance().recalculateClickPosition())},handleMouseDown:function(t){e.Input.mouseDown||(a.MouseCursor.getInstance().startClickAnim(),e.Input.mouseDown=!0,e.Input.mouseDownStartTime=Date.now(),e.Input.isMouseHold=!1,e.Input.mouseDownListener(e.Input.mouseX,e.Input.mouseY,t.button),e.Input._holdCheckInterval||(e.Input._holdCheckInterval=setInterval(e.Input.checkIsMouseHold,16)))},handleMouseUp:function(t){e.Input.mouseDown=!1,e.Input.mouseDownStartTime=null,e.Input.mouseUpListener(e.Input.mouseX,e.Input.mouseY,t.button),e.Input.lastMouseDownTime=0,e.Input.mouseDownHandled=!1,e.Input._holdCheckInterval&&(clearInterval(e.Input._holdCheckInterval),e.Input._holdCheckInterval=null),setTimeout(()=>{e.Input.isMouseHold=!1},50)},_holdCheckInterval:null,checkIsMouseHold:function(){e.Input.mouseDown&&null!==e.Input.mouseDownStartTime&&Date.now()>=e.Input.mouseDownStartTime+e.Input.HOLD_THRESH&&(e.Input.isMouseHold||(e.Input.isMouseHold=!0,e.Input.holdCallback&&e.Input.holdCallback()))},getTouches:function(t){return o.Game.inputReceived=!0,t.touches||t.originalEvent.touches},xDown:null,yDown:null,currentX:0,currentY:0,swiped:!1,handleTouchStart:function(t){o.Game.inputReceived=!0,t.preventDefault();const i=e.Input.getTouches(t)[0];e.Input.xDown=i.clientX,e.Input.yDown=i.clientY,e.Input.currentX=i.clientX,e.Input.currentY=i.clientY,e.Input.tapStartTime=Date.now(),e.Input.updateMousePos({clientX:e.Input.currentX,clientY:e.Input.currentY}),e.Input.swiped=!1,e.Input.mouseDown=!0,e.Input.mouseDownStartTime=Date.now(),e.Input.isMouseHold=!1,e.Input.mouseDownListener(e.Input.mouseX,e.Input.mouseY,0),e.Input._holdCheckInterval||(e.Input._holdCheckInterval=setInterval(e.Input.checkIsMouseHold,16))},handleTouchMove:function(t){if(t.preventDefault(),e.Input.currentX=t.touches[0].clientX,e.Input.currentY=t.touches[0].clientY,e.Input.updateMousePos({clientX:e.Input.currentX,clientY:e.Input.currentY}),!e.Input.swiped){var i=e.Input.xDown-e.Input.currentX,o=e.Input.yDown-e.Input.currentY;i**2+o**2>=s.GameConstants.SWIPE_THRESH&&(Math.abs(i)>Math.abs(o)?(i>0?(e.Input.leftSwipeListener(),e.Input.lastSwipeDirection=r.Direction.LEFT):(e.Input.rightSwipeListener(),e.Input.lastSwipeDirection=r.Direction.RIGHT),e.Input.swiped=!0,e.Input.lastSwipeTime=Date.now(),e.Input.swipeHoldActive=!0,e.Input.swipeHoldRepeating=!1):(o>0?(e.Input.upSwipeListener(),e.Input.lastSwipeDirection=r.Direction.UP):(e.Input.downSwipeListener(),e.Input.lastSwipeDirection=r.Direction.DOWN),e.Input.swiped=!0,e.Input.lastSwipeTime=Date.now(),e.Input.swipeHoldActive=!0,e.Input.swipeHoldRepeating=!1))}},handleTouchEnd:function(t){t.preventDefault(),e.Input.isTapHold||e.Input.swiped||e.Input.tapListener(),e.Input.isTapHold=!1,e.Input.tapStartTime=null,e.Input.swipeHoldActive=!1,e.Input.swipeHoldRepeating=!1,e.Input.lastSwipeTime=0,e.Input.lastSwipeDirection=null,e.Input.mouseDown=!1,e.Input.mouseDownStartTime=null,e.Input.mouseUpListener(e.Input.mouseX,e.Input.mouseY,0),e.Input._holdCheckInterval&&(clearInterval(e.Input._holdCheckInterval),e.Input._holdCheckInterval=null),setTimeout(()=>{e.Input.isMouseHold=!1},50)},checkIsTapHold:function(){null!==e.Input.tapStartTime&&Date.now()>=e.Input.tapStartTime+e.Input.IS_TAP_HOLD_THRESH&&(e.Input.isTapHold=!0)},set isMouseHold(t){this._isMouseHold=t},get isMouseHold(){return this._isMouseHold},_isMouseHold:!1,mouseDownStartTime:null,HOLD_THRESH:200,holdCallback:null,lastSwipeTime:0,lastSwipeDirection:null,swipeHoldActive:!1,swipeHoldRepeating:!1},window.addEventListener("keyup",function(t){e.Input.onKeyup(t)},!1),window.addEventListener("keydown",function(t){e.Input.onKeydown(t)},!1),window.document.getElementById("gameCanvas").addEventListener("mousemove",t=>e.Input.updateMousePos(t),!1),window.document.getElementById("gameCanvas").addEventListener("mousedown",t=>e.Input.handleMouseDown(t),!1),window.document.getElementById("gameCanvas").addEventListener("mouseup",t=>e.Input.handleMouseUp(t),!1),window.document.getElementById("gameCanvas").addEventListener("contextmenu",t=>t.preventDefault(),!1),window.document.getElementById("gameCanvas").addEventListener("wheel",t=>{t.preventDefault(),e.Input.wheelListener(t.deltaY)},{passive:!1})},3691:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.KingEnemy=void 0;const s=i(7851),o=i(7455),a=i(6986);class r extends a.Enemy{constructor(t,e,i,a,r){super(t,e,i,a),this.justHurt=!1,this.hit=()=>this.damage,this.behavior=()=>{if(this.lastX=this.x,this.lastY=this.y,this.health<=1&&(this.imageParticleY=29),!this.dead){if(this.handleSkipTurns())return;if(this.ticks++,this.seenPlayer){if(this.seenPlayer){if(this.room.playerTicked===this.targetPlayer){this.alertTicks=Math.max(0,this.alertTicks-1);let t=this.x,e=this.y,i=Array();for(const t of this.room.entities)t!==this&&i.push({x:t.x,y:t.y});for(let t=this.x-1;t<=this.x+1;t++)for(let e=this.y-1;e<=this.y+1;e++)this.room.roomArray[t][e]instanceof o.SpikeTrap&&this.room.roomArray[t][e].on&&i.push({x:t,y:e});let s=this.searchPathLocalized(this.targetPlayer,i,{diagonals:!0,diagonalsOnly:!1});if(this.justHurt)this.retreat(t,e);else if(s.length>0&&this.ticks%2==0){i.push({x:t+1,y:e}),i.push({x:t-1,y:e}),i.push({x:t,y:e+1}),i.push({x:t,y:e-1});let o=s[0].pos.x,a=s[0].pos.y,r=!1;for(const t in this.game.players)this.game.rooms[this.game.players[t].levelID]===this.room&&this.game.players[t].x===o&&this.game.players[t].y===a&&(this.game.players[t].hurt(this.hit(),this.name),this.drawX=.5*(this.x-this.game.players[t].x),this.drawY=.5*(this.y-this.game.players[t].y),this.game.players[t]===this.game.players[this.game.localPlayerID]&&this.game.shakeScreen(10*this.drawX,10*this.drawY));r||(this.tryMove(o,a),this.setDrawXY(t,e))}this.ticks%2!=0?(this.unconscious=!1,this.makeHitWarnings()):this.unconscious=!0}let t=-1!==Object.values(this.game.offlinePlayers).indexOf(this.targetPlayer);if(!this.aggro||t){let e=this.nearestPlayer();if(!1!==e){let[i,s]=e;i<=4&&(t||i<this.playerDistance(this.targetPlayer))&&s!==this.targetPlayer&&(this.targetPlayer=s,this.facePlayer(s),s===this.game.players[this.game.localPlayerID]&&(this.alertTicks=1),this.makeHitWarnings())}}}}else{this.justHurt=!1;let t=this.nearestPlayer();if(!1!==t){let[e,i]=t;e<=4&&(this.targetPlayer=i,this.facePlayer(i),this.seenPlayer=!0,i===this.game.players[this.game.localPlayerID]&&(this.alertTicks=1),this.makeHitWarnings())}}}},this.jump=t=>{let e=Math.max(Math.abs(this.drawX),Math.abs(this.drawY)),i=Math.abs(Math.sin(e*Math.PI))*this.jumpHeight;i<.01&&(i=0),i>this.jumpHeight&&(i=this.jumpHeight),this.jumpY=i},this.draw=t=>{let e=this.health<=1?0:-3;this.cloned&&(e=0),this.dead||(s.Game.ctx.save(),s.Game.ctx.globalAlpha=this.alpha,this.dead||(this.updateDrawXY(t),this.frame+=.1*t,this.frame>=4&&(this.frame=0),this.hasShadow&&this.drawShadow(t),s.Game.drawMob(this.tileX+Math.floor(this.frame),this.tileY+e,1,3,this.x-this.drawX,this.y-this.drawYOffset-this.drawY-this.jumpY-1,1,3,this.softShadeColor,this.shadeAmount()*(1+this.jumpY/3),void 0,this.outlineColor(),this.outlineOpacity())),this.cloned||(this.seenPlayer||this.drawSleepingZs(t),this.alertTicks>0&&this.drawExclamation(t)),s.Game.ctx.restore())},this.ticks=0,this.frame=0,this.health=2,this.maxHealth=2,this.defaultMaxHealth=2,this.tileX=51,this.tileY=15,this.seenPlayer=!1,this.aggro=!1,this.destroyableByOthers=!1,this.name="king",this.orthogonalAttack=!0,this.diagonalAttack=!0,this.jumpHeight=1,this.imageParticleX=6,this.imageParticleY=25,this.baseDamage=2,r&&(this.drop=r),this.armored=!0,this.getDrop(["weapon","equipment","consumable","tool","coin"])}}e.KingEnemy=r,r.difficulty=4,r.tileX=23,r.tileY=8},3709:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.AmberResource=void 0;const s=i(7172),o=i(9432),a=i(9467),r=i(2351),n=i(2103);class h extends s.Resource{constructor(t,e,i,s){super(t,e,i,s),this.tileX=17,this.tileY=0,this.health=3,this.hasBloom=!0,this.bloomColor="#FFA500",this.bloomAlpha=1,this.softBloomAlpha=0,this.name="amber",a.Random.rand()<.025&&this.drops.push(new o.Geode(this.room,this.x,this.y)),this.drops.push(new r.OrangeGem(this.room,this.x,this.y)),this.lightSource=new n.LightSource(this.x+.5,this.y+.5,7,[100,30,1],1),this.addLightSource(this.lightSource)}}e.AmberResource=h},3718:(t,e)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.EventEmitter=void 0,e.EventEmitter=class{constructor(){this.events={}}on(t,e){this.events[t]||(this.events[t]=[]),this.events[t].push(e)}off(t,e){this.events[t]&&(this.events[t]=this.events[t].filter(t=>t!==e))}emit(t,e){this.events[t]&&this.events[t].forEach(t=>t(e))}removeAllListeners(t){delete this.events[t]}}},3779:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.BoltcasterEnemy=void 0;const s=i(7851),o=i(7455),a=i(6986),r=i(369),n=i(6791),h=i(6291);var l;!function(t){t[t.SEEK_LINE=0]="SEEK_LINE",t[t.LOADING=1]="LOADING"}(l||(l={}));class c extends a.Enemy{constructor(t,e,i,a){super(t,e,i,a),this.isInlineWithPlayerAndClear=(t,e)=>{if(this.x!==t&&this.y!==e)return!1;const i=Math.sign(t-this.x),s=Math.sign(e-this.y);let o=this.x,a=this.y;for(;;){if(o+=i,a+=s,o===t&&a===e)return!0;if(!this.room.tileInside(o,a))return!1;const r=this.room.roomArray[o]?.[a];if(!r||r.isSolid())return!1;if(this.room.entities.some(t=>t.x===o&&t.y===a))return!1}},this.findNearestInlineTile=()=>{const t=this.getPlayer();if(!t)return null;const e=t.x,i=t.y,s=[];for(let t=this.room.roomX;t<this.room.roomX+this.room.width;t++){const o=i,a=this.room.roomArray[t]?.[o];a&&!a.isSolid()&&(this.room.entities.some(e=>e.x===t&&e.y===o)||this.lineClear(t,o,e,i)&&s.push({x:t,y:o}))}for(let t=this.room.roomY;t<this.room.roomY+this.room.height;t++){const o=e,a=this.room.roomArray[o]?.[t];a&&!a.isSolid()&&(this.room.entities.some(e=>e.x===o&&e.y===t)||this.lineClear(o,t,e,i)&&s.push({x:o,y:t}))}if(0===s.length)return null;let a=null,r=1/0;const n=[];for(const t of this.room.entities)t!==this&&n.push({x:t.x,y:t.y});for(let t=this.x-1;t<=this.x+1;t++)for(let e=this.y-1;e<=this.y+1;e++)this.room.roomArray[t]?.[e]instanceof o.SpikeTrap&&this.room.roomArray[t][e].on&&n.push({x:t,y:e});for(const t of s){const e=this.searchPathLocalized({x:t.x,y:t.y},n);e&&e.length>0&&e.length<r&&(a=t,r=e.length)}return a},this.lineClear=(t,e,i,s)=>{if(t!==i&&e!==s)return!1;const o=Math.sign(i-t),a=Math.sign(s-e);let r=t,n=e;for(;;){if(r+=o,n+=a,r===i&&n===s)return!0;if(!this.room.tileInside(r,n))return!1;const t=this.room.roomArray[r]?.[n];if(!t||t.isSolid())return!1;if(this.room.entities.some(t=>t.x===r&&t.y===n))return!1}},this.makeLineHitWarnings=(t,e)=>{const i=Math.sign(t-this.x),s=Math.sign(e-this.y);let o=this.x,a=this.y;for(;o+=i,a+=s,(o!==t||a!==e)&&this.room.tileInside(o,a);){const i=this.room.roomArray[o]?.[a];if(!i||i.isSolid())break;this.makeHitWarning(t,e,o,a)}},this.makeHitWarning=(t,e,i,s)=>{this.room.hitwarnings.push(new r.HitWarning(this.room.game,t,e,i,s,!0,!1,this))},this.fireLoadedShot=()=>{let t=this.loadDx,e=this.loadDy;const i=this.targetPlayer;!i||this.x!==i.x&&this.y!==i.y||this.lineClear(this.x,this.y,i.x,i.y)&&(t=Math.sign(i.x-this.x)||0,e=Math.sign(i.y-this.y)||0);let s=this.x,o=this.y,a=s,r=o,h=s,l=o,c=null,d=!1;for(;s+=t,o+=e,this.room.tileInside(s,o);){const n=this.room.roomArray[s]?.[o];if(!n||n.isSolid()){t>0?(a=s-.5,r=l+0):t<0?(a=s+1.5,r=l+0):e>0?(r=o-.5,a=h+0):e<0&&(r=o+1.5,a=h+0);break}if(i&&s===i.x&&o===i.y){a=s,r=o,d=!0;break}const m=this.room.entities.find(t=>t.x===s&&t.y===o);if(m){c=m,a=s,r=o;break}a=s,r=o,h=s,l=o}const m=0!==t&&0===e,u=this.x+.5,p=m?this.y-.25:this.y,y=a+.5,g=m?r-.25:r;this.room.particles.push(new n.ArrowParticle(this.room,u,p,y,g)),d&&i?i.hurt(this.hit(),this.name):c&&c.hurt?.(this,1)},this.draw=t=>{if(this.dead)return;s.Game.ctx.globalAlpha=this.alpha,this.updateDrawXY(t),this.frame+=.1*t,this.frame>=4&&(this.frame=0),this.hasShadow&&this.drawShadow(t),this.rumbling=this.isLoading;let e=this.rumble(this.rumbling,this.frame,this.direction).x,i=this.rumble(this.rumbling,this.frame,this.direction).y;s.Game.drawMob(this.tileX,this.tileY,1,2,this.x-this.drawX+e,this.y-this.drawYOffset-this.drawY-this.jumpY+i,1,2,this.softShadeColor,this.shadeAmount(),void 0,this.outlineColor(),this.outlineOpacity()),this.cloned||(this.seenPlayer||this.drawSleepingZs(t),this.alertTicks>0&&this.drawExclamation(t)),this.isLoading&&this.drawLoadBeam(t),s.Game.ctx.globalAlpha=1},this.behavior=()=>{if(this.lastX=this.x,this.lastY=this.y,!this.dead&&!this.handleSkipTurns())if(this.ticks++,this.seenPlayer){if(this.seenPlayer&&this.room.playerTicked===this.targetPlayer){this.alertTicks=Math.max(0,this.alertTicks-1);const t=this.targetPlayer;if(t&&this.playerDistance(t)<=1&&!this.isLoading)return void this.runAway(!0);if(this.isLoading)return this.isLoading=!1,this.rumbling=!1,void this.fireLoadedShot();if(this.isInlineWithPlayerAndClear(t.x,t.y))return this.loadDx=Math.sign(t.x-this.x)||0,this.loadDy=Math.sign(t.y-this.y)||0,this.loadedPlayerX=t.x,this.loadedPlayerY=t.y,this.facePlayer(t),this.isLoading=!0,this.rumbling=!0,void this.makeLineHitWarnings(t.x,t.y);const e=[];for(const t of this.room.entities)t!==this&&e.push({x:t.x,y:t.y});for(let t=this.x-1;t<=this.x+1;t++)for(let i=this.y-1;i<=this.y+1;i++)this.room.roomArray[t]?.[i]instanceof o.SpikeTrap&&this.room.roomArray[t][i].on&&e.push({x:t,y:i});const i=this.findNearestInlineTile();if(i){const o=this.searchPathLocalized({x:i.x,y:i.y},e);if(o&&o.length>0){const e=o[0].pos.x,i=o[0].pos.y,a=this.x,r=this.y;this.facePlayer(t),this.tryMove(e,i),this.setDrawXY(a,r),this.x>a?this.direction=s.Direction.RIGHT:this.x<a?this.direction=s.Direction.LEFT:this.y>r?this.direction=s.Direction.DOWN:this.y<r&&(this.direction=s.Direction.UP),this.makeHitWarnings()}}else{const i=this.searchPathLocalized(t,e);if(i&&i.length>0){const t=i[0].pos.x,e=i[0].pos.y,s=this.x,o=this.y;this.tryMove(t,e),this.setDrawXY(s,o)}}}}else this.lookForPlayer()},this.computeLoadBeamEnd=()=>{let t=this.loadDx,e=this.loadDy;0===t&&0===e&&(t=this.direction===s.Direction.RIGHT?1:this.direction===s.Direction.LEFT?-1:0,e=this.direction===s.Direction.DOWN?1:this.direction===s.Direction.UP?-1:0);let i=this.x,o=this.y,a=i,r=o;for(let s=0;s<50&&(i+=t,o+=e,this.room.tileInside(i,o));s++){const t=this.room.roomArray[i]?.[o];if(!t||t.isSolid())break;if(this.room.entities.some(t=>t.x===i&&t.y===o))break;if(a=i,r=o,i===this.loadedPlayerX&&o===this.loadedPlayerY)break}return{endX:a,endY:r}},this.drawLoadBeam=t=>{if(this.loadTrailFrame+=.2*t,Math.floor(this.loadTrailFrame)%2==0){let t=(this.x+.5)*h.GameConstants.TILESIZE,e=(this.y-.25)*h.GameConstants.TILESIZE;this.direction===s.Direction.LEFT?t-=3:this.direction===s.Direction.RIGHT?t+=3:this.direction===s.Direction.DOWN?e+=2:this.direction===s.Direction.UP&&(e-=8);const{endX:i,endY:o}=this.computeLoadBeamEnd();s.Game.ctx.strokeStyle="white",s.Game.ctx.lineWidth=.1*h.GameConstants.TILESIZE,s.Game.ctx.beginPath(),s.Game.ctx.moveTo(Math.round(t),Math.round(e)),s.Game.ctx.lineCap="round",s.Game.ctx.lineTo(Math.round((i+.5)*h.GameConstants.TILESIZE),Math.round((o-.25)*h.GameConstants.TILESIZE)),s.Game.ctx.stroke(),s.Game.ctx.globalAlpha=1}},this.name="boltcaster",this.tileX=43,this.tileY=8,this.health=2,this.maxHealth=2,this.dropChance=1,this.state=l.SEEK_LINE,this.isLoading=!1,this.loadDx=0,this.loadDy=0,this.loadedPlayerX=0,this.loadedPlayerY=0,this.loadTrailFrame=0,this.loadTrailAlpha=1,this.getDrop(["crossbow"],!1)}}e.BoltcasterEnemy=c},3785:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Spellbook=void 0;const s=i(4052),o=i(7366),a=i(3937),r=i(6199),n=i(7851),h=i(3346);class l extends s.Weapon{constructor(t,e,i){super(t,e,i),this.getTargets=()=>{this.targets=[];let t=(this.wielder?.getRoom?this.wielder.getRoom():this.game.rooms[this.wielder.levelID]).entities;this.targets=t.filter(t=>!t.pushable&&r.Utils.distance(this.wielder.x,this.wielder.y,t.x,t.y)<=this.range&&t.destroyable);let e=this.targets.filter(t=>!0===t.isEnemy);return e.length>0?e:this.targets},this.disassemble=()=>{if(this.equipped)return void this.game.pushMessage("I should probably unequip this before I try to disassemble it...");this.game.pushMessage("You tear the remaining pages out of your spellbook.");let t=this.wielder.inventory,e=this.x,i=this.y,s=Math.floor(this.durability);this.toggleEquip(),t.removeItem(this),t.addItem(new h.SpellbookPage(this.level,e,i,s))},this.weaponMove=(t,e)=>{this.getTargets();let i=this.wielder.direction,s=!1,r=this.targets;r.length>0?this.isTargeting=!0:this.isTargeting=!1,r=r.filter(s=>{switch(i){case n.Direction.UP:return s.y<=e;case n.Direction.RIGHT:return s.x>=t;case n.Direction.DOWN:return s.y>=e;case n.Direction.LEFT:return s.x<=t;default:return!1}});const h=[];for(let t of r){const e=this.wielder?.getRoom?this.wielder.getRoom():this.game.rooms[this.wielder.levelID];e.roomArray[t.x][t.y].isSolid()||(t.hurt(this.wielder,this.damage+this.wielder.magicDamageBonus),e.projectiles.push(new a.PlayerFireball(this.wielder,t.x,t.y)),h.push(t),s=!0)}if(this.targets=h,s){this.hitSound(),this.wielder.setHitXY(t,e),(this.wielder?.getRoom?this.wielder.getRoom():this.game.rooms[this.wielder.levelID]).tick(this.wielder),this.shakeScreen(t,e),o.Sound.playMagic(),this.degrade(),this.cooldown=this.cooldownMax;for(let t of this.wielder.inventory.items)t instanceof l&&(t.cooldown=t.cooldownMax);setTimeout(()=>{this.isTargeting=!1},100)}return!s},this.drawBeams=(t,e,i)=>{const s=this.wielder?.getRoom?this.wielder.getRoom():this.game.rooms[this.wielder.levelID];if(s.beamEffects=[],this.isTargeting)for(let o of this.targets)s.addBeamEffect(t,e,o.x-o.drawX,o.y-o.drawY,o),s.beamEffects[s.beamEffects.length-1].render(t,e,o.x-o.drawX,o.y-o.drawY,"cyan",2,i)},this.range=4,this.tileX=25,this.tileY=0,this.canMine=!0,this.name=l.itemName,this.isTargeting=!1,this.durability=10,this.durabilityMax=10,this.description="Hits multiple enemies within a range of 4 tiles.",this.degradeable=!0,this.cooldownMax=25}}e.Spellbook=l,l.itemName="spellbook"},3937:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.PlayerFireball=void 0;const s=i(8774),o=i(7851),a=i(1124),r=i(6199);class n extends s.Projectile{constructor(t,e,i){super(t,e,i),this.drawTopLayer=t=>{this.dead||(this.offsetFrame<0&&(this.offsetFrame+=10*t),this.offsetFrame>=0&&(this.frame+=.25*t),this.frame>17&&(this.dead=!0),o.Game.drawFX(Math.floor(this.frame),6,1,2,this.x,this.y-1,1,2))},this.state=0,this.frame=6,this.offsetFrame=50*-r.Utils.distance(this.parent.x,this.parent.y,this.x,this.y),this.delay=0,a.Lighting.momentaryLight(this.parent.game.rooms[this.parent.levelID],this.x+.5,this.y+.5,.5,[255,100,0],250,10,1)}}e.PlayerFireball=n},4021:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Pumpkin=void 0;const s=i(606),o=i(7851),a=i(606),r=i(2103),n=i(8149);class h extends s.Entity{constructor(t,e,i,s){super(t,e,i,s),this.draw=t=>{this.dead||(o.Game.ctx.save(),o.Game.ctx.globalAlpha=this.alpha,this.dead||(this.hasShadow&&this.drawShadow(t),this.updateDrawXY(t),o.Game.drawObj(this.tileX,this.tileY,1,2,this.x-this.drawX,this.y-this.drawYOffset-this.drawY,1,2,this.room.shadeColor,this.shadeAmount())),o.Game.ctx.restore())},this.drawTopLayer=t=>{this.drawableY=this.y},this.room=t,this.health=1,this.tileX=15,this.tileY=2,this.hasShadow=!0,this.chainPushable=!1,this.name="pumpkin",this.drops.push(new n.Candle(this.room,this.x,this.y)),this.imageParticleX=0,this.imageParticleY=25,this.bloomColor="#FFA500",this.hasBloom=!0,this.bloomAlpha=1,this.softBloomAlpha=0,this.lightSource=new r.LightSource(this.x+.5,this.y+.5,5,[200,30,1],3),this.addLightSource(this.lightSource)}get type(){return a.EntityType.PROP}}e.Pumpkin=h},4052:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Weapon=void 0;const s=i(7851),o=i(8549),a=i(7366),r=i(6291),n=i(4083),h=i(1302),l=i(7851),c=i(8551);class d extends o.Equippable{constructor(t,e,i,o){super(t,e,i),this.hoverText=()=>this.name,this.break=()=>{this.durability=0,this.wielder.inventory.weapon=null,this.toggleEquip(),this.game.pushMessage("Your weapon breaks"),(this.status.poison||this.status.blood)&&this.clearStatus(),this.broken=!0},this.coEquippable=t=>!(t instanceof d),this.applyStatus=t=>{this.status=t,this.status.blood},this.clearStatus=()=>{const t=this.status.poison?"poison":"bleed";this.game.pushMessage(`Your ${this.name}'s ${t} effect dries up`),this.status={poison:!1,blood:!1},this.statusApplicationCount=0},this.statusEffect=t=>{if(!t.isEnemy)return;const e=t;!e.status.poison.active&&!e.status.bleed.active&&this.wielder.applyStatus(e,this.status)&&e.health>0&&(this.statusApplicationCount++,this.status.poison,e.name)},this.disassemble=()=>{if(!this.degradeable)return void this.game.pushMessage("You can't disassemble this item because it's not degradeable.");if(this.equipped)return void this.game.pushMessage("I should probably unequip this before I try to disassemble it...");this.game.pushMessage(`You dissassemble your ${this.name} into fragments.`);let t=this.wielder.inventory,e=this.x,i=this.y,s=Math.floor(this.durability/1.5);this.toggleEquip(),t.removeItem(this),t.addItem(new n.WeaponFragments(this.level,e,i),s)},this.dropFromInventory=()=>{this.wielder.inventory.weapon===this&&(this.wielder.inventory.weapon=null),this.wielder=null,this.equipped=!1},this.checkForCollidables=(t,e)=>{for(const i of this.getEntitiesAt(t,e))if(!0===i.collidable)return!0;return!1},this.weaponMove=(t,e)=>!!this.checkForPushables(t,e)||!(this.knockbackDistance>0&&this.attemptKnockback(t,e))&&!this.executeAttack(t,e),this.attack=(t,e)=>{this.shouldHitEntity(t)&&(t.hurt(this.wielder,e||this.damage),this.statusEffect(t))},this.attackAnimation=(t,e)=>{this.wielder.setHitXY(t,e);const i=this.wielder?.getRoom?this.wielder.getRoom():this.game?.rooms?.[this.wielder.levelID];i?i.particles.push(new h.AttackAnimation(t,e,this.name,this.wielder.direction)):console.error(" WEAPON: Cannot add particle - invalid room state")},this.shakeScreen=(t,e)=>{(this.wielder?.getRoom?this.wielder.getRoom():this.wielder.game.rooms[this.wielder.levelID])===this.wielder.game.room&&this.wielder.shakeScreen(this.wielder.x,this.wielder.y,t,e)},this.hitSound=()=>{a.Sound.swing(),a.Sound.hit()},this.drawStatus=(t,e)=>{if(this.status.poison||this.status.blood){let i=3;this.status.poison&&(i=4),this.status.blood&&(i=3),s.Game.drawFX(i,0,1,1,t-1/r.GameConstants.TILESIZE,e-1/r.GameConstants.TILESIZE,1,1)}},this.getDescription=()=>{let t=this.broken?" (broken)":"",e=[],i="";return this.status.poison&&e.push("Poison"),this.status.blood&&e.push(" Bleed"),this.durability<this.durabilityMax&&(i=` Durability: ${this.durability}/${this.durabilityMax}`),`${this.name}${t}\n${e.join(", ")}\n${i}\n${this.description}\ndamage: ${this.damage}`},this.tick=()=>{this.updateCooldown()},this.updateCooldown=()=>{this.cooldown>0&&(this.cooldown--,this.cooldown>0&&this.equipped)&&(this.equipped=!1,this.wielder.inventory.items.some(t=>t===this.previousWeapon)&&null!==this.previousWeapon&&!1===this.previousWeapon.broken&&0===this.previousWeapon.cooldown?(this.wielder.inventory.weapon=this.previousWeapon,this.previousWeapon.equipped=!0):this.wielder.inventory.weapon=null)},this.applyHitDelay=t=>{t&&(this.wielder.busyAnimating=!0,setTimeout(()=>{this.wielder.busyAnimating=!1},this.hitDelay||0))},this.beginSwing=()=>{this._swingHitIds=new Set},this.endSwing=()=>{this._swingHitIds=null},this.shouldHitEntity=t=>{if(!this._swingHitIds)return!0;const e=t?.globalId||`${t.name}:${t.x},${t.y}`;return!this._swingHitIds.has(e)&&(this._swingHitIds.add(e),!0)},t&&(this.game=t.game),this.canMine=!1,this.range=1,this.damage=1,this.status=o||{poison:!1,blood:!1},this.durability=50,this.durabilityMax=50,this.statusApplicationCount=0,this.equipTick=!0,this.name=this.constructor.prototype.itemName,this.cooldown=0,this.cooldownMax=0,this.twoHanded=!1,this.knockbackDistance=0,this._swingHitIds=null}getEntitiesAt(t,e){if(!this.game)return console.error(" WEAPON: this.game is undefined"),[];if(!this.wielder)return console.error(" WEAPON: this.wielder is undefined"),[];const i=this.wielder?.getRoom?this.wielder.getRoom():this.game?.rooms?.[this.wielder.levelID];return i?i.entities.filter(i=>i.destroyable&&i.pointIn(t,e)):(console.error(" WEAPON: current room is undefined"),[])}hitEntitiesAt(t,e,i){const s=this.getEntitiesAt(t,e).filter(t=>!t.pushable);let o=!1;for(const t of s)this.attack(t,i),o=!0;return o}checkForPushables(t,e){let i=t,s=e;switch(this.wielder.direction){case l.Direction.DOWN:s+=1;break;case l.Direction.UP:s-=1;break;case l.Direction.LEFT:i-=1;break;case l.Direction.RIGHT:i+=1}const o=this.wielder?.getRoom?this.wielder.getRoom():this.game?.rooms?.[this.wielder.levelID];if(!o)return!1;const a=this.getEntitiesAt(i,s).filter(t=>!t.pushable).length>0,r=o.roomArray[i]?.[s],n=!(!r||r.isSolid()||a);return this.getEntitiesAt(t,e).filter(t=>t.pushable).length>0&&n}attemptKnockback(t,e){if(this.knockbackDistance<=0)return!1;const i=this.wielder?.getRoom?this.wielder.getRoom():this.game?.rooms?.[this.wielder.levelID];if(!i)return!1;const s=this.getEntitiesAt(t,e).filter(t=>!t.pushable&&t.isEnemy);if(0===s.length)return!1;const o=s[0],a=Math.sign(t-this.wielder.x),r=Math.sign(e-this.wielder.y);if(this.attack(o,this.damage+this.wielder.damageBonus),!1===o.chainPushable)return this.applyHitDelay(!0),this.hitSound(),this.wielder.setHitXY(t,e),this.attackAnimation(t,e),i&&i.tick(this.wielder),this.shakeScreen(t,e),this.degrade(),!0;const{chain:n,nextX:h,nextY:l,enemyEnd:d}=(0,c.computePushChain)(i,o,a,r),m=i.roomArray?.[h]?.[l];let u=!1;return!!m&&(!m.isSolid?.()||m.canCrushEnemy?.()||d)&&(u=(0,c.applyPushChain)(i,o,n,a,r,h,l,d)),this.applyHitDelay(!0),this.hitSound(),this.wielder.setHitXY(t,e),this.attackAnimation(t,e),i&&i.tick(this.wielder),this.shakeScreen(t,e),u&&(o.skipNextTurns=1),this.degrade(),!0}executeAttack(t,e,i=!0,s=this.damage+this.wielder.damageBonus,o=!0,a=!0,r=!0,n=!0){const h=this.hitEntitiesAt(t,e,s);if(this.applyHitDelay(h),h){if(a&&this.hitSound(),this.wielder.setHitXY(t,e),i&&this.attackAnimation(t,e),n){const t=this.wielder?.getRoom?this.wielder.getRoom():this.game?.rooms?.[this.wielder.levelID];t&&t.tick(this.wielder)}o&&this.shakeScreen(t,e),r&&this.degrade()}return h}}e.Weapon=d,d.itemName="weapon"},4083:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.WeaponFragments=void 0;const s=i(7366),o=i(5180),a=i(8549),r=i(9467);class n extends o.Usable{constructor(t,e,i,o){super(t,e,i),this.onUse=t=>{t.health=Math.min(t.maxHealth,t.health+1),(t?.getRoom?t.getRoom():this.level.game.rooms[t.levelID])===this.level.game.room&&s.Sound.heal(),t.inventory.removeItem(this)},this.useOnOther=(t,e)=>{if(e instanceof a.Equippable&&e.durabilityMax-e.durability>=1&&"spellbook"!==e.name){let i=Math.min(e.durabilityMax-e.durability,this.stackCount);e.durability+=i,this.stackCount-=i,e.broken=!1,this.level.game.pushMessage(`You repair your ${e.name} with ${i} fragments.`),this.stackCount<=0&&t.inventory.removeItem(this)}else"spellbook"===e.name&&this.level.game.pushMessage("You'll need some book pages to replenish that.")},this.tileX=3,this.tileY=0,this.offsetY=-.3,this.name="weapon fragments",this.canUseOnOther=!0,this.stackable=!0,this.stackCount=o||Math.ceil(10*r.Random.rand())+7,this.description="Can be used to repair broken weapons",this.maximumStackCount=64}}e.WeaponFragments=n,n.itemName="weapon fragments"},4118:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Room=e.WallDirection=e.TurnState=e.RoomType=e.EnemyTypeMap=e.EnemyType=void 0;const s=i(9200),o=i(1285),a=i(3384),r=i(7851),n=i(4804),h=i(8132),l=i(5097),c=i(606),d=i(32),m=i(6083),u=i(6291),p=i(7975),y=i(3201),g=i(4854),f=i(2270),w=i(824),E=i(7455),x=i(8004),b=i(369),T=i(2057),I=i(3436),S=i(1987),v=i(5838),A=i(5146),M=i(2248),C=i(126),D=i(1103),O=i(6084),_=i(9982),R=i(4918),G=i(8243),P=i(4254),L=i(8200),k=i(3180),N=i(675),Y=i(9467),B=i(66),H=i(3005),X=i(8017),F=i(492),W=i(1626),U=i(6598),j=i(7716),V=i(9357),z=i(6986),q=i(4159),$=i(5339),Z=i(645),K=i(1085),Q=i(5196),J=i(6493),tt=i(8075),et=i(1073),it=i(4438),st=i(2102),ot=i(9245),at=i(7366),rt=i(7356),nt=i(3175),ht=i(1429),lt=i(9997),ct=i(7135),dt=i(8480),mt=i(8149),ut=i(8323),pt=i(8287),yt=i(2394),gt=i(6199),ft=i(5741),wt=i(5947),Et=i(9713),xt=i(2440),bt=i(1040),Tt=i(8363),It=i(5016),St=i(5926),vt=i(5109),At=i(3691),Mt=i(3779),Ct=i(721),Dt=i(783),Ot=i(1199),_t=i(8583),Rt=i(1096);var Gt,Pt,Lt,kt;!function(t){t.crab="crab",t.frog="frog",t.zombie="zombie",t.skull="skull",t.energyWizard="energywizard",t.charge="charge",t.rook="rook",t.bishop="bishop",t.armoredzombie="armoredzombie",t.bigskull="bigskull",t.queen="queen",t.knight="knight",t.bigknight="bigknight",t.firewizard="firewizard",t.spawner="spawner",t.occultist="occultist",t.bomb="bomb",t.armoredskull="armoredskull",t.mummy="mummy",t.spider="spider",t.bigzombie="bigzombie",t.glowbug="glowbug",t.tree="tree",t.tombStone="tombstone",t.warden="warden",t.crusher="crusher",t.pawn="pawn",t.beetle="beetle",t.bigfrog="bigfrog",t.exalter="exalter",t.king="king",t.chest="chest",t.boltcaster="boltcaster",t.earthwizard="earthwizard",t.tallSucculent="succulent"}(Gt=e.EnemyType||(e.EnemyType={})),e.EnemyTypeMap={[Gt.crab]:L.CrabEnemy,[Gt.frog]:j.FrogEnemy,[Gt.zombie]:k.ZombieEnemy,[Gt.skull]:p.SkullEnemy,[Gt.energyWizard]:$.EnergyWizardEnemy,[Gt.charge]:_.ChargeEnemy,[Gt.rook]:J.RookEnemy,[Gt.bishop]:H.BishopEnemy,[Gt.armoredzombie]:F.ArmoredzombieEnemy,[Gt.bigskull]:N.BigSkullEnemy,[Gt.queen]:U.QueenEnemy,[Gt.knight]:l.KnightEnemy,[Gt.bigknight]:V.BigKnightEnemy,[Gt.firewizard]:q.FireWizardEnemy,[Gt.spawner]:C.Spawner,[Gt.occultist]:it.OccultistEnemy,[Gt.bomb]:ot.Bomb,[Gt.armoredskull]:nt.ArmoredSkullEnemy,[Gt.mummy]:ht.MummyEnemy,[Gt.spider]:lt.SpiderEnemy,[Gt.bigzombie]:dt.BigZombieEnemy,[Gt.glowbug]:ut.GlowBugEnemy,[Gt.tree]:ft.Tree,[Gt.tombStone]:W.TombStone,[Gt.warden]:Et.WardenEnemy,[Gt.crusher]:xt.CrusherEnemy,[Gt.pawn]:bt.PawnEnemy,[Gt.beetle]:Tt.BeetleEnemy,[Gt.bigfrog]:It.BigFrogEnemy,[Gt.exalter]:vt.ExalterEnemy,[Gt.king]:At.KingEnemy,[Gt.chest]:d.Chest,[Gt.boltcaster]:Mt.BoltcasterEnemy,[Gt.earthwizard]:Ct.EarthWizardEnemy,[Gt.tallSucculent]:Rt.TallSucculent},function(t){t.START="START",t.DUNGEON="DUNGEON",t.BOSS="BOSS",t.BIGDUNGEON="BIGDUNGEON",t.TREASURE="TREASURE",t.FOUNTAIN="FOUNTAIN",t.COFFIN="COFFIN",t.GRASS="GRASS",t.PUZZLE="PUZZLE",t.KEYROOM="KEYROOM",t.CHESSBOARD="CHESSBOARD",t.MAZE="MAZE",t.CORRIDOR="CORRIDOR",t.SPIKECORRIDOR="SPIKECORRIDOR",t.UPLADDER="UPLADDER",t.DOWNLADDER="DOWNLADDER",t.SHOP="SHOP",t.BIGCAVE="BIGCAVE",t.CAVE="CAVE",t.SPAWNER="SPAWNER",t.ROPEHOLE="ROPEHOLE",t.ROPECAVE="ROPECAVE",t.TUTORIAL="TUTORIAL",t.GRAVEYARD="GRAVEYARD",t.FOREST="FOREST",t.ROPEUP="ROPEUP",t.GEMCAVE="GEMCAVE"}(Pt=e.RoomType||(e.RoomType={})),function(t){t[t.playerTurn=0]="playerTurn",t[t.computerTurn=1]="computerTurn"}(Lt=e.TurnState||(e.TurnState={})),(kt=e.WallDirection||(e.WallDirection={})).NORTH="North",kt.EAST="East",kt.SOUTH="South",kt.WEST="West",kt.TOPLEFT="TopLeft",kt.TOPRIGHT="TopRight",kt.BOTTOMLEFT="BottomLeft",kt.BOTTOMRIGHT="BottomRight",e.Room=class{constructor(t,l,d,p,f,S,v,A,M,_=Y.Random.rand,R){this.shadeSliceBorderTiles=1,this.name="",this.shadeColor="#000000",this.wallInfo=new Map,this.tunnelDoor=null,this.blurOffsetX=5,this.blurOffsetY=5,this.lastDraw=0,this.drawTimestamp=0,this.drawInterval=4,this.underwater=!1,this.beamEffects=[],this.particleCleanupAccumulator=0,this.blurCache={color6px:null,color12px:null,shade5px:null,bloom8px:null,color8px:null,isValid:!1,lastLightingUpdate:0},this.isUpdatingLighting=!1,this.estimatedLightingTiles=0,this.playMusic=()=>{this.envType===et.EnvType.FOREST?(at.Sound.stopMusic(),at.Sound.playForestMusic()):this.envType===et.EnvType.CAVE?(at.Sound.stopMusic(),at.Sound.playCaveMusic()):this.envType===et.EnvType.CASTLE?(at.Sound.stopMusic(),at.Sound.playCastleMusic()):at.Sound.stopMusic()},this.removeWall=(t,e)=>{this.roomArray[t][e]instanceof s.Wall&&(this.roomArray[t][e]=null)},this.addDoor=(t,e,i=this,s=!1)=>{let o,a=n.DoorType.DOOR;return i.type===Pt.BOSS&&(a=n.DoorType.GUARDEDDOOR),i.type===Pt.KEYROOM&&(a=n.DoorType.LOCKEDDOOR),s&&(a=n.DoorType.TUNNELDOOR),t===i.roomX?(o=new n.Door(i,i.game,t,e,r.Direction.RIGHT,a),i.roomArray[t+1][e]=new m.SpawnFloor(i,t+1,e)):t===i.roomX+i.width-1?(o=new n.Door(i,i.game,t,e,r.Direction.LEFT,a),i.roomArray[t-1][e]=new m.SpawnFloor(i,t-1,e)):e===i.roomY?(o=new n.Door(i,i.game,t,e,r.Direction.UP,a),i.roomArray[t][e+1]=new m.SpawnFloor(i,t,e+1)):e===i.roomY+i.height-1&&(o=new n.Door(i,i.game,t,e,r.Direction.DOWN,a),i.roomArray[t][e-1]=new m.SpawnFloor(i,t,e-1)),s&&(i.tunnelDoor=o),i.doors.push(o),i.roomArray[o.x],i.roomArray[o.x][o.y]=o,o},this.addNewEnemy=t=>{const i=e.EnemyTypeMap[t];if(!i)return void console.error(`Enemy type "${t}" is not recognized.`);const s=this.getEmptyTiles();if(!s||0===s.length)return;let o=this.getRandomEmptyPosition(s);if(!o)return;let{x:a,y:r}=o;if(t===Gt.bigzombie){if(o=this.getBigRandomEmptyPosition(s),!o)return;({x:a,y:r}=o)}i.add(this,this.game,a,r)},this.addNewSpawner=t=>{if(!e.EnemyTypeMap[t])return;const i=this.getEmptyTiles();if(!i||0===i.length)return;const{x:s,y:o}=this.getRandomEmptyPosition(i);C.Spawner.add(this,this.game,s,o)},this.linkExitToStart=t=>{t||(t=this.level.startRoom),this.addDoorWithOffset(t.roomX+Math.floor(t.width/2)+1,t.roomY,t,!0)&&this.addDoorWithOffset(this.roomX+Math.floor(this.width/2)-1,this.roomY,this,!0)&&(t.tunnelDoor.startRoom=!0,this.tunnelDoor.linkedDoor=t.tunnelDoor,t.tunnelDoor.linkedDoor=this.tunnelDoor)},this.exitLevel=()=>{r.Game.shade_canvases={},r.Game.text_rendering_canvases={};for(let t of this.doors){if(!t||!t.linkedDoor)continue;const e=t.linkedDoor;e.lightSource&&e.room&&!e.room.active&&e.room.entered&&(e.lightSource.b=0,e.lightSource.r=0,e.room.updateLighting())}this.active=!1,this.updateLighting(),this.particles.splice(0,this.particles.length),this.disableFuseSounds()},this.disableFuseSounds=()=>{for(const t of this.entities.filter(t=>t instanceof ot.Bomb)){const e=t;at.Sound.stopSound(e.fuseSound)}},this.enableFuseSounds=()=>{for(const t of this.entities.filter(t=>t instanceof ot.Bomb)){const e=t;e.lit&&at.Sound.playWithReverb(e.fuseSound)}},this.onEnterRoom=t=>{this.enableFuseSounds();for(let e of this.level.rooms)e.roomOnScreen(t);this.entered=!0,this.clearDeadStuff(),this.calculateWallInfo(),this.resetDoorLightSources(),this.particles=[],this.syncKeyPathParticles(),this.alertEnemiesOnEntry(),this.message=this.name,this.setReverb(),this.active=!0,t.map.saveMapData(),this.updateLighting()},this.enterLevel=(t,e)=>{this.game.updateLevel(this);const i=this.game.transitioningLadder;let s=this.__entryPositionFromLadder;const o=s?{...s}:void 0;s&&delete this.__entryPositionFromLadder;let a=s||e||this.getRoomCenter();this.roomArray[a.x][a.y].isSolid()&&(a=this.getRandomEmptyPosition(this.getEmptyTiles()));let r=a.x,n=a.y;if(!e&&!s){let t=!1;if(i instanceof I.DownLadder){const e=i.entryUpLadderPos??this.findPrimaryUpLadderCoords();e&&(r=e.x,n=e.y,t=!0)}if(!t)for(let e=this.roomX;e<this.roomX+this.width;e++){for(let i=this.roomY;i<this.roomY+this.height;i++){const s=this.roomArray[e]?.[i];if(s instanceof I.DownLadder&&!s.lockable.isLocked()){r=s.x,n=s.y,t=!0;break}}if(t)break}}t.moveSnap(r,n);const h=t.getOxygenLine(),l=h?.isDisconnectedFromPlayer()??!1;if(l||t.anchorOxygenLineToPlayer(-Math.PI/2),this.onEnterRoom(t),this.playMusic(),i instanceof I.DownLadder)if(this.underwater){const e=o??this.findPrimaryUpLadderCoords();e?l||h?.isAttached?.()||(t.attachOxygenLine(this,e.x,e.y,{kind:"upLadder",angle:Math.PI/2}),t.anchorOxygenLineToPlayer(-Math.PI/2)):l||t.detachOxygenLine()}else l||t.detachOxygenLine();else l||!(i instanceof T.UpLadder)&&this.underwater||t.detachOxygenLine();l||h?.update(!0)},this.enterLevelThroughDoor=(t,e,i)=>{e.doorDir===e.linkedDoor.doorDir&&(e.opened=!0,t.moveSnap(e.x,e.y+1),setTimeout(()=>{t.direction=r.Direction.DOWN},150)),e instanceof n.Door&&e.doorDir===r.Direction.UP?(e.opened=!0,t.moveNoSmooth(e.x,e.y+1)):e instanceof n.Door&&e.doorDir===r.Direction.DOWN?t.moveNoSmooth(e.x,e.y-1):e instanceof n.Door&&[r.Direction.RIGHT,r.Direction.LEFT].includes(e.doorDir)&&t.moveNoSmooth(e.x+i,e.y),this.onEnterRoom(t);const s=t.getOxygenLine();(s?.isDisconnectedFromPlayer()??!1)||(t.anchorOxygenLineToPlayer(-Math.PI/2),this.underwater||t.detachOxygenLine(),s?.update(!0)),this.updateOxygenLineBeams()},this.alertEnemiesOnEntry=()=>{for(const t of this.entities)t instanceof z.Enemy&&t.lookForPlayer(!1)},this.tick=t=>{const e=t.z;this.updateLighting(),t.updateSlowMotion(),this.syncKeyPathParticles(),this.lastEnemyCount=this.entities.filter(t=>t instanceof z.Enemy&&(t.z??0)===e).length;for(const t of this.hitwarnings)this.isWithinEnemyInteractionRange(t.x,t.y)&&t.tick();for(const t of this.projectiles)t.z===e&&t.tick();this.clearDeadStuff(),this.calculateWallInfo(),this.entities=this.entities.filter(t=>!t.dead);for(let t=this.roomX;t<this.roomX+this.width;t++)for(let e=this.roomY;e<this.roomY+this.height;e++)this.roomArray[t][e].tick();for(const t of this.entities)t.z===e&&t.shouldSeeThrough();this.turn=Lt.computerTurn,this.playerTurnTime=Date.now(),this.playerTicked=t,this.updateLighting(),t.map.saveMapData(),this.clearDeadStuff()},this.computerTurn=()=>{const t=this.playerTicked?.z??this.getActiveZ();for(const e of this.entities)e.z===t&&(e instanceof z.Enemy&&!this.isWithinEnemyInteractionRange(e.x,e.y)||e.tick());this.entities=this.entities.filter(t=>!t.dead);for(const e of this.entities)if(e.z===t&&e instanceof z.Enemy){if(!this.isWithinEnemyInteractionRange(e.x,e.y))continue;e.makeHitWarnings()}for(const e of this.items)e.z===t&&e.tick();for(const t in this.game.players)for(const e of this.game.players[t].inventory.items)e&&e.tick();for(const t of this.hitwarnings)this.isWithinEnemyInteractionRange(t.x,t.y)&&(this.roomArray[t.x]&&this.roomArray[t.x][t.y]&&!this.roomArray[t.x][t.y].isSolid()||(t.dead=!0),t.removeOverlapping());for(const e of this.projectiles)if(e.z===t){this.roomArray[e.x]&&this.roomArray[e.x][e.y]&&this.roomArray[e.x][e.y].isSolid()&&(e.dead=!0);for(const i in this.game.players)this.game.players[i].z===t&&this.game.players[i].getRoom?.()===this&&e.x===this.game.players[i].x&&e.y===this.game.players[i].y&&e.hitPlayer(this.game.players[i]);for(const i of this.entities)i.z===t&&e.x===i.x&&e.y===i.y&&e.hitEnemy(i)}for(let t=this.roomX;t<this.roomX+this.width;t++)for(let e=this.roomY;e<this.roomY+this.height;e++)this.roomArray[t][e].tickEnd();this.entities=this.entities.filter(t=>!t.dead),this.clearDeadStuff(),this.playerTicked.finishTick(),this.checkForNoEnemies(),this.turn=Lt.playerTurn,this.updateLighting();for(const e of this.entities)(e.z??0)===t&&e.shouldSeeThrough()},this.update=()=>{if(this.turn==Lt.computerTurn){const t=this.game.replayManager?.isReplaying?.()?u.GameConstants.REPLAY_COMPUTER_TURN_DELAY:o.LevelConstants.COMPUTER_TURN_DELAY;Date.now()-this.playerTurnTime>=t&&this.computerTurn()}},this.clearDeadStuff=()=>{this.deadEntities=this.deadEntities.filter(t=>t&&!t.dead),this.entities=this.entities.filter(t=>t&&!t.dead),this.projectiles=this.projectiles.filter(t=>t&&!t.dead),this.lightSources=this.lightSources.filter(t=>t&&!t.dead),this.hitwarnings=this.hitwarnings.filter(t=>t&&!t.dead),this.particles=this.particles.filter(t=>t&&!t.dead)},this.syncKeyPathParticles=(t,e)=>{let s=null,o=null;if(t&&e)s=t,o=e;else for(const t of Object.values(this.game.players)){for(const e of t.inventory.items)if(e instanceof St.Key&&e.showPath&&(null===e.depth&&(e.depth=t.depth),e.depth===t.depth)){s=e,o=t;break}if(s)break}if(!s||!o){let t=!1;for(const e of this.particles)"KeyPathParticle"===e.constructor?.name&&(e.dead=!0,t=!0);return}s.updatePathToDoor(o);const a=!0===s.showPath,r=this.keyPathDots;if(!r||0===r.length||!a){let t=!1;for(const e of this.particles)"KeyPathParticle"===e.constructor?.name&&(e.dead=!0,t=!0);return}const n=new Set((r||[]).map(t=>`${t.x},${t.y}`));for(const t of this.particles)if("KeyPathParticle"===t.constructor?.name){const e=`${Math.floor(t.x)},${Math.floor(t.y+.25)}`;n.has(e)||(t.dead=!0)}const h=(t,e)=>{if(!a)return!1;for(const i of this.particles)if("KeyPathParticle"===i.constructor?.name&&Math.floor(i.x)===t&&Math.floor(i.y+.25)===e&&!i.dead)return!0;return!1};for(const t of r)if(!h(t.x,t.y)){const e=new(i(3534).v)(t.x,t.y);e.room=this,this.particles.push(e),Math.random()<.1&&console.log(`Room.syncKeyPathParticles: spawned at (${t.x},${t.y})`)}},this.catchUp=()=>{this.turn===Lt.computerTurn&&this.computerTurn()},this.tickHitWarnings=()=>{for(const t of this.hitwarnings)t.parent&&(t.parent.dead||t.parent.unconscious)&&t.tick()},this.fadeLighting=t=>{const{minX:e,maxX:i,minY:s,maxY:o}=this.getVisibleTileBounds(2);for(let a=e;a<=i;a++)for(let e=s;e<=o;e++){let i=this.softVis[a][e]-this.vis[a][e],s=this.softVis[a][e],o=!1;Math.abs(i)>.01&&(o=!0),o&&(i*=.05*t,s-=i,s<0&&(s=0),s>1&&(s=1),this.softVis[a][e]=s)}},this.fadeRgb=t=>{const{minX:e,maxX:i,minY:s,maxY:o}=this.getVisibleTileBounds(2);for(let a=e;a<=i;a++)for(let e=s;e<=o;e++){const[i,s,o]=this.softCol[a][e],[r,n,h]=this.col[a][e];let l=i-r,c=s-n,d=o-h,m=!1,u=!1,p=!1;Math.abs(l)>.001&&(m=!0),Math.abs(c)>.001&&(u=!0),Math.abs(d)>.001&&(p=!0),(m||u||p)&&(m&&(l*=.05*t,this.softCol[a][e][0]=this.clamp(Math.round(i-l),0,255)),u&&(c*=.05*t,this.softCol[a][e][1]=this.clamp(Math.round(s-c),0,255)),p&&(d*=.05*t,this.softCol[a][e][2]=this.clamp(Math.round(o-d),0,255)))}},this.resetDoorLightSources=()=>{this.doors.forEach(t=>{t&&t.lightSource&&(t.lightSource.r=0),t&&t.linkedDoor&&t.linkedDoor.lightSource&&(t.linkedDoor.lightSource.r=0)})},this.tileValuesToLightSource=(t,e,i)=>i.roomArray[t]&&i.roomArray[t][e]?{color:i.col[t][e],brightness:(1-i.vis[t][e])/4,radius:9}:null,this.updateDoorLightSources=()=>{if(!this.active)return;const t={[r.Direction.UP]:{x:0,y:-1},[r.Direction.DOWN]:{x:0,y:1},[r.Direction.LEFT]:{x:1,y:0},[r.Direction.RIGHT]:{x:-1,y:0}};let e=[];this.doors.forEach(t=>{t.linkedDoor&&t.room.entered&&this.isTileOnScreen(t.linkedDoor.x,t.linkedDoor.y,o.LevelConstants.LIGHTING_MAX_DISTANCE)&&e.push(t.linkedDoor)}),this.doors.forEach(t=>{t.lightSource.b=.1});for(const i of e){const e=i.linkedDoor,s=t[e.doorDir]||{x:0,y:0},a=e.x-s.x,r=e.y-s.y;let n=this.tileValuesToLightSource(a,r,this);n||(n=this.tileValuesToLightSource(e.x,e.y,this)),n&&(i.lightSource.c=n.color,i.lightSource.b=n.brightness,i.lightSource.r=o.LevelConstants.LIGHTING_MAX_DISTANCE)}let i=new Set(this.doors.filter(t=>t&&t.linkedDoor).map(t=>t.linkedDoor.room).filter(t=>t));for(const t of Array.from(i))t.entered&&!t.isUpdatingLighting&&t.updateLighting()},this.setLightingAngleStep=()=>{if(!this.active)return;const t=this.width*this.height,e=Object.values(this.game.players||{}).filter(t=>t?.getRoom?.()===this).length,i=Math.ceil(360/o.LevelConstants.LIGHTING_ANGLE_STEP);let s=0;for(const t of this.lightSources)s+=Math.min(t.r,o.LevelConstants.LIGHTING_MAX_DISTANCE);s+=e*o.LevelConstants.LIGHTING_MAX_DISTANCE;const a=t+s*i;this.estimatedLightingTiles=a},this.updateLighting=t=>{if(!this.onScreen)return;if(t){const e=o.LevelConstants.LIGHTING_MAX_DISTANCE;if(!this.isTileOnScreen(t.x,t.y,e))return}if(this.isUpdatingLighting)return;this.isUpdatingLighting=!0,this.invalidateBlurCache(),this.updateDoorLightSources();let e=[],i=[];for(let t=this.roomX;t<this.roomX+this.width;t++){e[t]=[],i[t]=[];for(let s=this.roomY;s<this.roomY+this.height;s++)e[t][s]=this.vis[t][s],i[t][s]=this.col[t][s],this.vis[t][s]=1,this.col[t][s]=[1,1,1],this.renderBuffer[t][s]=[]}try{this.lightSources=this.lightSources.filter(t=>{const e=Math.floor(t.x),i=Math.floor(t.y);if(e<this.roomX-1||e>this.roomX+this.width||i<this.roomY-1||i>this.roomY+this.height)return!1;for(let t=-1;t<=1;t++)for(let s=-1;s<=1;s++)if(this.roomArray[e+t]?.[i+s])return!0;return!1})}catch{}if(u.GameConstants.ENEMIES_BLOCK_LIGHT){const t=new Set;for(const e of this.entities)if(e.opaque&&this.isTileOnScreen(e.x,e.y,7)){const i=Math.max(1,e.w||1),s=Math.max(1,e.h||1);for(let o=0;o<i;o++)for(let i=0;i<s;i++)t.add(`${e.x+o},${e.y+i}`)}this.opaqueEntityPositions=t}else this.opaqueEntityPositions=void 0;for(const t of this.lightSources)if(t.shouldUpdate())for(let e=0;e<360;e+=o.LevelConstants.LIGHTING_ANGLE_STEP)this.castTintAtAngle(e,t.x,t.y,t.r,t.c,t.b*o.LevelConstants.LIGHTING_ANGLE_BRIGHTNESS_COMPENSATION,t.falloffDecay);this.setLightingAngleStep();let s=o.LevelConstants.LIGHTING_ANGLE_STEP;for(const t in this.game.players){let e=this.game.players[t];if(e.getRoom?.()===this){let t=o.LevelConstants.AMBIENT_LIGHT_COLOR,i=5;e.lightEquipped&&(t=e.lightColor,i=e.lightBrightness);const a=this.getPlayerLightingFov(e),r=a<u.GameConstants.DEFAULT_LIGHTING_FOV_DEGREES?this.getPlayerFacingAngle(e):null;if(a<u.GameConstants.DEFAULT_LIGHTING_FOV_DEGREES&&null!==r)this.castDirectionalPlayerLight(e,r,a,s,t,i,e.lightFalloffDecay);else for(let a=0;a<360;a+=s)this.castTintAtAngle(a,e.x+.5,e.y+.5,o.LevelConstants.LIGHTING_MAX_DISTANCE,t,i*o.LevelConstants.LIGHTING_ANGLE_BRIGHTNESS_COMPENSATION,e.lightFalloffDecay)}}const a=this.roomX,r=this.roomY,n=this.width,h=this.height,l=this.renderBuffer;for(let t=a;t<a+n;t++)for(let e=r;e<r+h;e++)this.col[t][e]=this.blendColorsArray(l[t][e]);for(let t=a;t<a+n;t++)for(let e=r;e<r+h;e++)this.vis[t][e]=this.rgbToLuminance(this.col[t][e]);this.updateDoorLightSources(),this.lastLightingUpdate++,this.isUpdatingLighting=!1},this.castDirectionalPlayerLight=(t,e,i,s,a,r,n)=>{const h=t.x+.5,l=t.y+.5,c=i/2,d=Math.max(i,s);for(let t=0;t<=d;t+=s){const i=this.normalizeDegrees(e-c+t);this.castTintAtAngle(i,h,l,o.LevelConstants.LIGHTING_MAX_DISTANCE,a,r*o.LevelConstants.LIGHTING_ANGLE_BRIGHTNESS_COMPENSATION,n)}},this.getPlayerLightingFov=t=>u.GameConstants.NARROWED_LIGHTING_FOV&&this.underwater&&!t.dead?u.GameConstants.UNDERWATER_LIGHTING_FOV_DEGREES:t.lightEquipped&&"number"==typeof t.lightFov?t.lightFov:u.GameConstants.DEFAULT_LIGHTING_FOV_DEGREES,this.getPlayerFacingAngle=t=>{const e=this.getMouseFacingAngle(t);return null!==e?e:this.directionToDegrees(t.direction)},this.getMouseFacingAngle=t=>{const e=t.inputHandler;if(!e||"mouse"!==e.mostRecentMoveInput||u.GameConstants.isMobile||!u.GameConstants.MOVE_WITH_MOUSE)return null;const i=this.normalizeDegrees(180*e.mouseAngle()/Math.PI);return 45*this.getOctantFromAngle(i)},this.directionToDegrees=t=>{switch(t){case r.Direction.RIGHT:return 0;case r.Direction.DOWN_RIGHT:return 45;case r.Direction.DOWN:return 90;case r.Direction.DOWN_LEFT:return 135;case r.Direction.LEFT:return 180;case r.Direction.UP_LEFT:return 225;case r.Direction.UP:return 270;case r.Direction.UP_RIGHT:return 315;default:return null}},this.getOctantFromAngle=t=>{const e=this.normalizeDegrees(t);return Math.floor((e+22.5)/45)%8},this.normalizeDegrees=t=>{const e=t%360;return e<0?e+360:e},this.updateLightSources=(t,e)=>{if(!t||!1!==this.isTileOnScreen(t.x,t.y,o.LevelConstants.LIGHTING_MAX_DISTANCE)){if(this.oldCol=[],this.oldVis=[],this.oldCol=this.col,this.oldVis=this.vis,t)for(let i=0;i<360;i+=o.LevelConstants.LIGHTING_ANGLE_STEP)e?this.unCastTintAtAngle(i,t.x,t.y,t.r,t.c,t.b*o.LevelConstants.LIGHTING_ANGLE_BRIGHTNESS_COMPENSATION,t.falloffDecay):this.castTintAtAngle(i,t.x,t.y,t.r,t.c,t.b*o.LevelConstants.LIGHTING_ANGLE_BRIGHTNESS_COMPENSATION,t.falloffDecay);for(let t=this.roomX;t<this.roomX+this.width;t++)for(let e=this.roomY;e<this.roomY+this.height;e++)this.col[t][e]=this.blendColorsArray(this.renderBuffer[t][e]);for(let t=this.roomX;t<this.roomX+this.width;t++)for(let e=this.roomY;e<this.roomY+this.height;e++)this.vis[t][e]=this.rgbToLuminance(this.col[t][e])}},this.revertLightSources=()=>{this.oldCol=[],this.oldVis=[],this.col=this.oldCol,this.vis=this.oldVis},this.processTintAtAngle=(t,e,i,a,r,n,h=1,l="cast")=>{const c=Math.cos(t*Math.PI/180),d=Math.sin(t*Math.PI/180),m=[this.sRGBToLinear(r[0]),this.sRGBToLinear(r[1]),this.sRGBToLinear(r[2])];for(let t=0;t<=Math.min(o.LevelConstants.LIGHTING_MAX_DISTANCE,a);t++){const o=Math.floor(e+c*t),a=Math.floor(i+d*t);if(!this.isPositionInRoom(o,a))return;const r=this.roomArray[o][a];let p;if(p=0===t?.1*n:n*Math.exp(-h*(t-.25)),p<.005&&(p=0),p<=0)continue;if(this.renderBuffer[o]||(this.renderBuffer[o]=[]),this.renderBuffer[o][a]||(this.renderBuffer[o][a]=[]),r instanceof s.Wall&&r.isInnerWall()){const t=[m[0],m[1],m[2],p];return void("cast"===l?this.renderBuffer[o][a].push(t):"unCast"===l&&(this.renderBuffer[o][a]=this.renderBuffer[o][a].filter(e=>!(Math.abs(e[0]-t[0])<1e-4&&Math.abs(e[1]-t[1])<1e-4&&Math.abs(e[2]-t[2])<1e-4&&Math.abs(e[3]-t[3])<1e-4))))}if(u.GameConstants.ENEMIES_BLOCK_LIGHT&&this.opaqueEntityPositions&&this.opaqueEntityPositions.has(`${o},${a}`)){const t=[m[0],m[1],m[2],p];return void("cast"===l?this.renderBuffer[o][a].push(t):"unCast"===l&&(this.renderBuffer[o][a]=this.renderBuffer[o][a].filter(e=>!(Math.abs(e[0]-t[0])<1e-4&&Math.abs(e[1]-t[1])<1e-4&&Math.abs(e[2]-t[2])<1e-4&&Math.abs(e[3]-t[3])<1e-4))))}const y=[m[0],m[1],m[2],p];"cast"===l?this.renderBuffer[o][a].push(y):"unCast"===l&&(this.renderBuffer[o][a]=this.renderBuffer[o][a].filter(t=>!(Math.abs(t[0]-y[0])<1e-4&&Math.abs(t[1]-y[1])<1e-4&&Math.abs(t[2]-y[2])<1e-4&&Math.abs(t[3]-y[3])<1e-4)))}},this.castTintAtAngle=(t,e,i,s,o,a,r=1)=>{this.processTintAtAngle(t,e,i,s,o,a/3,r,"cast")},this.unCastTintAtAngle=(t,e,i,s,o,a,r=1)=>{this.processTintAtAngle(t,e,i,s,o,a/3,r,"unCast")},this.sRGBToLinear=t=>{const e=t/255;return e<=.04045?e/12.92:Math.pow((e+.055)/1.055,2.2)},this.linearToSRGB=t=>t<=.0031308?Math.round(12.92*t*255):Math.round(255*(1.055*Math.pow(t,1/2.2)-.055)),this.clamp=(t,e=0,i=1)=>Math.min(Math.max(t,e),i),this.blendColorsArray=t=>{if(0===t.length)return[0,0,0];const e=t.reduce((t,e)=>[t[0]+e[0]*e[3],t[1]+e[1]*e[3],t[2]+e[2]*e[3]],[0,0,0]),i=1.125,s=[e[0]*i,e[1]*i,e[2]*i],o=[this.clamp(s[0],0,1),this.clamp(s[1],0,1),this.clamp(s[2],0,1)];return[this.linearToSRGB(o[0]),this.linearToSRGB(o[1]),this.linearToSRGB(o[2])]},this.rgbToLuminance=t=>1-(.299*t[0]+.587*t[1]+.114*t[2])/255,this.draw=t=>{this.onScreen&&(this.active?(b.HitWarning.updateFrame(t),this.drawInterval=4):this.active||(this.drawInterval=8),this.drawTimestamp+=t,this.drawTimestamp-this.lastDraw>=this.drawInterval&&(this.fadeRgb(t+this.drawInterval),this.fadeLighting(t+this.drawInterval),this.lastDraw=this.drawTimestamp))},this.drawColorLayer=()=>{if(!this.onScreen)return;r.Game.ctx.save(),this.colorOffscreenCtx.clearRect(0,0,this.colorOffscreenCanvas.width,this.colorOffscreenCanvas.height);let t="";const e=this.blurOffsetX,i=this.blurOffsetY,{minX:s,maxX:o,minY:a,maxY:n}=this.getVisibleTileBounds(3);for(let r=s;r<=o;r++)for(let s=a;s<=n;s++){const[o,a,n]=this.softCol[r][s];if(0===o&&0===a&&0===n)continue;const h=`rgba(${o}, ${a}, ${n}, 1)`;h!==t&&(this.colorOffscreenCtx.fillStyle=h,t=h),this.colorOffscreenCtx.fillRect((r-this.roomX+e)*u.GameConstants.TILESIZE,(s-this.roomY+i)*u.GameConstants.TILESIZE,u.GameConstants.TILESIZE,u.GameConstants.TILESIZE)}if(u.GameConstants.USE_WEBGL_BLUR){const t=yt.WebGLBlurRenderer.getInstance();if(this.shouldUseBlurCache()&&this.blurCache.color6px&&this.blurCache.color12px)r.Game.ctx.globalCompositeOperation="soft-light",r.Game.ctx.globalAlpha=.6,r.Game.ctx.drawImage(this.blurCache.color6px,(this.roomX-e)*u.GameConstants.TILESIZE,(this.roomY-i)*u.GameConstants.TILESIZE),r.Game.ctx.globalCompositeOperation="lighten",r.Game.ctx.globalAlpha=.05,r.Game.ctx.drawImage(this.blurCache.color12px,(this.roomX-e)*u.GameConstants.TILESIZE,(this.roomY-i)*u.GameConstants.TILESIZE);else{r.Game.ctx.globalCompositeOperation="soft-light",r.Game.ctx.globalAlpha=.6;const s=t.applyBlur(this.colorOffscreenCanvas,8);r.Game.ctx.drawImage(s,(this.roomX-e)*u.GameConstants.TILESIZE,(this.roomY-i)*u.GameConstants.TILESIZE),this.active||this.cacheBlurResult("color8px",s),r.Game.ctx.globalCompositeOperation="lighten",r.Game.ctx.globalAlpha=.05;const o=t.applyBlur(this.colorOffscreenCanvas,12);r.Game.ctx.drawImage(o,(this.roomX-e)*u.GameConstants.TILESIZE,(this.roomY-i)*u.GameConstants.TILESIZE),this.active||this.cacheBlurResult("color12px",o)}}else r.Game.ctx.globalCompositeOperation=u.GameConstants.COLOR_LAYER_COMPOSITE_OPERATION,r.Game.ctx.globalAlpha=.6,u.GameConstants.ctxBlurEnabled&&(r.Game.ctx.filter="blur(6px)"),r.Game.ctx.drawImage(this.colorOffscreenCanvas,(this.roomX-e)*u.GameConstants.TILESIZE,(this.roomY-i)*u.GameConstants.TILESIZE),r.Game.ctx.globalCompositeOperation="lighten",r.Game.ctx.globalAlpha=.05,u.GameConstants.ctxBlurEnabled&&(r.Game.ctx.filter="blur(12px)"),r.Game.ctx.drawImage(this.colorOffscreenCanvas,(this.roomX-e)*u.GameConstants.TILESIZE,(this.roomY-i)*u.GameConstants.TILESIZE),r.Game.ctx.filter="none";this.colorOffscreenCtx.clearRect(0,0,this.colorOffscreenCanvas.width,this.colorOffscreenCanvas.height),r.Game.ctx.restore()},this.drawShadeLayer=()=>{if(u.GameConstants.isIOS||!u.GameConstants.SHADE_ENABLED)return;if(u.GameConstants.SHADE_INLINE_IN_ENTITY_LAYER)return;if(!this.onScreen)return;if(u.GameConstants.SHADING_DISABLED)return;r.Game.ctx.save(),r.Game.ctx.globalCompositeOperation=u.GameConstants.SHADE_LAYER_COMPOSITE_OPERATION,this.shadeOffscreenCtx.clearRect(0,0,this.shadeOffscreenCanvas.width,this.shadeOffscreenCanvas.height);const t=this.shadeSliceBorderTiles,e=this.shadeSliceBorderTiles;let i="";for(let o=this.roomX-2;o<this.roomX+this.width+4;o++)for(let a=this.roomY-2;a<this.roomY+this.height+4;a++){if(!this.isTileOnScreen(o,a,4))continue;const h=this.roomArray[o]?.[a];let l=this.softVis[o]&&this.softVis[o][a]?this.softVis[o][a]:0;if(h instanceof O.WallTorch)continue;let c=l**(u.GameConstants.SMOOTH_LIGHTING,2)*(u.GameConstants.SMOOTH_LIGHTING?1:0),d=o,m=a,p=1,y=1;if(h instanceof s.Wall){const t=h;if(!this.innerWalls.includes(t))switch(t.direction){case r.Direction.UP:m=a-.5,y=.5;break;case r.Direction.DOWN:m=a-.5,y=1.5;break;case r.Direction.LEFT:d=o+.25,p=.75;break;case r.Direction.RIGHT:d=o,p=.75;break;case r.Direction.DOWN_LEFT:d=o+.25,m=a-.5,p=.75,y=1.5;break;case r.Direction.DOWN_RIGHT:d=o,m=a-.5,p=.75,y=1.5;break;case r.Direction.UP_LEFT:d=o+.25,m=a-.5,p=.75,y=.5;break;case r.Direction.UP_RIGHT:d=o-.5,m=a-.5,p=.75,y=.5}}else if(h instanceof n.Door){const t=h;switch(!0===t.opened&&(c/=2),t.doorDir){case r.Direction.UP:case r.Direction.DOWN:m=a-.5,y=1.5;break;case r.Direction.RIGHT:d=o-.5,m=a-1.25,p=1.5,y=2;break;case r.Direction.LEFT:d=o,m=a-1.25,p=1.5,y=2}}const g=`rgba(0, 0, 0, ${c*(u.GameConstants.SMOOTH_LIGHTING?1.25:.5)})`;g!==i&&(this.shadeOffscreenCtx.fillStyle=g,i=g),this.shadeOffscreenCtx.fillRect((d-this.roomX+t)*u.GameConstants.TILESIZE,(m-this.roomY+e)*u.GameConstants.TILESIZE,p*u.GameConstants.TILESIZE,y*u.GameConstants.TILESIZE)}if(u.GameConstants.USE_WEBGL_BLUR){const i=yt.WebGLBlurRenderer.getInstance();if(this.shouldUseBlurCache()&&this.blurCache.shade5px)r.Game.ctx.globalAlpha=1,r.Game.ctx.drawImage(this.blurCache.shade5px,(this.roomX-t)*u.GameConstants.TILESIZE,(this.roomY-e)*u.GameConstants.TILESIZE);else{r.Game.ctx.globalAlpha=1;const s=i.applyBlur(this.shadeOffscreenCanvas,5);r.Game.ctx.drawImage(s,(this.roomX-t)*u.GameConstants.TILESIZE,(this.roomY-e)*u.GameConstants.TILESIZE),this.active||this.cacheBlurResult("shade5px",s)}}else{r.Game.ctx.globalAlpha=1;const i=(u.GameConstants.SMOOTH_LIGHTING,5);u.GameConstants.ctxBlurEnabled&&(r.Game.ctx.filter=`blur(${i}px)`),r.Game.ctx.drawImage(this.shadeOffscreenCanvas,(this.roomX-t)*u.GameConstants.TILESIZE,(this.roomY-e)*u.GameConstants.TILESIZE),r.Game.ctx.filter="none"}r.Game.ctx.restore()},this.buildShadeOffscreenForSlicing=()=>{this.shadeOffscreenCtx.clearRect(0,0,this.shadeOffscreenCanvas.width,this.shadeOffscreenCanvas.height);const t=this.blurOffsetX,e=this.blurOffsetY;let i="";const{minX:o,maxX:a,minY:h,maxY:l}=this.getVisibleTileBounds(4);for(let c=Math.max(this.roomX-2,o);c<=Math.min(this.roomX+this.width+3,a);c++)for(let o=Math.max(this.roomY-2,h);o<=Math.min(this.roomY+this.height+3,l);o++){const a=this.roomArray[c]?.[o];let h=this.softVis[c]&&this.softVis[c][o]?this.softVis[c][o]:0;if(a instanceof O.WallTorch)continue;let l=h**(u.GameConstants.SMOOTH_LIGHTING?1:2)*(u.GameConstants.SMOOTH_LIGHTING?1:0),d=c,m=o,p=1,y=1;if(a instanceof s.Wall){const t=a;if(!this.innerWalls.includes(t))switch(t.direction){case r.Direction.UP:m=o-.5,y=.5;break;case r.Direction.DOWN:m=o-.5,y=1.5;break;case r.Direction.LEFT:d=c+.25,p=.75;break;case r.Direction.RIGHT:d=c,p=.75;break;case r.Direction.DOWN_LEFT:d=c+.25,m=o-.5,p=.75,y=1.5;break;case r.Direction.DOWN_RIGHT:d=c,m=o-.5,p=.75,y=1.5;break;case r.Direction.UP_LEFT:d=c+.25,m=o-.5,p=.75,y=.5;break;case r.Direction.UP_RIGHT:d=c-.5,m=o-.5,p=.75,y=.5}}else if(a instanceof n.Door){const t=a;if(!0===t.opened)switch(l/=2,t.doorDir){case r.Direction.UP:m=o-1.5,y=1.5,p=2,d=c-.5;break;case r.Direction.DOWN:m=o-.5,y=1.5,p=2,d=c-.5;break;case r.Direction.RIGHT:d=c-2,m=o-2,p=3,y=3;break;case r.Direction.LEFT:d=c,m=o-2,p=3,y=3}else switch(t.doorDir){case r.Direction.UP:m=o-.5,y=1.5;break;case r.Direction.DOWN:m=o-1,y=3,p=3,d=c-.5;break;case r.Direction.RIGHT:d=c-2,m=o-2,p=3,y=3;break;case r.Direction.LEFT:d=c,m=o-2,p=3,y=3}}const g=`rgba(0, 0, 0, ${l*(u.GameConstants.SMOOTH_LIGHTING?1:.5)})`;g!==i&&(this.shadeOffscreenCtx.fillStyle=g,i=g),m+=1,d+=1,this.shadeOffscreenCtx.fillRect((d-this.roomX+t)*u.GameConstants.TILESIZE,(m-this.roomY+e)*u.GameConstants.TILESIZE,p*u.GameConstants.TILESIZE,y*u.GameConstants.TILESIZE)}},this.getBlurredShadeSourceForSlicing=()=>{if(u.GameConstants.USE_WEBGL_BLUR){const t=yt.WebGLBlurRenderer.getInstance();if(this.shouldUseBlurCache()&&this.blurCache.shade5px)return this.blurCache.shade5px;{const e=t.applyBlur(this.shadeOffscreenCanvas,8);return this.active||this.cacheBlurResult("shade5px",e),e}}{this.shadeBlurTempCanvas||(this.shadeBlurTempCanvas=document.createElement("canvas"),this.shadeBlurTempCanvas.width=this.shadeOffscreenCanvas.width,this.shadeBlurTempCanvas.height=this.shadeOffscreenCanvas.height,this.shadeBlurTempCtx=this.shadeBlurTempCanvas.getContext("2d"));const t=this.shadeBlurTempCtx;return t.clearRect(0,0,this.shadeBlurTempCanvas.width,this.shadeBlurTempCanvas.height),u.GameConstants.ctxBlurEnabled?t.filter="blur(5px)":t.filter="none",t.drawImage(this.shadeOffscreenCanvas,0,0),t.filter="none",this.shadeBlurTempCanvas}},this.drawShadeSliceForTile=(t,e,i,s)=>{const o=u.GameConstants.TILESIZE,a=(e+1-this.roomX+this.blurOffsetX)*o,n=(i+1-this.roomY+this.blurOffsetY)*o,h=e*o,l=i*o;if(!s)return void r.Game.ctx.drawImage(t,a,n,o,o,h,l,o,o);this.shadeSliceTempCanvas||(this.shadeSliceTempCanvas=document.createElement("canvas"),this.shadeSliceTempCanvas.width=o,this.shadeSliceTempCanvas.height=o,this.shadeSliceTempCtx=this.shadeSliceTempCanvas.getContext("2d"));const c=this.shadeSliceTempCtx;c.clearRect(0,0,o,o),c.globalCompositeOperation="source-over",c.drawImage(t,a,n,o,o,0,0,o,o);let d=null;"right"===s?(d=c.createLinearGradient(0,0,o,0),d.addColorStop(0,"rgba(0,0,0,0)"),d.addColorStop(1,"rgba(0,0,0,1)")):"left"===s?(d=c.createLinearGradient(0,0,o,0),d.addColorStop(0,"rgba(0,0,0,1)"),d.addColorStop(1,"rgba(0,0,0,0)")):"up"===s?(d=c.createLinearGradient(0,0,0,o),d.addColorStop(0,"rgba(0,0,0,0)"),d.addColorStop(1,"rgba(0,0,0,1)")):"down"===s&&(d=c.createLinearGradient(0,0,0,o),d.addColorStop(0,"rgba(0,0,0,1)"),d.addColorStop(1,"rgba(0,0,0,0)")),d&&(c.globalCompositeOperation="destination-in",c.fillStyle=d,c.fillRect(0,0,o,o)),r.Game.ctx.drawImage(this.shadeSliceTempCanvas,h,l)},this.drawBloomLayer=t=>{if(!this.onScreen)return;r.Game.ctx.save(),this.bloomOffscreenCtx.clearRect(0,0,this.bloomOffscreenCanvas.width,this.bloomOffscreenCanvas.height);const e=this.blurOffsetX,i=this.blurOffsetY;if(this.entities.concat(this.deadEntities).length>0)for(let s of this.entities)s.hasBloom&&(s.updateBloom(t),this.bloomOffscreenCtx.globalAlpha=1*(1-this.softVis[s.x][s.y])*s.softBloomAlpha,this.bloomOffscreenCtx.fillStyle=s.bloomColor,this.bloomOffscreenCtx.fillRect((s.x-s.drawX-this.roomX+e+.5-s.bloomSize/2)*u.GameConstants.TILESIZE,(s.y-s.drawY-this.roomY-.5+i+.5-s.bloomSize/2)*u.GameConstants.TILESIZE+s.bloomOffsetY,u.GameConstants.TILESIZE*s.bloomSize,u.GameConstants.TILESIZE*s.bloomSize));for(const s in this.game.players){const o=this.game.players[s];if(o.getRoom()!==this)continue;const[a,r,n]=this.softCol[o.x][o.y]||[255,255,255];o.bloomColor=`rgba(${a}, ${r}, ${n}, 1)`,o.bloomAlpha=.5,o.updateBloom(t),this.bloomOffscreenCtx.globalAlpha=o.softBloomAlpha,this.bloomOffscreenCtx.fillStyle=o.bloomColor,this.bloomOffscreenCtx.fillRect((o.x-o.drawX-this.roomX+e)*u.GameConstants.TILESIZE,(o.y-o.drawY-this.roomY+i-.5)*u.GameConstants.TILESIZE,u.GameConstants.TILESIZE,u.GameConstants.TILESIZE)}const{minX:s,maxX:o,minY:a,maxY:n}=this.getVisibleTileBounds(4);for(let r=s;r<=o;r++)for(let s=a;s<=n;s++)this.roomArray[r][s].hasBloom&&(this.roomArray[r][s].updateBloom(t),this.bloomOffscreenCtx.globalAlpha=1*(1-this.softVis[r][s])*this.roomArray[r][s].softBloomAlpha,this.bloomOffscreenCtx.fillStyle=this.roomArray[r][s].bloomColor,this.bloomOffscreenCtx.fillRect((r-this.roomX+e)*u.GameConstants.TILESIZE,(s-this.roomY-.25+i-this.roomArray[r][s].bloomOffsetY)*u.GameConstants.TILESIZE,u.GameConstants.TILESIZE,.75*u.GameConstants.TILESIZE));if(this.projectiles.length>0)for(let s of this.projectiles)s.hasBloom&&(s.updateBloom(t),this.bloomOffscreenCtx.globalAlpha=1*(1-this.softVis[s.x][s.y])*s.softBloomAlpha,this.bloomOffscreenCtx.fillStyle=s.bloomColor,this.bloomOffscreenCtx.fillRect((s.x-this.roomX+e)*u.GameConstants.TILESIZE,(s.y-this.roomY+i+s.bloomOffsetY)*u.GameConstants.TILESIZE,u.GameConstants.TILESIZE,u.GameConstants.TILESIZE));if(u.GameConstants.USE_WEBGL_BLUR){const t=yt.WebGLBlurRenderer.getInstance();if(this.shouldUseBlurCache()&&this.blurCache.bloom8px)r.Game.ctx.globalCompositeOperation="screen",r.Game.ctx.globalAlpha=1,r.Game.ctx.drawImage(this.blurCache.bloom8px,(this.roomX-e)*u.GameConstants.TILESIZE,(this.roomY-i)*u.GameConstants.TILESIZE);else{r.Game.ctx.globalCompositeOperation="screen",r.Game.ctx.globalAlpha=1;const s=t.applyBlur(this.bloomOffscreenCanvas,8);r.Game.ctx.drawImage(s,(this.roomX-e)*u.GameConstants.TILESIZE,(this.roomY-i)*u.GameConstants.TILESIZE),this.active||this.cacheBlurResult("bloom8px",s)}}else r.Game.ctx.globalCompositeOperation="screen",r.Game.ctx.globalAlpha=1,u.GameConstants.ctxBlurEnabled&&(r.Game.ctx.filter="blur(8px)"),r.Game.ctx.drawImage(this.bloomOffscreenCanvas,(this.roomX-e)*u.GameConstants.TILESIZE,(this.roomY-i)*u.GameConstants.TILESIZE),r.Game.ctx.filter="none";this.bloomOffscreenCtx.fillStyle="rgba(0, 0, 0, 1)",this.bloomOffscreenCtx.fillRect(0,0,this.bloomOffscreenCanvas.width,this.bloomOffscreenCanvas.height),r.Game.ctx.restore()},this.drawEntities=(t,e)=>{if(!this.onScreen)return;if(this.particleCleanupAccumulator+=t,this.particleCleanupAccumulator>=10&&(this.particleCleanupAccumulator=0,this.particles.length>0)){let t=0;for(let e=0;e<this.particles.length;e++){const i=this.particles[e];i&&!i.dead&&(this.particles[t++]=i)}t!==this.particles.length&&(this.particles.length=t)}this.updateOxygenLineBeams(),r.Game.ctx.save();let i=u.GameConstants.SHADE_ENABLED&&u.GameConstants.SHADE_INLINE_IN_ENTITY_LAYER,o=null;i&&!u.GameConstants.SHADING_DISABLED&&(this.buildShadeOffscreenForSlicing(),o=this.getBlurredShadeSourceForSlicing());let l=[];const{minX:d,maxX:p,minY:y,maxY:g}=this.getVisibleTileBounds(3);for(let e=d;e<=p;e++)for(let i=y;i<=g;i++){const s=this.roomArray[e][i];s.drawUnderPlayer(t),l.push(s)}let f=new Array,E=new Array;E=E.concat(this.entities,this.deadEntities),f=f.concat(l,this.decorations,E,this.hitwarnings,this.projectiles,this.particles,this.items),f=f.filter(t=>{const e=t.x,i=t.y;if("number"!=typeof e||"number"!=typeof i)return!0;const s=Math.max(1,Math.ceil(t?.w||1)),o=Math.max(1,Math.ceil(t?.h||1));for(let t=0;t<s;t++)for(let s=0;s<o;s++)if(this.isTileOnScreen(e+t,i+s,3))return!0;return!1});for(const t in this.game.players)this.game.players[t].getRoom?.()===this&&(e&&this.game.players[t]===this.game.players[this.game.localPlayerID]||f.push(this.game.players[t]));f.sort((t,e)=>{if(t instanceof a.Floor||t instanceof m.SpawnFloor)return-1;if(e instanceof a.Floor||e instanceof m.SpawnFloor)return 1;if(t instanceof st.Decoration)return-1;if(e instanceof st.Decoration)return 1;if(Math.abs(t.drawableY-e.drawableY)<.1){const i=!0===t.shouldDrawAbovePlayer,s=!0===e.shouldDrawAbovePlayer;return t instanceof P.Player&&s?-1:e instanceof P.Player&&i||t instanceof P.Player?1:e instanceof P.Player?-1:t instanceof c.Entity?1:e instanceof c.Entity?-1:t instanceof w.Particle?1:e instanceof w.Particle?-1:0}return t.drawableY-e.drawableY});for(const e of f)if(e.draw(t),i&&o&&e instanceof h.Tile){const t=e.x,i=e.y;if((this.softVis[t]&&this.softVis[t][i]?this.softVis[t][i]:0)>0){const a=r.Game.ctx.globalCompositeOperation;a!==u.GameConstants.SHADE_LAYER_COMPOSITE_OPERATION&&(r.Game.ctx.globalCompositeOperation=u.GameConstants.SHADE_LAYER_COMPOSITE_OPERATION);const h=r.Game.ctx.globalAlpha;let l;if(r.Game.ctx.globalAlpha=1,e instanceof n.Door&&e.opened)switch(e.doorDir){case r.Direction.LEFT:l="left";break;case r.Direction.RIGHT:l="right";break;case r.Direction.UP:l=void 0;break;case r.Direction.DOWN:l="down"}else if(e instanceof s.Wall){const e=this.wallInfo.get(`${t},${i}`);if(e&&e.isBelowDoorWall){const e=this.roomArray[t]?.[i+1];e instanceof n.Door&&e.opened&&(e.doorDir===r.Direction.LEFT?l="left":e.doorDir===r.Direction.RIGHT&&(l="right"))}}this.drawShadeSliceForTile(o,t,i,l),r.Game.ctx.globalAlpha=h,a!==u.GameConstants.SHADE_LAYER_COMPOSITE_OPERATION&&(r.Game.ctx.globalCompositeOperation=a)}}this.drawAbovePlayer(t);for(const e of this.items)e.drawTopLayer(t);for(const t of f)t instanceof _t.Passageway&&t.drawFloodedCaveFX();r.Game.ctx.restore()},this.updateOxygenLineBeams=()=>{if(this.active)for(const t of Object.values(this.game.players)){if((t.getRoom?.()??this.game.levels[t.depth]?.rooms[t.levelID])!==this)continue;const e=t.getOxygenLine?.();if(e?.isDisconnectedFromPlayer?.())continue;const i=e?.getActiveTraversalIndex?.()??void 0,s=t.getInterpolatedTilePosition(),o=s.x,a=s.y-t.getOxygenAttachmentOffset();for(const e of this.projectiles)if(e instanceof tt.BeamEffect&&"oxygen-line"===e.type&&e.parent===t){const t="player"===e.startAttachment||this.isNear(e.x,e.y,o,a),s=void 0===e.oxygenTraversalIndex||e.oxygenTraversalIndex===i;t&&s&&(e.startAttachment="player",e.x=o,e.y=a)}}},this.drawAbovePlayer=t=>{for(let t=this.roomX;t<this.roomX+this.width;t++)for(let t=this.roomY;t<this.roomY+this.height;t++);},this.drawUnderwater=t=>{this.onScreen&&(this.underwater||(r.Game.ctx.save(),r.Game.ctx.globalCompositeOperation="source-over",r.Game.ctx.globalAlpha=.3,r.Game.ctx.fillStyle="#003B6F",r.Game.ctx.fillRect((this.roomX+.5)*u.GameConstants.TILESIZE,this.roomY*u.GameConstants.TILESIZE,(this.width-1)*u.GameConstants.TILESIZE,(this.height-.5)*u.GameConstants.TILESIZE),r.Game.ctx.restore()))},this.drawShade=t=>{if(!this.onScreen)return;r.Game.ctx.save();let e=0;for(const t in this.game.players){r.Game.ctx.globalCompositeOperation="source-over",r.Game.ctx.globalAlpha=1;const i=this.game.players[t];(i.getRoom?i.getRoom():this.level.rooms[i.levelID])===this&&i.defaultSightRadius>e&&(e=this.game.players[t].defaultSightRadius)}Math.max(0,Math.min(.8,2/e)),u.GameConstants.ALPHA_ENABLED&&(r.Game.ctx.globalAlpha=.25,r.Game.ctx.fillStyle=this.shadeColor,r.Game.ctx.fillRect(this.roomX*u.GameConstants.TILESIZE,(this.roomY-1)*u.GameConstants.TILESIZE,this.width*u.GameConstants.TILESIZE,(this.height+1)*u.GameConstants.TILESIZE),r.Game.ctx.globalAlpha=1,r.Game.ctx.globalCompositeOperation="source-over"),r.Game.ctx.restore()},this.shadeOpacity=()=>(this.active,.25),this.drawOverShade=t=>{r.Game.ctx.save();for(const e of this.entities)e.drawTopLayer(t);for(const e of this.projectiles)e.drawTopLayer(t);for(const e of this.hitwarnings)e.drawTopLayer(t);for(const e of this.particles)e.drawTopLayer(t);for(let e=this.roomX;e<this.roomX+this.width;e++)for(let i=this.roomY;i<this.roomY+this.height;i++)this.roomArray[e][i].drawAboveShading(t);for(const e of this.items)e.drawAboveShading(t);r.Game.ctx.restore()},this.drawTopLayer=t=>{r.Game.ctx.save();let e=r.Game.ctx.font;r.Game.ctx.font=u.GameConstants.SCRIPT_FONT_SIZE+"px Script",r.Game.ctx.fillStyle=o.LevelConstants.LEVEL_TEXT_COLOR,r.Game.fillText(this.message,u.GameConstants.WIDTH/2-r.Game.measureText(this.name).width/2,5),r.Game.ctx.font=e,r.Game.ctx.restore()},this.drawTopBeams=t=>{for(const e of this.projectiles)e instanceof tt.BeamEffect&&e.drawOnTop&&e.drawTopLayer(t)},this.hasTopBeams=()=>{for(const t of this.projectiles)if(t instanceof tt.BeamEffect&&t.drawOnTop)return!0;return!1},this.createWallMask=()=>{this.wallMaskCanvas||(this.wallMaskCanvas=document.createElement("canvas"),this.wallMaskCtx=this.wallMaskCanvas.getContext("2d"));const t=this.wallMaskCanvas;t.width=this.width*u.GameConstants.TILESIZE,t.height=this.height*u.GameConstants.TILESIZE;const e=this.wallMaskCtx;if(!e)throw new Error("Failed to create mask canvas context.");return e.fillStyle="rgba(255, 255, 255, 1)",e.fillRect(this.roomX*u.GameConstants.TILESIZE,this.roomY*u.GameConstants.TILESIZE,t.width,t.height),t},this.getExtremeLuminance=()=>{const t=[];for(let e=this.roomX;e<this.roomX+this.width;e++)for(let i=this.roomY;i<this.roomY+this.height;i++)this.vis[e]&&void 0!==this.vis[e][i]&&t.push({x:e,y:i,vis:this.vis[e][i]});return 0===t.length?{darkest:null,lightest:null}:(t.sort((t,e)=>t.vis-e.vis),{darkest:t[t.length-1],lightest:t[0]})},this.getExtremeLuminanceFromPoint=(t,e)=>{const i=[];return[{x:t,y:e-1},{x:t,y:e+1},{x:t-1,y:e},{x:t+1,y:e}].forEach(t=>{const{x:e,y:s}=t;this.vis[e]&&void 0!==this.vis[e][s]&&this.roomArray[e]&&this.roomArray[e][s]&&this.roomArray[e][s]instanceof a.Floor&&i.push({x:e,y:s,vis:this.vis[e][s]})}),0===i.length?{darkest:null,lightest:null}:(i.sort((t,e)=>t.vis-e.vis),{darkest:i[i.length-1],lightest:i[0]})},this.getAverageLuminance=()=>{let t=0,e=0;for(let i=this.roomX-2;i<=this.roomX+2;i++)if(this.roomArray[i]&&this.roomArray[i][this.roomY])for(let s=this.roomY-2;s<=this.roomY+2;s++)this.vis[i][s]&&(t+=this.vis[i][s],e++);return t/e},this.tileInside=(t,e)=>this.pointInside(t,e,this.roomX,this.roomY,this.width,this.height),this.getEmptyTiles=()=>{let t=[];for(let e=this.roomX+1;e<this.roomX+this.width-1;e++)for(let i=this.roomY+1;i<this.roomY+this.height-1;i++)this.roomArray[e][i].isSolid()||this.roomArray[e][i]instanceof E.SpikeTrap||this.roomArray[e][i]instanceof m.SpawnFloor||this.roomArray[e][i]instanceof T.UpLadder||this.roomArray[e][i]instanceof I.DownLadder||t.push(this.roomArray[e][i]);for(const e of this.entities)t=t.filter(t=>!e.pointIn(t.x,t.y));return t},this.getTile=(t,e)=>this.roomArray[t]?this.roomArray[t][e]:void 0,this.getBossDoor=()=>{for(const t of this.doors)if(t.linkedDoor.room.type===Pt.DOWNLADDER)return{x:t.x,y:t.y,doorDir:t.doorDir};return null},this.path=()=>{const t=new Set,e=[],i=[this];for(;i.length>0;){const s=i.shift();if(!s)continue;const o=s.globalId;if(o&&!t.has(o)){t.add(o),e.push(s);try{const e=s.doors;if(!e)continue;for(const s of e){const e=s?.linkedDoor,o=e&&e.room;if(o){const e=o.globalId;e&&!t.has(e)&&i.push(o)}}}catch{}}}return e},this.hasLadder=t=>{for(let e=this.roomX;e<this.roomX+this.width;e++)if(this.roomArray[e])for(let i=this.roomY;i<this.roomY+this.height;i++){const s=this.roomArray[e][i];if(s instanceof T.UpLadder&&"up"===t)return!0;if(s instanceof I.DownLadder&&"down"===t&&s.isSidePath)return!0}return!1},this.hasKey=()=>{for(const t of this.items)if(t instanceof St.Key)return!0;return!1},this.getDistanceToNearestLadder=t=>{const e=this;if(e.hasLadder(t))return 0;const i=new Set,s=[];for(i.add(e.globalId),s.push({room:e,dist:0});s.length>0;){const{room:e,dist:o}=s.shift();for(const a of e.doors){const e=a&&a.linkedDoor&&a.linkedDoor.room;if(!e)continue;const r=e.globalId;if(!i.has(r)){if(e.hasLadder(t))return o+1;i.add(r),s.push({room:e,dist:o+1})}}}return null},this.hasNoEnemies=()=>{const t=this.getActiveZ();return 0===this.entities.filter(e=>e instanceof z.Enemy&&(e.z??0)===t).length&&this.lastEnemyCount>0},this.roomCleared=()=>{const t=this.getActiveZ();return 0===this.entities.filter(e=>e instanceof z.Enemy&&(e.z??0)===t).length},this.hasHitwarning=(t,e)=>{for(const i of this.hitwarnings)if(i.x===t&&i.y===e&&!i.dead)return!0;return!1},this.hasEnemy=(t,e,i=this.getActiveZ())=>{for(const s of this.entities)if(s instanceof z.Enemy&&s.x===t&&s.y===e&&(s.z??0)===i)return!0;return!1},this.isTileEmpty=(t,e)=>{if(!this.roomArray[t]||!this.roomArray[t][e])return!1;const i=this.roomArray[t][e];if(i.isSolid())return!1;if(i instanceof E.SpikeTrap||i instanceof m.SpawnFloor||i instanceof T.UpLadder||i instanceof I.DownLadder)return!1;for(const i of this.entities)if(i.pointIn(t,e))return!1;return!0},this.hasEnemyInRadius=(t,e)=>{for(let i=-3;i<=3;i++)for(let s=-3;s<=3;s++)if(i*i+s*s<=9){const o=t+i,a=e+s;if(this.hasEnemy(o,a))return!0}return!1},this.checkForNoEnemies=()=>{if(this.hasNoEnemies()){const t=this.type===Pt.BOSS;let e=!1;this.doors.forEach(i=>{i.type===n.DoorType.GUARDEDDOOR&&(i.unGuard(t),e=!0,t&&this.game.startCameraAnimation(this.getBossDoor().x,this.getBossDoor().y,175))}),e&&this.game.pushMessage("The foes have been slain and the door allows you passage.")}},this.removeDoorObstructions=()=>{let t=[];for(const e of this.doors)for(const i of this.doors){if(e===i||null===e||null===i)continue;const s=this.findPath(e,i);s.length>0&&t.push(...s)}if(t.length>0)for(let e of t)this.entities=this.entities.filter(t=>t!==e),e=null},this.hasUpladder=()=>this.roomArray.some(t=>t.some(t=>t instanceof T.UpLadder)),this.findPath=(t,e,i)=>{let s=Array(),o=[];for(const t of this.entities)(t instanceof D.VendingMachine||t instanceof X.Rock||t instanceof y.Barrel||t instanceof g.Crate||t instanceof rt.Block||t instanceof W.TombStone||t instanceof x.PottedPlant)&&(s.push({x:t.x,y:t.y}),o.push(t));i&&s.push(...i);let a=[];for(let t=0;t<this.width;t++){a[t]=[];for(let e=0;e<this.height;e++){const i=this.roomX+t,s=this.roomY+e;this.roomArray[i]&&this.roomArray[i][s]?a[t][e]=this.roomArray[i][s]:a[t][e]=!1}}const r={x:t.x-this.roomX,y:t.y-this.roomY},n={x:e.x-this.roomX,y:e.y-this.roomY},h=s.map(t=>({x:t.x-this.roomX,y:t.y-this.roomY}));return 0===K.astar.AStar.search(a,r,n,h,!1,!1,!1).length?o:[]},this.wouldBlockDoor=(t,e)=>{if(this.doors.length<2)return!1;for(let i=0;i<this.doors.length;i++)for(let s=i+1;s<this.doors.length;s++){const o=this.doors[i],a=this.doors[s];if(!o||!a)continue;if(this.findPath(o,a).length>0)continue;const r=[{x:t,y:e}];if(this.findPath(o,a,r).length>0)return console.warn("DOOR WOULD BE BLOCKED!"),!0}return!1},this.getEmptyTilesNotBlockingDoors=()=>this.getEmptyTiles().filter(t=>!this.wouldBlockDoor(t.x,t.y)),this.findShortestDoorPathTo=(t,e=!0)=>{if(!t)return null;if(t===this)return[];try{const i=this,s=(t.globalId,i.pathId),o=[i],a=new Set,r=new Map,n=(t,e)=>{r.has(t)||r.set(t,e)},h=t=>t?.globalId,l=t=>!e||t.pathId===s,c=h(i);if(!c)return null;for(a.add(c),n(c,{prevRoomGID:null,viaDoor:null});o.length>0;){const e=o.shift();if(!e)continue;const i=h(e);if(!i)continue;if(e===t){const t=[];let e=i;for(;e&&e!==c;){const i=r.get(e);if(!i)break;i.viaDoor&&t.push(i.viaDoor),e=i.prevRoomGID||void 0}return t.reverse(),t}const s=e.doors;if(s)for(const t of s){const e=t?.linkedDoor?.room;if(!e)continue;if(!l(e))continue;const s=h(e);s&&!a.has(s)&&(a.add(s),n(s,{prevRoomGID:i,viaDoor:t}),o.push(e))}}return null}catch{return null}},this.buildTilePathPositions=(t,e,i,s)=>{const o=[];for(let t=0;t<this.width;t++){o[t]=[];for(let e=0;e<this.height;e++){const i=this.roomX+t,s=this.roomY+e;this.roomArray[i]&&this.roomArray[i][s]?o[t][e]=this.roomArray[i][s]:o[t][e]=!1}}const a={x:t-this.roomX,y:e-this.roomY},r={x:i-this.roomX,y:s-this.roomY};return K.astar.AStar.search(o,a,r,void 0,!1,!1,!1).map(t=>({x:t.pos.x+this.roomX,y:t.pos.y+this.roomY}))},this.addDoorWithOffset=(t,e,i=this,s=!1)=>{const o=(t,e)=>i.entities.some(i=>i instanceof D.VendingMachine&&i.x===t&&i.y===e);if(i.roomArray[t]?.[e]instanceof n.Door){let a=null;if(t===i.roomX?a=r.Direction.RIGHT:t===i.roomX+i.width-1?a=r.Direction.LEFT:e===i.roomY?a=r.Direction.DOWN:e===i.roomY+i.height-1&&(a=r.Direction.UP),!a)return null;const h=[];switch(a){case r.Direction.RIGHT:case r.Direction.LEFT:h.push({dx:0,dy:1},{dx:0,dy:-1})}const l=h.sort(()=>Y.Random.rand()-.5);if(o(t,e))return null;for(const a of l){const r=t+a.dx,h=e+a.dy;if(r>i.roomX&&r<i.roomX+i.width-1&&h>i.roomY&&h<i.roomY+i.height-1&&!(i.roomArray[r]?.[h]instanceof n.Door)&&!o(r,h))return i.addDoor(r,h,i,s)}return null}return o(t,e)?null:i.addDoor(t,e,i,s)},this.findPathToDoor=t=>{let e=Array();for(const t of this.entities)e.push({x:t.x,y:t.y});return K.astar.AStar.search(this.roomArray,this,t,[],!1,!1,!1)},this.pointExists=(t,e)=>this.roomArray[t]&&this.roomArray[t][e],this.invalidateBlurCache=()=>{this.blurCache.isValid=!1,this.blurCache.lastLightingUpdate=this.lastLightingUpdate},this.shouldUseBlurCache=()=>!this.active&&this.blurCache.isValid&&this.blurCache.lastLightingUpdate===this.lastLightingUpdate,this.getPlayer=()=>{for(const t in this.game.players)if(this.game.players[t].getRoom?.()===this)return this.game.players[t];return null},this.cacheBlurResult=(t,e)=>{if(!this.active){const i=document.createElement("canvas");i.width=e.width,i.height=e.height;const s=i.getContext("2d");s&&(s.drawImage(e,0,0),this.blurCache[t]=i,this.blurCache.isValid=!0,this.blurCache.lastLightingUpdate=this.lastLightingUpdate)}},this.globalId=wt.IdGenerator.generate("R"),this.pathId="main",this.game=t,this.roomX=l,this.roomY=d,this.width=p,this.height=f,this.type=S,this.depth=v,this.mapGroup=A,this.entered=!1,this.turn=Lt.playerTurn,this.playerTurnTime=Date.now(),this.items=Array(),this.projectiles=Array(),this.hitwarnings=Array(),this.particles=Array(),this.doors=Array(),this.entities=Array(),this.lightSources=Array(),this.innerWalls=Array(),this.level=M,this.id=0,this.currentSpawnerCount=0,this.deadEntities=Array(),this.active=!1,this.lastLightingUpdate=0,this.walls=Array(),this.decorations=Array(),this.underwater=R===et.EnvType.FLOODED_CAVE,this.colorOffscreenCanvas=document.createElement("canvas"),this.colorOffscreenCanvas.width=(this.width+10)*u.GameConstants.TILESIZE,this.colorOffscreenCanvas.height=(this.height+10)*u.GameConstants.TILESIZE;const G=this.colorOffscreenCanvas.getContext("2d");if(!G)throw new Error("Failed to initialize color offscreen canvas context.");this.colorOffscreenCtx=G,this.shadeOffscreenCanvas=document.createElement("canvas"),this.shadeOffscreenCanvas.width=(this.width+10)*u.GameConstants.TILESIZE,this.shadeOffscreenCanvas.height=(this.height+10)*u.GameConstants.TILESIZE;const L=this.shadeOffscreenCanvas.getContext("2d");if(!L)throw new Error("Failed to initialize shade offscreen canvas context.");this.shadeOffscreenCtx=L,this.bloomOffscreenCanvas=document.createElement("canvas"),this.bloomOffscreenCanvas.width=(this.width+10)*u.GameConstants.TILESIZE,this.bloomOffscreenCanvas.height=(this.height+10)*u.GameConstants.TILESIZE;const k=this.bloomOffscreenCanvas.getContext("2d");if(!k)throw new Error("Failed to initialize bloom offscreen canvas context.");this.bloomOffscreenCtx=k,this.roomArray=[];for(let t=this.roomX-1;t<this.roomX+this.width+1;t++){this.roomArray[t]=[];for(let e=this.roomY-1;e<this.roomY+this.height+1;e++)this.roomArray[t][e]=null}this.vis=[],this.softVis=[],this.col=[],this.softCol=[];for(let t=this.roomX;t<this.roomX+this.width;t++){this.vis[t]=[],this.softVis[t]=[],this.col[t]=[],this.softCol[t]=[];for(let e=this.roomY;e<this.roomY+this.height;e++)this.vis[t][e]=1,this.softVis[t][e]=1,this.col[t][e]=[0,0,0],this.softCol[t][e]=[0,0,0]}this.renderBuffer=[];for(let t=this.roomX;t<this.roomX+this.width;t++){this.renderBuffer[t]=[];for(let e=this.roomY;e<this.roomY+this.height;e++)this.renderBuffer[t][e]=[]}this.envType=R,this.skin=R,this.envType===et.EnvType.TUTORIAL&&(this.skin=h.SkinType.DUNGEON),this.builder=new ct.RoomBuilder(this)}addDoorTorches(t,e,i){if((i===r.Direction.UP||i===r.Direction.DOWN)&&t&&e){this.calculateWallInfo();const i=this.wallInfo.get(`${t-1},${e}`),s=this.wallInfo.get(`${t+1},${e}`),o=(this.roomArray[t-1],this.roomArray[t+1],!1===i?.isLeftWall),a=!1===s?.isRightWall;o&&(this.roomArray[t-1][e]=new O.WallTorch(this,t-1,e)),a&&(this.roomArray[t+1][e]=new O.WallTorch(this,t+1,e))}}addTorches(t,e,i,o){if(this.level.environment.type===et.EnvType.FOREST&&this.type!==Pt.DOWNLADDER)return;if(void 0!==i&&void 0!==o&&this.roomArray[i]?.[o]instanceof s.Wall)return void(this.roomArray[i][o]=new O.WallTorch(this,i,o));let a=[];for(let t=this.roomX+1;t<this.roomX+this.width-2;t++)for(let e=this.roomY;e<this.roomY+this.height-1;e++)this.roomArray[t][e]instanceof s.Wall&&!(this.roomArray[t][e+1]instanceof s.Wall)&&a.push(this.roomArray[t][e]);let n=[];for(let t=this.roomX+1;t<this.roomX+this.width-2;t++){const e=this.roomY+this.height-1;this.roomArray[t][e]instanceof s.Wall&&!(this.roomArray[t][e+1]instanceof s.Wall)&&n.push(this.roomArray[t][e])}const h=r.Game.rand(0,t,e),l=t-h;for(let t=0;t<h&&0!=a.length;t++){const t=r.Game.rand(0,a.length-1,e),i=a.splice(t,1)[0],s=i.x,o=i.y;this.roomArray[s][o]=new O.WallTorch(this,s,o)}for(let t=0;t<l&&0!=n.length;t++){const t=r.Game.rand(0,n.length-1,e),i=n.splice(t,1)[0],s=i.x,o=i.y;this.roomArray[s][o]=new O.WallTorch(this,s,o,!0)}}addChasms(t){let e=r.Game.rand(2,4,t),i=r.Game.rand(2,4,t),s=this.roomX+2,o=this.roomX+this.width-e-2,n=this.roomY+2,h=this.roomY+this.height-i-2;if(o<s||h<n)return;let l=r.Game.rand(s,o,t),c=r.Game.rand(n,h,t);for(let t=l-1;t<l+e+1;t++)for(let s=c-1;s<c+i+1;s++)t===l-1||t===l+e||s===c-1||s===c+i?this.roomArray[t][s]instanceof m.SpawnFloor||(this.roomArray[t][s]=new a.Floor(this,t,s)):this.roomArray[t][s]=new M.Chasm(this,t,s,t===l,t===l+e-1,s===c,s===c+i-1)}addSpikeTraps(t,e){if(this.level.environment.type===et.EnvType.FOREST||this.envType===et.EnvType.FOREST)return;let i=this.getEmptyTiles();for(let e=0;e<t;e++){const{x:t,y:e}=this.getRandomEmptyPosition(i);this.roomArray[t][e]=new E.SpikeTrap(this,t,e)}}addEnemies(t,e){if(!0===pt.GameplaySettings.NO_ENEMIES)return;this.envType===et.EnvType.FOREST&&(t/=2);let i=this.getEmptyTiles();if(null===i)return;const s=new Set;for(const t of this.doors)for(let e=-2;e<=2;e++)for(let i=-2;i<=2;i++)s.add(`${t.x+e},${t.y+i}`);i=i.filter(t=>!s.has(`${t.x},${t.y}`));for(let e=0;e<t;e++){if(0===i.length){console.warn("No tiles left to spawn enemies");break}let s=this.getRandomEmptyPosition(i);if(null===s.x||null===s.y){e=t;break}const{x:o,y:n}=s;let h=this.level.enemyParameters.enemyTables,c=this.level.enemyParameters.maxDepthTable,d=Math.min(this.depth,c);if(h[d]&&h[d].length>0){let e=e=>{for(let s=0;s<e.w;s++)for(let a=0;a<e.h;a++)if(!i.some(t=>t.x===o+s&&t.y===n+a))return t++,!1;this.entities.push(e);for(let t=0;t<e.w;t++)for(let s=0;s<e.h;s++)i=i.filter(e=>!(e.x===o+t&&e.y===n+s));return!0};switch(r.Game.randTable(h[d],Y.Random.rand)){case 1:L.CrabEnemy.add(this,this.game,o,n);break;case 2:j.FrogEnemy.add(this,this.game,o,n);break;case 3:k.ZombieEnemy.add(this,this.game,o,n);break;case 4:p.SkullEnemy.add(this,this.game,o,n);break;case 5:$.EnergyWizardEnemy.add(this,this.game,o,n);break;case 6:_.ChargeEnemy.add(this,this.game,o,n);break;case 7:J.RookEnemy.add(this,this.game,o,n);break;case 8:H.BishopEnemy.add(this,this.game,o,n);break;case 9:F.ArmoredzombieEnemy.add(this,this.game,o,n);break;case 10:if(e(new N.BigSkullEnemy(this,this.game,o,n)))for(let t=0;t<2;t++)for(let e=0;e<2;e++)this.roomArray[o+t][n+e]=new a.Floor(this,o+t,n+e);break;case 11:U.QueenEnemy.add(this,this.game,o,n);break;case 12:l.KnightEnemy.add(this,this.game,o,n);break;case 13:if(e(new V.BigKnightEnemy(this,this.game,o,n)))for(let t=0;t<2;t++)for(let e=0;e<2;e++)this.roomArray[o+t][n+e]=new a.Floor(this,o+t,n+e);break;case 14:nt.ArmoredSkullEnemy.add(this,this.game,o,n);break;case 15:q.FireWizardEnemy.add(this,this.game,o,n)}}}let o=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,2,2,2,2,2,2,2,3,3,4,5,3];if(this.depth>0){let t=r.Game.randTable(o,e);this.addSpawners(t,e)}let n=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];if(this.depth>1){let t=r.Game.randTable(n,e);this.addOccultists(t,e)}}addRandomEnemies(){let t=this.getEmptyTiles().length;const e=Math.min(.05*(this.depth+2),.3),i=Math.ceil(Math.max(gt.Utils.randomNormalInt(0,t*e),t*e));this.addEnemies(i,Y.Random.rand)}addSpawners(t,e){let i=this.getEmptyTiles();if(null!==i)for(let e=0;e<t;e++){const{x:t,y:e}=this.getRandomEmptyPosition(i);let s=this.level.populator.getEnemyPoolForDepth(Math.max(0,this.depth-1)).filter(t=>7!==t);return C.Spawner.add(this,this.game,t,e,s)}}addOccultists(t,e){let i=this.getEmptyTiles();if(null!==i)for(let e=0;e<t;e++){const{x:t,y:e}=this.getRandomEmptyPosition(i);return it.OccultistEnemy.add(this,this.game,t,e)}}addBosses(t){if(!0===pt.GameplaySettings.NO_ENEMIES)return;let e=this.getEmptyTiles();if(null===e)return;let i=["reaper","queen","bigskullenemy","bigzombieenemy"];t>0&&(i.push("occultist"),i.filter(t=>"queen"!==t));const s=r.Game.randTable(i,Y.Random.rand),{x:o,y:a}=s.startsWith("big")?this.getBigRandomEmptyPosition(e):this.getRandomEmptyPosition(e);switch(s){case"reaper":const t=this.addSpawners(1,Y.Random.rand);t.dropTable=["weapon","equipment"],t.dropChance=1;break;case"queen":const e=U.QueenEnemy.add(this,this.game,o,a);e.dropTable=["weapon","equipment"],e.dropChance=1;break;case"bigskullenemy":N.BigSkullEnemy.add(this,this.game,o,a).dropTable=["weapon","equipment","consumable","gem","tool"];break;case"occultist":const i=this.addOccultists(1,Y.Random.rand);i.dropTable=["weapon","equipment"],i.dropChance=1;break;case"bigzombieenemy":const s=dt.BigZombieEnemy.add(this,this.game,o,a);s.dropTable=["weapon","equipment","consumable","gem","tool"],s.dropChance=1}}addChests(t,e){let i=this.getEmptyTiles();for(let e=0;e<t;e++){const t=this.getRandomEmptyPosition(i);if(!t)break;const{x:e,y:s}=t;this.entities.push(new d.Chest(this,this.game,e,s))}}addBombs(t,e){let i=this.getEmptyTiles();for(let t=0;t<this.getEmptyTiles().length;t++){const{x:t,y:e}=this.getRandomEmptyPosition(i);ot.Bomb.add(this,this.game,t,e)}}addResources(t,e){let i=this.getEmptyTiles();for(let s=0;s<t;s++){const{x:t,y:s}=this.getRandomEmptyPosition(i);let o=e();o<=(10-this.depth**3)/10?S.CoalResource.add(this,this.game,t,s):o<=(10-(this.depth-2)**3)/10?v.GoldResource.add(this,this.game,t,s):A.EmeraldResource.add(this,this.game,t,s)}}addVendingMachine(t,e,i,s){if(this.height<=2||this.width<=2)return;const o=this.getRandomEmptyPosition(this.getEmptyTiles());let a=e||o.x,n=i||o.y,h=this.depth>0?[1,1,1,1,1,1,1,2,2,2,2,2,2,2,2,1,1,1,2,2,1,1,3,4,5,5,5,5,5,5,5,5,5,6,6,6,7,7,7]:[1,1,1],l=r.Game.randTable(h,t);if(s)D.VendingMachine.add(this,this.game,a,n,s);else switch(l){case 1:D.VendingMachine.add(this,this.game,a,n,new R.Heart(this,a,n));break;case 2:D.VendingMachine.add(this,this.game,a,n,new mt.Candle(this,a,n));break;case 3:D.VendingMachine.add(this,this.game,a,n,new f.Armor(this,a,n));break;case 4:D.VendingMachine.add(this,this.game,a,n,new G.Spear(this,a,n));break;case 5:D.VendingMachine.add(this,this.game,a,n,new Q.Torch(this,a,n));break;case 6:D.VendingMachine.add(this,this.game,a,n,new Dt.Backpack(this,a,n));break;case 7:D.VendingMachine.add(this,this.game,a,n,new B.Lantern(this,a,n));break;case 8:D.VendingMachine.add(this,this.game,a,n,new Ot.Coal(this,a,n))}}findPrimaryUpLadderCoords(){for(let t=this.roomX;t<this.roomX+this.width;t++)for(let e=this.roomY;e<this.roomY+this.height;e++){const i=this.roomArray[t]?.[e];if(i instanceof T.UpLadder)return{x:i.x,y:i.y}}}getActiveZ(){try{const t=this.game?.players?.[this.game?.localPlayerID];return t?.z??0}catch{return 0}}isWithinEnemyInteractionRange(t,e){try{const i=pt.GameplaySettings.MAXIMUM_ENEMY_INTERACTION_DISTANCE,s=this.game.players[this.game.localPlayerID];if(!s)return!0;const o=t-s.x,a=e-s.y;return o*o+a*a<=i*i}catch{return!0}}applyGaussianBlur(t,e){if(!t.getContext("2d"))throw new Error("Failed to get canvas context for Gaussian blur.");t.width,t.height;let i=e;u.GameConstants.BLUR_ENABLED||(i=0)}isNear(t,e,i,s,o=.05){return Math.abs(t-i)<=o&&Math.abs(e-s)<=o}calculateWallInfo(){this.wallInfo.clear(),this.walls&&(this.walls.length=0);for(let t=this.roomX;t<this.roomX+this.width;t++)for(let e=this.roomY;e<this.roomY+this.height;e++){const i=this.getTile(t,e);if(i instanceof s.Wall||i instanceof O.WallTorch){this.walls.push(i);const o=e===this.roomY,a=e===this.roomY+this.height-1,r=t===this.roomX,n=t===this.roomX+this.width-1,h=!(o||a||r||n),l=e<this.roomY+this.height-1&&this.getTile(t,e+1)?.isDoor,c=e<this.roomY+this.height-1&&this.getTile(t,e-1)?.isDoor,d=e<this.roomY+this.height&&this.getTile(t,e+1)?.isDoor;let m=null;if(h){const i=this.getTile(t,e-1)instanceof s.Wall,o=this.getTile(t,e+1)instanceof s.Wall,a=e===this.roomY+this.height-2;m=i||!o&&!a?!i||o||a?i&&(o||a)?"surroundedInner":"isolatedInner":"bottomInner":"topInner"}this.wallInfo.set(`${t},${e}`,{isTopWall:o,isBottomWall:a,isLeftWall:r,isRightWall:n,isInnerWall:h,isBelowDoorWall:l,isDoorWall:d,innerWallType:m,isAboveDoorWall:c,shouldDrawBottom:d||l||o&&!r&&!n||h})}}}pointInside(t,e,i,s,o,a){return!(t<i||t>=i+o||e<s||e>=s+a)}getRandomEmptyPosition(t,e){if(0===t.length)return null;const i=t.splice(r.Game.rand(0,t.length-1,Y.Random.rand),1)[0];return e&&i.x===e.x&&i.y===e.y?this.getRandomEmptyPosition(t,e):{x:i.x,y:i.y}}getBigRandomEmptyPosition(t){if(0===t.length)return null;const e=new Set(t.map(t=>`${t.x},${t.y}`)),i=t.filter(t=>e.has(`${t.x+1},${t.y}`)&&e.has(`${t.x},${t.y+1}`)&&e.has(`${t.x+1},${t.y+1}`));if(0===i.length)return null;const s=i[r.Game.rand(0,i.length-1,Y.Random.rand)];return{x:s.x,y:s.y}}getEmptyAreaPosition(t,e,i){if(!t||0===t.length)return null;if(e<=0||i<=0)return null;const s=new Set(t.map(t=>`${t.x},${t.y}`)),o=t.filter(t=>{if(t.x+e>this.roomX+this.width||t.y+i>this.roomY+this.height||t.x<this.roomX||t.y<this.roomY)return!1;for(let o=0;o<e;o++)for(let e=0;e<i;e++)if(!s.has(`${t.x+o},${t.y+e}`))return!1;return!0});if(0===o.length)return null;const a=o[r.Game.rand(0,o.length-1,Y.Random.rand)];return{x:a.x,y:a.y}}getRoomCenter(){return{x:Math.floor(this.roomX+this.width/2),y:Math.floor(this.roomY+this.height/2)}}isPositionInRoom(t,e){return!(Math.floor(t)<this.roomX||Math.floor(t)>=this.roomX+this.width||Math.floor(e)<this.roomY||Math.floor(e)>=this.roomY+this.height)}pathIsBlockedBy(t,e){const i=[];return t.isSolid()&&i.push(t),e.isSolid()&&i.push(e),i}addBeamEffect(t,e,i,s,o){const a=new tt.BeamEffect(t,e,i,s,o);this.beamEffects.push(a)}async changeReverb(t){await Z.ReverbEngine.setReverbImpulse(t)}get roomArea(){this.width,this.height;let t=[];for(let e=this.roomX+1;e<this.roomX+this.width-1;e++)for(let i=this.roomY+1;i<this.roomY+this.height-1;i++)this.roomArray[e][i]instanceof a.Floor&&t.push({x:e,y:i});return t.length}roomOnScreen(t){const e=u.GameConstants.TILESIZE,i=(this.roomX-2)*e,s=(this.roomX+this.width+2)*e,o=(this.roomY-2)*e,a=(this.roomY+this.height+2)*e,r=t.x*e,n=t.y*e,h=r-t.drawX+.5*e-.5*u.GameConstants.WIDTH-this.game.screenShakeX,l=n-t.drawY+.5*e-.5*u.GameConstants.HEIGHT-this.game.screenShakeY,c=u.GameConstants.WIDTH,d=u.GameConstants.HEIGHT,m=!(s<h||i>h+c||a<l||o>l+d);this.onScreen=m}isTileOnScreen(t,e,i=0){const s=u.GameConstants.TILESIZE,o=this.game.players[this.game.localPlayerID]?this.game.players[this.game.localPlayerID].x*s:0,a=this.game.players[this.game.localPlayerID]?this.game.players[this.game.localPlayerID].y*s:0,r=o-(this.game.players[this.game.localPlayerID]?.drawX||0)+.5*s-.5*u.GameConstants.WIDTH-this.game.screenShakeX,n=a-(this.game.players[this.game.localPlayerID]?.drawY||0)+.5*s-.5*u.GameConstants.HEIGHT-this.game.screenShakeY,h=u.GameConstants.WIDTH,l=u.GameConstants.HEIGHT,c=i*s,d=t*s,m=e*s;return!(d+s<r-c||d>r+h+c||m+s<n-c||m>n+l+c)}getVisibleTileBounds(t=0){const e=u.GameConstants.TILESIZE,i=this.game.players[this.game.localPlayerID]?this.game.players[this.game.localPlayerID].x*e:0,s=this.game.players[this.game.localPlayerID]?this.game.players[this.game.localPlayerID].y*e:0,o=i-(this.game.players[this.game.localPlayerID]?.drawX||0)+.5*e-.5*u.GameConstants.WIDTH-this.game.screenShakeX,a=s-(this.game.players[this.game.localPlayerID]?.drawY||0)+.5*e-.5*u.GameConstants.HEIGHT-this.game.screenShakeY,r=t*e,n=o-r,h=o+u.GameConstants.WIDTH+r,l=a-r,c=a+u.GameConstants.HEIGHT+r;let d=Math.floor(n/e),m=Math.ceil(h/e)-1,p=Math.floor(l/e),y=Math.ceil(c/e)-1;const g=this.roomX,f=this.roomX+this.width-1,w=this.roomY,E=this.roomY+this.height-1;return d<g&&(d=g),m>f&&(m=f),p<w&&(p=w),y>E&&(y=E),{minX:d,maxX:m,minY:p,maxY:y}}setReverb(){const t=this.roomArea;t<10?this.changeReverb("res/SFX/impulses/small.mp3"):t<55?this.changeReverb("res/SFX/impulses/medium.mp3"):this.changeReverb("res/SFX/impulses/large.mp3")}getEmptyWall(){const t=[];for(let e=this.roomX+1;e<this.roomX+this.width-1;e++)for(let i=this.roomY-1;i<this.roomY+this.height-1;i++){const o=this.roomArray[e][i];!(o instanceof s.Wall||o instanceof O.WallTorch)||o instanceof n.Door||[this.roomArray[e+1]?.[i],this.roomArray[e-1]?.[i],this.roomArray[e]?.[i+1],this.roomArray[e]?.[i-1]].some(t=>t instanceof n.Door)||t.push(o)}return t}removeEmptyWall(t){if(!(t instanceof s.Wall))return null;const{x:e,y:i}=t;return this.roomArray[e][i]=new a.Floor(this,e,i),this.innerWalls.length,this.innerWalls=this.innerWalls.filter(e=>e!==t),this.innerWalls.length,{x:e,y:i}}placeVendingMachineInWall(t){let e=this.getEmptyWall();if(e=e.filter(t=>{const e=t.wallInfo();return e&&!e.isInnerWall}),0===e.length)return;const i=r.Game.randTable(e,Y.Random.rand);if(!i)return;const s=this.removeEmptyWall(i);if(!s)return;const{x:o,y:a}=s;this.addVendingMachine(Y.Random.rand,o,a,t)}}},4159:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.FireWizardEnemy=e.WizardState=void 0;const s=i(7851),o=i(7180),a=i(1367),r=i(9467),n=i(263);var h;!function(t){t[t.idle=0]="idle",t[t.attack=1]="attack",t[t.justAttacked=2]="justAttacked",t[t.teleport=3]="teleport"}(h=e.WizardState||(e.WizardState={}));class l extends n.WizardEnemy{constructor(t,e,i,n,l){super(t,e,i,n),this.ATTACK_RADIUS=5,this.hit=()=>1,this.withinAttackingRangeOfPlayer=()=>{let t=!1;for(const e in this.game.players)(this.x-this.game.players[e].x)**2+(this.y-this.game.players[e].y)**2<=this.ATTACK_RADIUS**2&&(t=!0);return t},this.shuffle=t=>{let e,i,s;for(s=t.length-1;s>0;s--)e=Math.floor(r.Random.rand()*(s+1)),i=t[s],t[s]=t[e],t[e]=i;return t},this.behavior=()=>{if(this.lastX=this.x,this.lastY=this.y,!this.dead){if(this.handleSkipTurns())return;if(this.seenPlayer){if(this.seenPlayer)switch(this.alertTicks=Math.max(0,this.alertTicks-1),this.state){case h.attack:const t=this.nearestPlayer();if(!1!==t){const[e,i]=t;this.calculateProjectileOffsets(i.x,i.y,10),this.attemptProjectilePlacement([{x:-1,y:0},{x:1,y:0},{x:0,y:-1},{x:0,y:1}],a.WizardFireball,!1)}this.state=h.justAttacked;break;case h.justAttacked:this.attemptProjectilePlacement([{x:-1,y:-1},{x:1,y:1},{x:1,y:-1},{x:-1,y:1}],a.WizardFireball,!1),this.state=h.idle;break;case h.teleport:let e,i=this.x,n=this.y,l=1e5,c=this.shuffle(this.room.getEmptyTiles());if(c=c.filter(t=>!this.room.projectiles.some(e=>e.x===t.x&&e.y===t.y)),0===c.length||0===Object.keys(this.game.players).length){this.state=h.idle;break}let d=s.Game.randTable([2,2,3,3,3,3,3],r.Random.rand),m=[];for(const t in this.game.players)m.push(t);let u=s.Game.randTable(m,r.Random.rand);if(!this.game.players[u]){this.state=h.idle;break}for(let t of c){let i=t,s=Math.abs(i.x-this.game.players[u].x)+Math.abs(i.y-this.game.players[u].y);Math.abs(s-d)<Math.abs(l-d)&&(l=s,e=i)}e||(e=c[0]),this.tryMove(e.x,e.y),this.drawX=this.x-i,this.drawY=this.y-n,this.frame=0,this.room.particles.push(new o.WizardTeleportParticle(i,n)),this.withinAttackingRangeOfPlayer()?this.state=h.attack:this.state=h.idle;break;case h.idle:this.state=h.teleport}}else this.lookForPlayer()}},this.draw=t=>{this.dead||(s.Game.ctx.save(),s.Game.ctx.globalAlpha=this.alpha,this.dead||(this.updateDrawXY(t),this.state===h.attack?this.tileX=36:this.tileX=35,this.hasShadow&&this.state!==h.idle&&this.drawShadow(t),this.frame>=0?(s.Game.drawMob(Math.floor(this.frame)+5,18,1,2,this.x,this.y-1.3,1,2,this.softShadeColor,this.shadeAmount()),this.frame+=.4*t,this.frame>12&&(this.frame=-1)):s.Game.drawMob(this.tileX,this.tileY,1,2,this.x-this.drawX,this.y-1.3-this.drawY,1,2,this.softShadeColor,this.shadeAmount(),void 0,this.outlineColor(),this.outlineOpacity()),this.cloned||(this.seenPlayer||this.drawSleepingZs(t),this.alertTicks>0&&this.drawExclamation(t))),s.Game.ctx.restore())},this.ticks=0,this.health=1,this.maxHealth=1,this.defaultMaxHealth=1,this.tileX=35,this.tileY=8,this.frame=0,this.state=h.attack,this.seenPlayer=!1,this.alertTicks=0,this.name="fire wizard",this.projectileColor=[200,20,0],l&&(this.drop=l),this.jumpHeight=.5,this.getDrop(["weapon","equipment","consumable","tool","coin"])}}e.FireWizardEnemy=l,l.difficulty=3,l.tileX=35,l.tileY=8},4182:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.BombItem=void 0;const s=i(7366),o=i(5180);class a extends o.Usable{constructor(t,e,o){super(t,e,o),this.onUse=t=>{const{Bomb:e}=i(9245);e.add(t.game.room,t.game,t.x,t.y),t.inventory.removeItem(this),s.Sound.mine()},this.tileX=20,this.tileY=2,this.offsetY=-.3,this.name=a.itemName,this.description="explodes"}}e.BombItem=a,a.itemName="bomb"},4196:(t,e,i)=>{var s;!function(){"use strict";var o=function(){this.init()};o.prototype={init:function(){var t=this||a;return t._counter=1e3,t._html5AudioPool=[],t.html5PoolSize=10,t._codecs={},t._howls=[],t._muted=!1,t._volume=1,t._canPlayEvent="canplaythrough",t._navigator="undefined"!=typeof window&&window.navigator?window.navigator:null,t.masterGain=null,t.noAudio=!1,t.usingWebAudio=!0,t.autoSuspend=!0,t.ctx=null,t.autoUnlock=!0,t._setup(),t},volume:function(t){var e=this||a;if(t=parseFloat(t),e.ctx||u(),void 0!==t&&t>=0&&t<=1){if(e._volume=t,e._muted)return e;e.usingWebAudio&&e.masterGain.gain.setValueAtTime(t,a.ctx.currentTime);for(var i=0;i<e._howls.length;i++)if(!e._howls[i]._webAudio)for(var s=e._howls[i]._getSoundIds(),o=0;o<s.length;o++){var r=e._howls[i]._soundById(s[o]);r&&r._node&&(r._node.volume=r._volume*t)}return e}return e._volume},mute:function(t){var e=this||a;e.ctx||u(),e._muted=t,e.usingWebAudio&&e.masterGain.gain.setValueAtTime(t?0:e._volume,a.ctx.currentTime);for(var i=0;i<e._howls.length;i++)if(!e._howls[i]._webAudio)for(var s=e._howls[i]._getSoundIds(),o=0;o<s.length;o++){var r=e._howls[i]._soundById(s[o]);r&&r._node&&(r._node.muted=!!t||r._muted)}return e},stop:function(){for(var t=this||a,e=0;e<t._howls.length;e++)t._howls[e].stop();return t},unload:function(){for(var t=this||a,e=t._howls.length-1;e>=0;e--)t._howls[e].unload();return t.usingWebAudio&&t.ctx&&void 0!==t.ctx.close&&(t.ctx.close(),t.ctx=null,u()),t},codecs:function(t){return(this||a)._codecs[t.replace(/^x-/,"")]},_setup:function(){var t=this||a;if(t.state=t.ctx&&t.ctx.state||"suspended",t._autoSuspend(),!t.usingWebAudio)if("undefined"!=typeof Audio)try{void 0===(new Audio).oncanplaythrough&&(t._canPlayEvent="canplay")}catch(e){t.noAudio=!0}else t.noAudio=!0;try{(new Audio).muted&&(t.noAudio=!0)}catch(t){}return t.noAudio||t._setupCodecs(),t},_setupCodecs:function(){var t=this||a,e=null;try{e="undefined"!=typeof Audio?new Audio:null}catch(e){return t}if(!e||"function"!=typeof e.canPlayType)return t;var i=e.canPlayType("audio/mpeg;").replace(/^no$/,""),s=t._navigator?t._navigator.userAgent:"",o=s.match(/OPR\/(\d+)/g),r=o&&parseInt(o[0].split("/")[1],10)<33,n=-1!==s.indexOf("Safari")&&-1===s.indexOf("Chrome"),h=s.match(/Version\/(.*?) /),l=n&&h&&parseInt(h[1],10)<15;return t._codecs={mp3:!(r||!i&&!e.canPlayType("audio/mp3;").replace(/^no$/,"")),mpeg:!!i,opus:!!e.canPlayType('audio/ogg; codecs="opus"').replace(/^no$/,""),ogg:!!e.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,""),oga:!!e.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,""),wav:!!(e.canPlayType('audio/wav; codecs="1"')||e.canPlayType("audio/wav")).replace(/^no$/,""),aac:!!e.canPlayType("audio/aac;").replace(/^no$/,""),caf:!!e.canPlayType("audio/x-caf;").replace(/^no$/,""),m4a:!!(e.canPlayType("audio/x-m4a;")||e.canPlayType("audio/m4a;")||e.canPlayType("audio/aac;")).replace(/^no$/,""),m4b:!!(e.canPlayType("audio/x-m4b;")||e.canPlayType("audio/m4b;")||e.canPlayType("audio/aac;")).replace(/^no$/,""),mp4:!!(e.canPlayType("audio/x-mp4;")||e.canPlayType("audio/mp4;")||e.canPlayType("audio/aac;")).replace(/^no$/,""),weba:!(l||!e.canPlayType('audio/webm; codecs="vorbis"').replace(/^no$/,"")),webm:!(l||!e.canPlayType('audio/webm; codecs="vorbis"').replace(/^no$/,"")),dolby:!!e.canPlayType('audio/mp4; codecs="ec-3"').replace(/^no$/,""),flac:!!(e.canPlayType("audio/x-flac;")||e.canPlayType("audio/flac;")).replace(/^no$/,"")},t},_unlockAudio:function(){var t=this||a;if(!t._audioUnlocked&&t.ctx){t._audioUnlocked=!1,t.autoUnlock=!1,t._mobileUnloaded||44100===t.ctx.sampleRate||(t._mobileUnloaded=!0,t.unload()),t._scratchBuffer=t.ctx.createBuffer(1,1,22050);var e=function(i){for(;t._html5AudioPool.length<t.html5PoolSize;)try{var s=new Audio;s._unlocked=!0,t._releaseHtml5Audio(s)}catch(i){t.noAudio=!0;break}for(var o=0;o<t._howls.length;o++)if(!t._howls[o]._webAudio)for(var a=t._howls[o]._getSoundIds(),r=0;r<a.length;r++){var n=t._howls[o]._soundById(a[r]);n&&n._node&&!n._node._unlocked&&(n._node._unlocked=!0,n._node.load())}t._autoResume();var h=t.ctx.createBufferSource();h.buffer=t._scratchBuffer,h.connect(t.ctx.destination),void 0===h.start?h.noteOn(0):h.start(0),"function"==typeof t.ctx.resume&&t.ctx.resume(),h.onended=function(){h.disconnect(0),t._audioUnlocked=!0,document.removeEventListener("touchstart",e,!0),document.removeEventListener("touchend",e,!0),document.removeEventListener("click",e,!0),document.removeEventListener("keydown",e,!0);for(var i=0;i<t._howls.length;i++)t._howls[i]._emit("unlock")}};return document.addEventListener("touchstart",e,!0),document.addEventListener("touchend",e,!0),document.addEventListener("click",e,!0),document.addEventListener("keydown",e,!0),t}},_obtainHtml5Audio:function(){var t=this||a;if(t._html5AudioPool.length)return t._html5AudioPool.pop();var e=(new Audio).play();return e&&"undefined"!=typeof Promise&&(e instanceof Promise||"function"==typeof e.then)&&e.catch(function(){console.warn("HTML5 Audio pool exhausted, returning potentially locked audio object.")}),new Audio},_releaseHtml5Audio:function(t){var e=this||a;return t._unlocked&&e._html5AudioPool.push(t),e},_autoSuspend:function(){var t=this;if(t.autoSuspend&&t.ctx&&void 0!==t.ctx.suspend&&a.usingWebAudio){for(var e=0;e<t._howls.length;e++)if(t._howls[e]._webAudio)for(var i=0;i<t._howls[e]._sounds.length;i++)if(!t._howls[e]._sounds[i]._paused)return t;return t._suspendTimer&&clearTimeout(t._suspendTimer),t._suspendTimer=setTimeout(function(){if(t.autoSuspend){t._suspendTimer=null,t.state="suspending";var e=function(){t.state="suspended",t._resumeAfterSuspend&&(delete t._resumeAfterSuspend,t._autoResume())};t.ctx.suspend().then(e,e)}},3e4),t}},_autoResume:function(){var t=this;if(t.ctx&&void 0!==t.ctx.resume&&a.usingWebAudio)return"running"===t.state&&"interrupted"!==t.ctx.state&&t._suspendTimer?(clearTimeout(t._suspendTimer),t._suspendTimer=null):"suspended"===t.state||"running"===t.state&&"interrupted"===t.ctx.state?(t.ctx.resume().then(function(){t.state="running";for(var e=0;e<t._howls.length;e++)t._howls[e]._emit("resume")}),t._suspendTimer&&(clearTimeout(t._suspendTimer),t._suspendTimer=null)):"suspending"===t.state&&(t._resumeAfterSuspend=!0),t}};var a=new o,r=function(t){t.src&&0!==t.src.length?this.init(t):console.error("An array of source files must be passed with any new Howl.")};r.prototype={init:function(t){var e=this;return a.ctx||u(),e._autoplay=t.autoplay||!1,e._format="string"!=typeof t.format?t.format:[t.format],e._html5=t.html5||!1,e._muted=t.mute||!1,e._loop=t.loop||!1,e._pool=t.pool||5,e._preload="boolean"!=typeof t.preload&&"metadata"!==t.preload||t.preload,e._rate=t.rate||1,e._sprite=t.sprite||{},e._src="string"!=typeof t.src?t.src:[t.src],e._volume=void 0!==t.volume?t.volume:1,e._xhr={method:t.xhr&&t.xhr.method?t.xhr.method:"GET",headers:t.xhr&&t.xhr.headers?t.xhr.headers:null,withCredentials:!(!t.xhr||!t.xhr.withCredentials)&&t.xhr.withCredentials},e._duration=0,e._state="unloaded",e._sounds=[],e._endTimers={},e._queue=[],e._playLock=!1,e._onend=t.onend?[{fn:t.onend}]:[],e._onfade=t.onfade?[{fn:t.onfade}]:[],e._onload=t.onload?[{fn:t.onload}]:[],e._onloaderror=t.onloaderror?[{fn:t.onloaderror}]:[],e._onplayerror=t.onplayerror?[{fn:t.onplayerror}]:[],e._onpause=t.onpause?[{fn:t.onpause}]:[],e._onplay=t.onplay?[{fn:t.onplay}]:[],e._onstop=t.onstop?[{fn:t.onstop}]:[],e._onmute=t.onmute?[{fn:t.onmute}]:[],e._onvolume=t.onvolume?[{fn:t.onvolume}]:[],e._onrate=t.onrate?[{fn:t.onrate}]:[],e._onseek=t.onseek?[{fn:t.onseek}]:[],e._onunlock=t.onunlock?[{fn:t.onunlock}]:[],e._onresume=[],e._webAudio=a.usingWebAudio&&!e._html5,void 0!==a.ctx&&a.ctx&&a.autoUnlock&&a._unlockAudio(),a._howls.push(e),e._autoplay&&e._queue.push({event:"play",action:function(){e.play()}}),e._preload&&"none"!==e._preload&&e.load(),e},load:function(){var t=this,e=null;if(a.noAudio)t._emit("loaderror",null,"No audio support.");else{"string"==typeof t._src&&(t._src=[t._src]);for(var i=0;i<t._src.length;i++){var s,o;if(t._format&&t._format[i])s=t._format[i];else{if("string"!=typeof(o=t._src[i])){t._emit("loaderror",null,"Non-string found in selected audio sources - ignoring.");continue}(s=/^data:audio\/([^;,]+);/i.exec(o))||(s=/\.([^.]+)$/.exec(o.split("?",1)[0])),s&&(s=s[1].toLowerCase())}if(s||console.warn('No file extension was found. Consider using the "format" property or specify an extension.'),s&&a.codecs(s)){e=t._src[i];break}}if(e)return t._src=e,t._state="loading","https:"===window.location.protocol&&"http:"===e.slice(0,5)&&(t._html5=!0,t._webAudio=!1),new n(t),t._webAudio&&l(t),t;t._emit("loaderror",null,"No codec support for selected audio sources.")}},play:function(t,e){var i=this,s=null;if("number"==typeof t)s=t,t=null;else{if("string"==typeof t&&"loaded"===i._state&&!i._sprite[t])return null;if(void 0===t&&(t="__default",!i._playLock)){for(var o=0,r=0;r<i._sounds.length;r++)i._sounds[r]._paused&&!i._sounds[r]._ended&&(o++,s=i._sounds[r]._id);1===o?t=null:s=null}}var n=s?i._soundById(s):i._inactiveSound();if(!n)return null;if(s&&!t&&(t=n._sprite||"__default"),"loaded"!==i._state){n._sprite=t,n._ended=!1;var h=n._id;return i._queue.push({event:"play",action:function(){i.play(h)}}),h}if(s&&!n._paused)return e||i._loadQueue("play"),n._id;i._webAudio&&a._autoResume();var l=Math.max(0,n._seek>0?n._seek:i._sprite[t][0]/1e3),c=Math.max(0,(i._sprite[t][0]+i._sprite[t][1])/1e3-l),d=1e3*c/Math.abs(n._rate),m=i._sprite[t][0]/1e3,u=(i._sprite[t][0]+i._sprite[t][1])/1e3;n._sprite=t,n._ended=!1;var p=function(){n._paused=!1,n._seek=l,n._start=m,n._stop=u,n._loop=!(!n._loop&&!i._sprite[t][2])};if(!(l>=u)){var y=n._node;if(i._webAudio){var g=function(){i._playLock=!1,p(),i._refreshBuffer(n);var t=n._muted||i._muted?0:n._volume;y.gain.setValueAtTime(t,a.ctx.currentTime),n._playStart=a.ctx.currentTime,void 0===y.bufferSource.start?n._loop?y.bufferSource.noteGrainOn(0,l,86400):y.bufferSource.noteGrainOn(0,l,c):n._loop?y.bufferSource.start(0,l,86400):y.bufferSource.start(0,l,c),d!==1/0&&(i._endTimers[n._id]=setTimeout(i._ended.bind(i,n),d)),e||setTimeout(function(){i._emit("play",n._id),i._loadQueue()},0)};"running"===a.state&&"interrupted"!==a.ctx.state?g():(i._playLock=!0,i.once("resume",g),i._clearTimer(n._id))}else{var f=function(){y.currentTime=l,y.muted=n._muted||i._muted||a._muted||y.muted,y.volume=n._volume*a.volume(),y.playbackRate=n._rate;try{var s=y.play();if(s&&"undefined"!=typeof Promise&&(s instanceof Promise||"function"==typeof s.then)?(i._playLock=!0,p(),s.then(function(){i._playLock=!1,y._unlocked=!0,e?i._loadQueue():i._emit("play",n._id)}).catch(function(){i._playLock=!1,i._emit("playerror",n._id,"Playback was unable to start. This is most commonly an issue on mobile devices and Chrome where playback was not within a user interaction."),n._ended=!0,n._paused=!0})):e||(i._playLock=!1,p(),i._emit("play",n._id)),y.playbackRate=n._rate,y.paused)return void i._emit("playerror",n._id,"Playback was unable to start. This is most commonly an issue on mobile devices and Chrome where playback was not within a user interaction.");"__default"!==t||n._loop?i._endTimers[n._id]=setTimeout(i._ended.bind(i,n),d):(i._endTimers[n._id]=function(){i._ended(n),y.removeEventListener("ended",i._endTimers[n._id],!1)},y.addEventListener("ended",i._endTimers[n._id],!1))}catch(t){i._emit("playerror",n._id,t)}};"data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA"===y.src&&(y.src=i._src,y.load());var w=window&&window.ejecta||!y.readyState&&a._navigator.isCocoonJS;if(y.readyState>=3||w)f();else{i._playLock=!0,i._state="loading";var E=function(){i._state="loaded",f(),y.removeEventListener(a._canPlayEvent,E,!1)};y.addEventListener(a._canPlayEvent,E,!1),i._clearTimer(n._id)}}return n._id}i._ended(n)},pause:function(t){var e=this;if("loaded"!==e._state||e._playLock)return e._queue.push({event:"pause",action:function(){e.pause(t)}}),e;for(var i=e._getSoundIds(t),s=0;s<i.length;s++){e._clearTimer(i[s]);var o=e._soundById(i[s]);if(o&&!o._paused&&(o._seek=e.seek(i[s]),o._rateSeek=0,o._paused=!0,e._stopFade(i[s]),o._node))if(e._webAudio){if(!o._node.bufferSource)continue;void 0===o._node.bufferSource.stop?o._node.bufferSource.noteOff(0):o._node.bufferSource.stop(0),e._cleanBuffer(o._node)}else isNaN(o._node.duration)&&o._node.duration!==1/0||o._node.pause();arguments[1]||e._emit("pause",o?o._id:null)}return e},stop:function(t,e){var i=this;if("loaded"!==i._state||i._playLock)return i._queue.push({event:"stop",action:function(){i.stop(t)}}),i;for(var s=i._getSoundIds(t),o=0;o<s.length;o++){i._clearTimer(s[o]);var a=i._soundById(s[o]);a&&(a._seek=a._start||0,a._rateSeek=0,a._paused=!0,a._ended=!0,i._stopFade(s[o]),a._node&&(i._webAudio?a._node.bufferSource&&(void 0===a._node.bufferSource.stop?a._node.bufferSource.noteOff(0):a._node.bufferSource.stop(0),i._cleanBuffer(a._node)):isNaN(a._node.duration)&&a._node.duration!==1/0||(a._node.currentTime=a._start||0,a._node.pause(),a._node.duration===1/0&&i._clearSound(a._node))),e||i._emit("stop",a._id))}return i},mute:function(t,e){var i=this;if("loaded"!==i._state||i._playLock)return i._queue.push({event:"mute",action:function(){i.mute(t,e)}}),i;if(void 0===e){if("boolean"!=typeof t)return i._muted;i._muted=t}for(var s=i._getSoundIds(e),o=0;o<s.length;o++){var r=i._soundById(s[o]);r&&(r._muted=t,r._interval&&i._stopFade(r._id),i._webAudio&&r._node?r._node.gain.setValueAtTime(t?0:r._volume,a.ctx.currentTime):r._node&&(r._node.muted=!!a._muted||t),i._emit("mute",r._id))}return i},volume:function(){var t,e,i,s=this,o=arguments;if(0===o.length)return s._volume;if(1===o.length||2===o.length&&void 0===o[1]?s._getSoundIds().indexOf(o[0])>=0?e=parseInt(o[0],10):t=parseFloat(o[0]):o.length>=2&&(t=parseFloat(o[0]),e=parseInt(o[1],10)),!(void 0!==t&&t>=0&&t<=1))return(i=e?s._soundById(e):s._sounds[0])?i._volume:0;if("loaded"!==s._state||s._playLock)return s._queue.push({event:"volume",action:function(){s.volume.apply(s,o)}}),s;void 0===e&&(s._volume=t),e=s._getSoundIds(e);for(var r=0;r<e.length;r++)(i=s._soundById(e[r]))&&(i._volume=t,o[2]||s._stopFade(e[r]),s._webAudio&&i._node&&!i._muted?i._node.gain.setValueAtTime(t,a.ctx.currentTime):i._node&&!i._muted&&(i._node.volume=t*a.volume()),s._emit("volume",i._id));return s},fade:function(t,e,i,s){var o=this;if("loaded"!==o._state||o._playLock)return o._queue.push({event:"fade",action:function(){o.fade(t,e,i,s)}}),o;t=Math.min(Math.max(0,parseFloat(t)),1),e=Math.min(Math.max(0,parseFloat(e)),1),i=parseFloat(i),o.volume(t,s);for(var r=o._getSoundIds(s),n=0;n<r.length;n++){var h=o._soundById(r[n]);if(h){if(s||o._stopFade(r[n]),o._webAudio&&!h._muted){var l=a.ctx.currentTime,c=l+i/1e3;h._volume=t,h._node.gain.setValueAtTime(t,l),h._node.gain.linearRampToValueAtTime(e,c)}o._startFadeInterval(h,t,e,i,r[n],void 0===s)}}return o},_startFadeInterval:function(t,e,i,s,o,a){var r=this,n=e,h=i-e,l=Math.abs(h/.01),c=Math.max(4,l>0?s/l:s),d=Date.now();t._fadeTo=i,t._interval=setInterval(function(){var o=(Date.now()-d)/s;d=Date.now(),n+=h*o,n=Math.round(100*n)/100,n=h<0?Math.max(i,n):Math.min(i,n),r._webAudio?t._volume=n:r.volume(n,t._id,!0),a&&(r._volume=n),(i<e&&n<=i||i>e&&n>=i)&&(clearInterval(t._interval),t._interval=null,t._fadeTo=null,r.volume(i,t._id),r._emit("fade",t._id))},c)},_stopFade:function(t){var e=this,i=e._soundById(t);return i&&i._interval&&(e._webAudio&&i._node.gain.cancelScheduledValues(a.ctx.currentTime),clearInterval(i._interval),i._interval=null,e.volume(i._fadeTo,t),i._fadeTo=null,e._emit("fade",t)),e},loop:function(){var t,e,i,s=this,o=arguments;if(0===o.length)return s._loop;if(1===o.length){if("boolean"!=typeof o[0])return!!(i=s._soundById(parseInt(o[0],10)))&&i._loop;t=o[0],s._loop=t}else 2===o.length&&(t=o[0],e=parseInt(o[1],10));for(var a=s._getSoundIds(e),r=0;r<a.length;r++)(i=s._soundById(a[r]))&&(i._loop=t,s._webAudio&&i._node&&i._node.bufferSource&&(i._node.bufferSource.loop=t,t&&(i._node.bufferSource.loopStart=i._start||0,i._node.bufferSource.loopEnd=i._stop,s.playing(a[r])&&(s.pause(a[r],!0),s.play(a[r],!0)))));return s},rate:function(){var t,e,i,s=this,o=arguments;if(0===o.length?e=s._sounds[0]._id:1===o.length?s._getSoundIds().indexOf(o[0])>=0?e=parseInt(o[0],10):t=parseFloat(o[0]):2===o.length&&(t=parseFloat(o[0]),e=parseInt(o[1],10)),"number"!=typeof t)return(i=s._soundById(e))?i._rate:s._rate;if("loaded"!==s._state||s._playLock)return s._queue.push({event:"rate",action:function(){s.rate.apply(s,o)}}),s;void 0===e&&(s._rate=t),e=s._getSoundIds(e);for(var r=0;r<e.length;r++)if(i=s._soundById(e[r])){s.playing(e[r])&&(i._rateSeek=s.seek(e[r]),i._playStart=s._webAudio?a.ctx.currentTime:i._playStart),i._rate=t,s._webAudio&&i._node&&i._node.bufferSource?i._node.bufferSource.playbackRate.setValueAtTime(t,a.ctx.currentTime):i._node&&(i._node.playbackRate=t);var n=s.seek(e[r]),h=1e3*((s._sprite[i._sprite][0]+s._sprite[i._sprite][1])/1e3-n)/Math.abs(i._rate);!s._endTimers[e[r]]&&i._paused||(s._clearTimer(e[r]),s._endTimers[e[r]]=setTimeout(s._ended.bind(s,i),h)),s._emit("rate",i._id)}return s},seek:function(){var t,e,i=this,s=arguments;if(0===s.length?i._sounds.length&&(e=i._sounds[0]._id):1===s.length?i._getSoundIds().indexOf(s[0])>=0?e=parseInt(s[0],10):i._sounds.length&&(e=i._sounds[0]._id,t=parseFloat(s[0])):2===s.length&&(t=parseFloat(s[0]),e=parseInt(s[1],10)),void 0===e)return 0;if("number"==typeof t&&("loaded"!==i._state||i._playLock))return i._queue.push({event:"seek",action:function(){i.seek.apply(i,s)}}),i;var o=i._soundById(e);if(o){if(!("number"==typeof t&&t>=0)){if(i._webAudio){var r=i.playing(e)?a.ctx.currentTime-o._playStart:0,n=o._rateSeek?o._rateSeek-o._seek:0;return o._seek+(n+r*Math.abs(o._rate))}return o._node.currentTime}var h=i.playing(e);h&&i.pause(e,!0),o._seek=t,o._ended=!1,i._clearTimer(e),i._webAudio||!o._node||isNaN(o._node.duration)||(o._node.currentTime=t);var l=function(){h&&i.play(e,!0),i._emit("seek",e)};if(h&&!i._webAudio){var c=function(){i._playLock?setTimeout(c,0):l()};setTimeout(c,0)}else l()}return i},playing:function(t){var e=this;if("number"==typeof t){var i=e._soundById(t);return!!i&&!i._paused}for(var s=0;s<e._sounds.length;s++)if(!e._sounds[s]._paused)return!0;return!1},duration:function(t){var e=this,i=e._duration,s=e._soundById(t);return s&&(i=e._sprite[s._sprite][1]/1e3),i},state:function(){return this._state},unload:function(){for(var t=this,e=t._sounds,i=0;i<e.length;i++)e[i]._paused||t.stop(e[i]._id),t._webAudio||(t._clearSound(e[i]._node),e[i]._node.removeEventListener("error",e[i]._errorFn,!1),e[i]._node.removeEventListener(a._canPlayEvent,e[i]._loadFn,!1),e[i]._node.removeEventListener("ended",e[i]._endFn,!1),a._releaseHtml5Audio(e[i]._node)),delete e[i]._node,t._clearTimer(e[i]._id);var s=a._howls.indexOf(t);s>=0&&a._howls.splice(s,1);var o=!0;for(i=0;i<a._howls.length;i++)if(a._howls[i]._src===t._src||t._src.indexOf(a._howls[i]._src)>=0){o=!1;break}return h&&o&&delete h[t._src],a.noAudio=!1,t._state="unloaded",t._sounds=[],t=null,null},on:function(t,e,i,s){var o=this["_on"+t];return"function"==typeof e&&o.push(s?{id:i,fn:e,once:s}:{id:i,fn:e}),this},off:function(t,e,i){var s=this,o=s["_on"+t],a=0;if("number"==typeof e&&(i=e,e=null),e||i)for(a=0;a<o.length;a++){var r=i===o[a].id;if(e===o[a].fn&&r||!e&&r){o.splice(a,1);break}}else if(t)s["_on"+t]=[];else{var n=Object.keys(s);for(a=0;a<n.length;a++)0===n[a].indexOf("_on")&&Array.isArray(s[n[a]])&&(s[n[a]]=[])}return s},once:function(t,e,i){return this.on(t,e,i,1),this},_emit:function(t,e,i){for(var s=this,o=s["_on"+t],a=o.length-1;a>=0;a--)o[a].id&&o[a].id!==e&&"load"!==t||(setTimeout(function(t){t.call(this,e,i)}.bind(s,o[a].fn),0),o[a].once&&s.off(t,o[a].fn,o[a].id));return s._loadQueue(t),s},_loadQueue:function(t){var e=this;if(e._queue.length>0){var i=e._queue[0];i.event===t&&(e._queue.shift(),e._loadQueue()),t||i.action()}return e},_ended:function(t){var e=this,i=t._sprite;if(!e._webAudio&&t._node&&!t._node.paused&&!t._node.ended&&t._node.currentTime<t._stop)return setTimeout(e._ended.bind(e,t),100),e;var s=!(!t._loop&&!e._sprite[i][2]);if(e._emit("end",t._id),!e._webAudio&&s&&e.stop(t._id,!0).play(t._id),e._webAudio&&s){e._emit("play",t._id),t._seek=t._start||0,t._rateSeek=0,t._playStart=a.ctx.currentTime;var o=1e3*(t._stop-t._start)/Math.abs(t._rate);e._endTimers[t._id]=setTimeout(e._ended.bind(e,t),o)}return e._webAudio&&!s&&(t._paused=!0,t._ended=!0,t._seek=t._start||0,t._rateSeek=0,e._clearTimer(t._id),e._cleanBuffer(t._node),a._autoSuspend()),e._webAudio||s||e.stop(t._id,!0),e},_clearTimer:function(t){var e=this;if(e._endTimers[t]){if("function"!=typeof e._endTimers[t])clearTimeout(e._endTimers[t]);else{var i=e._soundById(t);i&&i._node&&i._node.removeEventListener("ended",e._endTimers[t],!1)}delete e._endTimers[t]}return e},_soundById:function(t){for(var e=this,i=0;i<e._sounds.length;i++)if(t===e._sounds[i]._id)return e._sounds[i];return null},_inactiveSound:function(){var t=this;t._drain();for(var e=0;e<t._sounds.length;e++)if(t._sounds[e]._ended)return t._sounds[e].reset();return new n(t)},_drain:function(){var t=this,e=t._pool,i=0,s=0;if(!(t._sounds.length<e)){for(s=0;s<t._sounds.length;s++)t._sounds[s]._ended&&i++;for(s=t._sounds.length-1;s>=0;s--){if(i<=e)return;t._sounds[s]._ended&&(t._webAudio&&t._sounds[s]._node&&t._sounds[s]._node.disconnect(0),t._sounds.splice(s,1),i--)}}},_getSoundIds:function(t){if(void 0===t){for(var e=[],i=0;i<this._sounds.length;i++)e.push(this._sounds[i]._id);return e}return[t]},_refreshBuffer:function(t){return t._node.bufferSource=a.ctx.createBufferSource(),t._node.bufferSource.buffer=h[this._src],t._panner?t._node.bufferSource.connect(t._panner):t._node.bufferSource.connect(t._node),t._node.bufferSource.loop=t._loop,t._loop&&(t._node.bufferSource.loopStart=t._start||0,t._node.bufferSource.loopEnd=t._stop||0),t._node.bufferSource.playbackRate.setValueAtTime(t._rate,a.ctx.currentTime),this},_cleanBuffer:function(t){var e=a._navigator&&a._navigator.vendor.indexOf("Apple")>=0;if(!t.bufferSource)return this;if(a._scratchBuffer&&t.bufferSource&&(t.bufferSource.onended=null,t.bufferSource.disconnect(0),e))try{t.bufferSource.buffer=a._scratchBuffer}catch(t){}return t.bufferSource=null,this},_clearSound:function(t){/MSIE |Trident\//.test(a._navigator&&a._navigator.userAgent)||(t.src="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA")}};var n=function(t){this._parent=t,this.init()};n.prototype={init:function(){var t=this,e=t._parent;return t._muted=e._muted,t._loop=e._loop,t._volume=e._volume,t._rate=e._rate,t._seek=0,t._paused=!0,t._ended=!0,t._sprite="__default",t._id=++a._counter,e._sounds.push(t),t.create(),t},create:function(){var t=this,e=t._parent,i=a._muted||t._muted||t._parent._muted?0:t._volume;return e._webAudio?(t._node=void 0===a.ctx.createGain?a.ctx.createGainNode():a.ctx.createGain(),t._node.gain.setValueAtTime(i,a.ctx.currentTime),t._node.paused=!0,t._node.connect(a.masterGain)):a.noAudio||(t._node=a._obtainHtml5Audio(),t._errorFn=t._errorListener.bind(t),t._node.addEventListener("error",t._errorFn,!1),t._loadFn=t._loadListener.bind(t),t._node.addEventListener(a._canPlayEvent,t._loadFn,!1),t._endFn=t._endListener.bind(t),t._node.addEventListener("ended",t._endFn,!1),t._node.src=e._src,t._node.preload=!0===e._preload?"auto":e._preload,t._node.volume=i*a.volume(),t._node.load()),t},reset:function(){var t=this,e=t._parent;return t._muted=e._muted,t._loop=e._loop,t._volume=e._volume,t._rate=e._rate,t._seek=0,t._rateSeek=0,t._paused=!0,t._ended=!0,t._sprite="__default",t._id=++a._counter,t},_errorListener:function(){var t=this;t._parent._emit("loaderror",t._id,t._node.error?t._node.error.code:0),t._node.removeEventListener("error",t._errorFn,!1)},_loadListener:function(){var t=this,e=t._parent;e._duration=Math.ceil(10*t._node.duration)/10,0===Object.keys(e._sprite).length&&(e._sprite={__default:[0,1e3*e._duration]}),"loaded"!==e._state&&(e._state="loaded",e._emit("load"),e._loadQueue()),t._node.removeEventListener(a._canPlayEvent,t._loadFn,!1)},_endListener:function(){var t=this,e=t._parent;e._duration===1/0&&(e._duration=Math.ceil(10*t._node.duration)/10,e._sprite.__default[1]===1/0&&(e._sprite.__default[1]=1e3*e._duration),e._ended(t)),t._node.removeEventListener("ended",t._endFn,!1)}};var h={},l=function(t){var e=t._src;if(h[e])return t._duration=h[e].duration,void m(t);if(/^data:[^;]+;base64,/.test(e)){for(var i=atob(e.split(",")[1]),s=new Uint8Array(i.length),o=0;o<i.length;++o)s[o]=i.charCodeAt(o);d(s.buffer,t)}else{var a=new XMLHttpRequest;a.open(t._xhr.method,e,!0),a.withCredentials=t._xhr.withCredentials,a.responseType="arraybuffer",t._xhr.headers&&Object.keys(t._xhr.headers).forEach(function(e){a.setRequestHeader(e,t._xhr.headers[e])}),a.onload=function(){var e=(a.status+"")[0];"0"===e||"2"===e||"3"===e?d(a.response,t):t._emit("loaderror",null,"Failed loading audio file with status: "+a.status+".")},a.onerror=function(){t._webAudio&&(t._html5=!0,t._webAudio=!1,t._sounds=[],delete h[e],t.load())},c(a)}},c=function(t){try{t.send()}catch(e){t.onerror()}},d=function(t,e){var i=function(){e._emit("loaderror",null,"Decoding audio data failed.")},s=function(t){t&&e._sounds.length>0?(h[e._src]=t,m(e,t)):i()};"undefined"!=typeof Promise&&1===a.ctx.decodeAudioData.length?a.ctx.decodeAudioData(t).then(s).catch(i):a.ctx.decodeAudioData(t,s,i)},m=function(t,e){e&&!t._duration&&(t._duration=e.duration),0===Object.keys(t._sprite).length&&(t._sprite={__default:[0,1e3*t._duration]}),"loaded"!==t._state&&(t._state="loaded",t._emit("load"),t._loadQueue())},u=function(){if(a.usingWebAudio){try{"undefined"!=typeof AudioContext?a.ctx=new AudioContext:"undefined"!=typeof webkitAudioContext?a.ctx=new webkitAudioContext:a.usingWebAudio=!1}catch(t){a.usingWebAudio=!1}a.ctx||(a.usingWebAudio=!1);var t=/iP(hone|od|ad)/.test(a._navigator&&a._navigator.platform),e=a._navigator&&a._navigator.appVersion.match(/OS (\d+)_(\d+)_?(\d+)?/),i=e?parseInt(e[1],10):null;if(t&&i&&i<9){var s=/safari/.test(a._navigator&&a._navigator.userAgent.toLowerCase());a._navigator&&!s&&(a.usingWebAudio=!1)}a.usingWebAudio&&(a.masterGain=void 0===a.ctx.createGain?a.ctx.createGainNode():a.ctx.createGain(),a.masterGain.gain.setValueAtTime(a._muted?0:a._volume,a.ctx.currentTime),a.masterGain.connect(a.ctx.destination)),a._setup()}};void 0===(s=function(){return{Howler:a,Howl:r}}.apply(e,[]))||(t.exports=s),e.Howler=a,e.Howl=r,void 0!==i.g?(i.g.HowlerGlobal=o,i.g.Howler=a,i.g.Howl=r,i.g.Sound=n):"undefined"!=typeof window&&(window.HowlerGlobal=o,window.Howler=a,window.Howl=r,window.Sound=n)}(),function(){"use strict";var t;HowlerGlobal.prototype._pos=[0,0,0],HowlerGlobal.prototype._orientation=[0,0,-1,0,1,0],HowlerGlobal.prototype.stereo=function(t){var e=this;if(!e.ctx||!e.ctx.listener)return e;for(var i=e._howls.length-1;i>=0;i--)e._howls[i].stereo(t);return e},HowlerGlobal.prototype.pos=function(t,e,i){var s=this;return s.ctx&&s.ctx.listener?(e="number"!=typeof e?s._pos[1]:e,i="number"!=typeof i?s._pos[2]:i,"number"!=typeof t?s._pos:(s._pos=[t,e,i],void 0!==s.ctx.listener.positionX?(s.ctx.listener.positionX.setTargetAtTime(s._pos[0],Howler.ctx.currentTime,.1),s.ctx.listener.positionY.setTargetAtTime(s._pos[1],Howler.ctx.currentTime,.1),s.ctx.listener.positionZ.setTargetAtTime(s._pos[2],Howler.ctx.currentTime,.1)):s.ctx.listener.setPosition(s._pos[0],s._pos[1],s._pos[2]),s)):s},HowlerGlobal.prototype.orientation=function(t,e,i,s,o,a){var r=this;if(!r.ctx||!r.ctx.listener)return r;var n=r._orientation;return e="number"!=typeof e?n[1]:e,i="number"!=typeof i?n[2]:i,s="number"!=typeof s?n[3]:s,o="number"!=typeof o?n[4]:o,a="number"!=typeof a?n[5]:a,"number"!=typeof t?n:(r._orientation=[t,e,i,s,o,a],void 0!==r.ctx.listener.forwardX?(r.ctx.listener.forwardX.setTargetAtTime(t,Howler.ctx.currentTime,.1),r.ctx.listener.forwardY.setTargetAtTime(e,Howler.ctx.currentTime,.1),r.ctx.listener.forwardZ.setTargetAtTime(i,Howler.ctx.currentTime,.1),r.ctx.listener.upX.setTargetAtTime(s,Howler.ctx.currentTime,.1),r.ctx.listener.upY.setTargetAtTime(o,Howler.ctx.currentTime,.1),r.ctx.listener.upZ.setTargetAtTime(a,Howler.ctx.currentTime,.1)):r.ctx.listener.setOrientation(t,e,i,s,o,a),r)},Howl.prototype.init=(t=Howl.prototype.init,function(e){var i=this;return i._orientation=e.orientation||[1,0,0],i._stereo=e.stereo||null,i._pos=e.pos||null,i._pannerAttr={coneInnerAngle:void 0!==e.coneInnerAngle?e.coneInnerAngle:360,coneOuterAngle:void 0!==e.coneOuterAngle?e.coneOuterAngle:360,coneOuterGain:void 0!==e.coneOuterGain?e.coneOuterGain:0,distanceModel:void 0!==e.distanceModel?e.distanceModel:"inverse",maxDistance:void 0!==e.maxDistance?e.maxDistance:1e4,panningModel:void 0!==e.panningModel?e.panningModel:"HRTF",refDistance:void 0!==e.refDistance?e.refDistance:1,rolloffFactor:void 0!==e.rolloffFactor?e.rolloffFactor:1},i._onstereo=e.onstereo?[{fn:e.onstereo}]:[],i._onpos=e.onpos?[{fn:e.onpos}]:[],i._onorientation=e.onorientation?[{fn:e.onorientation}]:[],t.call(this,e)}),Howl.prototype.stereo=function(t,i){var s=this;if(!s._webAudio)return s;if("loaded"!==s._state)return s._queue.push({event:"stereo",action:function(){s.stereo(t,i)}}),s;var o=void 0===Howler.ctx.createStereoPanner?"spatial":"stereo";if(void 0===i){if("number"!=typeof t)return s._stereo;s._stereo=t,s._pos=[t,0,0]}for(var a=s._getSoundIds(i),r=0;r<a.length;r++){var n=s._soundById(a[r]);if(n){if("number"!=typeof t)return n._stereo;n._stereo=t,n._pos=[t,0,0],n._node&&(n._pannerAttr.panningModel="equalpower",n._panner&&n._panner.pan||e(n,o),"spatial"===o?void 0!==n._panner.positionX?(n._panner.positionX.setValueAtTime(t,Howler.ctx.currentTime),n._panner.positionY.setValueAtTime(0,Howler.ctx.currentTime),n._panner.positionZ.setValueAtTime(0,Howler.ctx.currentTime)):n._panner.setPosition(t,0,0):n._panner.pan.setValueAtTime(t,Howler.ctx.currentTime)),s._emit("stereo",n._id)}}return s},Howl.prototype.pos=function(t,i,s,o){var a=this;if(!a._webAudio)return a;if("loaded"!==a._state)return a._queue.push({event:"pos",action:function(){a.pos(t,i,s,o)}}),a;if(i="number"!=typeof i?0:i,s="number"!=typeof s?-.5:s,void 0===o){if("number"!=typeof t)return a._pos;a._pos=[t,i,s]}for(var r=a._getSoundIds(o),n=0;n<r.length;n++){var h=a._soundById(r[n]);if(h){if("number"!=typeof t)return h._pos;h._pos=[t,i,s],h._node&&(h._panner&&!h._panner.pan||e(h,"spatial"),void 0!==h._panner.positionX?(h._panner.positionX.setValueAtTime(t,Howler.ctx.currentTime),h._panner.positionY.setValueAtTime(i,Howler.ctx.currentTime),h._panner.positionZ.setValueAtTime(s,Howler.ctx.currentTime)):h._panner.setPosition(t,i,s)),a._emit("pos",h._id)}}return a},Howl.prototype.orientation=function(t,i,s,o){var a=this;if(!a._webAudio)return a;if("loaded"!==a._state)return a._queue.push({event:"orientation",action:function(){a.orientation(t,i,s,o)}}),a;if(i="number"!=typeof i?a._orientation[1]:i,s="number"!=typeof s?a._orientation[2]:s,void 0===o){if("number"!=typeof t)return a._orientation;a._orientation=[t,i,s]}for(var r=a._getSoundIds(o),n=0;n<r.length;n++){var h=a._soundById(r[n]);if(h){if("number"!=typeof t)return h._orientation;h._orientation=[t,i,s],h._node&&(h._panner||(h._pos||(h._pos=a._pos||[0,0,-.5]),e(h,"spatial")),void 0!==h._panner.orientationX?(h._panner.orientationX.setValueAtTime(t,Howler.ctx.currentTime),h._panner.orientationY.setValueAtTime(i,Howler.ctx.currentTime),h._panner.orientationZ.setValueAtTime(s,Howler.ctx.currentTime)):h._panner.setOrientation(t,i,s)),a._emit("orientation",h._id)}}return a},Howl.prototype.pannerAttr=function(){var t,i,s,o=this,a=arguments;if(!o._webAudio)return o;if(0===a.length)return o._pannerAttr;if(1===a.length){if("object"!=typeof a[0])return(s=o._soundById(parseInt(a[0],10)))?s._pannerAttr:o._pannerAttr;t=a[0],void 0===i&&(t.pannerAttr||(t.pannerAttr={coneInnerAngle:t.coneInnerAngle,coneOuterAngle:t.coneOuterAngle,coneOuterGain:t.coneOuterGain,distanceModel:t.distanceModel,maxDistance:t.maxDistance,refDistance:t.refDistance,rolloffFactor:t.rolloffFactor,panningModel:t.panningModel}),o._pannerAttr={coneInnerAngle:void 0!==t.pannerAttr.coneInnerAngle?t.pannerAttr.coneInnerAngle:o._coneInnerAngle,coneOuterAngle:void 0!==t.pannerAttr.coneOuterAngle?t.pannerAttr.coneOuterAngle:o._coneOuterAngle,coneOuterGain:void 0!==t.pannerAttr.coneOuterGain?t.pannerAttr.coneOuterGain:o._coneOuterGain,distanceModel:void 0!==t.pannerAttr.distanceModel?t.pannerAttr.distanceModel:o._distanceModel,maxDistance:void 0!==t.pannerAttr.maxDistance?t.pannerAttr.maxDistance:o._maxDistance,refDistance:void 0!==t.pannerAttr.refDistance?t.pannerAttr.refDistance:o._refDistance,rolloffFactor:void 0!==t.pannerAttr.rolloffFactor?t.pannerAttr.rolloffFactor:o._rolloffFactor,panningModel:void 0!==t.pannerAttr.panningModel?t.pannerAttr.panningModel:o._panningModel})}else 2===a.length&&(t=a[0],i=parseInt(a[1],10));for(var r=o._getSoundIds(i),n=0;n<r.length;n++)if(s=o._soundById(r[n])){var h=s._pannerAttr;h={coneInnerAngle:void 0!==t.coneInnerAngle?t.coneInnerAngle:h.coneInnerAngle,coneOuterAngle:void 0!==t.coneOuterAngle?t.coneOuterAngle:h.coneOuterAngle,coneOuterGain:void 0!==t.coneOuterGain?t.coneOuterGain:h.coneOuterGain,distanceModel:void 0!==t.distanceModel?t.distanceModel:h.distanceModel,maxDistance:void 0!==t.maxDistance?t.maxDistance:h.maxDistance,refDistance:void 0!==t.refDistance?t.refDistance:h.refDistance,rolloffFactor:void 0!==t.rolloffFactor?t.rolloffFactor:h.rolloffFactor,panningModel:void 0!==t.panningModel?t.panningModel:h.panningModel};var l=s._panner;l||(s._pos||(s._pos=o._pos||[0,0,-.5]),e(s,"spatial"),l=s._panner),l.coneInnerAngle=h.coneInnerAngle,l.coneOuterAngle=h.coneOuterAngle,l.coneOuterGain=h.coneOuterGain,l.distanceModel=h.distanceModel,l.maxDistance=h.maxDistance,l.refDistance=h.refDistance,l.rolloffFactor=h.rolloffFactor,l.panningModel=h.panningModel}return o},Sound.prototype.init=function(t){return function(){var e=this,i=e._parent;e._orientation=i._orientation,e._stereo=i._stereo,e._pos=i._pos,e._pannerAttr=i._pannerAttr,t.call(this),e._stereo?i.stereo(e._stereo):e._pos&&i.pos(e._pos[0],e._pos[1],e._pos[2],e._id)}}(Sound.prototype.init),Sound.prototype.reset=function(t){return function(){var e=this,i=e._parent;return e._orientation=i._orientation,e._stereo=i._stereo,e._pos=i._pos,e._pannerAttr=i._pannerAttr,e._stereo?i.stereo(e._stereo):e._pos?i.pos(e._pos[0],e._pos[1],e._pos[2],e._id):e._panner&&(e._panner.disconnect(0),e._panner=void 0,i._refreshBuffer(e)),t.call(this)}}(Sound.prototype.reset);var e=function(t,e){"spatial"===(e=e||"spatial")?(t._panner=Howler.ctx.createPanner(),t._panner.coneInnerAngle=t._pannerAttr.coneInnerAngle,t._panner.coneOuterAngle=t._pannerAttr.coneOuterAngle,t._panner.coneOuterGain=t._pannerAttr.coneOuterGain,t._panner.distanceModel=t._pannerAttr.distanceModel,t._panner.maxDistance=t._pannerAttr.maxDistance,t._panner.refDistance=t._pannerAttr.refDistance,t._panner.rolloffFactor=t._pannerAttr.rolloffFactor,t._panner.panningModel=t._pannerAttr.panningModel,void 0!==t._panner.positionX?(t._panner.positionX.setValueAtTime(t._pos[0],Howler.ctx.currentTime),t._panner.positionY.setValueAtTime(t._pos[1],Howler.ctx.currentTime),t._panner.positionZ.setValueAtTime(t._pos[2],Howler.ctx.currentTime)):t._panner.setPosition(t._pos[0],t._pos[1],t._pos[2]),void 0!==t._panner.orientationX?(t._panner.orientationX.setValueAtTime(t._orientation[0],Howler.ctx.currentTime),t._panner.orientationY.setValueAtTime(t._orientation[1],Howler.ctx.currentTime),t._panner.orientationZ.setValueAtTime(t._orientation[2],Howler.ctx.currentTime)):t._panner.setOrientation(t._orientation[0],t._orientation[1],t._orientation[2])):(t._panner=Howler.ctx.createStereoPanner(),t._panner.pan.setValueAtTime(t._stereo,Howler.ctx.currentTime)),t._panner.connect(t._node),t._paused||t._parent.pause(t._id,!0).play(t._id,!0)}}()},4208:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Hourglass=void 0;const s=i(5180);class o extends s.Usable{constructor(t,e,i){super(t,e,i),this.onUse=t=>{this.broken||(t.stall(),t.game.pushMessage("turn skipped"),this.durability-=1,this.durability<=0&&(this.broken=!0))},this.getDescription=()=>"HOURGLASS\nSkips a turn",this.tileX=0,this.tileY=2,this.offsetY=-.3,this.durability=30,this.durabilityMax=30,this.name=o.itemName}}e.Hourglass=o,o.itemName="hourglass"},4223:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Shrooms=void 0;const s=i(5180),o=i(7366);class a extends s.Usable{constructor(t,e,i){super(t,e,i),this.onUse=t=>{t.health<t.maxHealth&&(t.health=Math.min(t.maxHealth,t.health+.5),o.Sound.playEat(),this.stackCount>1?this.stackCount--:t.inventory.removeItem(this),t.game.pushMessage("You eat the mushrooms and feel better."))},this.getDescription=()=>"SHROOMS\nI don't think I should eat these...",this.tileX=6,this.tileY=0,this.name=a.itemName,this.stackable=!0}}e.Shrooms=a,a.itemName="mushrooms"},4254:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Player=e.PlayerDirection=void 0;const s=i(3628),o=i(6291),a=i(7851),r=i(4804),n=i(3139),h=i(8026),l=i(7366),c=i(1285),d=i(232),m=i(75),u=i(8160),p=i(5366),y=i(6105),g=i(6986),f=i(8900),w=i(3130),E=i(503),x=i(2890),b=i(6822),T=i(1879),I=i(2041),S=i(2057),v=i(3436),A=i(5947),M=i(2502),C=i(6277),D=i(8287),O=i(1887),_=i(9467),R=i(1425);var G,P;(P=e.PlayerDirection||(e.PlayerDirection={}))[P.DOWN=0]="DOWN",P[P.UP=1]="UP",P[P.RIGHT=2]="RIGHT",P[P.LEFT=3]="LEFT",function(t){t[t.X=0]="X",t[t.Y=1]="Y"}(G||(G={}));class L extends u.Drawable{constructor(t,e,i,u,P=0){super(),this.drowningDamageSteps=[5,4,3,2,1],this.drowningDamageAmount=.5,this.divingHelmetRefillPerTurn=12,this.drawMoveQueue=[],this.bubbleSpawnAccumulator=0,this.bubbleSpawnInterval=7,this.bubbleBreathTimer=0,this.bubbleBreathPeriod=240,this.seenEnemies=new Set,this.bestiary=null,this.getRoom=()=>{const t=this.game,e=t.getRoomById?.(this.roomGID);return e||this.game.levels[this.depth].rooms[this.levelID]},this.getEquippedDivingHelmet=()=>this.inventory.items.find(t=>t instanceof y.DivingHelmet&&t.equipped)??null,this.getInterpolatedTilePosition=()=>({x:this.x-this.drawX,y:this.y-this.drawY}),this.getOxygenLine=()=>this.oxygenLine,this.attachOxygenLine=(t,e,i,s)=>{this.oxygenLine.attach(t,e,i,s)},this.detachOxygenLine=()=>{this.oxygenLine.detach()},this.anchorOxygenLineToTile=(t,e,i,s)=>{this.oxygenLine.attachStartToTile(t,e,i,s)},this.anchorOxygenLineToPlayer=t=>{this.oxygenLine.attachStartToPlayer(t)},this.recordOxygenDoorTraversal=(t,e)=>{this.oxygenLine.recordDoorTraversal(t,e)},this.getJumpY=()=>this.renderer?.getJumpOffset?.()??0,this.getOxygenBaseOffset=()=>L.oxygenLineBaseOffset,this.getOxygenAttachmentOffset=()=>this.getJumpY()+L.oxygenLineBaseOffset,this.setHitXY=(t,e,i=.5)=>{this.renderer.hitX=i*(this.x-t),this.renderer.hitY=i*(this.y-e)},this.applyStatus=(t,e)=>{if(t instanceof g.Enemy){if(e.poison)return t.poison(),!0;if(e.blood)return t.bleed(),!0}},this.isMouseOnPlayerTile=()=>this.mouseToTile().x===this.x&&this.mouseToTile().y===this.y,this.isMouseAboveFloor=(t=0)=>{const e=this.mouseToTile(t);if(void 0===e.x||void 0===e.y)return!1;const i=e.x,s=e.y;return!!(this.game.levelState!==a.LevelState.LEVEL_GENERATION&&this.game.started&&this.game.room&&this.game.room.roomArray&&Array.isArray(this.game.room.roomArray[i])&&void 0!==this.game.room.roomArray[i][s])&&!(!this.game.room?.tileInside(i,s)||this.game.room?.tileInside(i,s)&&this.game.room?.roomArray[i][s].isSolid()&&!(this.game.room?.roomArray[i][s]instanceof r.Door))},this.mouseInLine=()=>{const t=this.mouseToTile();return void 0!==t.x&&void 0!==t.y&&(t.x===this.x||t.y===this.y)},this.canMoveWithMouse=()=>{if(this.inventory.isOpen)return null;const t=this.isMouseAboveFloor(),e=this.isMouseAboveFloor(8);if(!t&&!e)return null;const i=this.mouseToTile(),s=this.mouseToTile(8);if(void 0===i.x||void 0===i.y||void 0===s.x||void 0===s.y)return null;if(!this.game.room.roomArray||!this.game.room.roomArray[i.x]||!this.game.room.roomArray[i.x][i.y])return null;let o=i.y;const r=this.checkTileForEntity(s);e&&r&&(o=s.y);const n=i.x===this.x,h=o===this.y;if(n&&h)return null;if(n){const t=o<this.y?this.y-1:this.y+1;return this.game.room.roomArray[this.x]&&this.game.room.roomArray[this.x][t]?o<this.y?{direction:a.Direction.UP,x:this.x,y:t}:{direction:a.Direction.DOWN,x:this.x,y:t}:null}if(h){const t=i.x<this.x?this.x-1:this.x+1;return this.game.room.roomArray[t]&&this.game.room.roomArray[t][this.y]?i.x<this.x?{direction:a.Direction.LEFT,x:t,y:this.y}:{direction:a.Direction.RIGHT,x:t,y:this.y}:null}return null},this.stall=()=>{this.game.started&&this.game.room&&this.renderer&&this.game.levelState===a.LevelState.IN_LEVEL&&(this.game?.room?.tick(this),this.shakeScreen(this.x-.5,this.y,this.x+.5,this.y,5),this.game.pushMessage("Equipping an item takes a turn."))},this.moveWithMouse=()=>{if(this.inputHandler.setMostRecentMoveInput("mouse"),!o.GameConstants.MOVE_WITH_MOUSE)return;const t=this.canMoveWithMouse();null!==t&&this.actionProcessor.process({type:"MouseMove",direction:t.direction,targetX:t.x,targetY:t.y})},this.mouseToTile=(t=0)=>{if(void 0===s.Input.mouseX||void 0===s.Input.mouseY)return{x:void 0,y:void 0};const e=o.GameConstants.WIDTH/2,i=o.GameConstants.HEIGHT/2,a=Math.floor((s.Input.mouseX-e+o.GameConstants.TILESIZE/2)/o.GameConstants.TILESIZE),r=Math.floor((s.Input.mouseY+t-i+o.GameConstants.TILESIZE/2)/o.GameConstants.TILESIZE);return{x:this.x+a,y:this.y+r}},this.tileToMouse=(t,e)=>{const i=o.GameConstants.WIDTH/2,s=o.GameConstants.HEIGHT/2,a=t-this.x,r=e-this.y;return{x:i+a*o.GameConstants.TILESIZE,y:s+r*o.GameConstants.TILESIZE}},this.setTileCursorPosition=()=>{const t=Math.floor(o.GameConstants.WIDTH/2)/o.GameConstants.TILESIZE,e=Math.floor(o.GameConstants.HEIGHT/2)/o.GameConstants.TILESIZE,i=this.mouseToTile();let s=i.x-this.x+t-.5,a=i.y-this.y+e-.5;const r=t,n=e;Math.abs(s+.5-r)>1&&(s=r+(s>r?1:-1)-.5),Math.abs(a+.5-n)>1&&(a=n+(a>n?1:-1)-.5),this.tileCursor={x:s,y:a}},this.enemyInRange=(t,e,i)=>{const s=i??1;return(t!==this.x||e!==this.y)&&(t===this.x||e===this.y)&&(e===this.y?Math.abs(t-this.x)<=s:t===this.x&&Math.abs(e-this.y)<=s)},this.getDirectionFromCoords=(t,e)=>t===this.x&&e===this.y||t!==this.x&&e!==this.y?"":e===this.y?t>this.x?"right":"left":t===this.x?e>this.y?"down":"up":"arrow",this.setCursorIcon=()=>{if(this.inventory.isDragging)return void f.MouseCursor.getInstance().setIcon("grab");const t=f.MouseCursor.getInstance(),e=t.getPosition(),i=this.mouseToTile(),s=this.getCursorState(e,i);t.setIcon(s)},this.getCursorState=(t,e)=>this.isMouseInUI(t)?"hand":this.isEntityAttackable(e)?"sword":this.isMouseAboveFloor()&&this.mouseInLine()?this.enemyInRange(e.x,e.y,1)?this.getDirectionFromCoords(e.x,e.y):"hand":"arrow",this.isMouseInUI=t=>{const{x:e,y:i}=t;return this.inventory.isPointInInventoryButton(e,i)||this.isInventoryItemInteraction(e,i)},this.isInventoryItemInteraction=(t,e)=>{const i=this.inventory.itemAtSelectedSlot()instanceof p.Item;return this.inventory.isPointInQuickbarBounds(t,e).inBounds&&i||this.inventory.isOpen&&this.inventory.isPointInInventoryBounds(t,e).inBounds&&i},this.isEntityAttackable=t=>!!this.checkTileForEntity(t)||this.checkTileForEntity({x:t.x,y:this.mouseToTile(o.GameConstants.TILESIZE/2).y}),this.checkTileForEntity=t=>{const e=this.inventory.weapon?.range??1;return this.game.room.entities.some(i=>i.x===t.x&&i.y===t.y&&this.enemyInRange(i.x,i.y,e))},this.restart=()=>{this.dead=!1,this.game.newGame(),this.deathScreenPageIndex=0,this.deathScreenPageCount=1},this.hit=()=>1,this.tryCollide=(t,e,i)=>!(!1===t.collidable||e>=t.x+t.w||e+this.w<=t.x||i>=t.y+t.h||i+this.h<=t.y),this.tryMove=(t,e)=>{if(this.busyAnimating||this.game.levelState===a.LevelState.TRANSITIONING||this.game.levelState===a.LevelState.TRANSITIONING_LADDER)return;if(this.getRoom().catchUp(),!this.game.room)return void console.warn("oi bruv, game.room isn't even there!");if(this.dead)return;let i=!1;for(let s of this.getRoom().entities)if(s.z===this.z&&!0===s.collidable&&s.x===t&&s.y===e){i=!0;break}if(this.inventory.hasWeapon()&&!this.inventory.getWeapon().weaponMove(t,e))return;this.inventory.hasWeapon()||this.game.pushMessage("No weapon equipped.");for(let i of this.getRoom().entities)if(i.z===this.z&&(i.lastX=i.x,i.lastY=i.y,this.tryCollide(i,t,e)))if(i.pushable){let s=t-this.x,o=e-this.y,a=t+s,r=e+o,n=!1,h=!1,c=[];for(;;){n=!0;for(const t of this.getRoom().entities)if(t.z===this.z&&(t.lastX=t.x,t.lastY=t.y,t.pointIn(a,r))){if(!t.chainPushable){h=!0,n=!0;break}n=!1,c.push(t);break}if(n)break;a+=s*c[c.length-1].w,r+=o*c[c.length-1].h}if(0!==c.length||!this.getRoom().roomArray[a][r].canCrushEnemy()&&!h){this.getRoom()===this.game.room&&l.Sound.push();for(const t of c)t.lastX=t.x,t.lastY=t.y,t.x+=s,t.y+=o,t.drawX=s,t.drawY=o,t.skipNextTurns=1;if(this.getRoom().roomArray[a][r].canCrushEnemy()||h){const t=c[c.length-1];t.crush(),t.isEnemy&&l.Sound.playSquish(),this.getRoom()===this.game.room&&l.Sound.hit()}return i.x+=s,i.y+=o,i.drawX=s,i.drawY=o,this.move(t,e),this.moveDistance++,void this.getRoom().tick(this)}if(i.destroyable)return i.hurt(this,i.health,"none"),this.getRoom()===this.game.room&&l.Sound.hit(),this.shakeScreen(this.x,this.y,i.x,i.y),this.hitShake(this.x,this.y,i.x,i.y),void this.getRoom().tick(this)}else if(!i.dead)return void(i.interactable&&i.interact(this));let s=this.getRoom()?.roomArray?.[t]?.[e];if(s)if(this.getRoom())if(this.getRoom().roomArray)if(s.isSolid())s instanceof r.Door&&(this.shakeScreen(this.x,this.y,t,e),s.canUnlock(this)?s.unlock(this):l.Sound.playLocked());else{if((s instanceof S.UpLadder||s instanceof v.DownLadder)&&s.isLocked())return this.shakeScreen(this.x,this.y,t,e),s.lockable.canUnlock(this)?s.lockable.unlock(this):l.Sound.playLocked(),s.addLightSource(),void this.game.room.updateLighting();this.move(t,e),s.onCollide(this),s instanceof r.Door||s instanceof n.Trapdoor||s instanceof S.UpLadder||s instanceof v.DownLadder||this.getRoom().tick(this)}else console.warn("oi bruv, level to check for collision isn't even there!");else console.warn("oi bruv, room to check for collision isn't even there!");else console.warn("oi bruv, tile to check for collision isn't even there!")},this.updateLastPosition=(t,e)=>{this.lastX=t,this.lastY=e},this.hurt=(t,e,i=0)=>{this.getRoom()===this.game.room&&setTimeout(()=>{l.Sound.hurt(),l.Sound.playGrunt(),this.renderer.flash(),this.renderer.hurt()},i);const s=this.inventory.getArmor();let a=0;s&&s.health>0&&(a=s.health-t,s.hurt(t),this.renderer.hurtShield(),this.hurtShield=!0),this.lastHitBy=e,this.healthBar.hurt(),this.enemyHurtMessage(t,e),this.hurtShield?a<0&&(this.health+=a,M.globalEventBus.emit(C.EVENTS.DAMAGE_TAKEN,{amount:-a})):(this.health-=t,M.globalEventBus.emit(C.EVENTS.DAMAGE_TAKEN,{amount:t})),this.hurtShield=!1,this.health<=0&&!o.GameConstants.DEVELOPER_MODE&&(this.dead=!0,this.deathScreenPageIndex=0,this.deathScreenPageCount=1)},this.enemyHurtMessage=(t,e)=>{o.GameConstants.DEVELOPER_MODE||this.game.pushMessage(`The ${e} hits you for ${t} damage.`)},this.beginSlowMotion=()=>{this.renderer.beginSlowMotion()},this.endSlowMotion=()=>{this.renderer.endSlowMotion()},this.move=(t,e)=>{this.updateLastPosition(this.x,this.y),this.getRoom()===this.game.room&&l.Sound.playerStoneFootstep(this.game.room.envType),this.openVendingMachine&&this.openVendingMachine.close(),this.renderer.setNewDrawXY(t,e),this.drawMoveQueue.push({drawX:t-this.x,drawY:e-this.y}),this.x=t,this.y=e;for(let i of this.getRoom().items)i.z===this.z&&i.x===t&&i.y===e&&i.onPickup(this);let i=t-this.lastX,s=e-this.lastY;if(0!==i||0!==s)for(let t of this.game.level.rooms)t.roomOnScreen(this),t.onScreen},this.moveNoSmooth=(t,e)=>{this.x=t,this.y=e},this.moveSnap=(t,e)=>{this.x=Math.round(t),this.y=Math.round(e),this.renderer.snapDrawStuff()},this.update=()=>{},this.finishTick=()=>{this.turnCount+=1,this.inventory.tick(),this.oxygenLine.update(),this.handleUnderwater(),this.renderer.disableFlash();let t=this.health-this.lastTickHealth;this.lastTickHealth=this.health,t<0&&this.renderer.flash(),M.globalEventBus.emit(C.EVENTS.TURN_PASSED,{}),this.moveDistance=0},this.handleUnderwater=()=>{const t=this.getRoom();if(!t)return;const e=this.getEquippedDivingHelmet(),i=!0===t.underwater,s=!!e&&this.oxygenLine.isSupplyingAir();return i?s?(e?.refillCompletely(),void(this.isDrowning&&this.exitDrowningState())):e&&e.hasAir()?(e.consumeAir(),void(this.isDrowning&&this.exitDrowningState())):void this.applyDrowningTick():(e&&e.currentAir<e.maxAir&&e.restoreAir(this.divingHelmetRefillPerTurn),void(this.isDrowning&&this.exitDrowningState()))},this.applyDrowningTick=()=>{this.enterDrowningState(),this.drowningTurnsUntilDamage-=1,this.drowningTurnsUntilDamage<=0&&(this.hurt(this.drowningDamageAmount,"drowning"),this.advanceDrowningWindow())},this.enterDrowningState=()=>{this.isDrowning?this.drowningTurnsUntilDamage<=0&&(this.drowningTurnsUntilDamage=this.drowningDamageSteps[this.drowningIntervalIndex]??1):(this.isDrowning=!0,this.drowningIntervalIndex=0,this.drowningTurnsUntilDamage=this.drowningDamageSteps[0],this.game.pushMessage("You are drowning!"))},this.advanceDrowningWindow=()=>{this.drowningIntervalIndex<this.drowningDamageSteps.length-1?(this.drowningIntervalIndex+=1,this.drowningTurnsUntilDamage=this.drowningDamageSteps[this.drowningIntervalIndex]):this.drowningTurnsUntilDamage=1},this.exitDrowningState=()=>{this.isDrowning&&(this.isDrowning=!1,this.drowningTurnsUntilDamage=0,this.drowningIntervalIndex=0,this.game.pushMessage("You catch your breath."))},this.getDrowningTurnsUntilDamage=()=>this.drowningTurnsUntilDamage,this.draw=t=>{this.renderer.draw(t),this.emitPlayerBubbles(t)},this.emitPlayerBubbles=t=>{if(!this.isLocalPlayer)return;const e=this.getRoom();if(!e||e!==this.game.room||!e.underwater)return;for(this.bubbleBreathTimer+=t;this.bubbleBreathTimer>this.bubbleBreathPeriod;)this.bubbleBreathTimer-=this.bubbleBreathPeriod;const i=this.bubbleBreathTimer/this.bubbleBreathPeriod*Math.PI*2,s=Math.sin(i);if(!(s<=0))for(this.bubbleSpawnAccumulator+=t*s;this.bubbleSpawnAccumulator>=this.bubbleSpawnInterval;){this.bubbleSpawnAccumulator-=this.bubbleSpawnInterval;const t=.1*_.Random.rand()-.15,i=(_.Random.rand(),this.x+.5+t),s=this.y-.5,o=Math.floor(3*_.Random.rand());e.particles.push(new O.BubbleImageParticle(e,i,s,{height:.02+.08*_.Random.rand(),tileX:9+o,tileY:26}))}},this.heal=t=>{this.health+=t,this.health>this.maxHealth&&(this.health=this.maxHealth)},this.hitShake=(t,e,i,s)=>{const a=o.GameConstants.TILESIZE,r=Math.min(Math.max(.5*(t-i),-a),a),n=Math.min(Math.max(.5*(e-s),-a),a);this.renderer.setHitXY(r,n)},this.shakeScreen=(t,e,i,s,a=10)=>{const r=o.GameConstants.TILESIZE,n=Math.min(Math.max(.5*(t-i),-r),r),h=Math.min(Math.max(.5*(e-s),-r),r);this.renderer.setHitXY(n,h),this.game.shakeScreen(1*-n*a,1*-h*a)},this.updateSlowMotion=()=>{this.renderer.updateSlowMotion()},this.drawGUI=t=>{this.renderer.drawGUI(t)},this.globalId=A.IdGenerator.generate("P"),this.game=t,this.levelID=0,this.roomGID=void 0,this.x=e,this.y=i,this.z=P,this.w=1,this.h=1,this.moveDistance=0,this.direction=a.Direction.UP,this.lastDirection=a.Direction.UP,this.lastX=0,this.lastY=0,this.isLocalPlayer=u,this.depth=0,this.menu=new w.Menu(this),this.busyAnimating=!1,this.mapToggled=!0,this.health=D.GameplaySettings.STARTING_HEALTH,this.maxHealth=D.GameplaySettings.STARTING_HEALTH,this.healthBar=new m.HealthBar,this.dead=!1,this.lastTickHealth=this.health,this.damageBonus=0,this.magicDamageBonus=0,this.isDrowning=!1,this.drowningTurnsUntilDamage=0,this.drowningIntervalIndex=0,this.inventory=new h.Inventory(t,this),this.defaultSightRadius=3,this.sightRadius=c.LevelConstants.LIGHTING_MAX_DISTANCE,this.map=new d.Map(this.game,this),this.turnCount=0,this.triedMove=!1,this.tutorialRoom=!1,this.tileCursor={x:0,y:0},this.moveRange=1,this.lightEquipped=!1,this.lightColor=c.LevelConstants.AMBIENT_LIGHT_COLOR,this.lightFov=o.GameConstants.DEFAULT_LIGHTING_FOV_DEGREES,this.lightFalloffDecay=1,this.hurtShield=!1,this.lightBrightness=.3,this.moveQueue=[],this.justMoved=G.Y,this.inputHandler=new x.PlayerInputHandler(this),this.actionProcessor=new b.PlayerActionProcessor(this),this.movement=new T.PlayerMovement(this),this.renderer=new I.PlayerRenderer(this),this.oxygenLine=new R.OxygenLine(this),this.bestiary=new E.Bestiary(this.game,this),this.cooldownRemaining=0,this.deathScreenPageIndex=0,this.deathScreenPageCount=1,this.hasBloom=!0}get hitX(){return this.renderer?.drawX??0}get hitY(){return this.renderer?.drawY??0}get drawX(){return this.renderer?.drawX??0}get drawY(){return this.renderer?.drawY??0}}e.Player=L,L.minSightRadius=2,L.oxygenLineBaseOffset=1.4},4371:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Tips=void 0;const s=i(9467),o=["Too dark? Equip a light source to light up the area around you.","Red X's show dangerous tiles, stay off of them to avoid taking damage.","If you kill an enemy, it can't hit you on the next turn.","Use weapon fragments on your weapon to repair broken weapons.","A yellow box around an item means it can be used on another item.","Lanterns can be refueled with coal.","Some objects can be pushed and kill enemies by crushing them.","Reapers spawn other enemies. Target them first to avoid being overrun.","Occultists apply a purple occult shield to enemies, giving them an extra health.","Killing an Occultist also removes the shields of each shielded enemy.","Some enemies have helmets, giving them extra health.","The shield absorbs one damage, and regenerates within 15 turns.","Explore alternate pathways like caves to gather resources to prepare for tough battles.","Vending machine sell useful items in exchange for coins.","Different enemies have different movement and attack patterns.","Frogs can only deal half damage, but can attack two tiles away in any direction.","Sometimes you will need to switch weapons mid-fight to use the best one for the situation.","Once you reach the end of a level you can get back to the beginning easily through tunnel doors.","Dual daggers give you an extra turn. After attacking you can attack or move again.","The Warhammer does two damage for taking out enemies with more than one health.","The spear has an attack range of two, so you can hit enemies from a safe distance.","Bombs can be placed to blow up enemies, just be sure to avoid blowing yourself up.","Mushrooms heal one half health.","Weapon blood can be applied to your weapon, giving it a powerful bleed effect upon attacking.","Weapon poison can be applied to your weapon poisoning enemies upon attacking.","The spellbook can attack multiple enemies from long range, great for getting out of tough situations.","Bishops can move diagonally and might sneak up on you if you aren't careful.","Rooks can move every turn and attack from any direction.","Queens can move any direction and have two health, but retreat when hit.","Dark? Equip light source.","Red X = danger. Avoid.","Kill enemy = safe next turn.","Use fragments to repair weapons.","Yellow box = usable on items.","Coal refuels lanterns.","Push objects to crush enemies.","Kill reapers first - they spawn enemies.","Occultists give enemies purple shields.","Kill occultist = remove all shields.","Helmets = extra enemy health.","Shield: 1 damage, regens in 15 turns.","Explore caves for resources.","Vending machines: coins for items.","Enemies have unique patterns.","Frogs: half damage, 2-tile range.","Switch weapons mid-fight.","Tunnel doors = quick return to start.","Dual daggers = extra turn after attack.","Warhammer: 2 damage vs multi-health.","Spear: 2-tile range.","Bombs blow up enemies (not you).","Mushrooms: heal 0.5 health.","Weapon blood = bleed effect.","Weapon poison = poison effect.","Spellbook: multi-enemy, long range.","Bishops: diagonal movement.","Rooks: move every turn, any direction.","Queens: 2 health, retreat when hit."];e.Tips=class{static getRandomTip(){return o[Math.floor(s.Random.rand()*o.length)]}}},4396:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.EnemyShield=void 0;const s=i(8774),o=i(7851),a=i(1124),r=i(8075);class n extends s.Projectile{constructor(t,e,i,s=1,n=!0){super(t,e,i),this.remove=()=>{this.parent.shielded=!1,this.parent.removeLightSource(this.lightSource),this.parent.room.projectiles=this.parent.room.projectiles.filter(t=>t!==this);let t=this.parent.room.projectiles.find(t=>t instanceof r.BeamEffect&&t.parent===this.parent);t&&(t.dead=!0),this.parent.shadeColor="black",this.lightSource=null,this.parent.shield=null},this.updateLightSourcePos=()=>{if(null===this.lightSource)return;let t=this.parent.room.lightSources.indexOf(this.lightSource);this.parent.room.lightSources[t].x=this.parent.x+.5,this.parent.room.lightSources[t].y=this.parent.y+.5},this.hurt=t=>{const e=Math.max(0,t-this.health);return this.health-=t,this.parent.maxHealth-=t,this.health<=0&&this.remove(),e},this.tick=()=>{this.parent&&this.parent.room?(this.parent?.dead&&this.remove(),this.dead&&this.parent&&this.parent.room&&(this.parent.room.projectiles=this.parent.room.projectiles.filter(t=>t!==this))):this.dead=!0},this.draw=t=>{this.dead||(o.Game.ctx.save(),o.Game.ctx.globalAlpha=1,this.frame+=.1*t,this.frame>=4&&(this.frame=0),this.drawableY=this.parent.drawableY-.05,o.Game.ctx.globalCompositeOperation="difference",this.parent.shielded&&o.Game.drawFX(18+Math.floor(this.frame),9,1,1,this.parent.x-this.parent.drawX,this.parent.y-this.parent.drawY,1,1),o.Game.ctx.restore())},this.parent=t,this.frame=0,this.health=s,this.autoRegistered=!1,this.parent&&this.parent.room?(this.parent.shielded=!0,this.lightSource=a.Lighting.newLightSource(this.x+.5,this.y+.5,[20,0,40],3.5,20),this.parent.addLightSource(this.lightSource),n&&(this.parent.room.projectiles.push(this),this.autoRegistered=!0),this.parent.room.updateLighting({x:this.x,y:this.y})):this.dead=!0}}e.EnemyShield=n},4438:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.OccultistEnemy=void 0;const s=i(7851),o=i(7851),a=i(6986),r=i(6199),n=i(8075),h=i(1124),l=i(9467),c=i(8287),d=i(7455);class m extends a.Enemy{constructor(t,e,i,m){super(t,e,i,m),this.hit=()=>1,this.bleed=()=>{},this.uniqueKillBehavior=()=>{this.unshieldEnemies(),this.removeLightSource(this.lightSource),this.lightSource=null},this.behavior=()=>{this.lastX=this.x,this.lastY=this.y;let t=this.enemyShieldCandidates();if(!this.dead){if(this.handleSkipTurns())return;if(this.ticks++,this.shieldEnemies(t),this.updateShieldedEnemies(),this.shieldedEnemies.length>0){let t=this.shieldedEnemies.reduce((t,e)=>{const i=r.Utils.distance(this.x,this.y,t.x,t.y);return r.Utils.distance(this.x,this.y,e.x,e.y)>i?e:t}),e=Array();for(const t of this.room.entities)t!==this&&e.push({x:t.x,y:t.y});for(let t=this.x-1;t<=this.x+1;t++)for(let i=this.y-1;i<=this.y+1;i++)this.room.roomArray[t][i]instanceof d.SpikeTrap&&this.room.roomArray[t][i].on&&e.push({x:t,y:i});const i=this.searchPathLocalized({x:t.x,y:t.y},e);if(i.length>0){const t=this.x,e=this.y,s=i[0].pos.x,a=i[0].pos.y;this.tryMove(s,a),this.setDrawXY(t,e),this.x>t?this.direction=o.Direction.RIGHT:this.x<t?this.direction=o.Direction.LEFT:this.y>e?this.direction=o.Direction.DOWN:this.y<e&&(this.direction=o.Direction.UP)}}else this.runAway()}this.shieldedEnemies.length>0?this.shadeColor="#2E0854":this.shadeColor="#000000",this.lightSource&&this.lightSource.updatePosition(this.x+.5,this.y+.5)},this.onHurt=(t=1)=>{this.health<this.lastHealth&&this.health%2==0&&this.health>0&&this.teleport(),this.lastHealth=this.health},this.updateShieldedEnemies=()=>{this.shieldedEnemies.forEach(t=>{t.dead&&(this.shieldedEnemies=this.shieldedEnemies.filter(e=>e!==t))})},this.shieldEnemies=t=>{t.length>0&&t.forEach(t=>{const e=r.Utils.distance(this.x,this.y,t.x,t.y);10*l.Random.rand()>e&&this.applyShieldTo(t)})},this.enemyShieldCandidates=()=>this.room.entities.filter(t=>t instanceof a.Enemy&&r.Utils.distance(this.x,this.y,t.x,t.y)<=this.range&&!t.shielded&&!t.dead&&t!==this&&!t.shieldedBefore).slice(0,c.GameplaySettings.MAX_OCCULTIST_SHIELDS),this.unshieldEnemies=()=>{if(this.shieldedEnemies.length>0){for(let t of this.shieldedEnemies)t.cloned||t.removeShield();this.shieldedEnemies=[]}},this.applyShieldTo=t=>{if(this.shadeMultiplier=1.5,t.applyShield(),this.shieldedEnemies.push(t),t.shielded&&t.shield){let e=new n.BeamEffect(t.x,t.y,this.x,this.y,t);e.compositeOperation="source-over",e.color="#2E0854",e.turbulence=.4,e.gravity=.1,e.iterations=1,e.segments=100,e.angleChange=.001,e.springDamping=.01,e.drawableY=t.drawableY,e.type="shield",this.room.projectiles.push(e)}},this.updateBeam=t=>{for(let t of this.room.projectiles)if(t instanceof n.BeamEffect){if(!this.shieldedEnemies.includes(t.parent)||"shield"!==t.type)continue;switch(t.setTarget(this.x-this.drawX,this.y-this.drawY,t.parent.x-t.parent.drawX,t.parent.y-t.parent.drawY),t.drawableY=t.parent.drawableY,Math.floor(this.frame)){case 0:t.color="#2e0854";break;case 1:case 3:t.color="#331988";break;case 2:t.color="#4729db"}}},this.draw=t=>{this.dead||(s.Game.ctx.save(),s.Game.ctx.globalAlpha=this.alpha,this.drawableY=this.y,this.dead||(this.updateDrawXY(t),this.updateBeam(t),this.frame+=.1*t,this.frame>=4&&(this.frame=0),this.hasShadow&&this.drawShadow(t),s.Game.drawMob(this.tileX+Math.floor(this.frame),this.tileY,1,2,this.x-this.drawX,this.y-this.drawYOffset-this.drawY,1,2,this.softShadeColor,this.shadeAmount(),void 0,this.outlineColor(),this.outlineOpacity())),s.Game.ctx.restore())},this.ticks=0,this.health=6,this.lastHealth=this.health,this.maxHealth=6,this.tileX=55,this.tileY=8,this.seenPlayer=!0,this.name="occultist",this.range=6,this.aggro=!1,this.frame=0,this.hasShadow=!0,this.shieldedBefore=!1,this.shieldedEnemies=[],this.shadeColor="#000000",this.lightSource=h.Lighting.newLightSource(this.x+.5,this.y+.5,[20,0,40],3.5,20),this.addLightSource(this.lightSource),this.room.updateLighting(),this.hasBloom=!0,this.bloomColor="#2E0854",this.bloomAlpha=1,this.softBloomAlpha=0,this.dropChance=1,this.getDrop(["occultist"],!1),this.pushable=!1,this.chainPushable=!1,this.destroyableByOthers=!1}}e.OccultistEnemy=m,m.tileX=55,m.tileY=8},4478:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.WoodenShield=void 0;const s=i(7851),o=i(8549),a=i(6291),r=i(2270);class n extends o.Equippable{constructor(t,e,i){super(t,e,i),this.RECHARGE_TURNS=25,this.coEquippable=t=>!(t instanceof r.Armor||t instanceof n),this.getDescription=()=>"WOODEN SHIELD\nA wooden shield. Absorbs one hit and breaks after 1 hit",this.tickInInventory=()=>{this.rechargeTurnCounter>0&&(this.rechargeTurnCounter--,this.cooldown=this.rechargeTurnCounter,0===this.rechargeTurnCounter&&(this.rechargeTurnCounter=-1,this.cooldown=this.rechargeTurnCounter,this.health=1))},this.hurt=t=>{this.health<=0||(this.health-=Math.max(t,1),this.wielder?.inventory.removeItem(this),this.wielder?.game.pushMessage("Your wooden shield breaks."))},this.drawGUI=(t,e,i)=>{const o=(i-7)/a.GameConstants.TILESIZE,r=Math.max(o,-.2)+e/1.5+.5;let n=a.GameConstants.WIDTH>175?0:-1.25;-1===this.rechargeTurnCounter?s.Game.drawFX(5,2,.75,.75,r,a.GameConstants.HEIGHT/a.GameConstants.TILESIZE-1+n,.75,.75):1-this.rechargeTurnCounter/this.RECHARGE_TURNS<.5?s.Game.drawFX(7,2,.75,.75,r,a.GameConstants.HEIGHT/a.GameConstants.TILESIZE-1+n,.75,.75):s.Game.drawFX(8,2,.75,.75,r,a.GameConstants.HEIGHT/a.GameConstants.TILESIZE-1+n,.75,.75)},this.health=1,this.rechargeTurnCounter=-1,this.tileX=3,this.tileY=2,this.name=n.itemName}}e.WoodenShield=n,n.itemName="wooden shield"},4493:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.DownladderMaker=void 0;const s=i(606),o=i(3436),a=i(3067),r=i(1073),n=i(9467);class h extends s.Entity{constructor(t,e,i,s){super(t,e,i,s),this.createDownladder=()=>{let t=this.room.depth<1?r.EnvType.FOREST:r.EnvType.CAVE;this.room.depth>1&&(t=n.Random.rand()<.5?r.EnvType.FOREST:r.EnvType.CAVE);let e=new o.DownLadder(this.room,this.game,this.x,this.y,!0,t,a.LockType.NONE);e.lockable.isLocked()&&(console.log("adding key to downladder"),this.game.levels[this.room.depth].distributeKey(e)),this.room.roomArray[this.x][this.y]=e},this.draw=t=>{},this.drawTopLayer=t=>{},this.room=t,this.name="DownladderMaker",this.dead=!0}}e.DownladderMaker=h},4520:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Window=void 0;const s=i(7851),o=i(2103),a=i(9200);class r extends a.Wall{constructor(t,e,i,a){super(t,e,i),this.isSolid=()=>!0,this.canCrushEnemy=()=>!0,this.isOpaque=()=>{const t=this.room.wallInfo.get(`${this.x},${this.y}`);return!t||!t.isTopWall&&!t.isInnerWall||t.isLeftWall||t.isRightWall},this.draw=t=>{this.drawWall(t);const e=this.room.wallInfo.get(`${this.x},${this.y}`);e||(this.tileYOffset=6),this.frame+=.3*t,this.frame>=12&&(this.frame=0),this.tileYOffset="bottomInner"===e?.innerWallType||"surroundedInner"===e?.innerWallType?0:6,this.isBottomWall||s.Game.drawTile(0,this.skin,1,1,this.x,this.y,1,1,this.room.shadeColor,this.shadeAmount()),this.isBottomWall&&s.Game.drawTile(0,this.skin,1,1,this.x,this.y-.6,1,1,this.room.shadeColor,1)},this.isBottomWall=a,this.lightSource=new o.LightSource(this.x+.5,this.y+.5,20,[135,206,235],3),this.room.lightSources.push(this.lightSource),this.hasBloom=!0,this.bloomColor="#00FFFF",this.bloomAlpha=1,this.softBloomAlpha=0}}e.Window=r},4544:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.EntitySpawner=void 0;const s=i(5180),o=i(606),a=i(2502),r=i(3005);class n extends s.Usable{constructor(t,e,i){super(t,e,i),this.onUse=t=>{},this.spawnEntity=t=>{o.Entity.add(this.room,this.player.game,this.player.x,this.player.y)},this.commandHandler=t=>{this.room.game.players[0],(t=t.toLowerCase()).startsWith("/new")&&"bishop"===t.split(" ")[1]&&this.spawnEntity(new r.BishopEnemy(this.room,this.player.game,this.player.x,this.player.y))},this.getDescription=()=>"YOU SHOULD NOT HAVE THIS",this.room=t,this.count=0,this.tileX=31,this.tileY=0,this.setupEventListeners(),this.player=this.room.game.players[0],this.stackable=!1}setupEventListeners(){a.globalEventBus.on("ChatMessage",this.commandHandler.bind(this))}}e.EntitySpawner=n},4624:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.BishopStatue=void 0;const s=i(606),o=i(7851),a=i(606),r=i(4083),n=i(1236),h=i(9467);class l extends s.Entity{constructor(t,e,i,s){super(t,e,i,s),this.draw=t=>{this.dead||(o.Game.ctx.save(),o.Game.ctx.globalAlpha=this.alpha,this.dead||(this.hasShadow&&this.drawShadow(t),this.updateDrawXY(t),o.Game.drawObj(this.tileX,this.tileY,1,2,this.x-this.drawX,this.y-this.drawYOffset-this.drawY,1,2,this.room.shadeColor,this.shadeAmount())),o.Game.ctx.restore())},this.drawTopLayer=t=>{this.drawableY=this.y},this.room=t,this.health=1,this.tileX=7,this.tileY=4,this.hasShadow=!0,this.pushable=!0,this.name="bishopStatue",this.imageParticleX=3,this.imageParticleY=25,h.Random.rand()<.1?this.drops.push(new r.WeaponFragments(this.room,this.x,this.y)):this.drops.push(new n.Coin(this.room,this.x,this.y))}get type(){return a.EntityType.PROP}}e.BishopStatue=l},4752:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.CrossbowLimb=void 0;const s=i(5180),o=i(5692),a=i(2124);class r extends s.Usable{constructor(t,e,i){super(t,e,i),this.onDrop=()=>{"limb"===this.level.game.lastDroppedCrossbowPiece?(this.level.game.lastDroppedCrossbowPiece=null,this.level.items.push(new o.CrossbowStock(this.level,this.x,this.y)),this.level.items=this.level.items.filter(t=>t!==this)):null===this.level.game.lastDroppedCrossbowPiece&&(this.level.game.lastDroppedCrossbowPiece="limb")},this.useOnOther=(t,e)=>{if(e instanceof o.CrossbowStock){t.inventory.removeItem(this),t.inventory.removeItem(e),t.game.pushMessage("You combine the crossbow limb and stock.");const i=t?.getRoom?t.getRoom():t.game.rooms[t.levelID],s=new a.Crossbow(i,t.x,t.y);t.inventory.addItem(s)}},this.tileX=27,this.tileY=4,this.stackable=!1,this.name=r.itemName,this.description="The limb of a crossbow. Find the stock to use it.",this.canUseOnOther=!0}}e.CrossbowLimb=r,r.itemName="crossbow limb"},4804:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Door=e.DoorType=e.DoorDir=void 0;const s=i(7851),o=i(6291),a=i(5947),r=i(5926),n=i(7366),h=i(2103),l=i(8287),c=i(8583);var d,m;(m=e.DoorDir||(e.DoorDir={})).North="North",m.East="East",m.South="South",m.West="West",function(t){t[t.DOOR=0]="DOOR",t[t.LOCKEDDOOR=1]="LOCKEDDOOR",t[t.GUARDEDDOOR=2]="GUARDEDDOOR",t[t.TUNNELDOOR=3]="TUNNELDOOR"}(d=e.DoorType||(e.DoorType={}));class u extends c.Passageway{constructor(t,e,i,c,m,u){super(t,e,i,c),this.shadeAmount=(t=0,e=0,i=!0)=>{if(o.GameConstants.SMOOTH_LIGHTING&&i)return 0;const s=this.room.softVis[this.x+t][this.y+e];return this.opened?s/2:s},this.openTunnelXOffset=()=>this.type===d.TUNNELDOOR&&this.opened?-3:0,this.guard=()=>{this.type=d.GUARDEDDOOR,this.locked=!0,this.iconTileX=9,this.iconXOffset=1/32},this.lock=()=>{this.type=d.LOCKEDDOOR,this.locked=!0,this.iconTileX=10,this.iconXOffset=1/32},this.removeLock=()=>{this.type!==d.TUNNELDOOR&&(this.type=d.DOOR),this.locked=!1},this.removeLockIcon=()=>{this.iconYOffset=0,this.unlocking=!1,this.iconTileX=2,this.iconXOffset=0,this.iconAlpha=1},this.canUnlock=t=>{if(this.type===d.LOCKEDDOOR){let e=t.inventory.hasItem(r.Key);return null!==e?e.doorID===this.lockable.keyID?(this.game.pushMessage("You use the key to unlock the door."),!0):(this.game.pushMessage("The key doesn't fit the lock."),!1):(this.game.pushMessage("The door is locked tightly and won't budge."),!1)}return this.type===d.GUARDEDDOOR?(this.room.checkForNoEnemies(),this.game.pushMessage("There are still remaining foes guarding this door..."),!1):!!(this.type!==d.TUNNELDOOR||this.opened&&this.linkedDoor.opened)||(this.linkedDoor===this.room.level.exitRoom.tunnelDoor||this.startRoom?(this.game.pushMessage("The door refuses to budge from this side."),!1):(this.game.pushMessage("You clear the debris, revealing a narrow tunnel."),!0))},this.unlock=t=>{if(this.type===d.LOCKEDDOOR){let e=t.inventory.hasItem(r.Key);null!==e&&(t.inventory.removeItem(e),n.Sound.unlock(),this.removeLock(),this.unlocking=!0)}else this.type===d.TUNNELDOOR&&(this.locked=!1,this.unlocking=!0)},this.unGuard=(t=!0)=>{this.type===d.GUARDEDDOOR&&(this.removeLock(),n.Sound.unlock(),this.game.tutorialActive=!1),setTimeout(()=>{this.removeLockIcon()},t?1e3:100)},this.link=t=>{this.linkedDoor=t},this.isDrawnFirst=()=>{if(!this.linkedDoor||!this.linkedDoor.room)return!1;try{const t=this.game.currentPathId,e=this.game.rooms.filter(e=>e.pathId===t).slice().sort((t,e)=>t.roomY+t.height-(e.roomY+e.height)),i=e.indexOf(this.room),s=e.indexOf(this.linkedDoor.room);return-1!==i&&-1!==s&&i<s}catch{return!1}},this.isSolid=()=>{if(this.locked)return!0},this.canCrushEnemy=()=>!0,this.onCollide=t=>{this.opened||(n.Sound.doorOpen(),this.doorDir===s.Direction.LEFT&&(this.enteredFrom=s.Direction.LEFT,this.linkedDoor.enteredFrom=s.Direction.LEFT),this.doorDir===s.Direction.RIGHT&&(this.enteredFrom=s.Direction.RIGHT,this.linkedDoor.enteredFrom=s.Direction.RIGHT)),this.opened=!0,this.linkedDoor.opened=!0;const e=this.getAnchorAngle();t.anchorOxygenLineToTile(this.room,this.x,this.y,{kind:"door",angle:e}),t.recordOxygenDoorTraversal(this,this.linkedDoor),t.getOxygenLine()?.update(!0),this.doorDir===s.Direction.UP||this.doorDir===s.Direction.DOWN?this.game.changeLevelThroughDoor(t,this.linkedDoor):this.game.changeLevelThroughDoor(t,this.linkedDoor,this.linkedDoor.room.roomX-this.room.roomX>0?1:-1),this.type!==d.TUNNELDOOR||this.startRoom||this.game.pushMessage("The tunnel leads you back to the start."),this.linkedDoor.removeLock(),this.linkedDoor.removeLockIcon(),this.removeLockIcon()},this.draw=t=>{if(s.Game.ctx.save(),this.doorDir===s.Direction.DOWN&&s.Game.drawTile(1,this.skin,1,1,this.x,this.y,1,1,this.room.shadeColor,this.shadeAmount()),this.doorDir===s.Direction.UP&&(this.opened?s.Game.drawTile(6+this.tileXOffset+this.openTunnelXOffset(),this.skin,1,1,this.x,this.y,1,1,this.room.shadeColor,this.shadeAmount(0,1)):s.Game.drawTile(3+this.tileXOffset+this.openTunnelXOffset(),this.skin,1,1,this.x,this.y,1,1,this.room.shadeColor,this.shadeAmount())),this.doorDir===s.Direction.UP||!this.isDrawnFirst()&&this.opened||s.Game.drawTile(1,this.skin,1,1,this.x,this.y,1,1,this.room.shadeColor,this.shadeAmount()),this.doorDir===s.Direction.UP){if(!this.drawTopOf)return;this.opened?s.Game.drawTile(14,0,1,1,this.x,this.y-1,1,1,this.room.shadeColor,this.shadeAmount(0,1,!1)):s.Game.drawTile(13,0,1,1,this.x,this.y-1,1,1,this.room.shadeColor,this.shadeAmount(0,1,!1))}s.Game.ctx.restore()},this.drawAbovePlayer=t=>{},this.drawAboveShading=t=>{this.updateFrame(t),s.Game.ctx.globalAlpha=this.iconAlpha;let e=.125;!0===this.unlocking&&(this.iconAlpha*=.92**t,this.iconYOffset-=.035*t,e=0,this.iconAlpha<=.01&&this.removeLockIcon()),this.doorDir===s.Direction.UP||this.doorDir!==s.Direction.LEFT&&this.doorDir!==s.Direction.RIGHT||(this.iconYOffset=-.5),s.Game.drawFX(this.iconTileX,2,1,1,this.x+this.iconXOffset,this.y-1.25+e*Math.sin(this.frame*Math.PI/50)+this.iconYOffset,1,1),s.Game.ctx.globalAlpha=1},this.globalId=a.IdGenerator.generate("D"),this.opened=!1,this.doorDir=m,this.locked=!1,this.isDoor=!0,this.type=u,this.iconTileX=2,this.iconXOffset=0,this.iconYOffset=0,this.unlocking=!1,this.iconAlpha=1,this.tileXOffset=0,this.tileX=2,this.drawTopOf=!0;let p=0,y=0;switch(this.alpha=1,this.enteredFrom=null,this.doorDir){case s.Direction.UP:y=-.5;case s.Direction.DOWN:y=.5;case s.Direction.LEFT:p=-.5;case s.Direction.RIGHT:p=.5}switch(this.lightSource=new h.LightSource(i+.5,c+.5,0,[0,0,0],9),this.room.lightSources.push(this.lightSource),this.type){case d.GUARDEDDOOR:if(l.GameplaySettings.NO_ENEMIES)break;this.guard();break;case d.LOCKEDDOOR:this.lock();break;case d.DOOR:this.removeLock();break;case d.TUNNELDOOR:this.locked=!0,this.iconTileX=10,this.iconXOffset=1/32,this.tileXOffset=12,this.drawTopOf=!1}}getAnchorAngle(){switch(this.doorDir){case s.Direction.UP:return-Math.PI/2;case s.Direction.DOWN:return Math.PI/2;case s.Direction.LEFT:return Math.PI;case s.Direction.RIGHT:default:return 0}}}e.Door=u},4854:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Crate=void 0;const s=i(606),o=i(7851),a=i(606);class r extends s.Entity{constructor(t,e,i,s){super(t,e,i,s),this.draw=t=>{this.dead||(o.Game.ctx.save(),o.Game.ctx.globalAlpha=this.alpha,this.dead||(this.hasShadow&&this.drawShadow(t),this.updateDrawXY(t),o.Game.drawObj(this.tileX,this.tileY,1,2,this.x-this.drawX,this.y-this.drawYOffset-this.drawY,1,2,this.room.shadeColor,this.shadeAmount())),o.Game.ctx.restore())},this.drawTopLayer=t=>{this.drawableY=this.y},this.room=t,this.health=1,this.maxHealth=1,this.tileX=0,this.tileY=0,this.hasShadow=!0,this.pushable=!0,this.name="crate",this.imageParticleX=3,this.imageParticleY=26}get type(){return a.EntityType.PROP}}e.Crate=r},4918:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Heart=void 0;const s=i(7366),o=i(5180);class a extends o.Usable{constructor(t,e,i){super(t,e,i),this.onUse=t=>{t.health<t.maxHealth&&(t.health=Math.min(t.maxHealth,t.health+1),this.level.game.rooms[t.levelID]===this.level.game.room&&s.Sound.heal(),this.stackCount>1?this.stackCount--:t.inventory.removeItem(this),t.game.pushMessage("You drink the health potion."))},this.tileX=8,this.tileY=0,this.offsetY=-.3,this.name=a.itemName,this.stackable=!0,this.description="restores 1 health"}}e.Heart=a,a.itemName="health potion"},4937:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.FishingRod=void 0;const s=i(5366),o=i(4083),a=i(9467);class r extends s.Item{constructor(t,e,i){super(t,e,i),this.disassemble=()=>{this.level.game.pushMessage(`You dissassemble your ${this.name} into fragments.`);let t=this.level.game.players[this.level.game.localPlayerID].inventory,e=this.x,i=this.y,s=Math.floor(10+10*a.Random.rand());this.level.game.pushMessage(`You dissassemble your fishing rod into ${s} fragments.`),t.removeItem(this),t.addItem(new o.WeaponFragments(this.level,e,i),s)},this.tileX=31,this.tileY=2,this.offsetY=-.1,this.description="useful for catching fish",this.name=r.itemName}}e.FishingRod=r,r.itemName="fishing rod"},5016:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.BigFrogEnemy=void 0;const s=i(7851),o=i(369),a=i(7455),r=i(1236),n=i(6986),h=i(6199),l=i(3436),c=i(6291);class d extends n.Enemy{constructor(t,e,i,n,d){super(t,e,i,n),this.hit=()=>this.damage,this.poison=()=>{},this.behavior=()=>{if(this.lastX=this.x,this.lastY=this.y,!this.cloned&&(this.tileX=37,this.frameLength=3,this.animationSpeed=.1,!this.dead)){if(this.handleSkipTurns())return;if(this.seenPlayer){if(this.seenPlayer){if(this.tileX=37,this.room.playerTicked===this.targetPlayer)if(this.alertTicks=Math.max(0,this.alertTicks-1),this.ticks++,this.ticks%2==1){this.rumbling=!0;let t=this.x,e=this.y,i=Array();for(const t of this.room.entities)if(t!==this&&!t.destroyable)for(let e=0;e<(t.w||1);e++)for(let s=0;s<(t.h||1);s++)i.push({x:t.x+e,y:t.y+s});for(let t=this.x-1;t<=this.x+this.w;t++)for(let e=this.y-1;e<=this.y+this.h;e++)this.room.roomArray[t]&&this.room.roomArray[t][e]&&this.room.roomArray[t][e]instanceof a.SpikeTrap&&this.room.roomArray[t][e].on&&i.push({x:t,y:e});let o={x:this.targetPlayer.x,y:this.targetPlayer.y};const r=this.targetPlayer.x,n=this.targetPlayer.y,h=n>=this.y&&n<this.y+this.h,c=r>=this.x&&r<this.x+this.w,d=h&&r===this.x+this.w,m=h&&r===this.x-1,u=c&&n===this.y+this.h,p=c&&n===this.y-1;let y=!1,g=!1;const f=(t,e,i,s)=>{for(let o=0;o<i;o++)for(let a=0;a<s;a++){const r=t+o,n=e+a;if(!this.room.roomArray[r]||!this.room.roomArray[r][n])return!1;const h=this.room.roomArray[r][n];if(h.isSolid()||h.isDoor||h instanceof l.DownLadder)return!1;for(const o of this.room.entities)if(o!==this&&!o.destroyable&&!(o.x>=t+i||o.x+(o.w||1)<=t||o.y>=e+s||o.y+(o.h||1)<=e))return!1}return!0};if(d){y=!0;const i=r+1,o=this.y;if(f(i,o,this.w,this.h))return this.tryMove(i,o),this.setDrawXY(t,e),this.jumping&&(this.frame=8,this.animationSpeed=1),this.x>t?this.direction=s.Direction.RIGHT:this.x<t?this.direction=s.Direction.LEFT:this.y>e?this.direction=s.Direction.DOWN:this.y<e&&(this.direction=s.Direction.UP),this.rumbling=!1,void(g=!0)}else if(m){y=!0;const i=r-this.w,o=this.y;if(f(i,o,this.w,this.h))return this.tryMove(i,o),this.setDrawXY(t,e),this.jumping&&(this.frame=8,this.animationSpeed=1),this.x>t?this.direction=s.Direction.RIGHT:this.x<t?this.direction=s.Direction.LEFT:this.y>e?this.direction=s.Direction.DOWN:this.y<e&&(this.direction=s.Direction.UP),this.rumbling=!1,void(g=!0)}else if(u){y=!0;const i=this.x,o=n+1;if(f(i,o,this.w,this.h))return this.tryMove(i,o),this.setDrawXY(t,e),this.jumping&&(this.frame=8,this.animationSpeed=1),this.x>t?this.direction=s.Direction.RIGHT:this.x<t?this.direction=s.Direction.LEFT:this.y>e?this.direction=s.Direction.DOWN:this.y<e&&(this.direction=s.Direction.UP),this.rumbling=!1,void(g=!0)}else if(p){y=!0;const i=this.x,o=n-this.h;if(f(i,o,this.w,this.h))return this.tryMove(i,o),this.setDrawXY(t,e),this.jumping&&(this.frame=8,this.animationSpeed=1),this.x>t?this.direction=s.Direction.RIGHT:this.x<t?this.direction=s.Direction.LEFT:this.y>e?this.direction=s.Direction.DOWN:this.y<e&&(this.direction=s.Direction.UP),this.rumbling=!1,void(g=!0)}if(y&&!g)return void(this.rumbling=!1);const w=this.searchPathLocalized(o,i,{useLastPlayerPos:!0,allowOmni:!1});if(console.log(w),w[1]){const i=(t,e,i)=>t.x>=e&&t.x<e+this.w&&t.y>=i&&t.y<i+this.h;let o=!1;for(const t in this.game.players)if(this.game.rooms[this.game.players[t].levelID]===this.room&&i(this.game.players[t],w[1].pos.x,w[1].pos.y)){const e=this.closestTile(this.game.players[t]);this.game.players[t].hurt(this.hit(),this.name),this.drawX+=1.5*(e.x-this.game.players[t].x),this.drawY+=1.5*(e.y-this.game.players[t].y),this.game.players[t]===this.game.players[this.game.localPlayerID]&&this.game.shakeScreen(5*this.drawX,5*this.drawY),o=!0}if(!o&&w.length>1){let i=w[1].pos.x,o=w[1].pos.y;this.tryMove(i,o),this.setDrawXY(t,e),this.jumping&&(this.frame=8,this.animationSpeed=1),this.x>i?this.direction=s.Direction.RIGHT:this.x<i?this.direction=s.Direction.LEFT:this.y>o?this.direction=s.Direction.DOWN:this.y<o&&(this.direction=s.Direction.UP)}}this.rumbling=!1}else this.makeBigHitWarnings(),this.rumbling=!0,this.tileX=43,this.frame=0,this.frameLength=2,this.animationSpeed=.2;let t=-1!==Object.values(this.game.offlinePlayers).indexOf(this.targetPlayer);if(!this.aggro||t){let e=this.nearestPlayer();if(!1!==e){let[i,s]=e;i<=4&&(t||i<this.playerDistance(this.targetPlayer))&&s!==this.targetPlayer&&(this.targetPlayer=s,this.facePlayer(s),s===this.game.players[this.game.localPlayerID]&&(this.alertTicks=1),this.ticks%2==0&&this.makeBigHitWarnings())}}}}else this.tileX=37,this.lookForPlayer()}},this.jump=t=>{if(this.jumping&&!this.cloned){let t=Math.max(Math.abs(this.drawX),Math.abs(this.drawY));t>=1&&(this.jumpDistance=2),this.jumpY=Math.sin(t/(this.jumpDistance+1)*Math.PI)*this.jumpHeight,this.jumpY<.01&&this.jumpY>-.01&&(this.jumpY=0,this.jumpDistance=1),this.jumpY>this.jumpHeight&&(this.jumpY=this.jumpHeight)}},this.bigEnemyShake=()=>{(this.w>1||this.h>1)&&setTimeout(()=>{this.game.shakeScreen(0*this.drawX,5)},500)},this.makeHitWarnings=()=>{const t=this.getPlayer(),e=this.orthogonalAttack,i=this.diagonalAttack,a=this.forwardOnlyAttack,r=this.direction,n=this.attackRange,l=this.diagonalAttackRange,c=(t,e)=>(t?[[-2,0],[2,0],[0,-2],[0,2]]:[[-1,-1],[1,1],[1,-1],[-1,1]]).flatMap(([t,i])=>Array.from({length:e},(e,s)=>[(s+1)*t,(s+1)*i])),d={[s.Direction.LEFT]:[-1,0],[s.Direction.RIGHT]:[1,0],[s.Direction.UP]:[0,-1],[s.Direction.DOWN]:[0,1]};let m=[];if(a){const[t,e]=d[r];m=Array.from({length:n},(i,s)=>[(s+1)*t,(s+1)*e])}else e&&m.push(...c(!0,n)),i&&m.push(...c(!1,l));const u=m.map(([e,i])=>({x:e,y:i,distance:h.Utils.distance(e,i,t.x-this.x,t.y-this.y)})).sort((t,e)=>t.distance-e.distance),p=Math.ceil(.75*u.length);u.slice(0,p).forEach(({x:t,y:e})=>{const i=[{x:this.x,y:this.y},{x:this.x+1,y:this.y},{x:this.x,y:this.y+1},{x:this.x+1,y:this.y+1}];for(const s of i){const i=s.x+t,a=s.y+e;if(this.isWithinRoomBounds(i,a)){const t=new o.HitWarning(this.game,i,a,s.x,s.y,!0,!1,this),e=t.getPointerDir(),r=s.x-this.x,n=s.y-this.y;let h=[];h=1===r&&1===n?[o.HitWarningDirection.South,o.HitWarningDirection.East,o.HitWarningDirection.SouthEast]:1===r&&0===n?[o.HitWarningDirection.North,o.HitWarningDirection.East,o.HitWarningDirection.NorthEast]:0===r&&1===n?[o.HitWarningDirection.South,o.HitWarningDirection.West,o.HitWarningDirection.SouthWest]:[o.HitWarningDirection.North,o.HitWarningDirection.West,o.HitWarningDirection.NorthWest],h.includes(e)&&this.room.hitwarnings.push(t)}}})},this.drawTopLayer=t=>{this.drawableY=this.y,this.healthBar.draw(t,this.health,this.maxHealth,this.x+.5,this.y,!0)},this.draw=t=>{if(!this.dead){if(s.Game.ctx.save(),s.Game.ctx.globalAlpha=this.alpha,!this.dead){this.updateDrawXY(t),this.frame+=this.animationSpeed*t,this.frame>=this.frameLength&&(this.frame=0);let e=this.rumble(this.rumbling,this.frame).x;this.rumble(this.rumbling,this.frame).y,0!==this.drawX||0!==this.drawY?this.jumping=!0:this.jumping=!1,this.jumping?(this.frame<4&&(this.frame=4),this.frameLength=11,this.animationSpeed=.2):(this.frameLength=3,this.animationSpeed=.1),this.hasShadow&&this.drawShadow(t),s.Game.drawMob(this.tileX+2*(59===this.tileX||this.rumbling||this.cloned?0:Math.floor(this.frame)),this.tileY,2,3,this.x+e-this.drawX,this.y-this.drawYOffset-this.drawY-this.jumpY,2,3,this.softShadeColor,this.shadeAmount(),void 0,this.outlineColor(),this.outlineOpacity())}this.cloned||(this.seenPlayer||this.drawSleepingZs(t,.5*c.GameConstants.TILESIZE),this.alertTicks>0&&this.drawExclamation(t,.5*c.GameConstants.TILESIZE)),s.Game.ctx.restore()}},this.ticks=0,this.frame=0,this.health=4,this.maxHealth=4,this.defaultMaxHealth=4,this.tileX=37,this.tileY=24,this.seenPlayer=!1,this.aggro=!1,this.deathParticleColor="#ffffff",this.frameLength=3,this.startFrame=0,this.animationSpeed=.1,this.tickCount=0,this.jumping=!1,this.jumpDistance=1,this.drop=d||new r.Coin(this.room,this.x,this.y),this.name="bigfrog",this.orthogonalAttack=!0,this.diagonalAttack=!0,this.jumpHeight=2,this.imageParticleX=3,this.imageParticleY=30,this.canDestroyOthers=!0,this.halfJumped=!1,this.canCrushOthers=!0,this.dropChance=1,this.h=2,this.w=2,this.getDrop(["frog"],!0)}}e.BigFrogEnemy=d,d.difficulty=1,d.tileX=37,d.tileY=24},5064:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.WeaponPoison=void 0;const s=i(7366),o=i(5180),a=i(4052);class r extends o.Usable{constructor(t,e,i){super(t,e,i),this.onUse=t=>{t.health=Math.min(t.maxHealth,t.health+1),this.level.game.rooms[t.levelID]===this.level.game.room&&s.Sound.heal()},this.useOnOther=(t,e)=>{e instanceof a.Weapon&&(e.applyStatus({poison:!0,blood:!1}),t.inventory.removeItem(this),this.level.game.pushMessage(`You apply the poison to your ${e.name}.`),console.log(`weapon poison used on ${e.name}`))},this.getDescription=()=>"WEAPON POISON\nCan be applied to weapons to deal poison damage",this.tileX=11,this.tileY=4,this.offsetY=-.3,this.canUseOnOther=!0,this.name=r.itemName,this.description="Can be applied to weapons to deal poison damage"}}e.WeaponPoison=r,r.itemName="weapon poison"},5087:(t,e,i)=>{"use strict";t.exports=i.p+"assets/tileset.ed82dd24ab8797956df3.png"},5095:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.TileState=e.TileType=e.loadGameState=e.createGameState=e.GameState=e.LevelState=e.PlayerState=e.InventoryState=e.ItemState=e.ItemType=e.RoomState=e.EnemyState=e.EnemyType=e.ProjectileState=e.ProjectileType=e.HitWarningState=void 0;const s=i(3201),o=i(675),a=i(9982),r=i(1987),n=i(4854),h=i(5146),l=i(5838),c=i(5097),d=i(8004),m=i(7142),u=i(7975),p=i(8200),y=i(126),g=i(1103),f=i(263),w=i(3180),E=i(369),x=i(2270),b=i(521),T=i(8149),I=i(1199),S=i(1236),v=i(8549),A=i(2176),M=i(3565),C=i(5614),D=i(4918),O=i(5926),_=i(66),R=i(1470),G=i(5196),P=i(8737),L=i(4254),k=i(8330),N=i(1367),Y=i(9467),B=i(6094),H=i(2268),X=i(7512),F=i(8243),W=i(4052),U=i(9915),j=i(783),V=i(4804),z=i(8654),q=i(4021),$=i(7356),Z=i(5339),K=i(9362),Q=i(2502),J=i(6277),tt=i(3175),et=i(492),it=i(9357),st=i(8480),ot=i(3005),at=i(4159),rt=i(7716),nt=i(8323),ht=i(1429),lt=i(4438),ct=i(6598),dt=i(6493),mt=i(9997),ut=i(9938),pt=i(1645),yt=i(4182),gt=i(4544),ft=i(2694),wt=i(4937),Et=i(9432),xt=i(7834),bt=i(7418),Tt=i(3345),It=i(7510),St=i(2321),vt=i(3379),At=i(9066),Mt=i(529),Ct=i(846),Dt=i(995),Ot=i(4208),_t=i(2351),Rt=i(920),Gt=i(5734),Pt=i(2772),Lt=i(4223),kt=i(3427),Nt=i(3785),Yt=i(3346),Bt=i(9991),Ht=i(6635),Xt=i(9058),Ft=i(9406),Wt=i(5064),Ut=i(4083),jt=i(6535),Vt=i(5711),zt=i(2571),qt=i(249),$t=i(7976),Zt=i(1626),Kt=i(5367),Qt=i(5741),Jt=i(9259),te=i(9245),ee=i(3263),ie=i(7064),se=i(2125),oe=i(267),ae=i(9852),re=i(3164),ne=i(1932),he=i(4624),le=i(4493),ce=i(8017),de=i(1444),me=i(1073),ue=i(6986),pe=i(32),ye=i(9830),ge=i(8821),fe=i(6751),we=i(3709),Ee=i(3691),xe=i(3384),be=i(9200),Te=i(6084),Ie=i(4804),Se=i(3436),ve=i(2057),Ae=i(734),Me=i(6761),Ce=i(2248),De=i(6083),Oe=i(7455),_e=i(1144),Re=i(3139),Ge=i(9100),Pe=i(788),Le=i(9116),ke=i(8965),Ne=i(9201),Ye=i(4520),Be=i(5947),He=i(9713),Xe=i(4396),Fe=i(6525),We=i(2440),Ue=i(6644),je=i(2279),Ve=i(2147),ze=i(1040),qe=i(5016),$e=i(8363),Ze=i(5109),Ke=i(5816),Qe=i(9513);class Je{constructor(t){this.x=t.x,this.y=t.y,this.dead=t.dead}}e.HitWarningState=Je;let ti=(t,e)=>{let i=new E.HitWarning(e,t.x,t.y,t.x,t.y);return i.dead=t.dead,i};var ei;!function(t){t[t.SPAWN=0]="SPAWN",t[t.WIZARD=1]="WIZARD"}(ei=e.ProjectileType||(e.ProjectileType={}));class ii{constructor(t,e){this.x=t.x,this.y=t.y,this.dead=t.dead,t instanceof k.EnemySpawnAnimation&&(this.type=ei.SPAWN,this.roomID=e.rooms.indexOf(t.room),this.roomGID=t.room?.globalId,this.enemySpawn=new ai(t.enemy,e)),t instanceof N.WizardFireball&&(this.type=ei.WIZARD,this.wizardState=t.state,this.roomID=e.rooms.indexOf(t.parent.room),this.roomGID=t.parent.room?.globalId,this.wizardParentID=t.parent.room.entities.indexOf(t.parent),this.wizardParentGID=t.parent.globalId,this.state=t.state)}}e.ProjectileState=ii;let si=(t,e)=>{if(t.type===ei.SPAWN){let i=t.roomGID&&e.roomsById?.get(t.roomGID)||e.rooms[t.roomID],s=ri(t.enemySpawn,e),o=new k.EnemySpawnAnimation(i,s,t.x,t.y);return o.dead=t.dead,o}if(t.type===ei.WIZARD){const i=t.roomGID&&e.roomsById?.get(t.roomGID)||e.rooms[t.roomID];let s;if(t.wizardParentGID){const e=i.entities.find(e=>e.globalId===t.wizardParentGID);e&&e instanceof f.WizardEnemy&&(s=e)}if(!s){const e=i.entities[t.wizardParentID];e&&e instanceof f.WizardEnemy&&(s=e)}if(!s)return;const o=new N.WizardFireball(s,t.x,t.y);return o.state=t.wizardState,o}};var oi;!function(t){t[t.BARREL=0]="BARREL",t[t.BIGSKULL=1]="BIGSKULL",t[t.CHARGE=2]="CHARGE",t[t.CHEST=3]="CHEST",t[t.COAL=4]="COAL",t[t.CRATE=5]="CRATE",t[t.EMERALD=6]="EMERALD",t[t.GOLD=7]="GOLD",t[t.IRON=8]="IRON",t[t.KNIGHT=9]="KNIGHT",t[t.PLANT=10]="PLANT",t[t.POT=11]="POT",t[t.SKULL=12]="SKULL",t[t.CRAB=13]="CRAB",t[t.SPAWNER=14]="SPAWNER",t[t.VENDINGMACHINE=15]="VENDINGMACHINE",t[t.WIZARD=16]="WIZARD",t[t.ZOMBIE=17]="ZOMBIE",t[t.ARMOREDSKULL=18]="ARMOREDSKULL",t[t.ARMOREDZOMBIE=19]="ARMOREDZOMBIE",t[t.BIGKNIGHT=20]="BIGKNIGHT",t[t.BIGZOMBIE=21]="BIGZOMBIE",t[t.BISHOP=22]="BISHOP",t[t.ENERGYWIZARD=23]="ENERGYWIZARD",t[t.FIREWIZARD=24]="FIREWIZARD",t[t.FROG=25]="FROG",t[t.GLOWBUG=26]="GLOWBUG",t[t.MUMMY=27]="MUMMY",t[t.OCCULTIST=28]="OCCULTIST",t[t.QUEEN=29]="QUEEN",t[t.ROOK=30]="ROOK",t[t.SPIDER=31]="SPIDER",t[t.BUSH=32]="BUSH",t[t.FISHING_SPOT=33]="FISHING_SPOT",t[t.FURNACE=34]="FURNACE",t[t.PUMPKIN=35]="PUMPKIN",t[t.SPROUT=36]="SPROUT",t[t.TOMBSTONE=37]="TOMBSTONE",t[t.DECO_BLOCK=38]="DECO_BLOCK",t[t.TREE=39]="TREE",t[t.CHEST_LAYER=40]="CHEST_LAYER",t[t.BOMB=41]="BOMB",t[t.BLOCK=42]="BLOCK",t[t.DOWNLADDER_MAKER=43]="DOWNLADDER_MAKER",t[t.ROCK=44]="ROCK",t[t.MUSHROOMS=45]="MUSHROOMS",t[t.WARDEN=46]="WARDEN",t[t.OBSIDIAN=47]="OBSIDIAN",t[t.CRUSHER=48]="CRUSHER",t[t.PAWN=49]="PAWN",t[t.BIGFROG=50]="BIGFROG",t[t.BEETLE=51]="BEETLE",t[t.EXALTER=52]="EXALTER",t[t.KING=53]="KING",t[t.GARNET=54]="GARNET",t[t.ZIRCON=55]="ZIRCON",t[t.AMBER=56]="AMBER",t[t.BIG_BLOCK=57]="BIG_BLOCK",t[t.SMALL_BUSH=58]="SMALL_BUSH",t[t.SUCCULENT=59]="SUCCULENT",t[t.FALLEN_PILLAR=60]="FALLEN_PILLAR",t[t.CANDELABRA=61]="CANDELABRA",t[t.PAWN_STATUE=62]="PAWN_STATUE",t[t.ROOK_STATUE=63]="ROOK_STATUE",t[t.BISHOP_STATUE=64]="BISHOP_STATUE"}(oi=e.EnemyType||(e.EnemyType={}));class ai{constructor(t,e){this.roomID=e.rooms.indexOf(t.room),this.roomGID=t.room?.globalId,this.x=t.x,this.y=t.y,this.health=t.health,this.maxHealth=t.maxHealth,this.rumbling=t.rumbling,this.isEnemy=t.isEnemy;try{this.isShielded=!0===t.shielded,this.shieldHealth=t.shield?.health??void 0}catch{}try{this.buffed=!0===t.buffed}catch{}try{this.buffedBefore=!0===t.buffedBefore}catch{}if(this.shieldedBefore=t.shieldedBefore,this.unconscious=t.unconscious,this.direction=t.direction,this.dead=t.dead,this.skipNextTurns=t.skipNextTurns,this.destroyable=t.destroyable,this.hasDrop=!1,t.drop&&(this.hasDrop=!0,this.drop=new ci(t.drop,e)),this.alertTicks=t.alertTicks,t instanceof ue.Enemy&&(this.ticks=t.ticks,this.seenPlayer=t.seenPlayer,t.seenPlayer&&(this.targetPlayerID=Object.keys(e.players).find(i=>e.players[i]===t.targetPlayer),this.targetPlayerID||(this.targetPlayerID=Object.keys(e.offlinePlayers).find(i=>e.offlinePlayers[i]===t.targetPlayer)))),t instanceof s.Barrel&&(this.type=oi.BARREL),t instanceof o.BigSkullEnemy){this.type=oi.BIGSKULL,this.ticksSinceFirstHit=t.ticksSinceFirstHit,this.drops=[];for(const i of t.drops)i&&this.drops.push(new ci(i,e))}if(t instanceof a.ChargeEnemy&&(this.type=oi.CHARGE,this.chargeEnemyState=t.state,this.startX=t.startX,this.startY=t.startY,this.targetX=t.targetX,this.targetY=t.targetY,this.visualTargetX=t.visualTargetX,this.visualTargetY=t.visualTargetY),t instanceof pe.Chest&&(this.type=oi.CHEST),t instanceof pe.Chest&&(this.chestOpened=t.health<=2),t instanceof r.CoalResource&&(this.type=oi.COAL),t instanceof n.Crate&&(this.type=oi.CRATE),t instanceof h.EmeraldResource&&(this.type=oi.EMERALD),t instanceof l.GoldResource&&(this.type=oi.GOLD),t instanceof ye.IronResource&&(this.type=oi.IRON),t instanceof c.KnightEnemy&&(this.type=oi.KNIGHT),t instanceof d.PottedPlant&&(this.type=oi.PLANT),t instanceof m.Pot&&(this.type=oi.POT),t instanceof u.SkullEnemy&&(this.type=oi.SKULL,this.ticksSinceFirstHit=t.ticksSinceFirstHit),t instanceof p.CrabEnemy&&(this.type=oi.CRAB),t instanceof y.Spawner&&(this.type=oi.SPAWNER,this.enemySpawnType=t.enemySpawnType),t instanceof g.VendingMachine){this.type=oi.VENDINGMACHINE,this.isPlayerOpened=!1,t.playerOpened&&(this.isPlayerOpened=!0,this.playerOpenedID=Object.keys(e.players).find(i=>e.players[i]===t.playerOpened),this.playerOpenedID||(this.playerOpenedID=Object.keys(e.offlinePlayers).find(i=>e.offlinePlayers[i]===t.playerOpened))),this.open=t.open,this.costItems=[];for(const i of t.costItems)i&&this.costItems.push(new ci(i,e));t.item&&(this.item=new ci(t.item,e)),this.isInf=t.isInf,this.quantity=t.quantity}t instanceof f.WizardEnemy&&(this.type=oi.WIZARD,this.wizardState=t.state),t instanceof w.ZombieEnemy&&(this.type=oi.ZOMBIE),t instanceof tt.ArmoredSkullEnemy&&(this.type=oi.ARMOREDSKULL),t instanceof et.ArmoredzombieEnemy&&(this.type=oi.ARMOREDZOMBIE),t instanceof it.BigKnightEnemy&&(this.type=oi.BIGKNIGHT),t instanceof st.BigZombieEnemy&&(this.type=oi.BIGZOMBIE),t instanceof ot.BishopEnemy&&(this.type=oi.BISHOP),t instanceof Z.EnergyWizardEnemy&&(this.type=oi.ENERGYWIZARD),t instanceof at.FireWizardEnemy&&(this.type=oi.FIREWIZARD),t instanceof rt.FrogEnemy&&(this.type=oi.FROG),t instanceof nt.GlowBugEnemy&&(this.type=oi.GLOWBUG),t instanceof ht.MummyEnemy&&(this.type=oi.MUMMY),t instanceof lt.OccultistEnemy&&(this.type=oi.OCCULTIST),t instanceof ct.QueenEnemy&&(this.type=oi.QUEEN),t instanceof dt.RookEnemy&&(this.type=oi.ROOK),t instanceof mt.SpiderEnemy&&(this.type=oi.SPIDER),t instanceof Vt.Bush&&(this.type=oi.BUSH),t instanceof zt.FishingSpot&&(this.type=oi.FISHING_SPOT),t instanceof qt.Furnace&&(this.type=oi.FURNACE),t instanceof q.Pumpkin&&(this.type=oi.PUMPKIN),t instanceof $t.Sprout&&(this.type=oi.SPROUT),t instanceof Zt.TombStone&&(this.type=oi.TOMBSTONE),t instanceof Kt.DecoBlock&&(this.type=oi.DECO_BLOCK),t instanceof Qt.Tree&&(this.type=oi.TREE),t instanceof Jt.ChestLayer&&(this.type=oi.CHEST_LAYER),t instanceof te.Bomb&&(this.type=oi.BOMB),t instanceof $.Block&&(this.type=oi.BLOCK),t instanceof le.DownladderMaker&&(this.type=oi.DOWNLADDER_MAKER),t instanceof ce.Rock&&(this.type=oi.ROCK),t instanceof z.Mushrooms&&(this.type=oi.MUSHROOMS),t instanceof He.WardenEnemy&&(this.type=oi.WARDEN),t instanceof Fe.ObsidianResource&&(this.type=oi.OBSIDIAN),t instanceof We.CrusherEnemy&&(this.type=oi.CRUSHER),t instanceof ze.PawnEnemy&&(this.type=oi.PAWN),t instanceof $e.BeetleEnemy&&(this.type=oi.BEETLE),t instanceof qe.BigFrogEnemy&&(this.type=oi.BIGFROG),t instanceof Ze.ExalterEnemy&&(this.type=oi.EXALTER),t instanceof Ee.KingEnemy&&(this.type=oi.KING),t instanceof ge.GarnetResource&&(this.type=oi.GARNET),t instanceof fe.ZirconResource&&(this.type=oi.ZIRCON),t instanceof we.AmberResource&&(this.type=oi.AMBER),t instanceof ee.ObsidianBlock&&(this.type=oi.BIG_BLOCK),t instanceof ie.SmallBush&&(this.type=oi.SMALL_BUSH),t instanceof se.Succulent&&(this.type=oi.SUCCULENT),t instanceof oe.FallenPillar&&(this.type=oi.FALLEN_PILLAR),t instanceof ae.Candelabra&&(this.type=oi.CANDELABRA),t instanceof re.PawnStatue&&(this.type=oi.PAWN_STATUE),t instanceof ne.RookStatue&&(this.type=oi.ROOK_STATUE),t instanceof he.BishopStatue&&(this.type=oi.BISHOP_STATUE)}}e.EnemyState=ai;let ri=(t,e)=>{let i,E=t.roomGID&&e.roomsById?.get(t.roomGID)||e.rooms[t.roomID];if(t.type===oi.BARREL&&(i=new s.Barrel(E,e,t.x,t.y)),t.type===oi.BIGSKULL){i=new o.BigSkullEnemy(E,e,t.x,t.y),i.ticksSinceFirstHit=t.ticksSinceFirstHit,i.drops=[];for(const s of t.drops)s&&i.drops.push(di(s,e))}if(t.type===oi.CHARGE&&(i=new a.ChargeEnemy(E,e,t.x,t.y),i.state=t.chargeEnemyState,i.startX=t.startX,i.startY=t.startY,i.targetX=t.targetX,i.targetY=t.targetY,i.visualTargetX=t.visualTargetX,i.visualTargetY=t.visualTargetY),t.type===oi.CHEST&&(i=new pe.Chest(E,e,t.x,t.y)),i instanceof pe.Chest&&t.health<=2&&(i.tileX=6,i.tileY=2,i.opening=!1),t.type===oi.COAL&&(i=new r.CoalResource(E,e,t.x,t.y)),t.type===oi.CRATE&&(i=new n.Crate(E,e,t.x,t.y)),t.type===oi.EMERALD&&(i=new h.EmeraldResource(E,e,t.x,t.y)),t.type===oi.GOLD&&(i=new l.GoldResource(E,e,t.x,t.y)),t.type===oi.IRON&&(i=new ye.IronResource(E,e,t.x,t.y)),t.type===oi.KNIGHT&&(i=new c.KnightEnemy(E,e,t.x,t.y)),t.type===oi.PLANT&&(i=new d.PottedPlant(E,e,t.x,t.y)),t.type===oi.POT&&(i=new m.Pot(E,e,t.x,t.y)),t.type===oi.SKULL&&(i=new u.SkullEnemy(E,e,t.x,t.y),i.ticksSinceFirstHit=t.ticksSinceFirstHit),t.type===oi.CRAB&&(i=new p.CrabEnemy(E,e,t.x,t.y)),t.type===oi.SPAWNER&&(i=new y.Spawner(E,e,t.x,t.y,[t.enemySpawnType]),i.enemySpawnType=t.enemySpawnType),t.type===oi.VENDINGMACHINE){let s=di(t.item,e);i=new g.VendingMachine(E,e,t.x,t.y,s),t.isPlayerOpened&&(i.playerOpened=e.players[t.playerOpenedID],i.playerOpened||(i.playerOpened=e.offlinePlayers[t.playerOpenedID])),i.open=t.open,i.costItems=[];for(const s of t.costItems)s&&i.costItems.push(di(s,e));i.isInf=t.isInf,i.quantity=t.quantity}t.type===oi.ZOMBIE&&(i=new w.ZombieEnemy(E,e,t.x,t.y)),t.type===oi.ARMOREDSKULL&&(i=new tt.ArmoredSkullEnemy(E,e,t.x,t.y)),t.type===oi.ARMOREDZOMBIE&&(i=new et.ArmoredzombieEnemy(E,e,t.x,t.y)),t.type===oi.BIGKNIGHT&&(i=new it.BigKnightEnemy(E,e,t.x,t.y)),t.type===oi.BIGZOMBIE&&(i=new st.BigZombieEnemy(E,e,t.x,t.y)),t.type===oi.BISHOP&&(i=new ot.BishopEnemy(E,e,t.x,t.y)),t.type===oi.ENERGYWIZARD&&(i=new Z.EnergyWizardEnemy(E,e,t.x,t.y)),t.type===oi.FIREWIZARD&&(i=new at.FireWizardEnemy(E,e,t.x,t.y)),t.type===oi.FROG&&(i=new rt.FrogEnemy(E,e,t.x,t.y)),t.type===oi.GLOWBUG&&(i=new nt.GlowBugEnemy(E,e,t.x,t.y)),t.type===oi.MUMMY&&(i=new ht.MummyEnemy(E,e,t.x,t.y)),t.type===oi.OCCULTIST&&(i=new lt.OccultistEnemy(E,e,t.x,t.y)),t.type===oi.WARDEN&&(i=new He.WardenEnemy(E,e,t.x,t.y)),t.type===oi.CRUSHER&&(i=new We.CrusherEnemy(E,e,t.x,t.y)),t.type===oi.QUEEN&&(i=new ct.QueenEnemy(E,e,t.x,t.y)),t.type===oi.ROOK&&(i=new dt.RookEnemy(E,e,t.x,t.y)),t.type===oi.SPIDER&&(i=new mt.SpiderEnemy(E,e,t.x,t.y)),t.type===oi.BUSH&&(i=new Vt.Bush(E,e,t.x,t.y)),t.type===oi.FISHING_SPOT&&(i=new zt.FishingSpot(E,e,t.x,t.y)),t.type===oi.FURNACE&&(i=new qt.Furnace(E,e,t.x,t.y)),t.type===oi.PUMPKIN&&(i=new q.Pumpkin(E,e,t.x,t.y)),t.type===oi.SPROUT&&(i=new $t.Sprout(E,e,t.x,t.y)),t.type===oi.TOMBSTONE&&(i=new Zt.TombStone(E,e,t.x,t.y)),t.type===oi.DECO_BLOCK&&(i=new Kt.DecoBlock(E,e,t.x,t.y)),t.type===oi.TREE&&(i=new Qt.Tree(E,e,t.x,t.y)),t.type===oi.CHEST_LAYER&&(i=new Jt.ChestLayer(E,e,t.x,t.y)),t.type===oi.BOMB&&(i=new te.Bomb(E,e,t.x,t.y)),t.type===oi.BLOCK&&(i=new $.Block(E,e,t.x,t.y)),t.type===oi.DOWNLADDER_MAKER&&(i=new le.DownladderMaker(E,e,t.x,t.y)),t.type===oi.ROCK&&(i=new ce.Rock(E,e,t.x,t.y)),t.type===oi.MUSHROOMS&&(i=new z.Mushrooms(E,e,t.x,t.y)),t.type===oi.OBSIDIAN&&(i=new Fe.ObsidianResource(E,e,t.x,t.y)),t.type===oi.PAWN&&(i=new ze.PawnEnemy(E,e,t.x,t.y)),t.type===oi.BIGFROG&&(i=new qe.BigFrogEnemy(E,e,t.x,t.y)),t.type===oi.BEETLE&&(i=new $e.BeetleEnemy(E,e,t.x,t.y)),t.type===oi.EXALTER&&(i=new Ze.ExalterEnemy(E,e,t.x,t.y)),t.type===oi.KING&&(i=new Ee.KingEnemy(E,e,t.x,t.y)),t.type===oi.GARNET&&(i=new ge.GarnetResource(E,e,t.x,t.y)),t.type===oi.ZIRCON&&(i=new fe.ZirconResource(E,e,t.x,t.y)),t.type===oi.AMBER&&(i=new we.AmberResource(E,e,t.x,t.y)),t.type===oi.BIG_BLOCK&&(i=new ee.ObsidianBlock(E,e,t.x,t.y)),t.type===oi.SMALL_BUSH&&(i=new ie.SmallBush(E,e,t.x,t.y)),t.type===oi.SUCCULENT&&(i=new se.Succulent(E,e,t.x,t.y)),t.type===oi.FALLEN_PILLAR&&(i=new oe.FallenPillar(E,e,t.x,t.y)),t.type===oi.CANDELABRA&&(i=new ae.Candelabra(E,e,t.x,t.y)),t.type===oi.PAWN_STATUE&&(i=new re.PawnStatue(E,e,t.x,t.y)),t.type===oi.ROOK_STATUE&&(i=new ne.RookStatue(E,e,t.x,t.y)),t.type===oi.BISHOP_STATUE&&(i=new he.BishopStatue(E,e,t.x,t.y)),t.isEnemy&&(i.ticks=t.ticks,i.seenPlayer=t.seenPlayer,t.seenPlayer&&(i.targetPlayer=e.players[t.targetPlayerID],i.targetPlayer||(i.targetPlayer=e.offlinePlayers[t.targetPlayerID]))),i||(console.error("Unknown enemy type:",t.type,"EnemyType enum value:",oi[t.type],"Falling back to barrel"),i=new s.Barrel(E,e,t.x,t.y)),i.x=t.x,i.y=t.y,i.health=t.health,i.maxHealth=t.maxHealth,i.shieldedBefore=t.shieldedBefore,i.buffed=t.buffed,i.buffedBefore=t.buffedBefore;try{t.isBuffed&&i.applyBuff()}catch{}try{if(t.isShielded){const e=t.shieldHealth??1;i.shielded||i.applyShield(e,!0)}}catch{}i.unconscious=t.unconscious,i.direction=t.direction,i.dead=t.dead,i.skipNextTurns=t.skipNextTurns,i.rumbling=t.rumbling,"boolean"==typeof t.destroyable&&(i.destroyable=t.destroyable),t.hasDrop&&(i.drop=di(t.drop,e)),i.alertTicks=t.alertTicks;try{i instanceof f.WizardEnemy&&(i.ticks=t.ticks??0,i.state=t.wizardState??i.state,i.seenPlayer=t.seenPlayer??!1)}catch{}return i};class ni{constructor(t,e){this.roomID=e.rooms.indexOf(t),this.roomGID=t.globalId,this.pathId=t.pathId||"main",this.entered=t.entered,this.envType=t.envType,this.skin=t.skin,this.active=t.active,this.onScreen=t.onScreen,this.mapGroup=t.mapGroup,this.enemies=[],this.items=[],this.projectiles=[],this.hitwarnings=[],this.tiles=[];for(let i=t.roomX-1;i<t.roomX+t.width+1;i++){this.tiles[i]=[];for(let s=t.roomY-1;s<t.roomY+t.height+1;s++){const o=t.roomArray[i]?.[s];o&&this.shouldSaveTile(o)?this.tiles[i][s]=new wi(o,e):this.tiles[i][s]=null}}for(const i of t.entities)this.enemies.push(new ai(i,e));for(const i of t.items)i&&this.items.push(new ci(i,e));for(const i of t.projectiles)i instanceof Xe.EnemyShield||this.projectiles.push(new ii(i,e));for(const e of t.hitwarnings)this.hitwarnings.push(new Je(e))}shouldSaveTile(t){return t instanceof Ce.Chasm||t instanceof Ae.Pool||t instanceof Me.MagmaPool||t instanceof be.Wall||t instanceof Ye.Window||t instanceof Se.DownLadder||t instanceof ve.UpLadder||t instanceof xe.Floor||t instanceof Te.WallTorch||t instanceof De.SpawnFloor||t instanceof Ie.Door||t instanceof Ge.InsideLevelDoor||t instanceof Le.Button||t instanceof Pe.FountainTile||t instanceof ke.CoffinTile||t instanceof Oe.SpikeTrap}}e.RoomState=ni;let hi=(t,e,i)=>{if(e.pathId&&(t.pathId=e.pathId),t.entered=e.entered,void 0!==e.envType&&(t.envType=e.envType,t.skin=t.envType),t.active=e.active,t.onScreen=e.onScreen,t.skin=e.skin,e.tiles){try{t.lightSources=[]}catch{}for(let s=t.roomX-1;s<t.roomX+t.width+1;s++)for(let o=t.roomY-1;o<t.roomY+t.height+1;o++){const a=e.tiles[s]?.[o];if(a){const e=Ei(a,t,i);t.roomArray[s][o]=e}}try{const i=new Map,s=new Map;for(let o=t.roomX-1;o<t.roomX+t.width+1;o++)for(let a=t.roomY-1;a<t.roomY+t.height+1;a++){const r=e.tiles[o]?.[a],n=t.roomArray[o]?.[a];if(r&&r.type===fi.DOOR&&n instanceof Ie.Door){const t=r.properties.globalId;t&&i.set(t,n)}if(r&&r.type===fi.INSIDE_LEVEL_DOOR&&n instanceof Ge.InsideLevelDoor){const t=r.properties.globalId;t&&s.set(t,n)}n&&n.lightSource&&!t.lightSources?.includes(n.lightSource)&&t.lightSources.push(n.lightSource)}for(let o=t.roomX-1;o<t.roomX+t.width+1;o++)for(let a=t.roomY-1;a<t.roomY+t.height+1;a++){const r=e.tiles[o]?.[a],n=t.roomArray[o]?.[a];if(r&&r.type===fi.DOOR&&n instanceof Ie.Door){const t=r.properties.linkedDoorGID;t&&i.has(t)&&n.link(i.get(t))}if(r&&r.type===fi.BUTTON&&n instanceof Le.Button){const t=r.properties.linkedDoorGID;t&&s.has(t)&&(n.linkedDoor=s.get(t))}}}catch{}try{const e=[];for(let i=t.roomX-1;i<t.roomX+t.width+1;i++)for(let s=t.roomY-1;s<t.roomY+t.height+1;s++){const o=t.roomArray[i]?.[s];o instanceof Ie.Door&&e.push(o)}t.doors=e}catch{}}t.entities=[],t.items=[],t.projectiles=[],t.hitwarnings=[];const s=e.enemies.filter(t=>t.type!==oi.OCCULTIST),o=e.enemies.filter(t=>t.type===oi.OCCULTIST);for(const e of s)t.entities.push(ri(e,i));for(const e of o)t.entities.push(ri(e,i));for(const s of e.items)s&&t.items.push(di(s,i,void 0,t));try{const e=new Map;for(const i of t.items){const t=i?.sourceChestX,s=i?.sourceChestY;if(void 0!==t&&void 0!==s){const o=`${t},${s}`,a=e.get(o)||[];a.push(i),e.set(o,a)}}for(const i of t.entities)if(i instanceof pe.Chest&&i.health<=2){const s=`${i.x},${i.y}`,o=e.get(s);if(o&&o.length){i.drops=o.slice();continue}i.drops=t.items.filter(t=>t&&t.x===i.x&&t.y===i.y)}}catch{}for(const s of e.projectiles){const e=si(s,i);e&&!e.dead&&t.projectiles.push(e)}for(const s of e.hitwarnings)t.hitwarnings.push(ti(s,i));try{const e=t.entities.filter(t=>t instanceof Ze.ExalterEnemy);for(const t of e)for(const e of t.buffedEnemies)e instanceof ue.Enemy&&!e.dead&&!e.buffed&&!e.buffedBefore&&t.applyBuffTo(e)}catch{}try{const e=t.entities.filter(t=>t instanceof lt.OccultistEnemy),i=t.entities.filter(t=>t instanceof ue.Enemy&&t.shielded&&!t.dead);for(const t of e)t.shieldedEnemies=[];const s=new Map;for(const t of i){let i=null,o=Number.POSITIVE_INFINITY;for(const s of e){if(s===t)continue;const e=Math.max(Math.abs(s.x-t.x),Math.abs(s.y-t.y));e<o&&(o=e,i=s)}if(i){const e=s.get(i)||[];e.push(t),s.set(i,e)}}for(const[t,e]of s.entries())t.shieldedEnemies=e.slice(),t.createBeam&&e.length&&t.createBeam(e)}catch{}try{const e=t.entities.filter(t=>t instanceof Ze.ExalterEnemy);if(e.length){const i=t.entities.filter(t=>t instanceof ue.Enemy&&t.buffed&&!t.dead);for(const t of e)t.buffedEnemies=[];for(const t of i){let i=null,s=Number.POSITIVE_INFINITY;for(const o of e){const e=Math.max(Math.abs(o.x-t.x),Math.abs(o.y-t.y));e<s&&(s=e,i=o)}i&&i.applyBuffTo(t)}}}catch{}t.calculateWallInfo(),t.updateLighting()};var li;!function(t){t[t.ARMOR=0]="ARMOR",t[t.BLUEGEM=1]="BLUEGEM",t[t.CANDLE=2]="CANDLE",t[t.COAL=3]="COAL",t[t.COIN=4]="COIN",t[t.GOLD=5]="GOLD",t[t.GOLDENKEY=6]="GOLDENKEY",t[t.GREENGEM=7]="GREENGEM",t[t.KEY=8]="KEY",t[t.LANTERN=9]="LANTERN",t[t.REDGEM=10]="REDGEM",t[t.TORCH=11]="TORCH",t[t.DAGGER=12]="DAGGER",t[t.DUALDAGGER=13]="DUALDAGGER",t[t.SHOTGUN=14]="SHOTGUN",t[t.SPEAR=15]="SPEAR",t[t.PICKAXE=16]="PICKAXE",t[t.BACKPACK=17]="BACKPACK",t[t.SPELLBOOK=18]="SPELLBOOK",t[t.WEAPON_FRAGMENTS=19]="WEAPON_FRAGMENTS",t[t.WARHAMMER=20]="WARHAMMER",t[t.HAMMER=21]="HAMMER",t[t.WEAPON_POISON=22]="WEAPON_POISON",t[t.WEAPON_BLOOD=23]="WEAPON_BLOOD",t[t.HEART=24]="HEART",t[t.MUSHROOMS=25]="MUSHROOMS",t[t.STONE=26]="STONE",t[t.BLUE_POTION=27]="BLUE_POTION",t[t.APPLE=28]="APPLE",t[t.BESTIARY_BOOK=29]="BESTIARY_BOOK",t[t.BOMB_ITEM=30]="BOMB_ITEM",t[t.ENTITY_SPAWNER=31]="ENTITY_SPAWNER",t[t.FISH=32]="FISH",t[t.FISHING_ROD=33]="FISHING_ROD",t[t.GEODE=34]="GEODE",t[t.GLOW_BUGS=35]="GLOW_BUGS",t[t.GOD_STONE=36]="GOD_STONE",t[t.GOLD_BAR=37]="GOLD_BAR",t[t.GOLD_RING=38]="GOLD_RING",t[t.GARNET_RING=39]="GARNET_RING",t[t.ZIRCON_RING=40]="ZIRCON_RING",t[t.EMERALD_RING=41]="EMERALD_RING",t[t.AMBER_RING=42]="AMBER_RING",t[t.GREEN_POTION=43]="GREEN_POTION",t[t.GREATAXE=44]="GREATAXE",t[t.HOURGLASS=45]="HOURGLASS",t[t.ORANGE_GEM=46]="ORANGE_GEM",t[t.SCYTHE=47]="SCYTHE",t[t.SCYTHE_HANDLE=48]="SCYTHE_HANDLE",t[t.SCYTHE_BLADE=49]="SCYTHE_BLADE",t[t.SLINGSHOT=50]="SLINGSHOT",t[t.SPELLBOOK_PAGE=51]="SPELLBOOK_PAGE",t[t.SWORD=52]="SWORD",t[t.SHIELD_LEFT_FRAGMENT=53]="SHIELD_LEFT_FRAGMENT",t[t.SHIELD_RIGHT_FRAGMENT=54]="SHIELD_RIGHT_FRAGMENT",t[t.IRON_ORE=55]="IRON_ORE",t[t.IRON_BAR=56]="IRON_BAR"}(li=e.ItemType||(e.ItemType={}));class ci{constructor(t,e){if(!t)throw new Error("Cannot create ItemState from null item");t instanceof x.Armor&&(this.type=li.ARMOR),t instanceof b.BlueGem&&(this.type=li.BLUEGEM),t instanceof T.Candle&&(this.type=li.CANDLE),t instanceof I.Coal&&(this.type=li.COAL),t instanceof S.Coin&&(this.type=li.COIN),t instanceof A.GoldOre&&(this.type=li.GOLD),t instanceof M.GoldenKey&&(this.type=li.GOLDENKEY),t instanceof C.GreenGem&&(this.type=li.GREENGEM),t instanceof D.Heart&&(this.type=li.HEART),t instanceof O.Key&&(this.type=li.KEY),t instanceof _.Lantern&&(this.type=li.LANTERN),t instanceof R.RedGem&&(this.type=li.REDGEM),t instanceof G.Torch&&(this.type=li.TORCH),t instanceof B.Dagger&&(this.type=li.DAGGER),t instanceof H.DualDagger&&(this.type=li.DUALDAGGER),t instanceof X.Shotgun&&(this.type=li.SHOTGUN),t instanceof F.Spear&&(this.type=li.SPEAR),t instanceof U.Pickaxe&&(this.type=li.PICKAXE),t instanceof j.Backpack&&(this.type=li.BACKPACK),t instanceof ut.Apple&&(this.type=li.APPLE),t instanceof pt.BestiaryBook&&(this.type=li.BESTIARY_BOOK),t instanceof yt.BombItem&&(this.type=li.BOMB_ITEM),t instanceof gt.EntitySpawner&&(this.type=li.ENTITY_SPAWNER),t instanceof ft.Fish&&(this.type=li.FISH),t instanceof wt.FishingRod&&(this.type=li.FISHING_ROD),t instanceof Et.Geode&&(this.type=li.GEODE),t instanceof xt.GlowBugs&&(this.type=li.GLOW_BUGS),t instanceof bt.GodStone&&(this.type=li.GOD_STONE),t instanceof Tt.GoldBar&&(this.type=li.GOLD_BAR),t instanceof It.GoldRing&&(this.type=li.GOLD_RING),t instanceof St.GarnetRing&&(this.type=li.GARNET_RING),t instanceof vt.ZirconRing&&(this.type=li.ZIRCON_RING),t instanceof At.EmeraldRing&&(this.type=li.EMERALD_RING),t instanceof Mt.AmberRing&&(this.type=li.AMBER_RING),t instanceof Ct.GreenPotion&&(this.type=li.GREEN_POTION),t instanceof Dt.Greataxe&&(this.type=li.GREATAXE),t instanceof Ot.Hourglass&&(this.type=li.HOURGLASS),t instanceof _t.OrangeGem&&(this.type=li.ORANGE_GEM),t instanceof Rt.Scythe&&(this.type=li.SCYTHE),t instanceof Gt.ScytheHandle&&(this.type=li.SCYTHE_HANDLE),t instanceof Pt.ScytheBlade&&(this.type=li.SCYTHE_BLADE),t instanceof Lt.Shrooms&&(this.type=li.MUSHROOMS),t instanceof kt.Slingshot&&(this.type=li.SLINGSHOT),t instanceof Nt.Spellbook&&(this.type=li.SPELLBOOK),t instanceof Yt.SpellbookPage&&(this.type=li.SPELLBOOK_PAGE),t instanceof Bt.Stone&&(this.type=li.STONE),t instanceof Ht.Sword&&(this.type=li.SWORD),t instanceof Xt.Warhammer&&(this.type=li.WARHAMMER),t instanceof Ft.WeaponBlood&&(this.type=li.WEAPON_BLOOD),t instanceof Wt.WeaponPoison&&(this.type=li.WEAPON_POISON),t instanceof Ut.WeaponFragments&&(this.type=li.WEAPON_FRAGMENTS),t instanceof jt.BluePotion&&(this.type=li.BLUE_POTION),t instanceof de.Hammer&&(this.type=li.HAMMER),t instanceof Ue.ShieldLeftFragment&&(this.type=li.SHIELD_LEFT_FRAGMENT),t instanceof je.ShieldRightFragment&&(this.type=li.SHIELD_RIGHT_FRAGMENT),t instanceof Ke.IronOre&&(this.type=li.IRON_ORE),t instanceof Qe.IronBar&&(this.type=li.IRON_BAR),this.equipped=t instanceof v.Equippable&&t.equipped,this.x=t.x,this.y=t.y,this.roomID=e.rooms.indexOf(t.level),this.roomGID=t.level?.globalId,this.stackCount=t.stackCount,this.pickedUp=t.pickedUp;try{const e=t.level,i=e?.entities?.find(e=>e instanceof pe.Chest&&e.health<=2&&e.x===t.x&&e.y===t.y);i&&(this.sourceChestX=i.x,this.sourceChestY=i.y)}catch{}}}e.ItemState=ci;let di=(t,e,i,s)=>{let o,a=s||t.roomGID&&e.roomsById?.get(t.roomGID)||(-1!==t.roomID?e.rooms[t.roomID]:null);if(t.type===li.ARMOR&&(o=new x.Armor(a,t.x,t.y)),t.type===li.BLUEGEM&&(o=new b.BlueGem(a,t.x,t.y)),t.type===li.CANDLE&&(o=new T.Candle(a,t.x,t.y)),t.type===li.COAL&&(o=new I.Coal(a,t.x,t.y)),t.type===li.COIN&&(o=new S.Coin(a,t.x,t.y)),t.type===li.GOLD&&(o=new A.GoldOre(a,t.x,t.y)),t.type===li.GOLDENKEY&&(o=new M.GoldenKey(a,t.x,t.y)),t.type===li.GREENGEM&&(o=new C.GreenGem(a,t.x,t.y)),t.type===li.HEART&&(o=new D.Heart(a,t.x,t.y)),t.type===li.KEY&&(o=new O.Key(a,t.x,t.y)),t.type===li.LANTERN&&(o=new _.Lantern(a,t.x,t.y)),t.type===li.REDGEM&&(o=new R.RedGem(a,t.x,t.y)),t.type===li.TORCH&&(o=new G.Torch(a,t.x,t.y)),t.type===li.DAGGER&&(o=new B.Dagger(a,t.x,t.y)),t.type===li.DUALDAGGER&&(o=new H.DualDagger(a,t.x,t.y)),t.type===li.SHOTGUN&&(o=new X.Shotgun(a,t.x,t.y)),t.type===li.SPEAR&&(o=new F.Spear(a,t.x,t.y)),t.type===li.PICKAXE&&(o=new U.Pickaxe(a,t.x,t.y)),t.type===li.BACKPACK&&(o=new j.Backpack(a,t.x,t.y)),t.type===li.APPLE&&(o=new ut.Apple(a,t.x,t.y)),t.type===li.BESTIARY_BOOK&&(o=new pt.BestiaryBook(a,t.x,t.y)),t.type===li.BOMB_ITEM&&(o=new yt.BombItem(a,t.x,t.y)),t.type===li.ENTITY_SPAWNER&&(o=new gt.EntitySpawner(a,t.x,t.y)),t.type===li.FISH&&(o=new ft.Fish(a,t.x,t.y)),t.type===li.FISHING_ROD&&(o=new wt.FishingRod(a,t.x,t.y)),t.type===li.GEODE&&(o=new Et.Geode(a,t.x,t.y)),t.type===li.GLOW_BUGS&&(o=new xt.GlowBugs(a,t.x,t.y)),t.type===li.GOD_STONE&&(o=new bt.GodStone(a,t.x,t.y)),t.type===li.GOLD_BAR&&(o=new Tt.GoldBar(a,t.x,t.y)),t.type===li.GOLD_RING&&(o=new It.GoldRing(a,t.x,t.y)),t.type===li.GARNET_RING&&(o=new St.GarnetRing(a,t.x,t.y)),t.type===li.ZIRCON_RING&&(o=new vt.ZirconRing(a,t.x,t.y)),t.type===li.EMERALD_RING&&(o=new At.EmeraldRing(a,t.x,t.y)),t.type===li.AMBER_RING&&(o=new Mt.AmberRing(a,t.x,t.y)),t.type===li.GREEN_POTION&&(o=new Ct.GreenPotion(a,t.x,t.y)),t.type===li.GREATAXE&&(o=new Dt.Greataxe(a,t.x,t.y)),t.type===li.HOURGLASS&&(o=new Ot.Hourglass(a,t.x,t.y)),t.type===li.ORANGE_GEM&&(o=new _t.OrangeGem(a,t.x,t.y)),t.type===li.SCYTHE&&(o=new Rt.Scythe(a,t.x,t.y)),t.type===li.SCYTHE_HANDLE&&(o=new Gt.ScytheHandle(a,t.x,t.y)),t.type===li.SCYTHE_BLADE&&(o=new Pt.ScytheBlade(a,t.x,t.y)),t.type===li.MUSHROOMS&&(o=new Lt.Shrooms(a,t.x,t.y)),t.type===li.SLINGSHOT&&(o=new kt.Slingshot(a,t.x,t.y)),t.type===li.SPELLBOOK&&(o=new Nt.Spellbook(a,t.x,t.y)),t.type===li.SPELLBOOK_PAGE&&(o=new Yt.SpellbookPage(a,t.x,t.y)),t.type===li.STONE&&(o=new Bt.Stone(a,t.x,t.y)),t.type===li.SWORD&&(o=new Ht.Sword(a,t.x,t.y)),t.type===li.BLUE_POTION&&(o=new jt.BluePotion(a,t.x,t.y)),t.type===li.WEAPON_FRAGMENTS&&(o=new Ut.WeaponFragments(a,t.x,t.y)),t.type===li.WARHAMMER&&(o=new Xt.Warhammer(a,t.x,t.y)),t.type===li.HAMMER&&(o=new de.Hammer(a,t.x,t.y)),t.type===li.WEAPON_POISON&&(o=new Wt.WeaponPoison(a,t.x,t.y)),t.type===li.WEAPON_BLOOD&&(o=new Ft.WeaponBlood(a,t.x,t.y)),t.type===li.HAMMER&&(o=new de.Hammer(a,t.x,t.y)),t.type===li.SHIELD_LEFT_FRAGMENT&&(o=new Ue.ShieldLeftFragment(a,t.x,t.y)),t.type===li.SHIELD_RIGHT_FRAGMENT&&(o=new je.ShieldRightFragment(a,t.x,t.y)),t.type===li.IRON_ORE&&(o=new Ke.IronOre(a,t.x,t.y)),t.type===li.IRON_BAR&&(o=new Qe.IronBar(a,t.x,t.y)),o||(console.error("Unknown item type:",t.type,"ItemType enum value:",li[t.type],"Falling back to coal"),o=new I.Coal(a,t.x,t.y)),o&&!o.game&&(o.game=e),!a&&o&&!o.level){const t=e.players?.[e.localPlayerID],i=t?.getRoom?t.getRoom():e.rooms[e.players[e.localPlayerID].levelID];o.level=i}return t.equipped&&(o.equipped=!0),o instanceof v.Equippable&&o.setWielder(i),o&&!o.game&&(o.game=e),o.stackCount=t.stackCount,o.pickedUp=t.pickedUp,o};class mi{constructor(t,e){this.isOpen=t.isOpen,this.cols=t.cols,this.rows=t.rows,this.equipAnimAmount=t.equipAnimAmount.map(t=>t),this.isWeaponEquipped=!1,t.weapon&&(this.isWeaponEquipped=!0,this.weaponI=t.items.indexOf(t.weapon)),this.coins=t.coins,this.selX=t.selX,this.selY=t.selY,this.items=Array(t.cols*t.rows),this.expansion=t.expansion;for(let e=0;e<t.cols*t.rows;e++)this.items[e]=null;for(const i of t.items)i&&(this.items[t.items.indexOf(i)]=new ci(i,e))}}e.InventoryState=mi;class ui{constructor(t,e){this.x=t.x,this.y=t.y,this.dead=t.dead;const i=t?.getRoom?t.getRoom():e.rooms[t.levelID];this.roomGID=i?.globalId,this.roomID=i?e.rooms.indexOf(i):t.levelID,this.mapGroup=i?.mapGroup;const s=i;if(s){const t=e.rooms.filter(t=>t.mapGroup===s.mapGroup).sort((t,e)=>t.id-e.id);this.roomIndexInGroup=t.findIndex(t=>t===s)}this.direction=t.direction,this.health=t.health,this.maxHealth=t.maxHealth,this.lastTickHealth=t.lastTickHealth,this.inventory=new mi(t.inventory,e),this.hasOpenVendingMachine=!1,t.openVendingMachine&&(this.hasOpenVendingMachine=!0,this.openVendingMachineRoomID=e.rooms.indexOf(t.openVendingMachine.room),this.openVendingMachineRoomGID=t.openVendingMachine.room?.globalId,this.openVendingMachineID=t.openVendingMachine.room.entities.indexOf(t.openVendingMachine),this.openVendingMachineGID=t.openVendingMachine.globalId),this.sightRadius=t.sightRadius,this.lightEquipped=t.lightEquipped,this.lightColor=t.lightColor,this.lightBrightness=t.lightBrightness}}e.PlayerState=ui;let pi=(t,e,i)=>{let s=new L.Player(i,e.x,e.y,t===i.localPlayerID);if(s.dead=e.dead,e.roomGID&&i.roomsById?.has(e.roomGID)){const t=i.roomsById.get(e.roomGID);s.roomGID=e.roomGID,s.levelID=i.rooms.indexOf(t)}else{let t;if(void 0!==e.mapGroup){const s=i.rooms.filter(t=>t.mapGroup===e.mapGroup).sort((t,e)=>t.id-e.id);s.length&&(t=void 0!==e.roomIndexInGroup&&e.roomIndexInGroup<s.length?s[e.roomIndexInGroup]:s.find(t=>t.id===e.roomID)||s[0])}if(!t){const s=i.rooms.find(t=>t.tileInside(e.x,e.y));s&&(t=s)}t||(t=i.rooms[e.roomID]),s.roomGID=t?.globalId,s.levelID=t?i.rooms.indexOf(t):0}if(i.level&&(s.depth=i.level.depth),s.direction=e.direction,s.health=e.health,s.maxHealth=e.maxHealth,s.lastTickHealth=e.lastTickHealth,((t,e,i)=>{t.clear();for(let s=0;s<e.items.length;s++){const o=e.items[s];if(o){const e=di(o,i,t.player);if(!e.level){const s=i.rooms[t.player.levelID];e.level=s}e.game||(e.game=i),t.items[s]=e,e instanceof W.Weapon&&null===t.weapon&&(e.toggleEquip(),t.weapon=e)}else t.items[s]=null}t.isOpen=e.isOpen,t.cols=e.cols,t.rows=e.rows,t.selX=e.selX,t.selY=e.selY,t.equipAnimAmount=e.equipAnimAmount.map(t=>t),t.coins=e.coins,t.expansion=e.expansion,e.isWeaponEquipped&&e.weaponI<t.items.length&&(t.weapon=t.items[e.weaponI])})(s.inventory,e.inventory,i),e.hasOpenVendingMachine){const t=e.openVendingMachineRoomGID&&i.roomsById?.get(e.openVendingMachineRoomGID)||i.rooms[e.openVendingMachineRoomID];s.openVendingMachine=e.openVendingMachineGID?t.entities.find(t=>t.globalId===e.openVendingMachineGID):t.entities[e.openVendingMachineID]}return s.sightRadius=e.sightRadius,"boolean"==typeof e.lightEquipped&&(s.lightEquipped=e.lightEquipped),Array.isArray(e.lightColor)&&(s.lightColor=e.lightColor),"number"==typeof e.lightBrightness&&(s.lightBrightness=e.lightBrightness),s};class yi{constructor(t){this.depth=t.depth,this.width=t.width,this.height=t.height,this.isMainPath=t.isMainPath,this.mapGroup=t.mapGroup,this.envType=t.environment.type,this.levelGID=t.globalId}}e.LevelState=yi;class gi{constructor(){this.lastDroppedScythePiece=null,this.lastDroppedShieldPiece=null,this.seed=0,this.randomState=0,this.players={},this.offlinePlayers={},this.level=null,this.rooms=[]}}var fi;e.GameState=gi,e.createGameState=t=>{try{if(t.replayManager?.isReplaying?.())return console.warn(" SAVE: Skipped createGameState during replay"),null}catch{}try{let e=new gi;e.stats=Ve.statsTracker.getStats(),e.seed=t.levelgen.seed,e.randomState=Y.Random.state,e.lastDroppedScythePiece=t.lastDroppedScythePiece,e.lastDroppedShieldPiece=t.lastDroppedShieldPiece,t.level?(e.level=new yi(t.level),e.levelGID=t.level.globalId):console.warn(" SAVE: No game.level found!");for(const i in t.players)try{const s=t.players[i];t.rooms[s.levelID],e.players[i]=new ui(t.players[i],t)}catch(t){throw console.error(` SAVE: Error saving player ${i}:`,t),t}for(const i in t.offlinePlayers)try{e.offlinePlayers[i]=new ui(t.offlinePlayers[i],t)}catch(t){throw console.error(` SAVE: Error saving offline player ${i}:`,t),t}try{e.currentPathId=t.currentPathId||"main"}catch{}try{const e={};for(const i of t.rooms)e[i.mapGroup]=(e[i.mapGroup]||0)+1}catch{}for(let i=0;i<t.rooms.length;i++){const s=t.rooms[i];try{s.catchUp();const i=new ni(s,t);e.rooms.push(i),(e.roomGIDs||(e.roomGIDs=[])).push(s.globalId)}catch(t){throw console.error(` SAVE: Error saving room ${i}:`,t),t}}try{const t=new Map;for(const i of e.rooms){const e=i.pathId||"main";"main"!==e&&t.set(e,(t.get(e)||0)+1)}e.sidepathMeta=Array.from(t.entries()).map(([t,e])=>({pathId:t,rooms:e}))}catch{}return e}catch(t){throw console.error(" SAVE: Fatal error in createGameState:",t),t}},e.loadGameState=(t,e,s,o)=>{try{Ve.statsTracker&&s.stats&&Ve.statsTracker.setStats(s.stats),t.rooms=[],t.roomsById=new Map,t.levels=[],t.levelsById=new Map;try{const t=i(3628);t.Input.mouseDownListeners.length=0,t.Input.mouseRightClickListeners.length=0,t.Input.mouseLeftClickListeners.length=0,t.Input.mouseMoveListeners.length=0,t.Input.mouseUpListeners.length=0}catch{}if(t.levelgen=new P.LevelGenerator,t.levelgen.setSeed(s.seed),!s.level){console.warn(" LOAD: No level state found, creating default");const e=new K.Level(t,0,1,1,!0,0,me.EnvType.DUNGEON,!1,void 0);s.level=new yi(e)}return o?s.level.depth=0:Y.Random.setState(s.randomState),Q.globalEventBus.emit(J.EVENTS.LEVEL_GENERATION_STARTED,{}),t.levelgen.generateFirstNFloors(t,s.level.depth,!o).then(async()=>{try{t.levelgen.setSeed(s.seed),Y.Random.setState(s.randomState)}catch{}Q.globalEventBus.emit(J.EVENTS.LEVEL_GENERATION_COMPLETED,{});try{const e=s.rooms||[],i=new Map;for(const t of e){const e=t.pathId;if(!e||"main"===e)continue;const s=t.mapGroup;if("number"!=typeof s)continue;const o=i.get(e);(void 0===o||s<o)&&i.set(e,s)}const a=Array.from(i.entries()).map(([t,e])=>({pid:t,mg:e})).sort((t,e)=>t.mg-e.mg),r=[];for(const e of a){if(t.rooms.some(t=>t.pathId===e.pid))continue;t.rooms.length,await t.levelgen.generate(t,s.level.depth,!0,()=>{},s.level.envType,!o,e.pid,s.sidepathMeta?{caveRooms:s.sidepathMeta.find(t=>t.pathId===e.pid)?.rooms??void 0}:void 0),t.rooms.length;const i=t.rooms.filter(t=>t.pathId===e.pid);for(const t of i)r.push(t)}const n=t.levels[s.level.depth];if(n){const e=new Set(n.rooms.map(t=>t.globalId)),i=r.filter(t=>!e.has(t.globalId)).sort((t,e)=>{const i=t.pathId||"main",s=e.pathId||"main";return i!==s?i<s?-1:1:t.mapGroup!==e.mapGroup?t.mapGroup-e.mapGroup:t.id-e.id});let s=0,o=n.rooms.length;for(const t of i)t.id=o+s,n.rooms.push(t),s++;t.rooms=n.rooms,t.roomsById=new Map(t.rooms.map(t=>[t.globalId,t]));try{const e={},i={};for(const s of t.rooms){const t=s.pathId||"main";e[t]=(e[t]||0)+1,i[s.mapGroup]=(i[s.mapGroup]||0)+1}}catch{}}}catch(t){console.warn(" LOAD: Sidepath generation by pathId failed",t)}if(o)t.players[t.localPlayerID]=new L.Player(t,0,0,!0),t.room=t.rooms[t.players[t.localPlayerID].levelID],t.room.enterLevel(t.players[t.localPlayerID]),t.players[t.localPlayerID].map.updateSeenTiles(),t.players[t.localPlayerID].map.saveMapData();else{try{new Map;for(const e of s.rooms){if(!e?.roomGID)continue;let i=e.roomGID&&t.getRoomById(e.roomGID)||t.rooms.find(t=>t.mapGroup===e.mapGroup&&t.pathId===(e.pathId||"main")&&t.id===e.roomID)||t.rooms.find(t=>t.mapGroup===e.mapGroup&&t.id===e.roomID)||t.rooms.find(t=>t.id===e.roomID);if(i&&i.globalId!==e.roomGID)try{Be.IdGenerator.reserve(e.roomGID),i.globalId=e.roomGID}catch{}}t.roomsById=new Map(t.rooms.map(t=>[t.globalId,t]))}catch{}for(const e in s.players)try{const i=pi(e,s.players[e],t);t.players[e]=i}catch(t){throw console.error(` LOAD: Error loading player ${e}:`,t),t}for(const e in s.offlinePlayers)try{const i=pi(e,s.offlinePlayers[e],t);t.offlinePlayers[e]=i}catch(t){throw console.error(` LOAD: Error loading offline player ${e}:`,t),t}try{for(const e of s.rooms){let i,s="";const o=e.pathId||"main";if(e.roomGID){const o=t.getRoomById(e.roomGID);o&&(i=o,s="gid")}if(!i){const a=t.rooms.find(t=>t.mapGroup===e.mapGroup&&t.pathId===o&&t.id===e.roomID);a&&(i=a,s="group+path+id")}if(!i){const o=t.rooms.find(t=>t.mapGroup===e.mapGroup&&t.id===e.roomID);o&&(i=o,s="group+id")}if(!i){const o=t.rooms.find(t=>t.id===e.roomID);o&&(i=o,s="id")}const a=i;if(a){e.pathId&&(a.pathId=e.pathId);const i=t.room;try{t.room=a,hi(a,e,t)}finally{t.room=i}}}try{const e=new Map,i=[],s=new Map;for(const o of t.rooms)for(let t=o.roomX-1;t<o.roomX+o.width+1;t++)for(let a=o.roomY-1;a<o.roomY+o.height+1;a++){const r=o.roomArray[t]?.[a];if(r instanceof Ie.Door){const o=r.globalId;o&&e.set(o,r),r._pendingLinkedDoorGID&&i.push(r);const n=`${t},${a}`,h=s.get(n)||[];h.push(r),s.set(n,h)}}for(const t of i){const i=t._pendingLinkedDoorGID;i&&e.has(i)&&t.link(e.get(i)),t._pendingLinkedDoorGID=null}for(const[t,e]of s.entries())if(2===e.length){const[t,i]=e;t.linkedDoor||t.link(i),i.linkedDoor||i.link(t)}}catch(t){console.warn(" LOAD: Global door linking failed",t)}}catch(t){throw console.error(" LOAD: Error loading room states:",t),t}if(e.includes(t.localPlayerID)){const e=t.players[t.localPlayerID];if(e){if(!(t.rooms.length>0))throw console.error(" LOAD: Invalid levelID for local player:",e.levelID),new Error(`Invalid levelID ${e.levelID} for local player`);{const i=s.players[t.localPlayerID],o=i?.roomGID?t.getRoomById(i.roomGID):void 0;let a;if(void 0!==i?.mapGroup){const e=t.rooms.filter(t=>t.mapGroup===i.mapGroup).sort((t,e)=>t.id-e.id);e.length&&(void 0!==i?.roomIndexInGroup&&i.roomIndexInGroup<e.length?a=e[i.roomIndexInGroup]:void 0!==i?.roomID&&(a=e.find(t=>t.id===i.roomID)||e[0]))}const r=t.rooms.find(t=>t.tileInside(e.x,e.y)),n=e.levelID<t.rooms.length?t.rooms[e.levelID]:void 0,h=o||a||r||n||t.rooms[0];t.room=h,e.levelID=t.rooms.indexOf(h);try{t.currentPathId=s.currentPathId||h.pathId||"main"}catch{}if(t.updateLevel(t.room),t.currentDepth=t.level.depth,e.depth=t.level.depth,!h.tileInside(e.x,e.y)){const t=h.getRoomCenter();e.moveSnap(t.x,t.y)}t.room.enterLevel(e,{x:e.x,y:e.y}),e.map.updateSeenTiles();try{t.room.updateLighting()}catch{}const l=t.room.roomArray[e.x]?.[e.y];if(!l||l.isSolid()){console.warn(" LOAD: Player in invalid position, moving to room center");const i=t.room.getRoomCenter();e.moveSnap(i.x,i.y)}}}}}try{t.room?.updateLighting?.()}catch{}return t.chat=[],t}).catch(t=>{throw console.error(" LOAD: Level generation failed:",t),t})}catch(t){throw console.error(" LOAD: Fatal error in loadGameState:",t),t}},function(t){t[t.FLOOR=0]="FLOOR",t[t.WALL=1]="WALL",t[t.WALL_TORCH=2]="WALL_TORCH",t[t.WINDOW=3]="WINDOW",t[t.DOOR=4]="DOOR",t[t.DOWN_LADDER=5]="DOWN_LADDER",t[t.UP_LADDER=6]="UP_LADDER",t[t.POOL=7]="POOL",t[t.MAGMA_POOL=8]="MAGMA_POOL",t[t.CHASM=9]="CHASM",t[t.SPAWN_FLOOR=10]="SPAWN_FLOOR",t[t.SPIKE_TRAP=11]="SPIKE_TRAP",t[t.SPIKE=12]="SPIKE",t[t.TRAP_DOOR=13]="TRAP_DOOR",t[t.INSIDE_LEVEL_DOOR=14]="INSIDE_LEVEL_DOOR",t[t.BUTTON=15]="BUTTON",t[t.FOUNTAIN=16]="FOUNTAIN",t[t.COFFIN=17]="COFFIN",t[t.BONES=18]="BONES"}(fi=e.TileType||(e.TileType={}));class wi{constructor(t,e){if(!t)throw new Error("Cannot create TileState from null tile");if(this.x=t.x,this.y=t.y,this.properties={},t instanceof xe.Floor)this.type=fi.FLOOR;else if(t instanceof Te.WallTorch)this.type=fi.WALL_TORCH,this.properties.isBottomWall=t.isBottomWall,this.properties.frame=t.frame;else if(t instanceof Ye.Window)this.type=fi.WINDOW,this.properties.isBottomWall=t.isBottomWall;else if(t instanceof be.Wall)this.type=fi.WALL;else if(t instanceof Ie.Door)this.type=fi.DOOR,this.properties.doorType=t.type,this.properties.type=t.type,this.properties.isOpen=t.isOpen,this.properties.opened=t.opened,this.properties.locked=t.locked,this.properties.lockType=t.lockable?.lockType,this.properties.keyID=t.lockable?.keyID,this.properties.doorDir=t.doorDir,this.properties.tunnelDoor=t.tunnelDoor,this.properties.globalId=t.globalId,this.properties.linkedDoorGID=t.linkedDoor?.globalId||null;else if(t instanceof Ge.InsideLevelDoor)this.type=fi.INSIDE_LEVEL_DOOR,this.properties.opened=t.opened,this.properties.globalId=t.globalId;else if(t instanceof Le.Button){this.type=fi.BUTTON,this.properties.globalId=t.globalId;const e=t.linkedDoor;this.properties.linkedDoorGID=e?.globalId||null}else if(t instanceof Se.DownLadder){this.type=fi.DOWN_LADDER,this.properties.isSidePath=t.isSidePath,this.properties.environment=t.environment,this.properties.lockType=t.lockable?.lockType,this.properties.keyID=t.lockable?.keyID;const e=t.linkedRoom||null;this.properties.linkedRoomGID=e?e.globalId:null}else if(t instanceof ve.UpLadder){this.type=fi.UP_LADDER,this.properties.isRope=t.isRope||!1;const e=t.linkedRoom||null;this.properties.linkedRoomGID=e?e.globalId:null}else if(t instanceof Ae.Pool){this.type=fi.POOL;const e=1===t.skin?24:20,i=4;this.properties.leftEdge=t.tileX<e,this.properties.rightEdge=t.tileX>e,this.properties.topEdge=t.topEdge,this.properties.bottomEdge=t.tileY>i}else if(t instanceof Me.MagmaPool){this.type=fi.MAGMA_POOL;const e=24,i=4;this.properties.leftEdge=t.tileX<e,this.properties.rightEdge=t.tileX>e,this.properties.topEdge=t.topEdge,this.properties.bottomEdge=t.tileY>i}else if(t instanceof Ce.Chasm){this.type=fi.CHASM;const e=1===t.skin?24:20,i=1;this.properties.leftEdge=t.tileX<e,this.properties.rightEdge=t.tileX>e,this.properties.topEdge=t.topEdge,this.properties.bottomEdge=t.tileY>i}else t instanceof De.SpawnFloor?this.type=fi.SPAWN_FLOOR:t instanceof Pe.FountainTile?(this.type=fi.FOUNTAIN,this.properties.subTileX=t.subTileX,this.properties.subTileY=t.subTileY):t instanceof ke.CoffinTile?(this.type=fi.COFFIN,this.properties.subTileY=t.subTileY):t instanceof Oe.SpikeTrap?(this.type=fi.SPIKE_TRAP,this.properties.triggered=t.triggered):t instanceof _e.Spike?this.type=fi.SPIKE:t instanceof Re.Trapdoor?this.type=fi.TRAP_DOOR:t instanceof Ne.Bones?this.type=fi.BONES:(this.type=fi.FLOOR,console.warn("Unknown tile type, defaulting to FLOOR:",t.constructor.name))}}e.TileState=wi;let Ei=(t,e,i)=>{let s;switch(t.type){case fi.FLOOR:s=new xe.Floor(e,t.x,t.y);break;case fi.WALL:s=new be.Wall(e,t.x,t.y);break;case fi.WALL_TORCH:s=new Te.WallTorch(e,t.x,t.y,t.properties.isBottomWall),s.frame=t.properties.frame||0;break;case fi.WINDOW:s=new Ye.Window(e,t.x,t.y,t.properties.isBottomWall);break;case fi.DOOR:const o=t.properties.doorType??t.properties.type??V.DoorType.DOOR;s=new Ie.Door(e,i,t.x,t.y,t.properties.doorDir,o),s.isOpen=t.properties.isOpen||!1,"boolean"==typeof t.properties.opened&&(s.opened=t.properties.opened),"boolean"==typeof t.properties.locked&&(s.locked=t.properties.locked);try{s.lockable&&void 0!==t.properties.lockType&&(s.lockable.lockType=t.properties.lockType,s.lockable.keyID=t.properties.keyID)}catch{}if(s._pendingLinkedDoorGID=t.properties.linkedDoorGID||null,t.properties.globalId)try{Be.IdGenerator.reserve(t.properties.globalId),s.globalId=t.properties.globalId}catch{}break;case fi.INSIDE_LEVEL_DOOR:if(s=new Ge.InsideLevelDoor(e,i,t.x,t.y),"boolean"==typeof t.properties.opened&&(s.opened=t.properties.opened),t.properties.globalId)try{Be.IdGenerator.reserve(t.properties.globalId),s.globalId=t.properties.globalId}catch{}break;case fi.BUTTON:const a=new Ge.InsideLevelDoor(e,i,t.x,t.y);if(s=new Le.Button(e,t.x,t.y,a),t.properties.globalId)try{Be.IdGenerator.reserve(t.properties.globalId),s.globalId=t.properties.globalId}catch{}s._pendingLinkedDoorGID=t.properties.linkedDoorGID||null;break;case fi.DOWN_LADDER:if(s=new Se.DownLadder(e,i,t.x,t.y,t.properties.isSidePath||!1,t.properties.environment,t.properties.lockType,void 0,{lockType:t.properties.lockType,keyID:t.properties.keyID}),t.properties.linkedRoomGID){const e=i.roomsById?.get(t.properties.linkedRoomGID);e&&(s.linkedRoom=e)}break;case fi.UP_LADDER:if(s=new ve.UpLadder(e,i,t.x,t.y),s.isRope=!!t.properties.isRope,t.properties.linkedRoomGID){const e=i.roomsById?.get(t.properties.linkedRoomGID);e&&(s.linkedRoom=e)}break;case fi.POOL:s=new Ae.Pool(e,t.x,t.y,t.properties.leftEdge||!1,t.properties.rightEdge||!1,t.properties.topEdge||!1,t.properties.bottomEdge||!1);break;case fi.MAGMA_POOL:s=new Me.MagmaPool(e,t.x,t.y,t.properties.leftEdge||!1,t.properties.rightEdge||!1,t.properties.topEdge||!1,t.properties.bottomEdge||!1);break;case fi.CHASM:s=new Ce.Chasm(e,t.x,t.y,t.properties.leftEdge||!1,t.properties.rightEdge||!1,t.properties.topEdge||!1,t.properties.bottomEdge||!1);break;case fi.SPAWN_FLOOR:s=new De.SpawnFloor(e,t.x,t.y);break;case fi.FOUNTAIN:s=new Pe.FountainTile(e,t.x,t.y,t.properties.subTileX||0,t.properties.subTileY||0);break;case fi.COFFIN:s=new ke.CoffinTile(e,t.x,t.y,t.properties.subTileY||0);break;case fi.SPIKE_TRAP:s=new Oe.SpikeTrap(e,t.x,t.y),s.triggered=t.properties.triggered||!1;break;case fi.SPIKE:s=new _e.Spike(e,t.x,t.y);break;case fi.BONES:s=new Ne.Bones(e,t.x,t.y);break;default:console.error("Unknown tile type:",t.type,"TileType enum value:",fi[t.type],"Falling back to floor"),s=new xe.Floor(e,t.x,t.y)}return s.skin=e.skin,s}},5097:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.KnightEnemy=void 0;const s=i(7851),o=i(7455),a=i(6986);class r extends a.Enemy{constructor(t,e,i,a,r){super(t,e,i,a),this.hit=()=>this.damage,this.behavior=()=>{if(this.lastX=this.x,this.lastY=this.y,!this.dead){if(this.handleSkipTurns())return;if(this.seenPlayer){if(this.seenPlayer){if(this.room.playerTicked===this.targetPlayer)if(this.alertTicks=Math.max(0,this.alertTicks-1),this.ticks++,this.ticks%2==1){this.rumbling=!0;let t=this.x,e=this.y,i=Array();for(const t of this.room.entities)t!==this&&i.push({x:t.x,y:t.y});for(let t=this.x-1;t<=this.x+1;t++)for(let e=this.y-1;e<=this.y+1;e++)this.room.roomArray[t][e]instanceof o.SpikeTrap&&this.room.roomArray[t][e].on&&i.push({x:t,y:e});const a=this.searchPathLocalized(this.targetPlayer,i,{useLastPlayerPos:!0});if(a.length>0){let i=!1;for(const t in this.game.players)this.game.rooms[this.game.players[t].levelID]===this.room&&this.game.players[t].x===a[0].pos.x&&this.game.players[t].y===a[0].pos.y&&(this.game.players[t].hurt(this.hit(),this.name),this.drawX=.5*(this.x-this.game.players[t].x),this.drawY=.5*(this.y-this.game.players[t].y),this.game.players[t]===this.game.players[this.game.localPlayerID]&&this.game.shakeScreen(10*this.drawX,10*this.drawY),i=!0);i||(this.tryMove(a[0].pos.x,a[0].pos.y),this.setDrawXY(t,e),this.x>t?this.direction=s.Direction.RIGHT:this.x<t?this.direction=s.Direction.LEFT:this.y>e?this.direction=s.Direction.DOWN:this.y<e&&(this.direction=s.Direction.UP))}this.rumbling=!1,this.unconscious=!0}else this.rumbling=!0,this.unconscious=!1,this.makeHitWarnings();let t=-1!==Object.values(this.game.offlinePlayers).indexOf(this.targetPlayer);if(!this.aggro||t){let e=this.nearestPlayer();if(!1!==e){let[i,s]=e;i<=4&&(t||i<this.playerDistance(this.targetPlayer))&&s!==this.targetPlayer&&(this.targetPlayer=s,this.facePlayer(s),s===this.game.players[this.game.localPlayerID]&&(this.alertTicks=1),this.ticks%2==0&&(this.rumbling=!0,this.makeHitWarnings()))}}}}else{const t=this.nearestPlayer();if(!1!==t){let[e,i]=t;e<4&&(this.rumbling=!0,this.seenPlayer=!0,this.targetPlayer=i,this.facePlayer(i),i===this.game.players[this.game.localPlayerID]&&(this.alertTicks=1),this.makeHitWarnings())}}}},this.draw=t=>{if(this.dead)return;s.Game.ctx.save(),s.Game.ctx.globalAlpha=this.alpha;let e=this.rumble(this.rumbling,this.frame).x;this.rumble(this.rumbling,this.frame,this.direction).y,this.dead||(this.updateDrawXY(t),this.ticks%2==0?(this.tileX=9,this.tileY=8):(this.tileX=4,this.tileY=0),this.frame+=.1*t,this.frame>=4&&(this.frame=0),this.hasShadow&&this.drawShadow(t),s.Game.drawMob(this.tileX+(4===this.tileX?0:Math.floor(this.frame)),this.tileY+2*this.direction,1,2,this.x-this.drawX+e,this.y-this.drawYOffset-this.drawY+(4===this.tileX?.1875:0),1,2,this.softShadeColor,this.shadeAmount(),void 0,this.outlineColor(),this.outlineOpacity())),this.cloned||(this.seenPlayer||this.drawSleepingZs(t),this.alertTicks>0&&this.drawExclamation(t)),s.Game.ctx.restore()},this.ticks=0,this.frame=0,this.health=2,this.maxHealth=2,this.defaultMaxHealth=2,this.tileX=9,this.tileY=8,this.seenPlayer=!1,this.aggro=!1,this.deathParticleColor="#ffffff",this.lastX=this.x,this.lastY=this.y,this.name="burrow knight",this.orthogonalAttack=!0,this.imageParticleX=3,this.imageParticleY=29,r&&(this.drop=r),this.getDrop(["weapon","warhammer","equipment","consumable","tool","coin"])}}e.KnightEnemy=r,r.difficulty=2,r.tileX=9,r.tileY=8},5109:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.ExalterEnemy=void 0;const s=i(7851),o=i(7851),a=i(6986),r=i(6199),n=i(8075),h=i(1124),l=i(9467),c=i(8287),d=i(7455);class m extends a.Enemy{constructor(t,e,i,m){super(t,e,i,m),this.hit=()=>1,this.bleed=()=>{},this.uniqueKillBehavior=()=>{this.unbuffEnemies(),this.removeLightSource(this.lightSource),this.lightSource=null},this.behavior=()=>{this.lastX=this.x,this.lastY=this.y;let t=this.enemyBuffCandidates();if(!this.dead){if(this.handleSkipTurns())return;if(this.ticks++,this.buffEnemies(t),this.updateBuffedEnemies(),this.buffedEnemies.length>0){let t=this.buffedEnemies.reduce((t,e)=>{const i=r.Utils.distance(this.x,this.y,t.x,t.y);return r.Utils.distance(this.x,this.y,e.x,e.y)>i?e:t}),e=Array();for(const t of this.room.entities)t!==this&&e.push({x:t.x,y:t.y});for(let t=this.x-1;t<=this.x+1;t++)for(let i=this.y-1;i<=this.y+1;i++)this.room.roomArray[t][i]instanceof d.SpikeTrap&&this.room.roomArray[t][i].on&&e.push({x:t,y:i});const i=this.searchPathLocalized({x:t.x,y:t.y},e);if(i.length>0){const t=this.x,e=this.y,s=i[0].pos.x,a=i[0].pos.y;this.tryMove(s,a),this.setDrawXY(t,e),this.x>t?this.direction=o.Direction.RIGHT:this.x<t?this.direction=o.Direction.LEFT:this.y>e?this.direction=o.Direction.DOWN:this.y<e&&(this.direction=o.Direction.UP)}}else this.runAway()}this.buffedEnemies.length>0?this.shadeColor="#306082":this.shadeColor="#000000",this.lightSource&&this.lightSource.updatePosition(this.x+.5,this.y+.5)},this.onHurt=(t=1)=>{this.health<this.lastHealth&&this.health%2==0&&this.health>0&&this.teleport(),this.lastHealth=this.health},this.updateBuffedEnemies=()=>{this.buffedEnemies.forEach(t=>{t.dead&&(this.buffedEnemies=this.buffedEnemies.filter(e=>e!==t))})},this.buffEnemies=t=>{t.length>0&&t.forEach(t=>{const e=r.Utils.distance(this.x,this.y,t.x,t.y);10*l.Random.rand()>e&&this.applyBuffTo(t)})},this.enemyBuffCandidates=()=>this.room.entities.filter(t=>t instanceof a.Enemy&&r.Utils.distance(this.x,this.y,t.x,t.y)<=this.range&&!t.buffed&&!t.dead&&t!==this&&!t.buffedBefore).slice(0,c.GameplaySettings.MAX_EXALTER_BUFFS),this.unbuffEnemies=()=>{if(this.buffedEnemies.length>0){for(let t of this.buffedEnemies)t.cloned||t.removeBuff();this.buffedEnemies=[]}},this.applyBuffTo=t=>{if(t.destroyable&&(this.shadeMultiplier=1.5,t.applyBuff(),this.buffedEnemies.push(t),t.buffed)){let e=new n.BeamEffect(t.x,t.y,this.x,this.y,t);e.compositeOperation="source-over",e.color="#00FFFF",e.turbulence=.4,e.gravity=.1,e.iterations=1,e.segments=100,e.angleChange=.001,e.springDamping=.01,e.drawableY=t.drawableY,e.type="buff",this.room.projectiles.push(e)}},this.updateBeam=t=>{for(let t of this.room.projectiles)if(t instanceof n.BeamEffect){if(!this.buffedEnemies.includes(t.parent)||"buff"!==t.type)continue;switch(t.setTarget(this.x-this.drawX,this.y-this.drawY,t.parent.x-t.parent.drawX,t.parent.y-t.parent.drawY),t.drawableY=t.parent.drawableY,Math.floor(this.frame)){case 0:t.color="#00FFFF";break;case 1:case 3:t.color="#00a1dc";break;case 2:t.color="#008ea7"}}},this.draw=t=>{this.dead||(s.Game.ctx.save(),s.Game.ctx.globalAlpha=this.alpha,this.drawableY=this.y,this.dead||(this.updateDrawXY(t),this.updateBeam(t),this.frame+=.1*t,this.frame>=4&&(this.frame=0),this.hasShadow&&this.drawShadow(t),s.Game.drawMob(this.tileX+Math.floor(this.frame),this.tileY,1,2,this.x-this.drawX,this.y-this.drawYOffset-this.drawY,1,2,this.softShadeColor,this.shadeAmount(),void 0,this.outlineColor(),this.outlineOpacity())),s.Game.ctx.restore())},this.ticks=0,this.health=6,this.lastHealth=this.health,this.maxHealth=6,this.tileX=59,this.tileY=8,this.seenPlayer=!0,this.name="exalter",this.range=6,this.aggro=!1,this.frame=0,this.hasShadow=!0,this.buffedBefore=!1,this.buffedEnemies=[],this.shadeColor="#000000",this.lightSource=h.Lighting.newLightSource(this.x+.5,this.y+.5,[10,15,50],3.5,20),this.addLightSource(this.lightSource),this.room.updateLighting(),this.hasBloom=!0,this.bloomColor="#639bff",this.bloomAlpha=.5,this.softBloomAlpha=0,this.dropChance=1,this.getDrop(["exalter"],!1),this.pushable=!1,this.chainPushable=!1,this.destroyableByOthers=!1}}e.ExalterEnemy=m,m.tileX=59,m.tileY=8},5146:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.EmeraldResource=void 0;const s=i(5614),o=i(7172),a=i(9432),r=i(9467),n=i(2103);class h extends o.Resource{constructor(t,e,i,o){super(t,e,i,o),this.tileX=14,this.tileY=0,this.health=3,this.hasBloom=!0,this.bloomColor="#05FF05",this.bloomAlpha=1,this.softBloomAlpha=0,this.name="emerald",r.Random.rand()<.025&&this.drops.push(new a.Geode(this.room,this.x,this.y)),this.drops.push(new s.GreenGem(this.room,this.x,this.y)),this.lightSource=new n.LightSource(this.x+.5,this.y+.5,7,[5,150,5],1),this.addLightSource(this.lightSource)}}e.EmeraldResource=h},5180:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Usable=void 0;const s=i(5366);class o extends s.Item{constructor(t,e,i){super(t,e,i),this.onUse=t=>{},this.useOnOther=(t,e)=>{},this.canUseOnOther=!1}}e.Usable=o},5196:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Torch=void 0;const s=i(1650);class o extends s.Light{constructor(t,e,i){super(t,e,i),this.tileX=28,this.tileY=0,this.name="torch",this.fuelCap=500,this.fuel=500,this.radius=7,this.maxBrightness=4,this.minBrightness=2,this.falloffDecay=.85,this.stackable=!0}}e.Torch=o,o.itemName="torch"},5250:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.DamageNumber=void 0;const s=i(7851),o=i(6291),a=i(9467),r=i(824);class n extends r.Particle{constructor(t,e,i,r,h,l){super(),this.alpha=1,this.frame=0,this.xoffset=0,this.getXoffset=()=>{if(this.room.particles.length>0){let t=this.room.particles.filter(t=>t instanceof n);if(t.length%3==0)return.5;if(t.length%3==1)return 0;if(t.length%3==2)return.25}},this.drawTopLayer=t=>{if(s.Game.ctx.save(),this.dead)return void s.Game.ctx.restore();this.frame>15&&(this.alpha-=.025*t),this.y-=.03*t,this.frame+=t,s.Game.measureText(this.damage.toString()).width,this.alpha<=.002&&(this.alpha=0,this.dead=!0),s.Game.ctx.globalAlpha=this.alpha;const e=s.Game.measureText(this.damage.toString()).width/2;s.Game.fillTextOutline("-"+this.damage.toString(),(this.x+.4+this.xoffset)*o.GameConstants.TILESIZE-e,(this.y-.6)*o.GameConstants.TILESIZE,this.outlineColor,this.color),s.Game.ctx.globalAlpha=1,s.Game.ctx.restore()},this.room=t,this.damage=r,this.x=e,this.y=i,this.color=h||"red",this.outlineColor=l||o.GameConstants.OUTLINE,this.xoffset=.2*a.Random.rand()}}e.DamageNumber=n},5312:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.CaveRock=void 0;const s=i(7172),o=i(9432),a=i(9467);class r extends s.Resource{constructor(t,e,i,s){super(t,e,i,s),this.room=t,this.health=2,this.tileX=10,this.tileY=6,this.hasShadow=!1,this.chainPushable=!1,this.imageParticleX=9,this.imageParticleY=24,this.name="cave rock",a.Random.rand()<.005&&this.drops.push(new o.Geode(this.room,this.x,this.y))}}e.CaveRock=r},5339:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.EnergyWizardEnemy=e.WizardState=void 0;const s=i(7851),o=i(263);var a;!function(t){t[t.idle=0]="idle",t[t.attack=1]="attack",t[t.justAttacked=2]="justAttacked",t[t.teleport=3]="teleport"}(a=e.WizardState||(e.WizardState={}));class r extends o.WizardEnemy{constructor(t,e,i,o,r){super(t,e,i,o),this.draw=t=>{this.dead||(s.Game.ctx.save(),s.Game.ctx.globalAlpha=this.alpha,this.dead||(this.updateDrawXY(t),this.state===a.attack?this.tileX=7:this.tileX=6,this.hasShadow&&this.state!==a.teleport&&this.drawShadow(t),this.frame>=0?(s.Game.drawMob(Math.floor(this.frame)+6,2,1,2,this.x,this.y-1.3,1,2,this.softShadeColor,this.shadeAmount()),this.frame+=.4*t,this.frame>12&&(this.frame=-1)):s.Game.drawMob(this.tileX,this.tileY,1,2,this.x-this.drawX,this.y-1.3-this.drawY,1,2,this.softShadeColor,this.shadeAmount(),void 0,this.outlineColor(),this.outlineOpacity()),this.cloned||(this.seenPlayer||this.drawSleepingZs(t),this.alertTicks>0&&this.drawExclamation(t))),s.Game.ctx.restore())},this.ticks=0,this.health=1,this.maxHealth=1,this.defaultMaxHealth=1,this.tileX=6,this.tileY=0,this.frame=0,this.state=a.attack,this.seenPlayer=!1,this.alertTicks=0,this.name="wizard bomber",this.projectileColor=[0,50,150],r&&(this.drop=r),this.getDrop(["weapon","equipment","consumable","tool","coin"])}}e.EnergyWizardEnemy=r,r.difficulty=3,r.tileX=6,r.tileY=0},5350:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.LevelValidator=e.ValidationErrorType=void 0;const s=i(4118);var o;!function(t){t.INSUFFICIENT_ROOMS="INSUFFICIENT_ROOMS",t.BOSS_ROOM_MISSING="BOSS_ROOM_MISSING",t.BOSS_TOO_CLOSE="BOSS_TOO_CLOSE",t.OVERLAPPING_PARTITIONS="OVERLAPPING_PARTITIONS",t.EMPTY_PARTITIONS="EMPTY_PARTITIONS",t.STAIR_ROOM_MISSING="STAIR_ROOM_MISSING",t.INSUFFICIENT_CAVE_ROOMS="INSUFFICIENT_CAVE_ROOMS"}(o=e.ValidationErrorType||(e.ValidationErrorType={})),e.LevelValidator=class{constructor(t,e=!1){this.game=t,this.enableDebugMessages=e||document.cookie.includes("showgeneration=true")}validateDungeonPartitions(t,e){const i=this.validateNotEmpty(t);if(!i.isValid)return i;const s=this.validateMinimumRoomCount(t,e.minRoomCount);if(!s.isValid)return s;const o=this.validateBossRoomExists(t);if(!o.isValid)return o;const a=this.validateBossRoomDistance(t,3);if(!a.isValid)return a;const r=this.validateNoOverlaps(t);if(!r.isValid)return r;const n=this.validateStairRoomExists(t);return n.isValid?{isValid:!0}:n}validateCavePartitions(t,e){const i=this.validateNotEmpty(t);if(!i.isValid)return i;if(!this.validateMinimumRoomCount(t,e).isValid)return{isValid:!1,errorMessage:`Cave needs at least ${e} rooms, got ${t.length}`,errorType:o.INSUFFICIENT_CAVE_ROOMS};const s=this.validateNoOverlaps(t);if(!s.isValid)return s;const a=this.validateRopeCaveExists(t);return a.isValid?{isValid:!0}:a}validateTutorialPartitions(t){const e=this.validateNotEmpty(t);return e.isValid?1!==t.length?{isValid:!1,errorMessage:`Tutorial should have exactly 1 room, got ${t.length}`,errorType:o.INSUFFICIENT_ROOMS}:t[0].type!==s.RoomType.TUTORIAL?{isValid:!1,errorMessage:"Tutorial room is not marked with TUTORIAL type",errorType:o.INSUFFICIENT_ROOMS}:{isValid:!0}:e}validateNotEmpty(t){if(!t||0===t.length){const t="No partitions generated";return this.logValidationError(t),{isValid:!1,errorMessage:t,errorType:o.EMPTY_PARTITIONS}}return{isValid:!0}}validateMinimumRoomCount(t,e){if(t.length<e){const i=`Not enough rooms: need ${e}, got ${t.length}`;return this.logValidationError(i),{isValid:!1,errorMessage:i,errorType:o.INSUFFICIENT_ROOMS}}return{isValid:!0}}validateBossRoomExists(t){if(!t.some(t=>t.type===s.RoomType.BOSS)){const t="Boss room unreachable or missing";return this.logValidationError(t),{isValid:!1,errorMessage:t,errorType:o.BOSS_ROOM_MISSING}}return{isValid:!0}}validateBossRoomDistance(t,e){const i=t.find(t=>t.type===s.RoomType.BOSS);if(!i)return this.validateBossRoomExists(t);if(i.distance<e){const t=`Boss room too close to spawn: distance ${i.distance}, minimum ${e}`;return this.logValidationError(t),{isValid:!1,errorMessage:t,errorType:o.BOSS_TOO_CLOSE}}return{isValid:!0}}validateNoOverlaps(t){for(let e=0;e<t.length;e++)for(let i=e+1;i<t.length;i++){const s=t[e],a=t[i];if(s.x<a.x+a.w&&s.x+s.w>a.x&&s.y<a.y+a.h&&s.y+s.h>a.y){const t=`Overlapping partitions detected: partition ${e} overlaps with partition ${i}`;return this.logValidationError(t),{isValid:!1,errorMessage:t,errorType:o.OVERLAPPING_PARTITIONS}}}return{isValid:!0}}validateStairRoomExists(t){if(!t.some(t=>t.type===s.RoomType.DOWNLADDER)){const t="Stair room missing - dungeon cannot be completed";return this.logValidationError(t),{isValid:!1,errorMessage:t,errorType:o.STAIR_ROOM_MISSING}}return{isValid:!0}}validateRopeCaveExists(t){if(!t.some(t=>t.type===s.RoomType.ROPECAVE)){const t="Rope cave starting room missing";return this.logValidationError(t),{isValid:!1,errorMessage:t,errorType:o.INSUFFICIENT_CAVE_ROOMS}}return{isValid:!0}}validateConnectivity(t){const e=t.filter(t=>0===t.connections.length);if(e.length>0){const t=`Found ${e.length} unconnected rooms`;return this.logValidationError(t),{isValid:!1,errorMessage:t,errorType:o.INSUFFICIENT_ROOMS}}return{isValid:!0}}validateRequiredRoomTypes(t,e){const i=new Set(t.map(t=>t.type)),s=e.filter(t=>!i.has(t));if(s.length>0){const t=`Missing required room types: ${s.join(", ")}`;return this.logValidationError(t),{isValid:!1,errorMessage:t,errorType:o.INSUFFICIENT_ROOMS}}return{isValid:!0}}validatePartitionQuality(t){const e=t.filter(t=>t.w<4||t.h<4);if(e.length>0){const t=`Found ${e.length} partitions smaller than minimum size 4`;return this.logValidationError(t),{isValid:!1,errorMessage:t,errorType:o.INSUFFICIENT_ROOMS}}const i=t.filter(t=>t.w<=0||t.h<=0||t.x<0||t.y<0);if(i.length>0){const t=`Found ${i.length} partitions with invalid dimensions`;return this.logValidationError(t),{isValid:!1,errorMessage:t,errorType:o.INSUFFICIENT_ROOMS}}return{isValid:!0}}logValidationError(t){this.enableDebugMessages&&(console.warn(`[LevelValidator] ${t}`),this.game&&this.game.pushMessage&&this.game.pushMessage(t))}validateWithDetailedReport(t,e,i="dungeon"){const s=[];s.push(`Validating ${i} with ${t.length} partitions`),"dungeon"===i&&(s.push(`Required minimum rooms: ${e.minRoomCount}`),s.push(`Required maximum rooms: ${e.maxRoomCount}`));const o="dungeon"===i?this.validateDungeonPartitions(t,e):"cave"===i?this.validateCavePartitions(t,8):this.validateTutorialPartitions(t);return o.isValid?s.push("Validation passed"):s.push(`Validation failed: ${o.errorMessage}`),{...o,details:s}}}},5366:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Item=void 0;const s=i(7851),o=i(6291),a=i(7366),r=i(8160),n=i(6199),h=i(9467),l=i(5947),c=i(3458),d=i(2147),m=i(2502),u=i(6277);class p extends r.Drawable{constructor(t,e,i,r=0){super(),this.group=null,this.degradeable=!0,this.cooldown=0,this.maximumStackCount=8,this.animStartX=0,this.animStartY=0,this.animTargetX=0,this.animTargetY=0,this.animT=0,this.animStartDistance=null,this.hoverText=()=>this.name,this.tick=()=>{},this.tickInInventory=()=>{},this.getDescription=()=>{const t=this.stackable?`\nAmount: ${this.stackCount}`:"";return`${this.name} \n${this.description} \n${t}`},this.animateFromChest=()=>{this.chestOffsetY=.5,this.alpha=0,this.inChest=!0,this.sineAnimateFactor=0,this.setDrawOffset()},this.pickupSound=()=>{let t=0;o.GameConstants.ITEM_AUTO_PICKUP&&this.animateToInventory&&(t=Math.ceil(200*h.Random.rand()+400)),this.level===this.level.game.room&&a.Sound.delayPlay(a.Sound.genericPickup,t)},this.onDrop=()=>{},this.onPickup=t=>{t.inventory.canPickup(this)&&(this.player=t,this.pickedUp||(this.startY=t.y,this.drawableY=this.y,this.alpha=1,this.pickedUp=t.inventory.addItem(this),this.pickedUp&&(!0===this.animateToInventory&&(this.animStartX=this.x,this.animStartY=this.y,this.animTargetX=this.player.x,this.animTargetY=this.player.y,this.animT=0),this.isNewItem(t)&&(this.pickupMessage(),t.inventory.foundItems.push(this)),this.pickupSound(),m.globalEventBus.emit(u.EVENTS.ITEM_COLLECTED,{itemId:this.name}),this.grouped&&(d.statsTracker.recordWeaponChoice(this.name),this.group.destroyOtherItems(this),this.grouped=!1,this.group=null))))},this.autoPickup=()=>{o.GameConstants.ITEM_AUTO_PICKUP&&this.animateToInventory&&this.onPickup(this.level.game.players[this.level.game.localPlayerID])},this.pickupMessage=()=>{const t=this.constructor.itemName;let e=this.stackable?`You find ${this.stackCount} ${t}.`:`You find a ${t}.`;this.stackCount>1&&"coin"===this.name&&(e=`You find ${this.stackCount} ${t}s.`),this.level.game.pushMessage(e)},this.isNewItem=t=>{for(let e of t.inventory.foundItems)if(e.constructor===this.constructor)return!1;return!0},this.dropFromInventory=()=>{this.setDrawOffset()},this.shadeAmount=()=>o.GameConstants.SMOOTH_LIGHTING&&!o.GameConstants.SHADE_INLINE_IN_ENTITY_LAYER?0:this.level.softVis[this.x]?this.level.softVis[this.x]?.[this.y]:(console.warn("tried to get shade for tile that does not exist",this.x,this.y),0),this.drawStatus=(t,e)=>{},this.drawBrokenSymbol=(t,e)=>{this.broken&&s.Game.drawFX(5,0,1,1,t-.5/o.GameConstants.TILESIZE,e-.5/o.GameConstants.TILESIZE,1,1)},this.draw=t=>{if(s.Game.ctx.save(),!this.pickedUp){s.Game.ctx.globalAlpha=this.alpha,this.alpha<1&&(this.alpha+=.01*t),this.drawableY=this.y,this.inChest&&(this.chestOffsetY-=.035*Math.abs(this.chestOffsetY+.5)*t,this.chestOffsetY<-.47&&(this.chestOffsetY=-.5)),this.sineAnimateFactor<1&&this.chestOffsetY<-.45&&(this.sineAnimateFactor+=.2*t),this.scaleFactor>0&&(this.scaleFactor*=.5**t,this.scaleFactor<.01&&(this.scaleFactor=0));const e=1/(this.scaleFactor+1);s.Game.ctx.imageSmoothingEnabled=!1,c.Shadow.draw(this.x,this.y,1,1),this.frame+=t*(2*Math.PI)/60,s.Game.drawItem(this.tileX,this.tileY,1,2,this.x+this.w*(-.5*e+.5)+this.drawOffset,this.y+this.sineAnimateFactor*Math.sin(this.frame)*.07-1+this.offsetY+this.h*(-.5*e+.5)+this.chestOffsetY,this.w*e,this.h*e,this.level.shadeColor,this.shadeAmount())}s.Game.ctx.restore()},this.setDrawOffset=()=>{const t=this.level.items.filter(t=>t.x===this.x&&t.y===this.y);t.length>1&&t.forEach(e=>{e.drawOffset=(-t.length/2+t.indexOf(e)+1)/t.length})},this.degrade=()=>{this.degradeable&&(this.durability-=1)},this.drawAboveShading=t=>{if(this.pickedUp&&!0===this.animateToInventory&&this.player){const e=.025*t;this.animT=Math.min(1,this.animT+e);const i=Math.pow(this.animT,2),a=this.animStartX*(1-i)+this.animTargetX*i+(this.player.x-this.animTargetX-this.player.drawX)*i+this.drawOffset,r=this.animStartY*(1-i)+this.animTargetY*i+(this.player.y-this.animTargetY-this.player.drawY)*i+this.chestOffsetY;null===this.animStartDistance&&(this.animStartDistance=n.Utils.distance(this.player.x-this.player.drawX,this.player.y-this.player.drawY,a,r));const h=Math.abs(n.Utils.distance(this.player.x-this.player.drawX,this.player.y-this.player.drawY,a,r)),l=.5;if(i>l){const t=(i-l)/(1-l);this.alpha=Math.max(1-t,Math.abs(h/this.animStartDistance))}return o.GameConstants.ALPHA_ENABLED&&(s.Game.ctx.globalAlpha=Math.max(0,this.alpha)),this.x=Math.floor(a),this.y=Math.floor(r),s.Game.drawItem(this.tileX,this.tileY,1,2,a,r-1.5,this.w,this.h,this.level.shadeColor,this.shadeAmount()),s.Game.ctx.globalAlpha=1,void(this.animT>=1&&(this.level.items=this.level.items.filter(t=>t!==this)))}},this.drawTopLayer=t=>{if(this.pickedUp){if(!1!==this.animateToInventory)return;this.pickupOffsetY+=.1*(4.5-this.pickupOffsetY)*t,this.alpha*=.9**t,Math.abs(this.alpha)<.01&&(this.drawOffset=0,this.pickupOffsetY=1,this.level.items=this.level.items.filter(t=>t!==this)),o.GameConstants.ALPHA_ENABLED&&(s.Game.ctx.globalAlpha=Math.max(0,this.alpha)),s.Game.drawItem(this.tileX,this.tileY,1,2,this.x,this.y-this.pickupOffsetY,this.w,this.h),s.Game.ctx.globalAlpha=1}},this.outline=()=>({color:"white",opacity:0,offset:0,manhattan:!1}),this.drawIcon=(t,e,i,a=1,r)=>{o.GameConstants.ALPHA_ENABLED&&(s.Game.ctx.globalAlpha=a),this.drawDurability(e,i);let n=0;this.durability<=1&&!this.broken&&(n=Math.round(Math.sin(Date.now()/25)+.5)/2/o.GameConstants.TILESIZE),this.cooldown>0&&(s.Game.ctx.globalAlpha=.35),s.Game.drawItem(this.tileX,this.tileY,1,2,e+n,i-1+this.iconOffset,this.w,this.h,void 0,void 0,void 0,this.outline().color,this.outline().opacity,this.outline().offset,this.outline().manhattan),s.Game.ctx.globalAlpha=1;let h=r||this.stackCount,l=h<=1?"":""+h,c=16-s.Game.measureText(l).width;s.Game.fillTextOutline(l,e*o.GameConstants.TILESIZE+c,i*o.GameConstants.TILESIZE+10,o.GameConstants.OUTLINE,"white"),this.drawCooldown(e,i),this.drawStatus(e,i),this.drawBrokenSymbol(e,i)},this.drawCooldown=(t,e)=>{this.cooldown>0&&s.Game.fillTextOutline(this.cooldown.toString(),t*o.GameConstants.TILESIZE+10,e*o.GameConstants.TILESIZE+10,o.GameConstants.OUTLINE,"white")},this.drawDurability=(t,e)=>{if(this.durability<this.durabilityMax){const i=this.durability/this.durabilityMax;let a=n.Utils.hsvToHex(120*i,1,1);const r=o.GameConstants.TILESIZE,h=Math.ceil(i*r),l=2,c=Math.ceil(t*o.GameConstants.TILESIZE),d=Math.ceil(e*o.GameConstants.TILESIZE+o.GameConstants.TILESIZE-2);s.Game.ctx.fillStyle=a,s.Game.ctx.imageSmoothingEnabled=!1,s.Game.ctx.fillRect(c,d,h,l),s.Game.ctx.fillStyle="white"}},this.globalId=l.IdGenerator.generate("IT"),this.level=t,this.x=e,this.y=i,this.z=r,this.drawableY=i,this.w=1,this.h=2,this.tileX=0,this.tileY=0,this.frame=0,this.stackable=!1,this.stackCount=1,this.pickedUp=!1,this.alpha=1,this.scaleFactor=5,this.offsetY=-.5,this.name="item",this.startY=i,this.randomOffset=h.Random.rand(),this.durability=50,this.durabilityMax=50,this.broken=!1,this.description="",this.drawOffset=0,this.pickupOffsetY=1,this.chestOffsetY=0,this.sineAnimateFactor=1,this.iconOffset=0,this.grouped=!1,this.group=null,this.maximumStackCount=12,this.player=null}static add(t,e,i,...s){return new this(t,e,i,...s)}get animateToInventory(){return o.GameConstants.AUTO_PICKUP_ITEMS.includes(this.constructor)}destroy(){this.pickedUp=!0}}e.Item=p},5367:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.DecoBlock=void 0;const s=i(606),o=i(7851),a=i(606);class r extends s.Entity{constructor(t,e,i,s){super(t,e,i,s),this.draw=t=>{this.dead||(o.Game.ctx.save(),o.Game.ctx.globalAlpha=this.alpha,this.dead||(this.hasShadow&&this.drawShadow(t),this.updateDrawXY(t),o.Game.drawObj(this.tileX,this.tileY,1,2,this.x-this.drawX,this.y-this.drawYOffset-this.drawY,1,2,this.room.shadeColor,this.shadeAmount())),o.Game.ctx.restore())},this.drawTopLayer=t=>{this.drawableY=this.y},this.room=t,this.health=1,this.tileX=1,this.tileY=4,this.hasShadow=!0,this.pushable=!0,this.name="deco block",this.imageParticleX=3,this.imageParticleY=25}get type(){return a.EntityType.PROP}}e.DecoBlock=r},5614:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.GreenGem=void 0;const s=i(5180);class o extends s.Usable{constructor(t,e,i){super(t,e,i),this.useOnOther=(t,e)=>{"gold ring"===e.name&&e.embed(t,this)},this.getDescription=()=>"An emerald gem. Embed it into a gold ring to imbue it with magic.",this.tileX=11,this.tileY=0,this.name=o.itemName,this.canUseOnOther=!0,this.stackable=!0}}e.GreenGem=o,o.itemName="emerald"},5625:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.LevelParameterGenerator=e.enemyClasses=void 0;const s=i(8200),o=i(7716),a=i(3180),r=i(7975),n=i(5339),h=i(9982),l=i(3005),c=i(492),d=i(675),m=i(6598),u=i(5097),p=i(9357),y=i(4159),g=i(6493),f=i(3175),w=i(1429),E=i(9997);e.enemyClasses={1:s.CrabEnemy,2:o.FrogEnemy,3:a.ZombieEnemy,4:r.SkullEnemy,5:n.EnergyWizardEnemy,6:h.ChargeEnemy,7:g.RookEnemy,8:l.BishopEnemy,9:c.ArmoredzombieEnemy,10:d.BigSkullEnemy,11:m.QueenEnemy,12:u.KnightEnemy,13:p.BigKnightEnemy,14:y.FireWizardEnemy,15:f.ArmoredSkullEnemy,16:w.MummyEnemy,17:E.SpiderEnemy},e.LevelParameterGenerator=class{static getParameters(t){return{minRoomCount:0,maxRoomCount:t>0?12:6,maxRoomArea:t>0?120+10*t:40,mapWidth:25+5*t,mapHeight:25+5*t,splitProbabilities:[.75,1,.25],wallRemoveProbability:t>0?.1:1,numLoopDoorsRange:[4,8],numberOfRooms:t>0?5:3,softMaxRoomArea:t>0?.5*(120+10*t):40}}}},5643:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Rubble=void 0;const s=i(606),o=i(7851),a=i(606),r=i(7366),n=i(9432),h=i(9467);class l extends s.Entity{constructor(t,e,i,s){super(t,e,i,s),this.uniqueKillBehavior=()=>{this.cloned||r.Sound.delayPlay(r.Sound.breakRock,50)},this.draw=t=>{this.dead||(o.Game.ctx.save(),o.Game.ctx.globalAlpha=this.alpha,this.dead||(this.hasShadow&&this.drawShadow(t),this.updateDrawXY(t),o.Game.drawObj(this.tileX,this.tileY,1,2,this.x-this.drawX,this.y-this.drawYOffset-this.drawY,1,2,this.room.shadeColor,this.shadeAmount())),o.Game.ctx.restore())},this.drawTopLayer=t=>{this.drawableY=this.y},this.room=t,this.health=1,this.tileX=0,this.tileY=7,this.hasShadow=!0,this.chainPushable=!1,this.name="rubble",this.imageParticleX=0,this.imageParticleY=25,this.opaque=!0,h.Random.rand()<.01&&this.drops.push(new n.Geode(this.room,this.x,this.y))}get type(){return a.EntityType.PROP}}e.Rubble=l},5692:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.CrossbowStock=void 0;const s=i(5180),o=i(2124),a=i(4752);class r extends s.Usable{constructor(t,e,i){super(t,e,i),this.onDrop=()=>{"stock"===this.level.game.lastDroppedCrossbowPiece?(this.level.game.lastDroppedCrossbowPiece=null,this.level.items.push(new a.CrossbowLimb(this.level,this.x,this.y)),this.level.items=this.level.items.filter(t=>t!==this)):null===this.level.game.lastDroppedCrossbowPiece&&(this.level.game.lastDroppedCrossbowPiece="stock")},this.useOnOther=(t,e)=>{if(e instanceof a.CrossbowLimb){t.inventory.removeItem(this),t.inventory.removeItem(e),t.game.pushMessage("You combine the crossbow stock and limb.");const i=t?.getRoom?t.getRoom():t.game.rooms[t.levelID],s=new o.Crossbow(i,t.x,t.y);t.inventory.addItem(s)}},this.tileX=26,this.tileY=4,this.stackable=!1,this.name=r.itemName,this.description="The stock of a crossbow. Find the limb to use it.",this.canUseOnOther=!0}}e.CrossbowStock=r,r.itemName="crossbow stock"},5711:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Bush=void 0;const s=i(606),o=i(7851),a=i(606),r=i(7366);class n extends s.Entity{constructor(t,e,i,s){super(t,e,i,s),this.draw=t=>{this.dead||(o.Game.ctx.save(),o.Game.ctx.globalAlpha=this.alpha,this.dead||(this.updateDrawXY(t),this.hasShadow&&this.drawShadow(t),o.Game.drawObj(this.tileX,this.tileY,2,2,this.x-this.drawX-.5,this.y-this.drawYOffset-this.drawY,2,2,this.room.shadeColor,this.shadeAmount())),o.Game.ctx.restore())},this.drawTopLayer=t=>{this.drawableY=this.y},this.room=t,this.health=1,this.tileX=19,this.tileY=2,this.hasShadow=!0,this.chainPushable=!1,this.name="bush",this.imageParticleX=0,this.imageParticleY=28,this.opaque=!0,this.hitSound=r.Sound.playBush}get type(){return a.EntityType.PROP}}e.Bush=n},5734:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.ScytheHandle=void 0;const s=i(5180),o=i(920),a=i(2772);class r extends s.Usable{constructor(t,e,i){super(t,e,i),this.onDrop=()=>{"handle"===this.level.game.lastDroppedScythePiece?(this.level.game.lastDroppedScythePiece=null,this.level.items.push(new a.ScytheBlade(this.level,this.x,this.y)),this.level.items=this.level.items.filter(t=>t!==this)):null===this.level.game.lastDroppedScythePiece&&(this.level.game.lastDroppedScythePiece="handle")},this.useOnOther=(t,e)=>{if(e instanceof a.ScytheBlade){t.inventory.removeItem(this),t.inventory.removeItem(e),t.game.pushMessage("You combine the scythe blade and handle.");const i=t?.getRoom?t.getRoom():t.game.rooms[t.levelID],s=new o.Scythe(i,t.x,t.y);t.inventory.addItem(s)}},this.tileX=29,this.tileY=2,this.stackable=!1,this.name=r.itemName,this.description="The handle of a scythe. Find the blade to use it.",this.canUseOnOther=!0}}e.ScytheHandle=r,r.itemName="scythe handle"},5741:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Tree=void 0;const s=i(606),o=i(7851),a=i(606),r=i(9938),n=i(7366),h=i(9467);class l extends s.Entity{constructor(t,e,i,s){super(t,e,i,s),this.seeThroughAlpha=1,this.softSeeThroughAlpha=1,this.uniqueKillBehavior=()=>{this.cloned||n.Sound.playWood()},this.draw=t=>{this.room.getPlayer(),this.room.hasEnemy(this.x,this.y-1),this.tileX=2===this.health?14:16,!0===this.cloned&&(this.tileX=16),this.dead||(o.Game.ctx.save(),o.Game.ctx.globalAlpha=this.alpha,this.dead||(this.hasShadow&&this.drawShadow(t),this.updateDrawXY(t),o.Game.ctx.save(),this.updateSeeThroughAlpha(t),this.cloned||(o.Game.ctx.globalAlpha=this.softSeeThroughAlpha),o.Game.drawObj(this.tileX,this.tileY,2,3,this.x-this.drawX-.5,this.y-this.drawYOffset-this.drawY-1,2,3,this.room.shadeColor,this.shadeAmount()),o.Game.ctx.restore(),o.Game.drawObj(this.tileX,9,2,3,this.x-this.drawX-.5,this.y-this.drawYOffset-this.drawY-1,2,3,this.room.shadeColor,this.shadeAmount())),o.Game.ctx.restore())},this.drawTopLayer=t=>{this.drawableY=this.y},this.room=t,this.health=2,this.maxHealth=2,this.tileX=14,this.tileY=6,this.hasShadow=!0,this.chainPushable=!1,this.name="tree",this.imageParticleX=0,this.imageParticleY=28,this.opaque=!0,this.hitSound=n.Sound.playBush,h.Random.rand()<.5&&this.drops.push(new r.Apple(this.room,this.x,this.y))}get type(){return a.EntityType.PROP}}e.Tree=l},5778:(t,e,i)=>{"use strict";t.exports=i.p+"assets/objset.b5676c8fdf62e96c0af7.png"},5816:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.IronOre=void 0;const s=i(5366),o=i(7366),a=i(9513);class r extends s.Item{constructor(t,e,i){super(t,e,i),this.smelt=t=>{t.inventory.isFull()?this.level.game.pushMessage("You don't have enough space in your inventory to smelt the iron ore."):this.stackCount>=3&&(t.inventory.subtractItem(this,3),t.inventory.addItem(new a.IronBar(this.level,this.x,this.y)),o.Sound.playSmith(),this.level.game.pushMessage("You smelt the iron ore into a iron bar."))},this.tileX=16,this.tileY=2,this.name=r.itemName,this.stackable=!0,this.description="Some iron ore"}}e.IronOre=r,r.itemName="iron ore"},5838:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.GoldResource=void 0;const s=i(7172),o=i(2176),a=i(9432),r=i(9467);class n extends s.Resource{constructor(t,e,i,s){super(t,e,i,s),this.tileX=13,this.tileY=0,this.health=2,this.name="gold",r.Random.rand()<.005&&this.drops.push(new a.Geode(this.room,this.x,this.y)),this.drops.push(new o.GoldOre(this.room,this.x,this.y))}}e.GoldResource=n},5862:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Explosion=void 0;const s=i(8774),o=i(7851),a=i(4254),r=i(1124),n=i(6199),h=i(9245);class l extends s.Projectile{constructor(t,e,i,s){super(t,e,i),this.drawTopLayer=t=>{this.dead||(this.offsetFrame<0&&(this.offsetFrame+=10*t),this.offsetFrame>=0&&(this.frame+=.25*t),this.frame>17&&(this.dead=!0),o.Game.drawFX(Math.floor(this.frame),6,1,2,this.x,this.y-1,1,2))},this.state=0,this.frame=6,this.parent=t,this.offsetFrame=100*-n.Utils.distance(this.parent.x,this.parent.y,this.x,this.y),this.delay=0,r.Lighting.momentaryLight(this.parent.room,this.x+.5,this.y+.5,.5,[255,100,0],350,20,Math.abs(this.offsetFrame));const l=n.Utils.distance(this.parent.x,this.parent.y,this.x,this.y),c=0===l?1:Math.max(.5,Math.floor(1/l*6)/2);for(const t of this.parent.room.entities)t.x===this.x&&t.y===this.y&&t!==this.parent&&(t instanceof h.Bomb&&(t.fuseLength=1),t.hurt(s,c)),s.x===this.x&&s.y===this.y&&s instanceof a.Player&&s.hurt(c,"bomb")}}e.Explosion=l},5926:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Key=void 0;const s=i(7366),o=i(5180),a=i(7851),r=i(3458);class n extends o.Usable{constructor(t,e,i){super(t,e,i),this.getDescription=()=>"KEY\nA key. "+(null!==this.depth?"Depth: "+this.depth.toString():""),this.onPickup=t=>{this.pickedUp||(this.pickedUp=t.inventory.addItem(this),this.pickedUp&&(this.level.game.pushMessage("You found a key!"),this.level.game.pushMessage("Click key to toggle path guide"),s.Sound.keyPickup(),null===this.depth&&(this.depth=t.depth),console.log(this.depth)))},this.onUse=t=>{if(null===this.depth&&(this.depth=t.depth),this.depth!==t.depth)return void this.room.game.pushMessage("This key doesn't fit on this floor.");const e=!this.showPath;for(const t of Object.values(this.room.game.players))for(const e of t.inventory.items)e instanceof n&&e!==this&&(e.showPath=!1,e.tileX=1,e.tileY=0);this.showPath=e,this.tileX=this.showPath?2:1,this.tileY=0;const i=this.showPath?"Showing path":"Path hidden";this.room.syncKeyPathParticles(this,t),this.room.game.pushMessage(i)},this.tickInInventory=()=>{},this.onDrop=()=>{this.showPath=!1,this.tileX=this.showPath?2:1,this.room.syncKeyPathParticles()},this.draw=t=>{if(a.Game.ctx.save(),this.animateFrame+=t/8,(this.animateFrame>=8||this.pickedUp)&&(this.animateFrame=0),!this.pickedUp){a.Game.ctx.globalAlpha=this.alpha,this.alpha<1&&(this.alpha+=.01*t),this.drawableY=this.y,this.inChest&&(this.chestOffsetY-=.035*Math.abs(this.chestOffsetY+.5)*t,this.chestOffsetY<-.47&&(this.chestOffsetY=-.5)),this.sineAnimateFactor<1&&this.chestOffsetY<-.45&&(this.sineAnimateFactor+=.2*t),this.scaleFactor>0&&(this.scaleFactor*=.5**t,this.scaleFactor<.01&&(this.scaleFactor=0));const e=1/(this.scaleFactor+1);a.Game.ctx.imageSmoothingEnabled=!1,r.Shadow.draw(this.x,this.y,1,1),this.frame+=t*(2*Math.PI)/60,a.Game.drawItem(Math.floor(this.tileX+this.animateFrame),this.tileY,1,2,this.x+this.w*(-.5*e+.5)+this.drawOffset,this.y+this.sineAnimateFactor*Math.sin(this.frame)*.07-1+this.offsetY+this.h*(-.5*e+.5)+this.chestOffsetY,this.w*e,this.h*e,this.level.shadeColor,this.shadeAmount())}a.Game.ctx.restore()},this.updatePathToDoor=t=>{try{const e=t||this.level.game.players[this.level.game.localPlayerID],i=e?.getRoom?.()||this.level;if(!i)return;const s=this.level.level.findSidepathDownLadderByKeyID(i,this.doorID);if(!s)return void(i.keyPathDots=void 0);const{ladder:o,room:a}=s;if(a===i){const t=i.buildTilePathPositions(e.x,e.y,o.x,o.y);return void(i.keyPathDots=t)}const r=i.findShortestDoorPathTo(a,!0);if(!r||0===r.length)return void(i.keyPathDots=void 0);const n=r[0],h=i.buildTilePathPositions(e.x,e.y,n.x,n.y);i.keyPathDots=h}catch(t){}},this.tileX=0,this.tileY=4,this.name="key",this.doorID=0,this.depth=null,this.room=t,this.showPath=!1,this.animateFrame=0}}e.Key=n,n.itemName="key"},5947:(t,e)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.IdGenerator=void 0;class i{static generate(t=""){let e;do{const i=(this._next++).toString(36);e=t?`${t}-${i}`:i}while(this._registry.has(e));return this._registry.add(e),e}static reserve(t){if(this._registry.has(t))throw new Error(`Duplicate ID detected while reserving: ${t}`);this._registry.add(t)}static isReserved(t){return this._registry.has(t)}static resetForTest(){this._next=BigInt(1),this._registry.clear()}}e.IdGenerator=i,i._next=BigInt(1),i._registry=new Set},5949:(t,e,i)=>{"use strict";i.r(e),i.d(e,{MAX:()=>s,NIL:()=>o,parse:()=>n,stringify:()=>c,v1:()=>g,v1ToV6:()=>f,v3:()=>O,v4:()=>R,v5:()=>N,v6:()=>Y,v6ToV1:()=>B,v7:()=>F,validate:()=>r,version:()=>W});const s="ffffffff-ffff-ffff-ffff-ffffffffffff",o="00000000-0000-0000-0000-000000000000",a=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-8][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000|ffffffff-ffff-ffff-ffff-ffffffffffff)$/i,r=function(t){return"string"==typeof t&&a.test(t)},n=function(t){if(!r(t))throw TypeError("Invalid UUID");let e;return Uint8Array.of((e=parseInt(t.slice(0,8),16))>>>24,e>>>16&255,e>>>8&255,255&e,(e=parseInt(t.slice(9,13),16))>>>8,255&e,(e=parseInt(t.slice(14,18),16))>>>8,255&e,(e=parseInt(t.slice(19,23),16))>>>8,255&e,(e=parseInt(t.slice(24,36),16))/1099511627776&255,e/4294967296&255,e>>>24&255,e>>>16&255,e>>>8&255,255&e)},h=[];for(let t=0;t<256;++t)h.push((t+256).toString(16).slice(1));function l(t,e=0){return(h[t[e+0]]+h[t[e+1]]+h[t[e+2]]+h[t[e+3]]+"-"+h[t[e+4]]+h[t[e+5]]+"-"+h[t[e+6]]+h[t[e+7]]+"-"+h[t[e+8]]+h[t[e+9]]+"-"+h[t[e+10]]+h[t[e+11]]+h[t[e+12]]+h[t[e+13]]+h[t[e+14]]+h[t[e+15]]).toLowerCase()}const c=function(t,e=0){const i=l(t,e);if(!r(i))throw TypeError("Stringified UUID is invalid");return i};let d;const m=new Uint8Array(16);function u(){if(!d){if("undefined"==typeof crypto||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");d=crypto.getRandomValues.bind(crypto)}return d(m)}const p={};function y(t,e,i,s,o,a,r=0){if(t.length<16)throw new Error("Random bytes length must be >= 16");if(a){if(r<0||r+16>a.length)throw new RangeError(`UUID byte range ${r}:${r+15} is out of buffer bounds`)}else a=new Uint8Array(16),r=0;e??=Date.now(),i??=0,s??=16383&(t[8]<<8|t[9]),o??=t.slice(10,16);const n=(1e4*(268435455&(e+=122192928e5))+i)%4294967296;a[r++]=n>>>24&255,a[r++]=n>>>16&255,a[r++]=n>>>8&255,a[r++]=255&n;const h=e/4294967296*1e4&268435455;a[r++]=h>>>8&255,a[r++]=255&h,a[r++]=h>>>24&15|16,a[r++]=h>>>16&255,a[r++]=s>>>8|128,a[r++]=255&s;for(let t=0;t<6;++t)a[r++]=o[t];return a}const g=function(t,e,i){let s;const o=t?._v6??!1;if(t){const e=Object.keys(t);1===e.length&&"_v6"===e[0]&&(t=void 0)}if(t)s=y(t.random??t.rng?.()??u(),t.msecs,t.nsecs,t.clockseq,t.node,e,i);else{const t=Date.now(),a=u();!function(t,e,i){t.msecs??=-1/0,t.nsecs??=0,e===t.msecs?(t.nsecs++,t.nsecs>=1e4&&(t.node=void 0,t.nsecs=0)):e>t.msecs?t.nsecs=0:e<t.msecs&&(t.node=void 0),t.node||(t.node=i.slice(10,16),t.node[0]|=1,t.clockseq=16383&(i[8]<<8|i[9])),t.msecs=e}(p,t,a),s=y(a,p.msecs,p.nsecs,o?void 0:p.clockseq,o?void 0:p.node,e,i)}return e??l(s)};function f(t){const e=function(t){return Uint8Array.of((15&t[6])<<4|t[7]>>4&15,(15&t[7])<<4|(240&t[4])>>4,(15&t[4])<<4|(240&t[5])>>4,(15&t[5])<<4|(240&t[0])>>4,(15&t[0])<<4|(240&t[1])>>4,(15&t[1])<<4|(240&t[2])>>4,96|15&t[2],t[3],t[8],t[9],t[10],t[11],t[12],t[13],t[14],t[15])}("string"==typeof t?n(t):t);return"string"==typeof t?l(e):e}function w(t){return 14+(t+64>>>9<<4)+1}function E(t,e){const i=(65535&t)+(65535&e);return(t>>16)+(e>>16)+(i>>16)<<16|65535&i}function x(t,e,i,s,o,a){return E((r=E(E(e,t),E(s,a)))<<(n=o)|r>>>32-n,i);var r,n}function b(t,e,i,s,o,a,r){return x(e&i|~e&s,t,e,o,a,r)}function T(t,e,i,s,o,a,r){return x(e&s|i&~s,t,e,o,a,r)}function I(t,e,i,s,o,a,r){return x(e^i^s,t,e,o,a,r)}function S(t,e,i,s,o,a,r){return x(i^(e|~s),t,e,o,a,r)}const v=function(t){return function(t){const e=new Uint8Array(4*t.length);for(let i=0;i<4*t.length;i++)e[i]=t[i>>2]>>>i%4*8&255;return e}(function(t,e){const i=new Uint32Array(w(e)).fill(0);i.set(t),i[e>>5]|=128<<e%32,i[i.length-1]=e,t=i;let s=1732584193,o=-271733879,a=-1732584194,r=271733878;for(let e=0;e<t.length;e+=16){const i=s,n=o,h=a,l=r;s=b(s,o,a,r,t[e],7,-680876936),r=b(r,s,o,a,t[e+1],12,-389564586),a=b(a,r,s,o,t[e+2],17,606105819),o=b(o,a,r,s,t[e+3],22,-1044525330),s=b(s,o,a,r,t[e+4],7,-176418897),r=b(r,s,o,a,t[e+5],12,1200080426),a=b(a,r,s,o,t[e+6],17,-1473231341),o=b(o,a,r,s,t[e+7],22,-45705983),s=b(s,o,a,r,t[e+8],7,1770035416),r=b(r,s,o,a,t[e+9],12,-1958414417),a=b(a,r,s,o,t[e+10],17,-42063),o=b(o,a,r,s,t[e+11],22,-1990404162),s=b(s,o,a,r,t[e+12],7,1804603682),r=b(r,s,o,a,t[e+13],12,-40341101),a=b(a,r,s,o,t[e+14],17,-1502002290),o=b(o,a,r,s,t[e+15],22,1236535329),s=T(s,o,a,r,t[e+1],5,-165796510),r=T(r,s,o,a,t[e+6],9,-1069501632),a=T(a,r,s,o,t[e+11],14,643717713),o=T(o,a,r,s,t[e],20,-373897302),s=T(s,o,a,r,t[e+5],5,-701558691),r=T(r,s,o,a,t[e+10],9,38016083),a=T(a,r,s,o,t[e+15],14,-660478335),o=T(o,a,r,s,t[e+4],20,-405537848),s=T(s,o,a,r,t[e+9],5,568446438),r=T(r,s,o,a,t[e+14],9,-1019803690),a=T(a,r,s,o,t[e+3],14,-187363961),o=T(o,a,r,s,t[e+8],20,1163531501),s=T(s,o,a,r,t[e+13],5,-1444681467),r=T(r,s,o,a,t[e+2],9,-51403784),a=T(a,r,s,o,t[e+7],14,1735328473),o=T(o,a,r,s,t[e+12],20,-1926607734),s=I(s,o,a,r,t[e+5],4,-378558),r=I(r,s,o,a,t[e+8],11,-2022574463),a=I(a,r,s,o,t[e+11],16,1839030562),o=I(o,a,r,s,t[e+14],23,-35309556),s=I(s,o,a,r,t[e+1],4,-1530992060),r=I(r,s,o,a,t[e+4],11,1272893353),a=I(a,r,s,o,t[e+7],16,-155497632),o=I(o,a,r,s,t[e+10],23,-1094730640),s=I(s,o,a,r,t[e+13],4,681279174),r=I(r,s,o,a,t[e],11,-358537222),a=I(a,r,s,o,t[e+3],16,-722521979),o=I(o,a,r,s,t[e+6],23,76029189),s=I(s,o,a,r,t[e+9],4,-640364487),r=I(r,s,o,a,t[e+12],11,-421815835),a=I(a,r,s,o,t[e+15],16,530742520),o=I(o,a,r,s,t[e+2],23,-995338651),s=S(s,o,a,r,t[e],6,-198630844),r=S(r,s,o,a,t[e+7],10,1126891415),a=S(a,r,s,o,t[e+14],15,-1416354905),o=S(o,a,r,s,t[e+5],21,-57434055),s=S(s,o,a,r,t[e+12],6,1700485571),r=S(r,s,o,a,t[e+3],10,-1894986606),a=S(a,r,s,o,t[e+10],15,-1051523),o=S(o,a,r,s,t[e+1],21,-2054922799),s=S(s,o,a,r,t[e+8],6,1873313359),r=S(r,s,o,a,t[e+15],10,-30611744),a=S(a,r,s,o,t[e+6],15,-1560198380),o=S(o,a,r,s,t[e+13],21,1309151649),s=S(s,o,a,r,t[e+4],6,-145523070),r=S(r,s,o,a,t[e+11],10,-1120210379),a=S(a,r,s,o,t[e+2],15,718787259),o=S(o,a,r,s,t[e+9],21,-343485551),s=E(s,i),o=E(o,n),a=E(a,h),r=E(r,l)}return Uint32Array.of(s,o,a,r)}(function(t){if(0===t.length)return new Uint32Array;const e=new Uint32Array(w(8*t.length)).fill(0);for(let i=0;i<t.length;i++)e[i>>2]|=(255&t[i])<<i%4*8;return e}(t),8*t.length))},A="6ba7b810-9dad-11d1-80b4-00c04fd430c8",M="6ba7b811-9dad-11d1-80b4-00c04fd430c8";function C(t,e,i,s,o,a){const r="string"==typeof i?function(t){t=unescape(encodeURIComponent(t));const e=new Uint8Array(t.length);for(let i=0;i<t.length;++i)e[i]=t.charCodeAt(i);return e}(i):i,h="string"==typeof s?n(s):s;if("string"==typeof s&&(s=n(s)),16!==s?.length)throw TypeError("Namespace must be array-like (16 iterable integer values, 0-255)");let c=new Uint8Array(16+r.length);if(c.set(h),c.set(r,h.length),c=e(c),c[6]=15&c[6]|t,c[8]=63&c[8]|128,o){a=a||0;for(let t=0;t<16;++t)o[a+t]=c[t];return o}return l(c)}function D(t,e,i,s){return C(48,v,t,e,i,s)}D.DNS=A,D.URL=M;const O=D,_={randomUUID:"undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)},R=function(t,e,i){return!_.randomUUID||e||t?function(t,e,i){const s=(t=t||{}).random??t.rng?.()??u();if(s.length<16)throw new Error("Random bytes length must be >= 16");if(s[6]=15&s[6]|64,s[8]=63&s[8]|128,e){if((i=i||0)<0||i+16>e.length)throw new RangeError(`UUID byte range ${i}:${i+15} is out of buffer bounds`);for(let t=0;t<16;++t)e[i+t]=s[t];return e}return l(s)}(t,e,i):_.randomUUID()};function G(t,e,i,s){switch(t){case 0:return e&i^~e&s;case 1:case 3:return e^i^s;case 2:return e&i^e&s^i&s}}function P(t,e){return t<<e|t>>>32-e}const L=function(t){const e=[1518500249,1859775393,2400959708,3395469782],i=[1732584193,4023233417,2562383102,271733878,3285377520],s=new Uint8Array(t.length+1);s.set(t),s[t.length]=128;const o=(t=s).length/4+2,a=Math.ceil(o/16),r=new Array(a);for(let e=0;e<a;++e){const i=new Uint32Array(16);for(let s=0;s<16;++s)i[s]=t[64*e+4*s]<<24|t[64*e+4*s+1]<<16|t[64*e+4*s+2]<<8|t[64*e+4*s+3];r[e]=i}r[a-1][14]=8*(t.length-1)/Math.pow(2,32),r[a-1][14]=Math.floor(r[a-1][14]),r[a-1][15]=8*(t.length-1)&4294967295;for(let t=0;t<a;++t){const s=new Uint32Array(80);for(let e=0;e<16;++e)s[e]=r[t][e];for(let t=16;t<80;++t)s[t]=P(s[t-3]^s[t-8]^s[t-14]^s[t-16],1);let o=i[0],a=i[1],n=i[2],h=i[3],l=i[4];for(let t=0;t<80;++t){const i=Math.floor(t/20),r=P(o,5)+G(i,a,n,h)+l+e[i]+s[t]>>>0;l=h,h=n,n=P(a,30)>>>0,a=o,o=r}i[0]=i[0]+o>>>0,i[1]=i[1]+a>>>0,i[2]=i[2]+n>>>0,i[3]=i[3]+h>>>0,i[4]=i[4]+l>>>0}return Uint8Array.of(i[0]>>24,i[0]>>16,i[0]>>8,i[0],i[1]>>24,i[1]>>16,i[1]>>8,i[1],i[2]>>24,i[2]>>16,i[2]>>8,i[2],i[3]>>24,i[3]>>16,i[3]>>8,i[3],i[4]>>24,i[4]>>16,i[4]>>8,i[4])};function k(t,e,i,s){return C(80,L,t,e,i,s)}k.DNS=A,k.URL=M;const N=k,Y=function(t,e,i){t??={},i??=0;let s=g({...t,_v6:!0},new Uint8Array(16));if(s=f(s),e){for(let t=0;t<16;t++)e[i+t]=s[t];return e}return l(s)};function B(t){const e=(i="string"==typeof t?n(t):t,Uint8Array.of((15&i[3])<<4|i[4]>>4&15,(15&i[4])<<4|(240&i[5])>>4,(15&i[5])<<4|15&i[6],i[7],(15&i[1])<<4|(240&i[2])>>4,(15&i[2])<<4|(240&i[3])>>4,16|(240&i[0])>>4,(15&i[0])<<4|(240&i[1])>>4,i[8],i[9],i[10],i[11],i[12],i[13],i[14],i[15]));var i;return"string"==typeof t?l(e):e}const H={};function X(t,e,i,s,o=0){if(t.length<16)throw new Error("Random bytes length must be >= 16");if(s){if(o<0||o+16>s.length)throw new RangeError(`UUID byte range ${o}:${o+15} is out of buffer bounds`)}else s=new Uint8Array(16),o=0;return e??=Date.now(),i??=127*t[6]<<24|t[7]<<16|t[8]<<8|t[9],s[o++]=e/1099511627776&255,s[o++]=e/4294967296&255,s[o++]=e/16777216&255,s[o++]=e/65536&255,s[o++]=e/256&255,s[o++]=255&e,s[o++]=112|i>>>28&15,s[o++]=i>>>20&255,s[o++]=128|i>>>14&63,s[o++]=i>>>6&255,s[o++]=i<<2&255|3&t[10],s[o++]=t[11],s[o++]=t[12],s[o++]=t[13],s[o++]=t[14],s[o++]=t[15],s}const F=function(t,e,i){let s;if(t)s=X(t.random??t.rng?.()??u(),t.msecs,t.seq,e,i);else{const t=Date.now(),o=u();!function(t,e,i){t.msecs??=-1/0,t.seq??=0,e>t.msecs?(t.seq=i[6]<<23|i[7]<<16|i[8]<<8|i[9],t.msecs=e):(t.seq=t.seq+1|0,0===t.seq&&t.msecs++)}(H,t,o),s=X(o,H.msecs,H.seq,e,i)}return e??l(s)},W=function(t){if(!r(t))throw TypeError("Invalid UUID");return parseInt(t.slice(14,15),16)}},6001:(t,e,i)=>{"use strict";t.exports=i.p+"assets/mobset.129c664bdc0df72912de.png"},6083:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.SpawnFloor=void 0;const s=i(7851),o=i(8132),a=i(9467);class r extends o.Tile{constructor(t,e,i){super(t,e,i),this.draw=t=>{s.Game.drawTile(this.variation,this.skin,1,1,this.x,this.y,1,1,this.room.shadeColor,this.shadeAmount())},this.variation=1,this.skin==o.SkinType.DUNGEON&&(this.variation=s.Game.randTable([1,1,1,1,1,1,8,8,8,9,10,10,10,10,10,12],a.Random.rand)),this.skin==o.SkinType.CAVE&&(this.variation=s.Game.randTable([1,1,1,1,1,1,8,8,8,9,10,10,10,10,10,12],a.Random.rand))}}e.SpawnFloor=r},6084:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.WallTorch=void 0;const s=i(7851),o=i(2103),a=i(1285),r=i(9200),n=i(9467);class h extends r.Wall{constructor(t,e,i,r){super(t,e,i),this.isSolid=()=>!0,this.canCrushEnemy=()=>!0,this.isOpaque=()=>{const t=this.room.wallInfo.get(`${this.x},${this.y}`);return!t||!t.isTopWall&&!t.isInnerWall||t.isLeftWall||t.isRightWall},this.draw=t=>{this.drawWall(t);const e=this.room.wallInfo.get(`${this.x},${this.y}`);e||(this.tileYOffset=6),this.frame+=.3*t,this.frame>=12&&(this.frame=0),this.tileYOffset="bottomInner"===e?.innerWallType||"surroundedInner"===e?.innerWallType?0:6,this.isBottomWall||s.Game.drawTile(0,this.skin,1,1,this.x,this.y,1,1,this.room.shadeColor,this.shadeAmount()),s.Game.drawFX(Math.floor(this.frame),32,1,2,this.x,this.y-1-this.torchOffset,1,2),this.isBottomWall&&s.Game.drawTile(0,this.skin,1,1,this.x,this.y-.6,1,1,this.room.shadeColor,1)},this.isBottomWall=r,this.torchOffset=r?1:0,this.lightSource=new o.LightSource(this.x+.5,this.y+.5-this.torchOffset,5,a.LevelConstants.TORCH_LIGHT_COLOR,1.5),this.room.lightSources.push(this.lightSource),this.frame=12*n.Random.rand(),this.tileYOffset=6,this.hasBloom=!0,this.bloomColor="#FFA500",this.bloomAlpha=1,this.softBloomAlpha=0,this.bloomOffsetY=this.torchOffset}}e.WallTorch=h},6094:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Dagger=void 0;const s=i(4052);class o extends s.Weapon{constructor(t,e,i){super(t,e,i),this.weaponMove=(t,e)=>!!this.checkForPushables(t,e)||!this.executeAttack(t,e,!0,this.damage+this.wielder.damageBonus),this.degrade=()=>{},this.tileX=22,this.tileY=0,this.name="dagger",this.description="A basic but dependable weapon."}}e.Dagger=o,o.itemName="dagger"},6105:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.DivingHelmet=void 0;const s=i(8549);class o extends s.Equippable{constructor(t,e,i){super(t,e,i),this.getDescription=()=>`DIVING HELMET\nStores ${this.maxAir} turns of air for underwater travel.`,this.onEquip=()=>{this.refreshLighting(),this.wielder?.getOxygenLine?.().onHelmetEquipped()},this.onUnequip=()=>{this.refreshLighting(),this.wielder?.getOxygenLine?.().onHelmetUnequipped()},this.coEquippable=t=>!(t instanceof o),this.hasAir=()=>this.currentAir>0,this.consumeAir=(t=this.airDrainPerTurn)=>!!this.hasAir()&&(this.currentAir=this.currentAir-t,this.currentAir<=0&&(this.currentAir=0,this.level.game.pushMessage("Your diving helmet runs out of air!")),this.hasAir()),this.restoreAir=t=>{if(t<=0)return;const e=this.currentAir;this.currentAir=Math.min(this.maxAir,this.currentAir+t),0===e&&this.currentAir>0&&this.level.game.pushMessage("The diving helmet refills with air.")},this.refillCompletely=()=>{this.currentAir=this.maxAir},this.tickInInventory=()=>{},this.refreshLighting=()=>{try{const t=this.wielder?.getRoom?.()??this.wielder?.game?.rooms?.[this.wielder?.levelID];t?.updateLighting?.()}catch{}},this.tileX=4,this.tileY=2,this.name=o.itemName,this.degradeable=!1,this.iconOffset=.1,this.maxAir=100,this._air=this.maxAir,this.airDrainPerTurn=1}get currentAir(){return this._air}set currentAir(t){this._air=Math.min(Math.max(t,0),this.maxAir)}}e.DivingHelmet=o,o.itemName="diving helmet"},6116:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.LevelImageGenerator=void 0;const s=i(7851),o=i(6199),a=i(9467);class r{constructor(t=100,e=100){this.rooms=[],this.settled=!1,this.width=t,this.height=e,this.canvas=document.createElement("canvas"),this.canvas.width=t,this.canvas.height=e,this.ctx=this.canvas.getContext("2d"),this.ctx.imageSmoothingEnabled=!1,this.ctx.webkitImageSmoothingEnabled=!1,this.ctx.mozImageSmoothingEnabled=!1,this.ctx.msImageSmoothingEnabled=!1}generateRoomSize(){return{width:Math.max(2,Math.min(25,o.Utils.randomNormalInt(2,25,{median:6}))),height:Math.max(2,Math.min(25,o.Utils.randomNormalInt(2,25,{median:6})))}}calculateMass(t,e){return t*e*.1}generateRooms(t,e=a.Random.rand,i="center"){this.rooms=[],this.settled=!1;for(let s=0;s<t;s++){const{width:o,height:a}=this.generateRoomSize(),r=this.calculateMass(o,a);let n,h;switch(i){case"split":s<t/2?(n=.6*this.width+e()*this.width*.3,h=.1*this.height+e()*this.height*.3):(n=.1*this.width+e()*this.width*.3,h=.6*this.height+e()*this.height*.3);break;case"corners":switch(Math.floor(4*e())){case 0:n=.1*this.width+e()*this.width*.2,h=.1*this.height+e()*this.height*.2;break;case 1:n=.7*this.width+e()*this.width*.2,h=.1*this.height+e()*this.height*.2;break;case 2:n=.1*this.width+e()*this.width*.2,h=.7*this.height+e()*this.height*.2;break;case 3:n=.7*this.width+e()*this.width*.2,h=.7*this.height+e()*this.height*.2}break;default:n=.3*this.width+e()*this.width*.4,h=.3*this.height+e()*this.height*.4}this.rooms.push({x:n,y:h,width:o,height:a,vx:0,vy:0,mass:r,id:s})}}roomsCollide(t,e){return!(t.x+t.width+1<=e.x||e.x+e.width+1<=t.x||t.y+t.height+1<=e.y||e.y+e.height+1<=t.y)}shouldSnap(t,e){const i=Math.min(Math.abs(t.x+t.width+1-e.x),Math.abs(e.x+e.width+1-t.x)),s=Math.min(Math.abs(t.y+t.height+1-e.y),Math.abs(e.y+e.height+1-t.y)),o=!(t.x+t.width<e.x||e.x+e.width<t.x),a=!(t.y+t.height<e.y||e.y+e.height<t.y);return i<3&&a||s<3&&o}snapRooms(t,e){const i=!(t.x+t.width<e.x||e.x+e.width<t.x),s=!(t.y+t.height<e.y||e.y+e.height<t.y);if(i)if(t.y<e.y){const i=t.y+t.height+1;e.y=i,e.vy=0,t.vy=0}else{const i=e.y+e.height+1;t.y=i,t.vy=0,e.vy=0}else if(s)if(t.x<e.x){const i=t.x+t.width+1;e.x=i,e.vx=0,t.vx=0}else{const i=e.x+e.width+1;t.x=i,t.vx=0,e.vx=0}}resolveCollision(t,e){const i=Math.min(t.x+t.width+1-e.x,e.x+e.width+1-t.x),s=Math.min(t.y+t.height+1-e.y,e.y+e.height+1-t.y);if(i<s){const s=t.x<e.x?-1:1,o=t.mass+e.mass,a=i/2;t.x+=s*a*(e.mass/o),e.x-=s*a*(t.mass/o),t.vx+=.1*s*(e.mass/o),e.vx-=.1*s*(t.mass/o)}else{const i=t.y<e.y?-1:1,o=t.mass+e.mass,a=s/2;t.y+=i*a*(e.mass/o),e.y-=i*a*(t.mass/o),t.vy+=.1*i*(e.mass/o),e.vy-=.1*i*(t.mass/o)}}simulatePhysics(t=1e3){for(let e=0;e<t;e++){let t=!1;for(let e=0;e<this.rooms.length;e++)for(let i=e+1;i<this.rooms.length;i++)this.roomsCollide(this.rooms[e],this.rooms[i])&&(this.resolveCollision(this.rooms[e],this.rooms[i]),t=!0);for(let t=0;t<this.rooms.length;t++)for(let e=t+1;e<this.rooms.length;e++)this.shouldSnap(this.rooms[t],this.rooms[e])&&this.snapRooms(this.rooms[t],this.rooms[e]);for(const e of this.rooms)e.x+=e.vx,e.y+=e.vy,e.vx*=.95,e.vy*=.95,e.x=Math.max(1,Math.min(this.width-e.width-1,e.x)),e.y=Math.max(1,Math.min(this.height-e.height-1,e.y)),(Math.abs(e.vx)>.01||Math.abs(e.vy)>.01)&&(t=!0);if(!t){console.log(`Physics settled after ${e} iterations`);break}}for(const t of this.rooms)t.x=Math.round(t.x),t.y=Math.round(t.y);this.settled=!0}generatePNG(){this.ctx.clearRect(0,0,this.width,this.height),this.ctx.imageSmoothingEnabled=!1,this.ctx.fillStyle="white";for(const t of this.rooms)this.ctx.fillRect(Math.floor(t.x),Math.floor(t.y),t.width,t.height);return this.canvas}savePNG(t){const e=this.generatePNG(),i=(new Date).toISOString().replace(/[:.]/g,"-"),s=t||`level_${i}.png`,o=document.createElement("a");o.download=`generated_levels/${s}`,o.href=e.toDataURL("image/png"),document.body.appendChild(o),o.click(),document.body.removeChild(o),console.log(`Generated level PNG (${this.width}x${this.height}):`,o.href),console.log(`Suggested save path: generated_levels/${s}`)}draw(t=0,e=0,i=2){if(s.Game.ctx){s.Game.ctx.save(),s.Game.ctx.imageSmoothingEnabled=!1,s.Game.ctx.webkitImageSmoothingEnabled=!1,s.Game.ctx.mozImageSmoothingEnabled=!1,s.Game.ctx.msImageSmoothingEnabled=!1,s.Game.ctx.fillStyle="rgba(0, 0, 0, 0.8)",s.Game.ctx.fillRect(t,e,this.width*i,this.height*i),s.Game.ctx.strokeStyle="rgba(100, 100, 100, 0.3)",s.Game.ctx.lineWidth=1;for(let o=0;o<=this.width;o+=10)s.Game.ctx.beginPath(),s.Game.ctx.moveTo(t+o*i,e),s.Game.ctx.lineTo(t+o*i,e+this.height*i),s.Game.ctx.stroke();for(let o=0;o<=this.height;o+=10)s.Game.ctx.beginPath(),s.Game.ctx.moveTo(t,e+o*i),s.Game.ctx.lineTo(t+this.width*i,e+o*i),s.Game.ctx.stroke();for(const o of this.rooms){const a=o.width/o.height;let r;r=a>1.5?200+30*o.id%60:a<.67?0+30*o.id%60:100+30*o.id%60,s.Game.ctx.fillStyle=`hsl(${r}, 70%, 60%)`,s.Game.ctx.fillRect(t+Math.floor(o.x)*i,e+Math.floor(o.y)*i,o.width*i,o.height*i),s.Game.ctx.strokeStyle="white",s.Game.ctx.lineWidth=1,s.Game.ctx.strokeRect(t+Math.floor(o.x)*i,e+Math.floor(o.y)*i,o.width*i,o.height*i),i>=2&&(s.Game.ctx.fillStyle="white",s.Game.ctx.font="10px monospace",s.Game.ctx.textAlign="center",s.Game.ctx.fillText(`${o.id}`,t+(o.x+o.width/2)*i,e+(o.y+o.height/2)*i-2),i>=3&&(s.Game.ctx.font="8px monospace",s.Game.ctx.fillText(`${o.width}${o.height}`,t+(o.x+o.width/2)*i,e+(o.y+o.height/2)*i+8)))}s.Game.ctx.restore()}}static generateRandomLevel(t=80,e=60,i=15,s=a.Random.rand,o="center"){const n=new r(t,e);return n.generateRooms(i,s,o),n.simulatePhysics(),n}getRooms(){return[...this.rooms]}areRoomsAccessible(){if(0===this.rooms.length)return!0;if(1===this.rooms.length)return!0;const t=new Set,e=[0];for(t.add(0);e.length>0;){const i=e.shift(),s=this.rooms[i];for(let i=0;i<this.rooms.length;i++){if(t.has(i))continue;const o=this.rooms[i],a=Math.abs(s.x+s.width+1-o.x)<1||Math.abs(o.x+o.width+1-s.x)<1,r=Math.abs(s.y+s.height+1-o.y)<1||Math.abs(o.y+o.height+1-s.y)<1,n=!(s.x+s.width<o.x||o.x+o.width<s.x),h=!(s.y+s.height<o.y||o.y+o.height<s.y);(a&&h||r&&n)&&(t.add(i),e.push(i))}}return t.size===this.rooms.length}}e.LevelImageGenerator=r},6199:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Utils=void 0;const s=i(7851),o=i(9467);class a{}e.Utils=a,a.distance=(t,e,i,s)=>Math.sqrt((i-t)**2+(s-e)**2),a.calculateExponentialFalloff=(t,e)=>Math.exp(-e*t),a.hsvToHex=(t,e,i)=>{let s=i*e,o=s*(1-Math.abs(t/60%2-1)),r=i-s,n=0,h=0,l=0;t>=0&&t<60?(n=s,h=o,l=0):t>=60&&t<120?(n=o,h=s,l=0):t>=120&&t<180?(n=0,h=s,l=o):t>=180&&t<240?(n=0,h=o,l=s):t>=240&&t<300?(n=o,h=0,l=s):(n=s,h=0,l=o);const c=Math.round(255*(n+r)),d=Math.round(255*(h+r)),m=Math.round(255*(l+r));return a.rgbToHex(c,d,m)},a.rgbToHex=(t,e,i)=>{const s=t=>{const e=t.toString(16);return 1===e.length?"0"+e:e};return`#${s(t)}${s(e)}${s(i)}`},a.randomSineInt=(t,e,i={})=>{const s=Math.ceil(e),a=Math.floor(t),r=s-a+1,{median:n=a+(r-1)/2}=i,h=Math.min(Math.max(n,a),s),l=2*o.Random.rand()*Math.PI,c=2*o.Random.rand()*Math.PI,d=(Math.cos(l)+Math.cos(c)+2)/4,m=(h-a)/(r-1),u=d*(1-.7)+.7*(d<.5?d*(m/.5):m+2*(d-.5)*(1-m)),p=Math.min(Math.max(u,.001),.999),y=Math.floor(p*r)+a;return Math.min(Math.max(y,a),s)},a.randTableWeighted=t=>{if(!t||0===t.length)return null;if(!t.some(t=>t&&"number"==typeof t.weight))return t[s.Game.rand(0,t.length-1,o.Random.rand)];const e=t.reduce((t,e)=>t+(e&&"number"==typeof e.weight?e.weight:0),0);if(e<=0)return t[s.Game.rand(0,t.length-1,o.Random.rand)];let i=o.Random.rand()*e;for(const e of t)if(e&&"number"==typeof e.weight&&(i-=e.weight,i<=0))return e;return t[t.length-1]},a.randomNormalInt=(t,e,i={})=>{const{median:s=t+(e-t)/2}=i,a=(e-t)/5;let r=o.Random.rand(),n=o.Random.rand();for(;0===r;)r=o.Random.rand();const h=Math.sqrt(-2*Math.log(r))*Math.cos(2*Math.PI*n)*a+s,l=Math.max(0,h);return Math.round(l)}},6277:(t,e)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.EVENTS=void 0,e.EVENTS={KEY_DOWN:"KEY_DOWN",KEY_UP:"KEY_UP",MOUSE_LEFT_CLICK:"MOUSE_LEFT_CLICK",MOUSE_RIGHT_CLICK:"MOUSE_RIGHT_CLICK",MOUSE_MOVE:"MOUSE_MOVE",TOUCH_START:"TOUCH_START",TOUCH_MOVE:"TOUCH_MOVE",TOUCH_END:"TOUCH_END",TAP:"TAP",TAP_HOLD:"TAP_HOLD",MOUSE_DOWN:"MOUSE_DOWN",MOUSE_UP:"MOUSE_UP",CHAT_MESSAGE:"ChatMessage",ENEMY_SEEN_PLAYER:"EnemySeenPlayer",ENEMY_KILLED:"ENEMY_KILLED",DAMAGE_DONE:"DAMAGE_DONE",DAMAGE_TAKEN:"DAMAGE_TAKEN",TURN_PASSED:"TURN_PASSED",COIN_COLLECTED:"COIN_COLLECTED",ITEM_COLLECTED:"ITEM_COLLECTED",LEVEL_GENERATION_STARTED:"LEVEL_GENERATION_STARTED",LEVEL_GENERATION_COMPLETED:"LEVEL_GENERATION_COMPLETED"}},6291:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.GameConstants=void 0;const s=i(2270),o=i(783),a=i(8149),r=i(1199),n=i(7418),h=i(66),l=i(5196),c=i(9406),d=i(1285),m=i(6094),u=i(8243),p=i(3785),y=i(1444),g=i(4182),f=i(521),w=i(1470),E=i(5614),x=i(9915),b=i(2176),T=i(6635),I=i(2351),S=i(4937),v=i(1236),A=i(2694),M=i(5816),C=i(2321),D=i(4478),O=i(8991),_=i(2953),R=i(6105);class G{static get SHADE_ENABLED(){return G.SMOOTH_LIGHTING}}e.GameConstants=G,G.VERSION="Alpha v0.3.1",G.DEVELOPER_MODE=!1,G.isMobile=!1,G.isIOS=!1,G.MOBILE_KEYBOARD_SUPPORT=!1,G.CAMERA_SPEED=1,G.SAVING_ENABLED=!1,G.FPS=120,G.ALPHA_ENABLED=!0,G.SHADE_LEVELS=50,G.ENTITY_SHADE_LEVELS=40,G.TILESIZE=16,G.SCALE=null,G.SOFT_SCALE=6,G.MAX_SCALE=16,G.MIN_SCALE=1,G.smoothScaling=!1,G.SWIPE_THRESH=625,G.HOLD_THRESH=250,G.KEY_REPEAT_TIME=250,G.SWIPE_HOLD_REPEAT_TIME=200,G.SWIPE_HOLD_INITIAL_DELAY=10,G.MOVEMENT_COOLDOWN=50,G.MOVEMENT_QUEUE_COOLDOWN=25,G.MOVE_WITH_MOUSE=!0,G.SLOW_INPUTS_NEAR_ENEMIES=!1,G.SCREEN_SHAKE_ENABLED=!0,G.CHAT_APPEAR_TIME=1e3,G.CHAT_FADE_TIME=2e3,G.ALERT_HOLD_TIME=1e3,G.ALERT_FADE_TIME=600,G.ALERT_MAX_WIDTH_RATIO=.8,G.ALERT_TEXT_COLOR="white",G.ALERT_OUTLINE_COLOR="black",G.ALERT_REPLACE_FLOAT_TIME=600,G.ALERT_REPLACE_FLOAT_PX=12,G.POINTER_MAX_WIDTH_RATIO=.6,G.POINTER_TEXT_COLOR="white",G.POINTER_OUTLINE_COLOR="black",G.POINTER_ARROW_COLOR="white",G.POINTER_ARROW_SIZE=4,G.POINTER_BOB_PX=1,G.POINTER_BOB_PERIOD_MS=1200,G.POINTER_FADE_TIME=500,G.ANIMATION_SPEED=1,G.REPLAY_STEP_MS=10,G.REPLAY_COMPUTER_TURN_DELAY=10,G.REPLAY_DEBUG=!1,G.DEFAULTWIDTH=G.TILESIZE,G.DEFAULTHEIGHT=G.TILESIZE,G.WIDTH=d.LevelConstants.SCREEN_W*G.TILESIZE,G.HEIGHT=d.LevelConstants.SCREEN_H*G.TILESIZE,G.drawOtherRooms=!0,G.SCRIPT_FONT_SIZE=16,G.FONT_SIZE=7,G.BIG_FONT_SIZE=15,G.RED="#ac3232",G.WARNING_RED="#ff0000",G.GREEN="#6abe30",G.ARMOR_GREY="#9badb7",G.OUTLINE="#222034",G.HIT_ENEMY_TEXT_COLOR="#76428a",G.HEALTH_BUFF_COLOR="#d77bba",G.MISS_COLOR="#639bff",G.XP_POPUP_ENABLED=!0,G.OUTLINE_SHIELD_COLOR="#7642ff",G.OUTLINE_BUFF_COLOR="cyan",G.PLAYER_SHIELD_COLOR="#5b6ee1",G.PLAYER_DAMAGE_BUFF_COLOR="#ff0000",G.MAP_ENABLED=!0,G.COIN_ANIMATION=!0,G.COIN_AUTO_PICKUP=!0,G.ITEM_AUTO_PICKUP=!0,G.AUTO_PICKUP_ITEMS=[r.Coal,b.GoldOre,M.IronOre,w.RedGem,f.BlueGem,E.GreenGem,I.OrangeGem,v.Coin,A.Fish],G.PERSISTENT_HEALTH_BAR=!1,G.HOVER_TEXT_ENABLED=!0,G.INVENTORY_HOVER_TEXT_ENABLED=!0,G.IN_GAME_HOVER_TEXT_ENABLED=!1,G.VENDING_MACHINE_HOVER_TEXT_ENABLED=!0,G.HOVER_TEXT_FOLLOWS_MOUSE=!0,G.INVENTORY_HOVER_TEXT_FOLLOWS_MOUSE=!0,G.IN_GAME_HOVER_TEXT_FOLLOWS_MOUSE=!0,G.VENDING_MACHINE_HOVER_TEXT_FOLLOWS_MOUSE=!0,G.NARROWED_LIGHTING_FOV=!0,G.DEFAULT_LIGHTING_FOV_DEGREES=360,G.UNDERWATER_LIGHTING_FOV_DEGREES=120,G.CUSTOM_SHADER_COLOR_ENABLED=!1,G.COLOR_LAYER_COMPOSITE_OPERATION="soft-light",G.SHADE_LAYER_COMPOSITE_OPERATION="source-over",G.SHADE_INLINE_IN_ENTITY_LAYER=!0,G.USE_OPTIMIZED_SHADING=!1,G.SMOOTH_LIGHTING=!0,G.ctxBlurEnabled=!0,G.BLUR_ENABLED=!0,G.USE_WEBGL_BLUR=!1,G.USE_WEBGL_WATER_OVERLAY=!0,G.HIGH_QUALITY_BLUR=!1,G.BLUR_DOWNSAMPLE_FACTOR=8,G.ENEMIES_BLOCK_LIGHT=!0,G.SHADING_DISABLED=!1,G.USE_PNG_LEVELS=!0,G.SHADE_LAYER_COMPOSITE_OPERATIONS=["source-over","screen","multiply","overlay","darken","lighten"],G.COLOR_LAYER_COMPOSITE_OPERATIONS=["soft-light","overlay","multiply"],G.SET_COLOR_LAYER_COMPOSITE_OPERATION=(t=!1)=>{const e=G.COLOR_LAYER_COMPOSITE_OPERATIONS.indexOf(G.COLOR_LAYER_COMPOSITE_OPERATION);let i;i=t?(e-1+G.COLOR_LAYER_COMPOSITE_OPERATIONS.length)%G.COLOR_LAYER_COMPOSITE_OPERATIONS.length:(e+1)%G.COLOR_LAYER_COMPOSITE_OPERATIONS.length,G.COLOR_LAYER_COMPOSITE_OPERATION=G.COLOR_LAYER_COMPOSITE_OPERATIONS[i],console.log(`Color layer composite operation set to ${G.COLOR_LAYER_COMPOSITE_OPERATION}`)},G.SET_SHADE_LAYER_COMPOSITE_OPERATION=(t=!1)=>{const e=G.SHADE_LAYER_COMPOSITE_OPERATIONS.indexOf(G.SHADE_LAYER_COMPOSITE_OPERATION);let i;i=t?(e-1+G.SHADE_LAYER_COMPOSITE_OPERATIONS.length)%G.SHADE_LAYER_COMPOSITE_OPERATIONS.length:(e+1)%G.SHADE_LAYER_COMPOSITE_OPERATIONS.length,G.SHADE_LAYER_COMPOSITE_OPERATION=G.SHADE_LAYER_COMPOSITE_OPERATIONS[i],console.log(`Shade layer composite operation set to ${G.SHADE_LAYER_COMPOSITE_OPERATION}`)},G.TOGGLE_USE_OPTIMIZED_SHADING=()=>{G.USE_OPTIMIZED_SHADING=!G.USE_OPTIMIZED_SHADING},G.TOGGLE_ENEMIES_BLOCK_LIGHT=()=>{G.ENEMIES_BLOCK_LIGHT=!G.ENEMIES_BLOCK_LIGHT},G.TOGGLE_NARROWED_LIGHTING_FOV=()=>{G.NARROWED_LIGHTING_FOV=!G.NARROWED_LIGHTING_FOV,console.log("Narrowed lighting FoV is now "+(G.NARROWED_LIGHTING_FOV?"enabled":"disabled"))},G.TOGGLE_USE_WEBGL_BLUR=()=>{G.USE_WEBGL_BLUR=!G.USE_WEBGL_BLUR,console.log("WebGL blur is now "+(G.USE_WEBGL_BLUR?"enabled":"disabled"))},G.TOGGLE_WEBGL_WATER_OVERLAY=()=>{G.USE_WEBGL_WATER_OVERLAY=!G.USE_WEBGL_WATER_OVERLAY,console.log("WebGL water overlay is now "+(G.USE_WEBGL_WATER_OVERLAY?"enabled":"disabled"))},G.TOGGLE_HIGH_QUALITY_BLUR=()=>{G.HIGH_QUALITY_BLUR=!G.HIGH_QUALITY_BLUR,console.log("High quality blur: "+(G.HIGH_QUALITY_BLUR?"ON (49 samples)":"OFF (13 samples)"))},G.SET_SCALE=()=>{G.SCALE++,G.SCALE>G.MAX_SCALE&&(G.SCALE=G.MAX_SCALE)},G.INCREASE_SCALE=()=>{G.SCALE<G.MAX_SCALE&&(G.SCALE++,G.SCALE>G.MAX_SCALE&&(G.SCALE=G.MAX_SCALE))},G.DECREASE_SCALE=()=>{G.SCALE>G.MIN_SCALE&&(G.SCALE--,G.SCALE<G.MIN_SCALE&&(G.SCALE=G.MIN_SCALE))},G.FIND_SCALE=t=>{let e=G.MIN_SCALE,i=1/0;const s=(t&&"landscape-primary"!==screen.orientation.type?window.innerWidth:window.innerHeight)*window.devicePixelRatio,o=t?8:12;for(let t=G.MIN_SCALE;t<=G.MAX_SCALE;t++){const a=s/(t*G.TILESIZE),r=Math.abs(a-o);r<i&&(i=r,e=t)}return e},G.STARTING_INVENTORY=[m.Dagger,a.Candle],G.STARTING_DEV_INVENTORY=[m.Dagger,l.Torch,T.Sword,_.GlowStick,n.GodStone,p.Spellbook,S.FishingRod,s.Armor,o.Backpack,y.Hammer,p.Spellbook,D.WoodenShield,f.BlueGem,I.OrangeGem,w.RedGem,C.GarnetRing,O.CrossbowBolt,u.Spear,x.Pickaxe,h.Lantern,R.DivingHelmet,c.WeaponBlood,r.Coal,r.Coal,r.Coal,r.Coal,r.Coal,r.Coal,r.Coal,r.Coal,r.Coal,r.Coal,g.BombItem,M.IronOre,b.GoldOre,b.GoldOre,b.GoldOre,b.GoldOre,b.GoldOre,b.GoldOre,b.GoldOre]},6321:(t,e,i)=>{"use strict";t.exports=i.p+"assets/fxset.3344df30b97066f66689.png"},6392:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.DarkVase=void 0;const s=i(606),o=i(7851),a=i(606),r=i(9467),n=i(7366);class h extends s.Entity{constructor(t,e,i,s){super(t,e,i,s),this.draw=t=>{this.dead||(o.Game.ctx.save(),o.Game.ctx.globalAlpha=this.alpha,this.dead||(this.hasShadow&&this.drawShadow(t),this.updateDrawXY(t),o.Game.drawObj(this.tileX,this.tileY,1,2,this.x-this.drawX,this.y-this.drawYOffset-this.drawY,1,2,this.room.shadeColor,this.shadeAmount())),o.Game.ctx.restore())},this.drawTopLayer=t=>{this.drawableY=this.y},this.room=t,this.health=1,this.tileX=9,this.tileY=6,this.hasShadow=!0,this.chainPushable=!1,this.name="dark vase",this.hitSound=n.Sound.potSmash,this.imageParticleX=0,this.imageParticleY=29,r.Random.rand()}get type(){return a.EntityType.PROP}}e.DarkVase=h},6425:(t,e,i)=>{"use strict";function s(t,e){return function(){return t.apply(e,arguments)}}const{toString:o}=Object.prototype,{getPrototypeOf:a}=Object,{iterator:r,toStringTag:n}=Symbol,h=(l=Object.create(null),t=>{const e=o.call(t);return l[e]||(l[e]=e.slice(8,-1).toLowerCase())});var l;const c=t=>(t=t.toLowerCase(),e=>h(e)===t),d=t=>e=>typeof e===t,{isArray:m}=Array,u=d("undefined");function p(t){return null!==t&&!u(t)&&null!==t.constructor&&!u(t.constructor)&&f(t.constructor.isBuffer)&&t.constructor.isBuffer(t)}const y=c("ArrayBuffer"),g=d("string"),f=d("function"),w=d("number"),E=t=>null!==t&&"object"==typeof t,x=t=>{if("object"!==h(t))return!1;const e=a(t);return!(null!==e&&e!==Object.prototype&&null!==Object.getPrototypeOf(e)||n in t||r in t)},b=c("Date"),T=c("File"),I=c("Blob"),S=c("FileList"),v=c("URLSearchParams"),[A,M,C,D]=["ReadableStream","Request","Response","Headers"].map(c);function O(t,e,{allOwnKeys:i=!1}={}){if(null==t)return;let s,o;if("object"!=typeof t&&(t=[t]),m(t))for(s=0,o=t.length;s<o;s++)e.call(null,t[s],s,t);else{if(p(t))return;const o=i?Object.getOwnPropertyNames(t):Object.keys(t),a=o.length;let r;for(s=0;s<a;s++)r=o[s],e.call(null,t[r],r,t)}}function _(t,e){if(p(t))return null;e=e.toLowerCase();const i=Object.keys(t);let s,o=i.length;for(;o-- >0;)if(s=i[o],e===s.toLowerCase())return s;return null}const R="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:"undefined"!=typeof window?window:i.g,G=t=>!u(t)&&t!==R,P=(L="undefined"!=typeof Uint8Array&&a(Uint8Array),t=>L&&t instanceof L);var L;const k=c("HTMLFormElement"),N=(({hasOwnProperty:t})=>(e,i)=>t.call(e,i))(Object.prototype),Y=c("RegExp"),B=(t,e)=>{const i=Object.getOwnPropertyDescriptors(t),s={};O(i,(i,o)=>{let a;!1!==(a=e(i,o,t))&&(s[o]=a||i)}),Object.defineProperties(t,s)},H=c("AsyncFunction"),X=(F="function"==typeof setImmediate,W=f(R.postMessage),F?setImmediate:W?(U=`axios@${Math.random()}`,j=[],R.addEventListener("message",({source:t,data:e})=>{t===R&&e===U&&j.length&&j.shift()()},!1),t=>{j.push(t),R.postMessage(U,"*")}):t=>setTimeout(t));var F,W,U,j;const V="undefined"!=typeof queueMicrotask?queueMicrotask.bind(R):"undefined"!=typeof process&&process.nextTick||X;var z={isArray:m,isArrayBuffer:y,isBuffer:p,isFormData:t=>{let e;return t&&("function"==typeof FormData&&t instanceof FormData||f(t.append)&&("formdata"===(e=h(t))||"object"===e&&f(t.toString)&&"[object FormData]"===t.toString()))},isArrayBufferView:function(t){let e;return e="undefined"!=typeof ArrayBuffer&&ArrayBuffer.isView?ArrayBuffer.isView(t):t&&t.buffer&&y(t.buffer),e},isString:g,isNumber:w,isBoolean:t=>!0===t||!1===t,isObject:E,isPlainObject:x,isEmptyObject:t=>{if(!E(t)||p(t))return!1;try{return 0===Object.keys(t).length&&Object.getPrototypeOf(t)===Object.prototype}catch(t){return!1}},isReadableStream:A,isRequest:M,isResponse:C,isHeaders:D,isUndefined:u,isDate:b,isFile:T,isBlob:I,isRegExp:Y,isFunction:f,isStream:t=>E(t)&&f(t.pipe),isURLSearchParams:v,isTypedArray:P,isFileList:S,forEach:O,merge:function t(){const{caseless:e,skipUndefined:i}=G(this)&&this||{},s={},o=(o,a)=>{const r=e&&_(s,a)||a;x(s[r])&&x(o)?s[r]=t(s[r],o):x(o)?s[r]=t({},o):m(o)?s[r]=o.slice():i&&u(o)||(s[r]=o)};for(let t=0,e=arguments.length;t<e;t++)arguments[t]&&O(arguments[t],o);return s},extend:(t,e,i,{allOwnKeys:o}={})=>(O(e,(e,o)=>{i&&f(e)?t[o]=s(e,i):t[o]=e},{allOwnKeys:o}),t),trim:t=>t.trim?t.trim():t.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,""),stripBOM:t=>(65279===t.charCodeAt(0)&&(t=t.slice(1)),t),inherits:(t,e,i,s)=>{t.prototype=Object.create(e.prototype,s),t.prototype.constructor=t,Object.defineProperty(t,"super",{value:e.prototype}),i&&Object.assign(t.prototype,i)},toFlatObject:(t,e,i,s)=>{let o,r,n;const h={};if(e=e||{},null==t)return e;do{for(o=Object.getOwnPropertyNames(t),r=o.length;r-- >0;)n=o[r],s&&!s(n,t,e)||h[n]||(e[n]=t[n],h[n]=!0);t=!1!==i&&a(t)}while(t&&(!i||i(t,e))&&t!==Object.prototype);return e},kindOf:h,kindOfTest:c,endsWith:(t,e,i)=>{t=String(t),(void 0===i||i>t.length)&&(i=t.length),i-=e.length;const s=t.indexOf(e,i);return-1!==s&&s===i},toArray:t=>{if(!t)return null;if(m(t))return t;let e=t.length;if(!w(e))return null;const i=new Array(e);for(;e-- >0;)i[e]=t[e];return i},forEachEntry:(t,e)=>{const i=(t&&t[r]).call(t);let s;for(;(s=i.next())&&!s.done;){const i=s.value;e.call(t,i[0],i[1])}},matchAll:(t,e)=>{let i;const s=[];for(;null!==(i=t.exec(e));)s.push(i);return s},isHTMLForm:k,hasOwnProperty:N,hasOwnProp:N,reduceDescriptors:B,freezeMethods:t=>{B(t,(e,i)=>{if(f(t)&&-1!==["arguments","caller","callee"].indexOf(i))return!1;const s=t[i];f(s)&&(e.enumerable=!1,"writable"in e?e.writable=!1:e.set||(e.set=()=>{throw Error("Can not rewrite read-only method '"+i+"'")}))})},toObjectSet:(t,e)=>{const i={},s=t=>{t.forEach(t=>{i[t]=!0})};return m(t)?s(t):s(String(t).split(e)),i},toCamelCase:t=>t.toLowerCase().replace(/[-_\s]([a-z\d])(\w*)/g,function(t,e,i){return e.toUpperCase()+i}),noop:()=>{},toFiniteNumber:(t,e)=>null!=t&&Number.isFinite(t=+t)?t:e,findKey:_,global:R,isContextDefined:G,isSpecCompliantForm:function(t){return!!(t&&f(t.append)&&"FormData"===t[n]&&t[r])},toJSONObject:t=>{const e=new Array(10),i=(t,s)=>{if(E(t)){if(e.indexOf(t)>=0)return;if(p(t))return t;if(!("toJSON"in t)){e[s]=t;const o=m(t)?[]:{};return O(t,(t,e)=>{const a=i(t,s+1);!u(a)&&(o[e]=a)}),e[s]=void 0,o}}return t};return i(t,0)},isAsyncFn:H,isThenable:t=>t&&(E(t)||f(t))&&f(t.then)&&f(t.catch),setImmediate:X,asap:V,isIterable:t=>null!=t&&f(t[r])};function q(t,e,i,s,o){Error.call(this),Error.captureStackTrace?Error.captureStackTrace(this,this.constructor):this.stack=(new Error).stack,this.message=t,this.name="AxiosError",e&&(this.code=e),i&&(this.config=i),s&&(this.request=s),o&&(this.response=o,this.status=o.status?o.status:null)}z.inherits(q,Error,{toJSON:function(){return{message:this.message,name:this.name,description:this.description,number:this.number,fileName:this.fileName,lineNumber:this.lineNumber,columnNumber:this.columnNumber,stack:this.stack,config:z.toJSONObject(this.config),code:this.code,status:this.status}}});const $=q.prototype,Z={};function K(t){return z.isPlainObject(t)||z.isArray(t)}function Q(t){return z.endsWith(t,"[]")?t.slice(0,-2):t}function J(t,e,i){return t?t.concat(e).map(function(t,e){return t=Q(t),!i&&e?"["+t+"]":t}).join(i?".":""):e}["ERR_BAD_OPTION_VALUE","ERR_BAD_OPTION","ECONNABORTED","ETIMEDOUT","ERR_NETWORK","ERR_FR_TOO_MANY_REDIRECTS","ERR_DEPRECATED","ERR_BAD_RESPONSE","ERR_BAD_REQUEST","ERR_CANCELED","ERR_NOT_SUPPORT","ERR_INVALID_URL"].forEach(t=>{Z[t]={value:t}}),Object.defineProperties(q,Z),Object.defineProperty($,"isAxiosError",{value:!0}),q.from=(t,e,i,s,o,a)=>{const r=Object.create($);z.toFlatObject(t,r,function(t){return t!==Error.prototype},t=>"isAxiosError"!==t);const n=t&&t.message?t.message:"Error",h=null==e&&t?t.code:e;return q.call(r,n,h,i,s,o),t&&null==r.cause&&Object.defineProperty(r,"cause",{value:t,configurable:!0}),r.name=t&&t.name||"Error",a&&Object.assign(r,a),r};const tt=z.toFlatObject(z,{},null,function(t){return/^is[A-Z]/.test(t)});function et(t,e,i){if(!z.isObject(t))throw new TypeError("target must be an object");e=e||new FormData;const s=(i=z.toFlatObject(i,{metaTokens:!0,dots:!1,indexes:!1},!1,function(t,e){return!z.isUndefined(e[t])})).metaTokens,o=i.visitor||l,a=i.dots,r=i.indexes,n=(i.Blob||"undefined"!=typeof Blob&&Blob)&&z.isSpecCompliantForm(e);if(!z.isFunction(o))throw new TypeError("visitor must be a function");function h(t){if(null===t)return"";if(z.isDate(t))return t.toISOString();if(z.isBoolean(t))return t.toString();if(!n&&z.isBlob(t))throw new q("Blob is not supported. Use a Buffer instead.");return z.isArrayBuffer(t)||z.isTypedArray(t)?n&&"function"==typeof Blob?new Blob([t]):Buffer.from(t):t}function l(t,i,o){let n=t;if(t&&!o&&"object"==typeof t)if(z.endsWith(i,"{}"))i=s?i:i.slice(0,-2),t=JSON.stringify(t);else if(z.isArray(t)&&function(t){return z.isArray(t)&&!t.some(K)}(t)||(z.isFileList(t)||z.endsWith(i,"[]"))&&(n=z.toArray(t)))return i=Q(i),n.forEach(function(t,s){!z.isUndefined(t)&&null!==t&&e.append(!0===r?J([i],s,a):null===r?i:i+"[]",h(t))}),!1;return!!K(t)||(e.append(J(o,i,a),h(t)),!1)}const c=[],d=Object.assign(tt,{defaultVisitor:l,convertValue:h,isVisitable:K});if(!z.isObject(t))throw new TypeError("data must be an object");return function t(i,s){if(!z.isUndefined(i)){if(-1!==c.indexOf(i))throw Error("Circular reference detected in "+s.join("."));c.push(i),z.forEach(i,function(i,a){!0===(!(z.isUndefined(i)||null===i)&&o.call(e,i,z.isString(a)?a.trim():a,s,d))&&t(i,s?s.concat(a):[a])}),c.pop()}}(t),e}function it(t){const e={"!":"%21","'":"%27","(":"%28",")":"%29","~":"%7E","%20":"+","%00":"\0"};return encodeURIComponent(t).replace(/[!'()~]|%20|%00/g,function(t){return e[t]})}function st(t,e){this._pairs=[],t&&et(t,this,e)}const ot=st.prototype;function at(t){return encodeURIComponent(t).replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,"+")}function rt(t,e,i){if(!e)return t;const s=i&&i.encode||at;z.isFunction(i)&&(i={serialize:i});const o=i&&i.serialize;let a;if(a=o?o(e,i):z.isURLSearchParams(e)?e.toString():new st(e,i).toString(s),a){const e=t.indexOf("#");-1!==e&&(t=t.slice(0,e)),t+=(-1===t.indexOf("?")?"?":"&")+a}return t}ot.append=function(t,e){this._pairs.push([t,e])},ot.toString=function(t){const e=t?function(e){return t.call(this,e,it)}:it;return this._pairs.map(function(t){return e(t[0])+"="+e(t[1])},"").join("&")};var nt=class{constructor(){this.handlers=[]}use(t,e,i){return this.handlers.push({fulfilled:t,rejected:e,synchronous:!!i&&i.synchronous,runWhen:i?i.runWhen:null}),this.handlers.length-1}eject(t){this.handlers[t]&&(this.handlers[t]=null)}clear(){this.handlers&&(this.handlers=[])}forEach(t){z.forEach(this.handlers,function(e){null!==e&&t(e)})}},ht={silentJSONParsing:!0,forcedJSONParsing:!0,clarifyTimeoutError:!1},lt={isBrowser:!0,classes:{URLSearchParams:"undefined"!=typeof URLSearchParams?URLSearchParams:st,FormData:"undefined"!=typeof FormData?FormData:null,Blob:"undefined"!=typeof Blob?Blob:null},protocols:["http","https","file","blob","url","data"]};const ct="undefined"!=typeof window&&"undefined"!=typeof document,dt="object"==typeof navigator&&navigator||void 0,mt=ct&&(!dt||["ReactNative","NativeScript","NS"].indexOf(dt.product)<0),ut="undefined"!=typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope&&"function"==typeof self.importScripts,pt=ct&&window.location.href||"http://localhost";var yt={...Object.freeze({__proto__:null,hasBrowserEnv:ct,hasStandardBrowserWebWorkerEnv:ut,hasStandardBrowserEnv:mt,navigator:dt,origin:pt}),...lt};function gt(t){function e(t,i,s,o){let a=t[o++];if("__proto__"===a)return!0;const r=Number.isFinite(+a),n=o>=t.length;return a=!a&&z.isArray(s)?s.length:a,n?(z.hasOwnProp(s,a)?s[a]=[s[a],i]:s[a]=i,!r):(s[a]&&z.isObject(s[a])||(s[a]=[]),e(t,i,s[a],o)&&z.isArray(s[a])&&(s[a]=function(t){const e={},i=Object.keys(t);let s;const o=i.length;let a;for(s=0;s<o;s++)a=i[s],e[a]=t[a];return e}(s[a])),!r)}if(z.isFormData(t)&&z.isFunction(t.entries)){const i={};return z.forEachEntry(t,(t,s)=>{e(function(t){return z.matchAll(/\w+|\[(\w*)]/g,t).map(t=>"[]"===t[0]?"":t[1]||t[0])}(t),s,i,0)}),i}return null}const ft={transitional:ht,adapter:["xhr","http","fetch"],transformRequest:[function(t,e){const i=e.getContentType()||"",s=i.indexOf("application/json")>-1,o=z.isObject(t);if(o&&z.isHTMLForm(t)&&(t=new FormData(t)),z.isFormData(t))return s?JSON.stringify(gt(t)):t;if(z.isArrayBuffer(t)||z.isBuffer(t)||z.isStream(t)||z.isFile(t)||z.isBlob(t)||z.isReadableStream(t))return t;if(z.isArrayBufferView(t))return t.buffer;if(z.isURLSearchParams(t))return e.setContentType("application/x-www-form-urlencoded;charset=utf-8",!1),t.toString();let a;if(o){if(i.indexOf("application/x-www-form-urlencoded")>-1)return function(t,e){return et(t,new yt.classes.URLSearchParams,{visitor:function(t,e,i,s){return yt.isNode&&z.isBuffer(t)?(this.append(e,t.toString("base64")),!1):s.defaultVisitor.apply(this,arguments)},...e})}(t,this.formSerializer).toString();if((a=z.isFileList(t))||i.indexOf("multipart/form-data")>-1){const e=this.env&&this.env.FormData;return et(a?{"files[]":t}:t,e&&new e,this.formSerializer)}}return o||s?(e.setContentType("application/json",!1),function(t){if(z.isString(t))try{return(0,JSON.parse)(t),z.trim(t)}catch(t){if("SyntaxError"!==t.name)throw t}return(0,JSON.stringify)(t)}(t)):t}],transformResponse:[function(t){const e=this.transitional||ft.transitional,i=e&&e.forcedJSONParsing,s="json"===this.responseType;if(z.isResponse(t)||z.isReadableStream(t))return t;if(t&&z.isString(t)&&(i&&!this.responseType||s)){const i=!(e&&e.silentJSONParsing)&&s;try{return JSON.parse(t,this.parseReviver)}catch(t){if(i){if("SyntaxError"===t.name)throw q.from(t,q.ERR_BAD_RESPONSE,this,null,this.response);throw t}}}return t}],timeout:0,xsrfCookieName:"XSRF-TOKEN",xsrfHeaderName:"X-XSRF-TOKEN",maxContentLength:-1,maxBodyLength:-1,env:{FormData:yt.classes.FormData,Blob:yt.classes.Blob},validateStatus:function(t){return t>=200&&t<300},headers:{common:{Accept:"application/json, text/plain, */*","Content-Type":void 0}}};z.forEach(["delete","get","head","post","put","patch"],t=>{ft.headers[t]={}});var wt=ft;const Et=z.toObjectSet(["age","authorization","content-length","content-type","etag","expires","from","host","if-modified-since","if-unmodified-since","last-modified","location","max-forwards","proxy-authorization","referer","retry-after","user-agent"]),xt=Symbol("internals");function bt(t){return t&&String(t).trim().toLowerCase()}function Tt(t){return!1===t||null==t?t:z.isArray(t)?t.map(Tt):String(t)}function It(t,e,i,s,o){return z.isFunction(s)?s.call(this,e,i):(o&&(e=i),z.isString(e)?z.isString(s)?-1!==e.indexOf(s):z.isRegExp(s)?s.test(e):void 0:void 0)}class St{constructor(t){t&&this.set(t)}set(t,e,i){const s=this;function o(t,e,i){const o=bt(e);if(!o)throw new Error("header name must be a non-empty string");const a=z.findKey(s,o);(!a||void 0===s[a]||!0===i||void 0===i&&!1!==s[a])&&(s[a||e]=Tt(t))}const a=(t,e)=>z.forEach(t,(t,i)=>o(t,i,e));if(z.isPlainObject(t)||t instanceof this.constructor)a(t,e);else if(z.isString(t)&&(t=t.trim())&&!/^[-_a-zA-Z0-9^`|~,!#$%&'*+.]+$/.test(t.trim()))a((t=>{const e={};let i,s,o;return t&&t.split("\n").forEach(function(t){o=t.indexOf(":"),i=t.substring(0,o).trim().toLowerCase(),s=t.substring(o+1).trim(),!i||e[i]&&Et[i]||("set-cookie"===i?e[i]?e[i].push(s):e[i]=[s]:e[i]=e[i]?e[i]+", "+s:s)}),e})(t),e);else if(z.isObject(t)&&z.isIterable(t)){let i,s,o={};for(const e of t){if(!z.isArray(e))throw TypeError("Object iterator must return a key-value pair");o[s=e[0]]=(i=o[s])?z.isArray(i)?[...i,e[1]]:[i,e[1]]:e[1]}a(o,e)}else null!=t&&o(e,t,i);return this}get(t,e){if(t=bt(t)){const i=z.findKey(this,t);if(i){const t=this[i];if(!e)return t;if(!0===e)return function(t){const e=Object.create(null),i=/([^\s,;=]+)\s*(?:=\s*([^,;]+))?/g;let s;for(;s=i.exec(t);)e[s[1]]=s[2];return e}(t);if(z.isFunction(e))return e.call(this,t,i);if(z.isRegExp(e))return e.exec(t);throw new TypeError("parser must be boolean|regexp|function")}}}has(t,e){if(t=bt(t)){const i=z.findKey(this,t);return!(!i||void 0===this[i]||e&&!It(0,this[i],i,e))}return!1}delete(t,e){const i=this;let s=!1;function o(t){if(t=bt(t)){const o=z.findKey(i,t);!o||e&&!It(0,i[o],o,e)||(delete i[o],s=!0)}}return z.isArray(t)?t.forEach(o):o(t),s}clear(t){const e=Object.keys(this);let i=e.length,s=!1;for(;i--;){const o=e[i];t&&!It(0,this[o],o,t,!0)||(delete this[o],s=!0)}return s}normalize(t){const e=this,i={};return z.forEach(this,(s,o)=>{const a=z.findKey(i,o);if(a)return e[a]=Tt(s),void delete e[o];const r=t?function(t){return t.trim().toLowerCase().replace(/([a-z\d])(\w*)/g,(t,e,i)=>e.toUpperCase()+i)}(o):String(o).trim();r!==o&&delete e[o],e[r]=Tt(s),i[r]=!0}),this}concat(...t){return this.constructor.concat(this,...t)}toJSON(t){const e=Object.create(null);return z.forEach(this,(i,s)=>{null!=i&&!1!==i&&(e[s]=t&&z.isArray(i)?i.join(", "):i)}),e}[Symbol.iterator](){return Object.entries(this.toJSON())[Symbol.iterator]()}toString(){return Object.entries(this.toJSON()).map(([t,e])=>t+": "+e).join("\n")}getSetCookie(){return this.get("set-cookie")||[]}get[Symbol.toStringTag](){return"AxiosHeaders"}static from(t){return t instanceof this?t:new this(t)}static concat(t,...e){const i=new this(t);return e.forEach(t=>i.set(t)),i}static accessor(t){const e=(this[xt]=this[xt]={accessors:{}}).accessors,i=this.prototype;function s(t){const s=bt(t);e[s]||(function(t,e){const i=z.toCamelCase(" "+e);["get","set","has"].forEach(s=>{Object.defineProperty(t,s+i,{value:function(t,i,o){return this[s].call(this,e,t,i,o)},configurable:!0})})}(i,t),e[s]=!0)}return z.isArray(t)?t.forEach(s):s(t),this}}St.accessor(["Content-Type","Content-Length","Accept","Accept-Encoding","User-Agent","Authorization"]),z.reduceDescriptors(St.prototype,({value:t},e)=>{let i=e[0].toUpperCase()+e.slice(1);return{get:()=>t,set(t){this[i]=t}}}),z.freezeMethods(St);var vt=St;function At(t,e){const i=this||wt,s=e||i,o=vt.from(s.headers);let a=s.data;return z.forEach(t,function(t){a=t.call(i,a,o.normalize(),e?e.status:void 0)}),o.normalize(),a}function Mt(t){return!(!t||!t.__CANCEL__)}function Ct(t,e,i){q.call(this,null==t?"canceled":t,q.ERR_CANCELED,e,i),this.name="CanceledError"}function Dt(t,e,i){const s=i.config.validateStatus;i.status&&s&&!s(i.status)?e(new q("Request failed with status code "+i.status,[q.ERR_BAD_REQUEST,q.ERR_BAD_RESPONSE][Math.floor(i.status/100)-4],i.config,i.request,i)):t(i)}z.inherits(Ct,q,{__CANCEL__:!0});const Ot=(t,e,i=3)=>{let s=0;const o=function(t,e){t=t||10;const i=new Array(t),s=new Array(t);let o,a=0,r=0;return e=void 0!==e?e:1e3,function(n){const h=Date.now(),l=s[r];o||(o=h),i[a]=n,s[a]=h;let c=r,d=0;for(;c!==a;)d+=i[c++],c%=t;if(a=(a+1)%t,a===r&&(r=(r+1)%t),h-o<e)return;const m=l&&h-l;return m?Math.round(1e3*d/m):void 0}}(50,250);return function(i,a){let r,n,h=0,l=1e3/a;const c=(i,a=Date.now())=>{h=a,r=null,n&&(clearTimeout(n),n=null),(i=>{const a=i.loaded,r=i.lengthComputable?i.total:void 0,n=a-s,h=o(n);s=a,t({loaded:a,total:r,progress:r?a/r:void 0,bytes:n,rate:h||void 0,estimated:h&&r&&a<=r?(r-a)/h:void 0,event:i,lengthComputable:null!=r,[e?"download":"upload"]:!0})})(...i)};return[(...t)=>{const e=Date.now(),i=e-h;i>=l?c(t,e):(r=t,n||(n=setTimeout(()=>{n=null,c(r)},l-i)))},()=>r&&c(r)]}(0,i)},_t=(t,e)=>{const i=null!=t;return[s=>e[0]({lengthComputable:i,total:t,loaded:s}),e[1]]},Rt=t=>(...e)=>z.asap(()=>t(...e));var Gt=yt.hasStandardBrowserEnv?((t,e)=>i=>(i=new URL(i,yt.origin),t.protocol===i.protocol&&t.host===i.host&&(e||t.port===i.port)))(new URL(yt.origin),yt.navigator&&/(msie|trident)/i.test(yt.navigator.userAgent)):()=>!0,Pt=yt.hasStandardBrowserEnv?{write(t,e,i,s,o,a,r){if("undefined"==typeof document)return;const n=[`${t}=${encodeURIComponent(e)}`];z.isNumber(i)&&n.push(`expires=${new Date(i).toUTCString()}`),z.isString(s)&&n.push(`path=${s}`),z.isString(o)&&n.push(`domain=${o}`),!0===a&&n.push("secure"),z.isString(r)&&n.push(`SameSite=${r}`),document.cookie=n.join("; ")},read(t){if("undefined"==typeof document)return null;const e=document.cookie.match(new RegExp("(?:^|; )"+t+"=([^;]*)"));return e?decodeURIComponent(e[1]):null},remove(t){this.write(t,"",Date.now()-864e5,"/")}}:{write(){},read:()=>null,remove(){}};function Lt(t,e,i){let s=!/^([a-z][a-z\d+\-.]*:)?\/\//i.test(e);return t&&(s||0==i)?function(t,e){return e?t.replace(/\/?\/$/,"")+"/"+e.replace(/^\/+/,""):t}(t,e):e}const kt=t=>t instanceof vt?{...t}:t;function Nt(t,e){e=e||{};const i={};function s(t,e,i,s){return z.isPlainObject(t)&&z.isPlainObject(e)?z.merge.call({caseless:s},t,e):z.isPlainObject(e)?z.merge({},e):z.isArray(e)?e.slice():e}function o(t,e,i,o){return z.isUndefined(e)?z.isUndefined(t)?void 0:s(void 0,t,0,o):s(t,e,0,o)}function a(t,e){if(!z.isUndefined(e))return s(void 0,e)}function r(t,e){return z.isUndefined(e)?z.isUndefined(t)?void 0:s(void 0,t):s(void 0,e)}function n(i,o,a){return a in e?s(i,o):a in t?s(void 0,i):void 0}const h={url:a,method:a,data:a,baseURL:r,transformRequest:r,transformResponse:r,paramsSerializer:r,timeout:r,timeoutMessage:r,withCredentials:r,withXSRFToken:r,adapter:r,responseType:r,xsrfCookieName:r,xsrfHeaderName:r,onUploadProgress:r,onDownloadProgress:r,decompress:r,maxContentLength:r,maxBodyLength:r,beforeRedirect:r,transport:r,httpAgent:r,httpsAgent:r,cancelToken:r,socketPath:r,responseEncoding:r,validateStatus:n,headers:(t,e,i)=>o(kt(t),kt(e),0,!0)};return z.forEach(Object.keys({...t,...e}),function(s){const a=h[s]||o,r=a(t[s],e[s],s);z.isUndefined(r)&&a!==n||(i[s]=r)}),i}var Yt=t=>{const e=Nt({},t);let{data:i,withXSRFToken:s,xsrfHeaderName:o,xsrfCookieName:a,headers:r,auth:n}=e;if(e.headers=r=vt.from(r),e.url=rt(Lt(e.baseURL,e.url,e.allowAbsoluteUrls),t.params,t.paramsSerializer),n&&r.set("Authorization","Basic "+btoa((n.username||"")+":"+(n.password?unescape(encodeURIComponent(n.password)):""))),z.isFormData(i))if(yt.hasStandardBrowserEnv||yt.hasStandardBrowserWebWorkerEnv)r.setContentType(void 0);else if(z.isFunction(i.getHeaders)){const t=i.getHeaders(),e=["content-type","content-length"];Object.entries(t).forEach(([t,i])=>{e.includes(t.toLowerCase())&&r.set(t,i)})}if(yt.hasStandardBrowserEnv&&(s&&z.isFunction(s)&&(s=s(e)),s||!1!==s&&Gt(e.url))){const t=o&&a&&Pt.read(a);t&&r.set(o,t)}return e},Bt="undefined"!=typeof XMLHttpRequest&&function(t){return new Promise(function(e,i){const s=Yt(t);let o=s.data;const a=vt.from(s.headers).normalize();let r,n,h,l,c,{responseType:d,onUploadProgress:m,onDownloadProgress:u}=s;function p(){l&&l(),c&&c(),s.cancelToken&&s.cancelToken.unsubscribe(r),s.signal&&s.signal.removeEventListener("abort",r)}let y=new XMLHttpRequest;function g(){if(!y)return;const s=vt.from("getAllResponseHeaders"in y&&y.getAllResponseHeaders());Dt(function(t){e(t),p()},function(t){i(t),p()},{data:d&&"text"!==d&&"json"!==d?y.response:y.responseText,status:y.status,statusText:y.statusText,headers:s,config:t,request:y}),y=null}y.open(s.method.toUpperCase(),s.url,!0),y.timeout=s.timeout,"onloadend"in y?y.onloadend=g:y.onreadystatechange=function(){y&&4===y.readyState&&(0!==y.status||y.responseURL&&0===y.responseURL.indexOf("file:"))&&setTimeout(g)},y.onabort=function(){y&&(i(new q("Request aborted",q.ECONNABORTED,t,y)),y=null)},y.onerror=function(e){const s=new q(e&&e.message?e.message:"Network Error",q.ERR_NETWORK,t,y);s.event=e||null,i(s),y=null},y.ontimeout=function(){let e=s.timeout?"timeout of "+s.timeout+"ms exceeded":"timeout exceeded";const o=s.transitional||ht;s.timeoutErrorMessage&&(e=s.timeoutErrorMessage),i(new q(e,o.clarifyTimeoutError?q.ETIMEDOUT:q.ECONNABORTED,t,y)),y=null},void 0===o&&a.setContentType(null),"setRequestHeader"in y&&z.forEach(a.toJSON(),function(t,e){y.setRequestHeader(e,t)}),z.isUndefined(s.withCredentials)||(y.withCredentials=!!s.withCredentials),d&&"json"!==d&&(y.responseType=s.responseType),u&&([h,c]=Ot(u,!0),y.addEventListener("progress",h)),m&&y.upload&&([n,l]=Ot(m),y.upload.addEventListener("progress",n),y.upload.addEventListener("loadend",l)),(s.cancelToken||s.signal)&&(r=e=>{y&&(i(!e||e.type?new Ct(null,t,y):e),y.abort(),y=null)},s.cancelToken&&s.cancelToken.subscribe(r),s.signal&&(s.signal.aborted?r():s.signal.addEventListener("abort",r)));const f=function(t){const e=/^([-+\w]{1,25})(:?\/\/|:)/.exec(t);return e&&e[1]||""}(s.url);f&&-1===yt.protocols.indexOf(f)?i(new q("Unsupported protocol "+f+":",q.ERR_BAD_REQUEST,t)):y.send(o||null)})},Ht=(t,e)=>{const{length:i}=t=t?t.filter(Boolean):[];if(e||i){let i,s=new AbortController;const o=function(t){if(!i){i=!0,r();const e=t instanceof Error?t:this.reason;s.abort(e instanceof q?e:new Ct(e instanceof Error?e.message:e))}};let a=e&&setTimeout(()=>{a=null,o(new q(`timeout ${e} of ms exceeded`,q.ETIMEDOUT))},e);const r=()=>{t&&(a&&clearTimeout(a),a=null,t.forEach(t=>{t.unsubscribe?t.unsubscribe(o):t.removeEventListener("abort",o)}),t=null)};t.forEach(t=>t.addEventListener("abort",o));const{signal:n}=s;return n.unsubscribe=()=>z.asap(r),n}};const Xt=function*(t,e){let i=t.byteLength;if(!e||i<e)return void(yield t);let s,o=0;for(;o<i;)s=o+e,yield t.slice(o,s),o=s},Ft=(t,e,i,s)=>{const o=async function*(t,e){for await(const i of async function*(t){if(t[Symbol.asyncIterator])return void(yield*t);const e=t.getReader();try{for(;;){const{done:t,value:i}=await e.read();if(t)break;yield i}}finally{await e.cancel()}}(t))yield*Xt(i,e)}(t,e);let a,r=0,n=t=>{a||(a=!0,s&&s(t))};return new ReadableStream({async pull(t){try{const{done:e,value:s}=await o.next();if(e)return n(),void t.close();let a=s.byteLength;if(i){let t=r+=a;i(t)}t.enqueue(new Uint8Array(s))}catch(t){throw n(t),t}},cancel:t=>(n(t),o.return())},{highWaterMark:2})},{isFunction:Wt}=z,Ut=(({Request:t,Response:e})=>({Request:t,Response:e}))(z.global),{ReadableStream:jt,TextEncoder:Vt}=z.global,zt=(t,...e)=>{try{return!!t(...e)}catch(t){return!1}},qt=t=>{t=z.merge.call({skipUndefined:!0},Ut,t);const{fetch:e,Request:i,Response:s}=t,o=e?Wt(e):"function"==typeof fetch,a=Wt(i),r=Wt(s);if(!o)return!1;const n=o&&Wt(jt),h=o&&("function"==typeof Vt?(l=new Vt,t=>l.encode(t)):async t=>new Uint8Array(await new i(t).arrayBuffer()));var l;const c=a&&n&&zt(()=>{let t=!1;const e=new i(yt.origin,{body:new jt,method:"POST",get duplex(){return t=!0,"half"}}).headers.has("Content-Type");return t&&!e}),d=r&&n&&zt(()=>z.isReadableStream(new s("").body)),m={stream:d&&(t=>t.body)};o&&["text","arrayBuffer","blob","formData","stream"].forEach(t=>{!m[t]&&(m[t]=(e,i)=>{let s=e&&e[t];if(s)return s.call(e);throw new q(`Response type '${t}' is not supported`,q.ERR_NOT_SUPPORT,i)})});return async t=>{let{url:o,method:r,data:n,signal:l,cancelToken:u,timeout:p,onDownloadProgress:y,onUploadProgress:g,responseType:f,headers:w,withCredentials:E="same-origin",fetchOptions:x}=Yt(t),b=e||fetch;f=f?(f+"").toLowerCase():"text";let T=Ht([l,u&&u.toAbortSignal()],p),I=null;const S=T&&T.unsubscribe&&(()=>{T.unsubscribe()});let v;try{if(g&&c&&"get"!==r&&"head"!==r&&0!==(v=await(async(t,e)=>{const s=z.toFiniteNumber(t.getContentLength());return null==s?(async t=>{if(null==t)return 0;if(z.isBlob(t))return t.size;if(z.isSpecCompliantForm(t)){const e=new i(yt.origin,{method:"POST",body:t});return(await e.arrayBuffer()).byteLength}return z.isArrayBufferView(t)||z.isArrayBuffer(t)?t.byteLength:(z.isURLSearchParams(t)&&(t+=""),z.isString(t)?(await h(t)).byteLength:void 0)})(e):s})(w,n))){let t,e=new i(o,{method:"POST",body:n,duplex:"half"});if(z.isFormData(n)&&(t=e.headers.get("content-type"))&&w.setContentType(t),e.body){const[t,i]=_t(v,Ot(Rt(g)));n=Ft(e.body,65536,t,i)}}z.isString(E)||(E=E?"include":"omit");const e=a&&"credentials"in i.prototype,l={...x,signal:T,method:r.toUpperCase(),headers:w.normalize().toJSON(),body:n,duplex:"half",credentials:e?E:void 0};I=a&&new i(o,l);let u=await(a?b(I,x):b(o,l));const p=d&&("stream"===f||"response"===f);if(d&&(y||p&&S)){const t={};["status","statusText","headers"].forEach(e=>{t[e]=u[e]});const e=z.toFiniteNumber(u.headers.get("content-length")),[i,o]=y&&_t(e,Ot(Rt(y),!0))||[];u=new s(Ft(u.body,65536,i,()=>{o&&o(),S&&S()}),t)}f=f||"text";let A=await m[z.findKey(m,f)||"text"](u,t);return!p&&S&&S(),await new Promise((e,i)=>{Dt(e,i,{data:A,headers:vt.from(u.headers),status:u.status,statusText:u.statusText,config:t,request:I})})}catch(e){if(S&&S(),e&&"TypeError"===e.name&&/Load failed|fetch/i.test(e.message))throw Object.assign(new q("Network Error",q.ERR_NETWORK,t,I),{cause:e.cause||e});throw q.from(e,e&&e.code,t,I)}}},$t=new Map,Zt=t=>{let e=t&&t.env||{};const{fetch:i,Request:s,Response:o}=e,a=[s,o,i];let r,n,h=a.length,l=$t;for(;h--;)r=a[h],n=l.get(r),void 0===n&&l.set(r,n=h?new Map:qt(e)),l=n;return n};Zt();const Kt={http:null,xhr:Bt,fetch:{get:Zt}};z.forEach(Kt,(t,e)=>{if(t){try{Object.defineProperty(t,"name",{value:e})}catch(t){}Object.defineProperty(t,"adapterName",{value:e})}});const Qt=t=>`- ${t}`,Jt=t=>z.isFunction(t)||null===t||!1===t;var te=function(t,e){t=z.isArray(t)?t:[t];const{length:i}=t;let s,o;const a={};for(let r=0;r<i;r++){let i;if(s=t[r],o=s,!Jt(s)&&(o=Kt[(i=String(s)).toLowerCase()],void 0===o))throw new q(`Unknown adapter '${i}'`);if(o&&(z.isFunction(o)||(o=o.get(e))))break;a[i||"#"+r]=o}if(!o){const t=Object.entries(a).map(([t,e])=>`adapter ${t} `+(!1===e?"is not supported by the environment":"is not available in the build"));throw new q("There is no suitable adapter to dispatch the request "+(i?t.length>1?"since :\n"+t.map(Qt).join("\n"):" "+Qt(t[0]):"as no adapter specified"),"ERR_NOT_SUPPORT")}return o};function ee(t){if(t.cancelToken&&t.cancelToken.throwIfRequested(),t.signal&&t.signal.aborted)throw new Ct(null,t)}function ie(t){return ee(t),t.headers=vt.from(t.headers),t.data=At.call(t,t.transformRequest),-1!==["post","put","patch"].indexOf(t.method)&&t.headers.setContentType("application/x-www-form-urlencoded",!1),te(t.adapter||wt.adapter,t)(t).then(function(e){return ee(t),e.data=At.call(t,t.transformResponse,e),e.headers=vt.from(e.headers),e},function(e){return Mt(e)||(ee(t),e&&e.response&&(e.response.data=At.call(t,t.transformResponse,e.response),e.response.headers=vt.from(e.response.headers))),Promise.reject(e)})}const se="1.13.2",oe={};["object","boolean","number","function","string","symbol"].forEach((t,e)=>{oe[t]=function(i){return typeof i===t||"a"+(e<1?"n ":" ")+t}});const ae={};oe.transitional=function(t,e,i){function s(t,e){return"[Axios v"+se+"] Transitional option '"+t+"'"+e+(i?". "+i:"")}return(i,o,a)=>{if(!1===t)throw new q(s(o," has been removed"+(e?" in "+e:"")),q.ERR_DEPRECATED);return e&&!ae[o]&&(ae[o]=!0,console.warn(s(o," has been deprecated since v"+e+" and will be removed in the near future"))),!t||t(i,o,a)}},oe.spelling=function(t){return(e,i)=>(console.warn(`${i} is likely a misspelling of ${t}`),!0)};var re={assertOptions:function(t,e,i){if("object"!=typeof t)throw new q("options must be an object",q.ERR_BAD_OPTION_VALUE);const s=Object.keys(t);let o=s.length;for(;o-- >0;){const a=s[o],r=e[a];if(r){const e=t[a],i=void 0===e||r(e,a,t);if(!0!==i)throw new q("option "+a+" must be "+i,q.ERR_BAD_OPTION_VALUE);continue}if(!0!==i)throw new q("Unknown option "+a,q.ERR_BAD_OPTION)}},validators:oe};const ne=re.validators;class he{constructor(t){this.defaults=t||{},this.interceptors={request:new nt,response:new nt}}async request(t,e){try{return await this._request(t,e)}catch(t){if(t instanceof Error){let e={};Error.captureStackTrace?Error.captureStackTrace(e):e=new Error;const i=e.stack?e.stack.replace(/^.+\n/,""):"";try{t.stack?i&&!String(t.stack).endsWith(i.replace(/^.+\n.+\n/,""))&&(t.stack+="\n"+i):t.stack=i}catch(t){}}throw t}}_request(t,e){"string"==typeof t?(e=e||{}).url=t:e=t||{},e=Nt(this.defaults,e);const{transitional:i,paramsSerializer:s,headers:o}=e;void 0!==i&&re.assertOptions(i,{silentJSONParsing:ne.transitional(ne.boolean),forcedJSONParsing:ne.transitional(ne.boolean),clarifyTimeoutError:ne.transitional(ne.boolean)},!1),null!=s&&(z.isFunction(s)?e.paramsSerializer={serialize:s}:re.assertOptions(s,{encode:ne.function,serialize:ne.function},!0)),void 0!==e.allowAbsoluteUrls||(void 0!==this.defaults.allowAbsoluteUrls?e.allowAbsoluteUrls=this.defaults.allowAbsoluteUrls:e.allowAbsoluteUrls=!0),re.assertOptions(e,{baseUrl:ne.spelling("baseURL"),withXsrfToken:ne.spelling("withXSRFToken")},!0),e.method=(e.method||this.defaults.method||"get").toLowerCase();let a=o&&z.merge(o.common,o[e.method]);o&&z.forEach(["delete","get","head","post","put","patch","common"],t=>{delete o[t]}),e.headers=vt.concat(a,o);const r=[];let n=!0;this.interceptors.request.forEach(function(t){"function"==typeof t.runWhen&&!1===t.runWhen(e)||(n=n&&t.synchronous,r.unshift(t.fulfilled,t.rejected))});const h=[];let l;this.interceptors.response.forEach(function(t){h.push(t.fulfilled,t.rejected)});let c,d=0;if(!n){const t=[ie.bind(this),void 0];for(t.unshift(...r),t.push(...h),c=t.length,l=Promise.resolve(e);d<c;)l=l.then(t[d++],t[d++]);return l}c=r.length;let m=e;for(;d<c;){const t=r[d++],e=r[d++];try{m=t(m)}catch(t){e.call(this,t);break}}try{l=ie.call(this,m)}catch(t){return Promise.reject(t)}for(d=0,c=h.length;d<c;)l=l.then(h[d++],h[d++]);return l}getUri(t){return rt(Lt((t=Nt(this.defaults,t)).baseURL,t.url,t.allowAbsoluteUrls),t.params,t.paramsSerializer)}}z.forEach(["delete","get","head","options"],function(t){he.prototype[t]=function(e,i){return this.request(Nt(i||{},{method:t,url:e,data:(i||{}).data}))}}),z.forEach(["post","put","patch"],function(t){function e(e){return function(i,s,o){return this.request(Nt(o||{},{method:t,headers:e?{"Content-Type":"multipart/form-data"}:{},url:i,data:s}))}}he.prototype[t]=e(),he.prototype[t+"Form"]=e(!0)});var le=he;class ce{constructor(t){if("function"!=typeof t)throw new TypeError("executor must be a function.");let e;this.promise=new Promise(function(t){e=t});const i=this;this.promise.then(t=>{if(!i._listeners)return;let e=i._listeners.length;for(;e-- >0;)i._listeners[e](t);i._listeners=null}),this.promise.then=t=>{let e;const s=new Promise(t=>{i.subscribe(t),e=t}).then(t);return s.cancel=function(){i.unsubscribe(e)},s},t(function(t,s,o){i.reason||(i.reason=new Ct(t,s,o),e(i.reason))})}throwIfRequested(){if(this.reason)throw this.reason}subscribe(t){this.reason?t(this.reason):this._listeners?this._listeners.push(t):this._listeners=[t]}unsubscribe(t){if(!this._listeners)return;const e=this._listeners.indexOf(t);-1!==e&&this._listeners.splice(e,1)}toAbortSignal(){const t=new AbortController,e=e=>{t.abort(e)};return this.subscribe(e),t.signal.unsubscribe=()=>this.unsubscribe(e),t.signal}static source(){let t;return{token:new ce(function(e){t=e}),cancel:t}}}var de=ce;const me={Continue:100,SwitchingProtocols:101,Processing:102,EarlyHints:103,Ok:200,Created:201,Accepted:202,NonAuthoritativeInformation:203,NoContent:204,ResetContent:205,PartialContent:206,MultiStatus:207,AlreadyReported:208,ImUsed:226,MultipleChoices:300,MovedPermanently:301,Found:302,SeeOther:303,NotModified:304,UseProxy:305,Unused:306,TemporaryRedirect:307,PermanentRedirect:308,BadRequest:400,Unauthorized:401,PaymentRequired:402,Forbidden:403,NotFound:404,MethodNotAllowed:405,NotAcceptable:406,ProxyAuthenticationRequired:407,RequestTimeout:408,Conflict:409,Gone:410,LengthRequired:411,PreconditionFailed:412,PayloadTooLarge:413,UriTooLong:414,UnsupportedMediaType:415,RangeNotSatisfiable:416,ExpectationFailed:417,ImATeapot:418,MisdirectedRequest:421,UnprocessableEntity:422,Locked:423,FailedDependency:424,TooEarly:425,UpgradeRequired:426,PreconditionRequired:428,TooManyRequests:429,RequestHeaderFieldsTooLarge:431,UnavailableForLegalReasons:451,InternalServerError:500,NotImplemented:501,BadGateway:502,ServiceUnavailable:503,GatewayTimeout:504,HttpVersionNotSupported:505,VariantAlsoNegotiates:506,InsufficientStorage:507,LoopDetected:508,NotExtended:510,NetworkAuthenticationRequired:511,WebServerIsDown:521,ConnectionTimedOut:522,OriginIsUnreachable:523,TimeoutOccurred:524,SslHandshakeFailed:525,InvalidSslCertificate:526};Object.entries(me).forEach(([t,e])=>{me[e]=t});var ue=me;const pe=function t(e){const i=new le(e),o=s(le.prototype.request,i);return z.extend(o,le.prototype,i,{allOwnKeys:!0}),z.extend(o,i,null,{allOwnKeys:!0}),o.create=function(i){return t(Nt(e,i))},o}(wt);pe.Axios=le,pe.CanceledError=Ct,pe.CancelToken=de,pe.isCancel=Mt,pe.VERSION=se,pe.toFormData=et,pe.AxiosError=q,pe.Cancel=pe.CanceledError,pe.all=function(t){return Promise.all(t)},pe.spread=function(t){return function(e){return t.apply(null,e)}},pe.isAxiosError=function(t){return z.isObject(t)&&!0===t.isAxiosError},pe.mergeConfig=Nt,pe.AxiosHeaders=vt,pe.formToJSON=t=>gt(z.isHTMLForm(t)?new FormData(t):t),pe.getAdapter=te,pe.HttpStatusCode=ue,pe.default=pe,t.exports=pe},6493:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.RookEnemy=void 0;const s=i(7851),o=i(7455),a=i(6986);class r extends a.Enemy{constructor(t,e,i,a,r){super(t,e,i,a),this.hit=()=>this.damage,this.behavior=()=>{if(this.lastX=this.x,this.lastY=this.y,!this.dead){if(this.handleSkipTurns())return;if(this.ticks++,this.seenPlayer){if(this.seenPlayer){if(this.room.playerTicked===this.targetPlayer){this.alertTicks=Math.max(0,this.alertTicks-1);let t=this.x,e=this.y,i=Array();for(const t of this.room.entities)t!==this&&i.push({x:t.x,y:t.y});for(let t=this.x-1;t<=this.x+1;t++)for(let e=this.y-1;e<=this.y+1;e++)this.room.roomArray[t][e]instanceof o.SpikeTrap&&this.room.roomArray[t][e].on&&i.push({x:t,y:e});const s=this.searchPathLocalized(this.targetPlayer,i,{useLastPlayerPos:!0});if(this.justHurt)this.justHurt=!1;else if(s.length>0&&!this.unconscious){let i=s[0].pos.x,o=s[0].pos.y,a=!1;for(const t in this.game.players)this.game.rooms[this.game.players[t].levelID]===this.room&&this.game.players[t].x===i&&this.game.players[t].y===o&&(this.game.players[t].hurt(this.hit(),this.name),this.drawX=.5*(this.x-this.game.players[t].x),this.drawY=.5*(this.y-this.game.players[t].y),this.game.players[t]===this.game.players[this.game.localPlayerID]&&this.game.shakeScreen(10*this.drawX,10*this.drawY));a||(this.tryMove(i,o),this.setDrawXY(t,e))}this.makeHitWarnings()}let t=-1!==Object.values(this.game.offlinePlayers).indexOf(this.targetPlayer);if(!this.aggro||t){let e=this.nearestPlayer();if(!1!==e){let[i,s]=e;i<=4&&(t||i<this.playerDistance(this.targetPlayer))&&s!==this.targetPlayer&&(this.targetPlayer=s,this.facePlayer(s),s===this.game.players[this.game.localPlayerID]&&(this.alertTicks=1),this.makeHitWarnings())}}}}else{let t=this.nearestPlayer();if(!1!==t){let[e,i]=t;e<=4&&(this.targetPlayer=i,this.facePlayer(i),this.seenPlayer=!0,i===this.game.players[this.game.localPlayerID]&&(this.alertTicks=1),this.makeHitWarnings())}}}},this.draw=t=>{this.dead||(s.Game.ctx.save(),s.Game.ctx.globalAlpha=this.alpha,this.health<=1||this.cloned,this.dead||(this.updateDrawXY(t),this.frame+=.1*t,this.frame>=4&&(this.frame=0),this.hasShadow&&this.drawShadow(t),s.Game.drawMob(this.tileX+Math.floor(this.frame),this.tileY,1,2,this.x-this.drawX,this.y-this.drawYOffset-this.drawY-this.jumpY,1,2,this.softShadeColor,this.shadeAmount(),void 0,this.outlineColor(),this.outlineOpacity())),this.cloned||(this.seenPlayer||this.drawSleepingZs(t),this.alertTicks>0&&this.drawExclamation(t)),s.Game.ctx.restore())},this.ticks=0,this.frame=0,this.health=1,this.maxHealth=1,this.defaultMaxHealth=1,this.tileX=51,this.tileY=8,this.seenPlayer=!1,this.aggro=!1,this.name="rook",this.orthogonalAttack=!0,this.diagonalAttack=!1,this.jumpHeight=.5,r&&(this.drop=r),this.armored=!0,this.getDrop(["weapon","equipment","consumable","tool","coin"])}}e.RookEnemy=r,r.difficulty=4,r.tileX=51,r.tileY=8},6525:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.ObsidianResource=void 0;const s=i(7172),o=i(9432),a=i(9467);class r extends s.Resource{constructor(t,e,i,s){super(t,e,i,s),this.room=t,this.health=2,this.tileX=8,this.tileY=4,this.hasShadow=!1,this.chainPushable=!1,this.name="obsidian",a.Random.rand()<.025&&this.drops.push(new o.Geode(this.room,this.x,this.y))}}e.ObsidianResource=r},6535:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.BluePotion=void 0;const s=i(7366),o=i(5180);class a extends o.Usable{constructor(t,e,i){super(t,e,i),this.onUse=t=>{t.health=Math.min(t.maxHealth,t.health+1),this.level.game.rooms[t.levelID]===this.level.game.room&&s.Sound.heal(),t.inventory.removeItem(this)},this.getDescription=()=>"HEALTH POTION\nRestores 1 heart",this.tileX=9,this.tileY=0,this.offsetY=-.3}}e.BluePotion=a},6598:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.QueenEnemy=void 0;const s=i(7851),o=i(7455),a=i(6986);class r extends a.Enemy{constructor(t,e,i,a,r){super(t,e,i,a),this.justHurt=!1,this.hit=()=>this.damage,this.behavior=()=>{if(this.lastX=this.x,this.lastY=this.y,this.health<=1&&(this.imageParticleY=29),!this.dead){if(this.handleSkipTurns())return;if(this.ticks++,this.seenPlayer){if(this.seenPlayer){if(this.room.playerTicked===this.targetPlayer){this.alertTicks=Math.max(0,this.alertTicks-1);let t=this.x,e=this.y,i=Array();for(const t of this.room.entities)t!==this&&i.push({x:t.x,y:t.y});for(let t=this.x-1;t<=this.x+1;t++)for(let e=this.y-1;e<=this.y+1;e++)this.room.roomArray[t][e]instanceof o.SpikeTrap&&this.room.roomArray[t][e].on&&i.push({x:t,y:e});const s=this.searchPathLocalized(this.targetPlayer,i,{diagonals:!0});if(this.justHurt)this.retreat(t,e);else if(s.length>0){i.push({x:t+1,y:e}),i.push({x:t-1,y:e}),i.push({x:t,y:e+1}),i.push({x:t,y:e-1});let o=s[0].pos.x,a=s[0].pos.y,r=!1;for(const t in this.game.players)this.game.rooms[this.game.players[t].levelID]===this.room&&this.game.players[t].x===o&&this.game.players[t].y===a&&(this.game.players[t].hurt(this.hit(),this.name),this.drawX=.5*(this.x-this.game.players[t].x),this.drawY=.5*(this.y-this.game.players[t].y),this.game.players[t]===this.game.players[this.game.localPlayerID]&&this.game.shakeScreen(10*this.drawX,10*this.drawY));r||(this.tryMove(o,a),this.setDrawXY(t,e))}this.makeHitWarnings()}let t=-1!==Object.values(this.game.offlinePlayers).indexOf(this.targetPlayer);if(!this.aggro||t){let e=this.nearestPlayer();if(!1!==e){let[i,s]=e;i<=4&&(t||i<this.playerDistance(this.targetPlayer))&&s!==this.targetPlayer&&(this.targetPlayer=s,this.facePlayer(s),s===this.game.players[this.game.localPlayerID]&&(this.alertTicks=1),this.makeHitWarnings())}}}}else{this.justHurt=!1;let t=this.nearestPlayer();if(!1!==t){let[e,i]=t;e<=4&&(this.targetPlayer=i,this.facePlayer(i),this.seenPlayer=!0,i===this.game.players[this.game.localPlayerID]&&(this.alertTicks=1),this.makeHitWarnings())}}}},this.jump=t=>{let e=Math.max(Math.abs(this.drawX),Math.abs(this.drawY)),i=Math.abs(Math.sin(e*Math.PI))*this.jumpHeight;i<.01&&(i=0),i>this.jumpHeight&&(i=this.jumpHeight),this.jumpY=i},this.draw=t=>{let e=this.health<=1?0:-2;this.cloned&&(e=0),this.dead||(s.Game.ctx.save(),s.Game.ctx.globalAlpha=this.alpha,this.dead||(this.updateDrawXY(t),this.frame+=.1*t,this.frame>=4&&(this.frame=0),this.hasShadow&&this.drawShadow(t),s.Game.drawMob(this.tileX+Math.floor(this.frame),this.tileY+e,1,2,this.x-this.drawX,this.y-this.drawYOffset-this.drawY-this.jumpY,1,2,this.softShadeColor,this.shadeAmount()*(1+this.jumpY/3),void 0,this.outlineColor(),this.outlineOpacity())),this.cloned||(this.seenPlayer||this.drawSleepingZs(t),this.alertTicks>0&&this.drawExclamation(t)),s.Game.ctx.restore())},this.ticks=0,this.frame=0,this.health=2,this.maxHealth=2,this.defaultMaxHealth=2,this.tileX=23,this.tileY=10,this.seenPlayer=!1,this.aggro=!1,this.destroyableByOthers=!1,this.name="queen",this.orthogonalAttack=!0,this.diagonalAttack=!0,this.jumpHeight=1,this.imageParticleX=6,this.imageParticleY=28,r&&(this.drop=r),this.armored=!0,this.getDrop(["weapon","equipment","consumable","tool","coin"])}}e.QueenEnemy=r,r.difficulty=4,r.tileX=23,r.tileY=8},6635:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Sword=void 0;const s=i(4052),o=i(7366),a=i(7851);class r extends s.Weapon{constructor(t,e,i){super(t,e,i),this.hitSound=()=>{o.Sound.hit(),o.Sound.playShortSlice()},this.weaponMove=(t,e)=>{let i={x:t,y:e},s={x:t,y:e},o=[i,s];switch(this.wielder.direction){case a.Direction.DOWN:i.x=t-1,s.x=t+1;break;case a.Direction.UP:i.x=t+1,s.x=t-1;break;case a.Direction.LEFT:i.y=e+1,s.y=e-1;break;case a.Direction.RIGHT:i.y=e-1,s.y=e+1}if(this.checkForPushables(t,e))return!0;this.beginSwing();const r=this.executeAttack(t,e,!0,this.damage+this.wielder.damageBonus,!0,!0,!0,!1);if(r){for(const t of o)if(!this.game.rooms[this.wielder.levelID].roomArray[t.x][t.y].isSolid()){const e=this.damage+this.wielder.damageBonus;this.hitEntitiesAt(t.x,t.y,e)}this.game.rooms[this.wielder.levelID].tick(this.wielder)}return this.endSwing(),!r},this.shakeScreen=()=>{setTimeout(()=>{switch(this.wielder.direction){case a.Direction.DOWN:case a.Direction.UP:this.game.shakeScreen(0,-5,!1);break;case a.Direction.LEFT:this.game.shakeScreen(-5,-5,!1);break;case a.Direction.RIGHT:this.game.shakeScreen(5,-5,!1)}},this.hitDelay)},this.tileX=28,this.tileY=2,this.damage=1,this.name="sword",this.degradeable=!1,this.useCost=2,this.offsetY=-.5}}e.Sword=r,r.itemName="sword"},6644:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.ShieldLeftFragment=void 0;const s=i(5180),o=i(2279),a=i(2270);class r extends s.Usable{constructor(t,e,i){super(t,e,i),this.onDrop=()=>{"left"===this.level.game.lastDroppedShieldPiece?(this.level.game.lastDroppedShieldPiece=null,this.level.items.push(new o.ShieldRightFragment(this.level,this.x,this.y)),this.level.items=this.level.items.filter(t=>t!==this)):null===this.level.game.lastDroppedShieldPiece&&(this.level.game.lastDroppedScythePiece="blade")},this.useOnOther=(t,e)=>{if(e instanceof o.ShieldRightFragment){t.inventory.removeItem(this),t.inventory.removeItem(e),t.game.pushMessage("You combine the shield fragments into a shield.");const i=t?.getRoom?t.getRoom():t.game.rooms[t.levelID],s=new a.Armor(i,t.x,t.y);t.inventory.addItem(s)}},this.tileX=1,this.tileY=2,this.stackable=!1,this.name=r.itemName,this.description="The left fragment of a shield. Find the right fragment to use it.",this.canUseOnOther=!0}}e.ShieldLeftFragment=r,r.itemName="left shield fragment"},6739:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Glowshrooms=void 0;const s=i(606),o=i(7851),a=i(606),r=i(2103),n=i(8594);class h extends s.Entity{constructor(t,e,i,s){super(t,e,i,s),this.draw=t=>{this.dead||(o.Game.ctx.save(),o.Game.ctx.globalAlpha=this.alpha,this.dead||(this.hasShadow&&this.drawShadow(t),this.updateDrawXY(t),o.Game.drawObj(this.tileX,this.tileY,1,2,this.x-this.drawX,this.y-this.drawYOffset-this.drawY,1,2,this.room.shadeColor,this.shadeAmount())),o.Game.ctx.restore())},this.drawTopLayer=t=>{this.drawableY=this.y},this.room=t,this.health=1,this.tileX=1,this.tileY=7,this.hasShadow=!0,this.chainPushable=!1,this.name=h.itemName,this.imageParticleX=0,this.imageParticleY=30,this.drops.push(new n.ShroomLight(this.room,this.x,this.y)),this.hasBloom=!0,this.bloomColor="#054B4B",this.bloomAlpha=1,this.softBloomAlpha=0,this.lightSource=new r.LightSource(this.x+.5,this.y+.5,7,[5,100,150],5),this.addLightSource(this.lightSource)}get type(){return a.EntityType.PROP}}e.Glowshrooms=h,h.itemName="glowshrooms"},6751:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.ZirconResource=void 0;const s=i(7172),o=i(9432),a=i(9467),r=i(521),n=i(2103);class h extends s.Resource{constructor(t,e,i,s){super(t,e,i,s),this.tileX=16,this.tileY=0,this.health=3,this.name="zircon",this.hasBloom=!0,this.bloomColor="#0005FF",this.bloomAlpha=1,this.softBloomAlpha=0,a.Random.rand()<.025&&this.drops.push(new o.Geode(this.room,this.x,this.y)),this.drops.push(new r.BlueGem(this.room,this.x,this.y)),this.lightSource=new n.LightSource(this.x+.5,this.y+.5,7,[5,5,100],2),this.addLightSource(this.lightSource)}}e.ZirconResource=h},6760:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.clearCookieSave=e.loadFromCookies=e.saveToCookies=void 0;const s=i(5095),o=i(9573),a="wr_save";e.saveToCookies=t=>{const e=(0,s.createGameState)(t),i=JSON.stringify(e);(0,o.setCookieChunks)(a,i,30),t.pushMessage?.("Saved to cookies.")},e.loadFromCookies=async t=>{const e=(0,o.getCookieChunks)(a);if(!e)return t.pushMessage?.("No cookie save found."),!1;try{const i=JSON.parse(e),o=[t.localPlayerID];return await(0,s.loadGameState)(t,o,i,!1),t.pushMessage?.("Loaded from cookies."),!0}catch(e){return console.error("Cookie load failed",e),t.pushMessage?.("Cookie load failed."),!1}},e.clearCookieSave=()=>{try{const t=(0,o.getCookie)(`${a}_meta`),e=t?parseInt(t,10):NaN;if(Number.isFinite(e)&&e>0)for(let t=0;t<e;t++)(0,o.deleteCookie)(`${a}_${t}`);else for(let t=0;t<32;t++)(0,o.deleteCookie)(`${a}_${t}`)}catch{}(0,o.deleteCookie)(`${a}_meta`)}},6761:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.MagmaPool=void 0;const s=i(7851),o=i(8132),a=i(2103);class r extends o.Tile{constructor(t,e,i,o,r,n,h){super(t,e,i),this.interact=()=>{this.room.game.pushMessage("You jump into the pool.")},this.isSolid=()=>!0,this.canCrushEnemy=()=>!0,this.draw=t=>{s.Game.drawTile(1,this.skin,1,1,this.x,this.y,1,1,this.room.shadeColor,this.shadeAmount()),this.topEdge&&s.Game.drawTile(22,3,1,2,this.x,this.y,1,2,this.room.shadeColor,this.shadeAmount()),s.Game.drawTile(this.tileX,this.tileY,1,1,this.x,this.y,1,1,this.room.shadeColor,this.shadeAmount())},this.tileX=24,this.tileY=4,o?this.tileX--:r&&this.tileX++,n?this.tileY--:h&&this.tileY++,this.topEdge=n;const l=new a.LightSource(this.x+.5,this.y+.5,.5,[200,50,0],3);this.room.lightSources.push(l),this.hasBloom=!0,this.bloomColor="#641900",this.bloomAlpha=1}}e.MagmaPool=r},6791:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.ArrowParticle=void 0;const s=i(824),o=i(7851);class a extends s.Particle{constructor(t,e,i,s,a){super(),this.renderRect=(t,e,i,s,a)=>{o.Game.ctx;const r=o.Game.ctx;if(!r)return;const n=o.Game.TILESIZE||16;r.save(),r.imageSmoothingEnabled=!1,r.fillStyle=a;const h=Math.round((t-i/2)*n),l=Math.round((e-s/2)*n),c=Math.max(1,Math.round(i*n)),d=Math.max(1,Math.round(s*n));r.fillRect(h,l,c,d),r.restore()},this.draw=t=>{if(this.dead)return;const e=this.endX-this.startX,i=this.endY-this.startY,s=Math.max(1,Math.abs(e)+Math.abs(i));if(this.t+=this.speed*(t||1)/s,this.t>=1&&(this.t=1),this.x=this.startX+this.t*e,this.y=this.startY+this.t*i,this.t>=1){const t=Math.sign(e),s=Math.sign(i);this.room.game.shakeScreen(5*t,5*s),this.dead=!0}const o=Math.abs(e)>=Math.abs(i),a=o?1:.25,r=o?.25:1;this.renderRect(this.x,this.y,a,r,"white")},this.room=t,this.startX=e,this.startY=i,this.endX=s,this.endY=a,this.x=e,this.y=i,this.dead=!1,this.t=0,this.speed=2}}e.ArrowParticle=a},6822:(t,e)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.PlayerActionProcessor=void 0,e.PlayerActionProcessor=class{constructor(t){this.player=t}process(t){try{this.player.game.replayManager?.recordAction(t)}catch{}switch(t.type){case"Move":this.player.movement.move(t.direction,t.targetX,t.targetY);break;case"MouseMove":this.player.movement.moveMouse(t.direction,t.targetX,t.targetY);break;case"OpenInventory":this.player.inventory.open();break;case"CloseInventory":this.player.inventory.close();break;case"InventoryLeft":this.player.inventory.leftQuickbar();break;case"InventoryRight":this.player.inventory.rightQuickbar();break;case"InventoryUse":this.player.inventory.spaceQuickbar();break;case"InventoryDrop":this.player.inventory.drop();break;case"InventorySelect":this.player.inventory.selX=Math.max(0,Math.min(t.index,this.player.inventory.cols-1)),this.player.inventory.selY=0,this.player.inventory.spaceQuickbar();break;case"InventoryMove":{const e=Math.max(0,Math.min(t.fromIndex,this.player.inventory.cols*(this.player.inventory.rows+this.player.inventory.expansion)-1)),i=Math.max(0,Math.min(t.toIndex,this.player.inventory.cols*(this.player.inventory.rows+this.player.inventory.expansion)-1)),s=this.player.inventory.items[e];if(s){const t=this.player.inventory.items[i];this.player.inventory.items[e]=t,this.player.inventory.items[i]=s}break}case"Restart":this.player.restart();break;case"Attack":console.warn("Attack action received but not yet implemented.");break;case"Interact":this.player.tryMove(t.target.x,t.target.y)}}}},6986:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Enemy=void 0;const s=i(606),o=i(7851),a=i(1085),r=i(7455),n=i(606),h=i(2502),l=i(6199),c=i(2247),d=i(9467),m=i(8287);var u;!function(t){t[t.SLEEP=0]="SLEEP",t[t.AGGRO=1]="AGGRO",t[t.ATTACK=2]="ATTACK",t[t.DEAD=3]="DEAD",t[t.IDLE=4]="IDLE"}(u||(u={}));class p extends s.Entity{constructor(t,e,i,s){super(t,e,i,s),this.justHurt=!1,this.hit=()=>this.damage,this.alertNearbyEnemies=()=>{if(!this.seenPlayer)return;const t=this.nearestPlayer();if(!1===t)return;const e=this.room.entities.filter(t=>t instanceof p);for(const i of e)i!==this&&l.Utils.distance(this.x,this.y,i.x,i.y)<=m.GameplaySettings.BASE_ENEMY_ALERT_NEARBY_RANGE&&i instanceof p&&!i.seenPlayer&&i.ticks>=1&&(i.handleSeenPlayer(t[1],!1),i.alertTicks=2)},this.handleEnemyCase=t=>{t&&t&&(this.aggro=!0,this.targetPlayer=t,t===this.game.players[this.game.localPlayerID]&&(this.alertTicks=2))},this.poison=()=>{this.status.poison.active||(this.status.poison={active:!0,hitCount:0,startTick:this.ticks,effectTick:this.ticks%3},this.shadeColor="#00FF00")},this.bleed=()=>{this.status.bleed.active||(this.status.bleed={active:!0,hitCount:0,startTick:this.ticks,effectTick:this.ticks%1})},this.tickPoison=()=>{this.status.poison.active&&this.targetPlayer&&this.ticks%3===this.status.poison.effectTick&&this.ticks!==this.status.poison.startTick&&this.health>=1&&(this.hurt(this.targetPlayer,1,"poison"),this.shadeColor="#00FF00")},this.tickBleed=()=>{this.status.bleed.active&&this.targetPlayer&&this.ticks%1===this.status.bleed.effectTick&&this.ticks!==this.status.bleed.startTick&&(this.hurt(this.targetPlayer,.5,"blood"),this.shadeColor="#FF0000",this.status.bleed.hitCount++,this.status.bleed.hitCount>=4&&(this.status.bleed={active:!1,hitCount:0,startTick:0,effectTick:0}))},this.tick=()=>{this.tickPoison(),this.tickBleed(),this.behavior(),this.x===this.lastX&&this.y===this.lastY||this.emitEntityData(),this.shielded&&this.shield.updateLightSourcePos(),this.alertNearbyEnemies()},this.lookForPlayer=(t=!0)=>{if(this.seenPlayer)return;const e=this.nearestPlayer();if(!1===e)return;const[i,s]=e;i>this.alertRange||(this.handleSeenPlayer(s,t),this.makeHitWarnings())},this.handleSeenPlayer=(t,e=!0)=>{this.targetPlayer=t,e&&this.facePlayer(t),this.seenPlayer=!0,h.globalEventBus.emit("EnemySeenPlayer",{enemyType:this.constructor.name,enemyName:this.name}),t===this.game.players[this.game.localPlayerID]&&(this.alertTicks=1)},this.getDisablePositions=()=>{let t=Array();for(const e of this.room.entities)e!==this&&t.push({x:e.x,y:e.y});for(let e=this.x-1;e<=this.x+1;e++)for(let i=this.y-1;i<=this.y+1;i++)this.room.roomArray[e][i]instanceof r.SpikeTrap&&this.room.roomArray[e][i].on&&t.push({x:e,y:i});return t},this.findPath=()=>{let t=Array();for(const e of this.room.entities)e!==this&&t.push({x:e.x,y:e.y});for(let e=this.x-1;e<=this.x+1;e++)for(let i=this.y-1;i<=this.y+1;i++)this.room.roomArray[e][i]instanceof r.SpikeTrap&&this.room.roomArray[e][i].on&&t.push({x:e,y:i});this.searchPathLocalized(this.targetPlayer,t)},this.handleSkipTurns=()=>this.skipNextTurns>0&&(1===this.skipNextTurns&&this.makeHitWarnings(),this.skipNextTurns--,!0),this.behavior=()=>{if(this.lastX=this.x,this.lastY=this.y,!this.dead){if(this.handleSkipTurns())return;if(this.ticks++,this.seenPlayer){if(this.seenPlayer){if(this.room.playerTicked===this.targetPlayer){this.alertTicks=Math.max(0,this.alertTicks-1);let t=this.x,e=this.y,i=Array();for(const t of this.room.entities)t!==this&&i.push({x:t.x,y:t.y});for(let t=this.x-1;t<=this.x+1;t++)for(let e=this.y-1;e<=this.y+1;e++)this.room.roomArray[t][e]instanceof r.SpikeTrap&&this.room.roomArray[t][e].on&&i.push({x:t,y:e});let s=this.searchPathLocalized(this.targetPlayer,i);if(s.length>0){let i=s[0].pos.x,a=s[0].pos.y,r=this.direction,n=this.targetPlayer;if(this.facePlayer(n),i>t?this.direction=o.Direction.RIGHT:i<t?this.direction=o.Direction.LEFT:a>e?this.direction=o.Direction.DOWN:a<e&&(this.direction=o.Direction.UP),r==this.direction){let t=!1;for(const t in this.game.players)this.game.rooms[this.game.players[t].levelID]===this.room&&this.game.players[t].x===i&&this.game.players[t].y===a&&(this.game.players[t].hurt(this.hit(),this.name),this.drawX=.5*(this.x-this.game.players[t].x),this.drawY=.5*(this.y-this.game.players[t].y),this.game.players[t]===this.game.players[this.game.localPlayerID]&&this.game.shakeScreen(10*this.drawX,10*this.drawY));t||(this.tryMove(i,a),this.setDrawXY(i,a),this.x>i?this.direction=o.Direction.RIGHT:this.x<i?this.direction=o.Direction.LEFT:this.y>a?this.direction=o.Direction.DOWN:this.y<a&&(this.direction=o.Direction.UP))}}this.direction==o.Direction.LEFT&&(i.push({x:this.x,y:this.y+1}),i.push({x:this.x,y:this.y-1})),this.direction==o.Direction.RIGHT&&(i.push({x:this.x,y:this.y+1}),i.push({x:this.x,y:this.y-1})),this.direction==o.Direction.DOWN&&(i.push({x:this.x+1,y:this.y}),i.push({x:this.x-1,y:this.y})),this.direction==o.Direction.UP&&(i.push({x:this.x+1,y:this.y}),i.push({x:this.x-1,y:this.y})),this.makeHitWarnings()}let t=-1!==Object.values(this.game.offlinePlayers).indexOf(this.targetPlayer);if(!this.aggro||t){let e=this.nearestPlayer();if(!1!==e){let[i,s]=e;i<=4&&(t||i<this.playerDistance(this.targetPlayer))&&s!==this.targetPlayer&&(this.targetPlayer=s,this.facePlayer(s),s===this.game.players[this.game.localPlayerID]&&(this.alertTicks=1),this.makeHitWarnings())}}}}else this.lookForPlayer()}},this.onHurt=(t=1,e="none")=>{this.health>0&&"none"===e&&(this.justHurt=!0)},this.stun=()=>{this.stunned||(this.stunned=!0,this.unconscious=!0,new c.StunAnimation(this,this.x,this.y))},this.retreat=(t,e)=>{let i=this.x-this.targetPlayer.x,s=this.y-this.targetPlayer.y,o=Math.sqrt(i*i+s*s);o>0&&(i=Math.round(i/o),s=Math.round(s/o));let a=this.x,r=this.y,n=!1;if(this.orthogonalAttack&&this.diagonalAttack)if(a=this.x+i,r=this.y+s,this.room.isTileEmpty(a,r))n=!0;else{0===s&&(s=d.Random.rand()<.5?1:-1),0===i&&(i=d.Random.rand()<.5?1:-1);let t=this.x-s,e=this.y+i,o=this.x+s,h=this.y-i,l=d.Random.rand()<.5,c=l?t:o,m=l?e:h,u=l?o:t,p=l?h:e;this.room.isTileEmpty(c,m)?(a=c,r=m,n=!0):this.room.isTileEmpty(u,p)&&(a=u,r=p,n=!0)}else if(this.orthogonalAttack)a=this.x+i,r=this.y+s,this.room.isTileEmpty(a,r)&&(n=!0);else if(this.diagonalAttack){0===s&&(s=d.Random.rand()<.5?1:-1),0===i&&(i=d.Random.rand()<.5?1:-1);let t=this.x-s,e=this.y+i,o=this.x+s,h=this.y-i,l=d.Random.rand()<.5,c=l?t:o,m=l?e:h,u=l?o:t,p=l?h:e;this.room.isTileEmpty(c,m)?(a=c,r=m,n=!0):this.room.isTileEmpty(u,p)&&(a=u,r=p,n=!0)}n&&(this.tryMove(a,r),this.setDrawXY(t,e)),this.justHurt=!1},this.jump=t=>{let e=Math.max(Math.abs(this.drawX),Math.abs(this.drawY));this.jumpY=Math.abs(Math.sin(e*Math.PI))*this.jumpHeight,this.jumpY<.01&&(this.jumpY=0),this.jumpY>this.jumpHeight&&(this.jumpY=this.jumpHeight)},this.updateDrawXY=t=>{this.updateHurtFrame(t),this.animateDying(t),this.doneMoving()||(this.drawX*=this.drawMoveSpeed**t,this.drawY*=this.drawMoveSpeed**t,this.drawX=Math.abs(this.drawX)<.01?0:this.drawX,this.drawY=Math.abs(this.drawY)<.01?0:this.drawY,this.jump(t)),this.updateShadeColor(t)},this.setDrawXY=(t,e)=>{this.drawX+=this.x-t,this.drawY+=this.y-e},this.teleport=()=>{let t=this.findFarTile();t&&(this.drawX=t.x-this.x,this.drawY=t.y-this.y,this.x=t.x,this.y=t.y,this.lightSource?.updatePosition(this.x+.5,this.y+.5),this.room.updateLighting())},this.findFarTile=()=>{const t=this.room.getEmptyTiles(),e=this.getPlayer();if(!e||0===t.length)return null;const i=t.map(t=>({tile:t,distance:l.Utils.distance(t.x,t.y,e.x,e.y)}));i.sort((t,e)=>e.distance-t.distance);const s=i.slice(0,Math.floor(i.length/2));return 0===s.length?null:s[Math.floor(d.Random.rand()*s.length)].tile},this.draw=t=>{this.dead||(this.updateDrawXY(t),this.frame+=.1*t,this.frame>=4&&(this.frame=0),this.hasShadow&&this.drawShadow(t),o.Game.drawMob(this.tileX+Math.floor(this.frame),this.tileY+2*this.direction,1,2,this.x-this.drawX,this.y-this.drawYOffset-this.drawY-this.jumpY,1,2,this.softShadeColor,this.shadeAmount())),this.dying||(this.seenPlayer||this.drawSleepingZs(t),this.alertTicks>0&&this.drawExclamation(t))},this.drawYOffset=1.5,this.name="",this.seenPlayer=!1,this.heardPlayer=!1,this.ticks=0,this.frame=0,this.health=1,this.maxHealth=1,this.tileX=17,this.tileY=8,this.aggro=!1,this.jumpY=0,this.jumpHeight=.3,this.name="generic enemy",this.dropChance=10,this.status={poison:{active:!1,hitCount:0,startTick:0,effectTick:0},bleed:{active:!1,hitCount:0,startTick:0,effectTick:0}},this.alertRange=m.GameplaySettings.BASE_ENEMY_ALERT_RANGE,this.effectStartTick=1,this.startTick=1,this.isEnemy=!0,this.poisonHitCount=0,this.bleedHitCount=0,this.drawMoveSpeed=.85,this.justHurt=!1,this.orthogonalAttack=!1,this.diagonalAttack=!1,this.baseDamage=1}get damage(){return this.buffed?2*this.baseDamage:this.baseDamage}searchPathLocalized(t,e,i){const s=m.GameplaySettings.MAXIMUM_ENEMY_INTERACTION_DISTANCE,o=Math.min(this.x,t.x),r=Math.max(this.x,t.x),n=Math.min(this.y,t.y),h=Math.max(this.y,t.y);let l=Math.max(this.room.roomX,o-3),c=Math.min(this.room.roomX+this.room.width-1,r+3),d=Math.max(this.room.roomY,n-3),u=Math.min(this.room.roomY+this.room.height-1,h+3);const p=Math.floor((this.x+t.x)/2),y=Math.floor((this.y+t.y)/2),g=Math.floor(s/2);l=Math.min(l,p-g),c=Math.max(c,p+g),d=Math.min(d,y-g),u=Math.max(u,y+g),l=Math.max(this.room.roomX,l),c=Math.min(this.room.roomX+this.room.width-1,c),d=Math.max(this.room.roomY,d),u=Math.min(this.room.roomY+this.room.height-1,u);const f=c-l+1,w=u-d+1,E=[];for(let t=0;t<f;t++){E[t]=[];for(let e=0;e<w;e++){const i=l+t,s=d+e;this.room.roomArray[i]&&this.room.roomArray[i][s]?E[t][e]=this.room.roomArray[i][s]:E[t][e]=!1}}const x=(e||[]).filter(t=>t.x>=l&&t.x<=c&&t.y>=d&&t.y<=u).map(t=>({x:t.x-l,y:t.y-d})),b={...this,x:this.x-l,y:this.y-d},T={...t,x:t.x-l,y:t.y-d},I=i?.useLastPlayerPos?i?.lastPlayerPos?{x:i.lastPlayerPos.x-l,y:i.lastPlayerPos.y-d}:this.targetPlayer?{x:this.targetPlayer.lastX-l,y:this.targetPlayer.lastY-d}:void 0:void 0;let S;S=i?.useLastPlayerPos?a.astar.AStar.search(E,b,T,x,i?.diagonals??!1,i?.diagonalsOnly??!1,!1,void 0,void 0,!1,I):a.astar.AStar.search(E,b,T,x,i?.diagonals??!1,i?.diagonalsOnly??!1,i?.allowOmni??!0,i?.direction??this.direction);for(const t of S)t.pos.x=t.pos.x+l,t.pos.y=t.pos.y+d;return S}get lastPlayerPos(){return{x:this.targetPlayer.lastX,y:this.targetPlayer.lastY}}get type(){return n.EntityType.ENEMY}}e.Enemy=p,p.difficulty=1},7053:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.PartitionGenerator=e.PartialLevel=e.Partition=e.PartitionConnection=e.PathType=void 0;const s=i(7851),o=i(4118),a=i(9467),r=i(5350),n=i(3172);var h;(h=e.PathType||(e.PathType={}))[h.MAIN_PATH=0]="MAIN_PATH",h[h.SIDE_PATH=1]="SIDE_PATH",h[h.TUTORIAL=2]="TUTORIAL";class l{constructor(t,e,i){this.x=t,this.y=e,this.other=i}}e.PartitionConnection=l;class c{constructor(t,e,i,s,r){this.split=async()=>{this.isTopOpen=!0,this.isRightOpen=!0,this.isBottomOpen=!0,this.isLeftOpen=!0;let t=()=>.6*(a.Random.rand()-.5)+.5;if(this.w>this.h){let e=Math.floor(t()*this.w),i=this.w-e-1;return e<4||i<4?[this]:[new c(this.x,this.y,e,this.h,this.fillStyle),new c(this.x+e+1,this.y,i,this.h,this.fillStyle)]}{let e=Math.floor(t()*this.h),i=this.h-e-1;return e<4||i<4?[this]:[new c(this.x,this.y,this.w,e,this.fillStyle),new c(this.x,this.y+e+1,this.w,i,this.fillStyle)]}},this.point_in=(t,e)=>t>=this.x&&t<this.x+this.w&&e>=this.y&&e<this.y+this.h,this.point_next_to=(t,e)=>t>=this.x-1&&t<this.x+this.w+1&&e>=this.y&&e<this.y+this.h||t>=this.x&&t<this.x+this.w&&e>=this.y-1&&e<this.y+this.h+1,this.area=()=>this.w*this.h,this.overlaps=t=>t.x<this.x+this.w+1&&t.x+t.w>this.x-1&&t.y<this.y+this.h+1&&t.y+t.h>this.y-1,this.setOpenWall=t=>{t.y===this.y-1&&t.x>=this.x&&t.x<this.x+this.w&&(this.isTopOpen=!1),t.y===this.y+this.h&&t.x>=this.x&&t.x<this.x+this.w&&(this.isBottomOpen=!1),t.x===this.x+this.w&&t.y>=this.y&&t.y<this.y+this.h&&(this.isRightOpen=!1),t.x===this.x-1&&t.y>=this.y&&t.y<this.y+this.h&&(this.isLeftOpen=!1)},this.get_branch_point=()=>{let t=[];for(let e=this.x;e<this.x+this.w;e++)t.push({x:e,y:this.y-1}),t.push({x:e,y:this.y+this.h});for(let e=this.y;e<this.y+this.h;e++)t.push({x:this.x-1,y:e}),t.push({x:this.x+this.w,y:e});return t=t.filter(t=>!this.connections.some(e=>Math.abs(e.x-t.x)+Math.abs(e.y-t.y)<=1)),t.sort(()=>.5-a.Random.rand()),t[0]},this.x=t,this.y=e,this.w=i,this.h=s,this.fillStyle=r,this.type=o.RoomType.DUNGEON,this.connections=[],this.distance=1e3,this.isTopOpen=!0,this.isRightOpen=!0,this.isBottomOpen=!0,this.isLeftOpen=!0,this.pathIndex=0}}e.Partition=c;class d{constructor(){this.partitions=[]}}e.PartialLevel=d,e.PartitionGenerator=class{constructor(t){this.validator=new r.LevelValidator(t),this.visualizer=new n.GenerationVisualizer(t)}async generateDungeonPartitions(t,e,i,s,o,a){const r=new d;let n,h=0;this.visualizer.updateProgress("Starting dungeon generation",0);do{h++,this.visualizer.updateProgress(`Generating candidate ${h}`,.1*h),await this.generateDungeonCandidate(t,r,e,i,s,o,a),n=this.validator.validateDungeonPartitions(r.partitions,o),this.visualizer.setVisualizationState(r.partitions,e/2,i/2,"validating",.8)}while(!n.isValid);return this.visualizer.updateProgress("Finalizing generation",.9),await this.visualizer.createAnimationDelay("large"),this.visualizer.createVisualEffect("generation_complete"),this.visualizer.updateProgress("Generation complete",1),console.log("finished generation"),r.partitions}async generateCavePartitions(t){const e=new d;let i,s=0;const o=t.mapWidth??50,a=t.mapHeight??50,r=t.caveRooms??8,n="number"==typeof t.linearity,h="number"==typeof t.branching?t.branching:n?Math.max(0,Math.min(1,1-t.linearity)):.5,l="number"==typeof t.loopiness?t.loopiness:n?Math.max(0,Math.min(1,1-t.linearity)):.5;this.visualizer.updateProgress("Starting cave generation",0);do{s++,this.visualizer.updateProgress(`Generating cave candidate ${s}`,.1*s),t.giantCentralRoom?await this.generateCaveCandidateWithGiantCenter(e,o,a,r,h,l,t.giantRoomScale??.65):await this.generateCaveCandidate(e,o,a,r,h,l),i=this.validator.validateCavePartitions(e.partitions,r),this.visualizer.setVisualizationState(e.partitions,o/2,a/2,"validating cave",.8)}while(!i.isValid);return this.visualizer.updateProgress("Cave generation complete",1),e.partitions}generateTutorialPartitions(t=7,e=7){const i=[new c(0,0,t,e,"white")];i[0].type=o.RoomType.TUTORIAL;const s=this.validator.validateTutorialPartitions(i);if(!s.isValid)throw new Error(`Tutorial validation failed: ${s.errorMessage}`);return i}async generateDungeonCandidate(t,e,i,s,r,n,h){const{minRoomCount:l,maxRoomCount:d,maxRoomArea:m,splitProbabilities:u,wallRemoveProbability:p,softMaxRoomArea:y}=n;for(e.partitions=[new c(0,0,i,s,"white")],this.visualizer.updateProgress("Splitting partitions",.1),this.visualizer.setVisualizationState(e.partitions,i/2,s/2,"splitting");e.partitions.length<n.maxRoomCount;)for(let t=0;t<u.length;t++)e.partitions=await this.splitPartitions(e.partitions,u[t]),this.visualizer.setVisualizationState(e.partitions,i/2,s/2,"splitting",.1+t/u.length*.2);for(let t=0;t<100;t++)e.partitions.forEach(async t=>{let i=a.Random.rand()>.95?y:m;t.area()>i&&(e.partitions=e.partitions.filter(e=>e!==t),e.partitions=e.partitions.concat(await this.splitPartition(t,.5)))});if(this.visualizer.updateProgress("Removing wall rooms",.4),e.partitions=this.removeWallRooms(e.partitions,i,s,p),await this.visualizer.createAnimationDelay("large"),0===e.partitions.length)return void(e.partitions=[]);if(this.visualizer.updateProgress("Assigning room types",.5),e.partitions.sort((t,e)=>t.area()-e.area()),this.visualizer.updatePartitionStyles(e.partitions),0===e.partitions.length)return void(e.partitions=[]);let g=e.partitions[0];g?(g.type=o.RoomType.START,g.fillStyle="rgb(0, 255, 0)",e.partitions.length>1&&(e.partitions[e.partitions.length-1].type=o.RoomType.BOSS,e.partitions[e.partitions.length-1].fillStyle="red"),this.visualizer.updateProgress("Connecting partitions",.6),await this.connectPartitions(e,g,h?.branching),this.visualizer.updateProgress("Adding loop connections",.7),e.partitions.length>0&&await this.addLoopConnections(e,h?.loopiness),this.visualizer.updateProgress("Adding stair room",.8),e.partitions.length>0&&await this.addStairRoom(e,t),this.visualizer.updateProgress("Calculating distances",.9),e.partitions.length>0&&(await this.calculateDistances(e,g),await this.addSpecialRooms(e))):e.partitions=[]}async generateCaveCandidate(t,e,i,s,a=.5,r=.5){t.partitions=[new c(100,100,e,i,"white")];for(let e=0;e<9;e++)t.partitions=await this.splitPartitions(t.partitions,.75);if(t.partitions.sort((t,e)=>t.area()-e.area()),0===t.partitions.length)throw new Error("No partitions generated.");let n=t.partitions[0];n.type=o.RoomType.ROPECAVE;for(let e=1;e<t.partitions.length;e++)t.partitions[e].type=o.RoomType.CAVE;await this.connectCavePartitions(t,n,s,a),await this.addCaveLoops(t,r),await this.calculateDistances(t,n)}async generateCaveCandidateWithGiantCenter(t,e,i,r,n=.5,h=.5,d=.65){const m=100;t.partitions=[];const u=Math.max(6,Math.floor(e*Math.max(.4,Math.min(.9,d)))),p=Math.max(6,Math.floor(i*Math.max(.4,Math.min(.9,d)))),y=m+Math.floor((e-u)/2),g=m+Math.floor((i-p)/2),f=new c(y,g,u,p,"white");f.type=o.RoomType.BIGCAVE,t.partitions.push(f);const w=Math.max(4,r-1);let E=0;for(;t.partitions.length<w+1&&E<400;){E++;const r=Math.max(3,Math.floor(a.Random.rand()*Math.max(3,.25*e)+3)),n=Math.max(3,Math.floor(a.Random.rand()*Math.max(3,.25*i)+3)),h=Math.floor(4*a.Random.rand());let l=0,d=0;if(0===h){l=f.x-1-r;const t=Math.max(m,f.y-n+1),e=Math.min(m+i-n,f.y+f.h-1);if(t>e)continue;d=m+s.Game.rand(t-m,e-m,a.Random.rand)}else if(1===h){l=f.x+f.w+1;const t=Math.max(m,f.y-n+1),e=Math.min(m+i-n,f.y+f.h-1);if(t>e)continue;d=m+s.Game.rand(t-m,e-m,a.Random.rand)}else if(2===h){d=f.y-1-n;const t=Math.max(m,f.x-r+1),i=Math.min(m+e-r,f.x+f.w-1);if(t>i)continue;l=m+s.Game.rand(t-m,i-m,a.Random.rand)}else{d=f.y+f.h+1;const t=Math.max(m,f.x-r+1),i=Math.min(m+e-r,f.x+f.w-1);if(t>i)continue;l=m+s.Game.rand(t-m,i-m,a.Random.rand)}if(l<m||d<m)continue;if(l+r>m+e||d+n>m+i)continue;const u=new c(l,d,r,n,"white");u.type=o.RoomType.CAVE,t.partitions.some(t=>t.overlaps(u))||t.partitions.push(u)}for(let e=1;e<t.partitions.length;e++){const i=t.partitions[e];let s=0,o=0;if(i.x+i.w===f.x-1)s=f.x-1,o=Math.max(f.y,Math.min(i.y+Math.floor(i.h/2),f.y+f.h-1));else if(i.x===f.x+f.w+1)s=f.x+f.w,o=Math.max(f.y,Math.min(i.y+Math.floor(i.h/2),f.y+f.h-1));else if(i.y+i.h===f.y-1)o=f.y-1,s=Math.max(f.x,Math.min(i.x+Math.floor(i.w/2),f.x+f.w-1));else{if(i.y!==f.y+f.h+1)continue;o=f.y+f.h,s=Math.max(f.x,Math.min(i.x+Math.floor(i.w/2),f.x+f.w-1))}f.connections.push(new l(s,o,i)),i.connections.push(new l(s,o,f))}const x=t.partitions.filter(t=>t!==f);if(x.length>0){let t=x[0];for(let e=1;e<x.length;e++)x[e].area()<t.area()&&(t=x[e]);if(t.type=o.RoomType.ROPECAVE,x.length>1&&a.Random.rand()<.33){const e=x.filter(e=>e!==t);e.length>0&&(e[s.Game.rand(0,e.length-1,a.Random.rand)].type=o.RoomType.GEMCAVE)}}else f.type=o.RoomType.ROPECAVE;await this.addCaveLoops(t,h),await this.calculateDistances(t,f)}async splitPartitions(t,e){for(let i of t)a.Random.rand()<e&&(this.visualizer.createVisualEffect("partition_split",i),t=(t=t.filter(t=>t!==i)).concat(await i.split()));return t}async splitPartition(t,e){return a.Random.rand()<e?await t.split():[t]}getWallRooms(t,e,i){return t.filter(s=>{const o=o=>{switch(o){case"left":for(let e=s.y;e<s.y+s.h;e++)if(!t.some(t=>t!==s&&t.y<=e&&e<t.y+t.h&&t.x+t.w>0&&t.x+t.w<=s.x))return!0;return!1;case"right":for(let i=s.y;i<s.y+s.h;i++)if(!t.some(t=>t!==s&&t.y<=i&&i<t.y+t.h&&t.x<e&&t.x>=s.x+s.w))return!0;return!1;case"top":for(let e=s.x;e<s.x+s.w;e++)if(!t.some(t=>t!==s&&t.x<=e&&e<t.x+t.w&&t.y+t.h>0&&t.y+t.h<=s.y))return!0;return!1;case"bottom":for(let e=s.x;e<s.x+s.w;e++)if(!t.some(t=>t!==s&&t.x<=e&&e<t.x+t.w&&t.y<i&&t.y>=s.y+s.h))return!0;return!1;default:return!1}};return 1===[o("left"),o("right"),o("top"),o("bottom")].filter(Boolean).length})}removeWallRooms(t,e,i,s=1){const o=this.getWallRooms(t,e,i);for(const e of o)a.Random.rand()<s&&(t=t.filter(t=>t!==e));return t}async connectPartitions(t,e,i){let s=[e],r=[e],n=!1;for(;r.length>0&&!n;){let h=r[0];h!==e&&this.visualizer.createVisualEffect("room_connected",h),r.splice(0,1);let c=0;const d=void 0===i?Math.floor(2*a.Random.rand()+1):1+(a.Random.rand()<Math.max(0,Math.min(1,i))?1:0);let m=0;const u=1e3;for(;c<d&&m<u;){let e=h.get_branch_point();for(const i of t.partitions)if(i!==h&&-1===s.indexOf(i)&&i.point_next_to(e.x,e.y)){h.connections.push(new l(e.x,e.y,i)),i.connections.push(new l(e.x,e.y,h)),h.setOpenWall(new l(e.x,e.y,i)),i.setOpenWall(new l(e.x,e.y,h)),r.push(i),s.push(i),c++,i.type===o.RoomType.BOSS&&(n=!0,this.visualizer.createVisualEffect("boss_found",i));break}m++}await this.visualizer.createAnimationDelay("pathfinding")}for(const e of t.partitions)0===e.connections.length&&(t.partitions=t.partitions.filter(t=>t!==e))}async connectCavePartitions(t,e,i,s=.5){let o=[e],r=[e];for(;r.length>0&&o.length<i;){let e=r[0];r.splice(0,1);let n=0;const h=Math.max(0,Math.min(1,s)),c=1+(a.Random.rand()<h?1:0);let d=0;const m=1e3;for(;n<c&&d<m&&o.length<i;){let i=e.get_branch_point();if(!i)break;for(const s of t.partitions)if(s!==e&&-1===o.indexOf(s)&&s.point_next_to(i.x,i.y)){e.connections.push(new l(i.x,i.y,s)),s.connections.push(new l(i.x,i.y,e)),r.push(s),o.push(s),n++;break}d++}}if(t.partitions=t.partitions.filter(t=>t.connections.length>0),0===t.partitions.length)throw new Error("No valid rooms after filtering.")}async addLoopConnections(t,e){if(0===t.partitions.length)return;let i=void 0===e?Math.floor(4*a.Random.rand()+4):Math.floor((4*a.Random.rand()+4)*Math.max(0,Math.min(1,e)));for(let e=0;e<i&&0!==t.partitions.length;e++){let e=Math.floor(a.Random.rand()*t.partitions.length),i=t.partitions[e];if(!i)continue;let s=!1,o=0;const r=10;let n=t.partitions.filter(t=>t&&!i.connections.some(e=>e.other===t));for(;!s&&o<r;){let t=i.get_branch_point();if(!t)break;for(const e of n)if(e&&e!==i&&e.point_next_to(t.x,t.y)){i.connections.push(new l(t.x,t.y,e)),e.connections.push(new l(t.x,t.y,i)),i.setOpenWall(new l(t.x,t.y,e)),e.setOpenWall(new l(t.x,t.y,i)),s=!0;break}o++}}}async addCaveLoops(t,e=.5){if(0===t.partitions.length)return;let i=Math.floor((4*a.Random.rand()+4)*Math.max(0,Math.min(1,e)));for(let e=0;e<i&&0!==t.partitions.length;e++){let e=Math.floor(a.Random.rand()*t.partitions.length),i=t.partitions[e];if(!i)continue;let s=!1,o=0;const r=100;let n=t.partitions.filter(t=>t&&!i.connections.some(e=>e.other===t));for(;!s&&o<r;){let t=i.get_branch_point();if(!t)break;for(const e of n)if(e&&e!==i&&e.point_next_to(t.x,t.y)){i.connections.push(new l(t.x,t.y,e)),e.connections.push(new l(t.x,t.y,i)),s=!0;break}o++}}}async addStairRoom(t,e){if(!t.partitions.some(t=>t.type===o.RoomType.BOSS))return void(t.partitions=[]);let i=t.partitions.find(t=>t.type===o.RoomType.BOSS),r=!1;for(let e=0;e<5;e++){let e=new c(s.Game.rand(i.x-1,i.x+i.w-2,a.Random.rand),i.y-5-1,7,5,"white");if(e.type=o.RoomType.DOWNLADDER,e.fillStyle="blue",!t.partitions.some(t=>t.overlaps(e))){r=!0,t.partitions.push(e),e.connections.push(new l(e.x+1,e.y+5,i)),i.connections.push(new l(e.x+1,e.y+5,e)),e.setOpenWall(new l(e.x+1,e.y+5,i)),i.setOpenWall(new l(e.x+1,e.y+5,e));break}}r||(console.log("No stair found"),t.partitions=[])}async calculateDistances(t,e){let i=[e],s=[];for(e.distance=0;i.length>0;){let t=i[0];i.splice(0,1),s.push(t);for(let e of t.connections){let o=e.other;o.distance=Math.min(o.distance,t.distance+1),-1===s.indexOf(o)&&i.push(o)}}}async addSpecialRooms(t){for(const e of t.partitions)e.type===o.RoomType.DUNGEON&&e.distance>4&&e.area()<=30&&a.Random.rand()<0&&(e.type=o.RoomType.TREASURE);await this.visualizer.createAnimationDelay("large")}getVisualizer(){return this.visualizer}}},7064:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.SmallBush=void 0;const s=i(606),o=i(7851),a=i(606);class r extends s.Entity{constructor(t,e,i,s){super(t,e,i,s),this.draw=t=>{this.dead||(o.Game.ctx.save(),o.Game.ctx.globalAlpha=this.alpha,this.dead||(this.hasShadow&&this.drawShadow(t),this.updateDrawXY(t),o.Game.drawObj(this.tileX,this.tileY,1,2,this.x-this.drawX,this.y-this.drawYOffset-this.drawY,1,2,this.room.shadeColor,this.shadeAmount())),o.Game.ctx.restore())},this.drawTopLayer=t=>{this.drawableY=this.y},this.room=t,this.health=1,this.tileX=16,this.tileY=2,this.hasShadow=!0,this.chainPushable=!1,this.name="small bush",this.imageParticleX=0,this.imageParticleY=28}get type(){return a.EntityType.PROP}}e.SmallBush=r},7135:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.RoomBuilder=void 0;const s=i(7851),o=i(8287),a=i(3384),r=i(9200),n=i(4118);e.RoomBuilder=class{constructor(t){this.getWallType=(t,e,i,s,o,a)=>{let r=[];return e===s&&t>=i&&t<=i+o&&r.push(n.WallDirection.NORTH),e===s+a&&t>=i&&t<=i+o&&r.push(n.WallDirection.SOUTH),t===i&&e>=s&&e<=s+a&&r.push(n.WallDirection.WEST),t===i+o&&e>=s&&e<=s+a&&r.push(n.WallDirection.EAST),r},this.countWallNeighbors=t=>{let e=0;for(let i=t.x-1;i<=t.x+1;i++)for(let s=t.y-1;s<=t.y+1;s++)this.room.roomArray[i]?.[s]instanceof r.Wall&&(i!==t.x||s!==t.y)&&e++;return e},this.room=t,this.buildEmptyRoom()}buildEmptyRoom(){for(let t=this.room.roomX;t<this.room.roomX+this.room.width;t++)for(let e=this.room.roomY;e<this.room.roomY+this.room.height;e++)this.room.pointInside(t,e,this.room.roomX+1,this.room.roomY+1,this.room.width-2,this.room.height-2)?this.room.roomArray[t][e]=new a.Floor(this.room,t,e):this.room.roomArray[t][e]=new r.Wall(this.room,t,e,this.getWallType(t,e,this.room.roomX,this.room.roomY,this.room.width,this.room.height))}addWallBlocks(t){this.addWallBlocksStandard(t)}addWallBlocksStandard(t){let e=s.Game.randTable([0,0,1,1,2,2,2,2,3],t);this.room.width>8&&t()>.5&&(e*=4);for(let i=0;i<e;i++){let e=Math.min(s.Game.randTable([2,2,2,2,2,2,3,3,3,4,5],t),this.room.width-4),i=Math.min(e+s.Game.rand(-2,2,t),this.room.height-4),o=s.Game.rand(this.room.roomX+2,this.room.roomX+this.room.width-e-2,t),n=s.Game.rand(this.room.roomY+2,this.room.roomY+this.room.height-i-2,t);for(let t=o;t<o+e;t++)for(let e=n;e<n+i;e++){let i=new r.Wall(this.room,t,e);this.room.roomArray[t][e]=i,this.room.innerWalls.push(i)}this.room.innerWalls.forEach(t=>{this.countWallNeighbors(t)<=1&&(this.room.removeWall(t.x,t.y),this.room.roomArray[t.x][t.y]=new a.Floor(this.room,t.x,t.y),this.room.innerWalls=this.room.innerWalls.filter(e=>e!==t))})}}addWallBlocksVariant(t){let e=s.Game.randTable([2,2,3,3,4,5],t);this.room.width>10&&t()>.5&&(e+=2);for(let i=0;i<e;i++){let e=s.Game.randTable([1,2,2,2,3,3],t),i=Math.min(Math.max(1,e),this.room.width-4),o=Math.min(Math.max(1,e+s.Game.rand(-1,1,t)),this.room.height-4),n=s.Game.rand(this.room.roomX+2,this.room.roomX+this.room.width-i-2,t),h=s.Game.rand(this.room.roomY+2,this.room.roomY+this.room.height-o-2,t);for(let e=n;e<n+i;e++)for(let s=h;s<h+o;s++)if(e===n||s===h||e===n+i-1||s===h+o-1||t()>.35){let t=new r.Wall(this.room,e,s);this.room.roomArray[e][s]=t,this.room.innerWalls.push(t)}const l=s.Game.randTable([0,1,1,2],t);for(let e=0;e<l;e++){const e=s.Game.rand(n+1,Math.max(n+1,n+i-2),t),l=s.Game.rand(h+1,Math.max(h+1,h+o-2),t);this.room.roomArray[e]?.[l]instanceof r.Wall&&(this.room.removeWall(e,l),this.room.roomArray[e][l]=new a.Floor(this.room,e,l),this.room.innerWalls=this.room.innerWalls.filter(t=>!(t.x===e&&t.y===l)))}this.room.innerWalls.forEach(t=>{this.countWallNeighbors(t)<=2&&(this.room.removeWall(t.x,t.y),this.room.roomArray[t.x][t.y]=new a.Floor(this.room,t.x,t.y),this.room.innerWalls=this.room.innerWalls.filter(e=>e!==t))})}}addWallBlocksOrganicTunnels(t){const e=!0===o.GameplaySettings.ORGANIC_TUNNELS_DEBUG;e&&console.log("[OrganicTunnels] start",{room:this.room.globalId}),this.fillInteriorWithWalls();const i=this.getDoorEntryPoints(t);if(e&&console.log("[OrganicTunnels] entries",i),0===i.length)return;const a=!0===this.room.level?.organicTunnelsAvoidCenter;if(1===i.length){const e=i[0],s=this.generatePocketTargets(e,4,t);for(const i of s)this.carveOrganicPath(e.x,e.y,i.x,i.y,t,{baseRadius:1.2,radiusJitter:1,pocketChance:.25,pocketRadius:[2,3]});return}if(a)e&&console.log("[OrganicTunnels] perimeter routing enabled"),this.buildPerimeterBiasedNetwork(i,t);else{const s=this.getCenterSpoofEntries(t,[1,2]);if(e&&console.log("[OrganicTunnels] hubs",s),0===s.length){const t=Math.floor(this.room.roomX+this.room.width/2),e=Math.floor(this.room.roomY+this.room.height/2);this.isInterior(t,e)&&s.push({x:t,y:e})}for(const e of i){let i=s[0],o=this.distance(e,i);for(let t=1;t<s.length;t++){const a=this.distance(e,s[t]);a<o&&(o=a,i=s[t])}this.carveOrganicPath(e.x,e.y,i.x,i.y,t,{baseRadius:1.3,radiusJitter:1.2,pocketChance:.2,pocketRadius:[2,4]})}if(s.length>1){const i=this.minimumSpanningEdges(s);e&&console.log("[OrganicTunnels] hub edges",i);for(const e of i)this.carveOrganicPath(e.a.x,e.a.y,e.b.x,e.b.y,t,{baseRadius:1.4,radiusJitter:1.1,pocketChance:.25,pocketRadius:[2,5]})}}const r=s.Game.randTable([0,0,1,2],t);for(let e=0;e<r;e++){const e=i[s.Game.rand(0,i.length-1,t)],o=this.randomInteriorPointNear(e,6,t);this.carveDisk(o.x,o.y,s.Game.randTable([2,3,3,4],t))}const n=this.pruneWallsWithSingleNeighbor(!0);e&&console.log("[OrganicTunnels] pruned single-neighbor walls:",n),e&&console.log("[OrganicTunnels] done")}isInterior(t,e){return t>this.room.roomX&&e>this.room.roomY&&t<this.room.roomX+this.room.width-1&&e<this.room.roomY+this.room.height-1}fillInteriorWithWalls(){for(let t=this.room.roomX+1;t<this.room.roomX+this.room.width-1;t++)for(let e=this.room.roomY+1;e<this.room.roomY+this.room.height-1;e++)if(!(this.room.roomArray[t][e]instanceof r.Wall)){const i=new r.Wall(this.room,t,e);this.room.roomArray[t][e]=i,this.room.innerWalls.push(i)}}carveDisk(t,e,i){const s=i*i,o=Math.floor(t-i),n=Math.ceil(t+i),h=Math.floor(e-i),l=Math.ceil(e+i);for(let i=o;i<=n;i++)for(let o=h;o<=l;o++){if(!this.isInterior(i,o))continue;const n=i-t,h=o-e;n*n+h*h<=s&&(this.room.roomArray[i][o]instanceof r.Wall&&this.room.removeWall(i,o),this.room.roomArray[i][o]=new a.Floor(this.room,i,o),this.room.innerWalls=this.room.innerWalls.filter(t=>t.x!==i||t.y!==o))}}getDoorEntryPoints(t){const e=[],i=this.room.roomX,a=this.room.roomX+this.room.width-1,r=this.room.roomY,n=this.room.roomY+this.room.height-1;for(const t of this.room.doors||[]){const s=t.x,o=t.y;s===i&&this.isInterior(s+1,o)?e.push({x:s+1,y:o}):s===a&&this.isInterior(s-1,o)?e.push({x:s-1,y:o}):o===r&&this.isInterior(s,o+1)?e.push({x:s,y:o+1}):o===n&&this.isInterior(s,o-1)&&e.push({x:s,y:o-1})}if(o.GameplaySettings.ORGANIC_TUNNELS_SPOOF_ENABLED&&t){const h=Math.max(1,0|o.GameplaySettings.ORGANIC_TUNNELS_SPOOF_EDGE_MARGIN),l=e.some(t=>t.x===i+1),c=e.some(t=>t.x===a-1),d=e.some(t=>t.y===r+1),m=e.some(t=>t.y===n-1),u=(o,l)=>{for(let c=0;c<l;c++)if("left"===o){const o=s.Game.rand(r+h,n-h,t);this.isInterior(i+1,o)&&e.push({x:i+1,y:o})}else if("right"===o){const i=s.Game.rand(r+h,n-h,t);this.isInterior(a-1,i)&&e.push({x:a-1,y:i})}else if("top"===o){const o=s.Game.rand(i+h,a-h,t);this.isInterior(o,r+1)&&e.push({x:o,y:r+1})}else if("bottom"===o){const o=s.Game.rand(i+h,a-h,t);this.isInterior(o,n-1)&&e.push({x:o,y:n-1})}},p=Math.max(0,0|o.GameplaySettings.ORGANIC_TUNNELS_SPOOF_PER_WALL_MIN),y=Math.max(p,0|o.GameplaySettings.ORGANIC_TUNNELS_SPOOF_PER_WALL_MAX),g=()=>s.Game.rand(p,y,t);l||u("left",g()),c||u("right",g()),d||u("top",g()),m||u("bottom",g())}return e}distance(t,e){const i=t.x-e.x,s=t.y-e.y;return Math.sqrt(i*i+s*s)}minimumSpanningEdges(t){if(t.length<=1)return[];const e=[t[0]],i=t.slice(1),s=[];for(;i.length>0;){let t=-1,o=-1,a=1/0;for(let s=0;s<e.length;s++)for(let r=0;r<i.length;r++){const n=this.distance(e[s],i[r]);n<a&&(a=n,t=s,o=r)}const r=e[t],n=i[o];s.push({a:r,b:n}),e.push(n),i.splice(o,1)}return s}buildPerimeterBiasedNetwork(t,e){const i=this.getCenterAvoidRect(),s=this.room.roomX+this.room.width/2,o=this.room.roomY+this.room.height/2,a=t.slice().sort((t,e)=>Math.atan2(t.y-o,t.x-s)-Math.atan2(e.y-o,e.x-s)),r={baseRadius:1.25,radiusJitter:1.1,pocketChance:.2,pocketRadius:[2,4]};for(let t=0;t<a.length;t++){const s=a[t],o=a[(t+1)%a.length];this.carveAroundCenter(s,o,i,e,r)}if(a.length>=4){const t=Math.max(2,Math.floor(a.length/2)),s=Math.min(a.length,2);for(let o=0;o<s;o++){const s=a[o],r=a[(o+t)%a.length];s!==r&&this.carveAroundCenter(s,r,i,e,{baseRadius:1.1,radiusJitter:.7,pocketChance:.1,pocketRadius:[2,3]})}}this.ensureEntryConnectivity(a,e)}getCenterAvoidRect(){const t=this.room.roomX+1,e=this.room.roomX+this.room.width-2,i=this.room.roomY+1,s=this.room.roomY+this.room.height-2,o=Math.max(1,e-t),a=Math.max(1,s-i),r=Math.max(1,Math.floor(.25*o)),n=Math.max(1,Math.floor(.25*a));return{minX:t+r,maxX:e-r,minY:i+n,maxY:s-n}}carveAroundCenter(t,e,i,s,o){if(!this.segmentCrossesRect(t,e,i))return void this.carveOrganicPath(t.x,t.y,e.x,e.y,s,o);const a=this.choosePerimeterWaypoint(t,e,i,s);a?(this.carveOrganicPath(t.x,t.y,a.x,a.y,s,o),this.carveOrganicPath(a.x,a.y,e.x,e.y,s,o)):this.carveOrganicPath(t.x,t.y,e.x,e.y,s,o)}segmentCrossesRect(t,e,i){const s=Math.max(4,Math.ceil(Math.max(Math.abs(t.x-e.x),Math.abs(t.y-e.y))));for(let o=0;o<=s;o++){const a=o/s,r=t.x+(e.x-t.x)*a,n=t.y+(e.y-t.y)*a;if(r>i.minX&&r<i.maxX&&n>i.minY&&n<i.maxY)return!0}return!1}choosePerimeterWaypoint(t,e,i,s){const o=1.5,a=this.room.roomX+1,r=this.room.roomX+this.room.width-2,n=this.room.roomY+1,h=this.room.roomY+this.room.height-2,l=(t,e,i)=>Math.max(e,Math.min(t,i)),c=[{x:l(i.minX-o,a,r),y:l((t.y+e.y)/2+2*(s()-.5),n,h)},{x:l(i.maxX+o,a,r),y:l((t.y+e.y)/2+2*(s()-.5),n,h)},{x:l((t.x+e.x)/2+2*(s()-.5),a,r),y:l(i.minY-o,n,h)},{x:l((t.x+e.x)/2+2*(s()-.5),a,r),y:l(i.maxY+o,n,h)}].filter(t=>this.isInterior(Math.round(t.x),Math.round(t.y)));if(0===c.length)return null;let d=c[0],m=this.distance(d,t)+this.distance(d,e);for(let i=1;i<c.length;i++){const s=this.distance(c[i],t)+this.distance(c[i],e);s<m&&(m=s,d=c[i])}return d}ensureEntryConnectivity(t,e){for(let i=0;i<8;i++){const{componentMap:i,boundaryByComponent:s}=this.computeFloorComponents();if(0===i.size)return;const o=t.map(t=>i.get(this.coordKey(t.x,t.y))).filter(t=>"number"==typeof t),a=Array.from(new Set(o));if(a.length<=1)return;if(!this.bridgeDisconnectedComponents(a,i,s,e))return}}computeFloorComponents(){const t=new Map,e=new Map;let i=0;for(let s=this.room.roomX+1;s<this.room.roomX+this.room.width-1;s++)for(let o=this.room.roomY+1;o<this.room.roomY+this.room.height-1;o++){const a=this.coordKey(s,o);!t.has(a)&&this.isFloorTile(s,o)&&(this.floodFillFloor(s,o,i,t,e),i++)}return{componentMap:t,boundaryByComponent:e}}floodFillFloor(t,e,i,s,o){const a=[{x:t,y:e}];for(;a.length>0;){const{x:t,y:e}=a.pop(),r=this.coordKey(t,e);if(s.has(r)||!this.isFloorTile(t,e))continue;s.set(r,i),this.isBoundaryFloor(t,e)&&(o.has(i)||o.set(i,[]),o.get(i).push({x:t,y:e}));const n=[{x:t-1,y:e},{x:t+1,y:e},{x:t,y:e-1},{x:t,y:e+1}];for(const t of n)!s.has(this.coordKey(t.x,t.y))&&this.isFloorTile(t.x,t.y)&&a.push(t)}}isFloorTile(t,e){return this.room.roomArray[t]?.[e]instanceof a.Floor}isBoundaryFloor(t,e){return[this.room.roomArray[t-1]?.[e],this.room.roomArray[t+1]?.[e],this.room.roomArray[t]?.[e-1],this.room.roomArray[t]?.[e+1]].some(t=>t instanceof r.Wall)}coordKey(t,e){return`${t},${e}`}bridgeDisconnectedComponents(t,e,i,s){const o=this.findAdjacentComponentWall(t,e,s);if(o)return this.carveDisk(o.x,o.y,1),!0;const a=this.findClosestBoundaryPair(t,i);return!!a&&(this.carveOrganicPath(a.a.x,a.a.y,a.b.x,a.b.y,s,{baseRadius:1.05,radiusJitter:.4,pocketChance:0,pocketRadius:[2,3]}),!0)}findAdjacentComponentWall(t,e,i){const s=new Set(t),o=[];for(let t=this.room.roomX+1;t<this.room.roomX+this.room.width-1;t++)for(let i=this.room.roomY+1;i<this.room.roomY+this.room.height-1;i++){if(!(this.room.roomArray[t]?.[i]instanceof r.Wall))continue;const a=new Set,n=[{x:t-1,y:i},{x:t+1,y:i},{x:t,y:i-1},{x:t,y:i+1}];for(const t of n){const i=e.get(this.coordKey(t.x,t.y));"number"==typeof i&&s.has(i)&&a.add(i)}a.size>=2&&o.push({x:t,y:i})}return 0===o.length?null:o[Math.floor(i()*o.length)]}findClosestBoundaryPair(t,e){let i=null,s=1/0;for(let o=0;o<t.length;o++)for(let a=o+1;a<t.length;a++){const r=e.get(t[o])||[],n=e.get(t[a])||[];if(0!==r.length&&0!==n.length)for(const t of r)for(const e of n){const o=Math.abs(t.x-e.x)+Math.abs(t.y-e.y);if(o<s&&(s=o,i={a:t,b:e},o<=2))return i}}return i}carveOrganicPath(t,e,i,s,a,r){"bezier"===o.GameplaySettings.ORGANIC_TUNNELS_PATH_MODE?this.carveOrganicPathBezier(t,e,i,s,a,r):this.carveOrganicPathLinear(t,e,i,s,a,r)}carveOrganicPathLinear(t,e,i,o,a,r){const n=r?.baseRadius??1.2,h=r?.radiusJitter??1,l=r?.pocketChance??.15,c=r?.pocketRadius??[2,3];let d=i-t,m=o-e;const u=Math.max(1,Math.sqrt(d*d+m*m));d/=u,m/=u;let p=-m,y=d,g=0;const f=Math.ceil(u/.6);for(let i=0;i<=f;i++){const o=i/f;g+=.6*(a()-.5),g>2.5&&(g=2.5),g<-2.5&&(g=-2.5);const r=t+d*(o*u)+p*g,w=e+m*(o*u)+y*g,E=n+(a()-.5)*h;if(this.carveDisk(r,w,Math.max(1,E)),a()<l){const t=s.Game.rand(c[0],c[1],a),e=r+p*(g+2*(a()-.5)),i=w+y*(g+2*(a()-.5));this.carveDisk(e,i,t)}}}carveOrganicPathBezier(t,e,i,o,a,r){const n=r?.baseRadius??1.2,h=r?.radiusJitter??1,l=r?.pocketChance??.15,c=r?.pocketRadius??[2,3],d=i-t,m=o-e,u=Math.max(1,Math.sqrt(d*d+m*m)),p=d/u,y=m/u,g=u*(.15+.15*a()),f=()=>(a()-.5)*g,w=f(),E=f(),x=t+p*(.25*u)-y*w,b=e+y*(.25*u)+p*w,T=t+p*(.75*u)-y*E,I=e+y*(.75*u)+p*E,S=s=>{const a=1-s,r=a*a,n=s*s,h=r*a,l=n*s;return{x:h*t+3*r*s*x+3*a*n*T+l*i,y:h*e+3*r*s*b+3*a*n*I+l*o}},v=s=>{const a=1-s;return{x:3*a*a*(x-t)+6*a*s*(T-x)+3*s*s*(i-T),y:3*a*a*(b-e)+6*a*s*(I-b)+3*s*s*(o-I)}},A=Math.max(4,Math.ceil(u/.45));for(let t=0;t<=A;t++){const e=t/A,i=S(e),o=v(e),r=Math.max(.001,Math.sqrt(o.x*o.x+o.y*o.y)),d=o.x/r,m=-o.y/r,u=d,p=(a()-.5)*Math.min(.25*g,1.6),y=i.x+m*p,f=i.y+u*p,w=n+(a()-.5)*h;if(this.carveDisk(y,f,Math.max(1,w)),a()<l){const t=s.Game.rand(c[0],c[1],a),e=2*(a()-.5),i=y+m*(p+e),o=f+u*(p+e);this.carveDisk(i,o,t)}}}randomInteriorPointNear(t,e,i){for(let o=0;o<16;o++){const o=s.Game.rand(-e,e,i),a=s.Game.rand(-e,e,i),r=t.x+o,n=t.y+a;if(this.isInterior(r,n))return{x:r,y:n}}return{x:t.x,y:t.y}}generatePocketTargets(t,e,i){const o=[];for(let a=0;a<e;a++){const e=i()*Math.PI*2,a=s.Game.rand(4,Math.max(6,Math.min(this.room.width,this.room.height)-4),i),r=Math.round(t.x+Math.cos(e)*a*(.5+i())),n=Math.round(t.y+Math.sin(e)*a*(.5+i())),h=Math.max(this.room.roomX+1,Math.min(r,this.room.roomX+this.room.width-2)),l=Math.max(this.room.roomY+1,Math.min(n,this.room.roomY+this.room.height-2));o.push({x:h,y:l})}return o}getCenterSpoofEntries(t,e=[1,2]){const i=this.room.roomX+1,o=this.room.roomX+this.room.width-2,a=this.room.roomY+1,r=this.room.roomY+this.room.height-2;if(o<=i||r<=a)return[];const n=o-i+1,h=r-a+1,l=Math.floor(n/4),c=Math.floor(h/4),d=i+l,m=o-l,u=a+c,p=r-c,y=[],g=s.Game.rand(e[0],e[1],t);for(let e=0;e<g;e++){let e=!1;for(let i=0;i<16&&!e;i++){const i=s.Game.rand(d,m,t),o=s.Game.rand(u,p,t);this.isInterior(i,o)&&(y.some(t=>Math.abs(t.x-i)+Math.abs(t.y-o)<=2)||(y.push({x:i,y:o}),e=!0))}}return y}pruneWallsWithSingleNeighbor(t=!0){let e=0;for(;;){const i=[];for(let e=this.room.roomX+1;e<this.room.roomX+this.room.width-1;e++)for(let s=this.room.roomY+1;s<this.room.roomY+this.room.height-1;s++)this.room.roomArray[e][s]instanceof r.Wall&&1===(t?this.countOrthogonalWallNeighborsAt(e,s):this.countWallNeighbors(this.room.roomArray[e][s]))&&i.push({x:e,y:s});if(0===i.length)break;for(const{x:t,y:e}of i)this.room.roomArray[t][e]instanceof r.Wall&&this.room.removeWall(t,e),this.room.roomArray[t][e]=new a.Floor(this.room,t,e),this.room.innerWalls=this.room.innerWalls.filter(i=>i.x!==t||i.y!==e);e+=i.length}return e}countOrthogonalWallNeighborsAt(t,e){let i=0;return this.room.roomArray[t-1]?.[e]instanceof r.Wall&&i++,this.room.roomArray[t+1]?.[e]instanceof r.Wall&&i++,this.room.roomArray[t]?.[e-1]instanceof r.Wall&&i++,this.room.roomArray[t]?.[e+1]instanceof r.Wall&&i++,i}}},7142:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Pot=void 0;const s=i(606),o=i(7851),a=i(606),r=i(9467),n=i(7366);class h extends s.Entity{constructor(t,e,i,s){super(t,e,i,s),this.draw=t=>{this.dead||(o.Game.ctx.save(),o.Game.ctx.globalAlpha=this.alpha,this.dead||(this.hasShadow&&this.drawShadow(t),this.updateDrawXY(t),o.Game.drawObj(this.tileX,this.tileY,1,2,this.x-this.drawX,this.y-this.drawYOffset-this.drawY,1,2,this.room.shadeColor,this.shadeAmount())),o.Game.ctx.restore())},this.drawTopLayer=t=>{this.drawableY=this.y},this.room=t,this.health=1,this.tileX=11,this.tileY=0,this.hasShadow=!0,this.chainPushable=!1,this.name="pot",this.hitSound=n.Sound.potSmash,this.imageParticleX=0,this.imageParticleY=29,r.Random.rand()}get type(){return a.EntityType.PROP}}e.Pot=h},7172:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Resource=void 0;const s=i(7851),o=i(606),a=i(606),r=i(7366);class n extends o.Entity{constructor(t,e,i,o){super(t,e,i,o),this.hurt=(t,e)=>{t.inventory?.getWeapon().canMine&&(this.healthBar.hurt(),this.health-=e,r.Sound.mine(),this.hurtCallback(),this.createHitParticles(),this.health<=0&&this.kill(t))},this.uniqueKillBehavior=()=>{this.cloned||r.Sound.delayPlay(r.Sound.breakRock,50)},this.kill=t=>{if(this.dead=!0,this.cloned)return;this.emitEnemyKilled();const e=this.clone();this.room.deadEntities.push(e),this.removeLightSource(this.lightSource),(null!==t&&t.inventory?.canMine()||null===t)&&this.dropLoot(),this.uniqueKillBehavior()},this.draw=t=>{this.dead||(s.Game.ctx.save(),s.Game.ctx.globalAlpha=this.alpha,this.dead||(this.hasShadow&&this.drawShadow(t),this.updateDrawXY(t),s.Game.drawObj(this.tileX,this.tileY,1,2,this.x-this.drawX,this.y-1.25-this.drawY,1,2,this.room.shadeColor,this.shadeAmount())),s.Game.ctx.restore())},this.drawTopLayer=t=>{this.drawableY=this.y},this.tileX=12,this.tileY=0,this.health=1,this.chainPushable=!1,this.name="resource",this.imageParticleX=6,this.imageParticleY=24}get type(){return a.EntityType.RESOURCE}}e.Resource=n},7178:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Populator=void 0;const s=i(4854),o=i(7851),a=i(8287),r=i(7445),n=i(3436),h=i(1073),l=i(3067),c=i(9467),d=i(6199),m=i(7967),u=i(4118),p=i(6986),y=i(7851),g=i(6084),f=i(9200),w=i(7455),E=i(2248),x=i(3384),b=i(6083),T=i(1103),I=i(32),S=i(9245),v=i(4918),A=i(8149),M=i(2270),C=i(8243),D=i(5196),O=i(9100),_=i(9116),R=i(2057),G=i(9791),P=i(9058),L=i(6635),k=i(9915),N=i(7512),Y=i(675),B=i(6598),H=i(4438),X=i(126),F=i(8480),W=i(1987),U=i(5838),j=i(5146),V=i(734),z=i(6761),q=i(9713),$=i(4937),Z=i(1444),K=i(4520),Q=i(5016),J=i(5109),tt=i(8821),et=i(3709),it=i(6751),st=i(3263),ot=i(783),at=i(1199),rt=i(66),nt={};for(const[t,e]of r.enemyClassToId.entries())nt[e]=t.name;const ht={enabled:!0,weight:.25,diameter:6,chance:1};e.Populator=class{constructor(t,e=!1){this.props=[],this.addedDownladder=!1,this.skipPopulation=!1,this.populateRooms=()=>{if(this.skipPopulation)return;this.level.rooms.forEach(t=>{this.addEnvironmentalFeatures(t,c.Random.rand)});for(let t of this.level.rooms)this.populate(t,c.Random.rand);this.level.rooms.forEach(t=>{t.type!==u.RoomType.DOWNLADDER&&t.type!==u.RoomType.UPLADDER&&t.type!==u.RoomType.ROPEHOLE&&t.type!==u.RoomType.ROPECAVE&&this.populateByEnvironment(t)});const t=this.level.getFurthestFromLadder("up"),e=[];switch(t?.envType){case h.EnvType.CASTLE:e.push(new L.Sword(t,1,1));break;case h.EnvType.CAVE:e.push(new C.Spear(t,1,1));break;case h.EnvType.MAGMA_CAVE:e.push(new P.Warhammer(t,1,1))}if(t&&!this.level.isMainPath){this.addBosses(t,this.level.depth,e);let i=t.getEmptyTiles();const s=t.getRandomEmptyPosition(i);if(null===s)return;const{x:o,y:a}=s;I.Chest.add(t,t.game,o,a).drops.push(...e)}if(console.log(`Adding downladder with ${this.numRooms()} rooms`),this.level.environment.type===h.EnvType.DUNGEON&&0!==this.level.depth){let t={caveRooms:5,locked:!0,linearity:0,mapWidth:100,mapHeight:100,giantCentralRoom:!0,giantRoomScale:.4};switch(this.level.depth){case 1:t.caveRooms=this.numRooms(),t.mapWidth=50,t.mapHeight=50,t.giantRoomScale=.6,t.linearity=.5;break;case 2:t.caveRooms=this.numRooms(),t.mapWidth=75,t.mapHeight=75,t.giantRoomScale=.8}this.addDownladder(t)}else this.level.environment.type===h.EnvType.DUNGEON&&0===this.level.depth&&a.GameplaySettings.TUTORIAL_ENABLED&&this.addDownladder({caveRooms:5,locked:!0,envType:h.EnvType.TUTORIAL,linearity:1,mapWidth:20,mapHeight:10});this.level.environment.type===h.EnvType.CAVE&&this.addDownladder({caveRooms:3*this.numRooms(),locked:!0,envType:h.EnvType.FLOODED_CAVE,linearity:.75,mapWidth:100,mapHeight:30,giantRoomScale:.25,giantCentralRoom:!1,loopiness:1,branching:.5}),this.level.environment.type===h.EnvType.DARK_DUNGEON&&this.addDownladder({caveRooms:2*this.numRooms(),locked:!0,envType:h.EnvType.DARK_CASTLE,linearity:.8}),this.level.environment.type===h.EnvType.DARK_CASTLE&&this.addDownladder({caveRooms:2*this.numRooms(),locked:!0,envType:h.EnvType.MAGMA_CAVE,linearity:1,giantCentralRoom:!0,mapWidth:75,mapHeight:75,giantRoomScale:.8}),this.level.environment.type===h.EnvType.FOREST&&this.addDownladder({caveRooms:this.numRooms(),locked:!0,envType:h.EnvType.CASTLE,linearity:.8}),this.level.environment.type!==h.EnvType.CASTLE&&this.linkExitToStart()},this.populateByEnvironment=t=>{if(t.type!==u.RoomType.START)switch(t.envType){case h.EnvType.CAVE:this.populateCaveEnvironment(t);break;case h.EnvType.FOREST:this.populateForestEnvironment(t);break;case h.EnvType.MAGMA_CAVE:this.populateMagmaCaveEnvironment(t);break;case h.EnvType.CASTLE:this.populateCastleEnvironment(t);break;case h.EnvType.TUTORIAL:this.populateTutorialEnvironment(t);break;default:this.populateDefaultEnvironment(t)}},this.linkExitToStart=()=>{if(console.log("linkExitToStart",this.level.isMainPath),this.level.isMainPath)return;this.level.setExitRoom(!1),this.level.setStartRoom(!1);const t=this.level.exitRoom,e=this.level.startRoom;e&&t&&t.linkExitToStart(e)},this.addTrainingDownladder=t=>{if(0!==this.level.depth)return;const e=this.level.rooms.find(t=>t.type===u.RoomType.START);if(!e)return;const i=e.getEmptyTilesNotBlockingDoors();if(0===i.length)return void console.warn("No valid positions for training downladder that don't block doors");const s=e.getRandomEmptyPosition(i);if(null===s||void 0===s.x||void 0===s.y)return;const o=new n.DownLadder(e,this.level.game,s.x,s.y,!0,h.EnvType.DUNGEON,l.LockType.NONE,t,{lockType:l.LockType.NONE});e.roomArray[s.x][s.y]=o},this.addDownladder=t=>{const e=this.level.rooms.filter(t=>t.type!==u.RoomType.START&&t.type!==u.RoomType.DOWNLADDER&&t.type!==u.RoomType.UPLADDER&&t.type!==u.RoomType.ROPEHOLE&&t.type!==u.RoomType.BOSS||t.type===u.RoomType.START&&0===t.depth);let i=this.level.isMainPath?e[Math.floor(c.Random.rand()*e.length)]:this.level.getFurthestFromLadder("up");if(0===this.level.depth){const t=this.level.rooms.find(t=>t.type===u.RoomType.START);t&&(i=t)}console.log(`Selected room for downladder: Type=${i.type}, Doors=${i.doors.length}`);const s=i.getEmptyTilesNotBlockingDoors();if(0===s.length)return void console.warn("No valid positions for downladder that don't block doors");const o=i.getRandomEmptyPosition(s,void 0);if(null===o||void 0===o.x||void 0===o.y)return;console.log(`Placing downladder at position (${o.x}, ${o.y})`);const a=t?.envType?t.envType:i.depth<2?h.EnvType.FOREST:2===i.depth?h.EnvType.CAVE:3===i.depth?h.EnvType.FLOODED_CAVE:i.depth>3&&c.Random.rand()<.5?h.EnvType.FOREST:h.EnvType.CAVE,r=t&&"boolean"==typeof t.locked?{lockType:t.locked?l.LockType.LOCKED:l.LockType.NONE}:void 0,d=new n.DownLadder(i,this.level.game,o.x,o.y,!0,a,l.LockType.NONE,t,r);let m;0===i.depth&&(m=i),i.roomArray[o.x][o.y]=d,d.lockable.isLocked()&&(console.log("adding key to downladder"),this.level.distributeKey(d,m))},this.populateByType=t=>{},this.numRooms=()=>{const t=Math.ceil(10*1.05**this.level.depth)-this.level.rooms.length;return Math.max(t,5)},this.populateEmpty=(t,e)=>{},this.populateTreasure=(t,e)=>{this.addChests(t,10,e)},this.populateDungeon=(t,e)=>{o.Game.rand(1,36,e)<=6&&this.placeVendingMachineInWall(t),t.removeDoorObstructions()},this.populateBoss=(t,e)=>{this.addBosses(t,t.depth)},this.populateBigDungeon=(t,e)=>{t.removeDoorObstructions()},this.populateSpawner=(t,e)=>{X.Spawner.add(t,t.game,Math.floor(t.roomX+t.width/2),Math.floor(t.roomY+t.height/2)),t.removeDoorObstructions()},this.populatePuzzle=(t,e)=>{let i;for(let e=t.roomX;e<t.roomX+t.width;e++){let s=t.roomY+Math.floor(t.height/2);e===t.roomX+Math.floor(t.width/2)?(i=new O.InsideLevelDoor(t,t.game,e,s+1),t.roomArray[e][s+1]=i):t.roomArray[e][s]=new f.Wall(t,e,s)}let a=o.Game.rand(t.roomX,t.roomX+t.width-1,e),r=o.Game.rand(t.roomY+Math.floor(t.height/2)+3,t.roomY+t.height-2,e);t.roomArray[a][r]=new _.Button(t,a,r,i);let n=t.getEmptyTiles().filter(e=>e.x>=t.roomX+1&&e.x<=t.roomX+t.width-2&&e.y>=t.roomY+Math.floor(t.height/2)+3&&e.y<=t.roomY+t.height-2),h=o.Game.randTable([1,2,2,3,4],e);for(let i=0;i<h;i++){let i=n.splice(o.Game.rand(0,n.length-1,e),1)[0];i&&t.entities.push(new s.Crate(t,t.game,i.x,i.y))}t.removeDoorObstructions()},this.populateSpikeCorridor=(t,e)=>{for(let i=t.roomX;i<t.roomX+t.width;i++)for(let s=t.roomY+1;s<t.roomY+t.height-1;s++)t.roomArray[i][s]=new w.SpikeTrap(t,i,s,o.Game.rand(0,3,e));t.removeDoorObstructions()},this.populateCave=(t,e)=>{o.Game.rand(1,36,e);let i=t.getEmptyTiles().length,s=Math.ceil(i*o.Game.randTable([.25,.3,.35],e));t.level.environment.type===h.EnvType.CAVE&&this.addResources(t,(i-s)*o.Game.randTable([.1,.2,.3],e),e),t.removeDoorObstructions()},this.populateUpLadder=(t,e)=>{const{x:i,y:s}=t.getRoomCenter();t.roomArray[i-1][s-1]=new R.UpLadder(t,t.game,i-1,s-1)},this.populateDownLadder=(t,e)=>{const{x:i,y:s}=t.getRoomCenter();t.roomArray[i+1][s-1]=new n.DownLadder(t,t.game,i+1,s-1);const o=Math.ceil(5*c.Random.rand());let a=t.getEmptyTiles(),r=[];a=a.filter(t=>!r.some(e=>e.x===t.x&&e.y===t.y)),a=a.filter(t=>t.x!==i||t.y!==s);for(let e=0;e<o;e++)if(a.length>0){const e=t.getRandomEmptyPosition(a);if(null===e)break;const{x:i,y:s}=e;let o=new I.Chest(t,t.game,i,s);o.getDrop(["consumable","gem","light","tool","fuel","backpack","weapon","coin"],!1),a.filter(t=>t.x!==i&&t.y!==s),t.entities.push(o)}},this.populateWeaponGroup=(t,e)=>{const i=t.roomY+1,s=t.roomX+1,a=t.roomX+t.width-2,r=e.filter(t=>t.y===i&&t.x>=s&&t.x<=a);if(0===r.length)return;const n=t.getRoomCenter().x,h=Array.from(new Set(r.map(t=>t.x))).sort((t,e)=>t-e);if(h.length<3)return;const l=h.slice().sort((t,e)=>Math.abs(t-n)-Math.abs(e-n))[0],d=h.filter(t=>t<l),m=h.filter(t=>t>l),u=new Set(h),p=l-2,y=l+2;let g=u.has(p)?p:d.filter(t=>t<=l-2).slice(-1)[0],f=u.has(y)?y:m.filter(t=>t>=l+2)[0];void 0===g&&d.length>0&&(g=d[d.length-1]),void 0===f&&m.length>0&&(f=m[0]);let w=[];if(void 0!==g&&void 0!==f)w=[{x:g,y:i},{x:l,y:i},{x:f,y:i}];else{if(w=r.slice().sort((t,e)=>Math.abs(t.x-n)-Math.abs(e.x-n)).slice(0,3).map(t=>({x:t.x,y:i})),w.length<3)return;w.sort((t,e)=>t.x-e.x)}for(let t=w.length-1;t>0;t--){const e=o.Game.rand(0,t,c.Random.rand);[w[t],w[e]]=[w[e],w[t]]}const E=new G.ItemGroup([new C.Spear(t,w[0].x,w[0].y),new P.Warhammer(t,w[1].x,w[1].y),new L.Sword(t,w[2].x,w[2].y)]);for(const e of E.items)e.grouped=!0,e.group=E,t.items.push(e);return w},this.populateRopeHole=(t,e)=>{const{x:i,y:s}=t.getRoomCenter(),o=t.depth<1?h.EnvType.FOREST:h.EnvType.CAVE;let a=new n.DownLadder(t,t.game,i,s,!0,o);setTimeout(()=>{t.roomArray[i][s]=a},0)},this.populateRopeCave=(t,e)=>{let i="";switch(t.envType){case h.EnvType.CAVE:i="Cave";break;case h.EnvType.MAGMA_CAVE:i="Magma Cave";break;case h.EnvType.FOREST:i="Forest";break;case h.EnvType.CASTLE:i="Castle";break;case h.EnvType.TUTORIAL:i="Tutorial"}t.name=i;const{x:s,y:o}=t.getRoomCenter();let a=new R.UpLadder(t,t.game,s,o);a.isRope=!0,a.isSidePath=!0,t.roomArray[s][o]=a,t.envType===h.EnvType.CAVE?this.placeVendingMachineInWall(t,new k.Pickaxe(t,0,0)):t.envType!==h.EnvType.TUTORIAL&&this.placeVendingMachineInWall(t),t.removeDoorObstructions()},this.populateShop=(t,e)=>{this.addTorches(t,2,e);const{x:i,y:s}=t.getRoomCenter();T.VendingMachine.add(t,t.game,i-2,s-1,new N.Shotgun(t,0,0)),T.VendingMachine.add(t,t.game,i+2,s-1,new v.Heart(t,0,0)),T.VendingMachine.add(t,t.game,i-2,s+2,new M.Armor(t,0,0)),T.VendingMachine.add(t,t.game,i+2,s+2,new C.Spear(t,0,0)),t.removeDoorObstructions()},this.addTorchesByArea=t=>{const e=t.envType===h.EnvType.TUTORIAL?2:1;let i=Math.max(1,Math.floor(Math.sqrt(t.roomArea)/3)-Math.floor(Math.sqrt(t.depth)));if(0===t.depth)c.Random.rand()<.25&&(i=0);else{const e=.4,s=.9*(1-Math.exp(-e*(t.depth-1)));c.Random.rand()<s&&(i=0)}this.addTorches(t,i*e,c.Random.rand)},this.addWindowsByArea=t=>{if(t.envType!==h.EnvType.CASTLE&&t.level.environment.type!==h.EnvType.CASTLE)return;let e=Math.max(0,Math.floor(Math.sqrt(t.roomArea)/4)-Math.floor(Math.sqrt(t.depth)));0===t.depth&&c.Random.rand()<.15&&(e=0)},this.populate=(t,e)=>{switch(t.name="",t.type){case u.RoomType.START:0!==t.depth&&(this.populateUpLadder(t,e),this.placeVendingMachineInWall(t)),this.populateEmpty(t,e),t.name="FLOOR "+-t.depth;break;case u.RoomType.BOSS:this.populateBoss(t,e),t.name="BOSS";break;case u.RoomType.DUNGEON:t.level.environment.type===h.EnvType.CAVE&&c.Random.rand()<=.2?this.populateCave(t,e):this.populateDungeon(t,e);break;case u.RoomType.BIGDUNGEON:this.populateBigDungeon(t,e);break;case u.RoomType.PUZZLE:this.populatePuzzle(t,e);break;case u.RoomType.SPIKECORRIDOR:this.populateSpikeCorridor(t,e);break;case u.RoomType.TREASURE:this.populateTreasure(t,e);break;case u.RoomType.GRASS:this.populateDungeon(t,e);break;case u.RoomType.BIGCAVE:this.populateCave(t,e);case u.RoomType.CAVE:this.populateCave(t,e);break;case u.RoomType.UPLADDER:this.populateUpLadder(t,e),t.name="FLOOR "+-t.depth;break;case u.RoomType.DOWNLADDER:this.populateDownLadder(t,e),t.name="FLOOR "+-t.depth;break;case u.RoomType.ROPEHOLE:this.populateRopeHole(t,e);break;case u.RoomType.ROPECAVE:this.populateRopeCave(t,e);break;case u.RoomType.SHOP:this.populateShop(t,e);break;case u.RoomType.SPAWNER:this.populateSpawner(t,e)}t.message=t.name},this.level=t,this.props=[],this.medianDensity=a.GameplaySettings.MEDIAN_ROOM_DENSITY,this.levelEnemyPoolIds=this.generateEnemyPoolIds(this.level.depth)}addProps(t,e,i){const s=i?r.environmentData[i]:r.environmentData[t.level.environment.type];let o=t.getEmptyTiles();for(let i=0;i<e&&0!==o.length;i++){const e=d.Utils.randTableWeighted(s.props);if(!e)continue;const i=e.size||{w:1,h:1},a=1===i.w&&1===i.h?t.getRandomEmptyPosition(o):t.getEmptyAreaPosition(o,i.w,i.h);if(!a)break;const{x:r,y:n}=a;if(e.class&&e.class.add){const i=e.additionalParams||[];e.class.add(t,t.game,r,n,...i)}for(let t=0;t<i.w;t++)for(let e=0;e<i.h;e++){const i=o.findIndex(i=>i.x===r+t&&i.y===n+e);-1!==i&&o.splice(i,1)}}}addPropsWithClustering(t,e,i,s){const o=i?r.environmentData[i]:r.environmentData[t.level.environment.type],a=new m.PropClusterer(t,s),n=a.generateClusteredPositions(e),h=this.generateBlobField(t,s?.blobOptions),l=new Map;if(s?.debugEnabled){const t=a.getLastDebugReport();if(t){console.log("[PropClusterer] config:",{clusterTowardsWalls:t.config.clusterTowardsWalls,wallWeight:t.config.wallWeight,wallMaxDistance:t.config.wallMaxDistance,wallDeadzone:t.config.wallDeadzone,onlyInnerWalls:t.config.onlyInnerWalls,wallDistanceMetric:t.config.wallDistanceMetric}),console.log("[PropClusterer] walls:",t.wallsFound,"grid:",t.wallGridStats),console.log("[PropClusterer] iterations:",t.iterations.length,"seed:",t.seedUsed),t.iterations[0]?.top&&t.iterations[0].top.length&&console.log("[PropClusterer] first-iter top:",t.iterations[0].top);const e=a.analyzeEffectiveness(n,{wallScoreThresholdNormalized:.7,neighborMaxDistance:2,neighborWeight:1,combineMode:"max"});console.log("[PropClusterer] effectiveness summary:",e.summary)}}let c=t.getEmptyTiles();for(const e of n){if(0===c.length)break;const i=d.Utils.randTableWeighted(o.props);if(!i)continue;const a=i.size||{w:1,h:1};let r=null;if(1===a.w&&1===a.h)r=c.some(t=>t.x===e.x&&t.y===e.y)?{x:e.x,y:e.y}:t.getRandomEmptyPosition(c);else{const i=c.filter(t=>Math.abs(t.x-e.x)<=a.w&&Math.abs(t.y-e.y)<=a.h);r=t.getEmptyAreaPosition(i.length?i:c,a.w,a.h)}if(!r)continue;const{x:n,y:m}=r,u=this.resolveBlobOptions(i.blob,s?.blobOptions),p=this.getBlobFieldWithChance(t,u,l)??h;if(!p||this.isPlacementWithinBlobField(p,n,m,a.w,a.h)){if(i.class&&i.class.add){const e=i.additionalParams||[];i.class.add(t,t.game,n,m,...e)}for(let t=0;t<a.w;t++)for(let e=0;e<a.h;e++){const i=c.findIndex(i=>i.x===n+t&&i.y===m+e);-1!==i&&c.splice(i,1)}}}}generateBlobField(t,e){if(!e||!1===e.enabled)return null;const i=Math.max(0,Math.min(1,e.weight??ht.weight));if(i<=0)return null;const s=t.getEmptyTiles();if(!s.length)return null;const o=Math.max(1,Math.floor(e.diameter??ht.diameter)),a=Math.max(1,Math.floor(o/2)),r=a*a,n=t.width*t.height,h=Math.max(1,Math.PI*r);let l=Math.round(i*n/h);void 0!==e.maxBlobs&&(l=Math.min(l,Math.max(1,e.maxBlobs))),l=Math.max(l,1);const d=s.slice(),m=[];for(let t=0;t<l&&d.length>0;t++){const t=Math.floor(c.Random.rand()*d.length),e=d.splice(t,1)[0];m.push({x:e.x,y:e.y})}const u=new Set;for(const t of s)this.pointInsideAnyBlob(t.x,t.y,m,r)&&u.add(this.coordKey(t.x,t.y));return u.size?{allowedTiles:u}:null}pointInsideAnyBlob(t,e,i,s){for(const o of i){const i=t-o.x,a=e-o.y;if(i*i+a*a<=s)return!0}return!1}isPlacementWithinBlobField(t,e,i,s,o){for(let a=0;a<s;a++)for(let s=0;s<o;s++)if(!t.allowedTiles.has(this.coordKey(e+a,i+s)))return!1;return!0}coordKey(t,e){return`${t},${e}`}resolveBlobOptions(t,e){if(!t)return null;const i=this.getDefaultBlobOptions();if("boolean"==typeof t)return t?{...i,...e,enabled:!0}:null;if(!1===t.enabled)return null;const s=t.chance??e?.chance??i.chance??1;return{enabled:!0,weight:t.weight??e?.weight??i.weight,diameter:t.diameter??e?.diameter??i.diameter,maxBlobs:t.maxBlobs??e?.maxBlobs,chance:Math.max(0,Math.min(1,s))}}getBlobFieldFromCache(t,e,i){const s=this.getBlobOptionsKey(e);if(i.has(s))return i.get(s)??null;const o=this.generateBlobField(t,e);return i.set(s,o),o}getBlobFieldWithChance(t,e,i){if(!e)return null;const s=Math.max(0,Math.min(1,e.chance??1));return c.Random.rand()>s?null:this.getBlobFieldFromCache(t,e,i)}getBlobOptionsKey(t){return`${t.weight??ht.weight}|${t.diameter??ht.diameter}|${t.maxBlobs??"auto"}|${t.chance??ht.chance}`}getDefaultBlobOptions(){return{...ht}}getEntityFootprint(t){return t.size?.w&&t.size?.h?{w:t.size.w,h:t.size.h}:{w:1,h:1}}populateTutorialEnvironment(t){const e=Math.floor((this.getNumProps(t)+1)/4);this.addPropsWithClustering(t,e,t.envType,{falloffExponent:2,baseScore:.1,maxInfluenceDistance:12,useSeedPosition:!1});const i=t.path().find(t=>t.hasUpladder()),s=i?.path().indexOf(t);switch(s){case 0:break;case 1:t.addNewEnemy(u.EnemyType.crab);break;case 2:t.addNewEnemy(u.EnemyType.zombie);break;case 3:t.addNewEnemy(u.EnemyType.crab),t.addNewEnemy(u.EnemyType.skull);break;case 4:t.addNewEnemy(u.EnemyType.crab),t.addNewEnemy(u.EnemyType.skull),t.addNewEnemy(u.EnemyType.zombie);const e=t.entities.filter(t=>t instanceof p.Enemy);e[1].drops=[new v.Heart(t,e[1].x,e[1].y)]}for(const e of t.doors)e.guard()}populateDungeonEnvironment(t){this.populateDefaultEnvironment(t)}populateCaveEnvironment(t){const e=this.getNumProps(t);this.addPropsWithClustering(t,e,t.envType,{clusterTowardsWalls:!0,wallAdjacentOnly:!0,wallBandSize:1,wallDeadzone:0,wallWeight:80,seedStrategy:"bestWall",baseScore:0,entityWeight:5,falloffExponent:3,maxInfluenceDistance:1.15,wallDistanceMetric:"manhattan",debugEnabled:!0,debugCollectDetails:!0,debugLogToConsole:!0,debugTopN:5}),this.addRandomEnemies(t)}populateForestEnvironment(t){const e=this.getNumProps(t,.75);this.addPropsWithClustering(t,e,t.envType,{falloffExponent:2,baseScore:.1,maxInfluenceDistance:12,useSeedPosition:!1}),this.addRandomEnemies(t)}populateMagmaCaveEnvironment(t){const e=this.getNumProps(t,.25),i=Math.min(1.25*e,t.getEmptyTiles().length);this.addPropsWithClustering(t,i,t.envType,{clusterTowardsWalls:!0,wallAdjacentOnly:!0,wallBandSize:1,wallDeadzone:0,wallWeight:80,seedStrategy:"bestWall",baseScore:0,entityWeight:5,falloffExponent:3,maxInfluenceDistance:1.15,wallDistanceMetric:"manhattan"}),this.replaceEdgeWalls(t,st.ObsidianBlock,.75),this.addRandomEnemies(t)}populateCastleEnvironment(t){const e=this.getNumProps(t);this.addPropsWithClustering(t,e,t.envType,{falloffExponent:2,baseScore:.1,maxInfluenceDistance:12,useSeedPosition:!1}),this.addRandomEnemies(t)}getNumProps(t,e){e=e||this.medianDensity;const i=t.getEmptyTiles().length,s=d.Utils.randomNormalInt(0,i,{median:Math.ceil(e*i)});return Math.round(s/i*100),s}populateDefaultEnvironment(t){const e=this.getNumProps(t);this.addPropsWithClustering(t,e,t.envType,{falloffExponent:2,baseScore:.1,maxInfluenceDistance:12,useSeedPosition:!1,clusterTowardsWalls:!0,wallWeight:10,wallDistanceMetric:"manhattan",wallAdjacentOnly:!0,wallBandSize:1,wallDeadzone:0,seedStrategy:"bestWall",entityWeight:5,debugEnabled:!0,debugCollectDetails:!0,debugLogToConsole:!0,debugTopN:5}),this.addRandomEnemies(t)}addDoorTorches(t,e,i,s){if((s===y.Direction.UP||s===y.Direction.DOWN)&&e&&i){t.calculateWallInfo();const o=t.wallInfo.get(`${e-1},${i}`),a=t.wallInfo.get(`${e+1},${i}`),r=(t.roomArray[e-1],t.roomArray[e+1],!1===o?.isLeftWall),n=!1===a?.isRightWall,h=s===y.Direction.DOWN;r&&(t.roomArray[e-1][i]=new g.WallTorch(t,e-1,i,h)),n&&(t.roomArray[e+1][i]=new g.WallTorch(t,e+1,i,h))}}addTorches(t,e,i,s,a){if(t.level.environment.type===h.EnvType.FOREST&&t.type!==u.RoomType.DOWNLADDER)return;if(void 0!==s&&void 0!==a&&t.roomArray[s]?.[a]instanceof f.Wall)return void(t.roomArray[s][a]=new g.WallTorch(t,s,a));let r=[];for(let e=t.roomX+1;e<t.roomX+t.width-2;e++)for(let i=t.roomY;i<t.roomY+t.height-1;i++)t.roomArray[e][i]instanceof f.Wall&&!(t.roomArray[e][i+1]instanceof f.Wall)&&r.push(t.roomArray[e][i]);let n=[];for(let e=t.roomX+1;e<t.roomX+t.width-2;e++){const i=t.roomY+t.height-1;t.roomArray[e][i]instanceof f.Wall&&!(t.roomArray[e][i+1]instanceof f.Wall)&&n.push(t.roomArray[e][i])}const l=o.Game.rand(0,e,i),c=e-l;for(let e=0;e<l&&0!=r.length;e++){const e=o.Game.rand(0,r.length-1,i),s=r.splice(e,1)[0],a=s.x,n=s.y;t.roomArray[a][n]=new g.WallTorch(t,a,n)}for(let e=0;e<c&&0!=n.length;e++){const e=o.Game.rand(0,n.length-1,i),s=n.splice(e,1)[0],a=s.x,r=s.y;t.roomArray[a][r]=new g.WallTorch(t,a,r,!0)}}addDoorWindows(t,e,i,s){if((s===y.Direction.UP||s===y.Direction.DOWN)&&e&&i){t.calculateWallInfo();const o=t.wallInfo.get(`${e-1},${i}`),a=t.wallInfo.get(`${e+1},${i}`),r=!1===o?.isLeftWall,n=!1===a?.isRightWall,h=s===y.Direction.DOWN;r&&t.roomArray[e-1]?.[i]instanceof f.Wall&&(t.roomArray[e-1][i]=new K.Window(t,e-1,i,h)),n&&t.roomArray[e+1]?.[i]instanceof f.Wall&&(t.roomArray[e+1][i]=new K.Window(t,e+1,i,h))}}addWindows(t,e,i,s,a){if(t.envType!==h.EnvType.CASTLE&&t.level.environment.type!==h.EnvType.CASTLE)return;if(void 0!==s&&void 0!==a&&t.roomArray[s]?.[a]instanceof f.Wall)return void(t.roomArray[s][a]=new K.Window(t,s,a));let r=[];for(let e=t.roomX+1;e<t.roomX+t.width-2;e++)for(let i=t.roomY;i<t.roomY+t.height-1;i++)t.roomArray[e][i]instanceof f.Wall&&!(t.roomArray[e][i+1]instanceof f.Wall)&&r.push(t.roomArray[e][i]);let n=[];for(let e=t.roomX+1;e<t.roomX+t.width-2;e++){const i=t.roomY+t.height-1;t.roomArray[e][i]instanceof f.Wall&&!(t.roomArray[e][i+1]instanceof f.Wall)&&n.push(t.roomArray[e][i])}const l=o.Game.rand(0,e,i),c=e-l;for(let e=0;e<l&&0!==r.length;e++){const e=o.Game.rand(0,r.length-1,i),s=r.splice(e,1)[0],a=s.x,n=s.y;t.roomArray[a][n]=new K.Window(t,a,n)}for(let e=0;e<c&&0!==n.length;e++){const e=o.Game.rand(0,n.length-1,i),s=n.splice(e,1)[0],a=s.x,r=s.y;t.roomArray[a][r]=new K.Window(t,a,r,!0)}}addRectangularTileArea(t,e,i){let s=o.Game.rand(2,4,e),a=o.Game.rand(2,4,e),r=t.roomX+2,n=t.roomX+t.width-s-2,h=t.roomY+2,l=t.roomY+t.height-a-2;if(n<r||l<h)return;let c=o.Game.rand(r,n,e),d=o.Game.rand(h,l,e),m=!0;for(let e=c-1;e<c+s+1;e++)for(let i=d-1;i<d+a+1;i++){const s=t.roomArray[e][i];(s instanceof b.SpawnFloor&&!s.isSolid()||s instanceof V.Pool||s instanceof E.Chasm)&&(m=!1)}if(m?console.log("space for "+i.name):console.warn("no space for "+i.name),m)for(let e=c-1;e<c+s+1;e++)for(let o=d-1;o<d+a+1;o++)if(e===c-1||e===c+s||o===d-1||o===d+a){const i=t.roomArray[e][o];i instanceof b.SpawnFloor&&!i.isSolid()||i instanceof f.Wall||i instanceof V.Pool||i instanceof E.Chasm||(t.roomArray[e][o]=new x.Floor(t,e,o))}else t.roomArray[e][o]=new i(t,e,o,e===c,e===c+s-1,o===d,o===d+a-1)}addChasms(t,e){this.addRectangularTileArea(t,e,E.Chasm)}addMagmaPools(t,e){t.underwater||this.addRectangularTileArea(t,e,z.MagmaPool)}addPools(t,e){t.underwater||this.addRectangularTileArea(t,e,V.Pool)}addSpikeTraps(t,e,i){if(t.level.environment.type===h.EnvType.FOREST||t.envType===h.EnvType.FOREST)return;let s=t.getEmptyTiles();for(let i=0;i<e;i++){const e=t.getRandomEmptyPosition(s);if(null===e)break;const{x:i,y:o}=e;t.roomArray[i][o]=new w.SpikeTrap(t,i,o)}}replaceEdgeWalls(t,e,i=.25){t.calculateWallInfo();const s=[];for(let e=t.roomX;e<t.roomX+t.width;e++)for(let i=t.roomY;i<t.roomY+t.height;i++){const o=t.roomArray[e]?.[i];if(!(o instanceof f.Wall))continue;const a=t.wallInfo.get(`${e},${i}`);a?.isInnerWall&&([t.roomArray[e]?.[i-1],t.roomArray[e]?.[i+1],t.roomArray[e-1]?.[i],t.roomArray[e+1]?.[i]].some(t=>t instanceof x.Floor||t instanceof b.SpawnFloor)&&s.push({x:e,y:i}))}for(const o of s)if(c.Random.rand()<=i){const{x:i,y:s}=o;if(t.roomArray[i][s]=new x.Floor(t,i,s),e&&"function"==typeof e.add)try{e.add(t,t.game,i,s)}catch(t){}}t.calculateWallInfo();for(let e=t.roomX;e<t.roomX+t.width;e++)for(let i=t.roomY;i<t.roomY+t.height;i++){const s=t.roomArray[e]?.[i];if(!(s instanceof f.Wall))continue;const o=t.wallInfo.get(`${e},${i}`);if(!o?.isInnerWall)continue;const a=t.roomArray[e]?.[i-1],r=t.roomArray[e]?.[i+1],n=t.roomArray[e-1]?.[i],h=t.roomArray[e+1]?.[i];0===[a,r,n,h].filter(t=>t instanceof f.Wall).length&&(t.roomArray[e][i]=new x.Floor(t,e,i))}}addEnemiesUnified(t,e,i){if(!0===a.GameplaySettings.NO_ENEMIES)return;const s=this.getAvailableEnemiesForRoom(t,i);0!==s.length?(this.spawnEnemiesFromPool(t,e,s),this.addSpecialEnemies(t)):console.log(`No enemies available for environment ${i||t.level.environment.type} at depth ${t.depth}`)}getAvailableEnemiesForRoom(t,e){const i=e||t.level.environment.type,s=r.environmentData[i],o=this.levelEnemyPoolIds,a=s.enemies.map(t=>({...t,id:r.enemyClassToId.get(t.class)})).filter(e=>e.id&&o.includes(e.id)&&(e.minDepth??0)<=t.depth);return console.log(`Depth ${t.depth}, Env ${i}: Pool [${o.map(t=>nt[t]||`Unknown(${t})`).join(", ")} ] -> Available [${a.map(t=>nt[t.id]||`Unknown(${t.id})`).join(", ")}]`),a}spawnEnemiesFromPool(t,e,i){let s=t.getEmptyTiles();if(0===s.length)return;const o=new Map,a=new Set;for(const e of t.doors)for(let t=-2;t<=2;t++)for(let i=-2;i<=2;i++)a.add(`${e.x+t},${e.y+i}`);s=s.filter(t=>!a.has(`${t.x},${t.y}`));for(let a=0;a<e&&0!==s.length;a++){const r=d.Utils.randTableWeighted(i);if(!r?.class?.add)continue;const n=this.resolveBlobOptions(r.blob);let h,l=this.getBlobFieldWithChance(t,n,o);if(l?(h=s.filter(t=>l.allowedTiles.has(this.coordKey(t.x,t.y))),0===h.length&&(l=null,h=s)):h=s,0===h.length)continue;const c=t.getRandomEmptyPosition(h);if(null===c)break;const{x:m,y:u}=c,p=this.getEntityFootprint(r),y=h===s;if(l&&!this.isPlacementWithinBlobField(l,m,u,p.w,p.h)){y&&s.push(t.roomArray[m][u]),a--;continue}const g=r.additionalParams||[];if("clearFloor"===r.specialSpawnLogic){const i=new r.class(t,t.game,m,u,...g);this.canPlaceBigEnemy(t,i,m,u,s)?(t.entities.push(i),this.clearFloorForBigEnemy(t,m,u,i.w,i.h,i),this.removeTilesForEnemy(s,m,u,i.w,i.h)):(y&&s.push(t.roomArray[m][u]),e++)}else r.class.add(t,t.game,m,u,...g),s=s.filter(t=>!(t.x===m&&t.y===u))}console.log(`Spawned ${e} enemies from pool for total empty tiles ${s.length}`)}addSpecialEnemies(t){t.underwater||(t.depth>a.GameplaySettings.SPAWNER_MIN_DEPTH&&this.addSpawners(t,c.Random.rand),t.depth>a.GameplaySettings.OCCULTIST_MIN_DEPTH&&this.addOccultists(t,c.Random.rand))}generateEnemyPoolIds(t){const e=this.level.environment.type,i=r.environmentData[e].enemies.map(t=>({id:r.enemyClassToId.get(t.class),minDepth:t.minDepth??0})).filter(e=>"number"==typeof e.id&&e.minDepth<=t).map(t=>t.id).filter(t=>!this.level.game.encounteredEnemies.includes(t)),s=a.GameplaySettings.LIMIT_ENEMY_TYPES?Math.min(i.length,a.GameplaySettings.NEW_ENEMIES_PER_LEVEL):i.length,o=this.getRandomElements(i,s);this.level.game.encounteredEnemies.push(...o);const n=this.level.game.encounteredEnemies.slice(),h=a.GameplaySettings.LIMIT_ENEMY_TYPES?this.getNumberOfEnemyTypes(t):n.length,l=this.getRandomElements(n,h);return Array.from(new Set(l)).slice(0,h)}getEnemyPoolForDepth(t){return t===this.level.depth?this.levelEnemyPoolIds:this.generateEnemyPoolIds(t)}getNumberOfEnemyTypes(t){return 0===t?a.GameplaySettings.DEPTH_ZERO_ENEMY_TYPES:Math.ceil(Math.sqrt(t+1))+a.GameplaySettings.ENEMY_TYPES_BASE_COUNT}getRandomElements(t,e){const i=[...t];for(let t=i.length-1;t>0;t--){const e=Math.floor(c.Random.rand()*(t+1));[i[t],i[e]]=[i[e],i[t]]}return i.slice(0,Math.min(e,i.length))}canPlaceBigEnemy(t,e,i,s,o){if(e.x+e.w>t.roomX+t.width||e.y+e.h>t.roomY+t.height||e.x<t.roomX||e.y<t.roomY)return!1;for(let o=0;o<e.w;o++)for(let a=0;a<e.h;a++){const e=t.roomArray[i+o]?.[s+a];if((e.x===i+o||e.y===s+a)&&e.isSolid())return console.log("wall found"),!1}return!0}clearFloorForBigEnemy(t,e,i,s,o,a){for(let r=0;r<s;r++)for(let s=0;s<o;s++)t.roomArray[e+r][i+s]=new x.Floor(t,e+r,i+s),t.entities.some(t=>t.x===e+r&&t.y===i+s)&&(t.entities=t.entities.filter(t=>t.x!==e+r&&t.y!==i+s||t===a))}removeTilesForEnemy(t,e,i,s,o){for(let a=0;a<s;a++)for(let s=0;s<o;s++){const o=t.findIndex(t=>t.x===e+a&&t.y===i+s);-1!==o&&t.splice(o,1)}}addRandomEnemies(t,e=1,i=!1){const s=t.getEmptyTiles().length,o=(t.roomArea+s)/2,r=t.path().find(t=>t.hasUpladder()),n=i?r?.path().indexOf(t):1,h=Math.min((t.depth+a.GameplaySettings.ENEMY_DENSITY_DEPTH_OFFSET)*a.GameplaySettings.ENEMY_DENSITY_DEPTH_MULTIPLIER,a.GameplaySettings.MAX_ENEMY_DENSITY),l=Math.ceil(Math.max(d.Utils.randomNormalInt(0,o*h),o*h)),c=Math.min(l,s),m=i?n:c*e;this.addEnemiesUnified(t,m,t.envType)}addSpawners(t,e,i){let s=t.getEmptyTiles();if(0===s.length)return;let o=null;if(void 0!==i)for(let e=0;e<i;e++){const e=t.getRandomEmptyPosition(s);if(null===e)break;const{x:i,y:a}=e,r=this.getEnemyPoolForDepth(Math.max(0,t.depth)).filter(t=>7!==t);o=X.Spawner.add(t,t.game,i,a,r),s=s.filter(t=>!(t.x===i&&t.y===a))}else{const i=Math.ceil(t.roomArea/a.GameplaySettings.SPAWNER_AREA_THRESHOLD);for(let r=0;r<i;r++){if(e()>a.GameplaySettings.SPAWNER_SPAWN_CHANCE)continue;const i=t.getRandomEmptyPosition(s);if(null===i)break;const{x:r,y:n}=i,h=this.getEnemyPoolForDepth(Math.max(0,t.depth-1)).filter(t=>7!==t);o=X.Spawner.add(t,t.game,r,n,h),s=s.filter(t=>!(t.x===r&&t.y===n))}}return o}addOccultists(t,e,i){let s=t.getEmptyTiles();if(0===s.length)return;let o=null;if(void 0!==i)for(let e=0;e<i;e++){const e=t.getRandomEmptyPosition(s);if(null===e)break;const{x:i,y:a}=e;o=H.OccultistEnemy.add(t,t.game,i,a),s=s.filter(t=>!(t.x===i&&t.y===a))}else{const i=Math.ceil(t.roomArea/a.GameplaySettings.OCCULTIST_AREA_THRESHOLD);for(let r=0;r<i;r++){if(e()>a.GameplaySettings.OCCULTIST_SPAWN_CHANCE)continue;const i=t.getRandomEmptyPosition(s);if(null===i)break;const{x:r,y:n}=i;o=H.OccultistEnemy.add(t,t.game,r,n),s=s.filter(t=>!(t.x===r&&t.y===n))}}return o}addBosses(t,e,i){if(i=i||[],!0===a.GameplaySettings.NO_ENEMIES||t.envType===h.EnvType.TUTORIAL)return;let s=t.getEmptyTiles();if(0===s.length)return;let r=null;if(a.GameplaySettings.PRESET_BOSSES){const i=t.getBigRandomEmptyPosition(s);if(null===i)return;const{x:o,y:a}=i;switch(e){case 0:const e=F.BigZombieEnemy.add(t,t.game,o,a);e.dropTable=["weapon","equipment","consumable","gem","tool"],e.dropChance=1,r=e;const i=B.QueenEnemy.add(t,t.game,o,a);i.dropTable=["weapon","equipment"],i.dropChance=1,r=i;break;case 1:const s=Y.BigSkullEnemy.add(t,t.game,o,a);s.dropTable=["weapon","equipment","consumable","gem","tool"],r=s;const n=this.addSpawners(t,c.Random.rand,1);n.dropChance=1,r=n;break;case 2:const h=this.addSpawners(t,c.Random.rand,1);h.dropChance=1,r=h;const l=this.addOccultists(t,c.Random.rand,1);l.dropChance=1,r=l;break;case 3:const d=F.BigZombieEnemy.add(t,t.game,o,a);d.dropTable=["weapon","equipment","consumable","gem","tool"],d.dropChance=1,r=d;const m=F.BigZombieEnemy.add(t,t.game,o,a);m.dropTable=["weapon","equipment","consumable","gem","tool"],m.dropChance=1,r=m;const u=this.addOccultists(t,c.Random.rand,1);u.dropChance=1,r=u;break;case 4:const p=q.WardenEnemy.add(t,t.game,o,a);p.dropTable=["weapon","equipment"],p.dropChance=1,r=p}}else{let i=["reaper","queen","bigskullenemy","bigzombieenemy","bigfrogenemy","exalter"];e>0&&(i.push("occultist"),i=i.filter(t=>"queen"!==t)),t.envType===h.EnvType.FOREST&&i.push("bigfrogenemy"),e>4&&(i.push("warden"),i=i.filter(t=>"bigskullenemy"!==t&&"bigzombieenemy"!==t&&"occultist"!==t));const a=o.Game.randTable(i,c.Random.rand);console.log("bosses",i,"boss",a);const n=a.startsWith("big")||"warden"===a?t.getBigRandomEmptyPosition(s):t.getRandomEmptyPosition(s);if(null===n)return;const{x:l,y:d}=n;switch(a){case"reaper":const e=this.addSpawners(t,c.Random.rand,1);r=e,e.dropTable=["weapon","equipment"],e.dropChance=1;break;case"queen":const i=B.QueenEnemy.add(t,t.game,l,d);i.dropTable=["weapon","equipment"],i.dropChance=1,r=i;break;case"bigskullenemy":const s=Y.BigSkullEnemy.add(t,t.game,l,d);s.dropTable=["weapon","equipment","consumable","gem","tool"],r=s;break;case"occultist":const o=this.addOccultists(t,c.Random.rand,1);o.dropTable=["weapon","equipment"],o.dropChance=1,r=o;break;case"bigzombieenemy":const a=F.BigZombieEnemy.add(t,t.game,l,d);a.dropTable=["weapon","equipment","consumable","gem","tool"],a.dropChance=1,r=a;break;case"warden":const n=q.WardenEnemy.add(t,t.game,l,d);n.dropTable=["weapon","equipment"],n.dropChance=1,r=n;break;case"bigfrogenemy":const h=Q.BigFrogEnemy.add(t,t.game,l,d);h.dropTable=["weapon","equipment","consumable","gem","tool"],r=h;break;case"exalter":const m=J.ExalterEnemy.add(t,t.game,l,d);m.dropTable=["weapon","equipment"],m.dropChance=1,r=m}}r.drops.push(...i)}addChests(t,e,i){let s=t.getEmptyTiles();for(let i=0;i<e;i++){const e=t.getRandomEmptyPosition(s);if(!e)break;const{x:i,y:o}=e;t.entities.push(new I.Chest(t,t.game,i,o))}}addBombs(t,e,i){let s=t.getEmptyTiles();for(let e=0;e<t.getEmptyTiles().length;e++){const e=t.getRandomEmptyPosition(s);if(null===e)break;const{x:i,y:o}=e;S.Bomb.add(t,t.game,i,o)}}addResources(t,e,i){let s=t.getEmptyTiles();for(let o=0;o<e;o++){const e=t.getRandomEmptyPosition(s);if(null===e)break;const{x:o,y:a}=e;let r=i();r<=(10-t.depth**3)/10?W.CoalResource.add(t,t.game,o,a):r<=(10-(t.depth-2)**3)/10?U.GoldResource.add(t,t.game,o,a):j.EmeraldResource.add(t,t.game,o,a)}}addGems(t,e,i){let s=t.getEmptyTiles();for(let a=0;a<e;a++){const e=t.getRandomEmptyPosition(s);if(null===e)break;const{x:a,y:r}=e;let n;t.envType===h.EnvType.CAVE&&(n=o.Game.randTable([j.EmeraldResource,et.AmberResource],i),n.add(t,t.game,a,r)),t.envType===h.EnvType.FOREST&&(n=o.Game.randTable([it.ZirconResource],i),n.add(t,t.game,a,r)),t.envType===h.EnvType.MAGMA_CAVE&&(n=o.Game.randTable([tt.GarnetResource,it.ZirconResource],i)),n.add(t,t.game,a,r)}}addVendingMachine(t,e,i,s,a){const r=t.getRandomEmptyPosition(t.getEmptyTiles());if(null===r)return;let n=i||r.x,h=s||r.y,l=t.depth>0?[1,1,1,1,1,1,1,2,2,2,2,2,2,2,2,1,1,1,2,2,1,1,3,4,5,5,5,5,5,5,5,5,5,6,6,6,7,7,7,8,8,8,9,9,9,10,10,10]:[1,1,1],c=o.Game.randTable(l,e);if(a)T.VendingMachine.add(t,t.game,n,h,a);else switch(c){case 1:T.VendingMachine.add(t,t.game,n,h,new v.Heart(t,n,h));break;case 2:T.VendingMachine.add(t,t.game,n,h,new A.Candle(t,n,h));break;case 3:T.VendingMachine.add(t,t.game,n,h,new M.Armor(t,n,h));break;case 4:T.VendingMachine.add(t,t.game,n,h,new C.Spear(t,n,h));break;case 5:T.VendingMachine.add(t,t.game,n,h,new D.Torch(t,n,h));break;case 6:T.VendingMachine.add(t,t.game,n,h,new $.FishingRod(t,n,h));break;case 7:T.VendingMachine.add(t,t.game,n,h,new Z.Hammer(t,n,h));break;case 8:T.VendingMachine.add(t,t.game,n,h,new ot.Backpack(t,n,h));break;case 9:T.VendingMachine.add(t,t.game,n,h,new rt.Lantern(t,n,h));break;case 10:T.VendingMachine.add(t,t.game,n,h,new at.Coal(t,n,h))}}addRandomTorches(t,e="medium"){const i=o.Game.randTable({none:[0,0,0],low:[0,0,0,1,1],medium:[0,0,0,1,1,2,2,3],high:[1,1,2,2,3,3,4]}[e],c.Random.rand);this.addTorches(t,i,c.Random.rand)}addRandomWindows(t,e="medium"){o.Game.randTable({none:[0,0,0],low:[0,0,0,1,1],medium:[0,0,0,1,1,2,2,3],high:[1,1,2,2,3,3,4]}[e],c.Random.rand)}addEnvironmentalFeatures(t,e){const i=o.Game.rand(1,36,e);switch(t.envType===h.EnvType.TUTORIAL&&this.addTorchesByArea(t),a.GameplaySettings.ORGANIC_TUNNELS_FORCE&&t.type!==u.RoomType.START&&t.type!==u.RoomType.DOWNLADDER&&t.type!==u.RoomType.UPLADDER&&t.type!==u.RoomType.ROPEHOLE&&(a.GameplaySettings.ORGANIC_TUNNELS_DEBUG&&console.log("[OrganicTunnels] FORCED in DUNGEON room",t.globalId),t.builder.addWallBlocksOrganicTunnels(e)),t.type){case u.RoomType.START:0!==t.depth||this.addTorchesByArea(t);break;case u.RoomType.BOSS:const s=t.getBossDoor();this.addDoorTorches(t,s.x,s.y,s.doorDir),this.addTorchesByArea(t),this.addSpikeTraps(t,o.Game.randTable([0,0,0,1,1,2,5],e),e);break;case u.RoomType.DUNGEON:if(t.envType===h.EnvType.TUTORIAL)return;a.GameplaySettings.ORGANIC_TUNNELS_FORCE?(a.GameplaySettings.ORGANIC_TUNNELS_DEBUG&&console.log("[OrganicTunnels] FORCED in DUNGEON room",t.globalId),t.builder.addWallBlocksOrganicTunnels(e)):a.GameplaySettings.ORGANIC_TUNNELS_ENABLED&&(this.level.environment.type!==h.EnvType.CAVE&&this.level.environment.type!==h.EnvType.MAGMA_CAVE&&this.level.environment.type!==h.EnvType.FOREST||(a.GameplaySettings.ORGANIC_TUNNELS_DEBUG&&console.log("[OrganicTunnels] enabled in env",this.level.environment.type,t.globalId),t.height>15||t.width>15?t.builder.addWallBlocksOrganicTunnels(e):i<15?t.builder.addWallBlocksVariant(e):i<20&&t.builder.addWallBlocks(e))),t.envType!==h.EnvType.CASTLE&&(i<12&&this.addPools(t,e),i<12&&this.addChasms(t,e),i<12&&t.depth>5&&this.addMagmaPools(t,e)),this.addTorchesByArea(t),this.addWindowsByArea(t),i>15&&this.addSpikeTraps(t,o.Game.randTable([0,0,0,1,1,2,3],e),e);break;case u.RoomType.BIGDUNGEON:i<5&&t.builder.addWallBlocks(e),1===o.Game.rand(1,4,e)&&this.addChasms(t,e),this.addTorchesByArea(t),1===o.Game.rand(1,3,e)&&this.addSpikeTraps(t,o.Game.randTable([3,5,7,8],e),e);break;case u.RoomType.CAVE:case u.RoomType.BIGCAVE:this.level.environment.type!==h.EnvType.CAVE&&this.level.environment.type!==h.EnvType.MAGMA_CAVE&&this.level.environment.type!==h.EnvType.FOREST||(a.GameplaySettings.ORGANIC_TUNNELS_DEBUG&&console.log("[OrganicTunnels] enabled in env",this.level.environment.type,t.globalId),t.height>15||t.width>15?t.builder.addWallBlocksOrganicTunnels(e):i<15?t.builder.addWallBlocksVariant(e):i<20&&t.builder.addWallBlocks(e)),t.envType!==h.EnvType.CASTLE&&(i<12&&this.addChasms(t,e),i<12&&this.addPools(t,e),i<12&&t.depth>5&&this.addMagmaPools(t,e)),this.level.environment.type===h.EnvType.CASTLE&&this.addTorchesByArea(t),this.addWindowsByArea(t);break;case u.RoomType.GEMCAVE:this.level.environment.type!==h.EnvType.CAVE&&this.level.environment.type!==h.EnvType.MAGMA_CAVE&&this.level.environment.type!==h.EnvType.FOREST||this.addGems(t,o.Game.randTable([1,2,2,2,3,3,3,4],e),e);break;case u.RoomType.TREASURE:case u.RoomType.SPAWNER:this.addTorchesByArea(t);break;case u.RoomType.UPLADDER:this.addRandomTorches(t,"medium");break;case u.RoomType.DOWNLADDER:this.addTorches(t,1,e,t.roomX+3,t.roomY);break;case u.RoomType.ROPEHOLE:case u.RoomType.SPIKECORRIDOR:this.addRandomTorches(t,"medium");break;case u.RoomType.SHOP:this.addTorches(t,2,e);break;case u.RoomType.GRASS:i%4==0&&this.addChasms(t,e),i%3==0&&this.addPools(t,e),this.addTorchesByArea(t),i>15&&this.addSpikeTraps(t,o.Game.randTable([0,0,0,1,1,2,3],e),e)}}placeVendingMachineInWall(t,e){const i=t.getEmptyWall();if(0===i.length)return;const s=o.Game.randTable(i,c.Random.rand);if(!s)return;const a=t.removeEmptyWall(s);if(!a)return;const{x:r,y:n}=a;this.addVendingMachine(t,c.Random.rand,r,n,e),t.roomArray[r][n]=s}}},7180:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.WizardTeleportParticle=void 0;const s=i(824),o=i(7851);class a extends s.Particle{constructor(t,e){super(),this.draw=t=>{this.dead||(o.Game.drawFX(Math.floor(this.frame),3,1,1,this.x,this.y-this.z,1,1),this.z+=this.dz*t,this.dz*=.9,this.frame+=.3*t,this.frame>6&&(this.dead=!0))},this.x=t,this.y=e,this.dead=!1,this.frame=0,this.z=0,this.dz=.1}}e.WizardTeleportParticle=a},7264:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.WaterOverlay=void 0;const s=i(6291),o=i(9962),a={overlayAlpha:.55,shimmerAmplitude:.18,shimmerSpeed:.45,scrollSpeedX:12,scrollSpeedY:-9,canvasPadding:128,layers:[{color:"#02182a",seed:37,scale:65,holeRadius:1.15,sharpness:1.5,opacity:.75,speedX:5,speedY:-5,offsetX:0,offsetY:0},{color:"#042c3a",seed:91,scale:80,holeRadius:1.25,sharpness:1.15,opacity:.5,speedX:-2,speedY:2,offsetX:200,offsetY:100}]};class r{static draw(t,e,i){const o=e/s.GameConstants.FPS;r.time+=o,r.scrollX+=r.config.scrollSpeedX*o,r.scrollY+=r.config.scrollSpeedY*o;const a=1+Math.sin(r.time*r.config.shimmerSpeed*Math.PI*2)*r.config.shimmerAmplitude,h=n(r.config.overlayAlpha*a,0,1),l=r.config.canvasPadding,c=s.GameConstants.WIDTH+2*l,d=s.GameConstants.HEIGHT+2*l,m=i?.x??0,u=i?.y??0,p=m-l+r.scrollX,y=u-l+r.scrollY;if(r.canUseWebgl()){const e=r.renderWithWebgl(c,d,p,y);if(e)return void r.drawBuffer(t,e,h)}r.ensureCpuBuffer(c,d)&&(r.renderCpuTexture(p,y),r.drawBuffer(t,r.cpuBuffer,h))}static canUseWebgl(){return s.GameConstants.USE_WEBGL_WATER_OVERLAY&&!r.webglFailed&&o.WebGLWaterOverlayRenderer.isSupported()}static renderWithWebgl(t,e,i,s){try{const a=o.WebGLWaterOverlayRenderer.getInstance(),n=r.layers.map(t=>({color:[t.colorRgb.r/255,t.colorRgb.g/255,t.colorRgb.b/255],seed:t.seed,scale:t.scale,holeRadius:t.holeRadius,sharpness:t.sharpness,opacity:t.opacity,speed:[t.speedX,t.speedY],offset:[t.offsetX,t.offsetY]}));return a.render({width:t,height:e,layers:n,time:r.time,originX:i,originY:s})}catch(t){return console.warn("[WaterOverlay] WebGL renderer failed  falling back to Canvas2D",t),r.webglFailed=!0,null}}static drawBuffer(t,e,i){t.save(),t.globalAlpha=i,t.globalCompositeOperation="screen",t.drawImage(e,-r.config.canvasPadding,-r.config.canvasPadding),t.restore()}static ensureCpuBuffer(t,e){if(r.cpuBuffer&&r.cpuBufferCtx&&r.cpuFrameData&&r.cpuBuffer.width===t&&r.cpuBuffer.height===e)return!0;if("undefined"==typeof document)return!1;const i=document.createElement("canvas");i.width=t,i.height=e;const s=i.getContext("2d");return!!s&&(r.cpuBuffer=i,r.cpuBufferCtx=s,r.cpuFrameData=s.createImageData(t,e),!0)}static renderCpuTexture(t,e){if(!r.cpuBufferCtx||!r.cpuFrameData)return;const{data:i,width:s,height:o}=r.cpuFrameData;for(let a=0;a<o;a++){const o=e+a;for(let e=0;e<s;e++){const h=t+e;let l=0,c=0,d=0,m=0;for(const t of r.layers){const e=r.sampleVoronoiLayer(t,h,o),i=n(e/t.holeRadius,0,1),s=Math.pow(i,t.sharpness)*t.opacity,a=n(s,0,1);l+=t.colorRgb.r*a,c+=t.colorRgb.g*a,d+=t.colorRgb.b*a,m+=a}const u=4*(a*s+e);i[u]=n(Math.round(l),0,255),i[u+1]=n(Math.round(c),0,255),i[u+2]=n(Math.round(d),0,255),i[u+3]=n(Math.round(255*m),0,255)}}r.cpuBufferCtx.putImageData(r.cpuFrameData,0,0)}static sampleVoronoiLayer(t,e,i){const s=t.offsetX+r.time*t.speedX,o=t.offsetY+r.time*t.speedY,a=(e+s)/t.scale,n=(i+o)/t.scale;return c(a,n,t.seed)}}e.WaterOverlay=r,r.cpuBuffer=null,r.cpuBufferCtx=null,r.cpuFrameData=null,r.time=0,r.scrollX=0,r.scrollY=0,r.webglFailed=!1,r.config=a,r.layers=a.layers.map(t=>({...t,colorRgb:h(t.color)}));const n=(t,e,i)=>Math.min(Math.max(t,e),i);function h(t){const e=t.replace("#",""),i=3===e.length?parseInt(e.split("").map(t=>t+t).join(""),16):parseInt(e,16);return{r:i>>16&255,g:i>>8&255,b:255&i}}const l=(t,e,i)=>{let s=374761393*t+668265263*e+362437*i|0;return s=(s^s>>13)>>>0,s=1274126177*s>>>0,s/4294967295},c=(t,e,i)=>{const s=Math.floor(t),o=Math.floor(e);let a=1/0;for(let r=-1;r<=1;r++)for(let n=-1;n<=1;n++){const h=s+n,c=o+r,d=h+l(h,c,i)-t,m=c+l(h,c,i+1337)-e,u=Math.sqrt(d*d+m*m);u<a&&(a=u)}return n(a/Math.SQRT2,0,1)}},7356:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Block=void 0;const s=i(606),o=i(7851),a=i(606),r=i(7366),n=i(9432),h=i(9467);class l extends s.Entity{constructor(t,e,i,s){super(t,e,i,s),this.uniqueKillBehavior=()=>{this.cloned||r.Sound.delayPlay(r.Sound.breakRock,50)},this.draw=t=>{this.dead||(o.Game.ctx.save(),o.Game.ctx.globalAlpha=this.alpha,this.dead||(this.hasShadow&&this.drawShadow(t),this.updateDrawXY(t),o.Game.drawObj(this.tileX,this.tileY,1,2,this.x-this.drawX,this.y-this.drawYOffset-this.drawY,1,2,this.room.shadeColor,this.shadeAmount())),o.Game.ctx.restore())},this.drawTopLayer=t=>{this.drawableY=this.y},this.room=t,this.health=1,this.tileX=10,this.tileY=2,this.hasShadow=!0,this.chainPushable=!1,this.name="block",this.imageParticleX=0,this.imageParticleY=25,this.opaque=!0,h.Random.rand()<.01&&this.drops.push(new n.Geode(this.room,this.x,this.y))}get type(){return a.EntityType.PROP}}e.Block=l},7366:(t,e,i)=>{"use strict";var s;Object.defineProperty(e,"__esModule",{value:!0}),e.Sound=void 0;const o=i(7851),a=i(9467),r=i(645),n=i(4196);class h{static detectMobile(){const t=navigator.userAgent||navigator.vendor||window.opera;return h.isMobile=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(t),h.isMobile}static async enableAudioForMobile(){if(!h.audioContextResumed)try{n.Howler.ctx&&"suspended"===n.Howler.ctx.state&&(await n.Howler.ctx.resume(),h.audioContextResumed=!0,console.log("AudioContext resumed"))}catch(t){console.warn("Could not resume AudioContext:",t)}}static addMobileAudioHandlers(){const t=["touchstart","click","keydown"],e=()=>{(async()=>{await h.enableAudioForMobile(),h.audioMuted&&r.ReverbEngine.initialized&&(h.audioMuted=!1,n.Howler.mute(!1))})(),t.forEach(t=>{document.removeEventListener(t,e)})};t.forEach(t=>{document.addEventListener(t,e,{once:!0})})}static toggleMute(){h.audioMuted=!h.audioMuted,h.audioMuted?n.Howler.mute(!0):(n.Howler.mute(!1),h.isMobile&&h.enableAudioForMobile())}static playWithReverb(t,e=h.PRIORITY.INTERACTIONS){if(h.audioMuted)return null;try{if(h.currentlyPlaying.size>10&&e<h.PRIORITY.COMBAT)return null;let i=null;return i=r.ReverbEngine.initialized&&!h.isMobile?r.ReverbEngine.applyReverb(t):t.play(),i&&(h.currentlyPlaying.add(i),t.once("end",()=>{h.currentlyPlaying.delete(i)}),setTimeout(()=>{h.currentlyPlaying.delete(i)},5e3)),i}catch(t){return console.error("Error playing sound:",t),null}}static stopSound(t){t.stop()}static stopSoundWithReverb(t){r.ReverbEngine.removeReverb(t),this.stopSound(t)}static cleanup(){h.currentlyPlaying.clear(),n.Howler.unload()}}e.Sound=h,s=h,h.initialized=!1,h.audioMuted=!0,h.currentlyPlaying=new Set,h.PRIORITY={AMBIENT:1,FOOTSTEPS:2,INTERACTIONS:3,COMBAT:4,CRITICAL:5},h.isMobile=!1,h.audioContextResumed=!1,h.forestMusicId=null,h.caveMusicId=null,h.castleMusicId=null,h.ambientSoundId=null,h.loadSounds=async()=>{if(h.initialized)return;h.initialized=!0,h.detectMobile(),h.isMobile&&h.addMobileAudioHandlers(),r.ReverbEngine.initialized&&(h.audioMuted=!1);const t=(t,e,i=1,s=3)=>e.map(e=>new n.Howl({src:[`${t}${e}.mp3`],volume:i,preload:!0,html5:!1,pool:s})),e=(t,e=1,i=!1,s=2)=>new n.Howl({src:[t],volume:e,preload:!0,loop:i,html5:!1,pool:s});try{h.magicSound=e("res/SFX/attacks/magic2.mp3",.25,!1,3),h.warHammerSound=e("res/SFX/attacks/warhammer.mp3",1,!1,3),h.healSound=e("res/SFX/items/powerup1.mp3",.5,!1,1),h.eatSounds=t("res/SFX/items/eat",[1,2],1,5),h.playerStoneFootsteps=t("res/SFX/footsteps/stone/footstep",[1,2,3],1,4),h.playerGrassFootsteps=t("res/SFX/footsteps/grass/footstep",[1,2,3,6],1,4),h.playerDirtFootsteps=t("res/SFX/footsteps/dirt/footstep",[1,2,3,4,5],1,4),h.enemyFootsteps=t("res/SFX/footsteps/enemy/enemyfootstep",[1,2,3,4,5],1,4),h.swingSounds=t("res/SFX/attacks/swing",[1,2,3,4],.5,6),h.hitSounds=t("res/SFX/attacks/hurt",[1,2,3,4],.5,4),h.hurtSounds=[e("res/SFX/attacks/hit.mp3",.3,!1,0)],h.sliceSound=t("res/SFX/attacks/slice",[1,2,3],.5,4),h.shortSliceSound=t("res/SFX/attacks/sliceShort",[1,2,3],.5,4),h.parrySounds=t("res/SFX/attacks/parry",[1,2],.5,3),h.gruntSounds=t("res/SFX/attacks/grunt",[1],.35,1),h.enemySpawnSound=e("res/SFX/attacks/enemyspawn.mp3",.7,!1,3),h.wooshSounds=t("res/SFX/attacks/woosh",[1,2],.2,3),h.chestSounds=t("res/SFX/chest/chest",[1,2,3],.5,3),h.coinPickupSounds=t("res/SFX/items/coins",[1,2,3,4],1,5),h.genericPickupSound=e("res/SFX/items/pickup.mp3",.8,!1,3),h.keyPickupSound=e("res/SFX/items/keyPickup.mp3",1,!1,2),h.backpackSound=e("res/SFX/items/backpack.mp3",.75,!1,2),h.smithSound=e("res/SFX/items/smith.mp3",.5,!1,2),h.lockedSound=e("res/SFX/door/locked1.mp3",.75,!1,2),h.woodSound=e("res/SFX/objects/woodHit1.mp3",1.25,!1,2),h.squishSound=e("res/SFX/attacks/squish1.mp3",.75,!1,2),h.crushSounds=t("res/SFX/attacks/crush",[1,2],.4,2),h.miningSounds=t("res/SFX/resources/Pickaxe",[1,2,3,4],.3,3),h.breakRockSound=e("res/SFX/resources/rockbreak.mp3",1,!1,2),h.unlockSounds=t("res/SFX/door/unlock",[1],.5,2),h.doorOpenSounds=t("res/SFX/door/open",[1,2],.5,3),h.potSmashSounds=t("res/SFX/objects/potSmash",[1,2,3],.5,3),h.bushSounds=t("res/SFX/objects/plantHit",[1,2],.75,3),h.pushSounds=t("res/SFX/pushing/push",[1,2],1,3),h.fishingCastSounds=t("res/SFX/fishing/cast",[1,2],.5,3),h.fishingReelSound=e("res/SFX/fishing/catch.mp3",.5,!1,2),h.fishingCatchSounds=t("res/SFX/fishing/splash",[1,2],.85,3),h.bombSounds=t("res/SFX/attacks/explode",[1,2],.7,3),h.fuseBurnSound=e("res/SFX/attacks/fuse.mp3",.2,!1,2),h.fuseLoopSound=e("res/SFX/attacks/fuseLoop.mp3",.2,!0,1),h.fuseStartSound=e("res/SFX/attacks/fuseStart.mp3",.2,!1,2),h.forestMusic=e("res/music/forest1.mp3",.25,!0,1),h.caveMusic=e("res/music/cave1.mp3",.25,!0,1),h.castleMusic=e("res/music/castle1.mp3",.25,!0,1),h.graveSound=e("res/SFX/attacks/skelespawn.mp3",1,!1,2),h.ambientSound=e("res/SFX/ambient/ambientDark2.mp3",.3,!0,1),h.goreSound=e("res/SFX/misc Unused/gore2.mp3",.5,!1,2),console.log("All sounds loaded successfully")}catch(t){console.error("Error loading sounds:",t)}},h.playerStoneFootstep=t=>{if(h.audioMuted)return;let e=h.playerStoneFootsteps;2===t&&(e=h.playerGrassFootsteps),1===t&&(e=h.playerDirtFootsteps);let i=o.Game.randTable(e,a.Random.rand);s.playWithReverb(i,h.PRIORITY.FOOTSTEPS)},h.enemyFootstep=()=>{if(h.audioMuted)return;let t=o.Game.randTable(h.enemyFootsteps,a.Random.rand);s.playWithReverb(t,h.PRIORITY.FOOTSTEPS)},h.swing=()=>{if(h.audioMuted)return;let t=o.Game.randTable(h.swingSounds,a.Random.rand);s.playWithReverb(t,h.PRIORITY.COMBAT)},h.hit=(t=!1)=>{if(h.audioMuted)return;let e=h.hitSounds.slice(t?2:0,t?3:2);setTimeout(()=>{let t=o.Game.randTable(e,a.Random.rand);s.playWithReverb(t,h.PRIORITY.COMBAT)},100)},h.hurt=()=>{if(h.audioMuted)return;let t=o.Game.randTable(h.hurtSounds,a.Random.rand);s.playWithReverb(t,h.PRIORITY.CRITICAL)},h.enemySpawn=()=>{h.audioMuted||s.playWithReverb(h.enemySpawnSound,h.PRIORITY.CRITICAL)},h.chest=()=>{if(h.audioMuted)return;let t=o.Game.randTable(h.chestSounds,a.Random.rand);s.playWithReverb(t,h.PRIORITY.INTERACTIONS)},h.potSmash=()=>{if(h.audioMuted)return;let t=o.Game.randTable(h.potSmashSounds,a.Random.rand);s.delayPlay(()=>s.playWithReverb(t,h.PRIORITY.INTERACTIONS),100)},h.pickupCoin=()=>{if(h.audioMuted)return;let t=o.Game.randTable(h.coinPickupSounds,a.Random.rand);s.playWithReverb(t,h.PRIORITY.INTERACTIONS)},h.mine=()=>{if(h.audioMuted)return;let t=o.Game.randTable(h.miningSounds,a.Random.rand);s.playWithReverb(t,h.PRIORITY.INTERACTIONS)},h.breakRock=()=>{h.audioMuted||setTimeout(()=>{s.playWithReverb(h.breakRockSound,h.PRIORITY.INTERACTIONS)},100)},h.heal=()=>{h.audioMuted||s.playWithReverb(h.healSound,h.PRIORITY.CRITICAL)},h.genericPickup=()=>{h.audioMuted||s.playWithReverb(h.genericPickupSound,h.PRIORITY.INTERACTIONS)},h.keyPickup=()=>{h.audioMuted||s.playWithReverb(h.keyPickupSound,h.PRIORITY.INTERACTIONS)},h.push=()=>{if(h.audioMuted)return;let t=o.Game.randTable(h.pushSounds,a.Random.rand);s.playWithReverb(t,h.PRIORITY.INTERACTIONS)},h.skeleSpawn=()=>{h.audioMuted||(h.graveSound.volume(.3),s.playWithReverb(h.graveSound,h.PRIORITY.CRITICAL))},h.unlock=()=>{if(h.audioMuted)return;let t=o.Game.randTable(h.unlockSounds,a.Random.rand);s.playWithReverb(t,h.PRIORITY.INTERACTIONS)},h.playCaveMusic=(t=0)=>{if(!h.audioMuted)try{h.caveMusicId&&h.caveMusic.stop(h.caveMusicId),h.caveMusicId=h.caveMusic.play(),h.isMobile&&!h.audioContextResumed&&h.enableAudioForMobile()}catch(t){console.error("Error playing cave music:",t)}},h.playForestMusic=(t=0)=>{if(!h.audioMuted)try{h.forestMusicId&&h.forestMusic.stop(h.forestMusicId),h.forestMusicId=h.forestMusic.play(),h.isMobile&&!h.audioContextResumed&&h.enableAudioForMobile()}catch(t){console.error("Error playing forest music:",t)}},h.playCastleMusic=(t=0)=>{if(!h.audioMuted)try{h.castleMusicId&&h.castleMusic.stop(h.castleMusicId),h.castleMusicId=h.castleMusic.play(),h.isMobile&&!h.audioContextResumed&&h.enableAudioForMobile()}catch(t){console.error("Error playing castle music:",t)}},h.stopMusic=()=>{(h.forestMusicId||h.caveMusicId)&&(h.forestMusic.stop(h.forestMusicId),h.caveMusic.stop(h.caveMusicId),h.castleMusic.stop(h.castleMusicId))},h.doorOpen=()=>{if(h.audioMuted)return;let t=o.Game.randTable(h.doorOpenSounds,a.Random.rand);s.playWithReverb(t,h.PRIORITY.INTERACTIONS)},h.playAmbient=()=>{if(!h.audioMuted)try{h.ambientSoundId&&h.ambientSound.playing(h.ambientSoundId)||(h.ambientSoundId=h.ambientSound.play())}catch(t){console.error("Error playing ambient sound:",t)}},h.stopAmbient=()=>{h.ambientSoundId&&(h.ambientSound.stop(h.ambientSoundId),h.ambientSoundId=null)},h.playFuse=()=>{h.audioMuted||(h.fuseStartSound.play(),h.fuseStartSound.once("end",()=>{h.fuseLoopSound.play()}))},h.stopFuse=()=>{h.fuseLoopSound.stop(),h.fuseStartSound.stop()},h.playGore=()=>{h.audioMuted||s.playWithReverb(h.goreSound,h.PRIORITY.COMBAT)},h.playBomb=()=>{if(h.audioMuted)return;let t=o.Game.randTable(h.bombSounds,a.Random.rand);s.playWithReverb(t,h.PRIORITY.CRITICAL)},h.playWarHammer=()=>{h.audioMuted||s.delayPlay(()=>{s.playWithReverb(h.hitSounds[2],h.PRIORITY.COMBAT)},200)},h.playMagic=()=>{if(h.audioMuted)return;s.playWithReverb(h.magicSound,h.PRIORITY.COMBAT);let t=h.wooshSounds[0];s.playWithReverb(t,h.PRIORITY.COMBAT)},h.playSlice=()=>{if(h.audioMuted)return;let t=o.Game.randTable(h.sliceSound,a.Random.rand);s.playWithReverb(t,h.PRIORITY.COMBAT)},h.playShortSlice=()=>{if(h.audioMuted)return;let t=o.Game.randTable(h.shortSliceSound,a.Random.rand);s.playWithReverb(t,h.PRIORITY.COMBAT)},h.playBackpack=()=>{h.audioMuted||s.playWithReverb(h.backpackSound,h.PRIORITY.INTERACTIONS)},h.playSmith=()=>{h.audioMuted||s.playWithReverb(h.smithSound,h.PRIORITY.INTERACTIONS)},h.playBush=()=>{if(h.audioMuted)return;let t=o.Game.randTable(h.bushSounds,a.Random.rand);s.delayPlay(()=>s.playWithReverb(t,h.PRIORITY.INTERACTIONS),100)},h.playParry=()=>{if(h.audioMuted)return;let t=o.Game.randTable(h.parrySounds,a.Random.rand);s.delayPlay(()=>s.playWithReverb(t,h.PRIORITY.CRITICAL),100)},h.playEat=()=>{if(h.audioMuted)return;let t=o.Game.randTable(h.eatSounds,a.Random.rand);s.playWithReverb(t,h.PRIORITY.INTERACTIONS)},h.playGrunt=()=>{if(h.audioMuted)return;let t=o.Game.randTable(h.gruntSounds,a.Random.rand);s.playWithReverb(t,h.PRIORITY.COMBAT)},h.playLocked=()=>{h.audioMuted||s.playWithReverb(h.lockedSound,h.PRIORITY.INTERACTIONS)},h.playWood=()=>{h.audioMuted||s.delayPlay(()=>{s.playWithReverb(h.woodSound,h.PRIORITY.INTERACTIONS)},150)},h.playSquish=()=>{h.audioMuted||s.playWithReverb(h.squishSound,h.PRIORITY.INTERACTIONS)},h.playFishingCast=()=>{if(h.audioMuted)return;let t=o.Game.randTable(h.fishingCastSounds,a.Random.rand);s.playWithReverb(t,h.PRIORITY.INTERACTIONS)},h.playFishingReel=()=>{h.audioMuted||s.playWithReverb(h.fishingReelSound,h.PRIORITY.INTERACTIONS)},h.playFishingCatch=()=>{if(h.audioMuted)return;let t=o.Game.randTable(h.fishingCatchSounds,a.Random.rand);s.delayPlay(()=>s.playWithReverb(t,h.PRIORITY.INTERACTIONS),100)},h.playCrush=()=>{if(h.audioMuted)return;let t=h.wooshSounds[1],e=h.crushSounds[1];s.playWithReverb(t,h.PRIORITY.COMBAT),s.delayPlay(()=>{s.playWithReverb(e,h.PRIORITY.COMBAT)},200),s.playWithReverb(t,h.PRIORITY.COMBAT)},h.delayPlay=(t,e)=>{setTimeout(t,e)}},7418:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.GodStone=void 0;const s=i(4118),o=i(5180);class a extends o.Usable{constructor(t,e,i){super(t,e,i),this.onUse=t=>{this.teleportToExit(t)},this.teleportToExit=t=>{let e=this.level.game.rooms.filter(t=>t.type===s.RoomType.DOWNLADDER);console.log("downLadders",e);const i=e[e.length-1];this.level.game.rooms.forEach(t=>{t.entered=!0,t.calculateWallInfo()}),i.game.changeLevelThroughDoor(t,i.doors[0],1),t.x=i.roomX+2,t.y=i.roomY+3;try{t.map.updateSeenTiles(),t.map.saveMapData()}catch{}},this.getDescription=()=>"YOU SHOULD NOT HAVE THIS",this.count=0,this.tileX=31,this.tileY=0,this.stackable=!0}}e.GodStone=a},7445:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.environmentData=e.NullProp=e.Environment=e.enemyClassToId=void 0;const s=i(3201),o=i(7356),a=i(5711),r=i(32),n=i(4854),h=i(8654),l=i(7142),c=i(8004),d=i(4021),m=i(7976),u=i(1626),p=i(8017),y=i(8132),g=i(1987),f=i(5838),w=i(5146),E=i(8323),x=i(5741),b=i(1073),T=i(5367),I=i(249),S=i(1096),v=i(8200),A=i(7716),M=i(3180),C=i(7975),D=i(5339),O=i(9982),_=i(6493),R=i(3005),G=i(492),P=i(675),L=i(6598),k=i(5097),N=i(9357),Y=i(3175),B=i(4159),H=i(1429),X=i(9997),F=i(6525),W=i(1040),U=i(5016),j=i(8363),V=i(8821),z=i(6751),q=i(3709),$=i(9852),Z=i(3691),K=i(4624),Q=i(1932),J=i(3164),tt=i(267),et=i(2125),it=i(7064),st=i(3263),ot=i(2661),at=i(3202),rt=i(3122),nt=i(6392),ht=i(3779),lt=i(5312),ct=i(7463),dt=i(721),mt=i(9830),ut=i(5643),pt=i(6739);e.enemyClassToId=new Map([[v.CrabEnemy,1],[A.FrogEnemy,2],[M.ZombieEnemy,3],[C.SkullEnemy,4],[D.EnergyWizardEnemy,5],[O.ChargeEnemy,6],[_.RookEnemy,7],[R.BishopEnemy,8],[G.ArmoredzombieEnemy,9],[P.BigSkullEnemy,10],[L.QueenEnemy,11],[k.KnightEnemy,12],[N.BigKnightEnemy,13],[B.FireWizardEnemy,14],[Y.ArmoredSkullEnemy,15],[H.MummyEnemy,16],[X.SpiderEnemy,17],[W.PawnEnemy,18],[U.BigFrogEnemy,19],[j.BeetleEnemy,20],[Z.KingEnemy,21],[ht.BoltcasterEnemy,22],[dt.EarthWizardEnemy,23]]),e.Environment=class{constructor(t){this.type=t,this.skin=this.type,this.type===b.EnvType.TUTORIAL&&(this.skin=y.SkinType.DUNGEON)}};class yt{static add(){}}e.NullProp=yt;const gt={[b.EnvType.DUNGEON]:{props:[{class:n.Crate,weight:1},{class:s.Barrel,weight:1},{class:u.TombStone,weight:.01,additionalParams:[1]},{class:u.TombStone,weight:.01,additionalParams:[0]},{class:d.Pumpkin,weight:.05},{class:o.Block,weight:1},{class:l.Pot,weight:1},{class:c.PottedPlant,weight:1},{class:h.Mushrooms,weight:.1},{class:a.Bush,weight:.1},{class:m.Sprout,weight:.025},{class:r.Chest,weight:.025},{class:T.DecoBlock,weight:.05},{class:I.Furnace,weight:.05}],enemies:[{class:v.CrabEnemy,weight:1,minDepth:0},{class:M.ZombieEnemy,weight:1.2,minDepth:0},{class:C.SkullEnemy,weight:1,minDepth:0},{class:X.SpiderEnemy,weight:1,minDepth:2},{class:H.MummyEnemy,weight:1,minDepth:2},{class:W.PawnEnemy,weight:1,minDepth:1},{class:Z.KingEnemy,weight:.1,minDepth:2},{class:ht.BoltcasterEnemy,weight:.25,minDepth:4},{class:D.EnergyWizardEnemy,weight:.1,minDepth:1},{class:_.RookEnemy,weight:.6,minDepth:1},{class:R.BishopEnemy,weight:.6,minDepth:1},{class:G.ArmoredzombieEnemy,weight:.8,minDepth:1},{class:k.KnightEnemy,weight:.7,minDepth:1},{class:O.ChargeEnemy,weight:.5,minDepth:2},{class:P.BigSkullEnemy,weight:.1,minDepth:2,specialSpawnLogic:"clearFloor",size:{w:2,h:2}},{class:L.QueenEnemy,weight:.2,minDepth:2},{class:N.BigKnightEnemy,weight:.1,minDepth:2,specialSpawnLogic:"clearFloor",size:{w:2,h:2}},{class:B.FireWizardEnemy,weight:.1,minDepth:2},{class:dt.EarthWizardEnemy,weight:.1,minDepth:2},{class:Y.ArmoredSkullEnemy,weight:.5,minDepth:2},{class:U.BigFrogEnemy,weight:.1,minDepth:2,specialSpawnLogic:"clearFloor",size:{w:2,h:2}}]},[b.EnvType.CAVE]:{props:[{class:yt,weight:1},{class:g.CoalResource,weight:.5,blob:{enabled:!0,weight:.5,diameter:5}},{class:f.GoldResource,weight:.05,blob:{enabled:!0,weight:.25,diameter:5}},{class:mt.IronResource,weight:.1,blob:{enabled:!0,weight:.25,diameter:5}},{class:w.EmeraldResource,weight:.001},{class:q.AmberResource,weight:.001},{class:lt.CaveRock,weight:.2},{class:h.Mushrooms,weight:.02},{class:l.Pot,weight:.01},{class:r.Chest,weight:.01},{class:ct.CaveBlock,weight:.5}],enemies:[{class:v.CrabEnemy,weight:1.5,minDepth:0},{class:X.SpiderEnemy,weight:1.2,minDepth:1},{class:C.SkullEnemy,weight:.8,minDepth:0},{class:O.ChargeEnemy,weight:1,minDepth:2},{class:G.ArmoredzombieEnemy,weight:.6,minDepth:1},{class:D.EnergyWizardEnemy,weight:.5,minDepth:1},{class:j.BeetleEnemy,weight:.5,minDepth:1},{class:P.BigSkullEnemy,weight:.15,minDepth:2,specialSpawnLogic:"clearFloor",size:{w:2,h:2}},{class:Y.ArmoredSkullEnemy,weight:.7,minDepth:2}]},[b.EnvType.FOREST]:{props:[{class:yt,weight:2},{class:u.TombStone,weight:1,additionalParams:[1],blob:{enabled:!0,weight:.03,diameter:5}},{class:u.TombStone,weight:1,additionalParams:[0],blob:{enabled:!0,weight:.03,diameter:5}},{class:d.Pumpkin,weight:.05},{class:a.Bush,weight:2},{class:z.ZirconResource,weight:.001},{class:m.Sprout,weight:.05},{class:h.Mushrooms,weight:.05},{class:p.Rock,weight:.1},{class:r.Chest,weight:.01},{class:E.GlowBugEnemy,weight:.05},{class:x.Tree,weight:1,blob:{enabled:!0,weight:.1,diameter:12}},{class:et.Succulent,weight:.1},{class:it.SmallBush,weight:.5}],enemies:[{class:E.GlowBugEnemy,weight:1.5,minDepth:0,blob:{enabled:!0,weight:.08,diameter:6,maxBlobs:6,chance:.6}},{class:A.FrogEnemy,weight:.25,minDepth:0,blob:{enabled:!0,weight:.06,diameter:7,chance:.5}},{class:j.BeetleEnemy,weight:.1,minDepth:0,blob:{enabled:!0,weight:.05,diameter:6,chance:.4}},{class:v.CrabEnemy,weight:.3,minDepth:0,blob:{enabled:!0,weight:.04,diameter:5,chance:.35}},{class:M.ZombieEnemy,weight:.2,minDepth:0,blob:{enabled:!0,weight:.03,diameter:5,chance:.3}},{class:C.SkullEnemy,weight:.1,minDepth:0,blob:{enabled:!0,weight:.03,diameter:5,chance:.25}},{class:D.EnergyWizardEnemy,weight:.2,minDepth:1,blob:{enabled:!0,weight:.02,diameter:9,chance:.3}},{class:dt.EarthWizardEnemy,weight:.2,minDepth:1,blob:{enabled:!0,weight:.02,diameter:9,chance:.3}},{class:U.BigFrogEnemy,weight:.1,minDepth:2,specialSpawnLogic:"clearFloor",size:{w:2,h:2},blob:{enabled:!0,weight:.04,diameter:10,maxBlobs:2,chance:.5}}]},[b.EnvType.DESERT]:{props:[{class:yt,weight:2},{class:s.Barrel,weight:8},{class:u.TombStone,weight:5,additionalParams:[1]},{class:u.TombStone,weight:2,additionalParams:[0]},{class:o.Block,weight:5},{class:h.Mushrooms,weight:.5},{class:a.Bush,weight:.25},{class:l.Pot,weight:.15},{class:p.Rock,weight:.05},{class:r.Chest,weight:.05}],enemies:[{class:M.ZombieEnemy,weight:1.8,minDepth:0},{class:A.FrogEnemy,weight:1.5,minDepth:1},{class:H.MummyEnemy,weight:1,minDepth:2},{class:G.ArmoredzombieEnemy,weight:1.2,minDepth:1},{class:v.CrabEnemy,weight:.8,minDepth:0},{class:C.SkullEnemy,weight:1,minDepth:0},{class:X.SpiderEnemy,weight:.6,minDepth:0},{class:Y.ArmoredSkullEnemy,weight:.8,minDepth:2},{class:D.EnergyWizardEnemy,weight:.3,minDepth:1}]},[b.EnvType.GLACIER]:{props:[{class:yt,weight:2},{class:o.Block,weight:20},{class:n.Crate,weight:5},{class:p.Rock,weight:.6},{class:r.Chest,weight:.4}],enemies:[{class:v.CrabEnemy,weight:1,minDepth:0},{class:O.ChargeEnemy,weight:1.2,minDepth:2},{class:k.KnightEnemy,weight:1,minDepth:1},{class:N.BigKnightEnemy,weight:.15,minDepth:2,specialSpawnLogic:"clearFloor",size:{w:2,h:2}},{class:G.ArmoredzombieEnemy,weight:.8,minDepth:1},{class:Y.ArmoredSkullEnemy,weight:.9,minDepth:2},{class:_.RookEnemy,weight:.7,minDepth:1},{class:R.BishopEnemy,weight:.7,minDepth:1},{class:P.BigSkullEnemy,weight:.1,minDepth:2,specialSpawnLogic:"clearFloor",size:{w:2,h:2}}]},[b.EnvType.CASTLE]:{props:[{class:yt,weight:1},{class:n.Crate,weight:2},{class:s.Barrel,weight:2},{class:o.Block,weight:.25},{class:c.PottedPlant,weight:.1},{class:l.Pot,weight:.1},{class:r.Chest,weight:.1},{class:$.Candelabra,weight:.5},{class:J.PawnStatue,weight:.75},{class:Q.RookStatue,weight:.75},{class:K.BishopStatue,weight:.75},{class:tt.FallenPillar,weight:.5,size:{w:2,h:1}}],enemies:[{class:k.KnightEnemy,weight:2,minDepth:0},{class:N.BigKnightEnemy,weight:.2,minDepth:2,specialSpawnLogic:"clearFloor",size:{w:2,h:2}},{class:W.PawnEnemy,weight:1.5,minDepth:0},{class:_.RookEnemy,weight:1,minDepth:0},{class:R.BishopEnemy,weight:1,minDepth:0},{class:L.QueenEnemy,weight:.5,minDepth:0},{class:Z.KingEnemy,weight:.125,minDepth:0},{class:G.ArmoredzombieEnemy,weight:.25,minDepth:0},{class:Y.ArmoredSkullEnemy,weight:.25,minDepth:0},{class:D.EnergyWizardEnemy,weight:.1,minDepth:0},{class:B.FireWizardEnemy,weight:.1,minDepth:0},{class:O.ChargeEnemy,weight:.1,minDepth:0}]},[b.EnvType.DARK_CASTLE]:{props:[{class:yt,weight:2},{class:at.DarkCrate,weight:2},{class:s.Barrel,weight:1},{class:rt.DarkPot,weight:1},{class:nt.DarkVase,weight:1},{class:r.Chest,weight:.15},{class:ot.DarkPillar,weight:.05},{class:J.PawnStatue,weight:.2},{class:Q.RookStatue,weight:.2},{class:K.BishopStatue,weight:.2}],enemies:[{class:_.RookEnemy,weight:1.2,minDepth:1},{class:R.BishopEnemy,weight:1.2,minDepth:1},{class:k.KnightEnemy,weight:1.6,minDepth:1},{class:W.PawnEnemy,weight:1.5,minDepth:0},{class:L.QueenEnemy,weight:.35,minDepth:2},{class:Z.KingEnemy,weight:.125,minDepth:2},{class:ht.BoltcasterEnemy,weight:.25,minDepth:1},{class:D.EnergyWizardEnemy,weight:.4,minDepth:1},{class:B.FireWizardEnemy,weight:.35,minDepth:2},{class:N.BigKnightEnemy,weight:.15,minDepth:2,specialSpawnLogic:"clearFloor",size:{w:2,h:2}},{class:Y.ArmoredSkullEnemy,weight:.8,minDepth:2}]},[b.EnvType.PLACEHOLDER]:{props:[{class:yt,weight:1}],enemies:[]},[b.EnvType.MAGMA_CAVE]:{props:[{class:yt,weight:1},{class:F.ObsidianResource,weight:.5},{class:r.Chest,weight:.05},{class:st.ObsidianBlock,weight:3},{class:w.EmeraldResource,weight:.025},{class:V.GarnetResource,weight:.025},{class:z.ZirconResource,weight:.025},{class:q.AmberResource,weight:.025},{class:V.GarnetResource,weight:.001}],enemies:[{class:G.ArmoredzombieEnemy,weight:.8,minDepth:1},{class:R.BishopEnemy,weight:.6,minDepth:1},{class:D.EnergyWizardEnemy,weight:.1,minDepth:1},{class:k.KnightEnemy,weight:.7,minDepth:1},{class:_.RookEnemy,weight:.6,minDepth:1},{class:ht.BoltcasterEnemy,weight:.25,minDepth:1},{class:Y.ArmoredSkullEnemy,weight:.7,minDepth:2},{class:N.BigKnightEnemy,weight:.3,minDepth:2,specialSpawnLogic:"clearFloor",size:{w:2,h:2}},{class:P.BigSkullEnemy,weight:.35,minDepth:2,specialSpawnLogic:"clearFloor",size:{w:2,h:2}},{class:R.BishopEnemy,weight:.5,minDepth:2},{class:O.ChargeEnemy,weight:.5,minDepth:2},{class:B.FireWizardEnemy,weight:.9,minDepth:2},{class:H.MummyEnemy,weight:.5,minDepth:2},{class:L.QueenEnemy,weight:.25,minDepth:2},{class:X.SpiderEnemy,weight:.5,minDepth:2}]},[b.EnvType.DARK_DUNGEON]:{props:[{class:at.DarkCrate,weight:1},{class:s.Barrel,weight:1},{class:u.TombStone,weight:.01,additionalParams:[1]},{class:u.TombStone,weight:.01,additionalParams:[0]},{class:d.Pumpkin,weight:.05},{class:o.Block,weight:1},{class:rt.DarkPot,weight:1},{class:nt.DarkVase,weight:1},{class:h.Mushrooms,weight:.1},{class:a.Bush,weight:.1},{class:m.Sprout,weight:.025},{class:r.Chest,weight:.025},{class:ot.DarkPillar,weight:.05},{class:I.Furnace,weight:.05}],enemies:[{class:v.CrabEnemy,weight:1,minDepth:0},{class:M.ZombieEnemy,weight:1.2,minDepth:0},{class:C.SkullEnemy,weight:1,minDepth:0},{class:X.SpiderEnemy,weight:1,minDepth:2},{class:H.MummyEnemy,weight:1,minDepth:2},{class:W.PawnEnemy,weight:1,minDepth:1},{class:Z.KingEnemy,weight:.2,minDepth:2},{class:ht.BoltcasterEnemy,weight:.25,minDepth:1},{class:D.EnergyWizardEnemy,weight:.1,minDepth:1},{class:_.RookEnemy,weight:.6,minDepth:1},{class:R.BishopEnemy,weight:.6,minDepth:1},{class:G.ArmoredzombieEnemy,weight:.8,minDepth:1},{class:k.KnightEnemy,weight:.7,minDepth:1},{class:O.ChargeEnemy,weight:.5,minDepth:2},{class:P.BigSkullEnemy,weight:.1,minDepth:2,specialSpawnLogic:"clearFloor",size:{w:2,h:2}},{class:L.QueenEnemy,weight:.2,minDepth:2},{class:N.BigKnightEnemy,weight:.1,minDepth:2,specialSpawnLogic:"clearFloor",size:{w:2,h:2}},{class:B.FireWizardEnemy,weight:.1,minDepth:2},{class:Y.ArmoredSkullEnemy,weight:.5,minDepth:2},{class:U.BigFrogEnemy,weight:.1,minDepth:2,specialSpawnLogic:"clearFloor",size:{w:2,h:2}}]},[b.EnvType.TUTORIAL]:{props:[{class:n.Crate,weight:1},{class:d.Pumpkin,weight:.01},{class:o.Block,weight:1},{class:l.Pot,weight:1}],enemies:[{class:v.CrabEnemy,weight:1,minDepth:0},{class:M.ZombieEnemy,weight:1.2,minDepth:0},{class:C.SkullEnemy,weight:1,minDepth:0},{class:W.PawnEnemy,weight:1,minDepth:1}]},[b.EnvType.FLOODED_CAVE]:{props:[{class:yt,weight:.25},{class:et.Succulent,weight:.2},{class:S.TallSucculent,weight:.2},{class:ut.Rubble,weight:.2},{class:pt.Glowshrooms,weight:.1}],enemies:[]}};e.environmentData=gt},7455:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.SpikeTrap=void 0;const s=i(7851),o=i(8132),a=i(4854),r=i(3201),n=i(369);class h extends o.Tile{constructor(t,e,i,o){super(t,e,i),this.tick=()=>{if(this.tickCount++,this.tickCount>=4&&(this.tickCount=0),this.on=0===this.tickCount,this.on)for(const t in this.room.game.players)this.room===this.room.game.rooms[this.room.game.players[t].levelID]&&this.room.game.players[t].x===this.x&&this.room.game.players[t].y===this.y&&this.room.game.players[t].hurt(.5,"spike trap");3===this.tickCount&&this.room.hitwarnings.push(new n.HitWarning(this.room.game,this.x,this.y,this.x,this.y,!1))},this.tickEnd=()=>{if(this.on)for(const t of this.room.entities)t.x===this.x&&t.y===this.y&&t.hurt(null,1)},this.onCollideEnemy=t=>{this.on&&!(t instanceof a.Crate||t instanceof r.Barrel)&&t.hurt(null,1)},this.draw=t=>{s.Game.drawTile(1,this.skin,1,1,this.x,this.y,1,1,this.room.shadeColor,this.shadeAmount());let e=0;this.t+=t,this.on||3!==this.tickCount||(Math.floor(this.t)%4==1&&(e=.0325),Math.floor(this.t)%4==3&&(e=-.0325));let i=[0,1,2,3,3,4,2,0],o=6+i[Math.floor(this.frame)];(1===this.tickCount||0===this.tickCount&&0===i[Math.floor(this.frame)])&&(o=5),s.Game.drawObj(o,1,1,1,this.x+e,this.y,1,1,this.room.shadeColor,this.shadeAmount()),s.Game.drawObj(o,0,1,1,this.x+e,this.y-1,1,1,this.room.shadeColor,this.shadeAmount(0,0,!1)),this.on&&this.frame<i.length-1&&(i[Math.floor(this.frame)]<3?this.frame+=.4*t:this.frame+=.2*t),this.on||(this.frame=0)},this.tickCount=o||0,this.on=!1,this.frame=0,this.t=0,this.name="spike trap"}}e.SpikeTrap=h},7463:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.CaveBlock=void 0;const s=i(7851),o=i(606),a=i(7366),r=i(7172);class n extends r.Resource{constructor(t,e,i,o){super(t,e,i,o),this.draw=t=>{this.dead||(s.Game.ctx.save(),s.Game.ctx.globalAlpha=this.alpha,this.dead||(this.updateDrawXY(t),this.hasShadow&&this.drawShadow(t),s.Game.drawObj(this.tileX,this.tileY,2,2,this.x-this.drawX-.5,this.y-this.drawYOffset-this.drawY,2,2,this.room.shadeColor,this.shadeAmount())),s.Game.ctx.restore())},this.drawTopLayer=t=>{this.drawableY=this.y},this.room=t,this.health=1,this.tileX=18,this.tileY=8,this.hasShadow=!0,this.chainPushable=!1,this.name="cave rock",this.imageParticleX=9,this.imageParticleY=25,this.opaque=!0,this.hitSound=a.Sound.breakRock,this.extendShadow=!0,this.shadowOpacity=.5}get type(){return o.EntityType.PROP}}e.CaveBlock=n},7494:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.QuarterStaff=void 0;const s=i(4052),o=i(7366);class a extends s.Weapon{constructor(t,e,i){super(t,e,i),this.hitSound=()=>{o.Sound.swing(),o.Sound.hit()},this.tileX=22,this.tileY=4,this.damage=1,this.name=a.itemName,this.useCost=1,this.degradeable=!1,this.knockbackDistance=1}}e.QuarterStaff=a,a.itemName="quarterstaff"},7510:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.GoldRing=void 0;const s=i(8549),o=i(9066),a=i(3379),r=i(529),n=i(2321);class h extends s.Equippable{constructor(t,e,i){super(t,e,i),this.embed=(t,e)=>{switch(t.inventory.subtractItem(e,1),t.inventory.removeItem(this),e.name){case"emerald":t.inventory.addItem(new o.EmeraldRing(this.level,this.x,this.y));break;case"zircon":t.inventory.addItem(new a.ZirconRing(this.level,this.x,this.y));break;case"amber":t.inventory.addItem(new r.AmberRing(this.level,this.x,this.y));break;case"garnet":t.inventory.addItem(new n.GarnetRing(this.level,this.x,this.y))}this.level.game.pushMessage("You embed the gem into the ring.")},this.tileX=19,this.tileY=2,this.name=h.itemName,this.stackable=!1,this.description="Embed a gem within this ring to imbue it with magic."}}e.GoldRing=h,h.itemName="gold ring"},7512:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Shotgun=void 0;const s=i(4052),o=i(1731);class a extends s.Weapon{constructor(t,e,i){super(t,e,i),this.weaponMove=(t,e)=>{let i=2*t-this.wielder.x,s=2*e-this.wielder.y,a=3*t-2*this.wielder.x,r=3*e-2*this.wielder.y,n=3;if(!this.game.rooms[this.wielder.levelID].tileInside(t,e)||this.game.rooms[this.wielder.levelID].roomArray[t][e].isSolid())return!0;!this.game.rooms[this.wielder.levelID].tileInside(i,s)||this.game.rooms[this.wielder.levelID].roomArray[i][s].isSolid()?n=1:this.game.rooms[this.wielder.levelID].tileInside(a,r)&&!this.game.rooms[this.wielder.levelID].roomArray[a][r].isSolid()||(n=2);let h=[],l=4,c=5,d=5;for(let o of this.game.rooms[this.wielder.levelID].entities)if(o.pushable){if(o.pointIn(t,e))return!0;o.pointIn(i,s)&&n>=2&&(h.push({enemy:o,dist:2}),l=2),o.pointIn(a,r)&&n>=3&&(h.push({enemy:o,dist:3}),l=Math.min(l,3))}else o.destroyable?(o.pointIn(t,e)&&n>=1&&(c=1,h.push({enemy:o,dist:1})),o.pointIn(i,s)&&n>=2&&(c=Math.min(c,2),h.push({enemy:o,dist:2})),o.pointIn(a,r)&&n>=3&&(c=Math.min(c,3),h.push({enemy:o,dist:3}))):(o.pointIn(t,e)&&n>=1&&(d=1),o.pointIn(i,s)&&n>=2&&(d=Math.min(d,2)),o.pointIn(a,r)&&n>=3&&(d=Math.min(d,3)));let m=a,u=r;if(d<c&&d<l)return!0;if(c<=l){this.beginSwing();for(const t of h){let e=t.enemy;const i=3===t.dist?.5:1;this.shouldHitEntity(e)&&e.hurt(this.wielder,i)}this.hitSound(),this.wielder.setHitXY(t,e),o.GenericParticle.shotgun(this.game.rooms[this.wielder.levelID],this.wielder.x+.5,this.wielder.y,m+.5,u,"black"),o.GenericParticle.shotgun(this.game.rooms[this.wielder.levelID],this.wielder.x+.5,this.wielder.y,m+.5,u,"#ffddff");let i=new o.GenericParticle(this.game.rooms[this.wielder.levelID],.5*(t+this.wielder.x)+.5,.5*(e+this.wielder.y),0,1,0,0,0,"white",0);return i.expirationTimer=10,this.game.rooms[this.wielder.levelID].particles.push(i),this.game.rooms[this.wielder.levelID].tick(this.wielder),this.shakeScreen(t,e),this.degrade(),this.endSwing(),!1}return!0},this.tileX=26,this.tileY=0,this.name="shotgun"}}e.Shotgun=a,a.itemName="shotgun"},7716:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.FrogEnemy=void 0;const s=i(7851),o=i(369),a=i(7455),r=i(1236),n=i(6986),h=i(6199);class l extends n.Enemy{constructor(t,e,i,n,l){super(t,e,i,n),this.hit=()=>this.damage,this.behavior=()=>{if(this.lastX=this.x,this.lastY=this.y,this.tileX=1,this.frameLength=3,this.animationSpeed=.1,!this.dead){if(this.handleSkipTurns())return;if(this.seenPlayer){if(this.seenPlayer){if(this.tileX=1,this.room.playerTicked===this.targetPlayer)if(this.alertTicks=Math.max(0,this.alertTicks-1),this.ticks++,this.ticks%2==1){this.rumbling=!0,this.x,this.y;let t=Array();for(const e of this.room.entities)e!==this&&t.push({x:e.x,y:e.y});for(let e=this.x-1;e<=this.x+1;e++)for(let i=this.y-1;i<=this.y+1;i++)this.room.roomArray[e][i]instanceof a.SpikeTrap&&this.room.roomArray[e][i].on&&t.push({x:e,y:i});let e={x:this.targetPlayer.x,y:this.targetPlayer.y},i=this.targetPlayer.x-this.x,o=this.targetPlayer.y-this.y;if(0===i&&o<=1||i<=1&&0===o||0===i&&o>=-1||i>=-1&&0===o){let t=this.targetPlayer.x+i,s=this.targetPlayer.y+o;this.room.roomArray[t]&&this.room.roomArray[t][s]&&(this.room.roomArray[t][s].isSolid()||(e={x:t,y:s}))}const r=this.searchPathLocalized(e,t,{useLastPlayerPos:!0,allowOmni:!1});if(r[1]){let t=!1;for(const e in this.game.players)this.game.rooms[this.game.players[e].levelID]===this.room&&this.game.players[e].x===r[1].pos.x&&this.game.players[e].y===r[1].pos.y&&(this.game.players[e].hurt(this.hit(),this.name),this.drawX+=1.5*(this.x-this.game.players[e].x),this.drawY+=1.5*(this.y-this.game.players[e].y),this.game.players[e]===this.game.players[this.game.localPlayerID]&&this.game.shakeScreen(5*this.drawX,5*this.drawY),t=!0);if(!t&&r.length>1){let t=r[1].pos.x,e=r[1].pos.y;this.tryMove(t,e),this.setDrawXY(this.lastX,this.lastY),this.jumping&&(this.frame=8,this.animationSpeed=1),this.x>t?this.direction=s.Direction.RIGHT:this.x<t?this.direction=s.Direction.LEFT:this.y>e?this.direction=s.Direction.DOWN:this.y<e&&(this.direction=s.Direction.UP)}}this.rumbling=!1,this.unconscious=!0}else this.unconscious=!1,this.makeHitWarnings(),this.rumbling=!0,this.tileX=3,this.frame=0,this.frameLength=2,this.animationSpeed=.2;let t=-1!==Object.values(this.game.offlinePlayers).indexOf(this.targetPlayer);if(!this.aggro||t){let e=this.nearestPlayer();if(!1!==e){let[i,s]=e;i<=4&&(t||i<this.playerDistance(this.targetPlayer))&&s!==this.targetPlayer&&(this.targetPlayer=s,this.facePlayer(s),s===this.game.players[this.game.localPlayerID]&&(this.alertTicks=1),this.ticks%2==0&&this.makeHitWarnings())}}}}else this.tileX=12,this.lookForPlayer()}},this.jump=t=>{if(this.jumping){let t=Math.max(Math.abs(this.drawX),Math.abs(this.drawY));t>1&&(this.jumpDistance=2),this.jumpY=Math.sin(t/this.jumpDistance*Math.PI)*this.jumpHeight,this.jumpY<.01&&this.jumpY>-.01&&(this.jumpY=0,this.jumpDistance=1),this.jumpY>this.jumpHeight&&(this.jumpY=this.jumpHeight)}},this.makeHitWarnings=()=>{if(this.unconscious)return;const t=this.getPlayer(),e=this.orthogonalAttack,i=this.diagonalAttack,a=this.forwardOnlyAttack,r=this.direction,n=this.attackRange,l=this.diagonalAttackRange,c=(t,e)=>(t?[[-2,0],[2,0],[0,-2],[0,2]]:[[-1,-1],[1,1],[1,-1],[-1,1]]).flatMap(([t,i])=>Array.from({length:e},(e,s)=>[(s+1)*t,(s+1)*i])),d={[s.Direction.LEFT]:[-1,0],[s.Direction.RIGHT]:[1,0],[s.Direction.UP]:[0,-1],[s.Direction.DOWN]:[0,1]};let m=[];if(a){const[t,e]=d[r];m=Array.from({length:n},(i,s)=>[(s+1)*t,(s+1)*e])}else e&&m.push(...c(!0,n)),i&&m.push(...c(!1,l));const u=m.map(([e,i])=>({x:e,y:i,distance:h.Utils.distance(e,i,t.x-this.x,t.y-this.y)})).sort((t,e)=>t.distance-e.distance),p=Math.ceil(.75*u.length);u.slice(0,p).forEach(({x:t,y:e})=>{const i=this.x+t,s=this.y+e;if(this.isWithinRoomBounds(i,s)){const t=new o.HitWarning(this.game,i,s,this.x,this.y,!0,!1,this);this.room.hitwarnings.push(t)}})},this.draw=t=>{if(!this.dead){if(s.Game.ctx.save(),s.Game.ctx.globalAlpha=this.alpha,!this.dead){this.updateDrawXY(t),this.frame+=this.animationSpeed*t,this.frame>=this.frameLength&&(this.frame=0);let e=this.rumble(this.rumbling,this.frame).x;this.rumble(this.rumbling,this.frame).y,0!==this.drawX||0!==this.drawY?this.jumping=!0:this.jumping=!1,this.jumping?(this.frameLength=10,this.animationSpeed=.4):(this.frameLength=3,this.animationSpeed=.1),this.hasShadow&&this.drawShadow(t),s.Game.drawMob(this.tileX+(12===this.tileX||this.rumbling?0:Math.floor(this.frame)),this.tileY,1,2,this.x+e-this.drawX,this.y-this.drawYOffset-this.drawY-this.jumpY,1,2,this.softShadeColor,this.shadeAmount(),void 0,this.outlineColor(),this.outlineOpacity())}this.cloned||(this.seenPlayer||this.drawSleepingZs(t),this.alertTicks>0&&this.drawExclamation(t)),s.Game.ctx.restore()}},this.ticks=0,this.frame=0,this.health=1,this.maxHealth=1,this.defaultMaxHealth=1,this.tileX=12,this.tileY=16,this.seenPlayer=!1,this.aggro=!1,this.deathParticleColor="#ffffff",this.frameLength=3,this.startFrame=0,this.animationSpeed=.1,this.tickCount=0,this.jumping=!1,this.jumpDistance=1,this.drop=l||new r.Coin(this.room,this.x,this.y),this.name="frog",this.orthogonalAttack=!0,this.diagonalAttack=!0,this.jumpHeight=1,this.imageParticleX=3,this.imageParticleY=30,this.baseDamage=.5,l&&(this.drop=l),this.getDrop(["weapon","consumable","tool","coin","poison"])}}e.FrogEnemy=l,l.difficulty=1,l.tileX=12,l.tileY=16},7834:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.GlowBugs=void 0;const s=i(1650);class o extends s.Light{constructor(t,e,i){super(t,e,i),this.fuel=100,this.tileX=27,this.tileY=2,this.name=o.itemName,this.fuelCap=100,this.radius=6,this.stackable=!0,this.maxBrightness=2,this.maxBrightness=.25,this.color=[5,75,75]}}e.GlowBugs=o,o.itemName="glow bugs"},7851:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.gs=e.game=e.Game=e.ChatMessage=e.Direction=e.LevelState=void 0;const s=i(6291),o=i(4118),a=i(4804),r=i(7366),n=i(1285),h=i(8737),l=i(3628),c=i(3436),d=i(752),m=i(5095),u=i(6116),p=i(8900),y=i(9410),g=i(2502),f=i(645),w=i(2147),E=i(6277),x=i(8191),b=i(4371),T=i(8287),I=i(9467),S=i(5947),v=i(3574),A=i(5087),M=i(5778),C=i(6001),D=i(1284),O=i(6321),_=i(2508),R=i(2114),G=i(8561),P=i(8745);var L,k;!function(t){t[t.IN_LEVEL=0]="IN_LEVEL",t[t.TRANSITIONING=1]="TRANSITIONING",t[t.TRANSITIONING_LADDER=2]="TRANSITIONING_LADDER",t[t.LEVEL_GENERATION=3]="LEVEL_GENERATION"}(L=e.LevelState||(e.LevelState={})),function(t){t[t.DOWN=0]="DOWN",t[t.UP=1]="UP",t[t.RIGHT=2]="RIGHT",t[t.LEFT=3]="LEFT",t[t.DOWN_RIGHT=4]="DOWN_RIGHT",t[t.UP_LEFT=5]="UP_LEFT",t[t.UP_RIGHT=6]="UP_RIGHT",t[t.DOWN_LEFT=7]="DOWN_LEFT",t[t.CENTER=8]="CENTER"}(k=e.Direction||(e.Direction={}));class N{constructor(t){this.cachedLines=null,this.cachedWidth=-1,this.message=t,this.timestamp=Date.now()}getWrappedLines(t){return this.cachedLines&&this.cachedWidth===t||(this.cachedLines=this.wrapText(this.message,t),this.cachedWidth=t),this.cachedLines}wrapText(t,e){if(""===t)return[""];const i=t.split(" "),s=[];let o="";for(const t of i){const i=""===o?t:o+" "+t;F.measureText(i).width<=e?o=i:""!==o?(s.push(o),o=t):s.push(t)}return""!==o&&s.push(o),s.length>0?s:[""]}clearCache(){this.cachedLines=null,this.cachedWidth=-1}}e.ChatMessage=N;class Y{constructor(t,e){this.cachedLines=null,this.cachedWidth=-1,this.message=t,this.timestamp=Date.now(),this.holdMs=e?.holdMs??s.GameConstants.ALERT_HOLD_TIME,this.fadeMs=e?.fadeMs??s.GameConstants.ALERT_FADE_TIME,this.color=e?.color??s.GameConstants.ALERT_TEXT_COLOR,this.outlineColor=e?.outlineColor??s.GameConstants.ALERT_OUTLINE_COLOR,this.maxWidthRatio=e?.maxWidthRatio??s.GameConstants.ALERT_MAX_WIDTH_RATIO}getWrappedLines(t){if(this.cachedLines&&this.cachedWidth===t)return this.cachedLines;const e=new N(this.message);return this.cachedLines=e.getWrappedLines(t),this.cachedWidth=t,this.cachedLines}clearCache(){this.cachedLines=null,this.cachedWidth=-1}}class B{constructor(t){this.dismissStartTime=null,this.cachedLines=null,this.cachedWidth=-1,this.id=t.id,this.text=t.text,this.resolver=t.resolver,this.until=t.until,this.safety=t.safety??[],this.timeoutMs=t.timeoutMs,this.createdAt=Date.now(),this.arrowDirection=t.arrowDirection??"auto",this.textDx=t.textDx??0,this.textDy=t.textDy??0,this.color=t.color??s.GameConstants.POINTER_TEXT_COLOR,this.outlineColor=t.outlineColor??s.GameConstants.POINTER_OUTLINE_COLOR,this.maxWidthRatio=t.maxWidthRatio??s.GameConstants.POINTER_MAX_WIDTH_RATIO,this.zIndex=t.zIndex??0,this.bobPx=t.bobPx??s.GameConstants.POINTER_BOB_PX,this.bobPeriodMs=t.bobPeriodMs??s.GameConstants.POINTER_BOB_PERIOD_MS,this.tags=t.tags??[],this.dismissDurationMs=t.dismissDurationMs??s.GameConstants.POINTER_FADE_TIME}getWrappedLines(t){if(this.cachedLines&&this.cachedWidth===t)return this.cachedLines;const e=new N(this.text);return this.cachedLines=e.getWrappedLines(t),this.cachedWidth=t,this.cachedLines}clearCache(){this.cachedLines=null,this.cachedWidth=-1}}const H=[];let X=60;class F{get replayManager(){return F._replayManager||(F._replayManager=new v.ReplayManager),F._replayManager}constructor(){this.currentPathId="main",this.localPlayerID="localplayer",this.waterOverlayOffsetX=0,this.waterOverlayOffsetY=0,this.pendingWaterOffsetX=0,this.pendingWaterOffsetY=0,this.currentCameraOriginX=0,this.currentCameraOriginY=0,this.keyboardHeightPx=0,this.hasRecordedStats=!1,this.loadedFromSaveFile=!1,this.version="0.3.0",this.loginMessage="",this.startScreenAlpha=1,this.ellipsisFrame=0,this.ellipsisStartTime=0,this.justTransitioned=!1,this.lastDroppedScythePiece=null,this.lastDroppedCrossbowPiece=null,this.lastDroppedShieldPiece=null,this.tip=b.Tips.getRandomTip(),this.currentLevelGenerator=null,this.focusTimeout=null,this.FOCUS_TIMEOUT_DURATION=15e3,this.wasMuted=!1,this.wasStarted=!1,this.lastChatWidth=0,this.lastAlertWidth=0,this.lastPointerWidth=0,this.hasInitializedTutorialPointers=!1,this.hasShownOpenInventoryPointer=!1,this.savedGameState=null,this.startMenu=null,this.startMenuActive=!1,this.feedbackButton=null,this.updateDepth=t=>{this.currentDepth=t,this.players[this.localPlayerID].depth=t},this.updateLevel=t=>{t&&t.level&&(this.level=t.level),this.level.rooms.length>0&&(this.rooms=this.level.rooms,this.roomsById=new Map(this.rooms.map(t=>[t.globalId,t])))},this.getRoomById=t=>this.roomsById?.get(t),this.getLevelById=t=>this.levelsById?.get(t),this.registerLevel=t=>{this.levelsById.set(t.globalId,t)},this.registerRooms=t=>{this.rooms=t,this.roomsById=new Map(t.map(t=>[t.globalId,t]))},this.setCurrentRoomById=t=>{const e=this.roomsById.get(t);return e&&(this.room=e,this.updateLevel(e)),e},this.setPlayer=()=>{this.player=this.players[this.localPlayerID]},this.newGame=t=>{l.Input.mouseDownListeners.length=0,l.Input.mouseUpListeners.length=0,l.Input.mouseMoveListeners.length=0,l.Input.mouseLeftClickListeners.length=0,l.Input.mouseRightClickListeners.length=0,l.Input.touchStartListeners.length=0,l.Input.touchEndListeners.length=0,this.resetTutorialState(),w.statsTracker.resetStats(),this.currentDepth=0,this.encounteredEnemies=[],this.levels=[],this.hasRecordedStats=!1,this.loadedFromSaveFile=!1,this.gameStartTimeMs=Date.now(),this.currentPathId="main",this.startFreshWorld(t);try{const{loadSettings:t}=i(1856);t(this)}catch{}this.levelState=L.LEVEL_GENERATION,this.replayManager.beginRecording(e.gs.seed,this)},this.keyDownListener=t=>{if(F.inputReceived=!0,this.started)if(this.chatOpen)this.chatTextBox.handleKeyPress(t);else{switch(t.toUpperCase()){case"M":{const t=this.players[this.localPlayerID];if(t?.map)return void t.map.toggleMapOpen()}return;case"C":return void(this.chatOpen=!0);case"/":return this.chatOpen=!0,this.chatTextBox.clear(),void this.chatTextBox.handleKeyPress(t);case"1":return void(h.LevelGenerator.ANIMATION_CONSTANT=1);case"2":return void(h.LevelGenerator.ANIMATION_CONSTANT=2);case"3":return void(h.LevelGenerator.ANIMATION_CONSTANT=5);case"4":return void(h.LevelGenerator.ANIMATION_CONSTANT=1e4);case"0":return void(h.LevelGenerator.ANIMATION_CONSTANT=0)}this.players[this.localPlayerID].inputHandler.handleKeyboardKey(t)}else{if(this.startMenuActive)return;this.startedFadeOut=!0}},this.changeLevelThroughLadder=(t,e)=>{t.map.saveOldMap(),e instanceof c.DownLadder&&!e.linkedRoom&&e.generate();const i=e.linkedRoom;let s;e.entryUpLadderPos&&(s={...e.entryUpLadderPos},console.log(`changeLevelThroughLadder: captured entryPosition (${s.x}, ${s.y}) for newRoom gid=${i?.globalId}`)),this.players[this.localPlayerID]===t&&(t.levelID=i.id,t.roomGID=i.globalId,this.prevLevel=this.room,this.prevLevel.exitLevel()),this.updateDepth(i.depth),this.levelState=L.TRANSITIONING_LADDER,this.transitionStartTime=Date.now(),this.transitioningLadder=e,s?(i.__entryPositionFromLadder=s,console.log(`changeLevelThroughLadder: wrote __entryPositionFromLadder to room gid=${i?.globalId}`)):console.log(`changeLevelThroughLadder: no entryPosition available for room gid=${i?.globalId}`)},this.changeLevelThroughDoor=(t,e,i)=>{e.linkedDoor.room.entered=!0,t.roomGID=e.room.globalId;try{const i=this.rooms?.indexOf(e.room);void 0!==i&&i>=0&&(t.levelID=i)}catch{}if(this.players[this.localPlayerID]===t){this.levelState=L.TRANSITIONING,this.transitionStartTime=Date.now();const o=e.doorDir!==e.linkedDoor.doorDir;let r=this.players[this.localPlayerID].x,n=this.players[this.localPlayerID].y;this.prevLevel=this.room,this.prevLevel.exitLevel(),this.room=e.room,e.room.enterLevelThroughDoor(t,e,i),this.transitionX=(this.players[this.localPlayerID].x-r)*s.GameConstants.TILESIZE,this.transitionY=(this.players[this.localPlayerID].y-n)*s.GameConstants.TILESIZE,this.pendingWaterOffsetX=0!==this.transitionX?Math.sign(this.transitionX)*s.GameConstants.TILESIZE:0,this.pendingWaterOffsetY=0!==this.transitionY?Math.sign(this.transitionY)*s.GameConstants.TILESIZE:0,this.upwardTransition=!1,this.sideTransition=!1,this.sideTransitionDirection=i,e instanceof a.Door&&[k.RIGHT,k.LEFT].includes(e.doorDir)&&o?this.sideTransition=!0:e instanceof a.Door&&e.doorDir===k.DOWN&&o&&(this.upwardTransition=!0)}else e.room.enterLevelThroughDoor(t,e,i);t.map.saveMapData()},this.run=t=>{if(this.paused)return void window.requestAnimationFrame(this.run);if(!this.previousFrameTimestamp)return this.previousFrameTimestamp=t,void window.requestAnimationFrame(this.run);let e=60*(t-this.previousFrameTimestamp)/1e3;for(F.delta&&(e=F.delta),e<.1?e=.1:e>8&&(e=8);H.length>0&&H[0]<=t-1e3;)H.shift();H.push(t),X=H.length,Math.floor(t/(1e3/60))>Math.floor(this.previousFrameTimestamp/(1e3/60))&&this.update(),Math.floor(t)>Math.floor(this.previousFrameTimestamp)+1e3&&this.refreshDimensions(),this.draw(e*s.GameConstants.ANIMATION_SPEED*1*(this.room?.underwater?.75:1)),window.requestAnimationFrame(this.run),this.previousFrameTimestamp=t},this.update=()=>{if(this.refreshDimensions(),l.Input.checkIsTapHold(),this.replayManager.isReplaying()||0!==l.Input.lastPressTime&&Date.now()-l.Input.lastPressTime>s.GameConstants.KEY_REPEAT_TIME&&l.Input.onKeydown({repeat:!1,key:l.Input.lastPressKey}),!this.replayManager.isReplaying()&&l.Input.mouseDown&&l.Input.mouseDownHandled&&0!==l.Input.lastMouseDownTime&&Date.now()-l.Input.lastMouseDownTime>s.GameConstants.KEY_REPEAT_TIME){const t=this.players[this.localPlayerID];!t||t.game.levelState!==L.IN_LEVEL||t.dead||t.menu.open||t.busyAnimating||t.game.cameraAnimation.active||(t.moveWithMouse(),l.Input.lastMouseDownTime=Date.now())}if(l.Input.swipeHoldActive&&0!==l.Input.lastSwipeTime){const t=Date.now()-l.Input.lastSwipeTime;if(l.Input.swipeHoldRepeating){if(t>s.GameConstants.SWIPE_HOLD_REPEAT_TIME){switch(l.Input.lastSwipeDirection){case k.LEFT:l.Input.leftSwipeListener();break;case k.RIGHT:l.Input.rightSwipeListener();break;case k.UP:l.Input.upSwipeListener();break;case k.DOWN:l.Input.downSwipeListener()}l.Input.lastSwipeTime=Date.now()}}else t>s.GameConstants.SWIPE_HOLD_INITIAL_DELAY&&(l.Input.swipeHoldRepeating=!0,l.Input.lastSwipeTime=Date.now())}if(this.levelState===L.TRANSITIONING&&Date.now()-this.transitionStartTime>=n.LevelConstants.LEVEL_TRANSITION_TIME&&(this.levelState=L.IN_LEVEL,this.applyWaterOverlayGapCompensation()),this.levelState===L.TRANSITIONING_LADDER&&Date.now()-this.transitionStartTime>=n.LevelConstants.LEVEL_TRANSITION_TIME_LADDER&&(this.levelState=L.IN_LEVEL,this.players[this.localPlayerID].map.saveMapData()),this.levelState!==L.LEVEL_GENERATION)for(const t in this.players){if(this.players[t].update(),this.levelState!==L.TRANSITIONING&&this.levelState!==L.TRANSITIONING_LADDER){const e=this.players[t];(e.getRoom?e.getRoom():this.levels[e.depth].rooms[e.levelID]).update()}if(this.players[t].dead)for(const t in this.players)this.players[t].dead=!0}},this.applyWaterOverlayGapCompensation=()=>{if(this.transitionX){const t=Math.sign(this.transitionX);0!==t&&(this.waterOverlayOffsetX+=t*s.GameConstants.TILESIZE)}if(this.transitionY){const t=Math.sign(this.transitionY);0!==t&&(this.waterOverlayOffsetY+=t*s.GameConstants.TILESIZE)}this.pendingWaterOffsetX=0,this.pendingWaterOffsetY=0},this.getWaterOverlayOrigin=()=>{const t=this.getWaterTransitionProgress(),e=this.pendingWaterOffsetX*t,i=this.pendingWaterOffsetY*t;return{x:Math.round(this.currentCameraOriginX-(this.waterOverlayOffsetX??0)-e),y:Math.round(this.currentCameraOriginY-(this.waterOverlayOffsetY??0)-i)}},this.getWaterTransitionProgress=()=>{if(this.levelState===L.TRANSITIONING){const t=Date.now()-this.transitionStartTime,e=n.LevelConstants.LEVEL_TRANSITION_TIME;return Math.max(0,Math.min(1,t/e))}if(this.levelState===L.TRANSITIONING_LADDER){const t=Date.now()-this.transitionStartTime,e=n.LevelConstants.LEVEL_TRANSITION_TIME_LADDER;return Math.max(0,Math.min(1,t/e))}return 0},this.lerp=(t,e,i)=>(1-i)*t+i*e,this.pushMessage=t=>{this.chat.push(new N(t))},this.pushAlert=(t,e)=>{if(this.alerts.length>0){const i=this.alerts[0];if(i.message===t)return void(i.timestamp=Date.now());const o=new Y(i.message,{color:i.color,outlineColor:i.outlineColor,maxWidthRatio:i.maxWidthRatio,holdMs:0,fadeMs:s.GameConstants.ALERT_REPLACE_FLOAT_TIME});return o.timestamp=Date.now(),this.alertGhosts.push({alert:o,startTime:Date.now(),duration:s.GameConstants.ALERT_REPLACE_FLOAT_TIME}),void(this.alerts[0]=new Y(t,e))}this.alerts.push(new Y(t,e))},this.addPointer=t=>{const e=t.id??S.IdGenerator.generate("PTR"),i=new B({...t,id:e});return this.pointers.set(e,i),e},this.removePointer=t=>{this.pointers.delete(t)},this.removePointersByTag=t=>{for(const[e,i]of this.pointers)i.tags?.includes(t)&&this.pointers.delete(e)},this.resetTutorialState=()=>{this.tutorialFlags=new P.TutorialFlags,this.hasInitializedTutorialPointers=!1,this.hasShownOpenInventoryPointer=!1,this.pointers?this.pointers.clear():this.pointers=new Map},this.convertSeedToNumber=t=>{if(/^\d+$/.test(t))return parseInt(t);let e=0;for(let i=0;i<t.length;i++)e=(e<<5)-e+t.charCodeAt(i),e&=e;return Math.abs(e)},this.commandHandler=t=>{let e="";if((t=t.toLowerCase()).startsWith("new"))if(t.startsWith("new ")){const e=t.slice(4).trim(),i=this.convertSeedToNumber(e);this.pushMessage(`Starting new game with seed: ${e} (${i})`),this.newGame(i)}else"new"===t&&this.newGame();else switch(t){case"ladder":this.pushMessage(`Distance to nearest up ladder: ${this.room.getDistanceToNearestLadder("up")}`);break;case"encounter":this.pushMessage("Encountering enemies..."+this.encounteredEnemies.length);break;case"key":const a=this.level.getKeyRoom(this.room);if(a){this.pushMessage(`Key room: ${a.id}`),a.entered=!0,a.calculateWallInfo(),this.changeLevelThroughDoor(this.players[this.localPlayerID],a.doors[0],1);const t=a.getRandomEmptyPosition(a.getEmptyTiles());this.players[this.localPlayerID].x=t.x,this.players[this.localPlayerID].y=t.y,a.updateLighting(),this.pushMessage("Downladder located")}break;case"level":this.pushMessage(`Level: ${this.level.globalId}`);break;case"down":let r;for(const t of this.room.path())if(t.type!==o.RoomType.DOWNLADDER)for(let e=t.roomX;e<t.roomX+t.width;e++)for(let i=t.roomY;i<t.roomY+t.height;i++)if(t.roomArray[e][i]instanceof c.DownLadder){r=t.roomArray[e][i];break}r&&(r.room.entered=!0,r.room.calculateWallInfo(),this.changeLevelThroughDoor(this.players[this.localPlayerID],r.room.doors[0],1),r.lockable.removeLock(),this.players[this.localPlayerID].x=r.x,this.players[this.localPlayerID].y=r.y,r.room.updateLighting(),this.pushMessage("Downladder located"));break;case"lightup":n.LevelConstants.LIGHTING_ANGLE_STEP+=1,this.pushMessage(`Lighting angle step is now ${n.LevelConstants.LIGHTING_ANGLE_STEP}`);break;case"lightdown":n.LevelConstants.LIGHTING_ANGLE_STEP>1&&(n.LevelConstants.LIGHTING_ANGLE_STEP-=1),this.pushMessage(`Lighting angle step is now ${n.LevelConstants.LIGHTING_ANGLE_STEP}`);break;case"savec":try{const{saveToCookies:t}=i(6760);t(this),this.pushMessage("Attempted cookie save (cookies/localStorage fallback).")}catch(t){this.pushMessage("Cookie save failed.")}break;case"loadc":try{const{loadFromCookies:t}=i(6760);t(this),this.pushMessage("Attempted cookie load (cookies/localStorage fallback).")}catch(t){this.pushMessage("Cookie load failed.")}break;case"replay":this.pushMessage("Starting replay..."),this.replayManager.replay(this);break;case"replayinfo":{const t=this.replayManager.getStats?.();this.pushMessage(t?`Replay stats: actions=${t.count}, seed=${t.seed}, recording=${t.recording}, replaying=${t.replaying}`:"No replay stats available.");break}case"replayclear":this.replayManager.clearRecording?.(),this.pushMessage("Replay buffer cleared.");break;case"devmode":s.GameConstants.DEVELOPER_MODE=!s.GameConstants.DEVELOPER_MODE,console.log(`Developer mode is now ${s.GameConstants.DEVELOPER_MODE}`);break;case"dev":s.GameConstants.DEVELOPER_MODE=!s.GameConstants.DEVELOPER_MODE,console.log(`Developer mode is now ${s.GameConstants.DEVELOPER_MODE}`),this.newGame();break;case"kill":for(const t in this.players)this.players[t].dead=!0;break;case"killall":for(const t in this.players)this.players[t].game.room.entities.forEach(e=>{e.kill(this.players[t])});break;case"bomb":this.room.addBombs(1,()=>I.Random.rand());break;case"col":s.GameConstants.SET_COLOR_LAYER_COMPOSITE_OPERATION(!1);break;case"scl":s.GameConstants.SET_SCALE(),this.onResize();break;case"shd":s.GameConstants.SHADING_DISABLED=!s.GameConstants.SHADING_DISABLED,e=s.GameConstants.SHADING_DISABLED?"disabled":"enabled",this.pushMessage(`Shading is now ${e}`);break;case"shdop":s.GameConstants.SET_SHADE_LAYER_COMPOSITE_OPERATION(!1);break;case"smooth":s.GameConstants.SMOOTH_LIGHTING=!s.GameConstants.SMOOTH_LIGHTING,e=s.GameConstants.SMOOTH_LIGHTING?"enabled":"disabled",this.pushMessage(`Smooth lighting is now ${e}`);try{const{saveSettings:t}=i(1856);t(this)}catch{}break;case"rooms":s.GameConstants.drawOtherRooms=!s.GameConstants.drawOtherRooms,e=s.GameConstants.drawOtherRooms?"enabled":"disabled",this.pushMessage(`Drawing other rooms is now ${e}`);break;case"opq":s.GameConstants.ENEMIES_BLOCK_LIGHT=!s.GameConstants.ENEMIES_BLOCK_LIGHT,e=s.GameConstants.ENEMIES_BLOCK_LIGHT?"enabled":"disabled",this.pushMessage(`Enemies block light is now ${e}`);break;case"peace":T.GameplaySettings.NO_ENEMIES=!T.GameplaySettings.NO_ENEMIES,this.newGame(),e=T.GameplaySettings.NO_ENEMIES?"enabled":"disabled",this.pushMessage(`Peaceful mode is now ${e}`);break;case"equip":T.GameplaySettings.EQUIP_USES_TURN=!T.GameplaySettings.EQUIP_USES_TURN,e=T.GameplaySettings.EQUIP_USES_TURN?"enabled":"disabled",this.pushMessage(`Equipping an item takes a turn is now ${e}`);break;case"inline":s.GameConstants.SHADE_INLINE_IN_ENTITY_LAYER=!s.GameConstants.SHADE_INLINE_IN_ENTITY_LAYER,e=s.GameConstants.SHADE_INLINE_IN_ENTITY_LAYER?"enabled":"disabled",this.pushMessage(`Inline tile shading ${e}`);break;case"webgl":if(s.GameConstants.TOGGLE_USE_WEBGL_BLUR(),s.GameConstants.USE_WEBGL_BLUR)try{const{WebGLBlurRenderer:t}=i(2394);t.getInstance(),this.pushMessage("WebGL blur enabled and initialized.")}catch(t){this.pushMessage("Failed to initialize WebGL blur. Falling back to Canvas blur."),s.GameConstants.USE_WEBGL_BLUR=!1}else{try{const{WebGLBlurRenderer:t}=i(2394);t.getInstance().clearCache?.()}catch{}this.pushMessage("WebGL blur disabled.")}break;case"hq":s.GameConstants.TOGGLE_HIGH_QUALITY_BLUR();break;case"genroom":this.generateAndShowRoomLayout();break;case"cleargen":this.currentLevelGenerator=null,this.pushMessage("Cleared generated level display");break;case"post":y.PostProcessor.settings.enabled=!y.PostProcessor.settings.enabled,e=y.PostProcessor.settings.enabled?"enabled":"disabled",this.pushMessage(`Post processor is now ${e}`);break;case"save":try{this.replayManager.isReplaying()?this.pushMessage("Cannot save during replay."):(this.savedGameState=(0,m.createGameState)(this),this.pushMessage("Game state saved successfully!"),console.log("Saved game state:",this.savedGameState))}catch(t){this.pushMessage("Error saving game state: "+t.message),console.error("Save error:",t)}break;case"load":if(!this.savedGameState)return void this.pushMessage("No saved game state found. Use 'save' command first.");try{const t=Object.keys(this.players);(0,m.loadGameState)(this,t,this.savedGameState,!1),this.pushMessage("Game state loaded successfully!"),console.log("Loaded game state")}catch(t){this.pushMessage("Error loading game state: "+t.message),console.error("Load error:",t)}break;case"saveinfo":if(!this.savedGameState)return void this.pushMessage("No saved game state found.");this.pushMessage(`Saved state - Seed: ${this.savedGameState.seed}, Depth: ${this.savedGameState.level.depth}, Players: ${Object.keys(this.savedGameState.players).length}`),console.log("Saved game state details:",this.savedGameState);break;case"currentinfo":this.pushMessage(`Current state - Seed: ${this.levelgen.seed}, Depth: ${this.level.depth}, Players: ${Object.keys(this.players).length}`),console.log("Current game state details:",{seed:this.levelgen.seed,depth:this.level.depth,players:Object.keys(this.players),rooms:this.rooms.length});break;case"testsave":try{if(this.replayManager.isReplaying()){this.pushMessage("Cannot save during replay.");break}this.savedGameState=(0,m.createGameState)(this);const t=this.players[this.localPlayerID].health,e=this.players[this.localPlayerID].x,i=this.players[this.localPlayerID].y;this.players[this.localPlayerID].health=Math.max(1,this.players[this.localPlayerID].health-1),this.players[this.localPlayerID].x+=1,this.players[this.localPlayerID].y+=1,this.pushMessage(`Changes made - Health: ${t} -> ${this.players[this.localPlayerID].health}, Pos: (${e},${i}) -> (${this.players[this.localPlayerID].x},${this.players[this.localPlayerID].y})`),this.pushMessage("Use 'load' to restore the saved state")}catch(t){this.pushMessage("Error in test save: "+t.message),console.error("Test save error:",t)}break;default:if(t.startsWith("spawn "))this.room.addNewEnemy(t.slice(6));else if(t.startsWith("fill"))for(;this.room.getEmptyTiles().length>0;)this.room.addNewEnemy(t.slice(5));else if("map"===t){const{GameConstants:t}=i(6291);t.MAP_ENABLED=!t.MAP_ENABLED;const e=t.MAP_ENABLED?"enabled":"disabled";this.pushMessage(`Minimap is now ${e}`)}}},this.maxScale=()=>{let t=window.innerWidth;for(let e=s.GameConstants.MIN_SCALE;e<=s.GameConstants.MAX_SCALE;e++)if(t/e<130)return e;return s.GameConstants.MAX_SCALE},this.increaseScale=()=>{s.GameConstants.INCREASE_SCALE(),this.onResize(),l.Input.recalculateMousePosition()},this.decreaseScale=()=>{s.GameConstants.DECREASE_SCALE(),this.onResize(),l.Input.recalculateMousePosition()},this.updateScale=t=>{s.GameConstants.smoothScaling?(s.GameConstants.SOFT_SCALE<s.GameConstants.SCALE&&Math.abs(s.GameConstants.SOFT_SCALE-s.GameConstants.SCALE)>=.1&&(s.GameConstants.SOFT_SCALE+=(s.GameConstants.SCALE-s.GameConstants.SOFT_SCALE)*t/10),s.GameConstants.SOFT_SCALE>s.GameConstants.SCALE&&Math.abs(s.GameConstants.SOFT_SCALE-s.GameConstants.SCALE)>=.1&&(s.GameConstants.SOFT_SCALE-=(s.GameConstants.SOFT_SCALE-s.GameConstants.SCALE)*t/10),s.GameConstants.SOFT_SCALE<s.GameConstants.SCALE&&Math.abs(s.GameConstants.SOFT_SCALE-s.GameConstants.SCALE)<=.1&&(s.GameConstants.SOFT_SCALE+=t/25),s.GameConstants.SOFT_SCALE>s.GameConstants.SCALE&&Math.abs(s.GameConstants.SOFT_SCALE-s.GameConstants.SCALE)<=.1&&(s.GameConstants.SOFT_SCALE-=t/25),Math.abs(s.GameConstants.SOFT_SCALE-s.GameConstants.SCALE)<=.01&&(s.GameConstants.SOFT_SCALE=s.GameConstants.SCALE)):s.GameConstants.SOFT_SCALE=s.GameConstants.SCALE,this.onResize(),l.Input.recalculateMousePosition()},this.refreshDimensions=()=>{F.ctx.canvas.setAttribute("width",`${s.GameConstants.WIDTH}`),F.ctx.canvas.setAttribute("height",`${s.GameConstants.HEIGHT}`)},this.onResize=()=>{void 0!==this.localPlayerID&&this.players?.[this.localPlayerID]&&this.players?.[this.localPlayerID]?.menu&&this.players[this.localPlayerID].menu.positionButtons(),this.isMobile=/iPhone|iPad|iPod|Android|webOS|BlackBerry|IEMobile|Opera Mini|Mobile|mobile|CriOS/i.test(navigator.userAgent),s.GameConstants.isIOS=/iPhone|iPad|iPod/i.test(navigator.userAgent)&&!navigator.userAgent.includes("Chrome DevTools"),/Safari/.test(navigator.userAgent)&&!/Chrome/.test(navigator.userAgent)&&(s.GameConstants.USE_WEBGL_BLUR=!0,null===s.GameConstants.SCALE&&(s.GameConstants.SMOOTH_LIGHTING=!1)),null===s.GameConstants.SCALE&&(s.GameConstants.SCALE=s.GameConstants.FIND_SCALE(this.isMobile),s.GameConstants.SOFT_SCALE=s.GameConstants.SCALE);let t=Math.floor(window.innerWidth/s.GameConstants.DEFAULTWIDTH),e=Math.floor(window.innerHeight/s.GameConstants.DEFAULTHEIGHT);if(this.isMobile){this.isMobile&&console.log("Mobile detected"),s.GameConstants.SHADE_LEVELS=35,s.GameConstants.isMobile=!0,n.LevelConstants.LIGHTING_ANGLE_STEP=8,n.LevelConstants.LIGHTING_MAX_DISTANCE=7,s.GameConstants.USE_WEBGL_BLUR=!0;const i=s.GameConstants.SOFT_SCALE+0;F.scale=Math.min(t,e,i)}else{s.GameConstants.isMobile=!1;const i=s.GameConstants.SOFT_SCALE+0;F.scale=Math.min(t,e,i)}0===F.scale&&(t=window.innerWidth/s.GameConstants.DEFAULTWIDTH,e=window.innerHeight/s.GameConstants.DEFAULTHEIGHT,F.scale=Math.max(1,Math.min(t,e,1))),F.scale*=1/window.devicePixelRatio,n.LevelConstants.SCREEN_W=Math.floor(window.innerWidth/F.scale/s.GameConstants.TILESIZE),n.LevelConstants.SCREEN_H=Math.floor(window.innerHeight/F.scale/s.GameConstants.TILESIZE),s.GameConstants.WIDTH=Math.floor(window.innerWidth/F.scale),s.GameConstants.HEIGHT=Math.floor(window.innerHeight/F.scale),F.ctx.canvas.setAttribute("width",`${s.GameConstants.WIDTH}`),F.ctx.canvas.setAttribute("height",`${s.GameConstants.HEIGHT}`),F.ctx.canvas.setAttribute("style",`width: ${s.GameConstants.WIDTH*F.scale}px; height: ${s.GameConstants.HEIGHT*F.scale}px;\n      display: block;\n      margin: 0 auto;\n      image-rendering: optimizeSpeed; /* Older versions of FF */\n      image-rendering: -moz-crisp-edges; /* FF 6.0+ */\n      image-rendering: -webkit-optimize-contrast; /* Safari */\n      image-rendering: -o-crisp-edges; /* OS X & Windows Opera (12.02+) */\n      image-rendering: pixelated; /* Future-browsers */\n      -ms-interpolation-mode: nearest-neighbor; /* IE */\n      `);const i=s.GameConstants.WIDTH-20;i!==this.lastChatWidth&&(this.chat.forEach(t=>t.clearCache()),this.lastChatWidth=i);const o=Math.floor(s.GameConstants.WIDTH*s.GameConstants.ALERT_MAX_WIDTH_RATIO);o!==this.lastAlertWidth&&(this.alerts?.forEach(t=>t.clearCache()),this.alertGhosts?.forEach(t=>t.alert.clearCache()),this.lastAlertWidth=o);const a=Math.floor(s.GameConstants.WIDTH*s.GameConstants.POINTER_MAX_WIDTH_RATIO);a!==this.lastPointerWidth&&(this.pointers?.forEach(t=>t.clearCache()),this.lastPointerWidth=a)},this.shakeScreen=(t,e,i=!1)=>{if(s.GameConstants.SCREEN_SHAKE_ENABLED){let s=i?Math.max(-3,Math.min(3,t)):t,o=i?Math.max(-3,Math.min(3,e)):e;this.screenShakeActive=!0,this.screenShakeX+=s,this.screenShakeY+=o,this.shakeAmountX+=Math.abs(s),this.shakeAmountY+=Math.abs(o),(s<0||o<0)&&(this.shakeFrame=3*Math.PI/2),(s>0||o>0)&&(this.shakeFrame=Math.PI/2),this.screenShakeCutoff=Date.now()}},this.drawRooms=(t,e=!1)=>{if(s.GameConstants.drawOtherRooms){if(s.GameConstants.drawOtherRooms){const i=this.rooms.filter(t=>t.pathId===this.currentPathId).slice().sort((t,e)=>t.roomY+t.height-(e.roomY+e.height));for(const s of i)(s===this.room||s.active||s.entered&&s.onScreen)&&(s.draw(t),s.drawEntities(t,e))}}else{if(!this.room||this.room.pathId!==this.currentPathId)return;this.room.draw(t),this.room.drawEntities(t,!0)}},this.drawRoomShadeAndColor=t=>{for(const e of this.rooms)e.pathId===this.currentPathId&&(e===this.room||e.active||e.entered)&&(s.GameConstants.SMOOTH_LIGHTING&&!s.GameConstants.SHADE_INLINE_IN_ENTITY_LAYER&&e.drawShadeLayer(),e.drawColorLayer(),e.drawBloomLayer(t));for(const e of this.rooms)e.pathId===this.currentPathId&&(e===this.room||e.active&&e.entered)&&e.drawOverShade(t);for(const e of this.rooms)e.pathId===this.currentPathId&&(e===this.room||e.active||e.entered&&e.onScreen)&&e.drawTopBeams(t)},this.drawStartScreen=t=>{let e="Welcome to Turnarchist";if(F.ctx.globalAlpha=this.startScreenAlpha,this.started||this.startedFadeOut?!this.started&&this.startedFadeOut&&(this.startScreenAlpha-=.025*t,this.startScreenAlpha<=0&&(this.startScreenAlpha=0,this.started=!0,r.Sound.playAmbient())):(this.startScreenAlpha=1,this.startScreenAlpha<=0&&(this.startScreenAlpha=0)),F.ctx.fillStyle="black",F.ctx.fillRect(0,0,s.GameConstants.WIDTH,s.GameConstants.HEIGHT),F.ctx.fillStyle=n.LevelConstants.LEVEL_TEXT_COLOR,this.startMenuActive||this.startedFadeOut)this.startMenu?.draw();else{F.fillText(e,s.GameConstants.WIDTH/2-F.measureText(e).width/2,s.GameConstants.HEIGHT/2-F.letter_height+2);let t="Press space or click to start";this.isMobile&&(t="Tap to start"),F.fillText(t,s.GameConstants.WIDTH/2-F.measureText(t).width/2,s.GameConstants.HEIGHT/2+F.letter_height+5)}F.ctx.globalAlpha=1},this.drawTipScreen=t=>{let e=this.tip;F.ctx.fillStyle="black",F.ctx.fillRect(0,0,s.GameConstants.WIDTH,s.GameConstants.HEIGHT),F.ctx.fillStyle=n.LevelConstants.LEVEL_TEXT_COLOR,F.fillText(e,s.GameConstants.WIDTH/2-F.measureText(e).width/2,s.GameConstants.HEIGHT/2-F.letter_height+2)},this.draw=t=>{if(s.GameConstants.SOFT_SCALE!==s.GameConstants.SCALE&&(this.updateScale(t),this.onResize()),F.ctx.clearRect(0,0,s.GameConstants.WIDTH,s.GameConstants.HEIGHT),F.ctx.save(),F.ctx.setTransform(1,0,0,1,0,0),F.ctx.globalAlpha=1,F.ctx.globalCompositeOperation="source-over",F.ctx.fillStyle="black",F.ctx.fillRect(0,0,s.GameConstants.WIDTH,s.GameConstants.HEIGHT),this.levelState===L.TRANSITIONING){this.screenShakeX=0,this.screenShakeY=0,this.screenShakeActive=!1;let e=Math.floor(this.lerp((Date.now()-this.transitionStartTime)/n.LevelConstants.LEVEL_TRANSITION_TIME,0,-this.transitionX)),i=Math.floor(this.lerp((Date.now()-this.transitionStartTime)/n.LevelConstants.LEVEL_TRANSITION_TIME,0,-this.transitionY)),o=e-this.transitionX,a=i-this.transitionY,r=(this.players[this.localPlayerID].x-this.players[this.localPlayerID].drawX+.5)*s.GameConstants.TILESIZE,h=(this.players[this.localPlayerID].y-this.players[this.localPlayerID].drawY+.5)*s.GameConstants.TILESIZE;const l=Math.round(r+o-.5*s.GameConstants.WIDTH),c=Math.round(h+a-.5*s.GameConstants.HEIGHT);this.currentCameraOriginX=l,this.currentCameraOriginY=c,F.ctx.translate(-l,-c);let d=Math.floor(this.lerp((Date.now()-this.transitionStartTime)/n.LevelConstants.LEVEL_TRANSITION_TIME,0,s.GameConstants.TILESIZE)),m=o,u=a;this.sideTransition?this.sideTransitionDirection>0?(e+=d,m+=d+s.GameConstants.TILESIZE):(e-=d,m-=d+s.GameConstants.TILESIZE):this.upwardTransition?(i-=d,u-=d+s.GameConstants.TILESIZE):(i+=d,u+=d+s.GameConstants.TILESIZE),Math.floor(7*(Date.now()-this.transitionStartTime)/n.LevelConstants.LEVEL_TRANSITION_TIME),F.ctx.translate(e,i),s.GameConstants.drawOtherRooms||(this.prevLevel.draw(t),this.prevLevel.drawEntities(t),this.prevLevel.drawColorLayer(),this.prevLevel.drawShade(t),this.prevLevel.drawOverShade(t)),F.ctx.translate(-e,-i),F.ctx.translate(m,u),s.GameConstants.drawOtherRooms&&(this.drawRooms(t,!0),F.ctx.translate(-m,-u),F.ctx.translate(o,a),this.players[this.localPlayerID].draw(t),F.ctx.translate(-o,-a),F.ctx.translate(m,u),this.drawRoomShadeAndColor(t));for(let t=this.room.roomX-1;t<=this.room.roomX+this.room.width;t++)for(let t=this.room.roomY-1;t<=this.room.roomY+this.room.height;t++);F.ctx.translate(-m,-u),F.ctx.translate(l,c),this.players[this.localPlayerID].drawGUI(t),this.justTransitioned=!0}else if(this.levelState===L.TRANSITIONING_LADDER){let e=(this.players[this.localPlayerID].x-this.players[this.localPlayerID].drawX+.5)*s.GameConstants.TILESIZE,i=(this.players[this.localPlayerID].y-this.players[this.localPlayerID].drawY+.5)*s.GameConstants.TILESIZE;const o=Math.round(e-.5*s.GameConstants.WIDTH),a=Math.round(i-.5*s.GameConstants.HEIGHT);this.currentCameraOriginX=o,this.currentCameraOriginY=a,F.ctx.translate(-o,-a);let r=6,h=Math.floor((14+r)*(Date.now()-this.transitionStartTime)/n.LevelConstants.LEVEL_TRANSITION_TIME_LADDER);if(F.ctx.translate(o,a),h<7){if(this.drawRooms(t),this.drawRoomShadeAndColor(t),!s.GameConstants.drawOtherRooms)for(let t=this.room.roomX-1;t<=this.room.roomX+this.room.width;t++)for(let e=this.room.roomY-1;e<=this.room.roomY+this.room.height;e++)F.drawFX(7-h,10,1,1,t,e,1,1)}else if(h>=7+r&&(this.transitioningLadder&&(this.room=this.transitioningLadder.linkedRoom,this.room.enterLevel(this.players[this.localPlayerID]),this.transitioningLadder=null),this.drawRooms(t),this.drawRoomShadeAndColor(t),!s.GameConstants.drawOtherRooms))for(let t=this.room.roomX-1;t<=this.room.roomX+this.room.width;t++)for(let e=this.room.roomY-1;e<=this.room.roomY+this.room.height;e++)F.drawFX(h-(7+r),10,1,1,t,e,1,1);this.drawTextScreen("loading level")}else if(this.levelState===L.LEVEL_GENERATION)this.levelgen.draw(t);else if(this.levelState===L.IN_LEVEL){this.drawScreenShake(t);const{cameraX:e,cameraY:i}=this.applyCamera(t);F.ctx.translate(-e,-i),this.drawRooms(t),this.drawRoomShadeAndColor(t),F.ctx.translate(e,i),this.room.drawTopLayer(t),this.players[this.localPlayerID].drawGUI(t)}if(this.levelState===L.IN_LEVEL&&!this.startMenuActive&&!this.tutorialFlags.initPointers){try{this.setupInitialPointers()}catch{}this.tutorialFlags.initPointers=!0}this.drawPointers(t),this.drawChat(t),this.drawAlerts(t),s.GameConstants.ALPHA_ENABLED&&(F.ctx.globalAlpha=.1),F.ctx.fillStyle=n.LevelConstants.LEVEL_TEXT_COLOR,F.fillText(s.GameConstants.VERSION,s.GameConstants.WIDTH-F.measureText(s.GameConstants.VERSION).width-1,1),F.ctx.globalAlpha=1,s.GameConstants.ALPHA_ENABLED&&(F.ctx.globalAlpha=.1),F.ctx.fillStyle=n.LevelConstants.LEVEL_TEXT_COLOR,F.fillText(X+"fps",1,1),F.ctx.globalAlpha=1,this.started||this.levelState===L.LEVEL_GENERATION||this.drawStartScreen(10*t),this.currentLevelGenerator&&this.currentLevelGenerator.draw(10,10,3),p.MouseCursor.getInstance().draw(t,this.isMobile),F.ctx.restore()},this.drawPointers=t=>{if(!this.pointers||0===this.pointers.size)return;if(this.levelState!==L.IN_LEVEL)return;const e=Array.from(this.pointers.values()).sort((t,e)=>t.zIndex-e.zIndex),i=[],o=Date.now(),a=[];for(const t of e){(!0===t.until?.()||!0===t.safety?.some(t=>t())||t.timeoutMs&&o-t.createdAt>t.timeoutMs)&&null===t.dismissStartTime&&(t.dismissStartTime=o);const e=t.resolver?.();if(!e)continue;let r=t.arrowDirection;"auto"===r&&(r="down");const n=F.letter_height+1,h=Math.max(1,Math.floor(s.GameConstants.WIDTH*(t.maxWidthRatio||s.GameConstants.POINTER_MAX_WIDTH_RATIO))),l=t.getWrappedLines(h),c=l.length*n,d=4;let m=0;for(let t=0;t<l.length;t++){const e=F.measureText(l[t]).width;e>m&&(m=e)}let u=0,p=0;"down"===r?(u=Math.floor(e.x+e.w/2),p=Math.floor(e.y-d-c)):"up"===r?(u=Math.floor(e.x+e.w/2),p=Math.floor(e.y+e.h+d)):"left"===r?(u=Math.floor(e.x+e.w+d),p=Math.floor(e.y-Math.floor(c/2))):(u=Math.floor(e.x-d),p=Math.floor(e.y-Math.floor(c/2)));const y=Math.sin(o%t.bobPeriodMs/t.bobPeriodMs*Math.PI*2),g=Math.round(y*t.bobPx);u+=t.textDx,p+=t.textDy+("down"===r?-g:g);const f=n,w=25,E=(t,e)=>!(t.x+t.w<=e.x||e.x+e.w<=t.x||t.y+t.h<=e.y||e.y+e.h<=t.y);let x=0;for(;x<w;){const t={x:Math.floor(u-m/2),y:p,w:m,h:c};if(!i.some(e=>E(t,e)))break;"down"===r?p-=f:p+=f,x++}const b=d+Math.floor(m/2),T=s.GameConstants.WIDTH-d-Math.floor(m/2);u<b&&(u=b),u>T&&(u=T);const I=d,S=s.GameConstants.HEIGHT-d-c;p<I&&(p=I),p>S&&(p=S),i.push({x:Math.floor(u-m/2),y:p,w:m,h:c});let v=1;if(null!==t.dismissStartTime){const e=o-t.dismissStartTime;v=1-Math.max(0,Math.min(1,e/t.dismissDurationMs)),e>=t.dismissDurationMs&&a.push(t.id)}let A=p;F.ctx.globalAlpha=v;for(let e=0;e<l.length;e++){const i=l[e],s=F.measureText(i).width,o=Math.floor(u-s/2);F.fillTextOutline(i,o,A,t.outlineColor,t.color),A+=n}const M=(t,e,i)=>{F.ctx.fillStyle=s.GameConstants.POINTER_ARROW_COLOR;const o=Math.max(2,s.GameConstants.POINTER_ARROW_SIZE);if("down"===i)for(let i=0;i<o;i++){const s=1+2*i;F.ctx.fillRect(t-(s-1)/2,e-i,s,1)}else if("up"===i)for(let i=0;i<o;i++){const s=1+2*i;F.ctx.fillRect(t-(s-1)/2,e+i,s,1)}else if("left"===i)for(let i=0;i<o;i++){const s=1+2*i;F.ctx.fillRect(t+i,e-(s-1)/2,1,s)}else for(let i=0;i<o;i++){const s=1+2*i;F.ctx.fillRect(t-i,e-(s-1)/2,1,s)}};F.ctx.globalAlpha=v,"down"===r?M(Math.floor(e.x+e.w/2),Math.max(d,e.y-1),"down"):"up"===r?M(Math.floor(e.x+e.w/2),Math.min(s.GameConstants.HEIGHT-d,e.y+e.h+1),"up"):"left"===r?M(Math.min(s.GameConstants.WIDTH-d,e.x+e.w+1),Math.floor(e.y+e.h/2),"left"):M(Math.max(d,e.x-1),Math.floor(e.y+e.h/2),"right"),F.ctx.globalAlpha=1}for(const t of a)this.pointers.delete(t)},this.setupInitialPointers=()=>{if(!0===s.GameConstants.DEVELOPER_MODE)return;const t=this.players?.[this.localPlayerID];if(!t)return;const e=t.inventory;if(!e)return;const i="equip-candle";if(this.pointers.has(i))return;const o=[()=>this.levelState!==L.IN_LEVEL,()=>t.dead];this.addPointer({id:i,text:"Equip Candle",resolver:()=>e.getQuickbarSlotRect(1),until:()=>{const t=t=>"string"==typeof t?.name&&"candle"===t.name.toLowerCase();try{const i=Array.isArray(e.items)?e.items:[];return!!i.some(e=>t(e)&&Boolean(e?.equipped))||!i.some(e=>!!t(e)&&("number"==typeof e?.stackCount?e.stackCount:1)>0)}catch{return!0}},safety:o,arrowDirection:"down",textDy:-2,timeoutMs:6e4,tags:["tutorial"],zIndex:10});const a="equip-wooden-shield";if(!this.pointers.has(a)){let t=!1;try{for(const i of e.items)if("wooden shield"===i?.name){t=!0;break}}catch{}if(t){const t=()=>e.getQuickbarSlotRect(2),i=()=>{try{for(const t of e.items)if(t?.equipped&&"wooden shield"===t?.name)return!0}catch{}return!1};this.addPointer({id:a,text:"Equip Shield",resolver:t,until:i,safety:o,arrowDirection:"down",textDy:-2,timeoutMs:6e4,tags:["tutorial"],zIndex:10})}}},this.maybeShowOpenInventoryPointer=()=>{if(this.tutorialFlags.openInventoryShown)return;if(this.levelState!==L.IN_LEVEL)return;const t=this.players?.[this.localPlayerID],e=t?.inventory;if(!e||"function"!=typeof e.getInventoryButtonRect)return;const i=[()=>this.levelState!==L.IN_LEVEL,()=>t.dead];this.addPointer({id:"open-inventory",text:this.isMobile?"Tap to open inventory":"Click to open inventory",resolver:()=>e.getInventoryButtonRect(),until:()=>!0===e.isOpen,safety:i,arrowDirection:"down",textDy:-2,timeoutMs:45e3,tags:["tutorial"],zIndex:10}),this.tutorialFlags.openInventoryShown=!0},this.drawAlerts=t=>{if(this.alertGhosts&&this.alertGhosts.length>0){const t=Date.now();this.alertGhosts=this.alertGhosts.filter(e=>t-e.startTime<=e.duration);for(const e of this.alertGhosts){const i=t-e.startTime,o=Math.min(1,Math.max(0,i/e.duration)),a=1-o;if(a<=0)continue;const r=Math.max(1,Math.floor(s.GameConstants.WIDTH*(e.alert.maxWidthRatio||s.GameConstants.ALERT_MAX_WIDTH_RATIO))),n=e.alert.getWrappedLines(r),h=F.letter_height+1,l=n.length*h;let c=Math.floor(s.GameConstants.HEIGHT/2-l/2)+-Math.floor(o*s.GameConstants.ALERT_REPLACE_FLOAT_PX);F.ctx.globalAlpha=a;for(let t=0;t<n.length;t++){const i=n[t],o=F.measureText(i).width,a=Math.floor(s.GameConstants.WIDTH/2-o/2);F.fillTextOutline(i,a,c,e.alert.outlineColor,e.alert.color),c+=h}F.ctx.globalAlpha=1}}if(!this.alerts||0===this.alerts.length)return;const e=this.alerts[0],i=Math.max(1,Math.floor(s.GameConstants.WIDTH*(e.maxWidthRatio||s.GameConstants.ALERT_MAX_WIDTH_RATIO))),o=e.getWrappedLines(i),a=F.letter_height+1,r=Date.now()-e.timestamp;let n=1;if(r<=e.holdMs)n=1;else{if(!(r<=e.holdMs+e.fadeMs))return this.alerts.shift(),this.drawAlerts(t);n=1-(r-e.holdMs)/e.fadeMs}if(n<=0)return;const h=o.length*a;let l=Math.floor(s.GameConstants.HEIGHT/2-h/2);F.ctx.globalAlpha=n;for(let t=0;t<o.length;t++){const i=o[t],r=F.measureText(i).width,n=Math.floor(s.GameConstants.WIDTH/2-r/2);F.fillTextOutline(i,n,l,e.outlineColor,e.color),l+=a}F.ctx.globalAlpha=1},this.drawChat=t=>{const e=s.GameConstants.MOBILE_KEYBOARD_SUPPORT?Math.ceil(this.keyboardHeightPx/F.scale):0,i=s.GameConstants.HEIGHT-F.letter_height-38-e,o=this.players?.[this.localPlayerID]?.inventory.isOpen?.05:1,a=s.GameConstants.WIDTH-5,r=F.letter_height+1;let n=4;if(this.chatOpen){F.ctx.fillStyle="black",s.GameConstants.ALPHA_ENABLED&&(F.ctx.globalAlpha=.75),F.ctx.fillRect(0,0,s.GameConstants.WIDTH,s.GameConstants.HEIGHT),F.ctx.globalAlpha=1,F.ctx.fillStyle="white",F.fillText(this.chatTextBox.text,5,i);const t=F.measureText(this.chatTextBox.text.substring(0,this.chatTextBox.cursor)).width;F.ctx.fillRect(5+t,i,1,F.letter_height)}let h=0;const l=[];for(let t=0;t<this.chat.length;t++){const e=this.chat[t].getWrappedLines(a).length*r;l.push(e),h+=e}let c=i;this.chatOpen&&(c-=r);for(let t=this.chat.length-1;t>=0;t--){const e=this.chat[t],i=e.getWrappedLines(a),h=l[t],d=Date.now()-e.timestamp;let m=1;this.chatOpen||(m=d<=s.GameConstants.CHAT_APPEAR_TIME?s.GameConstants.ALPHA_ENABLED?o:1:d<=s.GameConstants.CHAT_APPEAR_TIME+s.GameConstants.CHAT_FADE_TIME?s.GameConstants.ALPHA_ENABLED?o*(1-(d-s.GameConstants.CHAT_APPEAR_TIME)/s.GameConstants.CHAT_FADE_TIME):1:0);let u=0;if(m>0){F.ctx.fillStyle="white",F.ctx.globalAlpha=m;let t=c;if(this.chatOpen){for(let e=i.length-1;e>=0;e--)F.fillText(i[e],5,t),t-=r;u=i.length}else{const e=Math.max(0,n),s=Math.min(i.length,e),o=i.length-s;for(let e=i.length-1;e>=o;e--)F.fillText(i[e],5,t),t-=r;u=s,n-=s}}if(this.chatOpen?c-=h:c-=u*r,!this.chatOpen&&n<=0)break}F.ctx.globalAlpha=1},this.targetCamera=(t,e)=>{let i=Math.round((t+.5)*s.GameConstants.TILESIZE-.5*s.GameConstants.WIDTH),o=Math.round((e+.5)*s.GameConstants.TILESIZE-.5*s.GameConstants.HEIGHT);this.cameraTargetX=i,this.cameraTargetY=o},this.updateCamera=t=>{const e=this.cameraTargetX-this.cameraX,i=this.cameraTargetY-this.cameraY;let o=s.GameConstants.CAMERA_SPEED;this.justTransitioned&&(o=1,this.justTransitioned=!1),this.cameraAnimation.active?o=this.cameraAnimation.fast?.5:.075:(Math.abs(e)>250||Math.abs(i)>250)&&(o=1),(Math.abs(e)>1||Math.abs(i)>1)&&1!==o?(this.cameraX+=e*o*t,this.cameraY+=i*o*t):(this.cameraX=this.cameraTargetX,this.cameraY=this.cameraTargetY)},this.applyCamera=t=>{let e=this.players[this.localPlayerID];this.targetCamera(e.x-e.drawX,e.y-e.drawY),this.updateCameraAnimation(t),this.updateCamera(t);const i=Math.round(this.cameraX-this.screenShakeX),s=Math.round(this.cameraY-this.screenShakeY);return this.currentCameraOriginX=i,this.currentCameraOriginY=s,{cameraX:i,cameraY:s}},this.drawScreenShake=t=>{this.screenShakeActive?(this.shakeAmountX*=.8**t,this.shakeAmountY*=.8**t,this.screenShakeX=Math.sin(this.shakeFrame*Math.PI)*this.shakeAmountX,this.screenShakeY=Math.sin(this.shakeFrame*Math.PI)*this.shakeAmountY,this.shakeFrame+=.15*t,Math.abs(this.shakeAmountX)<.5&&Math.abs(this.shakeAmountY)<.5&&this.resetScreenShake()):this.resetScreenShake()},this.resetScreenShake=()=>{this.shakeAmountX=0,this.shakeAmountY=0,this.shakeFrame=0,this.screenShakeX=0,this.screenShakeY=0,this.screenShakeActive=!1},this.updateCameraAnimation=t=>{if(!this.cameraAnimation.active)return;const e=this.cameraAnimation.fast?10:1;this.cameraAnimation.frame/this.cameraAnimation.duration*e<.6&&this.targetCamera(this.cameraAnimation.x,this.cameraAnimation.y),this.cameraAnimation.frame+=t*(this.cameraAnimation.fast?10:1),this.cameraAnimation.frame>this.cameraAnimation.duration&&(this.cameraAnimation.active=!1)},this.skipCameraAnimation=()=>{this.cameraAnimation.active&&(this.cameraAnimation.active=!1,this.cameraX=this.cameraTargetX,this.cameraY=this.cameraTargetY)},this.startCameraAnimation=(t,e,i)=>{this.cameraAnimation.active=!0,this.cameraAnimation.x=t,this.cameraAnimation.y=e,this.cameraAnimation.duration=i,this.cameraAnimation.frame=0,this.cameraAnimation.fast=!1;const s=this.isMobile?"Tap to skip camera animation":"Press space or click to skip camera animation";this.pushMessage(s)},this.drawTextScreen=(t,e=!0)=>{e&&(F.ctx.fillStyle="rgb(0, 0, 0)",F.ctx.fillRect(0,0,s.GameConstants.WIDTH,s.GameConstants.HEIGHT));const i=this.animateEllipsis(),o=F.measureText(t+i);F.ctx.fillStyle="rgb(255, 255, 255)",F.fillText(t+i,s.GameConstants.WIDTH/2-o.width/2,s.GameConstants.HEIGHT/2-o.height/2)},this.animateEllipsis=()=>(Date.now()-this.ellipsisStartTime>150&&(this.ellipsisStartTime=Date.now(),this.ellipsisFrame=(this.ellipsisFrame+1)%4),".".repeat(this.ellipsisFrame)),this.handleWindowBlur=()=>{this.focusTimeout=window.setTimeout(()=>{this.wasMuted=r.Sound.audioMuted,this.wasStarted=this.started,r.Sound.audioMuted=!0,this.paused=!0,this.pushMessage("Game paused - window inactive")},this.FOCUS_TIMEOUT_DURATION)},this.handleWindowFocus=()=>{this.focusTimeout&&(clearTimeout(this.focusTimeout),this.focusTimeout=null),this.paused&&(r.Sound.audioMuted=this.wasMuted,this.started=this.wasStarted,this.paused=!1,this.pushMessage("Game resumed"))},this.oneTime=new G.OneTimeEventTracker,this.tutorialFlags=new P.TutorialFlags,this.globalId=S.IdGenerator.generate("G"),this.roomsById=new Map,this.levelsById=new Map,window.addEventListener("load",()=>{let t=document.getElementById("gameCanvas");F.ctx=t.getContext("2d",{alpha:!1});const e=document.createElement("input");e.type="text",e.autocomplete="off",e.autocapitalize="off",e.style.position="absolute",e.style.left="-1000px";const o=document.createElement("input");o.type="text",o.autocomplete="off",o.autocapitalize="off",o.autocorrect="off",o.spellcheck=!1,o.inputMode="text",o.style.position="absolute",o.style.left="-1000px",document.body.appendChild(o),document.addEventListener("click",()=>{e.focus()},{once:!0}),this.chat=[],this.chatTextBox=new d.TextBox(o),this.alerts=[],this.alertGhosts=[],this.pointers=new Map,this.chatTextBox.setEnterCallback(()=>{this.chatTextBox.text.length>0?(this.chat.push(new N(this.chatTextBox.text)),this.chatTextBox.clear()):this.chatOpen=!1}),this.chatTextBox.setEscapeCallback(()=>{this.chatOpen=!1}),this.worldCodes=[],this.selectedWorldCode=0,F.shade_canvases={},F.text_rendering_canvases={};let a=0;F.tileset=new Image,F.tileset.onload=()=>{a++},F.tileset.src=A,F.objset=new Image,F.objset.onload=()=>{a++},F.objset.src=M,F.mobset=new Image,F.mobset.onload=()=>{a++},F.mobset.src=C,F.itemset=new Image,F.itemset.onload=()=>{a++},F.itemset.src=D,F.fxset=new Image,F.fxset.onload=()=>{a++},F.fxset.src=O,F.fontsheet=new Image,F.fontsheet.onload=()=>{a++},F.fontsheet.src=_,this.levelState=L.LEVEL_GENERATION,this.cameraX=0,this.cameraY=0,this.cameraTargetX=0,this.cameraTargetY=0;let r=()=>{if(a<6)window.setTimeout(r,500);else{if(F.scale=s.GameConstants.SCALE,document.addEventListener("touchstart",function(e){e.target==t&&e.preventDefault()},!1),document.addEventListener("touchend",function(e){e.target==t&&e.preventDefault()},!1),document.addEventListener("touchmove",function(e){e.target==t&&e.preventDefault()},!1),document.addEventListener("touchstart",l.Input.handleTouchStart,{passive:!1}),document.addEventListener("touchmove",l.Input.handleTouchMove,{passive:!1}),document.addEventListener("touchend",l.Input.handleTouchEnd,{passive:!1}),l.Input.keyDownListener=t=>{this.keyDownListener(t)},window.requestAnimationFrame(this.run),this.onResize(),window.addEventListener("resize",this.onResize),window.addEventListener("orientationchange",()=>{setTimeout(this.onResize,100)}),s.GameConstants.MOBILE_KEYBOARD_SUPPORT)try{const t=window.visualViewport;if(t&&"function"==typeof t.addEventListener){const e=()=>{const e=window.innerHeight,i=t.height,s=Math.max(0,e-i-(t.offsetTop||0));this.keyboardHeightPx=s};t.addEventListener("resize",e),t.addEventListener("scroll",e)}else{let t=window.innerHeight;window.addEventListener("resize",()=>{const e=window.innerHeight;this.keyboardHeightPx=Math.max(0,t-e),e>t&&(t=e)})}}catch{}else this.keyboardHeightPx=0;this.players={},this.offlinePlayers={},this.chatOpen=!1,this.cameraAnimation=new x.CameraAnimation(0,0,1e3,1,0,!1),this.feedbackButton=new R.FeedbackButton,s.GameConstants.MOBILE_KEYBOARD_SUPPORT&&l.Input.mouseDownListeners.push((t,e)=>{if(!this.isMobile)return;const i=this.players?.[this.localPlayerID];i&&i.dead||this.chatOpen||this.isPointInChatHotspot(t,e)&&(this.chatOpen=!0,this.chatTextBox.focus(),l.Input.mouseDownHandled=!0)}),this.screenShakeX=0,this.screenShakeY=0,this.shakeAmountX=0,this.shakeAmountY=0,this.shakeFrame=3*Math.PI/2,this.screenShakeCutoff=0,this.tutorialActive=!1,this.screenShakeActive=!1,this.levels=[],this.encounteredEnemies=[],this.newGame(),this.hasInitializedTutorialPointers=!1;try{const{getCookie:t}=i(9573);if(t("wr_save_meta")){const{Menu:t}=i(3130);this.startMenu=new t({game:this,showCloseButton:!1}),this.startMenu.buildStartMenu(),this.startMenu.openMenu(),this.startMenuActive=!0}}catch{}}};r()}),f.ReverbEngine.initialize(),r.Sound.loadSounds(),this.started=!1,this.tutorialListener=null,this.setupEventListeners(),g.globalEventBus.on(E.EVENTS.LEVEL_GENERATION_STARTED,()=>{this.levelState=L.LEVEL_GENERATION}),g.globalEventBus.on(E.EVENTS.LEVEL_GENERATION_COMPLETED,()=>{this.levelState=L.IN_LEVEL})}startFreshWorld(t){e.gs.seed=t??4294967296*Math.random()>>>0,e.gs.randomState=e.gs.seed,(0,m.loadGameState)(this,[this.localPlayerID],e.gs,!0);try{const{loadSettings:t}=i(1856);t(this)}catch{}this.levelState=L.LEVEL_GENERATION,this.replayManager.beginRecording(e.gs.seed,this)}setupEventListeners(){g.globalEventBus.on("ChatCommand",this.commandHandler.bind(this));try{const t=()=>{try{const{saveToCookies:t}=i(6760);t(this)}catch{}};window.addEventListener("beforeunload",t),document.addEventListener("visibilitychange",()=>{"hidden"===document.visibilityState&&t()}),window.addEventListener("pagehide",t),window.addEventListener("unload",()=>{try{const{Sound:t}=i(7366);t.cleanup?.()}catch{}}),window.addEventListener("popstate",t),window.addEventListener("hashchange",t)}catch{}}generateAndShowRoomLayout(){const t=["center","split","corners"],e=t[Math.floor(I.Random.rand()*t.length)],i=8+Math.floor(12*I.Random.rand()),o=60+Math.floor(40*I.Random.rand()),a=50+Math.floor(30*I.Random.rand()),r=u.LevelImageGenerator.generateRandomLevel(o,a,i,I.Random.rand,e),n=r.areRoomsAccessible(),h=n?" All rooms accessible":" Some rooms inaccessible";this.currentLevelGenerator=r,this.pushMessage(`Generated ${i} rooms (${e} pattern) - ${h}`),this.pushMessage("Level layout shown on screen. Use '/cleargen' to clear.");const l=`${e}_${o}x${a}_${i}rooms_${(new Date).toISOString().slice(0,19).replace(/[T:]/g,"_")}.png`;r.savePNG(l),this.pushMessage(`PNG saved as: generated_levels/${l}`),this.pushMessage("Check browser downloads or console for data URL"),s.GameConstants.DEVELOPER_MODE&&console.log("Generated level details:",{pattern:e,dimensions:`${o}x${a}`,numRooms:i,accessible:n,rooms:r.getRooms()})}isPointInChatHotspot(t,e){const i=F.letter_height+1+4,o=s.GameConstants.WIDTH-5,a=Math.max(0,0),r=Math.min(s.GameConstants.WIDTH,5+o),n=s.GameConstants.HEIGHT-5,h=Math.max(0,n-i-10);return t>=a&&t<=r&&e>=h&&e<=n}destroy(){window.removeEventListener("blur",this.handleWindowBlur),window.removeEventListener("focus",this.handleWindowFocus),this.focusTimeout&&clearTimeout(this.focusTimeout)}}e.Game=F,F._replayManager=null,F.inputReceived=!1,F.letters="abcdefghijklmnopqrstuvwxyz1234567890,.!?:'()[]%-/+",F.letter_widths=[4,4,4,4,3,3,4,4,1,4,4,3,5,5,4,4,4,4,4,3,4,5,5,5,5,3,3,4,4,4,4,4,4,4,4,4,2,1,1,4,1,1,2,2,2,2,5,3,3,3],F.letter_height=6,F.letter_positions=[],F.rand=(t,e,i)=>e<t?t:Math.floor(i()*(e-t+1)+t),F.randTable=(t,e)=>t[F.rand(0,t.length-1,e)],F.measureText=t=>{let e=0;for(const i of t.toLowerCase())if(" "===i)e+=4;else for(let t=0;t<F.letters.length;t++)F.letters[t]===i&&(e+=F.letter_widths[t]+1);return{width:e,height:F.letter_height}},F.fillText=(t,e,i,s)=>{if(e=Math.round(e),i=Math.round(i),0===F.letter_positions.length)for(let t=0;t<F.letter_widths.length;t++)0===t?F.letter_positions[0]=0:F.letter_positions[t]=F.letter_positions[t-1]+F.letter_widths[t-1]+2;else{let s=F.measureText(t);if(s.width>0){let o=t+F.ctx.fillStyle;if(F.text_rendering_canvases[o])F.ctx.drawImage(F.text_rendering_canvases[o],e,i);else{F.text_rendering_canvases[o]=document.createElement("canvas"),F.text_rendering_canvases[o].width=s.width,F.text_rendering_canvases[o].height=s.height;let a=F.text_rendering_canvases[o].getContext("2d"),r=0;for(const e of t.toLowerCase())if(" "===e)r+=4;else for(let t=0;t<F.letters.length;t++)F.letters[t]===e&&(a.drawImage(F.fontsheet,F.letter_positions[t]+1,0,F.letter_widths[t],F.letter_height,r,0,F.letter_widths[t],F.letter_height),r+=F.letter_widths[t]+1);a.fillStyle=F.ctx.fillStyle,a.globalCompositeOperation="source-in",a.fillRect(0,0,F.text_rendering_canvases[o].width,F.text_rendering_canvases[o].height),F.ctx.drawImage(F.text_rendering_canvases[o],e,i)}}}},F.fillTextOutline=(t,e,i,s,o)=>{F.ctx.fillStyle=s;for(let s=-1;s<=1;s++)for(let o=-1;o<=1;o++)F.fillText(t,e+s,i+o);F.ctx.fillStyle=o,F.fillText(t,e,i)},F.drawHelper=(t,e,i,o,a,r,n,h,l,c="black",d=0,m=!1,u,p,y=0,g=0,f=!1)=>{F.ctx.save();const w=m?s.GameConstants.ENTITY_SHADE_LEVELS:s.GameConstants.SHADE_LEVELS;d=Math.round(d*Math.max(w,12))/Math.max(w,12);let E=((t,e,i,s,o,a,r,n)=>t.src+","+e+","+i+","+s+","+o+","+a+","+r+",fade="+(n||"none"))(t,e,i,o,a,d,c,u);if(p&&y>0&&(E+=`,outline=${p}:${Math.max(0,Math.min(1,y))}`),p&&y>0&&g&&(E+=`,outlineOffset=${Math.max(0,Math.floor(g))}`),p&&y>0&&f&&(E+=",outlineStyle=manhattan"),!F.shade_canvases[E]){F.shade_canvases[E]=document.createElement("canvas");const r=Math.round(o*s.GameConstants.TILESIZE),n=Math.round(a*s.GameConstants.TILESIZE),h=p&&y>0?1+Math.max(0,Math.floor(g)):0,l=p&&y>0?2+2*Math.max(0,Math.floor(g)):0;F.shade_canvases[E].width=r+l,F.shade_canvases[E].height=n+l;let m=F.shade_canvases[E].getContext("2d");m.clearRect(0,0,F.shade_canvases[E].width,F.shade_canvases[E].height);const w=p&&y>0?h:0,x=p&&y>0?h:0;if(m.globalCompositeOperation="source-over",m.drawImage(t,Math.round(e*s.GameConstants.TILESIZE),Math.round(i*s.GameConstants.TILESIZE),Math.round(o*s.GameConstants.TILESIZE),Math.round(a*s.GameConstants.TILESIZE),w,x,r,n),m.globalAlpha=d,m.fillStyle=c,m.fillRect(0,0,F.shade_canvases[E].width,F.shade_canvases[E].height),m.globalAlpha=1,m.globalCompositeOperation="destination-in",m.drawImage(t,Math.round(e*s.GameConstants.TILESIZE),Math.round(i*s.GameConstants.TILESIZE),Math.round(o*s.GameConstants.TILESIZE),Math.round(a*s.GameConstants.TILESIZE),w,x,r,n),u){const t=F.shade_canvases[E].width,e=F.shade_canvases[E].height;let i=null;switch(u){case"left":i=m.createLinearGradient(0,0,t,0),i.addColorStop(0,"rgba(0,0,0,0)"),i.addColorStop(1,"rgba(0,0,0,1)");break;case"right":i=m.createLinearGradient(0,0,t,0),i.addColorStop(0,"rgba(0,0,0,1)"),i.addColorStop(1,"rgba(0,0,0,0)");break;case"up":i=m.createLinearGradient(0,0,0,e),i.addColorStop(0,"rgba(0,0,0,0)"),i.addColorStop(1,"rgba(0,0,0,1)");break;case"down":i=m.createLinearGradient(0,0,0,e),i.addColorStop(0,"rgba(0,0,0,1)"),i.addColorStop(1,"rgba(0,0,0,0)")}i&&(m.globalCompositeOperation="destination-in",m.fillStyle=i,m.fillRect(0,0,t,e))}if(p&&y>0){const h=1+Math.max(0,Math.floor(g)),l=h,c=r+2*l,d=n+2*l,u=document.createElement("canvas");u.width=c,u.height=d;const E=u.getContext("2d"),b=(h,c,d)=>{for(let m=-c;m<=c;m++)for(let u=-c;u<=c;u++)d&&Math.abs(u)+Math.abs(m)>c||h.drawImage(t,Math.round(e*s.GameConstants.TILESIZE),Math.round(i*s.GameConstants.TILESIZE),Math.round(o*s.GameConstants.TILESIZE),Math.round(a*s.GameConstants.TILESIZE),l+u,l+m,r,n)};if(E.globalCompositeOperation="source-over",b(E,h,f),h-1>=0){const t=document.createElement("canvas");t.width=c,t.height=d,b(t.getContext("2d"),Math.max(0,h-1),f),E.globalCompositeOperation="destination-out",E.drawImage(t,0,0),E.globalCompositeOperation="source-over"}E.globalCompositeOperation="source-in",E.globalAlpha=Math.max(0,Math.min(1,y)),E.fillStyle=p,E.fillRect(0,0,c,d),E.globalCompositeOperation="source-over",E.globalAlpha=1,m.globalCompositeOperation="destination-over",m.drawImage(u,w-l,x-l),m.globalCompositeOperation="source-over"}}F.ctx.drawImage(F.shade_canvases[E],Math.round(r*s.GameConstants.TILESIZE)-(p&&y>0?1+Math.max(0,Math.floor(g)):0),Math.round(n*s.GameConstants.TILESIZE)-(p&&y>0?1+Math.max(0,Math.floor(g)):0),Math.round(h*s.GameConstants.TILESIZE)+(p&&y>0?2+2*Math.max(0,Math.floor(g)):0),Math.round(l*s.GameConstants.TILESIZE)+(p&&y>0?2+2*Math.max(0,Math.floor(g)):0)),F.ctx.restore()},F.drawTile=(t,e,i,s,o,a,r,n,h="black",l=0,c)=>{F.drawHelper(F.tileset,t,e,i,s,o,a,r,n,h,l,!1,c)},F.drawObj=(t,e,i,s,o,a,r,n,h="black",l=0,c)=>{F.drawHelper(F.objset,t,e,i,s,o,a,r,n,h,l,!0,c)},F.drawMob=(t,e,i,s,o,a,r,n,h="black",l=0,c,d,m=0,u=0,p=!1)=>{F.drawHelper(F.mobset,t,e,i,s,o,a,r,n,h,l,!0,c,d,m,u,p)},F.drawItem=(t,e,i,s,o,a,r,n,h="black",l=0,c,d,m=0,u=0,p=!1)=>{F.drawHelper(F.itemset,t,e,i,s,o,a,r,n,h,l,!0,c,d,m,u,p)},F.drawFX=(t,e,i,s,o,a,r,n,h="black",l=0,c)=>{F.drawHelper(F.fxset,t,e,i,s,o,a,r,n,h,l,!0,c)},e.game=new F,e.gs=new m.GameState},7924:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.HoverText=void 0;const s=i(7851),o=i(6291),a=i(3628);class r{static getHoverText(t,e,i,s,r){if(void 0===a.Input.mouseX||void 0===a.Input.mouseY||"none"===r)return[];const n=o.GameConstants.WIDTH/2,h=o.GameConstants.HEIGHT/2,l=t+Math.floor((a.Input.mouseX-n+o.GameConstants.TILESIZE/2)/o.GameConstants.TILESIZE),c=e+Math.floor((a.Input.mouseY-h+o.GameConstants.TILESIZE/2)/o.GameConstants.TILESIZE),d=[];if("inGame"!==r||s.inventory.isPointInQuickbarBounds(t,e).inBounds)"inventory"===r?s.inventory.itemAtSelectedSlot()&&d.push(s.inventory.itemAtSelectedSlot()?.hoverText()):s.openVendingMachine&&d.push(s.openVendingMachine.hoverText());else{for(const t of i.entities)t.x===l&&t.y===c&&d.push(t.hoverText());for(const t of i.items)t.x===l&&t.y===c&&d.push(t.hoverText());const t=i.getTile(l,c);t&&d.push(t.getName())}return d}static draw(t,e,i,a,n,h,l,c){const d=r.getHoverText(e,i,a,n,c);if(0!==d.length&&(s.Game.ctx.save(),"none"!==c)){for(const t of d){d.indexOf(t),s.Game.ctx.globalAlpha="inventory"===c?1:.5,s.Game.ctx.fillStyle="yellow";const a=s.Game.measureText(t).width/2;let r=e,n=i;switch(c){case"inGame":r=o.GameConstants.IN_GAME_HOVER_TEXT_FOLLOWS_MOUSE?h+8:o.GameConstants.WIDTH/2-a,n=o.GameConstants.IN_GAME_HOVER_TEXT_FOLLOWS_MOUSE?l+8:o.GameConstants.HEIGHT-32;break;case"inventory":r=o.GameConstants.INVENTORY_HOVER_TEXT_FOLLOWS_MOUSE?h+8:o.GameConstants.WIDTH/2-a,n=o.GameConstants.INVENTORY_HOVER_TEXT_FOLLOWS_MOUSE?l+8:o.GameConstants.HEIGHT-32;break;case"vendingMachine":r=o.GameConstants.VENDING_MACHINE_HOVER_TEXT_FOLLOWS_MOUSE?h+8:o.GameConstants.WIDTH/2-a,n=o.GameConstants.VENDING_MACHINE_HOVER_TEXT_FOLLOWS_MOUSE?l+8:o.GameConstants.HEIGHT-32}s.Game.fillTextOutline(t,r,n,"black","yellow")}s.Game.ctx.restore()}}}e.HoverText=r},7967:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.PropClusterer=void 0;const s=i(9467),o=i(9200);e.PropClusterer=class{constructor(t,e={}){this.placedPositions=[],this.availableTiles=[],this.wallProximityScoreGrid=null,this.debugReport=null,this.room=t,this.options={falloffExponent:e.falloffExponent??2,baseScore:e.baseScore??.1,maxInfluenceDistance:e.maxInfluenceDistance??10,useSeedPosition:e.useSeedPosition??!1,seedPosition:e.seedPosition??{x:0,y:0},clusterTowardsWalls:e.clusterTowardsWalls??!1,wallMaxDistance:e.wallMaxDistance??10,wallWeight:e.wallWeight??1,wallDeadzone:e.wallDeadzone??0,onlyInnerWalls:e.onlyInnerWalls??!1,wallDistanceMetric:e.wallDistanceMetric??"euclidean",debugEnabled:e.debugEnabled??!1,debugLogToConsole:e.debugLogToConsole??!1,debugCollectDetails:e.debugCollectDetails??!1,debugTopN:e.debugTopN??5,entityWeight:e.entityWeight??1,seedStrategy:e.seedStrategy??"random",wallAdjacentOnly:e.wallAdjacentOnly??!1,wallBandSize:e.wallBandSize??void 0}}generateClusteredPositions(t){if(this.placedPositions=[],this.availableTiles=this.getAvailableTiles(),this.options.debugEnabled?this.debugReport={config:this.options,seedUsed:null,wallsFound:0,wallGridStats:void 0,iterations:[]}:this.debugReport=null,this.wallProximityScoreGrid=this.options.clusterTowardsWalls?this.computeWallProximityScores():null,0===this.availableTiles.length)return[];if(this.options.useSeedPosition&&this.isValidPosition(this.options.seedPosition))this.placePosition(this.options.seedPosition),this.debugReport&&(this.debugReport.seedUsed={...this.options.seedPosition});else if(this.availableTiles.length>0)if("bestWall"===this.options.seedStrategy&&this.wallProximityScoreGrid){let t=null,e=-1/0;for(const i of this.availableTiles){const s=i.x-this.room.roomX,o=i.y-this.room.roomY;if(s>=0&&o>=0&&s<this.wallProximityScoreGrid.length&&o<this.wallProximityScoreGrid[0].length){const a=this.wallProximityScoreGrid[s][o];a>e&&(t=i,e=a)}}const i=t||this.availableTiles[Math.floor(s.Random.rand()*this.availableTiles.length)];this.placePosition(i),this.debugReport&&(this.debugReport.seedUsed={...i})}else{const t=Math.floor(s.Random.rand()*this.availableTiles.length),e=this.availableTiles.splice(t,1)[0];this.placedPositions.push(e),this.debugReport&&(this.debugReport.seedUsed={...e})}for(let e=1;e<t&&this.availableTiles.length>0;e++){const t=this.selectNextPosition(e);if(!t)break;this.placePosition(t)}return[...this.placedPositions]}getAvailableTiles(){return this.room.getEmptyTiles().map(t=>({x:t.x,y:t.y}))}isValidPosition(t){return this.availableTiles.some(e=>e.x===t.x&&e.y===t.y)}placePosition(t){this.placedPositions.push(t),this.availableTiles=this.availableTiles.filter(e=>!(e.x===t.x&&e.y===t.y))}selectNextPosition(t){if(0===this.availableTiles.length)return null;const e=this.availableTiles.map(t=>({position:t,score:this.calculateTileScore(t)})),i=e.reduce((t,e)=>t+e.score,0);if(i<=0){const o=Math.floor(s.Random.rand()*this.availableTiles.length),a=this.availableTiles.splice(o,1)[0];return this.captureDebugIteration(t,i,!0,a,e),a}const o=s.Random.rand()*i;let a=0;for(const s of e)if(a+=s.score,a>=o)return this.captureDebugIteration(t,i,!1,s.position,e),s.position;const r=e[e.length-1].position;return this.captureDebugIteration(t,i,!0,r,e),r}calculateTileScore(t){let e=this.options.baseScore,i=0;for(const e of this.placedPositions){const s=this.calculateDistance(t,e);s<=this.options.maxInfluenceDistance&&(i+=1/Math.pow(s,this.options.falloffExponent))}if(i>0&&(e+=i*this.options.entityWeight),this.wallProximityScoreGrid){const i=t.x-this.room.roomX,s=t.y-this.room.roomY;i>=0&&s>=0&&i<this.wallProximityScoreGrid.length&&s<this.wallProximityScoreGrid[0].length&&(e+=this.wallProximityScoreGrid[i][s])}return e}calculateDistance(t,e){const i=t.x-e.x,s=t.y-e.y;return Math.sqrt(i*i+s*s)}computeWallProximityScores(){const t=this.room.roomX,e=this.room.roomY,i=this.room.width,s=this.room.height,a=[];for(let r=t;r<t+i;r++){const t=this.room.roomArray[r];if(t)for(let i=e;i<e+s;i++){const e=t[i];e instanceof o.Wall&&(this.options.onlyInnerWalls&&!e.isInnerWall()||a.push(e))}}const r=[];if(this.options.wallAdjacentOnly)for(let a=t;a<t+i;a++){const t=this.room.roomArray[a];if(t)for(let i=e;i<e+s;i++){const e=t[i];if(!e||e.isSolid())continue;const s=this.room.roomArray[a-1]?.[i],n=this.room.roomArray[a+1]?.[i],h=this.room.roomArray[a]?.[i-1],l=this.room.roomArray[a]?.[i+1];(s instanceof o.Wall&&(!this.options.onlyInnerWalls||s.isInnerWall())||n instanceof o.Wall&&(!this.options.onlyInnerWalls||n.isInnerWall())||h instanceof o.Wall&&(!this.options.onlyInnerWalls||h.isInnerWall())||l instanceof o.Wall&&(!this.options.onlyInnerWalls||l.isInnerWall()))&&r.push({x:a,y:i})}}const n=new Array(i);for(let o=0;o<i;o++){n[o]=new Array(s);for(let i=0;i<s;i++){const s=t+o,h=e+i,l=this.wallScoreForGlobalTile(s,h,a,r);n[o][i]=l}}if(this.debugReport){if(this.debugReport.wallsFound=a.length,this.debugReport.wallTargetMode=this.options.wallAdjacentOnly?"adjacentFloor":"wall",this.options.debugCollectDetails){let t=Number.POSITIVE_INFINITY,e=Number.NEGATIVE_INFINITY,o=0,a=0;for(let r=0;r<i;r++)for(let i=0;i<s;i++){const s=n[r][i];s>0&&(s<t&&(t=s),s>e&&(e=s),o+=s,a++)}this.debugReport.wallGridStats={min:a?t:0,max:a?e:0,avg:a?o/a:0,nonZeroCount:a}}this.options.debugLogToConsole&&console.log("[PropClusterer] walls:",a.length,"gridStats:",this.debugReport.wallGridStats)}return n}getWallProximityScores(){return this.wallProximityScoreGrid}getLastDebugReport(){return this.debugReport}wallScoreForGlobalTile(t,e,i,s){if(0===i.length)return 0;let o=Number.POSITIVE_INFINITY;if(this.options.wallAdjacentOnly)for(let i=0;i<s.length;i++){const a=s[i],r=t-a.x,n=e-a.y,h="manhattan"===this.options.wallDistanceMetric?Math.abs(r)+Math.abs(n):Math.sqrt(r*r+n*n);h<o&&(o=h)}else for(let s=0;s<i.length;s++){const a=i[s],r=t-a.x,n=e-a.y,h="manhattan"===this.options.wallDistanceMetric?Math.abs(r)+Math.abs(n):Math.sqrt(r*r+n*n);h<o&&(o=h)}const a=Math.max(1e-4,this.options.wallMaxDistance),r=Math.max(0,this.options.wallDeadzone);if(o>a)return 0;if(o<r)return 0;const n=this.options.wallBandSize;if(n&&n>0){const t=Math.min(1,Math.max(0,(o-r)/n)),e=1-t*t;return this.options.wallWeight*Math.max(0,e)}const h=(o-r)/(a-r),l=1-h*h;return this.options.wallWeight*Math.max(0,l)}analyzeEffectiveness(t,e={}){const i=t&&t.length?t:this.placedPositions,s={wallScoreThresholdNormalized:e.wallScoreThresholdNormalized??.7,neighborMaxDistance:e.neighborMaxDistance??2,neighborWeight:e.neighborWeight??1,combineMode:e.combineMode??"max"},o=this.wallProximityScoreGrid||this.computeWallProximityScores(),a=Math.max(1e-6,this.options.wallWeight),r=[],n=i.map(t=>{const e=t.x-this.room.roomX,i=t.y-this.room.roomY,s=e>=0&&i>=0&&o&&e<o.length&&i<o[0].length?o[e][i]:0;return Math.max(0,Math.min(1,s/a))}),h=n.map(t=>t>=s.wallScoreThresholdNormalized);for(let t=0;t<i.length;t++){const e=i[t],o=n[t];let a=Number.POSITIVE_INFINITY;for(let s=0;s<i.length;s++){if(t===s)continue;if(!h[s])continue;const o=i[s],r=this.calculateDistance(e,o);r<a&&(a=r)}let l,c=0;if(a!==Number.POSITIVE_INFINITY){const t=Math.max(s.neighborMaxDistance,1e-6);if(a<=t){const e=Math.max(0,Math.min(1,a/t));c=1-e*e}}l="sum"===s.combineMode?Math.min(1,o+c*s.neighborWeight):Math.max(o,c*s.neighborWeight),r.push({position:{x:e.x,y:e.y},wallScoreNormalized:o,neighborScore:c,combinedScore:l})}const l=t=>t.length?t.reduce((t,e)=>t+e,0)/t.length:0,c=l(r.map(t=>t.wallScoreNormalized)),d=l(r.map(t=>t.neighborScore)),m=l(r.map(t=>t.combinedScore)),u=s.wallScoreThresholdNormalized,p=r.filter(t=>t.wallScoreNormalized>=u).length/Math.max(1,r.length),y=r.filter(t=>t.combinedScore>=u).length/Math.max(1,r.length),g={total:r.length,params:{...s,wallWeightUsed:a,wallTargetMode:this.options.wallAdjacentOnly?"adjacentFloor":"wall"},perProp:r,summary:{avgWall:c,avgNeighbor:d,avgCombined:m,pctNearWall:p,pctCombinedHigh:y}};return this.options.debugLogToConsole&&console.log("[PropClusterer] effectiveness:",{total:g.total,params:g.params,summary:{avgWall:Number(c.toFixed(3)),avgNeighbor:Number(d.toFixed(3)),avgCombined:Number(m.toFixed(3)),pctNearWall:Number((100*p).toFixed(1))+"%",pctCombinedHigh:Number((100*y).toFixed(1))+"%"}}),g}captureDebugIteration(t,e,i,s,o){if(!this.options.debugEnabled||!this.debugReport)return;const a={iteration:t,availableTiles:this.availableTiles.length,placedSoFar:this.placedPositions.length,totalScore:e,usedFallback:i,selected:s};if(this.options.debugCollectDetails){const t=Math.max(0,this.options.debugTopN||0);if(t>0){const e=o.slice(0).sort((t,e)=>e.score-t.score).slice(0,t);a.top=e.map(t=>{const e=this.breakdownTileScore(t.position);return{position:{...t.position},total:e.total,base:e.base,entities:e.entities,wall:e.wall}})}}if(this.debugReport.iterations.push(a),this.options.debugLogToConsole){const s=a.top&&a.top[0];console.log("[PropClusterer] iter",t,"avail=",a.availableTiles,"placed=",a.placedSoFar,"totalScore=",e.toFixed(3),i?"(fallback)":"",s?{topPos:s.position,base:Number(s.base.toFixed(3)),entities:Number(s.entities.toFixed(3)),wall:Number(s.wall.toFixed(3)),total:Number(s.total.toFixed(3))}:void 0)}}breakdownTileScore(t){const e=this.options.baseScore;let i=0;for(const e of this.placedPositions){const s=this.calculateDistance(t,e);s<=this.options.maxInfluenceDistance&&(i+=1/Math.pow(s,this.options.falloffExponent))}let s=0;if(this.wallProximityScoreGrid){const e=t.x-this.room.roomX,i=t.y-this.room.roomY;e>=0&&i>=0&&e<this.wallProximityScoreGrid.length&&i<this.wallProximityScoreGrid[0].length&&(s=this.wallProximityScoreGrid[e][i])}return{base:e,entities:i,wall:s,total:e+i*this.options.entityWeight+s}}}},7975:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.SkullEnemy=void 0;const s=i(7851),o=i(7455),a=i(1887),r=i(6986);class n extends r.Enemy{constructor(t,e,i,r,n){super(t,e,i,r),this.REGEN_TICKS=5,this.hit=()=>this.damage,this.hurt=(t,e,i="none")=>{this.handleEnemyCase(t);let s=!1,o=0;this.shielded&&(o=this.shield.health,o>0&&this.shield.hurt(e)),this.ticksSinceFirstHit=0,2==this.health&&(this.unconscious=!1),this.health-=e,this.maxHealth-=o,this.startHurting(),this.healthBar.hurt(),this.createDamageNumber(e,i),this.playHitSound(),1==this.health?(this.unconscious=!0,a.ImageParticle.spawnCluster(this.room,this.x+.5,this.y+.5,3,28)):this.healthBar.hurt(),this.health<=0?(a.ImageParticle.spawnCluster(this.room,this.x+.5,this.y+.5,0,24),this.kill()):this.hurtCallback()},this.behavior=()=>{if(this.lastX=this.x,this.lastY=this.y,!this.dead){if(this.handleSkipTurns())return;if(this.health<=1)return this.unconscious=!0,this.ticksSinceFirstHit++,this.ticksSinceFirstHit>=this.REGEN_TICKS&&(this.healthBar.hurt(),this.health=2,this.unconscious=!1),void this.ticks++;if(this.ticks++,this.seenPlayer){if(this.seenPlayer){if(this.room.playerTicked===this.targetPlayer){this.alertTicks=Math.max(0,this.alertTicks-1);let t=this.x,e=this.y,i=Array();for(const t of this.room.entities)t!==this&&i.push({x:t.x,y:t.y});for(let t=this.x-1;t<=this.x+1;t++)for(let e=this.y-1;e<=this.y+1;e++)this.room.roomArray[t][e]instanceof o.SpikeTrap&&this.room.roomArray[t][e].on&&i.push({x:t,y:e});const a=this.searchPathLocalized(this.targetPlayer,i);if(a.length>0){let i=a[0].pos.x,o=a[0].pos.y,r=this.direction,n=this.targetPlayer;if(this.facePlayer(n),i>t?this.direction=s.Direction.RIGHT:i<t?this.direction=s.Direction.LEFT:o>e?this.direction=s.Direction.DOWN:o<e&&(this.direction=s.Direction.UP),r==this.direction){let a=!1;for(const t in this.game.players)this.game.rooms[this.game.players[t].levelID]===this.room&&this.game.players[t].x===i&&this.game.players[t].y===o&&(this.game.players[t].hurt(this.hit(),this.name),this.drawX=.5*(this.x-this.game.players[t].x),this.drawY=.5*(this.y-this.game.players[t].y),this.game.players[t]===this.game.players[this.game.localPlayerID]&&this.game.shakeScreen(10*this.drawX,10*this.drawY));a||(this.tryMove(i,o),this.setDrawXY(t,e),this.x>t?this.direction=s.Direction.RIGHT:this.x<t?this.direction=s.Direction.LEFT:this.y>e?this.direction=s.Direction.DOWN:this.y<e&&(this.direction=s.Direction.UP))}}this.direction==s.Direction.LEFT&&(i.push({x:this.x,y:this.y+1}),i.push({x:this.x,y:this.y-1})),this.direction==s.Direction.RIGHT&&(i.push({x:this.x,y:this.y+1}),i.push({x:this.x,y:this.y-1})),this.direction==s.Direction.DOWN&&(i.push({x:this.x+1,y:this.y}),i.push({x:this.x-1,y:this.y})),this.direction==s.Direction.UP&&(i.push({x:this.x+1,y:this.y}),i.push({x:this.x-1,y:this.y})),this.makeHitWarnings()}let t=-1!==Object.values(this.game.offlinePlayers).indexOf(this.targetPlayer);if(!this.aggro||t){let e=this.nearestPlayer();if(!1!==e){let[i,s]=e;i<=4&&(t||i<this.playerDistance(this.targetPlayer))&&s!==this.targetPlayer&&(this.targetPlayer=s,this.facePlayer(s),s===this.game.players[this.game.localPlayerID]&&(this.alertTicks=1),this.makeHitWarnings())}}}}else this.lookForPlayer()}},this.draw=t=>{this.dead||(s.Game.ctx.save(),s.Game.ctx.globalAlpha=this.alpha,this.dead||(this.updateDrawXY(t),this.tileX=5,this.tileY=8,(this.health<=1||this.dying)&&(this.tileX=3,this.tileY=0,this.ticksSinceFirstHit>=3&&(this.flashingFrame+=.1*t,Math.floor(this.flashingFrame)%2==0&&(this.tileX=2))),this.frame+=.1*t,this.frame>=4&&(this.frame=0),this.hasShadow&&this.drawShadow(t),s.Game.drawMob(this.tileX+(5===this.tileX?Math.floor(this.frame):0),this.tileY+2*this.direction,1,2,this.x-this.drawX,this.y-this.drawYOffset-this.drawY-this.jumpY,1,2,this.softShadeColor,this.shadeAmount(),void 0,this.outlineColor(),this.outlineOpacity())),this.cloned||(this.seenPlayer||this.drawSleepingZs(t),this.alertTicks>0&&this.drawExclamation(t)),s.Game.ctx.restore())},this.ticks=0,this.frame=0,this.health=2,this.maxHealth=2,this.defaultMaxHealth=2,this.tileX=5,this.tileY=8,this.seenPlayer=!1,this.aggro=!1,this.ticksSinceFirstHit=0,this.flashingFrame=0,this.deathParticleColor="#ffffff",this.name="skeleton",this.forwardOnlyAttack=!0,n&&(this.drop=n),this.getDrop(["weapon","consumable","tool","coin"])}}e.SkullEnemy=n,n.difficulty=2,n.tileX=5,n.tileY=8},7976:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Sprout=void 0;const s=i(606),o=i(7851),a=i(606);class r extends s.Entity{constructor(t,e,i,s){super(t,e,i,s),this.draw=t=>{this.dead||(o.Game.ctx.save(),o.Game.ctx.globalAlpha=this.alpha,this.dead||(this.hasShadow&&this.drawShadow(t),this.updateDrawXY(t),o.Game.drawObj(this.tileX,this.tileY,1,2,this.x-this.drawX,this.y-this.drawYOffset-this.drawY,1,2,this.room.shadeColor,this.shadeAmount())),o.Game.ctx.restore())},this.drawTopLayer=t=>{this.drawableY=this.y},this.room=t,this.health=1,this.tileX=17,this.tileY=2,this.hasShadow=!0,this.chainPushable=!1,this.name="sprout",this.imageParticleX=0,this.imageParticleY=28}get type(){return a.EntityType.PROP}}e.Sprout=r},8004:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.PottedPlant=void 0;const s=i(606),o=i(7851),a=i(606);class r extends s.Entity{constructor(t,e,i,s,a){super(t,e,i,s),this.uniqueKillBehavior=()=>{this.createHitParticles(0,29)},this.draw=t=>{this.dead||(o.Game.ctx.save(),o.Game.ctx.globalAlpha=this.alpha,this.dead||(this.hasShadow&&this.drawShadow(t),this.updateDrawXY(t),(this.health<=1||this.dying)&&(this.tileX=2),o.Game.drawObj(this.tileX,this.tileY,1,2,this.x-this.drawX,this.y-this.drawYOffset-this.drawY,1,2,this.room.shadeColor,this.shadeAmount())),o.Game.ctx.restore())},this.drawTopLayer=t=>{this.drawableY=this.y},this.room=t,this.health=2,this.tileX=3,this.tileY=0,this.hasShadow=!0,this.chainPushable=!1,this.name="plant",this.imageParticleX=0,this.imageParticleY=28,a&&(this.drop=a)}get type(){return a.EntityType.PROP}}e.PottedPlant=r},8017:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Rock=void 0;const s=i(7172),o=i(9432),a=i(9467);class r extends s.Resource{constructor(t,e,i,s){super(t,e,i,s),this.room=t,this.health=2,this.tileX=8,this.tileY=2,this.hasShadow=!1,this.chainPushable=!1,this.name="rock",this.imageParticleX=0,this.imageParticleY=25,a.Random.rand()<.005&&this.drops.push(new o.Geode(this.room,this.x,this.y))}}e.Rock=r},8026:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Inventory=void 0;const s=i(5366),o=i(7851),a=i(6291),r=i(8549),n=i(2270),h=i(1236),l=i(4052),c=i(5180),d=i(8900),m=i(3628),u=i(9915),p=i(3130),y=i(1929),g=i(4937),f=i(5947),w=i(2502),E=i(6277),x=i(4478),b=i(6105);let T=100,I="#5a595b",S="#292c36",v="#85a8e6";e.Inventory=class{constructor(t,e){this.rows=4,this.cols=5,this.selX=0,this.selY=0,this.isOpen=!1,this.openTime=Date.now(),this.coins=0,this.weapon=null,this._expansion=a.GameConstants.DEVELOPER_MODE?3:0,this.grabbedItem=null,this._mouseDownStartX=null,this._mouseDownStartY=null,this._mouseDownItem=null,this._wasHoldDetected=!1,this._isDragging=!1,this._dragStartItem=null,this._dragStartSlot=null,this.itemEquipAnimations=new Map,this.foundItems=[],this.dragEndTime=Date.now(),this.closeTime=Date.now(),this.usingItem=null,this.usingItemIndex=null,this.mostRecentInput="keyboard",this.initializedItems=!1,this.clear=()=>{this.items.fill(null),this.equipAnimAmount.fill(0)},this.open=()=>{this.isOpen=!this.isOpen,this.isOpen&&(this.openTime=Date.now(),this.player?.map?.mapOpen&&(this.player.map.mapOpen=!1,this.player.map.mapOpenProgress=0))},this.toggleOpen=()=>{this.isOpen?this.close():this.open()},this.close=()=>{if(this.isOpen){this.isOpen=!1,this.closeTime=Date.now(),this.selY>0&&(this.selY=0),this.usingItem=null,this.usingItemIndex=null;try{this.game.removePointer?.("open-inventory")}catch{}}},this.left=()=>{this.selX>0&&this.selX--},this.right=()=>{this.selX<this.cols-1&&this.selX++},this.up=()=>{this.selY>0&&this.selY--},this.down=()=>{this.selY<this.rows+this._expansion-1&&this.selY++},this.space=()=>{this.itemUse()},this.itemAtSelectedSlot=()=>{let t=this.selX+this.selY*this.cols;return t<0||t>=this.items.length?null:this.items[t]},this.getIndexOfItem=t=>null===t?-1:this.items.indexOf(t),this.itemUse=()=>{let t=this.selX+this.selY*this.cols;if(t<0||t>=this.items.length)return;const e=this.items[t];if(this.usingItem){if(null===e)return this.usingItem=null,void(this.usingItemIndex=null);e instanceof s.Item&&this.usingItem.useOnOther(this.player,e),this.usingItem=null,this.usingItemIndex=null}else if(e instanceof c.Usable)e.canUseOnOther?(this.usingItem=e,this.usingItemIndex=t):e.onUse(this.player);else if(e instanceof r.Equippable){if(e.toggleEquip(),e instanceof l.Weapon){if(e.broken||e.cooldown>0||e.disabled)return;this.weapon=e.equipped?e:null}e.equipped&&this.items.forEach((t,i)=>{t instanceof r.Equippable&&t!==e&&!e.coEquippable(t)&&(t.equipped=!1,this.equipAnimAmount[i]=0)})}},this.canPickup=t=>!this.isFull()||t instanceof h.Coin||!(!this.items.find(e=>null!==e&&e.constructor===t.constructor)||!t.stackable),this.leftQuickbar=()=>{this.mostRecentInput="keyboard",this.left()},this.rightQuickbar=()=>{this.mostRecentInput="keyboard",this.right()},this.spaceQuickbar=()=>{this.mostRecentInput="keyboard",this.itemUse()},this.mouseMove=()=>{const{x:t,y:e}=d.MouseCursor.getInstance().getPosition(),i=this.isPointInInventoryBounds(t,e);if(i.inBounds){this.mostRecentInput="mouse";const s=this.isOpen?Math.min(18,18*(Date.now()-this.openTime)/T):18,o=2,a=-2,r=this.selX;this.selY,this.selX=Math.max(0,Math.min(Math.floor((t-i.startX)/(s+2*o+a)),this.cols-1)),this.selY=this.isOpen?Math.max(0,Math.min(Math.floor((e-i.startY)/(s+2*o+a)),this.rows+this._expansion-1)):0,r!==this.selX||this.selY}},this.moveItemToSlot=(t,e,i,s)=>{null!==t&&(this.equipAnimAmount[e],i&&this.equipAnimAmount[s],null===i?(this.items[e]=t,this.equipAnimAmount[e]=this.itemEquipAnimations.get(t)??0):(this.items[e]=i,this.items[s]=t,this.equipAnimAmount[e]=this.itemEquipAnimations.get(i)??0,this.equipAnimAmount[s]=this.itemEquipAnimations.get(t)??0))},this.grabItem=t=>{if(null===t)return;if(null!==this.grabbedItem)return;const e=this.getIndexOfItem(t);-1!==e&&(this.items[e]=null,this.grabbedItem=t)},this.releaseItem=()=>{if(null===this.grabbedItem)return;const t=this.selX+this.selY*this.cols;this.items[t],this.items[t]=this.grabbedItem,this.grabbedItem=null},this.drawDraggedItem=t=>{if(null===this.grabbedItem)return;const{x:e,y:i}=d.MouseCursor.getInstance().getPosition(),s=Math.round(e-.5*a.GameConstants.TILESIZE),o=Math.round(i-.5*a.GameConstants.TILESIZE),r=s/a.GameConstants.TILESIZE,n=o/a.GameConstants.TILESIZE;this.grabbedItem.drawIcon(t,r,n)},this.drop=()=>{if(!this.isOpen)return;let t=this.selX+this.selY*this.cols;if(t<0||t>=this.items.length)return;const e=this.items[t];null!==e&&this.dropItem(e,t)},this.dropItem=(t,e)=>{const i=this.player.getRoom?this.player.getRoom():this.game.levels[this.player.depth].rooms[this.player.levelID];t.level=i,t.x=this.player.x,t.y=this.player.y,t.alpha=1,t.pickedUp=!1,t.dropFromInventory(),this.equipAnimAmount[e]=0,t.drawableY=this.player.y,i.items.push(t),this.items[e]=null},this.dropFromInventory=()=>{},this.hasItem=t=>this.items.find(e=>e instanceof t)||null,this.hasItemCount=t=>null!==t&&(t instanceof h.Coin?this.coinCount()>=t.stackCount:this.items.some(e=>null!==e&&e.constructor===t.constructor&&e.stackCount>=t.stackCount)),this.subtractItemCount=t=>{null!==t&&(t instanceof h.Coin?this.subtractCoins(t.stackCount):this.items.forEach((e,i)=>{null!==e&&e.constructor===t.constructor&&(e.stackCount-=t.stackCount,e.stackCount<=0&&(this.items[i]=null))}))},this.subtractItem=(t,e)=>{null!==t&&(t instanceof h.Coin?this.subtractCoins(t.stackCount):this.items.forEach((i,s)=>{null!==i&&i.constructor===t.constructor&&(i.stackCount-=e,i.stackCount<=0&&(this.items[s]=null))}))},this.coinCount=()=>this.coins,this.subtractCoins=t=>{this.coins=Math.max(0,this.coins-t)},this.addCoins=t=>{this.coins+=t},this.isFull=()=>this.items.filter(t=>null!==t).length>=(this.rows+this._expansion)*this.cols,this.addItem=(t,e=null)=>{if(null===t)return!1;if(t instanceof h.Coin)return this.coins+=t.stackCount,w.globalEventBus.emit(E.EVENTS.COIN_COLLECTED,{amount:t.stackCount}),!0;if(t instanceof r.Equippable&&t.setWielder(this.player),t.stackable){e&&(t.stackCount=e);for(let e=0;e<this.items.length;e++)if(null!==this.items[e]&&this.items[e].constructor===t.constructor)return this.items[e].stackCount+=t.stackCount,!0}const i=this.items.slice(0,this.cols).every(t=>null!==t);if(!this.isFull())for(let e=0;e<this.items.length;e++)if(null===this.items[e]){if(this.items[e]=t,this.initializedItems&&i)try{this.game.maybeShowOpenInventoryPointer?.()}catch{}return!0}return!1},this.removeItem=t=>{if(null===t)return;const e=this.items.indexOf(t);-1!==e&&(this.items[e]=null)},this.canMine=()=>null!==this.hasItem(u.Pickaxe),this.canFish=()=>null!==this.hasItem(g.FishingRod),this.getArmor=()=>this.items.find(t=>(t instanceof n.Armor||t instanceof x.WoodenShield)&&t.equipped)||null,this.divingHelmetEquipped=()=>this.items.some(t=>t instanceof b.DivingHelmet&&t.equipped)||!1,this.hasWeapon=()=>null!==this.weapon,this.getWeapon=()=>this.weapon,this.tick=()=>{this.items.forEach(t=>{null!==t&&t.tickInInventory()}),this.checkForDragStart()},this.textWrap=(t,e,i,s)=>{if(""===t)return i;let a=t.split(" "),r="";for(;a.length>0;)o.Game.measureText(r+a[0]).width>s?(o.Game.fillText(r,e,i),r="",i+=8):(""!==r&&(r+=" "),r+=a[0],a.splice(0,1));return""!==r.trim()&&(o.Game.fillText(r,e,i),i+=8),i},this.drawCoins=t=>{let e=19;this.coins>=3&&(e=20),this.coins>=7&&(e=21);let i=(this.getQuickbarStartX()+(20*this.cols- -2)-5)/a.GameConstants.TILESIZE-1,s=a.GameConstants.HEIGHT/a.GameConstants.TILESIZE-1.3;const r=(a.GameConstants.WIDTH-36)/a.GameConstants.TILESIZE;i>r&&(i=r),a.GameConstants.WIDTH<180?(s-=1.25,i+=1.15):i+=1.5,a.GameConstants.WIDTH<145&&(i-=1.15),o.Game.drawItem(e,0,1,2,i,s-1,1,2);const n=`${this.coins}`;o.Game.measureText(n).width,o.Game.fillTextOutline(n,i*a.GameConstants.TILESIZE+10-o.Game.measureText(this.coins.toString()).width+5,s*a.GameConstants.TILESIZE+9+2,a.GameConstants.OUTLINE,"white")},this.pointInside=(t,e)=>{const i=Math.min(18,18*(Date.now()-this.openTime)/T),s=(Math.round(.5*Math.sin(.01*Date.now())+.5),this.cols*(i+4+-2)- -2),o=(this.rows+this._expansion)*(i+4+-2)- -2,r=Math.round(.5*a.GameConstants.WIDTH-.5*s)-1,n=this.isOpen?Math.round(.5*a.GameConstants.HEIGHT-.5*o)-1:a.GameConstants.HEIGHT-(i+4)-5-1,h=this.isOpen?o+2:i+4+2;return t>=r&&t<=r+s+2&&e>=n&&e<=n+h},this.drawQuickbar=t=>{const{x:e,y:i}=d.MouseCursor.getInstance().getPosition(),s=this.isPointInInventoryBounds(e,i).inBounds||"keyboard"===this.mostRecentInput,r=18,n=Math.floor(20*this.cols- -2),h=Math.floor(22),l=Math.round(.5*a.GameConstants.WIDTH-.5*n),c=Math.floor(a.GameConstants.HEIGHT-h-2);for(let e=0;e<this.cols;e++){const i=e;if(e!==this.selX){o.Game.ctx.fillStyle=I,o.Game.ctx.fillRect(Math.floor(l+20*e+2),Math.floor(c+2),Math.floor(r),Math.floor(r)),o.Game.ctx.clearRect(Math.floor(l+20*e+2+1),Math.floor(c+2+1),Math.floor(16),Math.floor(16)),o.Game.ctx.fillStyle=v,o.Game.ctx.globalAlpha=.3;const t=Math.floor(r*(1-this.equipAnimAmount[i]));o.Game.ctx.fillRect(Math.floor(l+20*e+2),Math.floor(c+2+t),Math.floor(r),Math.floor(r-t)),o.Game.ctx.globalAlpha=1}if(i<this.items.length&&null!==this.items[i]){const s=l+20*e+2+Math.floor(9)-.5*a.GameConstants.TILESIZE,o=c+2+Math.floor(9)-.5*a.GameConstants.TILESIZE,r=s/a.GameConstants.TILESIZE,n=o/a.GameConstants.TILESIZE;this.items[i]?.drawIcon(t,r,n)}}{const e=Math.floor(l+20*this.selX),i=Math.floor(c),n=s?1:0;o.Game.ctx.fillStyle=I,o.Game.ctx.fillRect(Math.floor(e+2-n),Math.floor(i+2-n),Math.floor(r+2*n),Math.floor(r+2*n));const h=s?r:16,d=s?0:1;o.Game.ctx.clearRect(Math.floor(l+20*this.selX+2+d),Math.floor(c+2+d),Math.floor(h),Math.floor(h));const m=this.selX;o.Game.ctx.fillStyle=v,o.Game.ctx.globalAlpha=.3;const u=(r+2*n)*(1-this.equipAnimAmount[m]);if(o.Game.ctx.fillRect(Math.round(l+20*this.selX+2-n),Math.round(c+2+u-n),Math.round(r+2*n),Math.round(r+2*n-u)),o.Game.ctx.globalAlpha=1,this.drawUsingItem(t,l,c,r,2,-2),m<this.items.length&&null!==this.items[m]){const s=e+2+Math.floor(9)-.5*a.GameConstants.TILESIZE,o=i+2+Math.floor(9)-.5*a.GameConstants.TILESIZE,r=s/a.GameConstants.TILESIZE,n=o/a.GameConstants.TILESIZE;this.items[m]?.drawIcon(t,r,n)}this.drawUsingItem(t,l,c,r,2,-2)}this.drawUsingItem(t,l,c,r,2,-2)},this.drawUsingItem=(t,e,i,s,a,r)=>{if(o.Game.ctx.globalCompositeOperation="source-over",this.usingItem&&null!==this.usingItemIndex){const t=e+this.usingItemIndex%this.cols*(s+2*a+r),n=i+Math.floor(this.usingItemIndex/this.cols)*(s+2*a+r);o.Game.ctx.strokeStyle="yellow",o.Game.ctx.lineWidth=2,o.Game.ctx.strokeRect(t,n,s+2*a,s+2*a),o.Game.ctx.lineWidth=1}},this.updateEquipAnimAmount=t=>{this.equipAnimAmount.forEach((e,i)=>{const s=this.items[i];if(s instanceof r.Equippable){let o=s.equipped?1:0,a=this.itemEquipAnimations.get(s)??e;a+=.2*t*(o-a),a=Math.max(0,Math.min(1,a)),this.itemEquipAnimations.set(s,a),this.equipAnimAmount[i]=a}else this.equipAnimAmount[i]=0,s&&this.itemEquipAnimations.delete(s)})},this.draw=t=>{o.Game.ctx.imageSmoothingEnabled=!1,o.Game.ctx.imageSmoothingQuality="low";const{x:e,y:i}=d.MouseCursor.getInstance().getPosition(),s=this.isPointInInventoryBounds(e,i).inBounds,n=Math.floor(Math.min(18,18*(Date.now()-this.openTime)/T)),h=(Math.round(.5*Math.sin(.01*Date.now())+.5),Math.floor(this.rows+this._expansion)),l=Math.floor(this.cols*(n+4+-2)- -2),m=Math.floor(h*(n+4+-2)- -2),u=Math.round(.5*a.GameConstants.WIDTH-.5*l)-1,g=Math.round(.5*a.GameConstants.HEIGHT-.5*m)-1;if(this.drawCoins(t),this.drawQuickbar(t),this.updateEquipAnimAmount(t),this.drawInventoryButton(t),p.Menu.drawOpenMenuButton(),y.XPCounter.draw(t),this.isOpen){o.Game.ctx.fillStyle="rgba(0, 0, 0, 0.8)",o.Game.ctx.fillRect(0,0,a.GameConstants.WIDTH,a.GameConstants.HEIGHT),o.Game.ctx.globalAlpha=1;const e=Math.floor(Math.min(18,18*(Date.now()-this.openTime)/T)),i=2,n=-2,h=Math.floor(1+Math.round(.5*Math.sin(.01*Date.now())+.5)),l=this.rows+this._expansion,d=1,m=Math.floor(this.cols*(e+2*i+n)-n),u=Math.floor(l*(e+2*i+n)-n);o.Game.ctx.fillStyle="white";const p=Math.round(.5*a.GameConstants.WIDTH-.5*m)-d,y=Math.round(.5*a.GameConstants.HEIGHT-.5*u)-d;if(o.Game.ctx.fillRect(p,y,m+2*d,u+2*d),s||"keyboard"===this.mostRecentInput){const t=Math.round(.5*a.GameConstants.WIDTH-.5*m+this.selX*(e+2*i+n))-h-d,s=Math.round(.5*a.GameConstants.HEIGHT-.5*u+this.selY*(e+2*i+n))-h-d;o.Game.ctx.fillRect(t,s,e+2*i+2*h+2*d,e+2*i+2*h+2*d)}for(let s=0;s<this.cols;s++)for(let r=0;r<this.rows+this._expansion;r++){const h=Math.round(.5*a.GameConstants.WIDTH-.5*m+s*(e+2*i+n)),l=Math.round(.5*a.GameConstants.HEIGHT-.5*u+r*(e+2*i+n));o.Game.ctx.fillStyle=S,o.Game.ctx.fillRect(h,l,e+2*i,e+2*i),o.Game.ctx.fillStyle=I,o.Game.ctx.fillRect(h+i,l+i,e,e);const c=s+r*this.cols;o.Game.ctx.fillStyle=v;const d=Math.round(e*(1-this.equipAnimAmount[c]));if(o.Game.ctx.fillRect(h+i,l+i+d,e,e-d),c<this.items.length&&null!==this.items[c]){const o=Math.round(.5*a.GameConstants.WIDTH-.5*m+s*(e+2*i+n)+i+Math.floor(.5*e)-.5*a.GameConstants.TILESIZE),h=Math.round(.5*a.GameConstants.HEIGHT-.5*u+r*(e+2*i+n)+i+Math.floor(.5*e)-.5*a.GameConstants.TILESIZE),l=o/a.GameConstants.TILESIZE,d=h/a.GameConstants.TILESIZE;this.items[c]?.drawIcon(t,l,d)}}if(Date.now()-this.openTime>=T&&(this.items.forEach((s,o)=>{if(null===s)return;const r=o%this.cols,h=Math.floor(o/this.cols),l=Math.round(.5*a.GameConstants.WIDTH-.5*m+r*(e+2*i+n)+i+Math.floor(.5*e)-.5*a.GameConstants.TILESIZE),c=Math.round(.5*a.GameConstants.HEIGHT-.5*u+h*(e+2*i+n)+i+Math.floor(.5*e)-.5*a.GameConstants.TILESIZE),d=l/a.GameConstants.TILESIZE,p=c/a.GameConstants.TILESIZE;s.drawIcon(t,d,p)}),s||"keyboard"===this.mostRecentInput)){o.Game.ctx.fillStyle=S,o.Game.ctx.fillRect(Math.round(.5*a.GameConstants.WIDTH-.5*m+this.selX*(e+2*i+n)-h),Math.round(.5*a.GameConstants.HEIGHT-.5*u+this.selY*(e+2*i+n)-h),e+2*i+2*h,e+2*i+2*h);const s=Math.round(.5*a.GameConstants.WIDTH-.5*m+this.selX*(e+2*i+n)+i-h),r=Math.round(.5*a.GameConstants.HEIGHT-.5*u+this.selY*(e+2*i+n)+i-h);o.Game.ctx.fillStyle=I,o.Game.ctx.fillRect(s,r,e+2*h,e+2*h);const l=this.selX+this.selY*this.cols;if(l<this.items.length&&null!==this.items[l]){o.Game.ctx.fillStyle=v;const s=Math.round((e+2*h)*(1-this.equipAnimAmount[l]));o.Game.ctx.fillRect(Math.round(.5*a.GameConstants.WIDTH-.5*m+this.selX*(e+2*i+n)+i-h),Math.round(.5*a.GameConstants.HEIGHT-.5*u+this.selY*(e+2*i+n)+i-h+s),e+2*h,e+2*h-s);const r=Math.round(.5*a.GameConstants.WIDTH-.5*m+this.selX*(e+2*i+n)+i+Math.floor(.5*e)-.5*a.GameConstants.TILESIZE),c=Math.round(.5*a.GameConstants.HEIGHT-.5*u+this.selY*(e+2*i+n)+i+Math.floor(.5*e)-.5*a.GameConstants.TILESIZE),d=r/a.GameConstants.TILESIZE,p=c/a.GameConstants.TILESIZE;this.items[l]?.drawIcon(t,d,p)}}const g=this.selX+this.selY*this.cols;if(g<this.items.length&&null!==this.items[g]){const t=this.items[g];o.Game.ctx.fillStyle="white";let s="";t instanceof r.Equippable&&(s=t.equipped?"[SPACE] to unequip":"[SPACE] to equip"),t instanceof c.Usable&&(s="[SPACE] to use");const h=o.Game.measureText(s).width;o.Game.fillText(s,Math.round(.5*(a.GameConstants.WIDTH-h)),5);const l=t.getDescription().split("\n");let d=Math.round(.5*a.GameConstants.HEIGHT-.5*u+(this.rows+this.expansion)*(e+2*i+n)+i+5);l.forEach(t=>{d=this.textWrap(t,5,d,a.GameConstants.WIDTH-10)})}}this.isOpen&&this.drawUsingItem(t,u+1,g+1,n,2,-2),this.drawDraggedItem(t)},this.isPointInInventoryBounds=(t,e)=>{const i=this.isOpen?Math.min(18,18*(Date.now()-this.openTime)/T):18,s=(Math.round(.5*Math.sin(.01*Date.now())+.5),this.cols*(i+4+-2)- -2);let o,r,n;return this.isOpen?(n=(this.rows+this._expansion)*(i+4+-2)- -2,o=Math.round(.5*a.GameConstants.WIDTH-.5*s),r=Math.round(.5*a.GameConstants.HEIGHT-.5*n)):(n=i+4,o=Math.round(.5*a.GameConstants.WIDTH-.5*s),r=Math.round(a.GameConstants.HEIGHT-n-5)),{inBounds:t>=o-1&&t<=o+s+1&&e>=r-1&&e<=r+n+1,startX:o,startY:r}},this.isPointInQuickbarBounds=(t,e)=>{const i=this.isOpen?Math.min(18,18*(Date.now()-this.openTime)/T):18,s=this.cols*(i+4+-2)- -2,o=Math.round(.5*a.GameConstants.WIDTH-.5*s),r=Math.round(a.GameConstants.HEIGHT-(i+4)-5);return{inBounds:t>=o&&t<=o+s&&e>=r&&e<=r+(i+4),startX:o,startY:r}},this.isPointInInventoryButton=(t,e)=>{const i=t/a.GameConstants.TILESIZE,s=e/a.GameConstants.TILESIZE;return i>=this.buttonX&&i<=this.buttonX+1&&s>=this.buttonY&&s<=this.buttonY+1},this.drawInventoryButton=t=>{o.Game.ctx.save(),this.buttonX=a.GameConstants.WIDTH/a.GameConstants.TILESIZE-1.25,this.buttonY=a.GameConstants.HEIGHT/a.GameConstants.TILESIZE-1.25,a.GameConstants.WIDTH<145&&(this.buttonY-=1.25),o.Game.drawFX(0,0,1,1,this.buttonX,this.buttonY,1,1),o.Game.ctx.restore()},this.getInventoryButtonRect=()=>{let t=a.GameConstants.WIDTH/a.GameConstants.TILESIZE-1.25,e=a.GameConstants.HEIGHT/a.GameConstants.TILESIZE-1.25;return a.GameConstants.WIDTH<145&&(e-=1.25),{x:Math.round(t*a.GameConstants.TILESIZE),y:Math.round(e*a.GameConstants.TILESIZE),w:a.GameConstants.TILESIZE,h:a.GameConstants.TILESIZE}},this.getQuickbarStartX=()=>{const t=Math.floor(20*this.cols- -2);return Math.round(.5*a.GameConstants.WIDTH-.5*t)},this.getQuickbarSlotRect=t=>{if(t<0||t>=this.cols)return null;const e=Math.floor(20*this.cols- -2),i=Math.round(.5*a.GameConstants.WIDTH-.5*e),s=Math.floor(a.GameConstants.HEIGHT-22-2);return{x:Math.floor(i+20*t+2),y:Math.floor(s+2),w:Math.floor(18),h:Math.floor(18)}},this.handleMouseDown=(t,e,i)=>{if(!this.player.menu.open&&0===i&&this.isPointInInventoryBounds(t,e).inBounds){const t=this.itemAtSelectedSlot();null!==t&&(this._dragStartItem=t,this._dragStartSlot=this.selX+this.selY*this.cols)}},this.initiateDrag=()=>{null===this._dragStartItem||this._isDragging||(this._isDragging=!0,this.grabbedItem=this._dragStartItem,null!==this._dragStartSlot&&(this.items[this._dragStartSlot]=null))},this.onHoldDetected=()=>{this.initiateDrag()},this.checkForDragStart=()=>{(m.Input.mouseDown&&m.Input.isMouseHold||m.Input.isTapHold)&&this.initiateDrag()},this.handleMouseUp=(t,e,i)=>{if(this.player.menu.open)return;if(0!==i)return;const s=this.isPointInInventoryBounds(t,e),o=this.isPointInQuickbarBounds(t,e);if(this.isOpen?s.inBounds:o.inBounds)if(this._isDragging&&null!==this.grabbedItem){const t=this.selX+this.selY*this.cols;this.placeItemInSlot(t)}else null!==this._dragStartItem&&this.itemUse();else null!==this.grabbedItem&&(this.dropItem(this.grabbedItem,this._dragStartSlot),this.grabbedItem=null,this.items[this._dragStartSlot]=null,this.dragEndTime=Date.now());this._isDragging=!1,this._dragStartItem=null,this._dragStartSlot=null,this.grabbedItem=null},this.placeItemInSlot=t=>{if(null===this.grabbedItem)return;const e=this.items[t];null===e||null!==this._dragStartSlot&&(this.items[this._dragStartSlot]=e),this.items[t]=this.grabbedItem;try{const e=this._dragStartSlot??t,i=t;this.game.replayManager?.recordAction({type:"InventoryMove",fromIndex:e,toIndex:i})}catch{}this.grabbedItem=null},this.globalId=f.IdGenerator.generate("INV"),this.game=t,this.player=e,this.buttonX=(Math.round(a.GameConstants.WIDTH/2)+3)/a.GameConstants.TILESIZE,this.buttonY=10,m.Input.mouseDownListeners.push((t,e,i)=>this.handleMouseDown(t,e,i)),m.Input.mouseUpListeners.push((t,e,i)=>this.handleMouseUp(t,e,i)),m.Input.holdCallback=()=>this.onHoldDetected(),this.items=new Array((this.rows+this._expansion)*this.cols).fill(null),this.equipAnimAmount=new Array((this.rows+this._expansion)*this.cols).fill(0);let i=t=>{null!==t&&(t instanceof r.Equippable&&t.setWielder(this.player),t instanceof l.Weapon&&null===this.weapon&&!t.disabled&&(t.toggleEquip(),this.weapon=t),this.addItem(t))};(a.GameConstants.DEVELOPER_MODE?a.GameConstants.STARTING_DEV_INVENTORY:a.GameConstants.STARTING_INVENTORY).forEach(t=>{i(new t({game:this.game},0,0))}),this.initializedItems=!0}get isDragging(){return this._isDragging}get expansion(){return this._expansion}set expansion(t){if(t!==this._expansion){const e=(this.rows+this._expansion)*this.cols;this._expansion=t;const i=(this.rows+this._expansion)*this.cols;i>e?(this.items.push(...Array(i-e).fill(null)),this.equipAnimAmount.push(...Array(i-e).fill(0))):i<e&&(this.items.length=i,this.equipAnimAmount.length=i)}}expandInventory(t){this.expansion+=t}}},8075:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.BeamEffect=void 0;const s=i(7851),o=i(6291),a=i(8774),r=i(9467),n=i(4804);class h extends a.Projectile{constructor(t,e,i,s,a){super(a,t,e),this.active=!0,this.time=0,this.attachmentInfluence=[],this.drawOnTop=!1,this.alpha=1,this.gravity=h.GRAVITY,this.motionInfluence=h.MOTION_INFLUENCE,this.turbulence=h.TURBULENCE,this.velocityDecay=h.VELOCITY_DECAY,this.angleChange=h.ANGLE_CHANGE,this.maxVelocity=h.MAX_VELOCITY,this.damping=h.DAMPING,this.springStiffness=h.SPRING_STIFFNESS,this.springDamping=h.SPRING_DAMPING,this.iterations=h.ITERATIONS,this.segments=h.SEGMENTS,this.tick=()=>{this.parent.dead&&this.destroy()},this.draw=t=>{this.drawableY=this.y-.01;const e=!0===this.drawOnTop;this.render(this.targetX,this.targetY,this.x,this.y,this.color,2,t,this.compositeOperation,e,!0)},this.drawTopLayer=t=>{this.drawOnTop&&this.render(this.targetX,this.targetY,this.x,this.y,this.color,2,t,this.compositeOperation,!1,!1)};const r=t*o.GameConstants.TILESIZE+.5*o.GameConstants.TILESIZE,n=e*o.GameConstants.TILESIZE+.5*o.GameConstants.TILESIZE,l=i*o.GameConstants.TILESIZE+.5*o.GameConstants.TILESIZE,c=s*o.GameConstants.TILESIZE+.5*o.GameConstants.TILESIZE;this.x=t,this.y=e,this.targetX=i,this.targetY=s,this.points=this.initializePoints(r,n,l,c),this.prevStartX=r,this.prevStartY=n,this.prevEndX=l,this.prevEndY=c,this.color="cyan",this.compositeOperation="source-over"}applyAttachmentControl(t,e,i,s){const a=t?this.startControl:this.endControl;if(!a)return;const r=Math.cos(a.angle),n=Math.sin(a.angle),h=this.clamp01(a.weight??.6),l=a.lengthScale??1,c=(a.influenceDistance??(void 0!==a.influence?a.influence:3))*o.GameConstants.TILESIZE;if(c<=0)return;const d=Math.min(this.points.length-2,Math.max(1,Math.floor(c/Math.max(s,1e-4))));for(let o=1;o<=d;o++){const a=t?o:this.points.length-1-o;if(a<=0||a>=this.points.length-1)continue;const d=s*o,m=Math.min(1,d/c),u=h*Math.pow(1-m,2);if(u<=0)continue;const p=e+r*d*l,y=i+n*d*l;u<=(this.attachmentInfluence[a]??0)||(this.attachmentInfluence[a]=u,this.points[a].x=this.lerp(this.points[a].x,p,u),this.points[a].y=this.lerp(this.points[a].y,y,u))}}clamp01(t){return t<0?0:t>1?1:t}lerp(t,e,i){return t+(e-t)*i}resetAttachmentInfluence(){this.attachmentInfluence.length!==this.points.length?this.attachmentInfluence=new Array(this.points.length).fill(0):this.attachmentInfluence.fill(0)}getBrightnessAt(t,e){if(!this.hostRoom)return 1;const i=Math.floor(t/o.GameConstants.TILESIZE),s=Math.floor(e/o.GameConstants.TILESIZE);let a=this.sampleVisibility(this.hostRoom,i,s);const r=this.hostRoom.roomArray?.[i]?.[s];if(r instanceof n.Door&&r.linkedDoor?.room){const t=r.linkedDoor.room,e=this.sampleVisibility(t,r.linkedDoor.x,r.linkedDoor.y);a=Math.min(a,e)}return 1-a}sampleVisibility(t,e,i){const s=t.softVis?.[e];if(!s)return 1;const o=s[i];return void 0===o?1:Math.max(0,Math.min(1,o))}getColorWithBrightness(t,e,i){const s=this.getColorComponents(t),o=this.clamp01(e);return`rgba(${Math.round(s.r*o)},${Math.round(s.g*o)},${Math.round(s.b*o)},${s.a*i})`}getColorComponents(t){if(this.colorCache&&this.colorCache.source===t)return this.colorCache;let e=135,i=206,s=235,o=1;const a=(t||"").trim().toLowerCase();if(a.startsWith("#")){const t=a.slice(1);3===t.length?(e=parseInt(t[0]+t[0],16),i=parseInt(t[1]+t[1],16),s=parseInt(t[2]+t[2],16)):6!==t.length&&8!==t.length||(e=parseInt(t.slice(0,2),16),i=parseInt(t.slice(2,4),16),s=parseInt(t.slice(4,6),16),8===t.length&&(o=parseInt(t.slice(6,8),16)/255))}else if(a.startsWith("rgba")){const t=a.replace("rgba","").replace("(","").replace(")","").split(",").map(t=>t.trim());e=parseFloat(t[0])||e,i=parseFloat(t[1])||i,s=parseFloat(t[2])||s,o=parseFloat(t[3])||o}else if(a.startsWith("rgb")){const t=a.replace("rgb","").replace("(","").replace(")","").split(",").map(t=>t.trim());e=parseFloat(t[0])||e,i=parseFloat(t[1])||i,s=parseFloat(t[2])||s}return this.colorCache={source:t,r:e,g:i,b:s,a:o},this.colorCache}setPhysics(t,e,i,s,o,a,r,n,l,c,d){this.gravity=t??h.GRAVITY,this.motionInfluence=e??h.MOTION_INFLUENCE,this.turbulence=i??h.TURBULENCE,this.velocityDecay=s??h.VELOCITY_DECAY,this.angleChange=o??h.ANGLE_CHANGE,this.maxVelocity=a??h.MAX_VELOCITY,this.damping=r??h.DAMPING,this.springStiffness=n??h.SPRING_STIFFNESS,this.springDamping=l??h.SPRING_DAMPING,this.iterations=c??h.ITERATIONS,this.segments=d??h.SEGMENTS}setAttachmentControls(t,e){this.startControl=t,this.endControl=e}setHostRoom(t){this.hostRoom=t}setTarget(t,e,i,s){this.x=t,this.y=e,this.targetX=i,this.targetY=s}render(t,e,i,a,r=this.color,n=2,h=1/60,l=this.compositeOperation,c=!1,d=!0){const m=this.x*o.GameConstants.TILESIZE+.5*o.GameConstants.TILESIZE,u=this.y*o.GameConstants.TILESIZE+.5*o.GameConstants.TILESIZE,p=this.targetX*o.GameConstants.TILESIZE+.5*o.GameConstants.TILESIZE,y=this.targetY*o.GameConstants.TILESIZE+.5*o.GameConstants.TILESIZE;if(d){const t=(m-this.prevStartX)*this.motionInfluence*h,e=(u-this.prevStartY)*this.motionInfluence*h,i=(p-this.prevEndX)*this.motionInfluence*h,s=(y-this.prevEndY)*this.motionInfluence*h;for(let i=1;i<4;i++){const s=1-i/4;this.points[i].x+=t*s,this.points[i].y+=e*s}for(let t=this.points.length-4;t<this.points.length-1;t++){const e=1-(this.points.length-t)/4;this.points[t].x+=i*e,this.points[t].y+=s*e}this.simulateRope(m,u,p,y,h)}if(c)return this.prevStartX=m,this.prevStartY=u,this.prevEndX=p,void(this.prevEndY=y);const g=s.Game.ctx;g.save(),s.Game.ctx.globalCompositeOperation=l;for(let t=0;t<this.points.length-1;t++){const e=this.points[t],i=this.points[t+1],s=i.x-e.x,o=i.y-e.y,a=Math.max(Math.abs(s),Math.abs(o)),h=s/a,l=o/a;let c=e.x,d=e.y;for(let t=0;t<=a;t++){const t=this.getBrightnessAt(c,d),e=this.getColorWithBrightness(r,t,this.alpha);for(let t=0;t<n;t++)for(let i=0;i<n;i++)g.fillStyle=e,g.fillRect(Math.round(c+t),Math.round(d+i),1,1);c+=h,d+=l}}g.restore(),this.prevStartX=m,this.prevStartY=u,this.prevEndX=p,this.prevEndY=y}initializePoints(t,e,i,s){const o=[];for(let a=0;a<this.segments;a++){const n=a/(this.segments-1);o.push({x:t+(i-t)*n,y:e+(s-e)*n,oldX:t+(i-t)*n,oldY:e+(s-e)*n,velocityX:0,velocityY:0,angle:r.Random.rand()*Math.PI*2})}return o}applyTurbulence(t,e){t.angle+=Math.sin(.1*this.time+.5*e)*this.angleChange;const i=Math.cos(t.angle)*this.turbulence,s=Math.sin(t.angle)*this.turbulence;t.velocityX+=i,t.velocityY+=s,t.velocityX=Math.min(Math.max(t.velocityX,-this.maxVelocity),this.maxVelocity),t.velocityY=Math.min(Math.max(t.velocityY,-this.maxVelocity),this.maxVelocity)}simulateRope(t,e,i,s,o){const a=Math.ceil(this.iterations*o);for(let o=0;o<a;o++){for(let t=1;t<this.points.length-1;t++){const e=this.points[t],i=this.points[t-1],s=this.points[t+1],o=(i.x-e.x)*this.springStiffness,a=(i.y-e.y)*this.springStiffness,r=(s.x-e.x)*this.springStiffness,n=(s.y-e.y)*this.springStiffness;this.applyTurbulence(e,t),e.velocityX=(e.velocityX+o+r)*this.damping,e.velocityY=(e.velocityY+a+n)*this.damping;const h=i.velocityX-e.velocityX,l=i.velocityY-e.velocityY,c=s.velocityX-e.velocityX,d=s.velocityY-e.velocityY;e.velocityX+=(h+c)*this.springDamping,e.velocityY+=(l+d)*this.springDamping,e.oldX=e.x,e.oldY=e.y,e.x+=e.velocityX,e.y+=e.velocityY+this.gravity}const o=Math.sqrt(Math.pow(i-t,2)+Math.pow(s-e,2))/(this.segments-1);this.resetAttachmentInfluence(),this.applyAttachmentControl(!0,t,e,o),this.applyAttachmentControl(!1,i,s,o);for(let t=0;t<2;t++)for(let t=0;t<this.points.length-1;t++){const e=this.points[t],i=this.points[t+1],s=i.x-e.x,a=i.y-e.y,r=Math.sqrt(s*s+a*a),n=(o-r)/r/2,h=s*n,l=a*n;t>0&&(e.x-=1.5*h,e.y-=1.5*l),t<this.points.length-2&&(i.x+=1.5*h,i.y+=1.5*l)}}this.points[0].x=t,this.points[0].y=e,this.points[0].oldX=t,this.points[0].oldY=e,this.points[this.points.length-1].x=i,this.points[this.points.length-1].y=s,this.points[this.points.length-1].oldX=i,this.points[this.points.length-1].oldY=s}static renderBeam(t,e,i,a,r="cyan",n=2,h=1){const l=s.Game.ctx;l.globalAlpha=h;const c=t*o.GameConstants.TILESIZE+.5*o.GameConstants.TILESIZE,d=e*o.GameConstants.TILESIZE+.5*o.GameConstants.TILESIZE,m=i*o.GameConstants.TILESIZE+.5*o.GameConstants.TILESIZE,u=a*o.GameConstants.TILESIZE+.5*o.GameConstants.TILESIZE;l.save(),l.beginPath(),l.moveTo(c,d),l.lineTo(m,u),l.lineWidth=n,l.strokeStyle=r,l.stroke(),l.restore()}destroy(){this.active=!1,this.points=[],this.dead=!0}isActive(){return this.active}}e.BeamEffect=h,h.SEGMENTS=30,h.GRAVITY=2,h.ITERATIONS=5,h.MOTION_INFLUENCE=1,h.TURBULENCE=.5,h.VELOCITY_DECAY=.1,h.ANGLE_CHANGE=.01,h.MAX_VELOCITY=100,h.DAMPING=.8,h.SPRING_STIFFNESS=.01,h.SPRING_DAMPING=.1},8089:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.LinkButton=void 0;const s=i(1285),o=i(7851),a=i(2614);class r extends a.guiButton{constructor({text:t,linkUrl:e,x:i,y:s}){super(i,s,o.Game.measureText(t).width+10,16,t,()=>window.open(e,"_blank","noopener,noreferrer"),!1)}draw(){o.Game.ctx.save(),o.Game.ctx.imageSmoothingEnabled=!1,o.Game.ctx.fillStyle="rgba(100, 100, 100, 0.8)",o.Game.ctx.fillRect(Math.round(this.x),Math.round(this.y),Math.round(this.width),Math.round(this.height)),o.Game.ctx.fillStyle=s.LevelConstants.LEVEL_TEXT_COLOR,o.Game.ctx.lineWidth=1,o.Game.ctx.strokeRect(Math.round(this.x),Math.round(this.y),Math.round(this.width),Math.round(this.height)),o.Game.ctx.fillStyle="rgba(255, 255, 255, 1)";const t=o.Game.measureText(this.text).width,e=this.x+(this.width-t)/2,i=this.y+this.height/2-o.Game.letter_height/2;o.Game.ctx.fillStyle=s.LevelConstants.LEVEL_TEXT_COLOR,o.Game.fillText(this.text,Math.round(e),Math.round(i)),o.Game.ctx.restore()}}e.LinkButton=r},8132:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Tile=e.SkinType=void 0;const s=i(8160),o=i(6291),a=i(5947);var r;(r=e.SkinType||(e.SkinType={}))[r.DUNGEON=0]="DUNGEON",r[r.CAVE=1]="CAVE",r[r.FOREST=2]="FOREST",r[r.CASTLE=3]="CASTLE",r[r.GLACIER=4]="GLACIER",r[r.DARK_CASTLE=5]="DARK_CASTLE",r[r.PLACEHOLDER=6]="PLACEHOLDER",r[r.DESERT=7]="DESERT",r[r.MAGMA_CAVE=8]="MAGMA_CAVE",r[r.DARK_DUNGEON=9]="DARK_DUNGEON",r[r.TUTORIAL=10]="TUTORIAL",r[r.FLOODED_CAVE=11]="FLOODED_CAVE";class n extends s.Drawable{constructor(t,e,i,s=0){super(),this.name="",this.getName=()=>this.name,this.hasPlayer=t=>t.x===this.x&&t.y===this.y,this.shadeAmount=(t=0,e=0,i=!0)=>o.GameConstants.SMOOTH_LIGHTING&&i?0:this.room.softVis[this.x+t][this.y+e],this.isSolid=()=>!1,this.canCrushEnemy=()=>!1,this.isOpaque=()=>!1,this.onCollide=t=>{},this.onCollideEnemy=t=>{},this.tick=()=>{},this.tickEnd=()=>{},this.draw=t=>{},this.drawUnderPlayer=t=>{},this.drawAbovePlayer=t=>{},this.drawAboveShading=t=>{},this.globalId=a.IdGenerator.generate("T"),this.skin=t.skin,this.room=t,this.x=e,this.y=i,this.z=s,this.drawableY=i,this.isDoor=!1,this.opacity=1}}e.Tile=n},8149:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Candle=void 0;const s=i(1650);class o extends s.Light{constructor(t,e,i){super(t,e,i),this.fuel=100,this.tileX=27,this.tileY=0,this.name="candle",this.fuelCap=100,this.radius=4,this.stackable=!0,this.maxBrightness=2,this.maxBrightness=.25,this.fov=360}}e.Candle=o,o.itemName="candle"},8160:(t,e)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Drawable=void 0,e.Drawable=class{constructor(){this.drawableY=0,this.x=0,this.y=0,this.shouldDrawAbovePlayer=!1,this.draw=t=>{},this.hasBloom=!1,this.bloomColor="#FFFFFF",this.bloomAlpha=1,this.softBloomAlpha=0,this.bloomOffsetY=0,this.updateBloom=t=>{if(this.hasBloom){let e=this.softBloomAlpha-this.bloomAlpha;Math.abs(e)>.001?this.softBloomAlpha=this.softBloomAlpha-.1*e*t:this.softBloomAlpha=this.bloomAlpha}else this.softBloomAlpha=0}}}},8191:(t,e)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.CameraAnimation=void 0,e.CameraAnimation=class{constructor(t,e,i,s,o,a){this.x=t,this.y=e,this.duration=i,this.speed=s,this.frame=o,this.active=a,this.x=t,this.y=e,this.speed=s,this.frame=0,this.active=!1,this.fast=!1}}},8200:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.CrabEnemy=void 0;const s=i(7851),o=i(7455),a=i(6291),r=i(6986);class n extends r.Enemy{constructor(t,e,i,r,n){super(t,e,i,r),this.hit=()=>this.damage,this.behavior=()=>{if(this.lastX=this.x,this.lastY=this.y,!this.dead){if(this.handleSkipTurns())return;if(this.seenPlayer){if(this.seenPlayer){if(this.room.playerTicked===this.targetPlayer)if(this.alertTicks=Math.max(0,this.alertTicks-1),this.ticks++,this.ticks%2==1){this.rumbling=!0;let t=this.x,e=this.y,i=Array();for(const t of this.room.entities)t!==this&&i.push({x:t.x,y:t.y});for(let t=this.x-1;t<=this.x+1;t++)for(let e=this.y-1;e<=this.y+1;e++)this.room.roomArray[t][e]instanceof o.SpikeTrap&&this.room.roomArray[t][e].on&&i.push({x:t,y:e});let a=[];for(let t=0;t<this.room.roomX+this.room.width;t++){a[t]=[];for(let e=0;e<this.room.roomY+this.room.height;e++)this.room.roomArray[t]&&this.room.roomArray[t][e]?a[t][e]=this.room.roomArray[t][e]:a[t][e]=!1}this.target=this.getAverageLuminance()>0?this.targetPlayer:this.room.getExtremeLuminanceFromPoint(this.x,this.y).darkest;const r=this.searchPathLocalized(this.target,i,{useLastPlayerPos:!0,allowOmni:!0});if(r.length>0){let i=!1;for(const t in this.game.players)this.game.rooms[this.game.players[t].levelID]===this.room&&this.game.players[t].x===r[0].pos.x&&this.game.players[t].y===r[0].pos.y&&(this.game.players[t].hurt(this.hit(),this.name),this.drawX=.5*(this.x-this.game.players[t].x),this.drawY=.5*(this.y-this.game.players[t].y),this.game.players[t]===this.game.players[this.game.localPlayerID]&&this.game.shakeScreen(10*this.drawX,10*this.drawY),i=!0);i||(this.tryMove(r[0].pos.x,r[0].pos.y),this.setDrawXY(t,e),this.x>t?this.direction=s.Direction.RIGHT:this.x<t?this.direction=s.Direction.LEFT:this.y>e?this.direction=s.Direction.DOWN:this.y<e&&(this.direction=s.Direction.UP))}this.rumbling=!1,this.unconscious=!0}else this.rumbling=!0,this.unconscious=!1,this.makeHitWarnings();let t=-1!==Object.values(this.game.offlinePlayers).indexOf(this.targetPlayer);if(!this.aggro||t){let e=this.nearestPlayer();if(!1!==e){let[i,s]=e;i<=4&&(t||i<this.playerDistance(this.targetPlayer))&&s!==this.targetPlayer&&(this.targetPlayer=s,this.facePlayer(s),s===this.game.players[this.game.localPlayerID]&&(this.alertTicks=1),this.ticks%2==0&&this.makeHitWarnings())}}}}else this.lookForPlayer()}},this.draw=t=>{if(!this.dead){if(s.Game.ctx.save(),s.Game.ctx.globalAlpha=this.alpha,!this.dead){this.updateDrawXY(t),this.ticks%2==0?(this.tileX=9,this.tileY=4):(this.tileX=8,this.tileY=4);let e=this.rumble(this.rumbling,this.frame,this.direction).x,i=this.rumble(this.rumbling,this.frame,this.direction).y;this.frame+=.1*t,this.frame>=4&&(this.frame=0),this.hasShadow&&this.drawShadow(t),s.Game.drawMob(this.tileX,this.tileY+this.direction,1,1,this.x-this.drawX+e,this.y-this.drawYOffset-this.drawY+i,1*this.crushX,1*this.crushY,this.softShadeColor,this.shadeAmount(),void 0,this.outlineColor(),this.outlineOpacity()),this.crushed&&this.crushAnim(t)}this.cloned||(this.seenPlayer||this.drawSleepingZs(t,0,.75*a.GameConstants.TILESIZE),this.alertTicks>0&&this.drawExclamation(t,0,.75*a.GameConstants.TILESIZE)),s.Game.ctx.restore()}},this.ticks=0,this.frame=0,this.health=1,this.maxHealth=1,this.defaultMaxHealth=1,this.tileX=8,this.tileY=4,this.seenPlayer=!1,this.aggro=!1,this.name="crab",this.orthogonalAttack=!0,this.imageParticleX=3,this.imageParticleY=24,this.baseDamage=.5,this.drawYOffset=.25,this.getDrop(["weapon","equipment","consumable","tool","coin"])}get alertText(){return`New Enemy Spotted: Crab \n    Health: ${this.health}\n    Attack Pattern: Omnidirectional\n    Moves every other turn`}}e.CrabEnemy=n,n.difficulty=1,n.tileX=8,n.tileY=4},8243:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Spear=void 0;const s=i(4052);class o extends s.Weapon{constructor(t,e,i){super(t,e,i),this.weaponMove=(t,e)=>{let i=2*t-this.wielder.x,s=2*e-this.wielder.y,o=!1;if(this.getEntitiesAt(t,e).filter(t=>t.pushable).length>0)return!0;const a=this.getEntitiesAt(t,e),r=this.getEntitiesAt(i,s),n=a.filter(t=>!t.pushable&&!t.isEnemy);if(n.length>0){for(const t of n)this.attack(t,this.damage+this.wielder.damageBonus);return this.hitSound(),this.attackAnimation(t,e),this.game.rooms[this.wielder.levelID].tick(this.wielder),this.shakeScreen(t,e),this.degrade(),!1}this.beginSwing();const h=a.filter(t=>!t.pushable&&t.isEnemy);if(h.length>0){for(const t of h)this.attack(t,this.damage+this.wielder.damageBonus);o=!0}if(this.game.rooms[this.wielder.levelID].roomArray[i]&&this.game.rooms[this.wielder.levelID].roomArray[i][s]&&!this.game.rooms[this.wielder.levelID].roomArray[i][s].isSolid()){const t=r.filter(t=>!t.pushable&&t.isEnemy);if(t.length>0){for(const e of t)this.attack(e,this.damage+this.wielder.damageBonus);o=!0}}return o&&(this.hitSound(),this.attackAnimation(i,s),this.game.rooms[this.wielder.levelID].tick(this.wielder),this.shakeScreen(i,s),this.degrade()),this.endSwing(),!o},this.tileX=24,this.tileY=0,this.name="spear",this.description="Hits enemies in front of you within a range of 2 tiles.",this.iconOffset=.1,this.offsetY=-.25,this.useCost=1,this.degradeable=!1}}e.Spear=o,o.itemName="spear"},8287:(t,e)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.GameplaySettings=void 0;class i{}e.GameplaySettings=i,i.LEGACY_MINIMAP=!1,i.STARTING_HEALTH=2,i.LIMIT_ENEMY_TYPES=!0,i.MEDIAN_ROOM_DENSITY=.25,i.UNLIMITED_SPAWNERS=!0,i.THROTTLE_SPAWNERS=!0,i.NO_ENEMIES=!1,i.EQUIP_USES_TURN=!1,i.UNBREAKABLE_ITEMGROUP_LOOT=!1,i.PRESET_BOSSES=!1,i.PNG_LEVEL_PROBABILITY=.1,i.TUTORIAL_ENABLED=!1,i.MAXIMUM_ENEMY_INTERACTION_DISTANCE=30,i.OXYGEN_LINE_MAX_LENGTH=25,i.ORGANIC_TUNNELS_ENABLED=!0,i.ORGANIC_TUNNELS_FORCE=!1,i.ORGANIC_TUNNELS_DEBUG=!0,i.ORGANIC_TUNNELS_SPOOF_ENABLED=!0,i.ORGANIC_TUNNELS_SPOOF_PER_WALL_MIN=1,i.ORGANIC_TUNNELS_SPOOF_PER_WALL_MAX=2,i.ORGANIC_TUNNELS_SPOOF_EDGE_MARGIN=2,i.ORGANIC_TUNNELS_PATH_MODE="linear",i.ORGANIC_TUNNELS_AVOID_CENTER_DEFAULT=!0,i.LIGHTING_DEBUG=!0,i.MAIN_PATH_BRANCHING=.1,i.MAIN_PATH_LOOPINESS=.05,i.BASE_ENEMY_ALERT_RANGE=4,i.BASE_ENEMY_ALERT_NEARBY_RANGE=2,i.NEW_ENEMIES_PER_LEVEL=2,i.ENEMY_TYPES_BASE_COUNT=4,i.DEPTH_ZERO_ENEMY_TYPES=3,i.SPAWNER_MIN_DEPTH=0,i.OCCULTIST_MIN_DEPTH=1,i.SPAWNER_SPAWN_CHANCE=.1,i.OCCULTIST_SPAWN_CHANCE=.1,i.SPAWNER_AREA_THRESHOLD=50,i.OCCULTIST_AREA_THRESHOLD=200,i.ENEMY_DENSITY_DEPTH_MULTIPLIER=.04,i.ENEMY_DENSITY_DEPTH_OFFSET=2,i.MAX_ENEMY_DENSITY=.25,i.FOREST_ENEMY_REDUCTION=.25,i.MAX_OCCULTIST_SHIELDS=7,i.MAX_EXALTER_BUFFS=7},8323:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.GlowBugEnemy=void 0;const s=i(7851),o=i(6291),a=i(7834),r=i(2103),n=i(606);class h extends n.Entity{constructor(t,e,i,n,h){super(t,e,i,n),this.hit=()=>.5,this.behavior=()=>{if(this.lastX=this.x,this.lastY=this.y,this.seenPlayer=!0,this.aggro=!0,!this.dead){if(this.skipNextTurns>0)return void this.skipNextTurns--;this.wander(),this.lightSource.x=this.x+.5,this.lightSource.y=this.y+.5,this.room.updateLighting({x:this.x,y:this.y})}},this.draw=t=>{this.dead||(s.Game.ctx.save(),s.Game.ctx.globalAlpha=this.alpha,this.dead||(this.updateDrawXY(t),this.frame+=.15*t,this.frame>=4&&(this.frame=0),this.tileX=8+this.frame,this.hasShadow&&this.drawShadow(t),s.Game.drawMob(Math.floor(this.tileX),this.tileY,1,1,this.x-this.drawX,this.y-this.drawYOffset-this.drawY,1,1,this.softShadeColor,this.shadeAmount(),void 0,this.outlineColor(),this.outlineOpacity()),this.crushed&&this.crushAnim(t)),this.cloned||(this.seenPlayer||this.drawSleepingZs(t,0,.75*o.GameConstants.TILESIZE),this.alertTicks>0&&this.drawExclamation(t,0,.75*o.GameConstants.TILESIZE)),s.Game.ctx.restore())},this.ticks=0,this.frame=0,this.health=1,this.maxHealth=1,this.defaultMaxHealth=1,this.tileX=8,this.tileY=0,this.seenPlayer=!1,this.aggro=!1,this.name="glowbug",this.orthogonalAttack=!0,this.imageParticleX=3,this.imageParticleY=24,this.drawYOffset=1,this.hasShadow=!0,this.hasHitParticles=!1,this.hasDamageNumbers=!1,this.hasBloom=!0,this.bloomAlpha=1,this.bloomColor="#054B4B",this.lightSource=new r.LightSource(this.x+.5,this.y+.5,6,[5,75,75]),this.addLightSource(this.lightSource),this.drops=[new a.GlowBugs(this.room,this.x,this.y)]}get alertText(){return`New Enemy Spotted: Crab \n    Health: ${this.health}\n    Attack Pattern: Omnidirectional\n    Moves every other turn`}}e.GlowBugEnemy=h,h.difficulty=1,h.tileX=8,h.tileY=4},8330:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.EnemySpawnAnimation=void 0;const s=i(8774),o=i(7851),a=i(7366),r=i(369),n=i(2103);class h extends s.Projectile{constructor(t,e,i,s){super(e,i,s),this.ANIM_COUNT=3,this.tick=()=>{this.room===this.room.game.room&&a.Sound.enemySpawn();let t=!1;for(const e in this.room.game.players)this.room.game.players[e].x===this.x&&this.room.game.players[e].y===this.y&&(this.room.game.players[e].hurt(.5,"reaper"),t=!0);t?this.room.hitwarnings.push(new r.HitWarning(this.room.game,this.x,this.y,this.x,this.y)):(this.dead=!0,this.enemy.skipNextTurns=1,this.room.entities.push(this.enemy),this.enemy.createHitParticles(),this.lightSource.dead=!0)},this.drawTopLayer=t=>{if(!this.dead){this.frame+=.25*t,this.frame>=8&&(this.frame=0);for(let t=0;t<this.ANIM_COUNT;t++){let t=0;o.Game.drawFX(Math.floor(this.frame),27,1,1,this.x+Math.round(t)/16,this.y-.5,1,1)}}},this.room=t,this.enemy=e,this.frame=0,this.hasBloom=!0,this.bloomColor="#00BFFF",this.bloomOffsetY=-.5,this.lightSource=new n.LightSource(this.x+.5,this.y+.5,1,[0,50,150],1),this.room.lightSources.push(this.lightSource),this.room.updateLighting({x:this.x,y:this.y})}}e.EnemySpawnAnimation=h},8363:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.BeetleEnemy=void 0;const s=i(7851),o=i(7455),a=i(6291),r=i(6986),n=i(6199),h=i(369);class l extends r.Enemy{constructor(t,e,i,r,l){super(t,e,i,r),this.hit=()=>this.damage,this.toggleReveal=()=>{this.ticks,this.revealTick,this.revealTick=this.ticks},this.jump=t=>{let e=Math.max(Math.abs(this.drawX),Math.abs(this.drawY));e>2?this.jumpDistance=3:e>1&&(this.jumpDistance=2),this.jumpY=Math.sin(e/this.jumpDistance*Math.PI)*this.jumpHeight,this.jumpY<.01&&this.jumpY>-.01&&(this.jumpY=0,this.jumpDistance=1),this.jumpY>this.jumpHeight&&(this.jumpY=this.jumpHeight)},this.isTileFree=(t,e)=>{if(!this.room.roomArray[t]||!this.room.roomArray[t][e])return!1;const i=this.room.roomArray[t][e];if(i.isSolid())return!1;if(i instanceof o.SpikeTrap&&i.on)return!1;for(const i of this.room.entities)if(i!==this&&i.x===t&&i.y===e)return!1;return!0},this.getTwoTileCandidates=(t,e)=>{const i=[{dx:1,dy:0,axis:"x"},{dx:-1,dy:0,axis:"x"},{dx:0,dy:1,axis:"y"},{dx:0,dy:-1,axis:"y"}],s=[];for(const o of i){const i=t+o.dx,a=e+o.dy,r=t+2*o.dx,n=e+2*o.dy;this.isTileFree(i,a)&&this.isTileFree(r,n)&&s.push({endX:r,endY:n,axis:o.axis,dx:o.dx,dy:o.dy})}return s},this.getThreeTileCandidates=(t,e)=>{const i=[{dx:1,dy:0,axis:"x"},{dx:-1,dy:0,axis:"x"},{dx:0,dy:1,axis:"y"},{dx:0,dy:-1,axis:"y"}],s=[];for(const o of i){const i=t+o.dx,a=e+o.dy,r=t+2*o.dx,n=e+2*o.dy,h=t+3*o.dx,l=e+3*o.dy;this.isTileFree(i,a)&&this.isTileFree(r,n)&&this.isTileFree(h,l)&&s.push({endX:h,endY:l,axis:o.axis,dx:o.dx,dy:o.dy})}return s},this.pickBestCandidate=(t,e,i,s,o,a)=>{const r=0===o?0:o>0?1:-1,n=0===a?0:a>0?1:-1;return t.sort((t,o)=>{const a=Math.abs(t.endX-e)+Math.abs(t.endY-i),h=Math.abs(o.endX-e)+Math.abs(o.endY-i);if(a!==h)return a-h;if(s){if(t.axis!==o.axis)return"x"===t.axis?-1:1}else if(t.axis!==o.axis)return"y"===t.axis?-1:1;const l=(0!==t.dx?t.dx===r:t.dy===n)?-1:1,c=(0!==o.dx?o.dx===r:o.dy===n)?-1:1;return l!==c?l-c:0}),t[0]},this.getOneTileCandidates=(t,e)=>{const i=[{dx:1,dy:0},{dx:-1,dy:0},{dx:0,dy:1},{dx:0,dy:-1}],s=[];for(const o of i){const i=t+o.dx,a=e+o.dy;this.isTileFree(i,a)&&s.push({x:i,y:a})}return s},this.pickBestOneTileCandidate=(t,e,i,s,o,a)=>(t.sort((t,r)=>{const n=Math.abs(t.x-e)+Math.abs(t.y-i),h=Math.abs(r.x-e)+Math.abs(r.y-i);if(n!==h)return n-h;const l=Math.abs(t.x-e)>Math.abs(t.y-i)?"x":"y",c=Math.abs(r.x-e)>Math.abs(r.y-i)?"x":"y";if(s){if(l!==c)return"x"===l?-1:1}else if(l!==c)return"y"===l?-1:1;const d=(t.x>e?o<0:t.x<e?o>0:t.y>i?a<0:t.y<i&&a>0)?-1:1,m=(r.x>e?o<0:r.x<e?o>0:r.y>i?a<0:r.y<i&&a>0)?-1:1;return d!==m?d-m:0}),t[0]),this.attackOrMoveTo=(t,e,i,o)=>{const a=Math.abs(t-i)+Math.abs(e-o);let r=!1;for(const i in this.game.players)this.game.rooms[this.game.players[i].levelID]===this.room&&this.game.players[i].x===t&&this.game.players[i].y===e&&(a>=2&&a<=3&&(this.game.players[i].hurt(this.hit(),this.name),this.drawX=.5*(this.x-this.game.players[i].x),this.drawY=.5*(this.y-this.game.players[i].y),this.game.players[i]===this.game.players[this.game.localPlayerID]&&this.game.shakeScreen(10*this.drawX,10*this.drawY)),r=!0);r||(this.tryMove(t,e),this.setDrawXY(i,o),this.x>i?this.direction=s.Direction.RIGHT:this.x<i?this.direction=s.Direction.LEFT:this.y>o?this.direction=s.Direction.DOWN:this.y<o&&(this.direction=s.Direction.UP))},this.behavior=()=>{if(this.lastX=this.x,this.lastY=this.y,!this.dead){if(this.handleSkipTurns())return;if(this.seenPlayer){if(this.seenPlayer){if(this.room.playerTicked===this.targetPlayer)if(this.alertTicks=Math.max(0,this.alertTicks-1),this.ticks++,this.ticks%2==1){this.rumbling=!0;let t=this.x,e=this.y,i=Array();for(const t of this.room.entities)t!==this&&i.push({x:t.x,y:t.y});for(let t=this.x-1;t<=this.x+1;t++)for(let e=this.y-1;e<=this.y+1;e++)this.room.roomArray[t][e]instanceof o.SpikeTrap&&this.room.roomArray[t][e].on&&i.push({x:t,y:e});this.target=this.getAverageLuminance()>0?this.targetPlayer:this.room.getExtremeLuminanceFromPoint(this.x,this.y).darkest;let s={x:this.targetPlayer.x,y:this.targetPlayer.y};const a=Math.abs(this.targetPlayer.x-this.x)+Math.abs(this.targetPlayer.y-this.y);if(this.target===this.targetPlayer&&2===a){let t=this.targetPlayer.lastX-this.x,e=this.targetPlayer.lastY-this.y;if(0!==t&&0!==e&&(Math.abs(t)>=Math.abs(e)?e=0:t=0),0===t&&Math.abs(e)<=1||0===e&&Math.abs(t)<=1){const i=this.targetPlayer.x+Math.sign(t),o=this.targetPlayer.y+Math.sign(e);this.room.roomArray[i]&&this.room.roomArray[i][o]&&!this.room.roomArray[i][o].isSolid()&&(s={x:i,y:o})}}else this.target!==this.targetPlayer&&(s={x:this.target.x,y:this.target.y});const r=s.x-t,n=s.y-e,h=Math.abs(r)>=Math.abs(n);let l=this.x,c=this.y;const d=this.searchPathLocalized(s,i,{useLastPlayerPos:!0,allowOmni:!1});if(d.length>0){let i=d[0];const s=d[1],o=d[2];if(o){const s=o.pos.x===t||o.pos.y===e,a=h?o.pos.y===e:o.pos.x===t;s&&a&&(i=o)}else if(s){const o=s.pos.x===t||s.pos.y===e,a=h?s.pos.y===e:s.pos.x===t;o&&a&&(i=s)}l=i.pos.x,c=i.pos.y;const a=Math.abs(l-t)+Math.abs(c-e);if(1===a||2===a){const i=l-t,s=c-e,o=l+(0!==i?Math.sign(i):0),a=c+(0!==s?Math.sign(s):0);this.isTileFree(o,a)&&(l=o,c=a)}}if(a<=1)if(Math.abs(l-t)+Math.abs(c-e)>=2)this.attackOrMoveTo(l,c,t,e);else{const i=this.getTwoTileCandidates(t,e);if(i.length>0){const o=this.pickBestCandidate(i,s.x,s.y,h,r,n);this.attackOrMoveTo(o.endX,o.endY,t,e)}else{const i=this.getOneTileCandidates(t,e);if(i.length>0){const o=this.pickBestOneTileCandidate(i,s.x,s.y,h,r,n);this.attackOrMoveTo(o.x,o.y,t,e)}}}else if(Math.abs(l-t)+Math.abs(c-e)>=1)this.attackOrMoveTo(l,c,t,e);else{const i=this.getThreeTileCandidates(t,e);if(i.length>0){const o=this.pickBestCandidate(i,s.x,s.y,h,r,n);this.attackOrMoveTo(o.endX,o.endY,t,e)}else{const i=this.getTwoTileCandidates(t,e);if(i.length>0){const o=this.pickBestCandidate(i,s.x,s.y,h,r,n);this.attackOrMoveTo(o.endX,o.endY,t,e)}else{const i=this.getOneTileCandidates(t,e);if(i.length>0){const o=this.pickBestOneTileCandidate(i,s.x,s.y,h,r,n);this.attackOrMoveTo(o.x,o.y,t,e)}}}}this.rumbling=!1,this.unconscious=!0}else this.rumbling=!0,this.unconscious=!1,this.makeHitWarnings();let t=-1!==Object.values(this.game.offlinePlayers).indexOf(this.targetPlayer);if(!this.aggro||t){let e=this.nearestPlayer();if(!1!==e){let[i,s]=e;i<=4&&(t||i<this.playerDistance(this.targetPlayer))&&s!==this.targetPlayer&&(this.targetPlayer=s,this.facePlayer(s),s===this.game.players[this.game.localPlayerID]&&(this.alertTicks=1),this.ticks%2==0&&this.makeHitWarnings())}}}}else this.lookForPlayer()}},this.makeHitWarnings=()=>{if(this.unconscious)return;const t=this.getPlayer(),e=this.orthogonalAttack,i=this.diagonalAttack,o=this.forwardOnlyAttack,a=this.direction,r=this.attackRange,l=this.diagonalAttackRange,c=(t,e)=>(t?[[-3,0],[3,0],[0,-3],[0,3],[-2,0],[2,0],[0,-2],[0,2]]:[[-1,-1],[1,1],[1,-1],[-1,1]]).flatMap(([t,i])=>Array.from({length:e},(e,s)=>[(s+1)*t,(s+1)*i])),d={[s.Direction.LEFT]:[-1,0],[s.Direction.RIGHT]:[1,0],[s.Direction.UP]:[0,-1],[s.Direction.DOWN]:[0,1]};let m=[];if(o){const[t,e]=d[a];m=Array.from({length:r},(i,s)=>[(s+1)*t,(s+1)*e])}else e&&m.push(...c(!0,r)),i&&m.push(...c(!1,l));const u=m.map(([e,i])=>({x:e,y:i,distance:n.Utils.distance(e,i,t.x-this.x,t.y-this.y)})).sort((t,e)=>t.distance-e.distance),p=Math.ceil(.75*u.length);u.slice(0,p).forEach(({x:t,y:e})=>{const i=this.x+t,s=this.y+e;if(this.isWithinRoomBounds(i,s)){const t=new h.HitWarning(this.game,i,s,this.x,this.y,!0,!1,this);this.room.hitwarnings.push(t)}})},this.draw=t=>{if(!this.dead){if(s.Game.ctx.save(),s.Game.ctx.globalAlpha=this.alpha,!this.dead){switch(this.updateDrawXY(t),this.ticks,this.tileX=13,this.tileY=4,this.direction){case s.Direction.UP:case s.Direction.LEFT:case s.Direction.RIGHT:}let e=Math.max(this.rumble(this.rumbling,this.frame,this.direction).x,Math.max(this.rumble(this.rumbling,this.frame,this.direction).y));this.frame+=.1*t,this.frame>=4&&(this.frame=0),this.hasShadow&&this.drawShadow(t),s.Game.drawMob(this.tileX,this.tileY,2,2,this.x-this.drawX+e-.5,this.y-this.drawYOffset-this.drawY-this.jumpY,2*this.crushX,2*this.crushY,this.softShadeColor,this.shadeAmount(),void 0,this.outlineColor(),this.outlineOpacity()),this.crushed&&this.crushAnim(t)}this.cloned||(this.seenPlayer||this.drawSleepingZs(t,0,.75*a.GameConstants.TILESIZE),this.alertTicks>0&&this.drawExclamation(t,0,.75*a.GameConstants.TILESIZE)),s.Game.ctx.restore()}},this.ticks=0,this.frame=0,this.health=1,this.maxHealth=1,this.defaultMaxHealth=1,this.tileX=13,this.tileY=4,this.seenPlayer=!1,this.aggro=!1,this.name="beetle",this.orthogonalAttack=!0,this.diagonalAttack=!1,this.imageParticleX=3,this.imageParticleY=24,this.drawYOffset=1.2,this.revealTick=0,this.hasShadow=!0,this.jumpHeight=1,this.jumpDistance=1,this.attackRange=1,this.getDrop(["weapon","equipment","consumable","tool","coin"])}get alertText(){return`New Enemy Spotted: Beetle \n    Health: ${this.health}\n    Attack Pattern: Omnidirectional\n    Moves every other turn`}}e.BeetleEnemy=l,l.difficulty=1,l.tileX=8,l.tileY=4},8480:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.BigZombieEnemy=void 0;const s=i(7851),o=i(9467),a=i(7455),r=i(6986);class n extends r.Enemy{constructor(t,e,i,r,n){super(t,e,i,r),this.hit=()=>this.damage,this.bleed=()=>{},this.poison=()=>{},this.behavior=()=>{if(this.lastX=this.x,this.lastY=this.y,!this.dead){if(this.handleSkipTurns())return;if(this.ticks++,this.seenPlayer){if(this.seenPlayer){if(this.room.playerTicked===this.targetPlayer){this.alertTicks=Math.max(0,this.alertTicks-1);let t=this.x,e=this.y;const i=this.targetPlayer,o=i.y>=this.y&&i.y<this.y+this.h,r=i.x>=this.x&&i.x<this.x+this.w;if(o!==r){let t=this.direction;if(o?t=i.x<this.x?s.Direction.LEFT:s.Direction.RIGHT:r&&(t=i.y<this.y?s.Direction.UP:s.Direction.DOWN),t!==this.direction)return this.direction=t,this.makeBigHitWarnings(),void this.ticks++}let n=Array();for(const t of this.room.entities)if(t!==this)for(let e=0;e<t.w;e++)for(let i=0;i<t.h;i++)n.push({x:t.x+e,y:t.y+i});for(let t=this.x-1;t<=this.x+this.w;t++)for(let e=this.y-1;e<=this.y+this.h;e++)this.room.roomArray[t]&&this.room.roomArray[t][e]&&this.room.roomArray[t][e]instanceof a.SpikeTrap&&this.room.roomArray[t][e].on&&n.push({x:t,y:e});const h=this.searchPathLocalized(this.targetPlayer,n);if(h.length>0){let i=h[0].pos.x,o=h[0].pos.y,a=this.direction;if(this.targetPlayer,i>t?this.direction=s.Direction.RIGHT:i<t?this.direction=s.Direction.LEFT:o>e?this.direction=s.Direction.DOWN:o<e&&(this.direction=s.Direction.UP),a==this.direction){let a=!1;for(const t in this.game.players)if(this.game.rooms[this.game.players[t].levelID]===this.room){let e=!1;for(let s=0;s<this.w;s++){for(let a=0;a<this.h;a++)if(this.game.players[t].x===i+s&&this.game.players[t].y===o+a){e=!0;break}if(e)break}e&&(this.game.players[t].hurt(this.hit(),this.name),this.drawX=.5*(this.x-this.game.players[t].x),this.drawY=.5*(this.y-this.game.players[t].y),this.game.players[t]===this.game.players[this.game.localPlayerID]&&this.game.shakeScreen(10*this.drawX,10*this.drawY),a=!0)}a||(this.tryMove(i,o),this.setDrawXY(t,e),this.x>t?this.direction=s.Direction.RIGHT:this.x<t?this.direction=s.Direction.LEFT:this.y>e?this.direction=s.Direction.DOWN:this.y<e&&(this.direction=s.Direction.UP))}}else this.facePlayer(this.targetPlayer);this.direction==s.Direction.LEFT&&(n.push({x:this.x,y:this.y+1}),n.push({x:this.x,y:this.y-1})),this.direction==s.Direction.RIGHT&&(n.push({x:this.x,y:this.y+1}),n.push({x:this.x,y:this.y-1})),this.direction==s.Direction.DOWN&&(n.push({x:this.x+1,y:this.y}),n.push({x:this.x-1,y:this.y})),this.direction==s.Direction.UP&&(n.push({x:this.x+1,y:this.y}),n.push({x:this.x-1,y:this.y})),this.makeBigHitWarnings()}let t=-1!==Object.values(this.game.offlinePlayers).indexOf(this.targetPlayer);if(!this.aggro||t){let e=this.nearestPlayer();if(!1!==e){let[i,s]=e;i<=4&&(t||i<this.playerDistance(this.targetPlayer))&&s!==this.targetPlayer&&(this.targetPlayer=s,this.facePlayer(s),s===this.game.players[this.game.localPlayerID]&&(this.alertTicks=1),this.makeBigHitWarnings())}}}}else this.lookForPlayer()}},this.drawTopLayer=t=>{this.drawableY=this.y,this.healthBar.draw(t,this.health,this.maxHealth,this.x+.5,this.y,!0)},this.draw=t=>{this.dead||(s.Game.ctx.globalAlpha=this.alpha,this.updateDrawXY(t),this.frame+=.1*t,this.frame>=4&&(this.frame=0),this.hasShadow&&this.drawShadow(t),s.Game.drawMob(this.tileX,this.tileY+3*this.direction,2,3,this.x-this.drawX,this.y-this.drawYOffset-this.drawY-this.jumpY,2,3,this.softShadeColor,this.shadeAmount(),void 0,this.outlineColor(),this.outlineOpacity()),this.cloned||(this.seenPlayer||this.drawSleepingZs(t),this.alertTicks>0&&this.drawExclamation(t)),s.Game.ctx.globalAlpha=1)},this.w=2,this.h=2,this.ticks=0,this.frame=0,this.health=3,this.maxHealth=3,this.defaultMaxHealth=3,this.tileX=31,this.tileY=12,this.seenPlayer=!1,this.aggro=!1,this.dir=s.Direction.DOWN,this.name="bigzombie",this.chainPushable=!1,this.forwardOnlyAttack=!0,this.drawMoveSpeed=.9,this.jumpHeight=.35,this.drawYOffset=1.5,this.canDestroyOthers=!0,n&&(this.drop=n);const h=Math.floor(3*o.Random.rand())+2;for(;this.drops.length<h&&!this.cloned;)this.getDrop()}}e.BigZombieEnemy=n,n.difficulty=1,n.tileX=21,n.tileY=0},8549:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Equippable=void 0;const s=i(5366),o=i(7851),a=i(8287),r=i(2270);class n extends s.Item{constructor(t,e,i){super(t,e,i),this.wielder=null,this.equipTick=!1,this.useCost=1,this.cooldown=0,this.cooldownMax=0,this.previousWeapon=null,this.disabled=!1,this.setWielder=t=>{this.wielder=t},this.coEquippable=t=>!0,this.onEquip=()=>{},this.onUnequip=()=>{},this.toggleEquip=()=>{if(!this.broken&&this.cooldown<=0||this instanceof r.Armor)!this.equipped&&this.wielder?.inventory?.weapon&&(this.previousWeapon=this.wielder.inventory.weapon),this.equipped=!this.equipped,this.equipped?this.onEquip():this.onUnequip(),a.GameplaySettings.EQUIP_USES_TURN&&!0===this.equipped&&this.wielder?.stall();else if(this.broken){this.equipped=!1;let t=this.name.endsWith("s")?"them":"it";this.level.game.pushMessage("You'll have to fix your "+this.name+" before you can use "+t+".")}else this.cooldown>0&&this.level.game.pushMessage("Cooldown: "+this.cooldown)},this.drawEquipped=(t,e,i)=>{o.Game.drawItem(this.tileX,this.tileY,1,2,e,i-1,this.w,this.h)},this.degrade=(t=1)=>{this.degradeable&&(this.durability-=t*this.useCost,this.durability<=0&&this.break())},this.break=()=>{this.durability=0,this.broken=!0,this.toggleEquip()},this.onDrop=()=>{},this.dropFromInventory=()=>{this.wielder=null,this.equipped=!1},this.equipped=!1}}e.Equippable=n},8551:(t,e)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.applyPushChain=e.computePushChain=void 0,e.computePushChain=function(t,e,i,s){let o=e.x+i,a=e.y+s,r=!1;const n=[];for(;;){let e=!0;for(const i of t.entities)if(i.lastX=i.x,i.lastY=i.y,i.pointIn(o,a)){if(!i.chainPushable){r=!0,e=!0;break}e=!1,n.push(i);break}if(e)break;const h=n[n.length-1];o+=i*h.w,a+=s*h.h}return{chain:n,nextX:o,nextY:a,enemyEnd:r}},e.applyPushChain=function(t,e,i,s,o,a,r,n){const h=t.roomArray?.[a]?.[r],l=h&&h.canCrushEnemy?.()||n;if(0===i.length&&l)return e.crush(),!1;for(const t of i)t.lastX=t.x,t.lastY=t.y,t.x+=s,t.y+=o,t.drawX=s,t.drawY=o,t.skipNextTurns=1;return l&&i.length>0&&i[i.length-1].crush(),e.lastX=e.x,e.lastY=e.y,e.x+=s,e.y+=o,e.drawX=s,e.drawY=o,!0}},8561:(t,e)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.OneTimeEventTracker=void 0,e.OneTimeEventTracker=class{constructor(){this.done=new Set}has(t){return this.done.has(t)}mark(t){this.done.add(t)}clear(t){this.done.delete(t)}ensure(t,e){if(!this.done.has(t))try{e()}finally{this.done.add(t)}}}},8583:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Passageway=void 0;const s=i(7851),o=i(8132),a=i(2103),r=i(1073);class n extends o.Tile{constructor(t,e,i,o){super(t,i,o),this.isRope=!1,this.drawFloodedCaveFX=()=>{s.Game.ctx.save(),s.Game.ctx.globalAlpha=.25,s.Game.ctx.globalCompositeOperation="screen",this.isRope&&(this.room.envType===r.EnvType.FLOODED_CAVE&&(s.Game.ctx.globalAlpha=.5),s.Game.drawFX(8,18,3,3,this.x-1,this.y-1.75,3,3)),s.Game.ctx.restore()},this.addLightSource=()=>{this.environment!==r.EnvType.FOREST||this.lockable.isLocked()?this.isRope&&(this.lightSource=new a.LightSource(this.x+.5,this.y+.5,5,[150,100,50]),this.room.lightSources.push(this.lightSource)):(this.lightSource=new a.LightSource(this.x+.5,this.y+.5,6,[0,100,100]),this.room.lightSources.push(this.lightSource)),this.room.updateLighting()},this.game=e,this.frame=0,this.keyID=0}updateFrame(t){this.frame>100&&(this.frame=0),this.frame+=1*t}getFloatingOffset(){return.125*Math.sin(this.frame*Math.PI/50)}}e.Passageway=n},8594:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.ShroomLight=void 0;const s=i(1650);class o extends s.Light{constructor(t,e,i){super(t,e,i),this.getDescription=()=>"GLOWSHROOMS\nGives off a faint blue glow",this.fuel=100,this.tileX=7,this.tileY=2,this.name=o.itemName,this.fuelCap=100,this.radius=10,this.stackable=!0,this.maxBrightness=2,this.color=[5,100,150],this.waterproof=!0,this.falloffDecay=.7}}e.ShroomLight=o,o.itemName="glowshrooms"},8654:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Mushrooms=void 0;const s=i(606),o=i(7851),a=i(4223),r=i(606);class n extends s.Entity{constructor(t,e,i,s){super(t,e,i,s),this.draw=t=>{this.dead||(o.Game.ctx.save(),o.Game.ctx.globalAlpha=this.alpha,this.dead||(this.hasShadow&&this.drawShadow(t),this.updateDrawXY(t),o.Game.drawObj(this.tileX,this.tileY,1,2,this.x-this.drawX,this.y-this.drawYOffset-this.drawY,1,2,this.room.shadeColor,this.shadeAmount())),o.Game.ctx.restore())},this.drawTopLayer=t=>{this.drawableY=this.y},this.room=t,this.health=1,this.tileX=9,this.tileY=2,this.hasShadow=!0,this.chainPushable=!1,this.name=n.itemName,this.imageParticleX=0,this.imageParticleY=30,this.drops.push(new a.Shrooms(this.room,this.x,this.y))}get type(){return r.EntityType.PROP}}e.Mushrooms=n,n.itemName="mushrooms"},8696:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.MuteButton=void 0;const s=i(7851),o=i(6291),a=i(7366);e.MuteButton=class{static draw(){o.GameConstants.TILESIZE,s.Game.ctx.save(),s.Game.ctx.globalAlpha=.1,a.Sound.audioMuted?s.Game.drawFX(17,0,1,1,0,.5,1,1):s.Game.drawFX(16,0,1,1,0,.5,1,1),s.Game.ctx.restore()}static toggleMute(){a.Sound.toggleMute()}}},8737:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.LevelGenerator=void 0;const s=i(7851),o=i(4118),a=i(9467),r=i(5625),n=i(9362),h=i(6291),l=i(1073),c=i(7053),d=i(5350),m=i(3296),u=i(8287);class p{constructor(){this.depthReached=0,this.currentFloorFirstLevelID=0,this.setOpenWallsForPartitions=(t,e,i)=>{for(const s of t)s.isTopOpen=!1,s.isRightOpen=!1,s.isBottomOpen=!1,s.isLeftOpen=!1,0===s.x&&(s.isLeftOpen=!0),0===s.y&&(s.isTopOpen=!0),s.x+s.w===e&&(s.isRightOpen=!0),s.y+s.h===i&&(s.isBottomOpen=!0)},this.createLevel=(t,e=!0,i,s,o=!1,a)=>new n.Level(this.game,t,100,100,e,i,s,o,a),this.getRooms=(t,e,i,s,r)=>{let n=[];for(let h=0;h<t.length;h++){let l=t[h],c=new o.Room(this.game,l.x-1,l.y-1,l.w+2,l.h+2,l.type,e,i,this.game.levels[e],a.Random.rand,s);c.pathId=r||"main",n.push(c)}let h=[];return t.forEach((t,e)=>{t.connections.forEach(t=>{let i=n[e].addDoor(t.x,t.y),s=h.find(t=>t.x===i.x&&t.y===i.y);s&&(s.link(i),i.link(s)),h.push(i)})}),n},this.setSeed=t=>{this.seed=t},this.generate=async(t,e,i=!1,s,n=l.EnvType.DUNGEON,m=!1,p,y)=>{this.partitionGenerator||(this.partitionGenerator=new c.PartitionGenerator(t)),this.validator||(this.validator=new d.LevelValidator(t)),this.visualizer||(this.visualizer=this.partitionGenerator.getVisualizer()),this.levelParams=r.LevelParameterGenerator.getParameters(e),this.depthReached=e;const g=p??(i?"side":"main");let f=0;for(let t=0;t<g.length;t++)f=(131*f^g.charCodeAt(t))>>>0;a.Random.setState((this.seed+e^f)>>>0),this.game=t;let w,E=this.game.rooms.length>0?this.game.rooms[this.game.rooms.length-1].mapGroup+1:0;const x=h.GameConstants.USE_PNG_LEVELS&&!i,b=this.shouldUsePngForLevel(e,g,u.GameplaySettings.PNG_LEVEL_PROBABILITY);if(x&&b){const s=await this.selectRandomLevelForDepth(e);s&&(console.log(`Using PNG level generation from: ${s}`),w=await this.pngPartitionGenerator.generatePartitionsFromPng(s,t,e,i)),s&&0!==w.length||(s?console.warn("PNG generation failed, falling back to procedural generation"):console.warn(`No PNG levels found for depth ${e}, falling back to procedural generation`),w=await this.partitionGenerator.generateDungeonPartitions(t,this.levelParams.mapWidth,this.levelParams.mapHeight,e,this.levelParams,i?void 0:{branching:y?.branching,loopiness:y?.loopiness}))}else w=i?await this.partitionGenerator.generateCavePartitions(y):await this.partitionGenerator.generateDungeonPartitions(t,this.levelParams.mapWidth,this.levelParams.mapHeight,e,this.levelParams,i?void 0:{branching:y?.branching,loopiness:y?.loopiness});const T=this.validator.validateNoOverlaps(w);T.isValid||console.warn(`Overlap validation failed: ${T.errorMessage}`);let I=e>2?l.EnvType.DARK_DUNGEON:l.EnvType.DUNGEON,S=i?n:I,v=this.createLevel(e,!i,E,S,m,y);i||(this.game.levels.push(v),this.game.registerLevel(v));let A=this.getRooms(w,e,E,S,g);v.setRooms(A),v.populator.populateRooms(),v.setRoomSkins(),v.exitRoom&&v.exitRoom.linkExitToStart(),i||(this.currentFloorFirstLevelID=this.game.rooms.length),this.game.registerRooms(A),this.game.level=this.game.levels[e]||this.game.level,s(i?A.find(t=>t.type===o.RoomType.ROPECAVE):A.find(t=>t.type===o.RoomType.START))},this.generateFirstNFloors=async(t,e,i=!1)=>{for(let s=0;s<=e;s++)await this.generate(t,s,!1,()=>{},l.EnvType.DUNGEON,i,void 0,{branching:u.GameplaySettings.MAIN_PATH_BRANCHING,loopiness:u.GameplaySettings.MAIN_PATH_LOOPINESS})},this.draw=t=>{this.visualizer?this.visualizer.draw(t):(s.Game.ctx.fillStyle="rgba(0, 0, 0, 1)",s.Game.ctx.fillRect(0,0,h.GameConstants.WIDTH,h.GameConstants.HEIGHT),this.game.drawTextScreen("generating level"))},this.validator=null,this.visualizer=null,this.pngPartitionGenerator=new m.PngPartitionGenerator}shouldUsePngForLevel(t,e,i){let s=(this.seed^t)>>>0;for(let t=0;t<e.length;t++)s=Math.imul(s^e.charCodeAt(t),1664525)+1013904223>>>0;return(s>>>0)/4294967296<i}async selectRandomLevelForDepth(t){console.log(`Looking for PNG levels for depth ${t}...`);const e=[];for(let i=0;i<10;i++){const s=`${t}_${i}.png`,o=`res/levels/${s}`;await this.checkImageExists(o)&&(e.push(o),console.log(`   Found variation: ${s}`))}if(0===e.length)return console.log(`   No PNG levels found for depth ${t}`),null;const i=Math.floor(a.Random.rand()*e.length),s=e[i];return console.log(`   Selected ${s} (${i+1}/${e.length} available)`),s}async checkImageExists(t){return new Promise(e=>{const i=new Image;i.onload=()=>{e(!0)},i.onerror=()=>{e(!1)},setTimeout(()=>{e(!1)},1e3),i.src=t})}}e.LevelGenerator=p,p.ANIMATION_CONSTANT=1},8745:(t,e)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.TutorialFlags=void 0,e.TutorialFlags=class{constructor(){this.initPointers=!1,this.openInventoryShown=!1,this.purchasedFromVendingMachine=!1}}},8774:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Projectile=void 0;const s=i(8160),o=i(5947);class a extends s.Drawable{constructor(t,e,i,s=t?.z??0){super(),this.hitPlayer=t=>{},this.hitEnemy=t=>{},this.tick=()=>{},this.draw=t=>{},this.drawTopLayer=t=>{},this.globalId=o.IdGenerator.generate("PROJ"),this.x=e,this.y=i,this.z=s,this.dead=!1,this.parent=t,this.drawableY=i,this.hasBloom=!1,this.bloomColor="#00BFFF",this.bloomOffsetY=0}get distanceToParent(){return Math.abs(this.x-this.parent.x)+Math.abs(this.y-this.parent.y)}setTarget(t,e,i,s){}}e.Projectile=a},8821:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.GarnetResource=void 0;const s=i(7172),o=i(9432),a=i(9467),r=i(1470),n=i(2103);class h extends s.Resource{constructor(t,e,i,s){super(t,e,i,s),this.tileX=15,this.tileY=0,this.health=3,this.hasBloom=!0,this.bloomColor="#FF0000",this.bloomAlpha=1,this.softBloomAlpha=0,this.name="garnet",a.Random.rand()<.025&&this.drops.push(new o.Geode(this.room,this.x,this.y)),this.drops.push(new r.RedGem(this.room,this.x,this.y)),this.lightSource=new n.LightSource(this.x+.5,this.y+.5,7,[150,0,0],2),this.addLightSource(this.lightSource)}}e.GarnetResource=h},8900:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.MouseCursor=void 0;const s=i(7851),o=i(3628),a=i(6291);class r{constructor(){this.cursorSize=5,this.clickX=0,this.clickY=0,this.rawClickX=0,this.rawClickY=0,this.tileX=6,this.lastMouseX=0,this.lastMouseY=0,this.posChangeTime=Date.now(),this.cursorTimeout=5e3,this.frame=0,this.setIcon=t=>{switch(t){case"arrow":this.tileX=8;break;case"sword":this.tileX=7;break;case"hand":this.tileX=6;break;case"wait":this.tileX=9;break;case"grab":this.tileX=10;break;case"up":this.tileX=11;break;case"right":this.tileX=12;break;case"down":this.tileX=13;break;case"left":this.tileX=14;break;case"mine":this.tileX=15}},this.draw=(t,e=!1)=>{!e&&Date.now()-this.posChangeTime<this.cursorTimeout&&this.drawCursor(),this.drawAnimation(t)}}static getInstance(){return r.instance||(r.instance=new r),r.instance}drawCursor(){s.Game.ctx.save();const t=Date.now()-this.posChangeTime,e=this.cursorTimeout-200;let i=1;t>e&&(i=1-(t-e)/200),s.Game.ctx.globalAlpha=i,s.Game.drawFX(this.tileX,0,1,1,o.Input.mouseX/a.GameConstants.TILESIZE-8/a.GameConstants.TILESIZE,o.Input.mouseY/a.GameConstants.TILESIZE-8/a.GameConstants.TILESIZE,1,1),s.Game.ctx.restore()}drawAnimation(t){this.frame>5||(s.Game.drawFX(9+Math.ceil(this.frame),1,1,1,this.clickX/a.GameConstants.TILESIZE-8/a.GameConstants.TILESIZE,this.clickY/a.GameConstants.TILESIZE-8/a.GameConstants.TILESIZE,1,1),this.frame=this.frame+t/5)}startClickAnim(){this.frame=0,this.clickX=o.Input.mouseX,this.clickY=o.Input.mouseY,this.rawClickX=o.Input.rawMouseX,this.rawClickY=o.Input.rawMouseY}recalculateClickPosition(){void 0!==this.rawClickX&&void 0!==this.rawClickY&&(document.getElementById("gameCanvas").getBoundingClientRect(),this.clickX=Math.floor(this.rawClickX/s.Game.scale),this.clickY=Math.floor(this.rawClickY/s.Game.scale))}getPosition(){return o.Input.mouseX===this.lastMouseX&&o.Input.mouseY===this.lastMouseY||(this.posChangeTime=Date.now()),this.lastMouseX=o.Input.mouseX,this.lastMouseY=o.Input.mouseY,{x:o.Input.mouseX,y:o.Input.mouseY}}getTilePosition(){return{x:Math.floor(o.Input.mouseX/a.GameConstants.TILESIZE),y:Math.floor(o.Input.mouseY/a.GameConstants.TILESIZE)}}getInventoryPosition(){return{x:o.Input.mouseX,y:o.Input.mouseY}}}e.MouseCursor=r},8965:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.CoffinTile=void 0;const s=i(7851),o=i(8132);class a extends o.Tile{constructor(t,e,i,o){super(t,e,i),this.isSolid=()=>!0,this.canCrushEnemy=()=>!0,this.draw=t=>{0===this.subTileY?(s.Game.drawTile(0,5,1,1,this.x-1,this.y-1,1,1,this.room.shadeColor,this.shadeAmount()),s.Game.drawTile(1,5,1,1,this.x,this.y-1,1,1,this.room.shadeColor,this.shadeAmount()),s.Game.drawTile(2,5,1,1,this.x+1,this.y-1,1,1,this.room.shadeColor,this.shadeAmount()),s.Game.drawTile(0,6,1,1,this.x-1,this.y,1,1,this.room.shadeColor,this.shadeAmount()),s.Game.drawTile(1,6,1,1,this.x,this.y,1,1,this.room.shadeColor,this.shadeAmount()),s.Game.drawTile(2,6,1,1,this.x+1,this.y,1,1,this.room.shadeColor,this.shadeAmount())):(s.Game.drawTile(0,7,1,1,this.x-1,this.y,1,1,this.room.shadeColor,this.shadeAmount()),s.Game.drawTile(1,7,1,1,this.x,this.y,1,1,this.room.shadeColor,this.shadeAmount()),s.Game.drawTile(2,7,1,1,this.x+1,this.y,1,1,this.room.shadeColor,this.shadeAmount()))},this.subTileY=o}}e.CoffinTile=a},8991:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.CrossbowBolt=void 0;const s=i(7366),o=i(5180),a=i(4083),r=i(9467),n=i(2124);class h extends o.Usable{constructor(t,e,i){super(t,e,i),this.onUse=t=>{t.health=Math.min(t.maxHealth,t.health+1),(t?.getRoom?t.getRoom():this.level.game.rooms[t.levelID])===this.level.game.room&&s.Sound.heal()},this.useOnOther=(t,e)=>{e instanceof n.Crossbow&&e.addBolt()&&(this.stackCount--,this.stackCount<=0&&t.inventory.removeItem(this))},this.disassemble=t=>{let e=this.x,i=this.y,s=Math.ceil(2*r.Random.rand()+3);t.inventory.removeItem(this),t.inventory.addItem(new a.WeaponFragments(this.level,e,i,s))},this.tileX=21,this.tileY=4,this.offsetY=-.3,this.canUseOnOther=!0,this.description="useful for shooting with a crossbow",this.stackable=!0,this.stackCount=Math.ceil(10*r.Random.rand())+5,this.name=h.itemName}}e.CrossbowBolt=h,h.itemName="crossbow bolt"},9058:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Warhammer=void 0;const s=i(4052),o=i(7366),a=i(7851);class r extends s.Weapon{constructor(t,e,i){super(t,e,i),this.hitSound=()=>{o.Sound.swing(),o.Sound.playWarHammer()},this.weaponMove=(t,e)=>{if(this.checkForPushables(t,e))return!0;const i=this.executeAttack(t,e,!0,this.damage+this.wielder.damageBonus);return i&&(this.cooldown=this.cooldownMax),!i},this.shakeScreen=()=>{this.wielder.beginSlowMotion(),setTimeout(()=>{switch(this.wielder.endSlowMotion(),this.wielder.direction){case a.Direction.DOWN:case a.Direction.UP:this.game.shakeScreen(0,-5,!1);break;case a.Direction.LEFT:this.game.shakeScreen(-5,-5,!1);break;case a.Direction.RIGHT:this.game.shakeScreen(5,-5,!1)}},this.hitDelay)},this.tileX=22,this.tileY=2,this.damage=2,this.name="warhammer",this.hitDelay=225,this.useCost=2,this.degradeable=!1}}e.Warhammer=r,r.itemName="warhammer"},9066:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.EmeraldRing=void 0;const s=i(8549);class o extends s.Equippable{constructor(t,e,i){super(t,e,i),this.tileX=11,this.tileY=2,this.name=o.itemName,this.stackable=!1,this.description="A ring of emerald"}}e.EmeraldRing=o,o.itemName="emerald ring"},9100:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.InsideLevelDoor=void 0;const s=i(7851),o=i(8132);class a extends o.Tile{constructor(t,e,i,o){super(t,i,o),this.isSolid=()=>!this.opened,this.canCrushEnemy=()=>!this.opened,this.isOpaque=()=>!this.opened,this.draw=t=>{s.Game.drawTile(1,0,1,1,this.x,this.y,1,1,this.room.shadeColor,this.shadeAmount()),this.opened?s.Game.drawTile(15,1,1,1,this.x,this.y,1,1,this.room.shadeColor,this.shadeAmount()):s.Game.drawTile(3,this.skin,1,1,this.x,this.y,1,1,this.room.shadeColor,this.shadeAmount())},this.drawAbovePlayer=t=>{this.opened?s.Game.drawTile(14,0,1,1,this.x,this.y-1,1,1,this.room.shadeColor,this.shadeAmount()):s.Game.drawTile(13,0,1,1,this.x,this.y-1,1,1,this.room.shadeColor,this.shadeAmount())},this.game=e,this.opened=!1}}e.InsideLevelDoor=a},9116:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Button=void 0;const s=i(7851),o=i(8132);class a extends o.Tile{constructor(t,e,i,o){super(t,e,i),this.press=()=>{this.pressed=!0,this.linkedDoor.opened=!0},this.unpress=()=>{this.pressed=!1,this.linkedDoor.opened=!1},this.onCollide=t=>{this.press()},this.onCollideEnemy=t=>{this.press()},this.tickEnd=()=>{this.unpress();for(const t in this.room.game.players)this.room.game.players[t].x===this.x&&this.room.game.players[t].y===this.y&&this.press();for(const t of this.room.entities)t.x===this.x&&t.y===this.y&&this.press()},this.draw=t=>{s.Game.drawTile(1,0,1,1,this.x,this.y,1,1,this.room.shadeColor,this.shadeAmount()),this.pressed?s.Game.drawTile(18,0,1,1,this.x,this.y,this.w,this.h,this.room.shadeColor,this.shadeAmount()):s.Game.drawTile(17,0,1,1,this.x,this.y,this.w,this.h,this.room.shadeColor,this.shadeAmount())},this.w=1,this.h=1,this.pressed=!1,this.turnsSincePressed=1,this.linkedDoor=o}}e.Button=a},9200:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Wall=void 0;const s=i(7851),o=i(4804),a=i(8132),r=i(6291);class n extends a.Tile{constructor(t,e,i,a){super(t,e,i),this.isSolid=()=>!0,this.canCrushEnemy=()=>!0,this.isOpaque=()=>{const t=this.wallInfo();return!!t&&(!t.isTopWall&&!t.isInnerWall||(t.isTopWall||t.isBottomWall)&&t.isLeftWall&&t.isRightWall&&!t.isInnerWall||t.isLeftWall||t.isRightWall)},this.isInnerWall=()=>{const t=this.wallInfo();return t?.isInnerWall||!1},this.wallInfo=()=>this.room.wallInfo.get(`${this.x},${this.y}`),this.getDoor=()=>{const t=this.wallInfo();if(!t||!t.isBelowDoorWall)return;const e=this.room.roomArray[this.x]?.[this.y+1];return e instanceof o.Door?e:void 0},this.draw=t=>{this.drawWall(t)},this.drawWall=t=>{const e=this.room.wallInfo.get(`${this.x},${this.y}`);if(!e)return;this.tileXOffset="bottomInner"===e.innerWallType||"surroundedInner"===e.innerWallType?0:26;const i=this.getDoor()?.isDrawnFirst(),o=this.room.roomArray[this.x]?.[this.y+1],a=o instanceof n;if(e.isDoorWall||e.isBelowDoorWall||e.isTopWall&&!e.isLeftWall&&!e.isRightWall||e.isInnerWall&&!a){if(e.isBelowDoorWall&&!i&&r.GameConstants.SMOOTH_LIGHTING)return;const t=r.GameConstants.SMOOTH_LIGHTING?this.shadeAmount():this.room.softVis[this.x][this.y+1];s.Game.drawTile(0,this.skin,1,1,this.x,this.y,1,1,this.room.shadeColor,t)}s.Game.drawTile(2+this.tileXOffset,this.skin,1,1,this.x,this.y-1,1,1,this.room.shadeColor,this.shadeAmount())},this.drawTopLayer=t=>{const e=this.room.wallInfo.get(`${this.x},${this.y}`),i=this.room;e&&i&&(e.isBottomWall&&i.active||null!==e.innerWallType&&"isolatedInner"!==e.innerWallType||"topInner"===e.innerWallType)&&s.Game.drawTile(2+this.tileXOffset,this.skin,1,1,this.x,this.y-1,1,1,this.room.shadeColor,this.shadeAmount())},this.isDoor=!1,this.tileXOffset=6,this.wallDirections=a||[],this.opacity=1,this.room=t}get direction(){let t=[];return null===this.room.roomArray[this.x-1][this.y]&&t.push(s.Direction.LEFT),null===this.room.roomArray[this.x+1][this.y]&&t.push(s.Direction.RIGHT),null===this.room.roomArray[this.x][this.y-1]&&t.push(s.Direction.DOWN),null===this.room.roomArray[this.x][this.y+1]&&t.push(s.Direction.UP),1==t.length?t[0]:t.includes(s.Direction.UP)&&t.includes(s.Direction.LEFT)?(this.opacity=.5,s.Direction.UP_LEFT):t.includes(s.Direction.UP)&&t.includes(s.Direction.RIGHT)?(this.opacity=.5,s.Direction.UP_RIGHT):t.includes(s.Direction.DOWN)&&t.includes(s.Direction.LEFT)?(this.opacity=.5,s.Direction.DOWN_LEFT):s.Direction.DOWN_RIGHT}}e.Wall=n},9201:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Bones=void 0;const s=i(7851),o=i(3384);class a extends o.Floor{constructor(){super(...arguments),this.draw=t=>{s.Game.drawTile(7,this.skin,1,1,this.x,this.y,1,1,this.room.shadeColor,this.shadeAmount())}}}e.Bones=a},9245:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Bomb=void 0;const s=i(606),o=i(7851),a=i(1731),r=i(606),n=i(9467),h=i(7366),l=i(2103),c=i(1124),d=i(5862),m=i(6199);class u extends s.Entity{constructor(t,e,i,s){super(t,e,i,s),this.fuseLength=4,this.lit=!1,this.playerHitBy=null,this.soundPaused=!1,this.uniqueKillBehavior=()=>{this.cloned},this.tick=()=>{this.lit&&(this.fuseLength--,this.fuseLength<=0&&(this.fuseLength=0,h.Sound.stopSound(this.fuseSound),this.explode(),h.Sound.playBomb()))},this.createLightSource=()=>{this.lit&&(this.lightSource=new l.LightSource(this.x+.5,this.y+.5,3,[200,200,30],.75),this.addLightSource(this.lightSource),this.bloomAlpha=1,this.hasBloom=!0)},this.hurt=(t,e)=>{this.lit||(this.lit=!0,this.createLightSource(),this.playerHitBy=t,h.Sound.playFuse())},this.explode=()=>{h.Sound.stopSound(this.fuseSound);for(let t=this.x-2;t<this.x+3;t++)for(let e=this.y-2;e<this.y+3;e++)if(this.room.pointExists(t,e)&&!this.room.roomArray[t][e].isSolid()&&m.Utils.distance(this.x,this.y,t,e)<2.5){const i=new d.Explosion(this,t,e,this.playerHitBy);this.room.projectiles.push(i)}this.health=0,c.Lighting.momentaryLight(this.room,this.x,this.y,7,[200,200,50],250,50,0),a.GenericParticle.spawnCluster(this.room,this.x+.5,this.y+.5,"white"),this.kill(),setTimeout(()=>{this.game.shakeScreen(5*(n.Random.rand()-.5),0*(n.Random.rand()-.5),!1)},100),this.game.shakeScreen(0,20,!1)},this.draw=t=>{this.dead||(this.frame+=t,0===this.health&&(this.frame=0),this.frame>20&&(this.frame=0),this.bloomAlpha=this.frame/10%2==0?1:.5,o.Game.ctx.save(),o.Game.ctx.globalAlpha=this.alpha,this.dead||(this.hasShadow&&this.drawShadow(t),this.updateDrawXY(t),this.lit?o.Game.drawObj(this.tileX+6-2*Math.min(3,this.fuseLength)+Math.floor(this.frame/10)%2,this.tileY,1,2,this.x-this.drawX,this.y-this.drawYOffset-this.drawY,1,2,this.room.shadeColor,this.shadeAmount()):o.Game.drawObj(this.tileX-1,this.tileY,1,2,this.x-this.drawX,this.y-this.drawYOffset-this.drawY,1,2,this.room.shadeColor,this.shadeAmount())),o.Game.ctx.restore())},this.drawTopLayer=t=>{this.drawableY=this.y},this.room=t,this.health=1,this.tileX=15,this.tileY=4,this.hasShadow=!0,this.chainPushable=!1,this.name="bomb",this.frame=0,this.hasBloom=!1,this.bloomColor="yellow",this.bloomAlpha=0,this.bloomSize=1,this.bloomOffsetY=-1,this.health=1,this.hitSound=h.Sound.potSmash,this.imageParticleX=0,this.imageParticleY=29,this.createLightSource(),this.playerHitBy=null,this.fuseSound=h.Sound.fuseLoopSound,this.soundPaused=!1}get type(){return r.EntityType.PROP}}e.Bomb=u},9259:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.ChestLayer=void 0;const s=i(7851),o=i(606);class a extends o.Entity{constructor(t,e,i,o){super(t,e,i,o),this.setDrawableY=()=>{for(let t of this.room.items)t.x===this.x&&t.y===this.y&&(this.drawableY,this.room.roomArray[this.x][this.y].drawableY)},this.draw=t=>{this.drawableY=this.y-.01,this.setDrawableY,this.dead||s.Game.drawObj(0,4,1,2,this.x-this.drawX,this.y-this.drawYOffset-this.drawY,1,2,this.room.shadeColor,this.shadeAmount())},this.x=i,this.y=o,this.game=e,this.room=t,this.frame=0}}e.ChestLayer=a},9357:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.BigKnightEnemy=void 0;const s=i(7851),o=i(1236),a=i(1470),r=i(8243),n=i(6291),h=i(6986),l=i(9467),c=i(7455);class d extends h.Enemy{constructor(t,e,i,h,d){for(super(t,e,i,h),this.REGEN_TICKS=5,this.hit=()=>this.damage,this.bleed=()=>{},this.behavior=()=>{if(this.lastX=this.x,this.lastY=this.y,!this.dead){if(this.handleSkipTurns())return;if(1===this.health)this.ticksSinceFirstHit++,this.ticksSinceFirstHit>=this.REGEN_TICKS&&(this.health++,this.ticksSinceFirstHit=0);else if(this.seenPlayer){if(this.seenPlayer){if(this.room.playerTicked===this.targetPlayer){if(this.alertTicks=Math.max(0,this.alertTicks-1),this.ticks++,this.ticks%2==0)return this.rumbling=!0,void this.makeBigHitWarnings();const t=this.x,e=this.y;let i=Array();for(const t of this.room.entities)if(t!==this)for(let e=0;e<t.w;e++)for(let s=0;s<t.h;s++)i.push({x:t.x+e,y:t.y+s});for(let t=this.x-1;t<=this.x+this.w;t++)for(let e=this.y-1;e<=this.y+this.h;e++)this.room.roomArray[t]&&this.room.roomArray[t][e]&&this.room.roomArray[t][e]instanceof c.SpikeTrap&&this.room.roomArray[t][e].on&&i.push({x:t,y:e});const o=this.searchPathLocalized(this.targetPlayer,i);if(o.length>0){const i=o[0].pos.x,a=o[0].pos.y;i>t?this.direction=s.Direction.RIGHT:i<t?this.direction=s.Direction.LEFT:a>e?this.direction=s.Direction.DOWN:a<e&&(this.direction=s.Direction.UP);let r=!1;if(this.health>=3)for(const t in this.game.players)if(this.game.rooms[this.game.players[t].levelID]===this.room){let e=!1;for(let s=0;s<this.w;s++){for(let o=0;o<this.h;o++)if(this.game.players[t].x===i+s&&this.game.players[t].y===a+o){e=!0;break}if(e)break}e&&(this.game.players[t].hurt(this.hit(),this.name),this.drawX=.5*(this.x-this.game.players[t].x),this.drawY=.5*(this.y-this.game.players[t].y),this.game.players[t]===this.game.players[this.game.localPlayerID]&&this.game.shakeScreen(10*this.drawX,10*this.drawY),r=!0)}r||(this.tryMove(i,a),this.setDrawXY(t,e),this.x>t?this.direction=s.Direction.RIGHT:this.x<t?this.direction=s.Direction.LEFT:this.y>e?this.direction=s.Direction.DOWN:this.y<e&&(this.direction=s.Direction.UP))}else this.facePlayer(this.targetPlayer);this.health<this.maxHealth&&(this.ticksSinceFirstHit++,this.ticksSinceFirstHit>=this.REGEN_TICKS&&(this.health++,this.ticksSinceFirstHit=0))}let t=-1!==Object.values(this.game.offlinePlayers).indexOf(this.targetPlayer);if(!this.aggro||t){let e=this.nearestPlayer();if(!1!==e){let[i,s]=e;i<=4&&(t||i<this.playerDistance(this.targetPlayer))&&s!==this.targetPlayer&&(this.targetPlayer=s,this.facePlayer(s),s===this.game.players[this.game.localPlayerID]&&(this.alertTicks=1),this.health>=3&&this.ticks%2==0&&(this.rumbling=!0),this.makeBigHitWarnings())}}}}else{let t=this.nearestPlayer();if(!1!==t){let[e,i]=t;e<=4&&(this.targetPlayer=i,this.facePlayer(i),this.seenPlayer=!0,i===this.game.players[this.game.localPlayerID]&&(this.alertTicks=1),this.makeBigHitWarnings())}}}},this.draw=t=>{if(!this.dead){if(s.Game.ctx.save(),s.Game.ctx.globalAlpha=this.alpha,!this.dead){let e=this.rumble(this.rumbling,this.frame).x;this.rumble(this.rumbling,this.frame,this.direction).y,this.updateDrawXY(t),this.frame+=.1*t,this.frame>=4&&(this.frame=0);const i=this.ticks%2==0?2*Math.floor((this.tileX+this.frame)/2)+1:this.tileX,o=this.ticks%2==0?this.tileY:this.tileY+4;this.hasShadow&&this.drawShadow(t),s.Game.drawMob(i,o,2,4,this.x-this.drawX+e,this.y-2.5-this.drawY,2,4,this.softShadeColor,this.shadeAmount(),void 0,this.outlineColor(),this.outlineOpacity()),this.cloned||(this.seenPlayer||this.drawSleepingZs(t,.5*n.GameConstants.TILESIZE,-1*n.GameConstants.TILESIZE),this.alertTicks>0&&this.drawExclamation(t,.5*n.GameConstants.TILESIZE,-1*n.GameConstants.TILESIZE))}s.Game.ctx.restore()}},this.drawTopLayer=t=>{this.drawableY=this.y,this.healthBar.draw(t,this.health,this.maxHealth,this.x+.5,this.y,!0)},this.w=2,this.h=2,this.ticks=0,this.frame=0,this.health=4,this.maxHealth=4,this.defaultMaxHealth=4,this.tileX=29,this.tileY=0,this.seenPlayer=!1,this.aggro=!1,this.ticksSinceFirstHit=0,this.flashingFrame=0,this.deathParticleColor="#ffffff",this.chainPushable=!1,this.name="giant knight",this.orthogonalAttack=!0,this.drops=[],d&&this.drops.push(d);this.drops.length<4;){let t=l.Random.rand();t<.005?this.drops.push(new r.Spear(this.room,this.x,this.y)):t<.04||t<.075||t<.1?this.drops.push(new a.RedGem(this.room,this.x,this.y)):this.drops.push(new o.Coin(this.room,this.x,this.y))}}}e.BigKnightEnemy=d,d.difficulty=4,d.tileX=29,d.tileY=0},9362:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Level=void 0;const s=i(4118),o=i(7445),a=i(7178),r=i(8287),n=i(3436),h=i(5926),l=i(9467),c=i(5947),d={1:0,2:1,3:0,4:0,5:1,6:2,7:1,8:1,9:1,10:2,11:2,12:1,13:2,14:2,15:2,16:2,17:2,18:3};e.Level=class{constructor(t,e,i,s,h=!0,l,d,m=!1,u){this.paths=new Map,this.pathsById=new Map,this.isMainPath=!0,this.skipPopulation=!1,this.findSidepathDownLadderByKeyID=(t,e)=>{if(!t||null==e)return null;const i=t.path();console.log(`findSidepathDownLadderByKeyID: origin=${t.globalId} keyID=${e} roomsInPath=${i.length}`);for(const t of i)for(let i=t.roomX;i<t.roomX+t.width;i++)for(let s=t.roomY;s<t.roomY+t.height;s++){const o=t.roomArray[i][s];if(o instanceof n.DownLadder&&o.isSidePath){const a=o.lockable?.keyID;if(a===e)return console.log(`findSidepathDownLadderByKeyID: MATCH room=${t.globalId} at (${i},${s}) keyID=${a}`),{ladder:o,room:t};Math.random()<.02&&console.log(`findSidepathDownLadderByKeyID: saw sidepath downladder key=${a}, want=${e} in room ${t.globalId}`)}}return console.log(`findSidepathDownLadderByKeyID: NO MATCH for keyID=${e} from origin ${t.globalId}`),null},this.getLadderRoom=(t,e)=>{for(const i of t.path())if(i.hasLadder(e))return i;return null},this.initializeLevelArray=()=>{this.levelArray=[];for(let t=0;t<this.width;t++){this.levelArray[t]=[];for(let e=0;e<this.height;e++)this.levelArray[t][e]=null}},this.getFurthestFromLadder=t=>{let e=null,i=0;for(const s of this.rooms){const o=s.getDistanceToNearestLadder(t);o&&o>i&&(i=o,e=s)}return e},this.getFurthestFromLadders=t=>{let e=null,i=-1/0;const s=t.path();let o=0,a=0;for(const t of s){const s=t.getDistanceToNearestLadder("up"),r=t.getDistanceToNearestLadder("down");o=s,a=r;const n=[];if(null!=s&&n.push(s),null!=r&&n.push(r),0===n.length)continue;const h=Math.min(...n);h>i&&(i=h,e=t)}const r=e?.getDistanceToNearestLadder("up"),n=e?.getDistanceToNearestLadder("down");return console.log("furthestRoom",e?.globalId,{up:r,down:n,furthestMinDistance:i}),e},this.loadRoomsIntoLevelArray=()=>{for(let t of this.rooms)for(let e=t.roomX;e<t.roomX+t.width;e++)for(let i=t.roomY;i<t.roomY+t.height;i++)e>=0&&e<this.width&&i>=0&&i<this.height?t.roomArray[e]&&t.roomArray[e][i]?this.levelArray[e][i]=t.roomArray[e][i]:console.warn(`Room array missing tile at (${e}, ${i}) for room ${t.id}`):console.warn(`Room coordinates (${e}, ${i}) are outside level bounds (${this.width}, ${this.height})`)},this.game=t,this.globalId=c.IdGenerator.generate("L"),this.depth=e,this.width=i,this.height=s,this.rooms=[],this.roomsById=new Map,this.isMainPath=h,this.initializeLevelArray(),this.mapGroup=l,this.environment=new o.Environment(d),this.populator=new a.Populator(this,m),this.skipPopulation=m,this.generationOptions=u,this.organicTunnelsAvoidCenter=u?.organicTunnelsAvoidCenter??r.GameplaySettings.ORGANIC_TUNNELS_AVOID_CENTER_DEFAULT,this.enemyParameters=this.getEnemyParameters()}getDownLadder(t){if(!t||t.type!==s.RoomType.ROPEHOLE)return console.error("Room is not a rope hole"),null;if(t)for(let e=t.roomX;e<t.roomX+t.width;e++)for(let i=t.roomY;i<t.roomY+t.height;i++){const s=t.roomArray[e][i];if(s instanceof n.DownLadder)return s}return console.error("No down ladder found"),null}getKeyRoom(t){const e=t.path();for(const t of e)if(t.hasKey())return t;return null}distributeKey(t,e){if(this.skipPopulation)return;const i=t.x,s=t.y,o=t.room;if(0===t.room.path().length)return void console.error("No eligible rooms found for key placement");const a=this.getFurthestFromLadders(t.room),r=e||a;let n=r.getEmptyTiles();if(o===r&&(n=n.filter(t=>t.x!==i&&t.y!==s)),0===n.length)return void console.error(`No empty tiles found in room ${r.id} for key placement, unlocking downladder ${t.room.id}`,t.lockable.removeLock());const c=n[Math.floor(l.Random.rand()*n.length)],d=new h.Key(r,c.x,c.y);t.lockable.setKey(d),r.items.push(d)}setExitRoom(t=!0){this.exitRoom=t?this.rooms.find(t=>t.type===s.RoomType.DOWNLADDER):this.getLadderRoom(this.rooms[this.rooms.length-1],"down")}setStartRoom(t=!0){this.startRoom=t?this.rooms.find(t=>t.type===s.RoomType.START):this.getLadderRoom(this.rooms[this.rooms.length-1],"up")}setRooms(t){this.rooms=t,this.setExitRoom(),this.setStartRoom(),this.roomsById.clear(),this.paths.clear(),this.pathsById.clear(),t.forEach(t=>{t.id=this.rooms.indexOf(t),this.roomsById.set(t.globalId,t);const e=t.pathId||"main";this.paths.has(e)||this.paths.set(e,[]),this.pathsById.has(e)||this.pathsById.set(e,new Map),this.paths.get(e).push(t),this.pathsById.get(e).set(t.globalId,t)}),this.game.roomsById=new Map(t.map(t=>[t.globalId,t]))}getRoomById(t){return this.roomsById.get(t)}getEnemyParameters(){return{enemyTables:{},maxDepthTable:this.depth,minDepths:d}}setRoomSkins(){for(let t of this.rooms)t.skin=this.environment.skin}}},9406:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.WeaponBlood=void 0;const s=i(7366),o=i(5180),a=i(4052);class r extends o.Usable{constructor(t,e,i){super(t,e,i),this.onUse=t=>{t.health=Math.min(t.maxHealth,t.health+1),this.level.game.rooms[t.levelID]===this.level.game.room&&s.Sound.heal()},this.useOnOther=(t,e)=>{e instanceof a.Weapon&&(e.applyStatus({blood:!0,poison:!1}),t.inventory.removeItem(this),this.level.game.pushMessage(`You coat your ${e.name} in cursed blood.`))},this.getDescription=()=>"WEAPON BLOOD\nCan be applied to weapons to deal bleed damage",this.tileX=12,this.tileY=4,this.offsetY=-.3,this.canUseOnOther=!0}}e.WeaponBlood=r,r.itemName="cursed blood"},9410:(t,e,i)=>{"use strict";var s;Object.defineProperty(e,"__esModule",{value:!0}),e.PostProcessor=void 0;const o=i(7851),a=i(6291),r=i(7264);class n{static applyDefaultLayer(){o.Game.ctx.globalAlpha=n.settings.globalAlpha,o.Game.ctx.globalCompositeOperation=n.settings.globalCompositeOperation,o.Game.ctx.fillStyle=n.settings.fillStyle}static applyUnderwaterLayer(){o.Game.ctx.globalAlpha=n.settings.underwaterBaseAlpha,o.Game.ctx.globalCompositeOperation=n.settings.underwaterCompositeOperation,o.Game.ctx.fillStyle=n.settings.underwaterFillStyle,o.Game.ctx.fillRect(0,0,a.GameConstants.WIDTH,a.GameConstants.HEIGHT)}}e.PostProcessor=n,s=n,n.settings={enabled:!0,globalAlpha:.15,fillStyle:"#006A6E",globalCompositeOperation:"screen",underwaterBaseAlpha:.1,underwaterFillStyle:"#002631",underwaterCompositeOperation:"source-over"},n.draw=(t,e=!1,i)=>{if(n.settings.enabled){if(o.Game.ctx.save(),e)return o.Game.ctx.save(),n.applyUnderwaterLayer(),r.WaterOverlay.draw(o.Game.ctx,t,i),o.Game.ctx.fillStyle=s.settings.underwaterFillStyle,o.Game.ctx.globalCompositeOperation=s.settings.underwaterCompositeOperation,o.Game.ctx.globalAlpha=s.settings.underwaterBaseAlpha,o.Game.ctx.fillRect(0,0,a.GameConstants.WIDTH,a.GameConstants.HEIGHT),s.settings.globalCompositeOperation="lighten",n.applyDefaultLayer(),o.Game.ctx.fillRect(0,0,a.GameConstants.WIDTH,a.GameConstants.HEIGHT),o.Game.ctx.restore(),void(s.settings.globalCompositeOperation="screen");n.applyDefaultLayer(),o.Game.ctx.fillRect(0,0,a.GameConstants.WIDTH,a.GameConstants.HEIGHT),o.Game.ctx.restore()}}},9432:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Geode=void 0;const s=i(5366),o=i(1470),a=i(521),r=i(5614),n=i(6199),h=i(9467);class l extends s.Item{constructor(t,e,i){super(t,e,i),this.getDescription=()=>"GEODE\nWhen in doubt hit it with a hammer.",this.split=t=>{if(t.isFull())this.level.game.pushMessage("You don't have enough space in your inventory to split the geode.");else{const e=Math.min(1,n.Utils.randomNormalInt(1,3));let i=[a.BlueGem,o.RedGem,r.GreenGem],s=i[Math.floor(h.Random.rand()*i.length)];this.level.game.pushMessage(`You split the geode and find ${e} ${s.itemName}.`);for(let i=0;i<e;i++)t.addItem(new s(this.level,this.x,this.y));this.stackCount>1?this.stackCount--:t.removeItem(this)}},this.tileX=15,this.tileY=2,this.name=l.itemName,this.stackable=!0}}e.Geode=l,l.itemName="geode"},9467:(t,e)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Random=void 0;class i{}e.Random=i,i.setState=t=>{i.state=t},i.rand=()=>(i.state^=i.state<<21,i.state^=i.state>>>35,i.state^=i.state<<4,(i.state>>>0)/4294967296)},9513:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.IronBar=void 0;const s=i(5366),o=i(7366),a=i(6105);class r extends s.Item{constructor(t,e,i){super(t,e,i),this.smith=t=>{t.inventory.subtractItem(this,1),t.inventory.addItem(new a.DivingHelmet(this.level,this.x,this.y)),this.level.game.pushMessage("You hammer the iron bar into a diving helmet."),o.Sound.playSmith()},this.tileX=16,this.tileY=0,this.name=r.itemName,this.stackable=!0,this.description="A bar of iron. Hit it with a hammer to make a diving helmet."}}e.IronBar=r,r.itemName="iron bar"},9573:(t,e)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.getCookieChunks=e.setCookieChunks=e.deleteCookie=e.getCookie=e.setCookie=void 0;const i=t=>encodeURIComponent(t);e.setCookie=(t,s,o=180)=>{try{const a=24*o*60*60;document.cookie=`${i(t)}=${(t=>encodeURIComponent(t))(s)}; path=/; max-age=${a}`,null===(0,e.getCookie)(t)&&localStorage.setItem(t,s)}catch{try{localStorage.setItem(t,s)}catch{}}},e.getCookie=t=>{try{const e=i(t)+"=",s=document.cookie.split(/;\s*/);for(const t of s)if(t.startsWith(e))return decodeURIComponent(t.substring(e.length))}catch{}try{const e=localStorage.getItem(t);return null===e?null:e}catch{return null}},e.deleteCookie=t=>{try{document.cookie=`${i(t)}=; path=/; max-age=0`}catch{}try{localStorage.removeItem(t)}catch{}};const s=3e3;e.setCookieChunks=(t,i,o=30)=>{const a=(0,e.getCookie)(`${t}_meta`);if(a){const i=parseInt(a,10);if(Number.isFinite(i))for(let s=0;s<i;s++)(0,e.deleteCookie)(`${t}_${s}`);(0,e.deleteCookie)(`${t}_meta`)}const r=Math.ceil(i.length/s)||1;for(let a=0;a<r;a++){const r=i.slice(a*s,(a+1)*s);(0,e.setCookie)(`${t}_${a}`,r,o)}(0,e.setCookie)(`${t}_meta`,String(r),o)},e.getCookieChunks=t=>{const i=(0,e.getCookie)(`${t}_meta`);if(!i)return null;const s=parseInt(i,10);if(!Number.isFinite(s)||s<=0)return null;let o="";for(let i=0;i<s;i++){const s=(0,e.getCookie)(`${t}_${i}`);if(null===s)return null;o+=s}return o}},9713:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.WardenEnemy=void 0;const s=i(7851),o=i(9467),a=i(7455),r=i(6986),n=i(8075),h=i(2440),l=i(2103);class c extends r.Enemy{constructor(t,e,i,r,c){super(t,e,i,r),this.crusherPositions=[],this.crusherCount=0,this.crushers=[],this.hit=()=>this.damage,this.bleed=()=>{},this.poison=()=>{},this.createCrusherBlocks=t=>{for(const e of t){const t=new h.CrusherEnemy(this.room,this.game,e.x,e.y);this.room.entities.push(t),this.crusherCount++,this.crushers.push(t)}},this.createCrusherChains=()=>{for(const t of this.crushers){let e=new n.BeamEffect(t.x,t.y,this.x,this.y,t);e.compositeOperation="source-over",e.color="#800000",e.turbulence=.4,e.gravity=.5,e.iterations=1,e.segments=100,e.angleChange=.001,e.springDamping=.01,e.drawableY=this.drawableY-.1,this.room.projectiles.push(e)}},this.getCrusherPositions=()=>[{x:this.x-1,y:this.y},{x:this.x+1,y:this.y}],this.setCrusherDrawableY=()=>{for(const t of this.crushers)this.y>t.y?this.drawableY=this.drawableY-.1:t.drawableY=this.drawableY-.1},this.initializeCrushers=()=>{0===this.crusherPositions.length&&(this.crusherPositions=this.getCrusherPositions()),this.crusherPositions.length>this.crusherCount&&(this.createCrusherBlocks(this.crusherPositions),this.createCrusherChains())},this.removeCrusherChains=()=>{for(let t of this.room.projectiles)t instanceof n.BeamEffect&&t.parent instanceof h.CrusherEnemy&&this.crushers.includes(t.parent)&&t.parent.dead&&(this.room.projectiles=this.room.projectiles.filter(e=>e!==t))},this.uniqueKillBehavior=()=>{this.removeCrusherChains();for(const t of this.crushers)t.dead||t.kill();this.removeLightSource(this.lightSource)},this.updateCrusherChains=t=>{for(let t of this.room.projectiles)if(t instanceof n.BeamEffect){if(t.parent!==this.crushers[0]&&t.parent!==this.crushers[1])continue;switch(t.setTarget(this.x-this.drawX,this.y-this.drawY-.5,t.parent.x-t.parent.drawX,t.parent.y-t.parent.drawY-1.25+t.parent.softAnimateY),t.drawableY=this.drawableY-.1,Math.floor(this.frame)){case 0:case 3:t.color="#800000";break;case 1:case 2:t.color="#ff0000"}}},this.behavior=()=>{if(this.initializeCrushers(),this.lastX=this.x,this.lastY=this.y,!this.dead){if(this.handleSkipTurns())return;if(this.seenPlayer){if(this.seenPlayer){if(this.room.playerTicked===this.targetPlayer)if(this.alertTicks=Math.max(0,this.alertTicks-1),this.ticks++,this.ticks%2==1){this.rumbling=!0;let t=this.x,e=this.y,i=Array();for(const t of this.room.entities)t!==this&&i.push({x:t.x,y:t.y});for(let t=this.x-1;t<=this.x+1;t++)for(let e=this.y-1;e<=this.y+1;e++)this.room.roomArray[t][e]instanceof a.SpikeTrap&&this.room.roomArray[t][e].on&&i.push({x:t,y:e});this.target=this.getAverageLuminance()>0?this.targetPlayer:this.room.getExtremeLuminanceFromPoint(this.x,this.y).darkest;const o=this.searchPathLocalized(this.target,i,{useLastPlayerPos:!0});if(o.length>0){let i=!1;for(const t in this.game.players)this.game.rooms[this.game.players[t].levelID]===this.room&&this.game.players[t].x===o[0].pos.x&&this.game.players[t].y===o[0].pos.y&&(this.game.players[t].hurt(this.hit(),this.name),this.drawX=.5*(this.x-this.game.players[t].x),this.drawY=.5*(this.y-this.game.players[t].y),this.game.players[t]===this.game.players[this.game.localPlayerID]&&this.game.shakeScreen(10*this.drawX,10*this.drawY),i=!0);i||(this.tryMove(o[0].pos.x,o[0].pos.y),this.setDrawXY(t,e),this.x>t?this.direction=s.Direction.RIGHT:this.x<t?this.direction=s.Direction.LEFT:this.y>e?this.direction=s.Direction.DOWN:this.y<e&&(this.direction=s.Direction.UP))}this.rumbling=!1}else this.rumbling=!0,this.makeHitWarnings();let t=-1!==Object.values(this.game.offlinePlayers).indexOf(this.targetPlayer);if(!this.aggro||t){let e=this.nearestPlayer();if(!1!==e){let[i,s]=e;i<=4&&(t||i<this.playerDistance(this.targetPlayer))&&s!==this.targetPlayer&&(this.targetPlayer=s,this.facePlayer(s),s===this.game.players[this.game.localPlayerID]&&(this.alertTicks=1),this.ticks%2==0&&this.makeHitWarnings())}}}}else this.lookForPlayer();this.lightSource&&this.lightSource.updatePosition(this.x+.5,this.y+.5)}this.removeCrusherChains()},this.drawTopLayer=t=>{this.drawableY=this.y,this.healthBar.draw(t,this.health,this.maxHealth,this.x,this.y,!0)},this.draw=t=>{this.dead||(s.Game.ctx.globalAlpha=this.alpha,this.updateDrawXY(t),this.setCrusherDrawableY(),this.updateCrusherChains(t),this.frame+=.1*t,this.frame>=4&&(this.frame=0),this.hasShadow&&this.drawShadow(t),s.Game.drawMob(this.tileX+2*Math.floor(this.frame),this.tileY,2,2,this.x-this.drawX-.5,this.y-this.drawYOffset-this.drawY-this.jumpY,2,2,this.softShadeColor,this.shadeAmount(),void 0,this.outlineColor(),this.outlineOpacity()),this.cloned||(this.seenPlayer||this.drawSleepingZs(t),this.alertTicks>0&&this.drawExclamation(t)),s.Game.ctx.globalAlpha=1)},this.w=1,this.h=1,this.ticks=0,this.frame=0,this.health=6,this.maxHealth=6,this.defaultMaxHealth=6,this.tileX=43,this.tileY=10,this.seenPlayer=!1,this.aggro=!1,this.dir=s.Direction.DOWN,this.name="warden",this.chainPushable=!1,this.forwardOnlyAttack=!1,this.drawMoveSpeed=.9,this.jumpHeight=.35,this.drawYOffset=1.5,this.alertRange=10,this.orthogonalAttack=!0,this.crusherPositions=[],this.crusherCount=0,this.crushers=[],this.baseDamage=2,this.lightSource=new l.LightSource(this.x+.5,this.y+.5,10,[255,10,10],1.5),this.addLightSource(this.lightSource),this.hasBloom=!0,this.bloomColor="#ff0a0a",this.bloomAlpha=1,this.room.updateLighting(),c&&(this.drop=c);const d=Math.floor(3*o.Random.rand())+2;for(;this.drops.length<d&&!this.cloned;)this.getDrop()}}e.WardenEnemy=c,c.difficulty=2,c.tileX=21,c.tileY=0},9791:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.ItemGroup=void 0;const s=i(8287);e.ItemGroup=class{constructor(t){this.items=t}destroyOtherItems(t){for(const e of this.items)e!==t&&e.destroy();t.level.game.pushMessage(`You choose to keep the ${t.name}.`),s.GameplaySettings.UNBREAKABLE_ITEMGROUP_LOOT&&(t.degradeable=!1,t.level.game.pushMessage("This one won't break."),t.description+=" Unbreakable.")}}},9830:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.IronResource=void 0;const s=i(7172),o=i(9432),a=i(9467),r=i(5816);class n extends s.Resource{constructor(t,e,i,s){super(t,e,i,s),this.tileX=18,this.tileY=0,this.health=2,this.name="iron",a.Random.rand()<.005&&this.drops.push(new o.Geode(this.room,this.x,this.y)),this.drops.push(new r.IronOre(this.room,this.x,this.y))}}e.IronResource=n},9852:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Candelabra=void 0;const s=i(606),o=i(7851),a=i(606),r=i(2103),n=i(8149);class h extends s.Entity{constructor(t,e,i,s){super(t,e,i,s),this.draw=t=>{this.dead||(o.Game.ctx.save(),o.Game.ctx.globalAlpha=this.alpha,this.frame+=.25*t,this.frame>=4&&(this.frame=0),this.dead||(this.hasShadow&&this.drawShadow(t),this.updateDrawXY(t),o.Game.drawObj(this.tileX+Math.floor(this.frame),this.tileY,1,2,this.x-this.drawX,this.y-this.drawYOffset-this.drawY,1,2,this.room.shadeColor,this.shadeAmount())),o.Game.ctx.restore())},this.drawTopLayer=t=>{this.drawableY=this.y},this.room=t,this.health=1,this.tileX=10,this.tileY=4,this.hasShadow=!0,this.chainPushable=!1,this.name="candelabra",this.drops.push(new n.Candle(this.room,this.x,this.y)),this.imageParticleX=0,this.imageParticleY=25,this.bloomColor="#FFA500",this.hasBloom=!0,this.bloomAlpha=1,this.softBloomAlpha=0,this.lightSource=new r.LightSource(this.x+.5,this.y+.5,7,[200,30,1],4),this.addLightSource(this.lightSource)}get type(){return a.EntityType.PROP}}e.Candelabra=h},9915:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Pickaxe=void 0;const s=i(4052);class o extends s.Weapon{constructor(t,e,i){super(t,e,i),this.tileX=30,this.tileY=0,this.name=o.itemName,this.description="allows mining rocks without equipping",this.canMine=!0}}e.Pickaxe=o,o.itemName="pickaxe"},9938:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Apple=void 0;const s=i(5180),o=i(7366);class a extends s.Usable{constructor(t,e,i){super(t,e,i),this.onUse=t=>{t.health<t.maxHealth&&(t.health=Math.min(t.maxHealth,t.health+1),o.Sound.playEat(),this.stackCount>1?this.stackCount--:t.inventory.removeItem(this),t.game.pushMessage("You eat the apple and feel better."))},this.getDescription=()=>"APPLE\nAppears nutritious.",this.tileX=6,this.tileY=2,this.stackable=!0}}e.Apple=a,a.itemName="apple"},9962:(t,e)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.WebGLWaterOverlayRenderer=void 0;class i{static isSupported(){if(null!==i.supportCache)return i.supportCache;if("undefined"==typeof document)return i.supportCache=!1,!1;const t=document.createElement("canvas"),e=t.getContext("webgl",{alpha:!0})||t.getContext("experimental-webgl",{alpha:!0});return i.supportCache=!!e,i.supportCache}static getInstance(){return i.instance||(i.instance=new i),i.instance}constructor(){if(this.layerColorLocations=[],this.layerSeedLocations=[],this.layerScaleLocations=[],this.layerHoleLocations=[],this.layerSharpnessLocations=[],this.layerOpacityLocations=[],this.layerSpeedLocations=[],this.layerOffsetLocations=[],this.currentWidth=0,this.currentHeight=0,"undefined"==typeof document)throw new Error("WebGL water overlay requires a browser environment.");this.canvas=document.createElement("canvas");const t=this.canvas.getContext("webgl",{alpha:!0,depth:!1,stencil:!1,antialias:!1,preserveDrawingBuffer:!1,premultipliedAlpha:!1,powerPreference:"high-performance"})||this.canvas.getContext("experimental-webgl",{alpha:!0,depth:!1,stencil:!1,antialias:!1,preserveDrawingBuffer:!1,premultipliedAlpha:!1,powerPreference:"high-performance"});if(!t)throw new Error("Unable to initialize WebGL for water overlay.");this.gl=t,this.gl.disable(this.gl.DEPTH_TEST),this.gl.disable(this.gl.CULL_FACE),this.gl.disable(this.gl.STENCIL_TEST),this.gl.disable(this.gl.BLEND);const e=this.createShader(this.gl.VERTEX_SHADER,"\n        precision mediump float;\n        attribute vec2 a_position;\n        uniform vec2 u_resolution;\n        void main() {\n          vec2 zeroToOne = a_position / u_resolution;\n          vec2 zeroToTwo = zeroToOne * 2.0;\n          vec2 clipSpace = zeroToTwo - 1.0;\n          gl_Position = vec4(clipSpace * vec2(1.0, -1.0), 0.0, 1.0);\n        }\n      "),i=this.createShader(this.gl.FRAGMENT_SHADER,"\n        precision mediump float;\n        #define MAX_LAYERS 4\n\n        uniform vec2 u_resolution;\n        uniform float u_time;\n        uniform int u_layerCount;\n        uniform vec3 u_layerColor[MAX_LAYERS];\n        uniform float u_layerSeed[MAX_LAYERS];\n        uniform float u_layerScale[MAX_LAYERS];\n        uniform float u_layerHoleRadius[MAX_LAYERS];\n        uniform float u_layerSharpness[MAX_LAYERS];\n        uniform float u_layerOpacity[MAX_LAYERS];\n        uniform vec2 u_layerSpeed[MAX_LAYERS];\n        uniform vec2 u_layerOffset[MAX_LAYERS];\n        uniform vec2 u_origin;\n\n        float hash(vec2 p, float seed) {\n          vec3 p3 = fract(vec3(p.x, p.y, p.x) * 0.1031 + seed);\n          p3 += dot(p3, p3.yzx + 33.33);\n          return fract((p3.x + p3.y) * p3.z);\n        }\n\n        float worley(vec2 p, float seed) {\n          vec2 cell = floor(p);\n          float minDistance = 1.41421356237;\n\n          for (int y = -1; y <= 1; y++) {\n            for (int x = -1; x <= 1; x++) {\n              vec2 neighbor = cell + vec2(float(x), float(y));\n              vec2 jitter = vec2(\n                hash(neighbor + vec2(0.17, 0.53), seed),\n                hash(neighbor + vec2(0.73, 0.19), seed + 19.0)\n              );\n              vec2 featurePoint = neighbor + jitter;\n              float distanceToFeature = distance(p, featurePoint);\n              if (distanceToFeature < minDistance) {\n                minDistance = distanceToFeature;\n              }\n            }\n          }\n\n          return minDistance;\n        }\n\n        void main() {\n          vec2 pixel = vec2(gl_FragCoord.x, u_resolution.y - gl_FragCoord.y);\n          vec2 world = u_origin + pixel;\n          vec4 color = vec4(0.0);\n\n          for (int i = 0; i < MAX_LAYERS; i++) {\n            if (i >= u_layerCount) {\n              break;\n            }\n\n            float scale = max(u_layerScale[i], 0.001);\n            vec2 animatedOffset = u_layerOffset[i] + u_layerSpeed[i] * u_time;\n            vec2 samplePoint = (world + animatedOffset) / scale;\n            float distanceToFeature = worley(samplePoint, u_layerSeed[i]);\n            float normalized = clamp(distanceToFeature / u_layerHoleRadius[i], 0.0, 1.0);\n            float fill = pow(normalized, u_layerSharpness[i]);\n            float layerAlpha = clamp(fill * u_layerOpacity[i], 0.0, 1.0);\n\n            color.rgb += u_layerColor[i] * layerAlpha;\n            color.a += layerAlpha;\n          }\n\n          color.rgb = clamp(color.rgb, 0.0, 1.5);\n          color.a = clamp(color.a, 0.0, 1.0);\n          gl_FragColor = color;\n        }\n      ");this.program=this.createProgram(e,i),this.gl.useProgram(this.program),this.positionBuffer=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.positionBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]),this.gl.DYNAMIC_DRAW);const s=this.gl.getAttribLocation(this.program,"a_position");this.gl.enableVertexAttribArray(s),this.gl.vertexAttribPointer(s,2,this.gl.FLOAT,!1,0,0),this.resolutionLocation=this.getUniform("u_resolution"),this.timeLocation=this.getUniform("u_time"),this.layerCountLocation=this.getUniform("u_layerCount"),this.originLocation=this.getUniform("u_origin");for(let t=0;t<4;t++)this.layerColorLocations.push(this.getUniform(`u_layerColor[${t}]`)),this.layerSeedLocations.push(this.getUniform(`u_layerSeed[${t}]`)),this.layerScaleLocations.push(this.getUniform(`u_layerScale[${t}]`)),this.layerHoleLocations.push(this.getUniform(`u_layerHoleRadius[${t}]`)),this.layerSharpnessLocations.push(this.getUniform(`u_layerSharpness[${t}]`)),this.layerOpacityLocations.push(this.getUniform(`u_layerOpacity[${t}]`)),this.layerSpeedLocations.push(this.getUniform(`u_layerSpeed[${t}]`)),this.layerOffsetLocations.push(this.getUniform(`u_layerOffset[${t}]`))}createShader(t,e){const i=this.gl.createShader(t);if(!i)throw new Error("Failed to create shader.");if(this.gl.shaderSource(i,e),this.gl.compileShader(i),!this.gl.getShaderParameter(i,this.gl.COMPILE_STATUS)){const t=this.gl.getShaderInfoLog(i);throw this.gl.deleteShader(i),new Error(`Failed to compile shader: ${t||"unknown error"}`)}return i}createProgram(t,e){const i=this.gl.createProgram();if(!i)throw new Error("Failed to create shader program.");if(this.gl.attachShader(i,t),this.gl.attachShader(i,e),this.gl.linkProgram(i),!this.gl.getProgramParameter(i,this.gl.LINK_STATUS)){const t=this.gl.getProgramInfoLog(i);throw new Error(`Failed to link shader program: ${t||"unknown error"}`)}return i}getUniform(t){const e=this.gl.getUniformLocation(this.program,t);if(!e)throw new Error(`Uniform ${t} not found.`);return e}ensureCanvasSize(t,e){if(this.currentWidth===t&&this.currentHeight===e)return;this.canvas.width=t,this.canvas.height=e,this.currentWidth=t,this.currentHeight=e,this.gl.viewport(0,0,t,e),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.positionBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array([0,0,t,0,0,e,0,e,t,0,t,e]),this.gl.STATIC_DRAW);const i=this.gl.getAttribLocation(this.program,"a_position");this.gl.enableVertexAttribArray(i),this.gl.vertexAttribPointer(i,2,this.gl.FLOAT,!1,0,0)}render(t){const e=Math.min(t.layers.length,4);this.ensureCanvasSize(t.width,t.height),this.gl.useProgram(this.program),this.gl.uniform2f(this.resolutionLocation,t.width,t.height),this.gl.uniform1f(this.timeLocation,t.time),this.gl.uniform1i(this.layerCountLocation,e),this.gl.uniform2f(this.originLocation,t.originX,t.originY);for(let i=0;i<e;i++){const e=t.layers[i];this.gl.uniform3fv(this.layerColorLocations[i],new Float32Array(e.color)),this.gl.uniform1f(this.layerSeedLocations[i],e.seed),this.gl.uniform1f(this.layerScaleLocations[i],e.scale),this.gl.uniform1f(this.layerHoleLocations[i],e.holeRadius),this.gl.uniform1f(this.layerSharpnessLocations[i],e.sharpness),this.gl.uniform1f(this.layerOpacityLocations[i],e.opacity),this.gl.uniform2fv(this.layerSpeedLocations[i],new Float32Array(e.speed)),this.gl.uniform2fv(this.layerOffsetLocations[i],new Float32Array(e.offset))}for(let t=e;t<4;t++)this.gl.uniform3fv(this.layerColorLocations[t],new Float32Array([0,0,0])),this.gl.uniform1f(this.layerSeedLocations[t],0),this.gl.uniform1f(this.layerScaleLocations[t],1),this.gl.uniform1f(this.layerHoleLocations[t],1),this.gl.uniform1f(this.layerSharpnessLocations[t],1),this.gl.uniform1f(this.layerOpacityLocations[t],0),this.gl.uniform2fv(this.layerSpeedLocations[t],new Float32Array([0,0])),this.gl.uniform2fv(this.layerOffsetLocations[t],new Float32Array([0,0]));return this.gl.clearColor(0,0,0,0),this.gl.clear(this.gl.COLOR_BUFFER_BIT),this.gl.drawArrays(this.gl.TRIANGLES,0,6),this.canvas}getCanvas(){return this.canvas}}e.WebGLWaterOverlayRenderer=i,i.instance=null,i.supportCache=null},9982:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.ChargeEnemy=e.ChargeEnemyState=void 0;const s=i(7851),o=i(369),a=i(4804),r=i(1731),n=i(6291),h=i(6986);var l;!function(t){t[t.IDLE=0]="IDLE",t[t.ALERTED=1]="ALERTED",t[t.CHARGING=2]="CHARGING"}(l=e.ChargeEnemyState||(e.ChargeEnemyState={}));class c extends h.Enemy{constructor(t,e,i,h,c){super(t,e,i,h),this.maxChargeDistance=3,this.trailAlpha=1,this.hit=()=>this.damage,this.canMoveOver=(t,e)=>{for(const i of this.room.entities)if(i!==this&&t===i.x&&e===i.y)return!1;let i=this.room.roomArray[t][e];return!(i.isSolid()||i instanceof a.Door)},this.behavior=()=>{if(this.lastX=this.x,this.lastY=this.y,!this.dead){if(this.handleSkipTurns())return;if(this.ticks++,this.state===l.IDLE){let t=!1,e=0,i=0;for(const a in this.game.players){const r=this.game.players[a].x,n=this.game.players[a].y,h=Math.abs(this.x-r),c=Math.abs(this.y-n);if(this.x===r&&c<=this.maxChargeDistance||this.y===n&&h<=this.maxChargeDistance){if(this.x===r){i=this.y<n?1:-1;for(let e=this.y;e!==n;e+=i)this.canMoveOver(this.x,e)||(t=!0)}else if(this.y===n){e=this.x<r?1:-1;for(let i=this.x;i!==r;i+=e)this.canMoveOver(i,this.y)||(t=!0)}if((0!==e||0!==i)&&!t){this.state=l.ALERTED,this.targetX=this.x,this.targetY=this.y;let t=0;for(;this.canMoveOver(this.targetX+e,this.targetY+i)&&t<this.maxChargeDistance;)this.targetX+=e,this.targetY+=i,t++,(this.targetX===r&&this.targetY===n||this.targetX===r-1&&this.targetY===n||this.targetX===r+1&&this.targetY===n||this.targetX===r&&this.targetY===n-1||this.targetX===r&&this.targetY===n+1)&&this.room.hitwarnings.push(new o.HitWarning(this.game,this.targetX,this.targetY,this.x,this.y));this.visualTargetX=this.targetX+.5*e,this.visualTargetY=this.targetY+.5*i,1===i&&(this.visualTargetY+=.65),e>0?this.direction=s.Direction.RIGHT:e<0?this.direction=s.Direction.LEFT:i<0?this.direction=s.Direction.UP:i>0&&(this.direction=s.Direction.DOWN);break}}}}else if(this.state===l.ALERTED){this.state=l.CHARGING,this.trailFrame=0;for(const t in this.game.players)(this.y===this.game.players[t].y&&(this.x<this.game.players[t].x&&this.game.players[t].x<=this.targetX||this.targetX<=this.game.players[t].x&&this.game.players[t].x<this.x)||this.x===this.game.players[t].x&&(this.y<this.game.players[t].y&&this.game.players[t].y<=this.targetY||this.targetY<=this.game.players[t].y&&this.game.players[t].y<this.y))&&this.game.players[t].hurt(this.hit(),this.name);this.startX=this.x,this.startY=this.y,this.drawX=this.targetX-this.x,this.drawY=this.targetY-this.y,this.x=this.targetX,this.y=this.targetY}else this.state===l.CHARGING&&(this.state=l.IDLE)}},this.draw=t=>{if(!this.dead){if(s.Game.ctx.save(),s.Game.ctx.globalAlpha=this.alpha,!this.dead){if(this.updateDrawXY(t),this.frame+=.1*t,this.frame>=4&&(this.frame=0),(this.state===l.CHARGING&&Math.abs(this.drawX)>.1||Math.abs(this.drawY)>.1)&&(r.GenericParticle.spawnCluster(this.room,this.x-this.drawX+.5,this.y-this.drawY+.5,"black"),r.GenericParticle.spawnCluster(this.room,this.x-this.drawX+.5,this.y-this.drawY+.5,"white")),this.state===l.CHARGING||this.trailAlpha<1){this.trailFrame+=.03*t;let e=this.trailFrame;e>=0&&e<=1&&(s.Game.ctx.strokeStyle="white",n.GameConstants.ALPHA_ENABLED&&(this.trailAlpha=1-e,s.Game.ctx.globalAlpha=this.trailAlpha),s.Game.ctx.lineWidth=.25*n.GameConstants.TILESIZE,s.Game.ctx.beginPath(),s.Game.ctx.moveTo((this.startX+.5)*n.GameConstants.TILESIZE,(this.startY+.5)*n.GameConstants.TILESIZE),s.Game.ctx.lineCap="round",s.Game.ctx.lineTo((this.x-this.drawX+.5)*n.GameConstants.TILESIZE,(this.y-this.drawY+.5)*n.GameConstants.TILESIZE),s.Game.ctx.stroke(),s.Game.ctx.globalAlpha=1),this.trailAlpha<=0&&(this.trailAlpha=1)}this.hasShadow&&this.drawShadow(t),s.Game.drawMob(this.tileX+Math.floor(this.frame),this.tileY+2*this.direction,1,2,this.x-this.drawX,this.y-this.drawYOffset-this.drawY,1,2,this.softShadeColor,this.shadeAmount(),void 0,this.outlineColor(),this.outlineOpacity()),this.cloned||(this.state===l.IDLE?this.drawSleepingZs(t):this.state===l.ALERTED&&this.drawExclamation(t))}this.drawChargeBeam(t),s.Game.ctx.restore()}},this.drawChargeBeam=t=>{if(!this.dying&&(this.drawableY=this.y,this.healthBar.draw(t,this.health,this.maxHealth,this.x,this.y,!0),this.drawX+=-.1*this.drawX,this.drawY+=-.1*this.drawY,this.state===l.ALERTED&&(this.trailFrame+=.2*t,Math.floor(this.trailFrame)%2==0))){let t=(this.x+.5)*n.GameConstants.TILESIZE,e=(this.y-.25)*n.GameConstants.TILESIZE;this.direction===s.Direction.LEFT?t-=3:this.direction===s.Direction.RIGHT?t+=3:this.direction===s.Direction.DOWN?e+=2:this.direction===s.Direction.UP&&(e-=8);let i=this.visualTargetX,o=this.visualTargetY;const a=this.direction===s.Direction.LEFT?-1:this.direction===s.Direction.RIGHT?1:0,r=this.direction===s.Direction.UP?-1:this.direction===s.Direction.DOWN?1:0;Math.max(Math.abs(this.visualTargetX-this.x),Math.abs(this.visualTargetY-this.y))>this.maxChargeDistance&&(i=this.x+a*this.maxChargeDistance,o=this.y+r*this.maxChargeDistance,1===r&&(o+=.65),a>0?i+=.5:a<0&&(i-=.5)),s.Game.ctx.strokeStyle="white",s.Game.ctx.lineWidth=.1*n.GameConstants.TILESIZE,s.Game.ctx.beginPath(),s.Game.ctx.moveTo(Math.round(t),Math.round(e)),s.Game.ctx.lineCap="round",s.Game.ctx.lineTo(Math.round((i+.5)*n.GameConstants.TILESIZE),Math.round((o-.25)*n.GameConstants.TILESIZE)),s.Game.ctx.stroke(),s.Game.ctx.globalAlpha=1}},this.ticks=0,this.frame=0,this.health=1,this.maxHealth=1,this.defaultMaxHealth=1,this.tileX=13,this.tileY=8,this.trailFrame=0,this.alertTicks=0,this.deathParticleColor="#ffffff",this.lastX=this.x,this.lastY=this.y,this.imageParticleX=3,this.imageParticleY=29,this.name="charge knight",this.state=l.IDLE,c&&(this.drop=c),this.getDrop(["weapon","equipment","consumable","tool","coin"])}}e.ChargeEnemy=c,c.difficulty=5,c.tileX=13,c.tileY=8},9991:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Stone=void 0;const s=i(5366);class o extends s.Item{constructor(t,e,i){super(t,e,i),this.getDescription=()=>"STONE\nSome fragments of stone.",this.tileX=15,this.tileY=0,this.stackable=!0}}e.Stone=o,o.itemName="stones"},9997:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.SpiderEnemy=void 0;const s=i(7851),o=i(7455),a=i(6291),r=i(6986),n=i(6199),h=i(369);var l;!function(t){t[t.VISIBLE=0]="VISIBLE",t[t.HIDING=1]="HIDING",t[t.HIDDEN=2]="HIDDEN"}(l||(l={}));class c extends r.Enemy{constructor(t,e,i,r,c){super(t,e,i,r),this.hit=()=>this.damage,this.toggleReveal=()=>{let t=this.ticks-this.revealTick;this.state===l.HIDDEN&&t>8&&(this.state=l.HIDING),this.revealTick=this.ticks},this.jump=t=>{let e=Math.max(Math.abs(this.drawX),Math.abs(this.drawY));e>1&&(this.jumpDistance=2),this.jumpY=Math.sin(e/this.jumpDistance*Math.PI)*this.jumpHeight,this.jumpY<.01&&this.jumpY>-.01&&(this.jumpY=0,this.jumpDistance=1),this.jumpY>this.jumpHeight&&(this.jumpY=this.jumpHeight)},this.isTileFree=(t,e)=>{if(!this.room.roomArray[t]||!this.room.roomArray[t][e])return!1;const i=this.room.roomArray[t][e];if(i.isSolid())return!1;if(i instanceof o.SpikeTrap&&i.on)return!1;for(const i of this.room.entities)if(i!==this&&i.x===t&&i.y===e)return!1;return!0},this.getTwoTileCandidates=(t,e)=>{const i=[{dx:1,dy:0,axis:"x"},{dx:-1,dy:0,axis:"x"},{dx:0,dy:1,axis:"y"},{dx:0,dy:-1,axis:"y"}],s=[];for(const o of i){const i=t+o.dx,a=e+o.dy,r=t+2*o.dx,n=e+2*o.dy;this.isTileFree(i,a)&&this.isTileFree(r,n)&&s.push({endX:r,endY:n,axis:o.axis,dx:o.dx,dy:o.dy})}return s},this.pickBestCandidate=(t,e,i,s,o,a)=>{const r=0===o?0:o>0?1:-1,n=0===a?0:a>0?1:-1;return t.sort((t,o)=>{const a=Math.abs(t.endX-e)+Math.abs(t.endY-i),h=Math.abs(o.endX-e)+Math.abs(o.endY-i);if(a!==h)return a-h;if(s){if(t.axis!==o.axis)return"x"===t.axis?-1:1}else if(t.axis!==o.axis)return"y"===t.axis?-1:1;const l=(0!==t.dx?t.dx===r:t.dy===n)?-1:1,c=(0!==o.dx?o.dx===r:o.dy===n)?-1:1;return l!==c?l-c:0}),t[0]},this.getOneTileCandidates=(t,e)=>{const i=[{dx:1,dy:0},{dx:-1,dy:0},{dx:0,dy:1},{dx:0,dy:-1}],s=[];for(const o of i){const i=t+o.dx,a=e+o.dy;this.isTileFree(i,a)&&s.push({x:i,y:a})}return s},this.pickBestOneTileCandidate=(t,e,i,s,o,a)=>(t.sort((t,r)=>{const n=Math.abs(t.x-e)+Math.abs(t.y-i),h=Math.abs(r.x-e)+Math.abs(r.y-i);if(n!==h)return n-h;const l=Math.abs(t.x-e)>Math.abs(t.y-i)?"x":"y",c=Math.abs(r.x-e)>Math.abs(r.y-i)?"x":"y";if(s){if(l!==c)return"x"===l?-1:1}else if(l!==c)return"y"===l?-1:1;const d=(t.x>e?o<0:t.x<e?o>0:t.y>i?a<0:t.y<i&&a>0)?-1:1,m=(r.x>e?o<0:r.x<e?o>0:r.y>i?a<0:r.y<i&&a>0)?-1:1;return d!==m?d-m:0}),t[0]),this.attackOrMoveTo=(t,e,i,o)=>{let a=!1;for(const i in this.game.players)this.game.rooms[this.game.players[i].levelID]===this.room&&this.game.players[i].x===t&&this.game.players[i].y===e&&(this.game.players[i].hurt(this.hit(),this.name),this.drawX=.5*(this.x-this.game.players[i].x),this.drawY=.5*(this.y-this.game.players[i].y),this.game.players[i]===this.game.players[this.game.localPlayerID]&&this.game.shakeScreen(10*this.drawX,10*this.drawY),a=!0);a||(this.tryMove(t,e),this.setDrawXY(i,o),this.x>i?this.direction=s.Direction.RIGHT:this.x<i?this.direction=s.Direction.LEFT:this.y>o?this.direction=s.Direction.DOWN:this.y<o&&(this.direction=s.Direction.UP))},this.behavior=()=>{if(this.lastX=this.x,this.lastY=this.y,!this.dead){if(this.handleSkipTurns())return;if(this.rumbling=this.ticks%2==1,this.seenPlayer){if(this.seenPlayer){if(this.room.playerTicked===this.targetPlayer)if(this.alertTicks=Math.max(0,this.alertTicks-1),this.ticks++,this.ticks%2==1){this.rumbling=!0;let t=this.x,e=this.y,i=Array();for(const t of this.room.entities)t!==this&&i.push({x:t.x,y:t.y});for(let t=this.x-1;t<=this.x+1;t++)for(let e=this.y-1;e<=this.y+1;e++)this.room.roomArray[t][e]instanceof o.SpikeTrap&&this.room.roomArray[t][e].on&&i.push({x:t,y:e});this.target=this.getAverageLuminance()>0?this.targetPlayer:this.room.getExtremeLuminanceFromPoint(this.x,this.y).darkest;let s={x:this.targetPlayer.x,y:this.targetPlayer.y};const a=Math.abs(this.targetPlayer.x-this.x)+Math.abs(this.targetPlayer.y-this.y);if(this.target===this.targetPlayer&&2===a){let t=this.targetPlayer.lastX-this.x,e=this.targetPlayer.lastY-this.y;if(0!==t&&0!==e&&(Math.abs(t)>=Math.abs(e)?e=0:t=0),0===t&&Math.abs(e)<=1||0===e&&Math.abs(t)<=1){const i=this.targetPlayer.x+Math.sign(t),o=this.targetPlayer.y+Math.sign(e);this.room.roomArray[i]&&this.room.roomArray[i][o]&&!this.room.roomArray[i][o].isSolid()&&(s={x:i,y:o})}}else this.target!==this.targetPlayer&&(s={x:this.target.x,y:this.target.y});const r=s.x-t,n=s.y-e,h=Math.abs(r)>=Math.abs(n);let l=this.x,c=this.y;const d=this.searchPathLocalized(s,i,{useLastPlayerPos:!0,allowOmni:!1});if(d.length>0){let i=d[0];const s=d[1];if(s){const o=s.pos.x===t||s.pos.y===e,a=h?s.pos.y===e:s.pos.x===t;o&&a&&(i=s)}if(l=i.pos.x,c=i.pos.y,1===Math.abs(l-t)+Math.abs(c-e)){const i=l-t,s=c-e,o=l+(0!==i?Math.sign(i):0),a=c+(0!==s?Math.sign(s):0);this.isTileFree(o,a)&&(l=o,c=a)}}if(1===a){const i=this.getOneTileCandidates(t,e);if(i.length>0){const o=this.pickBestOneTileCandidate(i,s.x,s.y,h,r,n);this.attackOrMoveTo(o.x,o.y,t,e)}}else if(Math.abs(l-t)+Math.abs(c-e)>=1)this.attackOrMoveTo(l,c,t,e);else{const i=this.getTwoTileCandidates(t,e);if(i.length>0){const o=this.pickBestCandidate(i,s.x,s.y,h,r,n);this.attackOrMoveTo(o.endX,o.endY,t,e)}else{const i=this.getOneTileCandidates(t,e);if(i.length>0){const o=this.pickBestOneTileCandidate(i,s.x,s.y,h,r,n);this.attackOrMoveTo(o.x,o.y,t,e)}}}this.rumbling=!1,this.unconscious=!0}else this.rumbling=!0,this.unconscious=!1,this.makeHitWarnings();let t=-1!==Object.values(this.game.offlinePlayers).indexOf(this.targetPlayer);if(!this.aggro||t){let e=this.nearestPlayer();if(!1!==e){let[i,s]=e;i<=4&&(t||i<this.playerDistance(this.targetPlayer))&&s!==this.targetPlayer&&(this.targetPlayer=s,this.facePlayer(s),s===this.game.players[this.game.localPlayerID]&&(this.alertTicks=1),this.ticks%2==0&&(this.rumbling=!0,this.makeHitWarnings()))}}}}else this.lookForPlayer()}},this.makeHitWarnings=()=>{if(this.unconscious)return;const t=this.getPlayer(),e=this.orthogonalAttack,i=this.diagonalAttack,o=this.forwardOnlyAttack,a=this.direction,r=this.attackRange,l=this.diagonalAttackRange,c=(t,e)=>(t?[[-2,0],[2,0],[0,-2],[0,2],[-1,0],[1,0],[0,-1],[0,1]]:[[-1,-1],[1,1],[1,-1],[-1,1]]).flatMap(([t,i])=>Array.from({length:e},(e,s)=>[(s+1)*t,(s+1)*i])),d={[s.Direction.LEFT]:[-1,0],[s.Direction.RIGHT]:[1,0],[s.Direction.UP]:[0,-1],[s.Direction.DOWN]:[0,1]};let m=[];if(o){const[t,e]=d[a];m=Array.from({length:r},(i,s)=>[(s+1)*t,(s+1)*e])}else e&&m.push(...c(!0,r)),i&&m.push(...c(!1,l));const u=m.map(([e,i])=>({x:e,y:i,distance:n.Utils.distance(e,i,t.x-this.x,t.y-this.y)})).sort((t,e)=>t.distance-e.distance),p=Math.ceil(.75*u.length);u.slice(0,p).forEach(({x:t,y:e})=>{const i=this.x+t,s=this.y+e;if(this.isWithinRoomBounds(i,s)){const t=new h.HitWarning(this.game,i,s,this.x,this.y,!0,!1,this);this.room.hitwarnings.push(t)}})},this.draw=t=>{if(!this.dead){if(s.Game.ctx.save(),s.Game.ctx.globalAlpha=this.alpha,!this.dead){switch(this.updateDrawXY(t),this.ticks,this.tileX=11,this.tileY=4,this.direction){case s.Direction.UP:case s.Direction.LEFT:case s.Direction.RIGHT:}let e=Math.max(this.rumble(this.rumbling,this.frame,this.direction).x,Math.max(this.rumble(this.rumbling,this.frame,this.direction).y));this.frame+=.1*t,this.frame>=4&&(this.frame=0),this.hasShadow&&this.drawShadow(t),this.state===l.VISIBLE&&s.Game.drawMob(this.tileX,this.tileY,2,2,this.x-this.drawX+e-.5,this.y-this.drawYOffset-this.drawY-this.jumpY,2*this.crushX,2*this.crushY,this.softShadeColor,this.shadeAmount(),void 0,this.outlineColor(),this.outlineOpacity()),this.crushed&&this.crushAnim(t)}this.cloned||(this.seenPlayer||this.drawSleepingZs(t,0,.75*a.GameConstants.TILESIZE),this.alertTicks>0&&this.drawExclamation(t,0,.75*a.GameConstants.TILESIZE)),s.Game.ctx.restore()}},this.ticks=0,this.frame=0,this.health=1,this.maxHealth=1,this.defaultMaxHealth=1,this.tileX=11,this.tileY=4,this.seenPlayer=!1,this.aggro=!1,this.name="spider",this.orthogonalAttack=!0,this.diagonalAttack=!1,this.imageParticleX=3,this.imageParticleY=24,this.state=l.VISIBLE,this.drawYOffset=1.2,this.revealTick=0,this.hasShadow=!0,this.jumpHeight=1,this.jumpDistance=1,this.getDrop(["weapon","equipment","consumable","tool","coin"])}get alertText(){return`New Enemy Spotted: Spider \n    Health: ${this.health}\n    Attack Pattern: Omnidirectional\n    Moves every other turn`}}e.SpiderEnemy=c,c.difficulty=1,c.tileX=8,c.tileY=4}},e={};function i(s){var o=e[s];if(void 0!==o)return o.exports;var a=e[s]={exports:{}};return t[s].call(a.exports,a,a.exports,i),a.exports}i.amdO={},i.d=(t,e)=>{for(var s in e)i.o(e,s)&&!i.o(t,s)&&Object.defineProperty(t,s,{enumerable:!0,get:e[s]})},i.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(t){if("object"==typeof window)return window}}(),i.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),i.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i.p="/dist/",i(7851)})();
//# sourceMappingURL=bundle.js.map